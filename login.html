<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - LOGIN</title>
    <link rel="stylesheet" href="css/style.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script src="firebase-config.js"></script>

    <script src="panic-key.js"></script>
    <script src="url-changer.js"></script>

    <style>
        .auth-split-container {
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
            display: flex;
            flex-wrap: wrap;
            max-width: 900px;
            margin: 50px auto;
            overflow: hidden;
            min-height: 650px;
        }

        .auth-col {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .auth-col.left-col {
            background-color: #f8f9fa;
            border-right: 1px solid #eee;
            min-width: 300px;
        }

        .auth-col.right-col {
            background-color: #fff;
        }

        .auth-col h2 {
            font-family: 'PrimaryFont', sans-serif;
            font-size: 2.2em;
            color: #333;
            margin-bottom: 25px;
            text-align: center;
            width: 100%;
        }
        
        .auth-col p {
            font-family: 'SecondaryFont', sans-serif;
            font-size: 1.1em;
            color: #555;
            line-height: 1.6;
            text-align: center;
            max-width: 350px;
        }

        .auth-col form {
            width: 100%;
            max-width: 350px;
        }

        .auth-col .input-group {
            margin-bottom: 20px;
        }

        .auth-col .input-group label {
            display: block;
            margin-bottom: 8px;
            font-family: 'SecondaryFont', sans-serif;
            color: #555;
            font-size: 0.95em;
            text-align: left;
        }

        .auth-col .input-group input[type="email"],
        .auth-col .input-group input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'SecondaryFont', sans-serif;
            font-size: 1em;
            color: #333;
            transition: border-color 0.3s ease;
        }

        .auth-col .input-group input[type="email"]:focus,
        .auth-col .input-group input[type="password"]:focus {
            border-color: #6720bd;
            outline: none;
        }

        .auth-col .btn-primary {
            width: 100%;
            padding: 14px;
            background-color: #6720bd;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-family: 'PrimaryFont', sans-serif;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .auth-col .btn-primary:hover {
            background-color: #5a1aa8;
            transform: translateY(-2px);
        }

        .auth-col .btn-google {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 350px;
            padding: 12px;
            background-color: #fff;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: 'PrimaryFont', sans-serif;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            margin-bottom: 10px;
        }

        .auth-col .btn-google img {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .auth-col .btn-google:hover {
            background-color: #f5f5f5;
            border-color: #aaa;
        }

        .auth-col .switch-link,
        .auth-col .forgot-password-link,
        .auth-col .back-to-login-link {
            width: 100%;
            max-width: 350px;
            margin-top: 25px;
            font-family: 'SecondaryFont', sans-serif;
            color: #555;
            text-align: center;
        }
        
        .auth-col .forgot-password-link {
            margin-top: 20px;
            font-size: 1em;
        }
        
        .auth-col .switch-link {
            font-size: 1em;
        }

        .auth-col .switch-link a,
        .auth-col .forgot-password-link a,
        .auth-col .back-to-login-link a {
            color: #6720bd;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .auth-col .switch-link a:hover,
        .auth-col .forgot-password-link a:hover,
        .auth-col .back-to-login-link a:hover {
            color: #5a1aa8;
        }
        
        .oauth-agreement-text {
            font-family: 'SecondaryFont', sans-serif;
            font-size: 0.8em !important;
            font-style: italic;
            color: #666;
            text-align: center;
            max-width: 350px;
            margin-top: 15px;
            line-height: 1.5 !important;
        }
        .oauth-agreement-text a {
            color: #6720bd;
            text-decoration: none;
        }
        .oauth-agreement-text a:hover {
            text-decoration: underline;
        }

        .auth-col .message-area {
            width: 100%;
            max-width: 350px;
            margin-top: 15px;
            min-height: 20px;
            text-align: center;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        .auth-col .error-message { color: #d9534f; }
        .auth-col .success-message { color: #5cb85c; }
        .auth-col .warning-message { color: #E69500; }

        .auth-col .resend-verification-link {
            color: #6720bd;
            text-decoration: underline;
            cursor: pointer;
        }
        
        .right-panel-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .auth-split-container { flex-direction: column; margin: 20px; }
            .auth-col.left-col { border-right: none; border-bottom: 1px solid #eee; }
            .right-col { display: none; } /* Hide right panel on mobile during linking */
        }
    </style>
</head>
<body>
    <section class="hero-section dark-bg">
        <div class="container"> <h1>LOG INTO 4SP</h1> </div>
    </section>
    
    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"> <a href="index.html"><img src="images/logo-dark.png" alt="4SP Logo"></a> </div>
            <nav class="main-nav"> <ul> <li><a href="index.html">HOME</a></li> <li><a href="signup.html">SIGN UP</a></li> </ul> </nav>
            <div class="auth-buttons"> <a href="login.html" class="btn btn-login">LOGIN</a> <a href="signup.html" class="btn btn-signup">SIGN UP</a> </div>
        </div>
    </header>

    <div class="auth-split-container">
        <div class="auth-col left-col">
            
            <div id="loginContainer">
                <h2>Login to Your Account</h2>
                <form id="loginForm" novalidate>
                    <div class="input-group"> <label for="loginEmail">Email</label> <input type="email" id="loginEmail" placeholder="Enter your email" required> </div>
                    <div class="input-group"> <label for="loginPassword">Password</label> <input type="password" id="loginPassword" placeholder="Enter your password" required> </div>
                    <button type="submit" class="btn-primary">LOGIN</button>
                </form>
                <div id="loginMessage" class="message-area"></div>
                <div class="forgot-password-link"> <a id="forgotPasswordLink">Forgot Password?</a> </div>
                <p class="switch-link">Don't have an account? <a href="signup.html">Sign up here</a></p>
            </div>

            <div id="resetPasswordContainer" style="display: none;">
                <h2>Reset Your Password</h2>
                <p style="text-align: center; max-width: 350px;">Enter your email address and we'll send you a link to reset your password.</p>
                <form id="resetPasswordForm" novalidate>
                    <div class="input-group"> <label for="resetEmail">Email</label> <input type="email" id="resetEmail" placeholder="Enter your registered email" required> </div>
                    <button type="submit" class="btn-primary">SEND RESET LINK</button>
                </form>
                <div id="resetMessage" class="message-area"></div>
                <div class="back-to-login-link"> <a id="backToLoginLink">&larr; Back to Login</a> </div>
            </div>

            <div id="linkingContainer" style="display: none; width: 100%; max-width: 350px; text-align: center; align-items: center;">
                <h2>Link Your Accounts</h2>
                <p id="linkingMessage" style="margin-bottom: 25px;"></p>
                <div id="linkingProviderButtonContainer" style="width: 100%;"></div>
                <div id="linkingPasswordContainer" style="display: none; width: 100%;">
                    <div class="input-group">
                        <label for="linkingPassword">Password</label>
                        <input type="password" id="linkingPassword" placeholder="Enter your password" required>
                    </div>
                    <button id="linkingPasswordBtn" class="btn-primary">Sign In & Link</button>
                </div>
                <div id="linkingErrorMessage" class="message-area"></div>
                <div class="switch-link" style="margin-top: 15px;">
                    <a id="cancelLinkingBtn">Cancel</a>
                </div>
            </div>

        </div>
        <div class="auth-col right-col">
            <div class="right-panel-content">
                <h2>Other ways to login</h2>
                <p style="text-align: center; margin-bottom: 25px;">Use a trusted provider like Google, GitHub or Microsoft to sign in instantly. It's the fastest way to access your account without needing to remember another password.</p>
                <button id="googleLoginBtn" class="btn-google"> <img src="images/google-icon.png" alt="Google Icon"> Login with Google </button>
                <button id="githubLoginBtn" class="btn-google"> <img src="images/github-mark.png" alt="GitHub Icon"> Login with GitHub </button>
                <button id="microsoftLoginBtn" class="btn-google"> <img src="../images/microsoft.png" alt="Microsoft Icon"> Login with Microsoft </button>
                <p class="oauth-agreement-text"> By logging in with third-party providers or via email, you agree to our <a href="legal.html" target="_blank">Terms of Service</a>, and our <a href="legal.html" target="_blank">Privacy Policy</a>. </p>
            </div>
        </div>
    </div>

    <footer>
        <div class="container"> <p>&copy; 2025 4SP. All rights reserved.</p> </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const db = firebase.firestore();
            const auth = firebase.auth();

            // Main UI Containers
            const loginContainer = document.getElementById('loginContainer');
            const resetPasswordContainer = document.getElementById('resetPasswordContainer');
            const rightPanel = document.querySelector('.auth-col.right-col');
            
            // Linking UI Containers
            const linkingContainer = document.getElementById('linkingContainer');
            const linkingMessage = document.getElementById('linkingMessage');
            const linkingProviderButtonContainer = document.getElementById('linkingProviderButtonContainer');
            const linkingPasswordContainer = document.getElementById('linkingPasswordContainer');
            const linkingPasswordInput = document.getElementById('linkingPassword');
            const linkingPasswordBtn = document.getElementById('linkingPasswordBtn');
            const cancelLinkingBtn = document.getElementById('cancelLinkingBtn');
            const linkingErrorMessage = document.getElementById('linkingErrorMessage');

            // Message Divs
            const loginMessageDiv = document.getElementById('loginMessage');
            const resetMessageDiv = document.getElementById('resetMessage');

            // Buttons
            const googleLoginBtn = document.getElementById('googleLoginBtn');
            const githubLoginBtn = document.getElementById('githubLoginBtn');
            const microsoftLoginBtn = document.getElementById('microsoftLoginBtn');

            function showMainLoginUI() {
                loginContainer.style.display = 'flex';
                rightPanel.style.display = 'flex';
                resetPasswordContainer.style.display = 'none';
                linkingContainer.style.display = 'none';

                loginMessageDiv.innerHTML = '';
                linkingErrorMessage.innerHTML = '';
                sessionStorage.removeItem('pendingCred');
            }

            // --- Event Listeners for UI toggling ---
            document.getElementById('forgotPasswordLink').addEventListener('click', () => {
                loginContainer.style.display = 'none';
                resetPasswordContainer.style.display = 'flex';
                resetPasswordContainer.style.flexDirection = 'column';
                loginMessageDiv.innerHTML = '';
            });

            document.getElementById('backToLoginLink').addEventListener('click', showMainLoginUI);
            cancelLinkingBtn.addEventListener('click', showMainLoginUI);


            const showMessage = (element, text, type = 'error') => {
                element.innerHTML = text;
                element.className = `message-area ${type}-message`;
            };

            const checkProfanity = async (text) => {
                if (!text || !text.trim()) return false;
                try {
                    const response = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
                    if (!response.ok) throw new Error('API request failed');
                    const result = await response.text();
                    return result.toLowerCase() === 'true';
                } catch (error) { console.error('Error calling profanity API:', error); return false; }
            };
            
            const isUsernameTaken = async (username) => {
                try {
                    const doc = await db.collection('usernames').doc(username).get();
                    return doc.exists;
                } catch (error) { 
                    console.error("Error checking username uniqueness:", error); 
                    return true;
                }
            };

            const updateUserAuthMethods = async (user, newProviderId) => {
                const userRef = db.collection('users').doc(user.uid);
                try {
                    const userDoc = await userRef.get();
                    if (userDoc.exists) {
                        const data = userDoc.data();
                        let methods = data.authMethods || (data.authMethod ? [data.authMethod] : []);
                        if (!Array.isArray(methods)) {
                            methods = [methods];
                        }
                        const providerName = newProviderId.split('.')[0];
                        if (!methods.includes(providerName)) {
                            methods.push(providerName);
                            await userRef.update({ authMethods: methods });
                        }
                    }
                } catch (error) {
                    console.error("Error updating user auth methods:", error);
                }
            };

            const createUserDocument = async (user, authMethod, username, explicitEmail = null) => {
                const emailToStore = explicitEmail || (user && user.email) || null;
                const isVerified = (authMethod !== 'password') ? true : !!(user && user.emailVerified);
                const userRef = db.collection('users').doc(user.uid);
                const usernameRef = db.collection('usernames').doc(username);
                try {
                    const batch = db.batch();
                    batch.set(userRef, {
                        email: emailToStore, 
                        authMethods: [authMethod], 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        username: username, 
                        emailVerified: isVerified
                    });
                    batch.set(usernameRef, { uid: user.uid });
                    await batch.commit();
                    return true;
                } catch (error) { 
                    console.error("Error creating user documents:", error); 
                    return false; 
                }
            };
            
            const handleSuccessfulLogin = async (user, isNewOrRepaired = false, newUsername = '') => {
                await user.reload();

                if (isNewOrRepaired) {
                    let countdown = 5;
                    const message = () => {
                        showMessage(loginMessageDiv, 
                            `Your account was incomplete, so we finished setting it up for you!<br>Your new username is <strong>${newUsername}</strong>.<br>Redirecting in ${countdown}...`, 
                            'warning'
                        );
                        countdown--;
                    };
                    
                    message();
                    const interval = setInterval(() => {
                        if (countdown < 0) {
                            clearInterval(interval);
                            window.location.href = 'logged-in/dashboard.html';
                        } else {
                            message();
                        }
                    }, 1000);
                    return; 
                }

                const isProviderLogin = user.providerData.some((provider) => provider.providerId !== 'password');
                if (user.emailVerified || isProviderLogin) {
                     window.location.href = 'logged-in/dashboard.html';
                } else {
                    loginMessageDiv.innerHTML = 'Your email is not verified. Please check your inbox. <a href="#" id="resend-link" class="resend-verification-link">Resend verification email</a>';
                    loginMessageDiv.className = 'message-area error-message';
                    document.getElementById('resend-link').addEventListener('click', async (event) => {
                        event.preventDefault();
                        try {
                            await user.sendEmailVerification();
                            showMessage(loginMessageDiv, 'A new verification link has been sent!', 'success');
                        } catch (err) { showMessage(loginMessageDiv, `Error sending email: ${err.message}`); }
                    });
                    await auth.signOut();
                }
            };
            
            const repairOrCreateUserDocument = async (user, providerName) => {
                let userEmail = user.email;
                let proposedUsername = user.displayName || userEmail.split('@')[0] || 'User';
                proposedUsername = proposedUsername.replace(/[^a-zA-Z0-9?!@#$%&\*\\-]/g, '').slice(0, 16);

                if (proposedUsername.length < 4) { proposedUsername = `User${user.uid.substring(0, 8)}`; } 
                if (await checkProfanity(proposedUsername)) { proposedUsername = `User${user.uid.substring(0, 8)}`; }

                let finalUsername = proposedUsername;
                let counter = 1;
                while (await isUsernameTaken(finalUsername)) {
                    const suffix = `_${counter}`;
                    const maxBaseLength = 16 - suffix.length;
                    const baseUsername = proposedUsername.substring(0, maxBaseLength);
                    finalUsername = `${baseUsername}${suffix}`;
                    counter++;
                }

                const documentCreated = await createUserDocument(user, providerName, finalUsername, userEmail);
                if (documentCreated) {
                    await handleSuccessfulLogin(user, true, finalUsername);
                } else {
                    throw new Error('Failed to create user document during login.');
                }
            };

            document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                resetMessageDiv.innerHTML = '';
                const email = document.getElementById('resetEmail').value;
                try {
                    const methods = await auth.fetchSignInMethodsForEmail(email);
                    if (methods.length === 0) { showMessage(resetMessageDiv, 'No account found with this email.'); } 
                    else if (!methods.includes('password')) { showMessage(resetMessageDiv, 'This account uses a third-party provider and does not have a password to reset.'); } 
                    else { await auth.sendPasswordResetEmail(email); showMessage(resetMessageDiv, 'Password reset link sent! Please check your inbox.', 'success'); }
                } catch (error) { showMessage(resetMessageDiv, 'An error occurred. Please try again.'); }
            });

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                loginMessageDiv.innerHTML = '';
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        await handleSuccessfulLogin(user);
                    } else {
                        await auth.signOut();
                        showMessage(loginMessageDiv, 'Your account record is incomplete. Please sign up again or contact support.');
                    }
                } catch (error) {
                    let message = 'An unknown login error occurred. Please try again.';
                    switch (error.code) {
                        case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': message = 'Invalid email or password.'; break;
                        case 'auth/too-many-requests': message = 'Access temporarily disabled due to too many failed login attempts.'; break;
                    }
                    showMessage(loginMessageDiv, message);
                }
            });

            const handleProviderLogin = async (provider) => {
                loginMessageDiv.innerHTML = '';
                linkingErrorMessage.innerHTML = '';
                try {
                    const result = await auth.signInWithPopup(provider);
                    const user = result.user;
                    
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        await handleSuccessfulLogin(user);
                    } else {
                        const providerName = provider.providerId.split('.')[0];
                        await repairOrCreateUserDocument(user, providerName);
                    }
                } catch (error) {
                    console.error('Provider Sign-In error:', error);

                    if (error.code === 'auth/account-exists-with-different-credential') {
                        const pendingCred = error.credential;
                        const email = error.email;
                        sessionStorage.setItem('pendingCred', JSON.stringify(pendingCred));
                        
                        const methods = await auth.fetchSignInMethodsForEmail(email);
                        
                        if (methods && methods.length > 0) {
                            const originalProviderId = methods[0];
                            const newProviderName = pendingCred.providerId.split('.')[0].replace(/^\w/, c => c.toUpperCase());
                            
                            loginContainer.style.display = 'none';
                            rightPanel.style.display = 'none';
                            linkingContainer.style.display = 'flex';
                            linkingContainer.style.flexDirection = 'column';

                            if (originalProviderId === 'password') {
                                linkingMessage.textContent = `This email is registered with a password. Please sign in with your password to link your ${newProviderName} account.`;
                                linkingProviderButtonContainer.innerHTML = '';
                                linkingPasswordContainer.style.display = 'block';
                                linkingPasswordInput.value = '';

                                linkingPasswordBtn.onclick = async () => {
                                    const password = linkingPasswordInput.value;
                                    if (!password) {
                                        showMessage(linkingErrorMessage, 'Please enter your password.');
                                        return;
                                    }
                                    try {
                                        const userCredential = await auth.signInWithEmailAndPassword(email, password);
                                        const user = userCredential.user;
                                        const pendingCredString = sessionStorage.getItem('pendingCred');
                                        if (pendingCredString) {
                                            const reconstructedCred = firebase.auth.OAuthCredential.fromJSON(pendingCredString);
                                            await user.linkWithCredential(reconstructedCred);
                                            await updateUserAuthMethods(user, reconstructedCred.providerId);
                                            showMessage(linkingErrorMessage, 'Accounts successfully linked! Redirecting...', 'success');
                                            setTimeout(() => handleSuccessfulLogin(user), 1500);
                                        }
                                    } catch (linkError) {
                                        showMessage(linkingErrorMessage, 'Incorrect password. Please try again.');
                                    }
                                };
                            } else {
                                const originalProviderName = originalProviderId.split('.')[0].replace(/^\w/, c => c.toUpperCase());
                                linkingMessage.textContent = `This email is already connected to an account with ${originalProviderName}. Please sign in with ${originalProviderName} to link your ${newProviderName} account.`;
                                linkingPasswordContainer.style.display = 'none';

                                const providerBtn = document.createElement('button');
                                providerBtn.className = 'btn-google';
                                let iconSrc = '';
                                if (originalProviderId.includes('google')) iconSrc = 'images/google-icon.png';
                                else if (originalProviderId.includes('github')) iconSrc = 'images/github-mark.png';
                                else if (originalProviderId.includes('microsoft')) iconSrc = '../images/microsoft.png';

                                providerBtn.innerHTML = `<img src="${iconSrc}" alt="${originalProviderName} Icon"> Sign in with ${originalProviderName} & Link`;
                                linkingProviderButtonContainer.innerHTML = '';
                                linkingProviderButtonContainer.appendChild(providerBtn);

                                providerBtn.onclick = async () => {
                                    let providerToLink;
                                    if (originalProviderId === 'google.com') providerToLink = new firebase.auth.GoogleAuthProvider();
                                    else if (originalProviderId === 'github.com') providerToLink = new firebase.auth.GithubAuthProvider();
                                    else if (originalProviderId === 'microsoft.com') providerToLink = new firebase.auth.OAuthProvider('microsoft.com');

                                    if (providerToLink) {
                                        try {
                                            const result = await auth.signInWithPopup(providerToLink);
                                            const user = result.user;
                                            const pendingCredString = sessionStorage.getItem('pendingCred');
                                            if (pendingCredString) {
                                                const reconstructedCred = firebase.auth.OAuthCredential.fromJSON(pendingCredString);
                                                await user.linkWithCredential(reconstructedCred);
                                                await updateUserAuthMethods(user, reconstructedCred.providerId);
                                                showMessage(linkingErrorMessage, 'Accounts successfully linked! Redirecting...', 'success');
                                                setTimeout(() => handleSuccessfulLogin(user), 1500);
                                            }
                                        } catch (linkError) {
                                            showMessage(linkingErrorMessage, 'Failed to sign in with the original provider. Please try again.');
                                        }
                                    }
                                };
                            }
                        } else {
                            showMessage(loginMessageDiv, 'An account with this email exists, but we could not determine the sign-in method. Please contact support.');
                        }
                        return;
                    }
                    
                    let message = `A problem occurred. Please try again.`;
                    if (error.code === 'auth/popup-closed-by-user') { return; }
                    showMessage(loginMessageDiv, message);
                }
            };

            googleLoginBtn.addEventListener('click', () => handleProviderLogin(new firebase.auth.GoogleAuthProvider()));
            githubLoginBtn.addEventListener('click', () => handleProviderLogin(new firebase.auth.GithubAuthProvider()));
            microsoftLoginBtn.addEventListener('click', () => handleProviderLogin(new firebase.auth.OAuthProvider('microsoft.com')));

            showMainLoginUI();
        });
    </script>
</body>
</html>

