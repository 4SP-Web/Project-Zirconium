<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MKGBA</title>

    <link rel="stylesheet" href="../../css/style.css" /> 
    <link rel="shortcut icon" type="image/x-icon" href="unnamed_ODh_icon.ico">
    <link rel="stylesheet" href="user_css/main.css">

    <style>
        body.dashboard-page {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            font-family: 'PrimaryFont', sans-serif; 
            background-color: #f0f2f5; 
        }
        .dashboard-container { display: flex; flex: 1; overflow: hidden; }

        .main-header {
            background-color: #ffffff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 0 20px;
            position: sticky; top: 0; z-index: 1002; 
        }
        .main-header .container { 
            display: flex; justify-content: space-between; align-items: center; height: 60px;
            max-width: 1200px; margin: 0 auto;
        }
        .main-header .logo img { height: 40px; cursor: pointer; }
        .main-header .auth-buttons { display: flex; align-items: center; }
        .main-header .btn {
            padding: 8px 18px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold;
            text-transform: uppercase; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif;
            font-size: 0.9em; margin-left: 10px;
        }
        .main-header .btn-login { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); color: white; }
        .main-header .btn-login:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(103, 32, 189, 0.4); }

        .sidebar {
            width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff;
            padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444;
            transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1001; 
            overflow-y: auto; 
        }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none;
            border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px;
            transition: transform 0.5s ease-in-out;
        }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a {
            display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none;
            border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif;
            text-transform: uppercase; position: relative; overflow: hidden;
        }
        .sidebar nav a::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        .sidebar nav a:hover::before { left: 100%; }
        .sidebar nav a.active, .sidebar nav a:hover {
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px);
        }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .sidebar.collapsed nav a { justify-content: center; padding: 10px 0; }
        .sidebar.collapsed nav a .label { display: none; }
        .user-info {
            text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555;
            padding-bottom: 20px; overflow: visible;
        }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em;}
        .marquee-content { display: inline-block; padding-left: 100%; transform: translateX(0); animation: none; line-height: 1.8em;}
        .marquee-active { animation: scroll-left 12s linear infinite; }
        .sidebar.collapsed .marquee-active { animation-duration: 20s; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .user-info .username { font-family: 'PrimaryFont', sans-serif; font-size: 1.3em; margin-bottom: 8px; line-height: 0.2em; font-weight: bold; }
        .user-info .email { font-family: 'SecondaryFont', sans-serif; font-size: 0.9em; color: #bbb; }
        
        .main-content {
            flex: 1;
            padding: 15px; 
            background: #1e1e1e; 
            display: flex;
            flex-direction: column;
            overflow: auto; 
            position: relative; 
            cursor: default; /* Ensure default cursor for main game area */
        }
        .game-launcher-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            flex-shrink: 0; 
        }
        #gameNameDisplay {
            margin: 0;
            font-size: 1.6em; 
            font-weight: bold;
            color: #e0e0e0;
            text-shadow: 0 0 3px rgba(128, 0, 128, 0.5);
        }
        #fullscreenBtn {
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            border: none; color: #fff; padding: 8px 15px; border-radius: 6px;
            font-family: 'PrimaryFont', sans-serif; cursor: pointer; transition: all 0.3s ease;
            font-size: 0.85em; font-weight: 600; text-transform: uppercase;
        }
        #fullscreenBtn:hover { transform: translateY(-1px); box-shadow: 0 2px 10px rgba(103, 32, 189, 0.3); }

        .emulator-area {
            flex-grow: 1; 
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            min-height: 0; 
            background-color: #000; 
            border-radius: 8px; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5); 
            cursor: default; /* Ensure default cursor here as well */
        }
        #emulator_target { 
            display: block;
            background-color: #000; 
            max-width: 100%; 
            max-height: 100%;
            object-fit: contain; 
            image-rendering: pixelated; 
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            cursor: default; /* Explicitly set cursor for the canvas */
        }
        
        .emulator-area:-webkit-full-screen { background: #000; width: 100vw; height:100vh; margin:0; padding:0; border-radius: 0; box-shadow: none;}
        .emulator-area:-moz-full-screen { background: #000; width: 100vw; height:100vh; margin:0; padding:0; border-radius: 0; box-shadow: none;}
        .emulator-area:-ms-fullscreen { background: #000; width: 100vw; height:100vh; margin:0; padding:0; border-radius: 0; box-shadow: none;}
        .emulator-area:fullscreen { background: #000; width: 100vw; height:100vh; margin:0; padding:0; border-radius: 0; box-shadow: none;}
        .emulator-area:fullscreen #emulator_target { width: 100%; height: 100%;}


        #tempMessage { color: #999; text-align: center; padding: 10px; font-size: 0.9em; flex-shrink: 0;}

        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .notification {
            position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: 8px;
            color: white; font-weight: 600; z-index: 10002;  transform: translateY(150%);
            transition: transform 0.4s ease-in-out; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .notification.success { background: linear-gradient(135deg, #28a745, #20c997); }
        .notification.error   { background: linear-gradient(135deg, #dc3545, #e83e8c); }
        .notification.info    { background: linear-gradient(135deg, #6720bd, #8a2be2); }
    </style>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-115293259-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-115293259-1');
    </script>

    <script src="IodineGBA/includes/TypedArrayShim.js"></script>
    <script src="IodineGBA/core/Cartridge.js"></script>
    <script src="IodineGBA/core/DMA.js"></script>
    <script src="IodineGBA/core/Emulator.js"></script>
    <script src="IodineGBA/core/Graphics.js"></script>
    <script src="IodineGBA/core/RunLoop.js"></script>
    <script src="IodineGBA/core/Memory.js"></script>
    <script src="IodineGBA/core/IRQ.js"></script>
    <script src="IodineGBA/core/JoyPad.js"></script>
    <script src="IodineGBA/core/Serial.js"></script>
    <script src="IodineGBA/core/Sound.js"></script>
    <script src="IodineGBA/core/Timer.js"></script>
    <script src="IodineGBA/core/Wait.js"></script>
    <script src="IodineGBA/core/CPU.js"></script>
    <script src="IodineGBA/core/Saves.js"></script>
    <script src="IodineGBA/core/sound/FIFO.js"></script>
    <script src="IodineGBA/core/sound/Channel1.js"></script>
    <script src="IodineGBA/core/sound/Channel2.js"></script>
    <script src="IodineGBA/core/sound/Channel3.js"></script>
    <script src="IodineGBA/core/sound/Channel4.js"></script>
    <script src="IodineGBA/core/CPU/ARM.js"></script>
    <script src="IodineGBA/core/CPU/THUMB.js"></script>
    <script src="IodineGBA/core/CPU/CPSR.js"></script>
    <script src="IodineGBA/core/graphics/Renderer.js"></script>
    <script src="IodineGBA/core/graphics/RendererProxy.js"></script>
    <script src="IodineGBA/core/graphics/BGTEXT.js"></script>
    <script src="IodineGBA/core/graphics/BG2FrameBuffer.js"></script>
    <script src="IodineGBA/core/graphics/BGMatrix.js"></script>
    <script src="IodineGBA/core/graphics/AffineBG.js"></script>
    <script src="IodineGBA/core/graphics/ColorEffects.js"></script>
    <script src="IodineGBA/core/graphics/Mosaic.js"></script>
    <script src="IodineGBA/core/graphics/OBJ.js"></script>
    <script src="IodineGBA/core/graphics/OBJWindow.js"></script>
    <script src="IodineGBA/core/graphics/Window.js"></script>
    <script src="IodineGBA/core/graphics/Compositor.js"></script>
    <script src="IodineGBA/core/memory/DMA0.js"></script>
    <script src="IodineGBA/core/memory/DMA1.js"></script>
    <script src="IodineGBA/core/memory/DMA2.js"></script>
    <script src="IodineGBA/core/memory/DMA3.js"></script>
    <script src="IodineGBA/core/cartridge/SaveDeterminer.js"></script>
    <script src="IodineGBA/core/cartridge/SRAM.js"></script>
    <script src="IodineGBA/core/cartridge/FLASH.js"></script>
    <script src="IodineGBA/core/cartridge/EEPROM.js"></script>
    <script src="user_scripts/XAudioJS/swfobject.js"></script>
    <script src="user_scripts/XAudioJS/resampler.js"></script>
    <script src="user_scripts/XAudioJS/XAudioServer.js"></script>
    <script src="user_scripts/IodineGBAROMLoadGlueCode.js"></script>
    <script src="user_scripts/IodineGBAJoyPadGlueCode.js"></script>
    <script src="user_scripts/IodineGBASavesGlueCode.js"></script>
    <script src="user_scripts/IodineGBAGraphicsGlueCode.js"></script>
    <script src="user_scripts/IodineGBAAudioGlueCode.js"></script>
    <script src="user_scripts/IodineGBACoreGlueCode.js"></script>
    <script src="user_scripts/base64.js"></script>
</head>

<body class="dashboard-page">
    <header class="main-header light-bg">
        <div class="container">
            <div class="logo">
                <a href="../../index.html"> 
                    <img src="../../images/logo-dark.png" alt="4SP Logo" /> 
                </a>
            </div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <div class="user-info">
                <div class="marquee-container"><span id="userName" class="marquee-content username">Loading…</span></div>
                <div class="marquee-container"><span id="userEmail" class="marquee-content email">Loading…</span></div>
            </div>
            <nav>
                <ul>
                    <li><a href="../dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="../proxies.html"><span class="icon">🛡️</span><span class="label">Proxies</span></a></li>
                    <li><a href="../soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="../games.html"><span class="icon">🎮</span><span class="label">Games Hub</span></a></li>
                    <li><a href="../others.html"><span class="icon">✨</span><span class="label">Others</span></a></li>
                    <li><a href="../settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content fade-in">
            <div class="game-launcher-header">
                <h1 id="gameNameDisplay">Loading Game...</h1>
                <button id="fullscreenBtn">Toggle Fullscreen</button>
            </div>
            <div class="emulator-area" id="emulatorArea">
                <canvas id="emulator_target" width="240" height="160"></canvas>
            </div>
            <span id="tempMessage"></span> 
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../../firebase-config.js"></script> 

    <script>
        const dbRef = () => {
            const currentUser = firebase.auth().currentUser;
            if (currentUser) {
                if (typeof db !== 'undefined') { return db.collection('users').doc(currentUser.uid); }
                else if (firebase.firestore) { return firebase.firestore().collection('users').doc(currentUser.uid); }
                else { console.error("Firestore 'db' instance not found."); return null; }
            }
            return null;
        };

        const marqueeEls = document.querySelectorAll('.marquee-content');
        const sidebar = document.getElementById('sidebar');
        const toggleSidebarBtn = document.getElementById('toggleSidebar');

        firebase.auth().onAuthStateChanged(async user => {
            if (!user) { return window.location.href = '../../login.html'; }
            document.getElementById('userEmail').textContent = user.email;
            try {
                const userDocRef = dbRef();
                if (userDocRef) {
                    const doc = await userDocRef.get();
                    const userData = doc.exists ? doc.data() : {};
                    document.getElementById('userName').textContent = userData.username || user.displayName || 'Gamer';
                } else { document.getElementById('userName').textContent = user.displayName || 'Gamer'; }
                updateMarquees();
            } catch (error) {
                console.error('Error loading user data:', error);
                document.getElementById('userName').textContent = user.displayName || 'Gamer';
                updateMarquees();
            }
        });

        const handleLogout = () => {
            firebase.auth().signOut()
                .then(() => { window.location.href = '../../login.html'; })
                .catch(error => { console.error('Logout error:', error); showNotification('Logout failed.', 'error'); });
        };
        document.getElementById('logoutBtn').onclick = handleLogout;
        if(document.getElementById('signOutLink')) { document.getElementById('signOutLink').onclick = handleLogout; }

        if (toggleSidebarBtn && sidebar) {
            toggleSidebarBtn.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                setTimeout(updateMarquees, 550);
            });
        }

        function updateMarquees() { 
            marqueeEls.forEach(el => {
                const container = el.parentElement;
                if (!container || container.offsetWidth === 0) { setTimeout(updateMarquees, 100); return; }
                const containerWidth = container.offsetWidth; const contentWidth = el.scrollWidth;
                el.classList.remove('marquee-active');
                if (contentWidth > containerWidth) { setTimeout(() => el.classList.add('marquee-active'), 50); }
            });
        }

        function showNotification(message, type = 'info', duration = 3000) { 
            const notification = document.createElement('div');
            notification.className = `notification ${type}`; notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.style.transform = 'translateY(0)'; }, 10);
            setTimeout(() => {
                notification.style.transform = 'translateY(150%)';
                setTimeout(() => { if (document.body.contains(notification)) document.body.removeChild(notification); }, 400);
            }, duration);
        }
        
        window.addEventListener('resize', () => { 
            setTimeout(updateMarquees, 300); 
        });

        const gameNameDisplay = document.getElementById('gameNameDisplay');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const emulatorArea = document.getElementById('emulatorArea');
        const emulatorCanvas = document.getElementById('emulator_target'); 

        function formatGameName(hash) {
            if (!hash || hash.length < 2) return "Game"; 
            let name = decodeURIComponent(hash.substring(1)); 
            name = name.replace(/[_\-\.]/g, ' '); 
            name = name.toLowerCase().replace(/\b[a-z]/g, char => char.toUpperCase());
            if (name.startsWith("Dbz ")) name = name.replace("Dbz", "DBZ"); 
            return name;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.documentElement.style.scrollBehavior = 'smooth';
            updateMarquees();

            const gameHash = window.location.hash;
            const formattedName = formatGameName(gameHash);
            if (gameNameDisplay) gameNameDisplay.textContent = formattedName;
            document.title = `Playing: ${formattedName} - 4SP`;

            if (fullscreenBtn && emulatorArea) {
                fullscreenBtn.addEventListener('click', () => {
                    if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                        if (emulatorArea.requestFullscreen) { emulatorArea.requestFullscreen(); } 
                        else if (emulatorArea.webkitRequestFullscreen) { emulatorArea.webkitRequestFullscreen(); } 
                        else if (emulatorArea.msRequestFullscreen) { emulatorArea.msRequestFullscreen(); }
                    } else {
                        if (document.exitFullscreen) { document.exitFullscreen(); } 
                        else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); } 
                        else if (document.msExitFullscreen) { document.msExitFullscreen(); }
                    }
                });
            }
            
            const fullscreenChangeEvents = [
                'fullscreenchange', 'webkitfullscreenchange', 
                'mozfullscreenchange', 'MSFullscreenChange'
            ];
            fullscreenChangeEvents.forEach(event => {
                document.addEventListener(event, () => {
                    const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
                    if (isFullscreen) {
                        fullscreenBtn.textContent = 'Exit Fullscreen';
                        emulatorCanvas.focus(); 
                    } else {
                        fullscreenBtn.textContent = 'Toggle Fullscreen';
                    }
                });
            });
        });

        var tid = setInterval(function() { 
            gtag('js', new Date());
            gtag('config', 'UA-115293259-1');
        }, 30000);
    </script>
</body>
</html>
