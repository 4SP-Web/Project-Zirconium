<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Constel Dashboard (by Vern)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style.css"> </head>

<body class="constel-page constel-dashboard-layout">

  <header class="main-header constel-header">
    <div class="container">
      <div class="logo">
        <a href="./index.html">
          <img src="../../images/logo.png" alt="Constel by Vern Logo" />
        </a>
      </div>
      <div class="auth-buttons">
        <button class="btn btn-link" onclick="window.location.href='../../index.html'">V4 Home</button>
        <button id="logoutBtnConstel" class="btn btn-primary">LOG OUT</button>
      </div>
    </div>
  </header>

  <div class="constel-app-container">
    <aside class="constel-sidebar">
      <nav>
        <ul>
          <li><a href="#dashboard" class="active-link" data-section="dashboard"><span class="icon">üìä</span><span class="label">Dashboard</span></a></li>
          <li><a href="#following" data-section="following"><span class="icon">üëÄ</span><span class="label">Following</span></a></li>
          <li><a href="#followers" data-section="followers"><span class="icon">üë•</span><span class="label">Followers</span></a></li>
          <li><a href="#friends" data-section="friends"><span class="icon">ü´Ç</span><span class="label">Friends</span></a></li>
          <li><a href="#chats" data-section="chats"><span class="icon">üí¨</span><span class="label">Chats</span></a></li>
          <li><a href="#groupchats" data-section="groupchats"><span class="icon">üó£Ô∏è</span><span class="label">Group Chats</span></a></li>
          <li><a href="#settings" data-section="settings"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
        </ul>
      </nav>
      <div class="sidebar-user-info">
        <span id="sidebarUsername" class="username-display">User</span>
      </div>
    </aside>

    <main class="constel-dashboard-main">
      <section id="dashboard-content" class="content-section active-section">
        <h1>Dashboard</h1>
        <p>Welcome to your Constel dashboard! Quick overview of your activity.</p>
        <div class="placeholder-content grid-2-cols">
            <div class="summary-card"><h3>0</h3><p>Following</p></div>
            <div class="summary-card"><h3>0</h3><p>Followers</p></div>
            <div class="summary-card"><h3>0</h3><p>Friends</p></div>
            <div class="summary-card"><h3>0</h3><p>New Messages</p></div>
        </div>
      </section>

      <section id="following-content" class="content-section">
        <h1>Following</h1>
        <div class="user-search-container">
            <input type="text" id="searchUsersInput" placeholder="Search users to follow...">
            <button id="searchUsersBtn">Search</button>
        </div>
        <div id="userSearchResults" class="user-list-container"></div>
        <h3>You are Following:</h3>
        <div id="followingList" class="user-list-container placeholder-content"><p>Loading who you follow...</p></div>
      </section>

      <section id="followers-content" class="content-section">
        <h1>Followers</h1>
        <h3>Users Following You:</h3>
        <div id="followersList" class="user-list-container placeholder-content"><p>Loading your followers...</p></div>
      </section>

      <section id="friends-content" class="content-section">
        <h1>Friends</h1>
        <h3>Your Mutual Connections:</h3>
        <div id="friendsList" class="user-list-container placeholder-content"><p>Loading your friends...</p></div>
      </section>

      <section id="chats-content" class="content-section">
        <h1>Chats</h1>
        <div class="chat-layout">
            <div class="chat-list-panel">
                <h3>Conversations</h3>
                <div id="chatSessionsList" class="placeholder-content"><p>Loading chats...</p></div>
            </div>
            <div class="chat-window-panel">
                <div id="chatWithHeader">Chatting with: <span id="chattingWithUsername">Select a conversation</span></div>
                <div id="chatMessagesArea" class="placeholder-content"><p>Messages will appear here.</p></div>
                <div class="chat-input-area">
                    <input type="text" id="chatMessageInput" placeholder="Type a message...">
                    <button id="sendChatMessageBtn">Send</button>
                </div>
            </div>
        </div>
      </section>

      <section id="groupchats-content" class="content-section">
        <h1>Group Chats</h1>
        <button id="createGroupChatBtn" class="action-button">Create New Group</button>
        <div class="chat-layout">
            <div class="chat-list-panel">
                <h3>Your Groups</h3>
                <div id="groupChatSessionsList" class="placeholder-content"><p>Loading group chats...</p></div>
            </div>
            <div class="chat-window-panel">
                 <div id="groupChatHeader">Group: <span id="currentGroupName">Select a group</span></div>
                <div id="groupChatMessagesArea" class="placeholder-content"><p>Group messages will appear here.</p></div>
                <div class="chat-input-area">
                    <input type="text" id="groupChatMessageInput" placeholder="Type a message...">
                    <button id="sendGroupChatMessageBtn">Send</button>
                </div>
            </div>
        </div>
      </section>

      <section id="settings-content" class="content-section">
        <h1>Constel Settings</h1>
        <p>Manage your Constel-specific preferences here. For main site settings, please visit the V4 settings page.</p>
        <div class="settings-options-container">
            <div class="setting-item">
                <label for="constelNotifications">Enable Constel Notifications:</label>
                <input type="checkbox" id="constelNotifications" checked>
            </div>
            <div class="setting-item">
                <label for="constelProfileVisibility">Profile Visibility:</label>
                <select id="constelProfileVisibility">
                    <option value="public">Public</option>
                    <option value="friends">Friends Only</option>
                    <option value="private">Private (Only You)</option>
                </select>
            </div>
            <button id="saveConstelSettingsBtn" class="action-button">Save Settings</button>
        </div>
      </section>
      <div id="statusMessages" style="margin-top: 20px;"></div>
    </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="../../firebase-config.js"></script>
  <script>
    // --- DOM Elements ---
    const statusMessagesEl = document.getElementById('statusMessages');
    const sidebarUsernameEl = document.getElementById('sidebarUsername');
    // Add other DOM element references here as you implement features

    // --- Firebase Refs & State ---
    let currentUser = null;
    const db = firebase.firestore();
    const userProfileDocRef = (uid) => db.collection('users').doc(uid); // Generic user profile

    // --- Utility Functions ---
    function showStatusMessage(message, type = 'info', duration = 4000) { /* ... (same as before) ... */ }
    function escapeHTML(str) { /* ... (same as before) ... */ }


    // --- Sidebar & General Auth ---
    const logoutBtnConstel = document.getElementById('logoutBtnConstel');
    if (logoutBtnConstel) { /* ... (logout logic same as before) ... */ }

    firebase.auth().onAuthStateChanged(async user => {
      currentUser = user;
      if (user) {
        if(sidebarUsernameEl) sidebarUsernameEl.textContent = user.displayName || user.email.split('@')[0];
        
        const userProfRef = userProfileDocRef(user.uid);
        try {
            const docSnap = await userProfRef.get();
            if (docSnap.exists && sidebarUsernameEl && docSnap.data().username) {
                sidebarUsernameEl.textContent = docSnap.data().username;
            }
        } catch (error) { console.error("Error fetching sidebar username:", error); }
        
        // Initialize dashboard view
        navigateToSection('dashboard'); 
        // TODO: Call functions to load initial data for dashboard, lists, etc.
        // e.g., loadFollowingList(); loadFollowersList(); loadFriendsList(); loadChatSessions(); etc.

      } else {
        if(sidebarUsernameEl) sidebarUsernameEl.textContent = "Guest";
        window.location.href = '../../login.html';
      }
    });

    // --- Sidebar Navigation & Content Switching ---
    const sidebarLinks = document.querySelectorAll('.constel-sidebar nav a');
    const contentSections = document.querySelectorAll('.content-section');
    const mainContentH1 = document.querySelector('.constel-dashboard-main h1'); // Assuming first h1 is main title

    function navigateToSection(sectionId) {
        sidebarLinks.forEach(l => l.classList.remove('active-link'));
        const activeLink = document.querySelector(`.constel-sidebar nav a[data-section="${sectionId}"]`);
        if (activeLink) activeLink.classList.add('active-link');
        
        let sectionTitle = "Dashboard"; // Default
        contentSections.forEach(section => {
            if (section.id === sectionId + '-content') {
                section.classList.add('active-section');
                // Try to get title from link label
                if(activeLink && activeLink.querySelector('.label')) {
                    sectionTitle = activeLink.querySelector('.label').textContent;
                } else if (section.querySelector('h1')) { // Or from section's H1
                    sectionTitle = section.querySelector('h1').textContent;
                }
            } else {
                section.classList.remove('active-section');
            }
        });
        // This direct update might not be ideal if each section has its own H1.
        // This dashboard.html has H1s in each section. So this line might be redundant.
        // if(mainContentH1) mainContentH1.textContent = sectionTitle;
    }

    sidebarLinks.forEach(link => {
        link.addEventListener('click', (event) => {
            event.preventDefault();
            const sectionId = link.dataset.section;
            navigateToSection(sectionId);
            // Update URL hash for basic history/bookmarking (optional)
            // window.location.hash = sectionId; 
        });
    });

    // --- Feature Function Stubs & Conceptual Logic ---

    // == Following / Followers / Friends ==
    async function followUser(targetUserId) {
        if (!currentUser) return;
        showStatusMessage("Following user...", "info", 0);
        // 1. Add to current user's 'following' subcollection/array
        // 2. Add to target user's 'followers' subcollection/array
        // Use a batch write for atomicity
        // await refreshAllLists();
        showStatusMessage("Successfully followed user!", "success");
    }
    async function unfollowUser(targetUserId) { /* ... similar logic ... */ }
    async function loadFollowingList() { /* ... fetch and display ... */ }
    async function loadFollowersList() { /* ... fetch and display ... */ }
    async function loadFriendsList() { /* ... fetch, determine mutuals, display ... */ }

    // == 1-on-1 Chats ==
    let currentOpenChatId = null;
    let messagesUnsubscribe = null;

    async function loadChatSessions() { /* ... fetch list of chats, display them ... */ }
    async function openChat(friendUserId, friendUsername) {
        if (!currentUser) return;
        const members = [currentUser.uid, friendUserId].sort();
        currentOpenChatId = members.join('_');
        document.getElementById('chattingWithUsername').textContent = friendUsername;
        document.getElementById('chatMessagesArea').innerHTML = '<p>Loading messages...</p>';
        
        if (messagesUnsubscribe) messagesUnsubscribe(); // Unsubscribe from previous chat
        messagesUnsubscribe = db.collection('chats').doc(currentOpenChatId).collection('messages')
            .orderBy('timestamp', 'asc')
            .onSnapshot(snapshot => {
                document.getElementById('chatMessagesArea').innerHTML = ''; // Clear
                snapshot.forEach(doc => displayChatMessage(doc.data()));
                // Scroll to bottom
            }, error => {
                console.error("Error listening to messages:", error);
                document.getElementById('chatMessagesArea').innerHTML = '<p>Error loading messages.</p>';
            });
    }
    function displayChatMessage(msgData) { /* ... append message to chatMessagesArea ... */ }
    async function sendChatMessage() {
        if (!currentUser || !currentOpenChatId) return;
        const inputEl = document.getElementById('chatMessageInput');
        const text = inputEl.value.trim();
        if (!text) return;
        // Censor text if needed using your censorText function
        // await db.collection('chats').doc(currentOpenChatId).collection('messages').add({...});
        // await db.collection('chats').doc(currentOpenChatId).set({ lastMessage: {...} }, { merge: true });
        inputEl.value = '';
    }
    // document.getElementById('sendChatMessageBtn').addEventListener('click', sendChatMessage);


    // == Group Chats ==
    // Similar structure: loadGroupChatSessions, openGroupChat, sendGroupChatMessage, displayGroupChatMessage
    // Create group chat will involve a modal or form to add members and name the group.

    // == Settings ==
    async function loadConstelSettings() { /* ... fetch user's constelSettings, populate form ... */ }
    async function saveConstelSettings() {
        // ... get values from form, update user's constelSettings in Firestore ...
        showStatusMessage("Constel settings saved!", "success");
    }
    // document.getElementById('saveConstelSettingsBtn').addEventListener('click', saveConstelSettings);

    // Initial call if hash exists from bookmark/refresh (optional)
    // if (window.location.hash) {
    //    const section = window.location.hash.substring(1);
    //    navigateToSection(section);
    // }


    // Utility functions (copied from notes.html for consistency if used)
    // Make sure escapeHTML is defined:
    // function escapeHTML(str) { ... }
    // Make sure showStatusMessage is defined (it is above)
  </script>
</body>
</html>
