<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - Vernsocial</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Base & Layout --- */
        body {
            font-family: 'Inter', sans-serif; /* Changed to Inter for a more modern feel */
            overflow: hidden; /* Prevent scrolling on the body */
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #f0f2f5;
        }

        .app-shell-container {
            display: flex;
            flex: 1;
            height: calc(100vh - 70px); /* Adjust height for the new main header */
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 320px; /* Wider for chat lists and friend management */
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #444;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .user-info {
            padding: 20px 15px;
            border-bottom: 1px solid #555;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-details {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #4f46e5;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        #current-username {
            font-weight: 700;
            font-size: 1.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #current-user-id {
            font-size: 0.8rem;
            color: #aaa;
        }

        #logout-btn {
            background: #dc3545;
            border: none;
            color: white;
            padding: 8px 12px;
            font-size: 0.85em;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        #logout-btn:hover {
            background: #c82333;
        }
        
        .sidebar-navigation {
            display: flex;
            border-bottom: 1px solid #444;
        }

        .sidebar-tab {
            flex-grow: 1;
            padding: 15px 10px;
            text-align: center;
            background-color: transparent;
            border: none;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            font-size: 0.9em;
            font-weight: 600;
        }

        .sidebar-tab:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .sidebar-tab.active-tab {
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            color: white;
        }
        
        .sidebar-content-area {
            flex-grow: 1;
            overflow-y: auto;
        }

        .sidebar-list {
            list-style: none;
            padding: 8px;
            margin: 0;
        }

        .sidebar-list li {
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-size: 0.95em;
        }
        
        .sidebar-list li:hover {
            background-color: #3a3a3a;
        }
        
        .sidebar-list li.active-chat {
            background: #6720bd;
            color: white;
            font-weight: bold;
            transform: scale(1.02);
        }

        .friend-list-item, .request-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 0 8px 5px 8px;
            background: #3e3e3e;
        }

        .friend-actions button, .request-actions button {
            border: none;
            color: white;
            padding: 5px 10px;
            font-size: 0.8em;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s ease;
        }
        .friend-actions button:hover, .request-actions button:hover {
            transform: translateY(-1px);
        }
        .friend-actions .message-friend-btn { background-color: #28a745; }
        .request-actions .accept-friend-btn { background-color: #28a745; }
        .friend-actions .unfriend-btn, .request-actions .decline-friend-btn { background-color: #6c757d; }
        /* NEW style for the block button */
        .friend-actions .block-btn { background-color: #dc3545; }
        
        .sidebar-section {
            padding: 12px 0;
        }
        
        .sidebar-section h5 {
            font-weight: bold;
            margin-bottom: 8px;
            padding: 0 15px;
            color: #ddd;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        
        .add-friend-section {
            padding: 15px;
            border-bottom: 1px solid #444;
        }
        #search-username-input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #2a2a2a;
            color: white;
            margin-bottom: 8px;
        }
        #search-user-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: #4f46e5;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        #search-results {
            margin-top: 10px;
            font-size: 0.9em;
            padding: 8px;
            background-color: rgba(0,0,0,0.2);
            border-radius: 5px;
            min-height: 20px;
        }

        /* --- Main Content Area --- */
        .main-content {
            flex-grow: 1;
            background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        #chat-view, #welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin: 20px;
            margin-top: 0;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            background: white;
        }
        
        #welcome-screen {
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        #welcome-screen h2 { font-size: 2em; color: #333; }
        #welcome-screen p { color: #666; font-size: 1.2em; }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background-color: #f8f9fa;
        }

        #chat-name { font-size: 1.5rem; font-weight: 700; }

        #messages-container {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }
        
        .chat-footer {
            padding: 1rem 1.5rem;
            background-color: #f8f9fa;
            border-top: 1px solid #e2e8f0;
        }
        
        #message-input-wrapper { position: relative; }
        
        #message-input {
            width: 100%;
            padding: 1rem 6rem 1rem 1rem;
            border-radius: 12px;
            border: 1px solid #ccc;
            resize: none;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        #message-input:focus {
            outline: none;
            border-color: #6720bd;
        }
        
        #send-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        #char-counter {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }

        /* --- Chat Bubbles & Messages --- */
        .message-wrapper {
            display: flex;
            margin-bottom: 1rem;
            align-items: flex-end;
            gap: 10px;
        }

        .message-wrapper.sent {
            justify-content: flex-end;
        }
        .message-wrapper.sent .message-content {
            align-items: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #64748b;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .message-content .sender-name {
            font-size: 0.8rem;
            color: #555;
            font-weight: 600;
        }
        
        .chat-bubble {
            max-width: 450px;
            padding: 10px 15px;
            border-radius: 20px;
            word-wrap: break-word;
            line-height: 1.4;
        }
        .chat-bubble.sent {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
            border-bottom-right-radius: 5px;
        }
        .chat-bubble.received {
            background-color: #e2e8f0; /* Slate-200 */
            color: #1e293b; /* Slate-800 */
            border-bottom-left-radius: 5px;
        }

        /* --- Scrollbar --- */
        .sidebar-content-area::-webkit-scrollbar,
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar-content-area::-webkit-scrollbar-track,
        #messages-container::-webkit-scrollbar-track {
            background: #2a2a2a;
        }
        .sidebar-content-area::-webkit-scrollbar-thumb,
        #messages-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        
        /* --- Auth Modal --- */
        #auth-container {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.75);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 1rem;
            width: 100%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .auth-title { font-size: 1.8rem; font-weight: 800; text-align: center; color: #1e293b; }
        .auth-form { margin-top: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .auth-form input {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid #ccc; border-radius: 0.5rem;
            font-size: 1rem; transition: all 0.2s;
        }
        .auth-form input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        .auth-form button {
            padding: 0.75rem; border-radius: 0.5rem; border: none; color: white;
            font-weight: 600; font-size: 1rem; cursor: pointer; transition: background-color 0.2s;
        }
        #login-btn { background-color: #3b82f6; } #login-btn:hover { background-color: #2563eb; }
        #signup-btn { background-color: #16a34a; } #signup-btn:hover { background-color: #15803d; }
        #auth-error { color: #ef4444; font-size: 0.9rem; text-align: center; margin-top: 1rem; min-height: 1.25rem;}
        .auth-toggle { font-size: 0.9rem; text-align: center; margin-top: 1rem; }
        .auth-toggle a { color: #4f46e5; font-weight: 600; cursor: pointer; }


        /* Utility */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="modal-content">
            <h2 id="auth-title" class="auth-title">Welcome to Vernsocial</h2>
            
            <div id="login-view">
                <form id="login-form" class="auth-form">
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit" id="login-btn">Login</button>
                </form>
                <p class="auth-toggle">Don't have an account? <a id="show-signup">Sign up</a></p>
            </div>

            <div id="signup-view" class="hidden">
                 <form id="signup-form" class="auth-form">
                    <input type="text" id="signup-username" placeholder="Username (unique, 3-20 chars)" required>
                    <input type="email" id="signup-email" placeholder="Email" required>
                    <input type="password" id="signup-password" placeholder="Password (min. 6 chars)" required>
                    <button type="submit" id="signup-btn">Sign Up</button>
                </form>
                 <p class="auth-toggle">Already have an account? <a id="show-login">Login</a></p>
            </div>
            <p id="auth-error"></p>
        </div>
    </div>


    <div id="app-container" class="hidden">
        <header class="main-header light-bg">
            <div class="container">
                <div class="logo">
                    <a href="dashboard.html">
                        <img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" />
                    </a>
                </div>
                <div class="auth-buttons">
                    <button class="btn btn-login" onclick="window.location.href='dashboard.html'">DASHBOARD</button>
                </div>
            </div>
        </header>

        <div class="app-shell-container">
            <aside class="sidebar">
                <div class="user-info">
                   <div class="user-details">
                        <div id="user-avatar"></div>
                        <div>
                            <h3 id="current-username">Loading...</h3>
                            <p id="current-user-id">Loading...</p>
                        </div>
                   </div>
                    <button id="logout-btn">Logout</button>
                </div>

                <div class="sidebar-navigation">
                    <button class="sidebar-tab active-tab" data-tab="chats">Chats</button>
                    <button class="sidebar-tab" data-tab="friends">Friends</button>
                </div>
                
                <div class="sidebar-content-area">
                    <div id="chats-tab" class="sidebar-content">
                        <ul id="chats-list" class="sidebar-list"></ul>
                    </div>

                    <div id="friends-tab" class="sidebar-content hidden">
                         <div class="add-friend-section">
                            <input type="text" id="search-username-input" placeholder="Enter exact username...">
                            <button id="search-user-btn">Search & Add Friend</button>
                            <div id="search-results"></div>
                        </div>
                        <div class="sidebar-section">
                            <h5>Friend Requests (<span id="request-count">0</span>)</h5>
                            <ul id="friend-requests-list"></ul>
                        </div>
                        <div class="sidebar-section">
                            <h5>Friends (<span id="friend-count">0</span>)</h5>
                            <ul id="friends-list"></ul>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="main-content">
                <div id="welcome-screen">
                    <h2>Welcome to Vernsocial!</h2>
                    <p>Select a chat from the sidebar to start messaging.</p>
                </div>

                <div id="chat-view" class="hidden">
                    <header class="chat-header">
                        <h3 id="chat-name"></h3>
                    </header>

                    <div id="messages-container"></div>

                    <footer class="chat-footer">
                        <div id="message-input-wrapper">
                            <textarea id="message-input" placeholder="Type a message..." maxlength="250" rows="1"></textarea>
                            <button id="send-btn">Send</button>
                        </div>
                        <p id="char-counter">0/250</p>
                    </footer>
                </div>
            </main>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script src="../firebase-config.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Initialization ---
        if (typeof firebaseConfig === 'undefined') {
            document.body.innerHTML = "<h1>Error: Firebase config not found.</h1>";
            return;
        }
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        // Auth Forms
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const authError = document.getElementById('auth-error');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        // App UI
        const logoutBtn = document.getElementById('logout-btn');
        const currentUserAvatar = document.getElementById('user-avatar');
        const currentUsernameEl = document.getElementById('current-username');
        const currentUserIdEl = document.getElementById('current-user-id');
        const sidebarTabs = document.querySelectorAll('.sidebar-tab');
        const chatsListEl = document.getElementById('chats-list');
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatView = document.getElementById('chat-view');
        const chatNameEl = document.getElementById('chat-name');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const charCounter = document.getElementById('char-counter');
        // Friends UI
        const searchUserInput = document.getElementById('search-username-input');
        const searchUserBtn = document.getElementById('search-user-btn');
        const searchResultsEl = document.getElementById('search-results');
        const friendRequestsListEl = document.getElementById('friend-requests-list');
        const friendsListEl = document.getElementById('friends-list');
        const friendCountEl = document.getElementById('friend-count');
        const requestCountEl = document.getElementById('request-count');


        // --- App State ---
        let currentUser = null;
        let currentChatId = null;
        let unsubscribeAllListeners = [];
        const userCache = new Map();

        // --- Auth State Change ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                initializeAppForUser(user.uid);
            } else {
                currentUser = null;
                cleanupListeners();
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                resetUI();
            }
        });

        // --- Auth Form Logic ---
        showSignup.addEventListener('click', (e) => { 
            e.preventDefault(); 
            document.getElementById('login-view').classList.add('hidden'); 
            document.getElementById('signup-view').classList.remove('hidden'); 
            authError.textContent = ''; 
        });
        showLogin.addEventListener('click', (e) => { 
            e.preventDefault(); 
            document.getElementById('signup-view').classList.add('hidden'); 
            document.getElementById('login-view').classList.remove('hidden'); 
            authError.textContent = ''; 
        });
        
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            authError.textContent = '';
            if (username.length < 3 || username.length > 20) { authError.textContent = 'Username must be 3-20 characters.'; return; }
            if (password.length < 6) { authError.textContent = 'Password must be at least 6 characters.'; return; }
            
            try {
                const usernameCheck = await db.collection('users').where('username', '==', username).get();
                if (!usernameCheck.empty) { throw new Error('Username is already taken.'); }
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // CRITICAL FIX: Add photoURL and bio fields to satisfy security rules on user creation.
                await db.collection('users').doc(userCredential.user.uid).set({
                    username: username,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    photoURL: '', // Default empty value
                    bio: ''       // Default empty value
                });
            } catch (error) { authError.textContent = error.message; }
        });
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authError.textContent = '';
            try { 
                await auth.signInWithEmailAndPassword(email, password); 
            } catch (error) { authError.textContent = error.message; }
        });

        logoutBtn.addEventListener('click', () => auth.signOut());

        // --- App Initialization & Cleanup ---
        async function initializeAppForUser(uid) {
            cleanupListeners();
            const userDoc = await db.collection('users').doc(uid).get();
            if (userDoc.exists) {
                const userData = { id: uid, ...userDoc.data() };
                userCache.set(uid, userData);
                currentUsernameEl.textContent = userData.username;
                currentUserAvatar.textContent = userData.username.charAt(0).toUpperCase();
            } else {
                 currentUsernameEl.textContent = "User not found";
            }
            currentUserIdEl.textContent = `UID: ${uid.substring(0, 8)}...`;
            listenForFriendships(uid);
            listenForChats(uid);
        }
        
        function cleanupListeners() {
            unsubscribeAllListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeAllListeners = [];
        }
        
        function resetUI() {
            chatsListEl.innerHTML = '';
            friendRequestsListEl.innerHTML = '';
            friendsListEl.innerHTML = '';
            welcomeScreen.classList.remove('hidden');
            chatView.classList.add('hidden');
            userCache.clear();
        }

        // --- Sidebar Tab Navigation ---
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                sidebarTabs.forEach(t => t.classList.remove('active-tab'));
                tab.classList.add('active-tab');
                document.querySelectorAll('.sidebar-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`${tab.dataset.tab}-tab`).classList.remove('hidden');
            });
        });

        // --- Helper to get user data with caching ---
        async function getUserData(uid) {
            if (userCache.has(uid)) return userCache.get(uid);
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if(userDoc.exists) {
                    const data = { id: uid, ...userDoc.data() };
                    userCache.set(uid, data);
                    return data;
                }
            } catch (error) {
                console.error("Error fetching user data:", error);
            }
            return null;
        }

        // --- Friend Management Logic ---
        function listenForFriendships(uid) {
            const friendshipsQuery = db.collection('friendships').where('users', 'array-contains', uid);
            const unsubscribe = friendshipsQuery.onSnapshot(async snapshot => {
                const friends = [];
                const requests = [];
                const blocked = []; // Not displayed, but good to track
                
                for (const doc of snapshot.docs) {
                    const data = { id: doc.id, ...doc.data()};
                    const otherUserId = data.users.find(id => id !== uid);
                    const otherUser = await getUserData(otherUserId);
                    if (!otherUser) continue;

                    const friendship = { ...data, otherUser };

                    if (friendship.status === 'friends') {
                        friends.push(friendship);
                    } else if (friendship.status === 'pending' && friendship.requester !== uid) {
                        requests.push(friendship);
                    } else if (friendship.status === 'blocked') {
                        blocked.push(friendship);
                    }
                }
                renderFriendsList(friends);
                renderFriendRequestsList(requests);
            }, error => {
                console.error("Snapshot listener for friendships failed:", error);
            });
            unsubscribeAllListeners.push(unsubscribe);
        }

        function renderFriendsList(friends) {
            friendsListEl.innerHTML = '';
            friendCountEl.textContent = friends.length;
            friends.forEach(friend => {
                const li = document.createElement('li');
                li.className = 'friend-list-item';
                // UPDATED: Added a "Block" button
                li.innerHTML = `<span>${friend.otherUser.username}</span>
                                <div class="friend-actions">
                                    <button class="message-friend-btn" data-uid="${friend.otherUser.id}">Message</button>
                                    <button class="unfriend-btn" data-fid="${friend.id}">Unfriend</button>
                                    <button class="block-btn" data-fid="${friend.id}">Block</button>
                                </div>`;
                friendsListEl.appendChild(li);
            });
            friendsListEl.querySelectorAll('.message-friend-btn').forEach(b => b.addEventListener('click', (e) => startDmChat(e.target.dataset.uid)));
            friendsListEl.querySelectorAll('.unfriend-btn').forEach(b => b.addEventListener('click', (e) => unfriend(e.target.dataset.fid)));
            // NEW: Event listener for the block button
            friendsListEl.querySelectorAll('.block-btn').forEach(b => b.addEventListener('click', (e) => blockUser(e.target.dataset.fid)));
        }

        function renderFriendRequestsList(requests) {
            friendRequestsListEl.innerHTML = '';
            requestCountEl.textContent = requests.length;
            requests.forEach(req => {
                const li = document.createElement('li');
                li.className = 'request-list-item';
                li.innerHTML = `<span>${req.otherUser.username}</span>
                                <div class="request-actions">
                                    <button class="accept-friend-btn" data-fid="${req.id}">Accept</button>
                                    <button class="decline-friend-btn" data-fid="${req.id}">Decline</button>
                                </div>`;
                friendRequestsListEl.appendChild(li);
            });
            friendRequestsListEl.querySelectorAll('.accept-friend-btn').forEach(b => b.addEventListener('click', (e) => acceptFriendRequest(e.target.dataset.fid)));
            friendRequestsListEl.querySelectorAll('.decline-friend-btn').forEach(b => b.addEventListener('click', (e) => declineFriendRequest(e.target.dataset.fid)));
        }

        searchUserBtn.addEventListener('click', async () => {
            const username = searchUserInput.value.trim();
            searchResultsEl.textContent = '';
            if (!username) { searchResultsEl.textContent = 'Please enter a username.'; return; }
            if (username === currentUsernameEl.textContent) { searchResultsEl.textContent = 'You cannot add yourself.'; return; }

            try {
                const querySnapshot = await db.collection('users').where('username', '==', username).get();
                if (querySnapshot.empty) {
                    searchResultsEl.textContent = 'User not found.';
                    return;
                }
                const targetUserDoc = querySnapshot.docs[0];
                const targetUid = targetUserDoc.id;
                
                const friendshipId = [currentUser.uid, targetUid].sort().join('_');
                const friendshipDoc = await db.collection('friendships').doc(friendshipId).get();
                if (friendshipDoc.exists) {
                    searchResultsEl.textContent = `You are already connected with this user (${friendshipDoc.data().status}).`;
                    return;
                }
                
                await db.collection('friendships').doc(friendshipId).set({
                    users: [currentUser.uid, targetUid],
                    status: 'pending',
                    requester: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                searchResultsEl.textContent = `Friend request sent to ${username}!`;
                searchUserInput.value = '';
            } catch (error) {
                console.error("Error sending friend request:", error);
                searchResultsEl.textContent = 'Could not send request.';
            }
        });

        async function acceptFriendRequest(friendshipId) {
            try {
                await db.collection('friendships').doc(friendshipId).update({ status: 'friends' });
            } catch (error) { console.error("Error accepting request:", error); }
        }

        async function declineFriendRequest(friendshipId) {
            try {
                await db.collection('friendships').doc(friendshipId).delete();
            } catch (error) { console.error("Error declining request:", error); }
        }
        
        async function unfriend(friendshipId) {
            if (confirm("Are you sure you want to unfriend this user? This will also delete the chat history.")) {
                try {
                    const batch = db.batch();
                    const friendshipRef = db.collection('friendships').doc(friendshipId);
                    const chatRef = db.collection('chats').doc(friendshipId);
                    
                    batch.delete(friendshipRef);
                    batch.delete(chatRef); // Also delete the associated chat
                    
                    await batch.commit();
                } catch (error) { console.error("Error unfriending:", error); }
            }
        }
        
        // NEW: Function to block a user
        async function blockUser(friendshipId) {
            if (confirm("Are you sure you want to block this user? You will no longer see their messages, and your chat history will be deleted.")) {
                try {
                    const batch = db.batch();
                    const friendshipRef = db.collection('friendships').doc(friendshipId);
                    const chatRef = db.collection('chats').doc(friendshipId);

                    // Update the friendship status to 'blocked'
                    batch.update(friendshipRef, {
                        status: 'blocked',
                        blocker: currentUser.uid
                    });
                    
                    // Also delete the associated chat
                    batch.delete(chatRef);

                    await batch.commit();
                } catch (error) {
                    console.error("Error blocking user:", error);
                    alert("Could not block user. They may have already been unfriended.");
                }
            }
        }
        
        // --- Chat & Messaging Logic ---
        function listenForChats(uid) {
            const chatsQuery = db.collection('chats').where('members', 'array-contains', uid);
            const unsubscribe = chatsQuery.onSnapshot(async snapshot => {
                const chatPromises = snapshot.docs.map(async doc => {
                    const chatData = doc.data();
                    const otherMembers = chatData.members.filter(m => m !== uid);
                    let chatName = chatData.groupName || "Group Chat";
                    if (chatData.type === 'dm' && otherMembers.length > 0) {
                        const otherUser = await getUserData(otherMembers[0]);
                        chatName = otherUser ? otherUser.username : "Unknown User";
                    } else if (chatData.type === 'dm') {
                        chatName = "Deleted User";
                    }
                    return { id: doc.id, name: chatName, data: chatData, lastUpdated: chatData.lastUpdated };
                });
                let chats = await Promise.all(chatPromises);
                chats.sort((a,b) => (b.lastUpdated?.seconds || b.data.createdAt?.seconds || 0) - (a.lastUpdated?.seconds || a.data.createdAt?.seconds || 0));
                renderChatsList(chats);
            });
            unsubscribeAllListeners.push(unsubscribe);
        }

        function renderChatsList(chats) {
            chatsListEl.innerHTML = '';
            chats.forEach(chat => {
                const li = document.createElement('li');
                li.textContent = chat.name;
                li.dataset.chatId = chat.id;
                if (chat.id === currentChatId) li.classList.add('active-chat');
                li.addEventListener('click', () => openChat(chat.id));
                chatsListEl.appendChild(li);
            });
        }
        
        async function startDmChat(otherUserId) {
            const chatId = [currentUser.uid, otherUserId].sort().join('_');
            const chatRef = db.collection('chats').doc(chatId);
            
            try {
                const chatDoc = await chatRef.get();
                if (!chatDoc.exists) {
                    await chatRef.set({
                        members: [currentUser.uid, otherUserId],
                        type: 'dm',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                openChat(chatId);
                document.querySelector('.sidebar-tab[data-tab="chats"]').click();

            } catch (error) {
                console.error("Error starting DM chat:", error);
                alert("Could not start chat. The user may have blocked you.");
            }
        }
        
        function openChat(chatId) {
            if (currentChatId === chatId) return;
            
            let oldListenerIndex = unsubscribeAllListeners.findIndex(l => l.isMessageListener);
            if (oldListenerIndex > -1) {
                unsubscribeAllListeners[oldListenerIndex]();
                unsubscribeAllListeners.splice(oldListenerIndex, 1);
            }

            currentChatId = chatId;
            
            document.querySelectorAll('#chats-list li').forEach(li => {
                li.classList.toggle('active-chat', li.dataset.chatId === chatId);
            });
            
            welcomeScreen.classList.add('hidden');
            chatView.classList.remove('hidden');
            messagesContainer.innerHTML = `<div class="text-center text-gray-500">Loading messages...</div>`;

             const chatMetaUnsubscribe = db.collection('chats').doc(chatId).onSnapshot(async doc => {
                if (doc.exists) {
                    const chatData = doc.data();
                    const otherUserId = chatData.members.find(id => id !== currentUser.uid);
                    const otherUser = await getUserData(otherUserId);
                    chatNameEl.textContent = otherUser ? otherUser.username : "Chat";
                } else {
                    chatNameEl.textContent = "Chat deleted";
                    chatView.classList.add('hidden');
                    welcomeScreen.classList.remove('hidden');
                    currentChatId = null;
                }
            });
            unsubscribeAllListeners.push(chatMetaUnsubscribe);

            const messagesQuery = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc');
            const messagesUnsubscribe = messagesQuery.onSnapshot(async snapshot => {
                const messages = snapshot.docs.map(doc => doc.data());
                renderMessages(messages);
            }, error => {
                console.error("Error listening to messages:", error);
                messagesContainer.innerHTML = `<div class="text-center text-red-500">Could not load messages. You may be blocked by this user.</div>`;
            });

            messagesUnsubscribe.isMessageListener = true; 
            unsubscribeAllListeners.push(messagesUnsubscribe);
        }
        
        async function renderMessages(messages) {
            messagesContainer.innerHTML = '';
            
            for (const msg of messages) {
                const sender = await getUserData(msg.senderId);
                if (!sender) continue;

                const isSent = msg.senderId === currentUser.uid;
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `message-wrapper ${isSent ? 'sent' : ''}`;
                
                const avatar = `<div class="message-avatar" style="background-color: ${getUserColor(sender.username)}">${sender.username.charAt(0).toUpperCase()}</div>`;
                const messageBody = `
                    <div class="message-content">
                        <p class="sender-name">${sender.username}</p>
                        <div class="chat-bubble ${isSent ? 'sent' : 'received'}">
                            <p>${msg.text.replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>`;

                messageWrapper.innerHTML = isSent ? messageBody + avatar : avatar + messageBody;
                messagesContainer.appendChild(messageWrapper);
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentChatId) return;

            const messagePayload = {
                senderId: currentUser.uid,
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            const chatRef = db.collection('chats').doc(currentChatId);
            const newMessageRef = chatRef.collection('messages').doc();

            try {
                const batch = db.batch();
                batch.set(newMessageRef, messagePayload);
                batch.update(chatRef, { 
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                await batch.commit();

                messageInput.value = '';
                updateCharCounter();
            } catch (error) {
                console.error("Error sending message:", error);
                alert("Failed to send message. You may have been blocked by this user.");
            }
        }
        
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                sendMessage(); 
            } 
        });
        messageInput.addEventListener('input', updateCharCounter);
        function updateCharCounter() { charCounter.textContent = `${messageInput.value.length}/250`; }

        // --- UI Helpers ---
        function getUserColor(username) {
            if (!username) return '#cccccc';
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                let value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }

    });
    </script>
</body>
</html>
