<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - VS</title>
    <!-- Assuming PrimaryFont and SecondaryFont are defined in this stylesheet -->
    <link rel="stylesheet" href="../css/style.css">
    <!-- Tailwind CSS for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define fallback fonts in case the external stylesheet fails to load */
        :root {
            --primary-font: 'PrimaryFont', sans-serif;
            --secondary-font: 'SecondaryFont', sans-serif;
        }

        /* --- Base & Layout --- */
        body {
            font-family: var(--primary-font);
            overflow: hidden;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #f0f2f5;
        }

        .app-shell-container {
            display: flex;
            flex: 1;
            height: calc(100vh - 70px);
        }

        /* --- Header --- */
        .main-header {
            background: white;
            padding: 10px 20px;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .main-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .main-header .logo img { height: 40px; }
        .main-header .auth-buttons .btn {
            font-family: var(--secondary-font);
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
         .main-header .auth-buttons .btn-login {
            background-color: #4f46e5;
            color: white;
        }
        .main-header .auth-buttons .btn-logout {
             background-color: #dc3545;
             color: white;
             margin-left: 10px;
        }


        /* --- Sidebar --- */
        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #444;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .user-info {
            padding: 20px 15px;
            border-bottom: 1px solid #555;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #4f46e5;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        #current-username {
            font-family: var(--secondary-font);
            font-weight: 700;
            font-size: 1.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sidebar-navigation {
            display: flex;
            border-bottom: 1px solid #444;
        }

        .sidebar-tab {
            flex-grow: 1;
            padding: 15px 10px;
            text-align: center;
            background-color: transparent;
            border: none;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: var(--secondary-font);
            text-transform: uppercase;
            font-size: 0.9em;
            font-weight: 600;
        }

        .sidebar-tab:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .sidebar-tab.active-tab {
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            color: white;
        }
        
        .sidebar-content-area {
            flex-grow: 1;
            overflow-y: auto;
        }

        .sidebar-list { list-style: none; padding: 8px; margin: 0; }
        .sidebar-list li { padding: 12px 15px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; font-size: 0.95em; font-family: var(--secondary-font); }
        .sidebar-list li:hover { background-color: #3a3a3a; }
        .sidebar-list li.active-chat { background: #6720bd; color: white; font-weight: bold; transform: scale(1.02); }

        .friend-list-item, .request-list-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; border-radius: 8px; margin: 0 8px 5px 8px; background: #3e3e3e; font-family: var(--secondary-font); }
        .friend-actions button, .request-actions button, #add-friend-btn { border: none; color: white; padding: 5px 10px; font-size: 0.8em; border-radius: 5px; cursor: pointer; margin-left: 5px; font-weight: 600; transition: background-color 0.2s, transform 0.1s ease; }
        .friend-actions button:hover, .request-actions button:hover, #add-friend-btn:hover { transform: translateY(-1px); }
        .friend-actions .message-friend-btn, .request-actions .accept-friend-btn, #add-friend-btn { background-color: #28a745; }
        .friend-actions .unfriend-btn, .request-actions .decline-friend-btn { background-color: #dc3545; }
        
        .sidebar-section h5 { font-weight: bold; margin-bottom: 8px; padding: 0 15px; color: #ddd; text-transform: uppercase; font-size: 0.8rem; font-family: var(--secondary-font);}
        .add-friend-section { padding: 15px; border-bottom: 1px solid #444; }
        #search-username-input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #555; background-color: #2a2a2a; color: white; margin-bottom: 8px; font-family: var(--primary-font); }
        #search-user-btn { width: 100%; padding: 10px; border: none; border-radius: 8px; background: #4f46e5; color: white; font-weight: 600; cursor: pointer; font-family: var(--secondary-font); }
        #search-results { margin-top: 10px; font-size: 0.9em; padding: 8px; background-color: rgba(0,0,0,0.2); border-radius: 5px; min-height: 20px; }
        #search-results .profile { display: flex; justify-content: space-between; align-items: center; }

        /* --- Main Content Area --- */
        .main-content { flex-grow: 1; background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%); display: flex; flex-direction: column; height: 100%; }
        #chat-view, #welcome-screen { flex: 1; display: flex; flex-direction: column; overflow: hidden; margin: 20px; margin-top: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); background: white; }
        #welcome-screen { align-items: center; justify-content: center; text-align: center; }
        #welcome-screen h2 { font-size: 2em; color: #333; font-family: var(--secondary-font); }
        #welcome-screen p { color: #666; font-size: 1.2em; font-family: var(--primary-font); }

        .chat-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e2e8f0; background-color: #f8f9fa; display: flex; justify-content: space-between; align-items: center; }
        #chat-name { font-size: 1.5rem; font-weight: 700; font-family: var(--secondary-font); }
        #settings-btn { background: none; border: none; cursor: pointer; font-size: 1.5rem; color: #555; transition: transform 0.2s; }
        #settings-btn:hover { transform: rotate(45deg); }

        #messages-container { flex-grow: 1; padding: 1.5rem; overflow-y: auto; }
        .chat-footer { padding: 1rem 1.5rem; background-color: #f8f9fa; border-top: 1px solid #e2e8f0; }
        #message-input-wrapper { position: relative; }
        #message-input { width: 100%; padding: 1rem 6rem 1rem 1rem; border-radius: 12px; border: 1px solid #ccc; resize: none; box-sizing: border-box; transition: border-color 0.2s; font-family: var(--primary-font); }
        #message-input:focus { outline: none; border-color: #6720bd; }
        #send-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: var(--secondary-font); }
        #char-counter { font-size: 0.8rem; color: #666; margin-top: 5px; text-align: right; font-family: var(--primary-font); }

        .message-wrapper { display: flex; margin-bottom: 1rem; align-items: flex-end; gap: 10px; }
        .message-wrapper.sent { justify-content: flex-end; }
        .message-wrapper.sent .message-content { align-items: flex-end; }
        .message-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #64748b; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .message-content { display: flex; flex-direction: column; max-width: calc(100% - 50px); }
        .message-content .sender-name { font-size: 0.8rem; color: #555; font-weight: 600; font-family: var(--secondary-font); margin-bottom: 4px; }
        .chat-bubble { max-width: 100%; padding: 10px 15px; border-radius: 20px; word-wrap: break-word; line-height: 1.4; font-family: var(--primary-font); }
        .chat-bubble.sent { background-color: #3b82f6; color: white; border-bottom-right-radius: 5px; }
        .chat-bubble.received { background-color: #e2e8f0; color: #1e293b; border-bottom-left-radius: 5px; }
        .message-timestamp { font-size: 0.75rem; color: #999; margin-top: 4px; font-family: var(--primary-font); }

        .sidebar-content-area::-webkit-scrollbar, #messages-container::-webkit-scrollbar { width: 8px; }
        .sidebar-content-area::-webkit-scrollbar-track, #messages-container::-webkit-scrollbar-track { background: #444; }
        .sidebar-content-area::-webkit-scrollbar-thumb, #messages-container::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        
        /* Settings Modal */
        #settings-modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 2rem; border-radius: 1rem; width: 100%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-content h2 { font-family: var(--secondary-font); color: #333; margin-bottom: 1rem; }
        .modal-content label { font-family: var(--secondary-font); font-weight: 600; color: #555; }
        .modal-content input { width: 100%; padding: 0.75rem 1rem; border: 1px solid #ccc; border-radius: 0.5rem; font-size: 1rem; margin-top: 0.5rem; font-family: var(--primary-font); }
        .modal-actions { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.5rem; }
        .modal-actions button { padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; color: white; font-weight: 600; cursor: pointer; font-family: var(--secondary-font); }
        #save-nickname-btn { background-color: #16a34a; }
        #cancel-nickname-btn { background-color: #6c757d; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="app-container" class="hidden">
        <header class="main-header">
            <div class="container">
                <div class="logo">
                    <a href="dashboard.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" /></a>
                </div>
                <div class="auth-buttons">
                    <button class="btn btn-login" onclick="window.location.href='dashboard.html'">DASHBOARD</button>
                    <button id="logout-btn" class="btn btn-logout">LOGOUT</button>
                </div>
            </div>
        </header>

        <div class="app-shell-container">
            <aside class="sidebar">
                <div class="user-info">
                    <div id="user-avatar"></div>
                    <h3 id="current-username">Loading...</h3>
                </div>
                <div class="sidebar-navigation">
                    <button class="sidebar-tab active-tab" data-tab="chats">Chats</button>
                    <button class="sidebar-tab" data-tab="friends">Friends</button>
                </div>
                <div class="sidebar-content-area">
                    <div id="chats-tab" class="sidebar-content">
                        <ul id="chats-list" class="sidebar-list"></ul>
                    </div>
                    <div id="friends-tab" class="sidebar-content hidden">
                         <div class="add-friend-section">
                            <input type="text" id="search-username-input" placeholder="Enter exact username...">
                            <button id="search-user-btn">Search</button>
                            <div id="search-results"></div>
                        </div>
                        <div class="sidebar-section">
                            <h5>Friend Requests (<span id="request-count">0</span>)</h5>
                            <ul id="friend-requests-list"></ul>
                        </div>
                        <div class="sidebar-section">
                            <h5>Friends (<span id="friend-count">0</span>)</h5>
                            <ul id="friends-list"></ul>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="main-content">
                <div id="welcome-screen">
                    <h2>Welcome to VS!</h2>
                    <p>Select a chat from the sidebar to start messaging.</p>
                </div>
                <div id="chat-view" class="hidden">
                    <header class="chat-header">
                        <h3 id="chat-name"></h3>
                        <button id="settings-btn">⚙️</button>
                    </header>
                    <div id="messages-container"></div>
                    <footer class="chat-footer">
                        <div id="message-input-wrapper">
                            <textarea id="message-input" placeholder="Type a message..." maxlength="250" rows="1"></textarea>
                            <button id="send-btn">Send</button>
                        </div>
                        <p id="char-counter">0/250</p>
                    </footer>
                </div>
            </main>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden">
        <div class="modal-content">
            <h2 id="nickname-modal-title">Set Nickname</h2>
            <label for="nickname-input">Nickname for this user:</label>
            <input type="text" id="nickname-input" placeholder="Enter a nickname...">
            <div class="modal-actions">
                <button id="cancel-nickname-btn">Cancel</button>
                <button id="save-nickname-btn">Save</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Initialization ---
        if (typeof firebaseConfig === 'undefined') {
            document.body.innerHTML = "<h1>Error: Firebase config not found. Please ensure firebase-config.js is loaded correctly.</h1>";
            return;
        }
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        // App UI
        const logoutBtn = document.getElementById('logout-btn');
        const currentUserAvatar = document.getElementById('user-avatar');
        const currentUsernameEl = document.getElementById('current-username');
        const sidebarTabs = document.querySelectorAll('.sidebar-tab');
        const chatsListEl = document.getElementById('chats-list');
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatView = document.getElementById('chat-view');
        const chatNameEl = document.getElementById('chat-name');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const charCounter = document.getElementById('char-counter');
        // Friends UI
        const searchUserInput = document.getElementById('search-username-input');
        const searchUserBtn = document.getElementById('search-user-btn');
        const searchResultsEl = document.getElementById('search-results');
        const friendRequestsListEl = document.getElementById('friend-requests-list');
        const friendsListEl = document.getElementById('friends-list');
        const friendCountEl = document.getElementById('friend-count');
        const requestCountEl = document.getElementById('request-count');
        // Settings & Nickname Modal
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const nicknameModalTitle = document.getElementById('nickname-modal-title');
        const nicknameInput = document.getElementById('nickname-input');
        const saveNicknameBtn = document.getElementById('save-nickname-btn');
        const cancelNicknameBtn = document.getElementById('cancel-nickname-btn');

        // --- App State ---
        let currentUser = null;
        let currentChatId = null;
        let currentChatOtherUserId = null; // To keep track of who we are chatting with for nicknames
        let unsubscribeAllListeners = [];
        const userCache = new Map();

        // --- Auth State Change: Redirect if not logged in ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                appContainer.classList.remove('hidden');
                initializeAppForUser(user.uid);
            } else {
                currentUser = null;
                cleanupListeners();
                // Redirect to login page if not authenticated
                window.location.href = '../login.html'; 
            }
        });

        // --- Auth Logic ---
        logoutBtn.addEventListener('click', () => auth.signOut());

        // --- App Initialization & Cleanup ---
        async function initializeAppForUser(uid) {
            cleanupListeners();
            const userDoc = await db.collection('users').doc(uid).get();
            if (userDoc.exists) {
                const userData = { id: uid, ...userDoc.data() };
                userCache.set(uid, userData);
                currentUsernameEl.textContent = userData.username;
                currentUserAvatar.textContent = userData.username.charAt(0).toUpperCase();
            } else {
                 currentUsernameEl.textContent = "User not found";
                 currentUserAvatar.textContent = "?";
            }
            listenForFriendships(uid);
            listenForChats(uid);
        }
        
        function cleanupListeners() {
            unsubscribeAllListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeAllListeners = [];
        }
        
        function resetUI() {
            chatsListEl.innerHTML = '';
            friendRequestsListEl.innerHTML = '';
            friendsListEl.innerHTML = '';
            welcomeScreen.classList.remove('hidden');
            chatView.classList.add('hidden');
            userCache.clear();
        }

        // --- Sidebar Tab Navigation ---
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                sidebarTabs.forEach(t => t.classList.remove('active-tab'));
                tab.classList.add('active-tab');
                document.querySelectorAll('.sidebar-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`${tab.dataset.tab}-tab`).classList.remove('hidden');
            });
        });

        // --- Helper Functions ---
        async function getUserData(uid) {
            if (userCache.has(uid)) return userCache.get(uid);
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if(userDoc.exists) {
                    const data = { id: uid, ...userDoc.data() };
                    userCache.set(uid, data);
                    return data;
                }
            } catch (error) { console.error("Error fetching user data:", error); }
            return null;
        }

        function getNickname(friendId) {
            return localStorage.getItem(`nickname_${currentUser.uid}_${friendId}`);
        }

        function setNickname(friendId, nickname) {
            if (nickname) {
                localStorage.setItem(`nickname_${currentUser.uid}_${friendId}`, nickname);
            } else {
                localStorage.removeItem(`nickname_${currentUser.uid}_${friendId}`);
            }
        }

        // --- Friend Management Logic ---
        function listenForFriendships(uid) {
            const friendshipsQuery = db.collection('friendships').where('users', 'array-contains', uid);
            const unsubscribe = friendshipsQuery.onSnapshot(async snapshot => {
                const friends = [];
                const requests = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const otherUserId = data.users.find(id => id !== uid);
                    const friendship = { id: doc.id, ...data, otherUserId };
                    if (friendship.status === 'friends') {
                        friends.push(friendship);
                    } else if (friendship.status === 'pending' && friendship.requester !== uid) {
                        requests.push(friendship);
                    }
                });
                await renderFriendsList(friends);
                await renderFriendRequestsList(requests);
            });
            unsubscribeAllListeners.push(unsubscribe);
        }

        async function renderFriendsList(friends) {
            friendsListEl.innerHTML = '';
            friendCountEl.textContent = friends.length;
            for (const friend of friends) {
                const otherUser = await getUserData(friend.otherUserId);
                if (!otherUser) continue;
                const li = document.createElement('li');
                li.className = 'friend-list-item';
                li.innerHTML = `<span>${getNickname(otherUser.id) || otherUser.username}</span>
                                <div class="friend-actions">
                                    <button class="message-friend-btn" data-uid="${otherUser.id}">Message</button>
                                    <button class="unfriend-btn" data-fid="${friend.id}" data-ouid="${otherUser.id}">Unfriend</button>
                                </div>`;
                friendsListEl.appendChild(li);
            }
            friendsListEl.querySelectorAll('.message-friend-btn').forEach(b => b.addEventListener('click', (e) => startDmChat(e.target.dataset.uid)));
            friendsListEl.querySelectorAll('.unfriend-btn').forEach(b => b.addEventListener('click', (e) => unfriend(e.target.dataset.fid, e.target.dataset.ouid)));
        }

        async function renderFriendRequestsList(requests) {
            friendRequestsListEl.innerHTML = '';
            requestCountEl.textContent = requests.length;
            for(const req of requests) {
                const otherUser = await getUserData(req.otherUserId);
                if (!otherUser) continue;
                const li = document.createElement('li');
                li.className = 'request-list-item';
                li.innerHTML = `<span>${otherUser.username}</span>
                                <div class="request-actions">
                                    <button class="accept-friend-btn" data-fid="${req.id}">Accept</button>
                                    <button class="decline-friend-btn" data-fid="${req.id}">Decline</button>
                                </div>`;
                friendRequestsListEl.appendChild(li);
            }
            friendRequestsListEl.querySelectorAll('.accept-friend-btn').forEach(b => b.addEventListener('click', (e) => acceptFriendRequest(e.target.dataset.fid)));
            friendRequestsListEl.querySelectorAll('.decline-friend-btn').forEach(b => b.addEventListener('click', (e) => declineFriendRequest(e.target.dataset.fid)));
        }
        
        searchUserBtn.addEventListener('click', async () => {
            const username = searchUserInput.value.trim();
            searchResultsEl.innerHTML = '';
            if (!username) { searchResultsEl.textContent = 'Please enter a username.'; return; }
            if (username === currentUsernameEl.textContent) { searchResultsEl.textContent = 'You cannot add yourself.'; return; }

            try {
                const querySnapshot = await db.collection('users').where('username', '==', username).get();
                if (querySnapshot.empty) {
                    searchResultsEl.textContent = 'User not found.';
                    return;
                }
                const targetUserDoc = querySnapshot.docs[0];
                const targetUser = {id: targetUserDoc.id, ...targetUserDoc.data()};
                
                searchResultsEl.innerHTML = `<div class="profile">
                                                <span>${targetUser.username}</span>
                                                <button id="add-friend-btn" data-uid="${targetUser.id}">Add Friend</button>
                                             </div>`;
                document.getElementById('add-friend-btn').addEventListener('click', sendFriendRequest);

            } catch (error) {
                console.error("Error searching for user:", error);
                searchResultsEl.textContent = 'Error finding user.';
            }
        });

        async function sendFriendRequest(event) {
            const targetUid = event.target.dataset.uid;
            const friendshipId = [currentUser.uid, targetUid].sort().join('_');
            
            try {
                const friendshipDoc = await db.collection('friendships').doc(friendshipId).get();
                if (friendshipDoc.exists) {
                    searchResultsEl.innerHTML = `You are already connected with this user (${friendshipDoc.data().status}).`;
                    return;
                }

                await db.collection('friendships').doc(friendshipId).set({
                    users: [currentUser.uid, targetUid],
                    status: 'pending',
                    requester: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                searchResultsEl.textContent = `Friend request sent!`;
                searchUserInput.value = '';
            } catch (error) {
                console.error("Error sending friend request:", error);
                searchResultsEl.textContent = 'Could not send request.';
            }
        }


        async function acceptFriendRequest(friendshipId) {
            try { await db.collection('friendships').doc(friendshipId).update({ status: 'friends' }); }
            catch (error) { console.error("Error accepting request:", error); }
        }

        async function declineFriendRequest(friendshipId) {
            try { await db.collection('friendships').doc(friendshipId).delete(); }
            catch (error) { console.error("Error declining request:", error); }
        }
        
        async function unfriend(friendshipId, otherUserId) {
            // A custom modal/confirm should be used here in a real app
            if (confirm("Are you sure you want to unfriend this user? This will also delete your chat history with them.")) {
                try {
                    // 1. Delete friendship document
                    await db.collection('friendships').doc(friendshipId).delete();
                    
                    // 2. Remove nickname from local storage
                    localStorage.removeItem(`nickname_${currentUser.uid}_${otherUserId}`);
                    
                    // 3. Delete the DM chat document between the two users
                    const chatId = [currentUser.uid, otherUserId].sort().join('_');
                    await db.collection('chats').doc(chatId).delete();

                    // 4. If the deleted chat was open, reset the view
                    if(currentChatId === chatId) {
                        welcomeScreen.classList.remove('hidden');
                        chatView.classList.add('hidden');
                        currentChatId = null;
                        currentChatOtherUserId = null;
                    }

                } catch (error) { console.error("Error unfriending:", error); alert("Could not complete unfriend operation.")}
            }
        }
        
        // --- Chat & Messaging Logic ---
        function listenForChats(uid) {
            const chatsQuery = db.collection('chats').where('members', 'array-contains', uid);
            const unsubscribe = chatsQuery.onSnapshot(async snapshot => {
                const chatPromises = snapshot.docs.map(async doc => {
                    const chatData = doc.data();
                    const otherMembers = chatData.members.filter(m => m !== uid);
                    let chatName = "Chat";
                    let otherUserId = null;
                    if (chatData.type === 'dm' && otherMembers.length > 0) {
                        otherUserId = otherMembers[0];
                        const nickname = getNickname(otherUserId);
                        const otherUser = await getUserData(otherUserId);
                        chatName = nickname || (otherUser ? otherUser.username : "Unknown User");
                    }
                    return { id: doc.id, name: chatName, lastUpdated: chatData.lastUpdated, otherUserId: otherUserId };
                });
                let chats = await Promise.all(chatPromises);
                chats.sort((a,b) => (b.lastUpdated?.seconds || 0) - (a.lastUpdated?.seconds || 0));
                renderChatsList(chats);
            });
            unsubscribeAllListeners.push(unsubscribe);
        }

        function renderChatsList(chats) {
            chatsListEl.innerHTML = '';
            chats.forEach(chat => {
                const li = document.createElement('li');
                li.textContent = chat.name;
                li.dataset.chatId = chat.id;
                li.dataset.otherUserId = chat.otherUserId;
                if (chat.id === currentChatId) li.classList.add('active-chat');
                li.addEventListener('click', () => openChat(chat.id, chat.otherUserId));
                chatsListEl.appendChild(li);
            });
        }
        
        async function startDmChat(otherUserId) {
            const chatId = [currentUser.uid, otherUserId].sort().join('_');
            const chatRef = db.collection('chats').doc(chatId);
            
            try {
                const chatDoc = await chatRef.get();
                if (!chatDoc.exists) {
                    await chatRef.set({
                        members: [currentUser.uid, otherUserId],
                        type: 'dm',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        messages: []
                    });
                }
                openChat(chatId, otherUserId);
            } catch (error) { console.error("Error starting DM chat:", error); }
        }
        
        function openChat(chatId, otherUserId) {
            if (currentChatId === chatId) return;
            
            // Clean up old listener
            let oldListenerIndex = unsubscribeAllListeners.findIndex(l => l.isChatListener);
            if (oldListenerIndex > -1) {
                unsubscribeAllListeners[oldListenerIndex]();
                unsubscribeAllListeners.splice(oldListenerIndex, 1);
            }

            currentChatId = chatId;
            currentChatOtherUserId = otherUserId; // Store for nickname logic
            
            document.querySelectorAll('#chats-list li').forEach(li => li.classList.toggle('active-chat', li.dataset.chatId === chatId));
            
            welcomeScreen.classList.add('hidden');
            chatView.classList.remove('hidden');
            messagesContainer.innerHTML = `<div class="text-center text-gray-500">Loading messages...</div>`;

            const messagesUnsubscribe = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp').onSnapshot(async snapshot => {
                const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMessages(messages);
                const nickname = getNickname(otherUserId);
                const otherUser = await getUserData(otherUserId);
                chatNameEl.textContent = nickname || (otherUser ? otherUser.username : "Chat");
            });

            messagesUnsubscribe.isChatListener = true; // Tag the listener
            unsubscribeAllListeners.push(messagesUnsubscribe);
        }
        
        async function renderMessages(messages) {
            messagesContainer.innerHTML = '';
            for (const msg of messages) {
                const sender = await getUserData(msg.senderId);
                if (!sender) continue;

                const isSent = msg.senderId === currentUser.uid;
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `message-wrapper ${isSent ? 'sent' : ''}`;
                
                const senderName = getNickname(sender.id) || sender.username;
                const timestamp = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleString() : '';

                const avatar = `<div class="message-avatar" style="background-color: ${getUserColor(sender.username)}">${sender.username.charAt(0).toUpperCase()}</div>`;
                const messageBody = `
                    <div class="message-content">
                        <p class="sender-name">${senderName}</p>
                        <div class="chat-bubble ${isSent ? 'sent' : 'received'}">
                            <p>${msg.text.replace(/\n/g, '<br>')}</p>
                        </div>
                        <div class="message-timestamp">${timestamp}</div>
                    </div>`;

                messageWrapper.innerHTML = isSent ? messageBody + avatar : avatar + messageBody;
                messagesContainer.appendChild(messageWrapper);
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentChatId) return;

            const messagePayload = {
                text: text,
                senderId: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                // Add message to subcollection
                await db.collection('chats').doc(currentChatId).collection('messages').add(messagePayload);
                // Update lastUpdated on parent chat doc for sorting chat list
                await db.collection('chats').doc(currentChatId).update({ lastUpdated: firebase.firestore.FieldValue.serverTimestamp() });

                messageInput.value = '';
                updateCharCounter();
                messageInput.style.height = 'auto';
            } catch (error) {
                console.error("Error sending message:", error);
                alert("Failed to send message.");
            }
        }
        
        // --- Event Listeners ---
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                sendMessage(); 
            } 
        });
        messageInput.addEventListener('input', () => {
            updateCharCounter();
            // Auto-resize textarea
            messageInput.style.height = 'auto';
            messageInput.style.height = `${messageInput.scrollHeight}px`;
        });
        function updateCharCounter() { charCounter.textContent = `${messageInput.value.length}/250`; }

        // --- Settings Modal Logic ---
        settingsBtn.addEventListener('click', async () => {
            if (!currentChatOtherUserId) return;
            const otherUser = await getUserData(currentChatOtherUserId);
            nicknameModalTitle.textContent = `Set Nickname for ${otherUser.username}`;
            nicknameInput.value = getNickname(currentChatOtherUserId) || '';
            settingsModal.classList.remove('hidden');
        });

        cancelNicknameBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        saveNicknameBtn.addEventListener('click', () => {
            const newNickname = nicknameInput.value.trim();
            setNickname(currentChatOtherUserId, newNickname);
            chatNameEl.textContent = newNickname || userCache.get(currentChatOtherUserId)?.username || "Chat";
            // Refresh friends list to show new nickname
            listenForFriendships(currentUser.uid);
             // Refresh chat list to show new nickname
            listenForChats(currentUser.uid);
            settingsModal.classList.add('hidden');
        });

        // --- UI Helpers ---
        function getUserColor(username) {
            if (!username) return '#cccccc';
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                let value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }

    });
    </script>
</body>
</html>
