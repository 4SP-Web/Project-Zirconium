<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - Playlists Remade</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="../panic-key.js"></script>

    <style>
        /* --- CORE REDESIGN STYLES --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --font-primary: 'Inter', sans-serif;
            --base-bg: #f0f2f5;
            --sidebar-bg: #1f1f23;
            --text-light: #e4e4e7;
            --text-dark: #18181b;
            --text-muted: #a1a1aa;
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-color-1: 98;
            --accent-color-2: 58;
            --accent-color-3: 162;
            --accent-gradient: linear-gradient(45deg, rgb(var(--accent-color-1), var(--accent-color-2), var(--accent-color-3)), rgb(139, 92, 246));
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            font-family: var(--font-primary);
            background-color: var(--base-bg);
            color: var(--text-dark);
            line-height: 1.5;
            overflow: hidden; /* Prevent body scroll */
        }
        
        .main-layout { display: flex; flex-grow: 1; height: calc(100vh - 70px); }

        /* --- Sidebar (Adopted from original for consistency) --- */
        .sidebar {
            width: 240px;
            background-color: var(--sidebar-bg);
            color: var(--text-light);
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            transition: width 0.3s ease;
        }
        .sidebar nav a { 
            color: var(--text-light); 
            text-decoration: none; display: flex; align-items: center; padding: 12px; border-radius: 8px; 
            transition: background-color 0.2s;
        }
        .sidebar nav a.active, .sidebar nav a:hover { background-color: rgba(255,255,255,0.08); }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; margin-right: 15px; }

        /* --- NEW MASTER-DETAIL LAYOUT --- */
        .playlist-master-view {
            width: 320px;
            background-color: #e9ebee;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            border-right: 1px solid #dcdfe3;
        }
        .master-header { margin-bottom: 20px; }
        .master-header h2 { font-size: 1.5rem; margin: 0; }
        .master-actions { display: flex; gap: 10px; margin-top: 15px; }
        .master-btn {
            flex-grow: 1; padding: 10px; border: none; border-radius: 8px;
            background-color: #fff; cursor: pointer; font-weight: 500;
            transition: background-color 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .master-btn:hover { background-color: #f7f7f7; }
        
        #playlist-list { list-style: none; padding: 0; margin: 0; }
        .playlist-list-item {
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 10px;
            border: 2px solid transparent;
        }
        .playlist-list-item:hover { background-color: #fff; transform: translateY(-2px); }
        .playlist-list-item.active {
            background-color: #fff;
            border-image: var(--accent-gradient) 1;
        }
        .playlist-list-item h3 { font-size: 1rem; margin: 0 0 4px 0; color: var(--text-dark); }
        .playlist-list-item p { font-size: 0.85rem; margin: 0; color: var(--text-muted); }
        .playlist-list-item.new-playlist-entry {
            background-color: transparent; border: 2px dashed #c8cbd0; text-align: center; color: #7f8694;
        }
        .playlist-list-item.new-playlist-entry:hover { background-color: #fff; color: var(--text-dark); }
        
        .playlist-detail-view {
            flex-grow: 1;
            padding: 30px 40px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* --- Glassmorphism Header --- */
        .detail-header {
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            position: relative;
            background: rgba(var(--accent-color-1), var(--accent-color-2), var(--accent-color-3), 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }
        .detail-header-content h1, .detail-header-content p {
            margin: 0;
            transition: opacity 0.3s ease;
            cursor: text;
        }
        .detail-header-content h1 { font-size: 2.5rem; font-weight: 700; color: var(--text-dark); }
        .detail-header-content p { font-size: 1rem; color: #555; margin-top: 5px; }
        
        /* Inline Editing */
        .inline-input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 0;
            font-family: inherit;
            color: inherit;
            outline: none;
        }
        .inline-input.title { font-size: 2.5rem; font-weight: 700; }
        .inline-input.description { font-size: 1rem; margin-top: 5px; }
        .hidden-by-edit { position: absolute; opacity: 0; pointer-events: none; }
        
        .detail-header-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        .header-action-btn {
            background-color: rgba(255, 255, 255, 0.5); border: none;
            width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
        }
        .header-action-btn:hover { background-color: #fff; transform: scale(1.1); }
        .header-action-btn.delete:hover { background-color: #ffeef0; color: #e53e3e; }
        .header-action-btn svg { width: 20px; height: 20px; }
        
        /* Sound Management Section */
        .detail-sounds-section {
            background: #fff;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.05);
        }
        .add-sound-container { display: flex; gap: 15px; margin-bottom: 25px; }
        #soundSearchInput {
            flex-grow: 1; padding: 12px 18px; font-size: 1rem;
            border-radius: 10px; border: 1px solid #e2e8f0;
            background-color: #f8fafc; outline: none; transition: all 0.2s;
        }
        #soundSearchInput:focus { border-color: rgb(var(--accent-color-1), var(--accent-color-2), var(--accent-color-3)); box-shadow: 0 0 0 3px rgba(var(--accent-color-1), var(--accent-color-2), var(--accent-color-3), 0.2); }
        
        #available-sounds {
            max-height: 200px; overflow-y: auto;
            border: 1px solid #e2e8f0; border-radius: 10px;
        }
        .available-sound-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .available-sound-item:not(:last-child) { border-bottom: 1px solid #e2e8f0; }
        .available-sound-item:hover { background-color: #f7f9fc; }
        .available-sound-item.hidden { display: none; }
        
        .sounds-list-header {
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }
        #playlist-sounds-list { list-style: none; padding: 0; margin: 0; }
        .playlist-sound-item {
            display: flex; align-items: center; padding: 12px;
            border-radius: 8px; transition: background-color 0.2s;
        }
        .playlist-sound-item:hover { background-color: #f1f5f9; }
        .sound-item-name { flex-grow: 1; margin-left: 15px; }
        .sound-item-action { background: none; border: none; cursor: pointer; color: #94a3b8; }
        .sound-item-action:hover { color: #e53e3e; }

        /* Welcome / Empty State */
        .welcome-view {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; height: 100%; color: var(--text-muted);
        }
        .welcome-view svg { width: 80px; height: 80px; margin-bottom: 20px; }
        .welcome-view h2 { font-size: 1.8rem; color: #555; margin: 0 0 10px 0; }
        
        /* Modal for palette selection */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(8px);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .modal-backdrop.visible { opacity: 1; pointer-events: all; }
        .modal-content {
            background: #fff; padding: 30px; border-radius: 20px;
            width: 90%; max-width: 400px;
            transform: scale(0.95); transition: transform 0.3s;
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .modal-content h2 { margin-top: 0; }
        .palette-picker { display: flex; justify-content: space-around; margin: 25px 0; }
        .palette-swatch {
            width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; border: 3px solid transparent;
            transition: all 0.2s;
        }
        .palette-swatch:hover { transform: scale(1.1); }
        .palette-swatch.selected { border-color: #333; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>
    <header class="main-header light-bg">
       <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="main-layout">
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="playlists.html" class="active"><span class="icon">🎶</span><span class="label">Playlists</span></a></li>
                    <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="playlist-master-view">
            <div class="master-header">
                <h2>Playlists</h2>
                <div class="master-actions">
                    <button id="importBtn" class="master-btn">Import</button>
                    <input type="file" id="importInput" accept=".json" hidden>
                </div>
            </div>
            <ul id="playlist-list">
                <li class="playlist-list-item new-playlist-entry">
                    <h3>+ Create New Playlist</h3>
                </li>
            </ul>
        </main>

        <section id="detailViewContainer" class="playlist-detail-view">
            </section>
    </div>

    <div id="paletteModal" class="modal-backdrop">
        <div class="modal-content">
            <h2>Choose a Theme</h2>
            <div class="palette-picker">
                 </div>
            <div class="modal-actions">
                <button id="cancelPalette" class="master-btn">Cancel</button>
                <button id="confirmPalette" class="master-btn" style="background: var(--accent-gradient); color: white;">Confirm</button>
            </div>
        </div>
    </div>


    <script>
    // --- Entirely Remade Playlist Module ---
    ((window, document) => {
        'use strict';

        const App = {
            // --- CONFIG ---
            STORAGE_KEY: 'playlistsRemade_v1',
            PALETTES: {
                purple: '98, 58, 162',
                blue: '59, 130, 246',
                green: '16, 185, 129',
                orange: '249, 115, 22',
                pink: '236, 72, 153',
                slate: '71, 85, 105',
            },
            
            // --- STATE ---
            playlists: [],
            allSounds: [],
            activePlaylistId: null,

            // --- UI ELEMENTS ---
            initUI() {
                this.ui = {
                    playlistList: document.getElementById('playlist-list'),
                    detailView: document.getElementById('detailViewContainer'),
                    newPlaylistBtn: document.querySelector('.new-playlist-entry'),
                    importBtn: document.getElementById('importBtn'),
                    importInput: document.getElementById('importInput'),
                    paletteModal: document.getElementById('paletteModal'),
                    palettePicker: document.querySelector('.palette-picker'),
                    cancelPaletteBtn: document.getElementById('cancelPalette'),
                    confirmPaletteBtn: document.getElementById('confirmPalette'),
                };
            },

            // --- INITIALIZATION ---
            async init() {
                this.initUI();
                await this.fetchSounds();
                this.loadPlaylists();
                this.renderMasterList();
                this.renderDetailView();
                this.bindEvents();
                this.populatePalettePicker();
            },
            
            // --- DATA HANDLING ---
            async fetchSounds() {
                try {
                    const res = await fetch('../SoundboardNames.json');
                    const data = await res.json();
                    this.allSounds = Object.values(data).flat().sort();
                } catch (e) { console.error("Failed to fetch sounds", e); }
            },
            loadPlaylists() { this.playlists = JSON.parse(localStorage.getItem(this.STORAGE_KEY)) || []; },
            savePlaylists() { localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.playlists)); },
            getPlaylist(id) { return this.playlists.find(p => p.id === id); },

            // --- RENDERING ---
            renderMasterList() {
                this.ui.playlistList.innerHTML = ''; // Clear list
                this.playlists.forEach(p => {
                    const item = document.createElement('li');
                    item.className = 'playlist-list-item';
                    item.dataset.id = p.id;
                    if (p.id === this.activePlaylistId) item.classList.add('active');
                    item.innerHTML = `<h3>${p.name}</h3><p>${p.sounds.length} sound${p.sounds.length !== 1 ? 's' : ''}</p>`;
                    this.ui.playlistList.appendChild(item);
                });
                const newPlaylistEntry = document.createElement('li');
                newPlaylistEntry.className = 'playlist-list-item new-playlist-entry';
                newPlaylistEntry.innerHTML = `<h3>+ Create New Playlist</h3>`;
                this.ui.playlistList.appendChild(newPlaylistEntry);
                
                // Re-bind click on the new entry
                newPlaylistEntry.addEventListener('click', () => this.handleCreateNewPlaylist());
            },

            renderDetailView() {
                if (!this.activePlaylistId || !this.getPlaylist(this.activePlaylistId)) {
                    this.ui.detailView.innerHTML = this.templates.welcome();
                    return;
                }
                const playlist = this.getPlaylist(this.activePlaylistId);
                this.setAccentColor(playlist.color);
                this.ui.detailView.innerHTML = this.templates.detail(playlist);
                this.renderSoundsLists(playlist);
                this.bindDetailEvents(playlist);
            },
            
            renderSoundsLists(playlist) {
                const availableSoundsList = document.getElementById('available-sounds');
                const playlistSoundsList = document.getElementById('playlist-sounds-list');
                availableSoundsList.innerHTML = this.allSounds
                    .filter(s => !playlist.sounds.includes(s))
                    .map(s => this.templates.availableSound(s)).join('');
                playlistSoundsList.innerHTML = playlist.sounds.length ? 
                    playlist.sounds.map(s => this.templates.playlistSound(s)).join('') : 
                    `<p style="text-align:center; color: var(--text-muted);">No sounds in this playlist yet.</p>`;
            },
            
            populatePalettePicker() {
                this.ui.palettePicker.innerHTML = Object.entries(this.PALETTES).map(([name, rgb]) => 
                    `<div class="palette-swatch" data-color="${name}" style="background-color: rgb(${rgb});"></div>`
                ).join('');
            },

            // --- TEMPLATES ---
            templates: {
                welcome: () => `
                    <div class="welcome-view">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 01-.99-3.467l2.31-.66A2.25 2.25 0 009 15.553z" /></svg>
                        <h2>Welcome to Playlists</h2>
                        <p>Select a playlist on the left or create a new one to get started.</p>
                    </div>`,
                detail: (p) => `
                    <div class="detail-header">
                        <div class="detail-header-content">
                            <div class="editable-field" data-field="name">
                                <h1>${p.name}</h1>
                                <input type="text" class="inline-input title hidden-by-edit" value="${p.name}">
                            </div>
                             <div class="editable-field" data-field="description">
                                <p>${p.description || 'No description'}</p>
                                <input type="text" class="inline-input description hidden-by-edit" value="${p.description || ''}" placeholder="Click to add description">
                            </div>
                        </div>
                        <div class="detail-header-actions">
                            <button class="header-action-btn" data-action="export" title="Export Playlist">
                               <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                            </button>
                            <button class="header-action-btn delete" data-action="delete" title="Delete Playlist">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.134-2.09-2.201a51.974 51.974 0 00-7.52 0c-1.18.067-2.09.92-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="detail-sounds-section">
                        <h3>Add Sounds</h3>
                        <div class="add-sound-container">
                            <input type="text" id="soundSearchInput" placeholder="Search for a sound...">
                        </div>
                        <div id="available-sounds"></div>
                        <h3 class="sounds-list-header">Playlist Sounds</h3>
                        <ul id="playlist-sounds-list"></ul>
                    </div>`,
                availableSound: (s) => `<div class="available-sound-item" data-sound="${s}">${s.replace('.mp3', '')}</div>`,
                playlistSound: (s) => `
                    <li class="playlist-sound-item">
                         <button class="sound-item-action" data-action="play-sound" data-sound="${s}" title="Play Sound">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z" /></svg>
                        </button>
                        <span class="sound-item-name">${s.replace('.mp3', '')}</span>
                        <button class="sound-item-action" data-action="remove-sound" data-sound="${s}" title="Remove Sound">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>
                        </button>
                    </li>`,
            },

            // --- EVENT BINDING ---
            bindEvents() {
                this.ui.playlistList.addEventListener('click', e => this.handleMasterListClick(e));
                this.ui.importBtn.addEventListener('click', () => this.ui.importInput.click());
                this.ui.importInput.addEventListener('change', e => this.handleImport(e));
                
                // Palette Modal Events
                this.ui.paletteModal.addEventListener('click', e => {
                    if (e.target === this.ui.paletteModal) this.closePaletteModal();
                });
                this.ui.cancelPaletteBtn.addEventListener('click', () => this.closePaletteModal());
            },

            bindDetailEvents(playlist) {
                // Actions
                this.ui.detailView.addEventListener('click', e => {
                    const button = e.target.closest('[data-action]');
                    if (!button) return;
                    
                    const { action, sound } = button.dataset;
                    switch (action) {
                        case 'delete': this.handleDeletePlaylist(); break;
                        case 'export': this.handleExport(); break;
                        case 'remove-sound': this.handleSoundChange(sound, 'remove'); break;
                        case 'play-sound': this.playSound(sound); break;
                    }
                });
                
                // Add sounds
                document.getElementById('available-sounds').addEventListener('click', e => {
                   const item = e.target.closest('.available-sound-item');
                   if (item) this.handleSoundChange(item.dataset.sound, 'add');
                });
                
                // Search
                document.getElementById('soundSearchInput').addEventListener('input', e => this.filterAvailableSounds(e.target.value));
                
                // Inline editing
                document.querySelectorAll('.editable-field').forEach(field => {
                    field.addEventListener('click', e => this.startEditing(field));
                });
            },
            
            // --- EVENT HANDLERS ---
            handleMasterListClick(e) {
                const item = e.target.closest('.playlist-list-item:not(.new-playlist-entry)');
                if (item) {
                    this.activePlaylistId = item.dataset.id;
                    this.renderMasterList();
                    this.renderDetailView();
                }
            },
            
            handleCreateNewPlaylist() {
                this.openPaletteModal(color => {
                    const newPlaylist = {
                        id: 'p_' + Date.now(),
                        name: 'Untitled Playlist',
                        description: '',
                        sounds: [],
                        color: color
                    };
                    this.playlists.push(newPlaylist);
                    this.activePlaylistId = newPlaylist.id;
                    this.savePlaylists();
                    this.renderMasterList();
                    this.renderDetailView();
                });
            },
            
            handleDeletePlaylist() {
                if (!confirm(`Are you sure you want to delete "${this.getPlaylist(this.activePlaylistId).name}"?`)) return;
                this.playlists = this.playlists.filter(p => p.id !== this.activePlaylistId);
                this.activePlaylistId = null;
                this.savePlaylists();
                this.renderMasterList();
                this.renderDetailView();
            },

            handleSoundChange(sound, type) {
                const playlist = this.getPlaylist(this.activePlaylistId);
                if (!playlist) return;
                if (type === 'add') {
                    playlist.sounds.push(sound);
                } else {
                    playlist.sounds = playlist.sounds.filter(s => s !== sound);
                }
                this.savePlaylists();
                this.renderSoundsLists(playlist);
                this.renderMasterList(); // To update sound count
            },

            handleExport() {
                const playlist = this.getPlaylist(this.activePlaylistId);
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(playlist, null, 2));
                const anchor = document.createElement('a');
                anchor.setAttribute("href", dataStr);
                anchor.setAttribute("download", `${playlist.name.replace(/\s/g, '_')}.json`);
                anchor.click();
            },

            handleImport(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const p = JSON.parse(event.target.result);
                        if (!p.id || !p.name || !Array.isArray(p.sounds)) throw new Error("Invalid format");
                        if (this.playlists.some(pl => pl.id === p.id)) {
                            alert('A playlist with this ID already exists.');
                            return;
                        }
                        this.playlists.unshift(p);
                        this.savePlaylists();
                        this.renderMasterList();
                    } catch { alert('Failed to import file.'); }
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset for next import
            },
            
            // --- UI LOGIC ---
            setAccentColor(colorName) {
                const rgb = this.PALETTES[colorName] || this.PALETTES.purple;
                const [r, g, b] = rgb.split(', ');
                document.documentElement.style.setProperty('--accent-color-1', r);
                document.documentElement.style.setProperty('--accent-color-2', g);
                document.documentElement.style.setProperty('--accent-color-3', b);
            },
            
            openPaletteModal(callback) {
                this.ui.paletteModal.classList.add('visible');
                const onConfirm = () => {
                    const selected = this.ui.palettePicker.querySelector('.selected');
                    if (selected) {
                        callback(selected.dataset.color);
                        this.closePaletteModal();
                    } else {
                        alert('Please select a color theme.');
                    }
                    this.ui.confirmPaletteBtn.removeEventListener('click', onConfirm);
                };
                
                this.ui.palettePicker.querySelector('.selected')?.classList.remove('selected');
                this.ui.palettePicker.firstElementChild.classList.add('selected');
                
                this.ui.palettePicker.onclick = e => {
                    if (e.target.classList.contains('palette-swatch')) {
                        this.ui.palettePicker.querySelector('.selected')?.classList.remove('selected');
                        e.target.classList.add('selected');
                    }
                };
                
                this.ui.confirmPaletteBtn.addEventListener('click', onConfirm);
            },
            
            closePaletteModal() { this.ui.paletteModal.classList.remove('visible'); },

            filterAvailableSounds(term) {
                const searchTerm = term.toLowerCase();
                document.querySelectorAll('.available-sound-item').forEach(item => {
                    item.classList.toggle('hidden', !item.textContent.toLowerCase().includes(searchTerm));
                });
            },
            
            startEditing(field) {
                const displayEl = field.children[0];
                const inputEl = field.children[1];
                
                displayEl.classList.add('hidden-by-edit');
                inputEl.classList.remove('hidden-by-edit');
                inputEl.focus();
                
                const saveChanges = () => {
                    const playlist = this.getPlaylist(this.activePlaylistId);
                    const fieldName = field.dataset.field;
                    playlist[fieldName] = inputEl.value;
                    
                    this.savePlaylists();
                    this.renderDetailView(); // Re-render to show saved value
                    this.renderMasterList(); // Update name in list if changed
                };
                
                inputEl.addEventListener('blur', saveChanges, { once: true });
                inputEl.addEventListener('keydown', e => {
                    if (e.key === 'Enter') inputEl.blur();
                });
            },

            playSound(soundFile) {
                // Placeholder for your actual sound playing logic from soundboard.js
                console.log(`Playing sound: ${soundFile}`);
                // Find the soundboard button and click it
                const button = document.querySelector(`.sound-button-v4[data-sound-file="${soundFile}"]`);
                if (button && typeof button.click === 'function') {
                    button.click();
                } else {
                    console.warn(`Could not find or click button for ${soundFile}`);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());

    })(window, document);
    </script>
</body>
</html>
