<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - My Playlists</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="../panic-key.js"></script>

    <style>
        /* Inherits all root variables and base styles from your v4 soundboard for consistency */
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
            --danger-color: #dc3545;
            --danger-color-hover: #c82333;
        }

        body {
            display: flex; flex-direction: column; min-height: 100vh;
            margin: 0; font-family: var(--v4-font-primary);
            background: var(--v4-bg-gradient); color: var(--v4-text-primary);
            line-height: 1.6;
        }

        /* --- V4 Sidebar and Header --- */
        .soundboard-container-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar {
            width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff; padding: 20px 10px; display: flex; flex-direction: column;
            border-right: 1px solid #444; transition: width 0.5s ease-in-out;
            position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: none; border: none; color: #fff; font-size: 1.2em;
            cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out;
        }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: visible; }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em; }
        .marquee-content { display: inline-block; padding-left: 100%; transform: translateX(0); animation: none; line-height: 1.8em; }
        .marquee-active { animation: scroll-left-soundboard 12s linear infinite; }
        @keyframes scroll-left-soundboard { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .user-info .username { font-family: var(--v4-font-primary); font-size: 1.3em; margin-bottom: 8px; line-height: 0.2em; font-weight: bold;}
        .user-info .email { font-family: var(--v4-font-secondary); font-size: 0.9em; color: #bbb; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a {
            display: flex; align-items: center; padding: 12px 15px; color: #fff;
            text-decoration: none; border-radius: 8px; transition: all 0.3s ease;
            font-family: var(--v4-font-primary); text-transform: uppercase;
            position: relative; overflow: hidden; font-size: 1em;
        }
        .sidebar nav a:hover, .sidebar nav a.active { background: var(--v4-purple-gradient); transform: translateX(5px); color: #fff; }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .sidebar.collapsed nav a .label { display: none; }

        /* --- Main Content Area --- */
        .main-content {
            flex: 1; padding: 30px; background: var(--v4-bg-gradient);
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .page-header-v4 {
            margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center;
        }
        .page-title-v4 {
            font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        #createPlaylistBtn {
            padding: 10px 20px; font-family: var(--v4-font-primary); background: var(--v4-purple-gradient);
            color: white; border: none; border-radius: 8px; cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease; font-size: 1em; text-transform: uppercase;
        }
        #createPlaylistBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(103, 32, 189, 0.3);
        }

        /* --- Playlist Grid & Cards --- */
        #playlistsGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }
        .playlist-card {
            background: var(--v4-card-bg); border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08);
            display: flex; flex-direction: column; transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .playlist-card:hover { transform: translateY(-5px); box-shadow: 0 10px 40px rgba(0,0,0,0.12); }
        .playlist-card-content { padding: 20px; flex-grow: 1; }
        .playlist-card h3 { margin: 0 0 8px 0; font-size: 1.4em; color: var(--v4-text-primary); }
        .playlist-card p { margin: 0; color: var(--v4-text-secondary); font-size: 0.9em; min-height: 40px; }
        .playlist-card-footer {
            display: flex; background: var(--v4-input-bg); border-top: 1px solid var(--v4-border-softer);
            border-radius: 0 0 15px 15px;
        }
        .playlist-card-footer button {
            flex: 1; background: none; border: none; padding: 12px; cursor: pointer;
            font-family: var(--v4-font-primary); font-weight: 600; font-size: 0.9em;
            text-transform: uppercase; transition: background-color 0.2s, color 0.2s;
            border-right: 1px solid var(--v4-border-softer);
        }
        .playlist-card-footer button:last-child { border-right: none; }
        .playlist-card-footer button:hover { background-color: var(--v4-purple-accent); color: white; }
        .playlist-card-footer button.delete-btn:hover { background-color: var(--danger-color); }
        
        #loadingMessage { text-align: center; font-size: 1.2em; color: var(--v4-text-secondary); }

        /* --- Playlist Creator/Editor Modal --- */
        #playlistCreatorModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px);
            z-index: 1000; display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: var(--v4-bg-gradient); width: 90%; max-width: 900px; height: 90vh;
            border-radius: 15px; box-shadow: 0 10px 50px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
        }
        .modal-header {
            padding: 15px 25px; border-bottom: 1px solid var(--v4-border-light);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h2 { font-size: 1.8em; color: var(--v4-text-primary); }
        .modal-header .close-btn { font-size: 2em; cursor: pointer; color: var(--v4-text-secondary); border:none; background:none; }
        .modal-body { flex: 1; padding: 25px; overflow-y: auto; }
        .modal-body label { font-weight: 600; font-size: 0.95em; color: var(--v4-text-secondary); margin-bottom: 6px; display: block; }
        .modal-body input[type="text"], .modal-body textarea {
            width: 100%; padding: 12px; margin-bottom: 20px;
            border-radius: 8px; border: 1px solid var(--v4-border-light);
            font-family: var(--v4-font-secondary); font-size: 1em; outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .modal-body input[type="text"]:focus, .modal-body textarea:focus {
            border-color: var(--v4-purple-accent); box-shadow: 0 0 0 2px rgba(103, 32, 189, 0.2);
        }
        .modal-sound-grid h3 { font-size: 1.3em; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--v4-border-softer); }
        .sound-selection-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px;}
        .sound-select-btn {
            background-color: var(--v4-input-bg); color: var(--v4-text-secondary); border: 1px solid var(--v4-input-border);
            padding: 8px 12px; font-size: 1em; text-align: center; cursor: pointer;
            transition: all 0.2s; text-transform: uppercase; font-family: var(--v4-font-primary);
            border-radius: 12px;
        }
        .sound-select-btn:hover { border-color: var(--v4-purple-accent); color: var(--v4-purple-accent); }
        .sound-select-btn.selected { background-color: var(--v4-purple-accent); color: white; border-color: var(--v4-purple-accent-darker); }

        .modal-footer {
            padding: 15px 25px; border-top: 1px solid var(--v4-border-light); text-align: right;
        }
        #savePlaylistBtn {
            padding: 12px 25px; font-family: var(--v4-font-primary); background: var(--v4-purple-gradient);
            color: white; border: none; border-radius: 8px; cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease; font-size: 1em; text-transform: uppercase;
        }
        #savePlaylistBtn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(103, 32, 189, 0.3); }

        /* Status Message from V4 */
        .status-message-v4 { display: none; padding: 15px 25px; margin: 0 auto 20px auto; border-radius: 12px; text-align: center; max-width: 600px; text-transform: uppercase; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); color: white; }
        .status-message-v4.success { background: linear-gradient(135deg, #1c7430, #155724); }
        .status-message-v4.error { background: linear-gradient(135deg, #8f262a, #721c24); }
        .status-message-v4.info { background: linear-gradient(135deg, #004085, #002752); }
    </style>
</head>
<body class="playlists-page">
    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtnHeader" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="soundboard-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <div class="user-info">
                <div class="marquee-container"> <span id="userName" class="marquee-content username">Loading…</span> </div>
                <div class="marquee-container"> <span id="userEmail" class="marquee-content email">Loading…</span> </div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">🛡️</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="playlists.html" class="active"><span class="icon">🎶</span><span class="label">Playlists</span></a></li>
                    <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="others.html"><span class="icon">✨</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-header-v4">
                <h2 class="page-title-v4">My Playlists</h2>
                <button id="createPlaylistBtn">Create New Playlist</button>
            </div>
            <div class="status-message-v4" id="statusMessageV4"></div>
            <div id="playlistsGrid">
                <p id="loadingMessage">Loading your playlists...</p>
            </div>
        </main>
    </div>

    <div id="playlistCreatorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Create Playlist</h2>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="playlistForm">
                    <input type="hidden" id="playlistId" />
                    <label for="playlistName">Playlist Name</label>
                    <input type="text" id="playlistName" required maxlength="50" placeholder="e.g., Epic Fails">
                    <label for="playlistDescription">Description</label>
                    <textarea id="playlistDescription" rows="3" required maxlength="150" placeholder="e.g., Sounds for when things go wrong"></textarea>
                </form>
                <div class="modal-sound-grid" id="soundSelectionGrid">
                    </div>
            </div>
            <div class="modal-footer">
                <button id="savePlaylistBtn">Save Playlist</button>
            </div>
        </div>
    </div>

    <script>
    // --- Standard V4 Setup (Auth, Sidebar, User Info) ---
    const dbRef_ = () => firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid);
    const marqueeEls_ = document.querySelectorAll('.marquee-content');
    firebase.auth().onAuthStateChanged(async user => {
        if (!user) {
            window.location.href = '../login.html';
        } else {
            const userEmailEl = document.getElementById('userEmail');
            const userNameEl = document.getElementById('userName');
            if (userEmailEl) userEmailEl.textContent = user.email;
            if (userNameEl) {
                try {
                    const doc = await dbRef_().get();
                    userNameEl.textContent = (doc.exists && doc.data().username) ? doc.data().username : (user.displayName || 'User');
                } catch (error) { userNameEl.textContent = 'User'; console.error("Error fetching username:", error); }
            }
            updateMarquees_();
            // --- App Specific Logic ---
            initializeApp(user);
        }
    });
    document.getElementById('logoutBtnHeader')?.addEventListener('click', () => firebase.auth().signOut());
    document.getElementById('signOutLink')?.addEventListener('click', (e) => { e.preventDefault(); firebase.auth().signOut(); });
    const sidebar_ = document.getElementById('sidebar');
    const toggleSidebarBtn_ = document.getElementById('toggleSidebar');
    if (toggleSidebarBtn_ && sidebar_) { toggleSidebarBtn_.addEventListener('click', () => { sidebar_.classList.toggle('collapsed'); setTimeout(updateMarquees_, 550); }); }
    function updateMarquees_() {
        marqueeEls_.forEach(el => {
            if (!el || !el.parentElement) return;
            const parent = el.parentElement; const overflow = el.scrollWidth > parent.clientWidth;
            const shouldScroll = sidebar_.classList.contains('collapsed') || (overflow && !sidebar_.classList.contains('collapsed'));
            el.classList.toggle('marquee-active', shouldScroll);
            if (!overflow && !sidebar_.classList.contains('collapsed')) { el.classList.remove('marquee-active'); }
        });
    }
    window.addEventListener('resize', updateMarquees_);
    // --- End Standard Setup ---

    const db = firebase.firestore();
    let allSoundsData = {};

    const showStatus = (message, type = 'info', duration = 3000) => {
        const el = document.getElementById('statusMessageV4');
        if (!el) return;
        clearTimeout(el.timeoutId);
        el.textContent = message;
        el.className = `status-message-v4 ${type}`;
        el.style.display = 'block';
        el.timeoutId = setTimeout(() => el.style.display = 'none', duration);
    };

    // --- Main Application Logic ---
    async function initializeApp(user) {
        await loadAllSounds();
        loadAndRenderPlaylists(user.uid);
        setupEventListeners(user.uid);
    }

    async function loadAllSounds() {
        try {
            const response = await fetch('../SoundboardNames.json');
            if (!response.ok) throw new Error('Failed to load SoundboardNames.json');
            allSoundsData = await response.json();
            populateSoundSelectionGrid();
        } catch (error) {
            console.error("Error loading sounds for selection:", error);
            document.getElementById('soundSelectionGrid').innerHTML = '<p>Could not load sounds.</p>';
        }
    }

    function populateSoundSelectionGrid() {
        const container = document.getElementById('soundSelectionGrid');
        container.innerHTML = '';
        for (const category in allSoundsData) {
            const categoryDiv = document.createElement('div');
            categoryDiv.innerHTML = `<h3>${category.replace(/([A-Z])/g, ' $1').trim()}</h3>`;
            const grid = document.createElement('div');
            grid.className = 'sound-selection-container';
            
            allSoundsData[category].sort().forEach(fileName => {
                const displayName = fileName.replace(/\.mp3$/i, '').replace(/_/g, ' ');
                const btn = document.createElement('button');
                btn.className = 'sound-select-btn';
                btn.textContent = displayName;
                btn.dataset.soundFile = fileName;
                btn.dataset.category = category;
                btn.onclick = () => btn.classList.toggle('selected');
                grid.appendChild(btn);
            });
            categoryDiv.appendChild(grid);
            container.appendChild(categoryDiv);
        }
    }

    function renderPlaylistCard(playlistId, data) {
        const card = document.createElement('div');
        card.className = 'playlist-card';
        card.dataset.id = playlistId;

        card.innerHTML = `
            <div class="playlist-card-content">
                <h3>${data.name}</h3>
                <p>${data.description}</p>
            </div>
            <div class="playlist-card-footer">
                <button class="load-btn">Load to Soundboard</button>
                <button class="edit-btn">Edit</button>
                <button class="delete-btn">Delete</button>
            </div>
        `;
        return card;
    }
    
    async function loadAndRenderPlaylists(uid) {
        const grid = document.getElementById('playlistsGrid');
        grid.innerHTML = '<p id="loadingMessage">Loading your playlists...</p>';

        try {
            const snapshot = await db.collection('playlists').where('owner', '==', uid).orderBy('createdAt', 'desc').get();
            grid.innerHTML = ''; // Clear loading message
            if (snapshot.empty) {
                grid.innerHTML = '<p id="loadingMessage">No playlists found. Create one to get started!</p>';
            } else {
                snapshot.forEach(doc => {
                    const card = renderPlaylistCard(doc.id, doc.data());
                    grid.appendChild(card);
                });
            }
        } catch (error) {
            console.error("Error fetching playlists: ", error);
            grid.innerHTML = '<p id="loadingMessage">Could not load your playlists. Please try again later.</p>';
            showStatus('Failed to load playlists.', 'error');
        }
    }

    function openPlaylistModal(playlistData = null) {
        const modal = document.getElementById('playlistCreatorModal');
        const form = document.getElementById('playlistForm');
        form.reset();
        document.getElementById('playlistId').value = '';
        
        // Deselect all sound buttons
        document.querySelectorAll('.sound-select-btn.selected').forEach(btn => btn.classList.remove('selected'));

        if (playlistData) {
            // EDIT MODE
            document.getElementById('modalTitle').textContent = 'Edit Playlist';
            document.getElementById('playlistId').value = playlistData.id;
            document.getElementById('playlistName').value = playlistData.name;
            document.getElementById('playlistDescription').value = playlistData.description;
            
            // Select the sounds that are in the playlist
            playlistData.sounds.forEach(sound => {
                const btn = document.querySelector(`.sound-select-btn[data-sound-file="${sound.fileName}"]`);
                if (btn) btn.classList.add('selected');
            });

        } else {
            // CREATE MODE
            document.getElementById('modalTitle').textContent = 'Create Playlist';
        }
        modal.style.display = 'flex';
    }

    function closePlaylistModal() {
        document.getElementById('playlistCreatorModal').style.display = 'none';
    }

    function setupEventListeners(uid) {
        document.getElementById('createPlaylistBtn').onclick = () => openPlaylistModal();
        document.getElementById('closeModalBtn').onclick = closePlaylistModal;
        document.getElementById('savePlaylistBtn').onclick = () => savePlaylist(uid);

        // Event delegation for playlist cards
        document.getElementById('playlistsGrid').addEventListener('click', async (e) => {
            const card = e.target.closest('.playlist-card');
            if (!card) return;
            
            const playlistId = card.dataset.id;

            if (e.target.matches('.edit-btn')) {
                const doc = await db.collection('playlists').doc(playlistId).get();
                if(doc.exists) {
                    openPlaylistModal({ id: doc.id, ...doc.data() });
                }
            } else if (e.target.matches('.delete-btn')) {
                if (confirm('Are you sure you want to delete this playlist? This cannot be undone.')) {
                    await db.collection('playlists').doc(playlistId).delete();
                    showStatus('Playlist deleted successfully.', 'success');
                    loadAndRenderPlaylists(uid); // Refresh the list
                }
            } else if (e.target.matches('.load-btn')) {
                const doc = await db.collection('playlists').doc(playlistId).get();
                if (doc.exists) {
                    localStorage.setItem('playlistToLoad', JSON.stringify(doc.data().sounds));
                    showStatus(`"${doc.data().name}" is ready. Redirecting to Soundboard...`, 'info');
                    setTimeout(() => window.location.href = 'soundboard.html', 1500);
                }
            }
        });
    }

    async function savePlaylist(uid) {
        const playlistId = document.getElementById('playlistId').value;
        const name = document.getElementById('playlistName').value.trim();
        const description = document.getElementById('playlistDescription').value.trim();

        if (!name || !description) {
            showStatus('Please fill out the playlist name and description.', 'error');
            return;
        }

        const selectedSounds = Array.from(document.querySelectorAll('.sound-select-btn.selected')).map(btn => ({
            category: btn.dataset.category,
            fileName: btn.dataset.soundFile
        }));

        if (selectedSounds.length === 0) {
            showStatus('Please select at least one sound for the playlist.', 'error');
            return;
        }

        const data = {
            owner: uid,
            name,
            description,
            sounds: selectedSounds,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (playlistId) {
                // Update existing playlist
                await db.collection('playlists').doc(playlistId).update(data);
                showStatus('Playlist updated successfully!', 'success');
            } else {
                // Create new playlist
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                await db.collection('playlists').add(data);
                showStatus('Playlist created successfully!', 'success');
            }
            closePlaylistModal();
            loadAndRenderPlaylists(uid); // Refresh the view
        } catch (error) {
            console.error("Error saving playlist: ", error);
            showStatus('Failed to save playlist.', 'error');
        }
    }
    </script>
</body>
</html>
