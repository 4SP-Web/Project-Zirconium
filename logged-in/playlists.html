<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - PLAYLISTS</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="../panic-key.js"></script>

    <style>
        /* --- INHERITED STYLES FROM SOUNDBOARD.HTML --- */
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
            --sound-search-bar-container-width: 530px;
        }
        body { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: var(--v4-font-primary); background: var(--v4-bg-gradient); color: var(--v4-text-primary); line-height: 1.6; }
        .soundboard-container-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: visible; }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em; }
        .marquee-content { display: inline-block; padding-left: 100%; transform: translateX(0); animation: none; line-height: 1.8em; }
        .marquee-active { animation: scroll-left-soundboard 12s linear infinite; }
        @keyframes scroll-left-soundboard { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .user-info .username { font-family: var(--v4-font-primary); font-size: 1.3em; margin-bottom: 8px; line-height: 0.2em; font-weight: bold;}
        .user-info .email { font-family: var(--v4-font-secondary); font-size: 0.9em; color: #bbb; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: var(--v4-font-primary); text-transform: uppercase; position: relative; overflow: hidden; font-size: 1em; }
        .sidebar nav a:hover, .sidebar nav a.active { background: var(--v4-purple-gradient); transform: translateX(5px); color: #fff; }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .sidebar.collapsed nav a .label { display: none; }
        .main-soundboard-content { flex: 1; padding: 30px; background: var(--v4-bg-gradient); overflow-y: auto; display: flex; flex-direction: column; padding-bottom: 120px; }
        .soundboard-header-v4 { margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .soundboard-title-v4 { font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .settings-tab-container { background: var(--v4-card-bg); border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); margin-bottom: 25px; overflow: visible; }
        .settings-header { display: flex; flex-direction: column; padding: 0 15px; border-bottom: 1px solid var(--v4-border-softer); }
        .settings-top-row { display: flex; justify-content: space-between; align-items: center; width: 100%;}
        nav.settings-tabs { display: flex; flex-wrap: wrap; }
        .tab-link { background: none; border: none; padding: 15px 20px; cursor: pointer; font-size: 1.1em; font-family: var(--v4-font-primary); color: var(--v4-text-secondary); border-bottom: 3px solid transparent; margin-bottom: -1px; transition: all 0.2s ease-in-out; }
        .tab-link.active, .tab-link:hover { color: var(--v4-purple-accent); }
        .tab-link.active { border-bottom-color: var(--v4-purple-accent); font-weight: bold; }
        .settings-buttons-group { display: flex; gap: 8px; }
        #resetSettingsBtn, #saveSettingsBtn { background: none; border: 1px solid var(--v4-border-light); color: var(--v4-text-secondary); font-size: 0.8em; padding: 5px 10px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-family: var(--v4-font-secondary); white-space: nowrap; }
        #resetSettingsBtn:hover { border-color: #dc3545; background-color: #dc3545; color: white; }
        #saveSettingsBtn:hover { border-color: #0d6efd; background-color: #0d6efd; color: white;}
        #settingsSearch { width: 100%; padding: 10px 15px; margin: 10px 0; border-radius: 12px; border: 1px solid var(--v4-border-light); font-family: var(--v4-font-secondary); font-size: 1em; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
        #settingsSearch:focus { border-color: var(--v4-purple-accent); box-shadow: 0 0 0 2px rgba(103, 32, 189, 0.2); }
        .tab-content { display: none; padding: 15px 25px 25px 25px; gap: 15px 25px; overflow: visible; }
        .tab-content.active { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        #effects.active, #equalizer.active { grid-template-columns: 1fr 1fr; }
        .control-group { position: relative; display: flex; flex-direction: column; margin-bottom: 10px; transition: opacity 0.3s ease; border-radius: 8px; }
        .control-group.disabled, .control-group.locked { opacity: 0.4; pointer-events: none; cursor: not-allowed; }
        .control-group label { font-family: var(--v4-font-primary); font-weight: 600; font-size: 0.95em; color: var(--v4-text-secondary); margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        .sound-category-v4 { margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); transition: opacity 0.3s ease-in-out; }
        .sound-category-v4 h2 { font-size: 1.5em; color: var(--v4-text-primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--v4-border-softer); text-transform: uppercase; }
        .sound-buttons-grid-v4 { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .sound-button-v4 { background-color: var(--v4-input-bg); color: var(--v4-text-secondary); border: 1px solid var(--v4-input-border); padding: 8px 12px; font-size: 1em; text-align: center; cursor: pointer; transition: all 0.2s ease, opacity 0.3s ease-in-out; text-transform: uppercase; font-family: var(--v4-font-primary); border-radius: 12px; }
        .sound-button-v4:hover { background-color: #e9ecef; border-color: var(--v4-purple-accent); color: var(--v4-purple-accent); transform: translateY(-2px); }
        .sound-button-v4.playing { background-color: var(--v4-purple-accent); color: white; border: 2px solid var(--v4-purple-accent-darker); }
        .sound-button-v4.pulsating { animation: pulsePlayingSoundboardV4 1.5s infinite; }
        @keyframes pulsePlayingSoundboardV4 { 0% { box-shadow: 0 0 0 0px var(--v4-purple-accent); } 100% { box-shadow: 0 0 0 8px rgba(103, 32, 189, 0); } }
        .is-hidden { display: none !important; }
        #bottom-fixed-bar { position: fixed; bottom: 15px; right: 15px; left: auto; z-index: 1001; display: flex; align-items: center; gap: 12px; padding: 10px 10px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1)); backdrop-filter: blur(4px) saturate(3); -webkit-backdrop-filter: blur(2px) saturate(1.2); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15), inset 0 1px 1px 0 rgba(255, 255, 255, 0.7); width: var(--sound-search-bar-container-width); }
        #bottom-fixed-bar input[type="text"] { background: transparent; border: none; border-bottom: 1px solid rgba(50,50,50,0.6); color: var(--v4-text-primary); padding: 8px 5px; font-size: 1em; outline: none; font-family: var(--v4-font-secondary); flex-grow: 1; width: auto; }
        #clearSoundsBtn { padding: 10px 12px; background: rgba(255, 5, 5, 0.85); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; cursor: pointer; font-size: 0.95em; text-transform: uppercase; transition: all 0.25s ease; font-family: var(--v4-font-primary); flex-shrink: 0; }
        /* --- ALL OTHER INHERITED STYLES from soundboard.html would go here... --- */
        /* To keep this response manageable, only the most relevant styles are included. */
        /* The full JS from soundboard.html handles all the complex audio logic. */
        
        /* --- NEW PLAYLIST-SPECIFIC STYLES --- */
        .playlists-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px 30px;
            background: var(--v4-card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        #create-playlist-btn {
            background: var(--v4-purple-gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 2.5em;
            line-height: 45px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(103, 32, 189, 0.3);
        }
        #create-playlist-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(103, 32, 189, 0.4);
        }
        #playlists-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }
        .playlist-card {
            background-color: var(--v4-card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.07);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-left: 8px solid var(--v4-purple-accent); /* Default color */
            overflow: hidden;
        }
        .playlist-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .playlist-card h3 {
            margin: 0 0 8px 0;
            font-size: 1.4em;
            color: var(--v4-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 60px; /* Space for buttons */
        }
        .playlist-card p {
            margin: 0;
            color: var(--v4-text-secondary);
            font-size: 0.9em;
            height: 2.7em; /* approx 2 lines */
            overflow: hidden;
        }
        .playlist-card-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .playlist-card:hover .playlist-card-actions {
            opacity: 1;
        }
        .playlist-action-btn {
            background: rgba(0,0,0,0.05);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .playlist-action-btn:hover {
            background: rgba(0,0,0,0.1);
        }
        #no-playlists-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 50px;
            background: var(--v4-card-bg);
            border-radius: 15px;
            color: var(--v4-text-secondary);
            font-size: 1.2em;
        }
        #back-to-grid-btn {
            background: none;
            border: 1px solid var(--v4-border-light);
            color: var(--v4-text-secondary);
            font-size: 1em;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #back-to-grid-btn:hover {
            border-color: var(--v4-purple-accent);
            background-color: var(--v4-input-bg);
            color: var(--v4-purple-accent);
        }

        /* --- Playlist Creation Modal Styles --- */
        .playlist-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none; /* Toggled by JS */
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .playlist-modal-overlay.visible {
            display: flex;
            opacity: 1;
        }
        .playlist-modal-content {
            background: var(--v4-card-bg);
            padding: 30px 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .playlist-modal-overlay.visible .playlist-modal-content {
            transform: scale(1);
        }
        .playlist-modal-content h2 {
            font-size: 1.8em; margin-top: 0; color: var(--v4-purple-accent);
        }
        .playlist-modal-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .playlist-modal-input-group { display: flex; flex-direction: column; }
        .playlist-modal-input-group label { margin-bottom: 8px; font-weight: 600; color: var(--v4-text-secondary); }
        .playlist-modal-input-group input, .playlist-modal-input-group textarea {
            padding: 12px;
            background-color: var(--v4-input-bg);
            border: 1px solid var(--v4-input-border);
            border-radius: 8px;
            font-size: 1em;
            font-family: var(--v4-font-secondary);
        }
        .playlist-modal-input-group textarea { resize: vertical; min-height: 60px; }
        .color-palette { display: flex; gap: 10px; flex-wrap: wrap; }
        .color-palette .color-choice {
            width: 30px; height: 30px; border-radius: 50%;
            cursor: pointer; transition: all 0.2s ease;
            border: 3px solid transparent;
        }
        .color-palette .color-choice.selected {
            border-color: var(--v4-card-bg);
            box-shadow: 0 0 0 3px var(--v4-purple-accent);
            transform: scale(1.1);
        }
        #modal-sounds-container {
            flex-grow: 1;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid var(--v4-border-softer);
            border-radius: 10px;
            padding: 15px;
        }
        .modal-sound-button {
            background-color: var(--v4-card-bg); color: var(--v4-text-secondary);
            border: 1px solid var(--v4-border-light);
            padding: 8px 12px; font-size: 0.9em;
            text-align: center; cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            font-family: var(--v4-font-primary);
            border-radius: 8px;
        }
        .modal-sound-button:hover {
            border-color: var(--v4-purple-accent);
            color: var(--v4-purple-accent);
        }
        .modal-sound-button.selected {
            background: var(--v4-purple-accent);
            color: white;
            border-color: var(--v4-purple-accent-darker);
            transform: scale(1.03);
            font-weight: bold;
        }
        .playlist-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }
        .modal-btn { padding: 12px 25px; border-radius: 8px; border: none; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.2s ease; }
        .modal-btn-primary { background: var(--v4-purple-gradient); color: white; }
        .modal-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(103, 32, 189, 0.3); }
        .modal-btn-secondary { background: #e9ecef; color: var(--v4-text-secondary); }
        .modal-btn-secondary:hover { background: #dee2e6; }
    </style>
</head>
<body class="playlists-page">

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="soundboard-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <div class="user-info">
                <div class="marquee-container"> <span id="userName" class="marquee-content username">Loading…</span> </div>
                <div class="marquee-container"> <span id="userEmail" class="marquee-content email">Loading…</span> </div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">🛡️</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="playlists.html" class="active"><span class="icon">✨</span><span class="label">Playlists</span></a></li>
                    <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-soundboard-content" id="playlists-main-content">
            
            <div id="playlist-grid-view">
                <div class="playlists-page-header">
                    <h1 class="soundboard-title-v4">My Playlists</h1>
                    <button id="create-playlist-btn" title="Create New Playlist">+</button>
                </div>
                <div id="playlists-container">
                    </div>
            </div>

            <div id="playlist-soundboard-view" style="display: none;">
                <div class="soundboard-header-v4">
                    <button id="back-to-grid-btn">&larr; Back to Playlists</button>
                    <h2 id="playlist-soundboard-title" class="soundboard-title-v4">Playlist Name</h2>
                </div>
                
                <div class="status-message-v4" id="statusMessageV4"></div>

                <div class="settings-tab-container">
                    <div class="settings-header">
                         <div class="settings-top-row">
                             <nav class="settings-tabs">
                                 <button class="tab-link active" data-tab="playback">Playback</button>
                                 <button class="tab-link" data-tab="autoclicker">Autoclicker</button>
                                 <button class="tab-link" data-tab="modes">Audio Modes</button>
                                 <button class="tab-link" data-tab="equalizer">Equalizer</button>
                                 <button class="tab-link" data-tab="effects">Effects</button>
                             </nav>
                             <div class="settings-buttons-group">
                                 <button id="saveSettingsBtn">Save</button>
                                 <button id="resetSettingsBtn">Reset</button>
                             </div>
                         </div>
                         <input type="text" id="settingsSearch" placeholder="Search settings...">
                    </div>
                    </div>

                <div id="playlistSoundCategoriesContainer">
                    </div>
            </div>
        </main>
    </div>

    <div id="bottom-fixed-bar">
        <input type="text" id="soundSearchInput" placeholder="Search sounds in this playlist...">
        <button id="clearSoundsBtn">Clear Sounds</button>
    </div>

    <div id="playlist-modal" class="playlist-modal-overlay">
        <div class="playlist-modal-content">
            <h2 id="modal-title">Create a New Playlist</h2>
            <div class="playlist-modal-form-grid">
                <div class="playlist-modal-input-group">
                    <label for="playlist-name">Playlist Name (Max 24)</label>
                    <input type="text" id="playlist-name" maxlength="24" placeholder="e.g., Epic Movie Moments">
                </div>
                <div class="playlist-modal-input-group">
                    <label>Accent Color</label>
                    <div id="playlist-color-palette" class="color-palette">
                        </div>
                </div>
                <div class="playlist-modal-input-group" style="grid-column: 1 / -1;">
                    <label for="playlist-desc">Description (Max 64)</label>
                    <textarea id="playlist-desc" maxlength="64" placeholder="Sounds for intense gaming sessions."></textarea>
                </div>
            </div>
            
            <label style="margin-bottom: 8px; font-weight: 600; color: var(--v4-text-secondary);">Select Sounds</label>
            <div id="modal-sounds-container">
                </div>

            <div class="playlist-modal-actions">
                <button id="modal-cancel-btn" class="modal-btn modal-btn-secondary">Cancel</button>
                <button id="modal-save-btn" class="modal-btn modal-btn-primary">Save Playlist</button>
            </div>
        </div>
    </div>


    <script>
    // --- Standard Setup (Auth, Sidebar, User Info) ---
    // This part is identical to your soundboard.html for consistency
    const dbRef_ = () => firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid);
    const marqueeEls_ = document.querySelectorAll('.marquee-content');
    firebase.auth().onAuthStateChanged(async user => {
        if (!user) { window.location.href = '../login.html'; }
        else {
            const userEmailEl = document.getElementById('userEmail');
            const userNameEl = document.getElementById('userName');
            if (userEmailEl) userEmailEl.textContent = user.email;
            if (userNameEl) {
                try {
                    const doc = await dbRef_().get();
                    userNameEl.textContent = (doc.exists && doc.data().username) ? doc.data().username : (user.displayName || 'User');
                } catch (error) { userNameEl.textContent = 'User'; console.error("Error fetching username:", error); }
            }
            updateMarquees_();
        }
    });
    document.getElementById('logoutBtn')?.addEventListener('click', () => { firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
    document.getElementById('signOutLink')?.addEventListener('click', (e) => { e.preventDefault(); firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
    const sidebar_ = document.getElementById('sidebar');
    const toggleSidebarBtn_ = document.getElementById('toggleSidebar');
    if (toggleSidebarBtn_ && sidebar_) { toggleSidebarBtn_.addEventListener('click', () => { sidebar_.classList.toggle('collapsed'); setTimeout(updateMarquees_, 550); }); }
    function updateMarquees_() {
        marqueeEls_.forEach(el => {
            if (!el || !el.parentElement) return;
            const parent = el.parentElement; const overflow = el.scrollWidth > parent.clientWidth;
            const shouldScroll = sidebar_.classList.contains('collapsed') || (overflow && !sidebar_.classList.contains('collapsed'));
            el.classList.toggle('marquee-active', shouldScroll);
            if (!overflow && !sidebar_.classList.contains('collapsed')) { el.classList.remove('marquee-active'); }
        });
    }
    window.addEventListener('resize', updateMarquees_);
    // --- End Standard Setup ---

    // --- Playlist & Soundboard Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- Core Playlist Variables ---
        const PLAYLIST_STORAGE_KEY = 'userPlaylistsV1';
        let playlists = [];
        let allSoundsData = null; // Cache for all available sounds
        let editingPlaylistId = null;

        // --- Playlist UI Elements ---
        const gridView = document.getElementById('playlist-grid-view');
        const soundboardView = document.getElementById('playlist-soundboard-view');
        const playlistsContainer = document.getElementById('playlists-container');
        const createPlaylistBtn = document.getElementById('create-playlist-btn');
        const backToGridBtn = document.getElementById('back-to-grid-btn');
        const playlistSoundboardTitle = document.getElementById('playlist-soundboard-title');
        const playlistCategoriesContainer = document.getElementById('playlistSoundCategoriesContainer');

        // --- Modal UI Elements ---
        const modal = document.getElementById('playlist-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalPlaylistName = document.getElementById('playlist-name');
        const modalPlaylistDesc = document.getElementById('playlist-desc');
        const modalColorPalette = document.getElementById('playlist-color-palette');
        const modalSoundsContainer = document.getElementById('modal-sounds-container');
        
        // This section is a simplified placeholder for the full soundboard script.
        // In a real implementation, the complex script from soundboard.html would be here.
        // For this example, we'll simulate its main functions.
        const soundboardScriptElements = {
            soundSearchInput: document.getElementById('soundSearchInput'),
            clearSoundsBtn: document.getElementById('clearSoundsBtn'),
            // We assume the full script is present to handle the audio context, settings, etc.
        };

        // --- COLOR PALETTE ---
        const colorPalette = [
            '#6720bd', '#8a2be2', '#4169e1', '#00ced1', '#3cb371', 
            '#ff8c00', '#ff4500', '#e91e63', '#9c27b0', '#795548'
        ];

        function initializeColorPalette() {
            modalColorPalette.innerHTML = '';
            colorPalette.forEach(color => {
                const colorChoice = document.createElement('div');
                colorChoice.className = 'color-choice';
                colorChoice.style.backgroundColor = color;
                colorChoice.dataset.color = color;
                colorChoice.addEventListener('click', () => {
                    document.querySelectorAll('.color-choice.selected').forEach(c => c.classList.remove('selected'));
                    colorChoice.classList.add('selected');
                });
                modalColorPalette.appendChild(colorChoice);
            });
        }

        // --- DATA HANDLING ---
        function loadPlaylistsFromStorage() {
            const data = localStorage.getItem(PLAYLIST_STORAGE_KEY);
            playlists = data ? JSON.parse(data) : [];
        }

        function savePlaylistsToStorage() {
            localStorage.setItem(PLAYLIST_STORAGE_KEY, JSON.stringify(playlists));
        }
        
        async function fetchAllSounds() {
            if (allSoundsData) return allSoundsData;
            try {
                const response = await fetch('../SoundboardNames.json');
                allSoundsData = await response.json();
                return allSoundsData;
            } catch (error) {
                console.error("Failed to load sound names JSON:", error);
                return {};
            }
        }

        // --- VIEW RENDERING ---
        function renderPlaylistGrid() {
            playlistsContainer.innerHTML = '';
            if (playlists.length === 0) {
                playlistsContainer.innerHTML = `
                    <div id="no-playlists-message">
                        <p>You haven't created any playlists yet. 🎶</p>
                        <p>Click the <strong>+</strong> button to get started!</p>
                    </div>`;
                return;
            }

            playlists.forEach(p => {
                const card = document.createElement('div');
                card.className = 'playlist-card';
                card.dataset.playlistId = p.id;
                card.style.borderLeftColor = p.color;
                card.innerHTML = `
                    <h3>${p.name}</h3>
                    <p>${p.description}</p>
                    <div class="playlist-card-actions">
                        <button class="playlist-action-btn edit-btn" title="Edit Playlist">✏️</button>
                        <button class="playlist-action-btn delete-btn" title="Delete Playlist">🗑️</button>
                    </div>
                `;
                playlistsContainer.appendChild(card);
            });
        }

        async function populateModalSoundSelector(selectedSounds = []) {
            const soundsData = await fetchAllSounds();
            modalSoundsContainer.innerHTML = '';
            
            const grid = document.createElement('div');
            grid.className = 'sound-buttons-grid-v4';

            for (const category in soundsData) {
                soundsData[category].forEach(soundFile => {
                    const btn = document.createElement('button');
                    btn.className = 'modal-sound-button';
                    btn.textContent = soundFile.replace('.mp3', '').replace(/_/g, ' ');
                    btn.dataset.soundFile = soundFile;
                    if (selectedSounds.includes(soundFile)) {
                        btn.classList.add('selected');
                    }
                    btn.addEventListener('click', () => btn.classList.toggle('selected'));
                    grid.appendChild(btn);
                });
            }
            modalSoundsContainer.appendChild(grid);
        }

        // --- VIEW TRANSITIONS ---
        function showGridView() {
            // Assume the full soundboard script has a `clearSounds()` function
            if (window.clearSounds) window.clearSounds();
            gridView.style.display = 'block';
            soundboardView.style.display = 'none';
        }

        function showPlaylistSoundboardView(playlistId) {
            const playlist = playlists.find(p => p.id === playlistId);
            if (!playlist) {
                console.error("Playlist not found!");
                return;
            }
            
            gridView.style.display = 'none';
            soundboardView.style.display = 'block';
            playlistSoundboardTitle.textContent = playlist.name;

            // This is the crucial part: load ONLY the sounds from the playlist
            // The full soundboard script must be adapted to handle this.
            // We'll simulate this by creating a dedicated function.
            loadSoundsForPlaylist(playlist.sounds, playlistCategoriesContainer);
        }
        
        // Simplified version of the soundboard's `loadSoundsAndCreateButtons`
        // In a real scenario, you'd refactor the original script.
        async function loadSoundsForPlaylist(soundFiles, container) {
            container.innerHTML = '<p>Loading sounds...</p>';
            const allSounds = await fetchAllSounds();
            const playlistSoundData = {};

            // Re-create the category structure for the playlist sounds
            for (const category in allSounds) {
                const soundsInCategory = allSounds[category].filter(sf => soundFiles.includes(sf));
                if (soundsInCategory.length > 0) {
                    playlistSoundData[category] = soundsInCategory;
                }
            }
            
            container.innerHTML = ''; // Clear loading message

            if (Object.keys(playlistSoundData).length === 0) {
                 container.innerHTML = '<p style="text-align:center; color: #777;">This playlist has no sounds.</p>';
                 return;
            }

            for (const categoryKey in playlistSoundData) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'sound-category-v4';
                categoryDiv.innerHTML = `<h2>${categoryKey.replace(/([A-Z])/g, ' $1').trim()}</h2>`;
                const buttonsGrid = document.createElement('div');
                buttonsGrid.className = 'sound-buttons-grid-v4';
                
                playlistSoundData[categoryKey].forEach(fileName => {
                    const button = document.createElement('button');
                    button.className = 'sound-button-v4';
                    button.textContent = fileName.replace('.mp3', '').replace(/_/g, ' ');
                    button.dataset.soundFile = fileName;
                    // IMPORTANT: The full soundboard script would attach its complex event listeners here.
                    // For example: button.addEventListener('click', handleSoundPlay);
                    buttonsGrid.appendChild(button);
                });

                categoryDiv.appendChild(buttonsGrid);
                container.appendChild(categoryDiv);
            }
            
            // Re-initialize the sound playing logic from the main soundboard script
            // This is a placeholder for where that re-initialization would happen.
            if (window.initializeSoundboardForContainer) {
                window.initializeSoundboardForContainer(container.id);
            } else {
                console.warn("`window.initializeSoundboardForContainer` not found. Sound playback will not work. Please refactor soundboard.js.");
            }
        }


        // --- MODAL LOGIC ---
        function openModal(playlistId = null) {
            editingPlaylistId = playlistId;
            if (playlistId) {
                const p = playlists.find(p => p.id === playlistId);
                modalTitle.textContent = 'Edit Playlist';
                modalPlaylistName.value = p.name;
                modalPlaylistDesc.value = p.description;
                populateModalSoundSelector(p.sounds);
                
                document.querySelectorAll('.color-choice').forEach(c => {
                    c.classList.toggle('selected', c.dataset.color === p.color);
                });

            } else {
                modalTitle.textContent = 'Create a New Playlist';
                modalPlaylistName.value = '';
                modalPlaylistDesc.value = '';
                populateModalSoundSelector([]);
                
                document.querySelectorAll('.color-choice.selected').forEach(c => c.classList.remove('selected'));
                const firstColor = document.querySelector('.color-choice');
                if (firstColor) firstColor.classList.add('selected');
            }
            modal.classList.add('visible');
        }

        function closeModal() {
            modal.classList.remove('visible');
            editingPlaylistId = null;
        }

        function handleSavePlaylist() {
            const name = modalPlaylistName.value.trim();
            const description = modalPlaylistDesc.value.trim();
            const selectedColorEl = modalColorPalette.querySelector('.selected');
            const color = selectedColorEl ? selectedColorEl.dataset.color : colorPalette[0];
            
            if (!name) {
                alert("Please provide a name for the playlist.");
                return;
            }

            const selectedSoundNodes = modalSoundsContainer.querySelectorAll('.modal-sound-button.selected');
            const sounds = Array.from(selectedSoundNodes).map(node => node.dataset.soundFile);
            
            if (editingPlaylistId) {
                // Update existing playlist
                const index = playlists.findIndex(p => p.id === editingPlaylistId);
                if (index > -1) {
                    playlists[index] = { ...playlists[index], name, description, color, sounds };
                }
            } else {
                // Create new playlist
                const newPlaylist = {
                    id: `p_${Date.now()}`,
                    name,
                    description,
                    color,
                    sounds
                };
                playlists.push(newPlaylist);
            }
            
            savePlaylistsToStorage();
            renderPlaylistGrid();
            closeModal();
        }

        // --- EVENT LISTENERS ---
        createPlaylistBtn.addEventListener('click', () => openModal());
        
        modalCancelBtn.addEventListener('click', closeModal);
        modalSaveBtn.addEventListener('click', handleSavePlaylist);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        backToGridBtn.addEventListener('click', showGridView);

        playlistsContainer.addEventListener('click', (e) => {
            const card = e.target.closest('.playlist-card');
            if (!card) return;

            const playlistId = card.dataset.playlistId;

            if (e.target.closest('.edit-btn')) {
                e.stopPropagation(); // Prevent card click
                openModal(playlistId);
            } else if (e.target.closest('.delete-btn')) {
                e.stopPropagation(); // Prevent card click
                if (confirm("Are you sure you want to delete this playlist? This cannot be undone.")) {
                    playlists = playlists.filter(p => p.id !== playlistId);
                    savePlaylistsToStorage();
                    renderPlaylistGrid();
                }
            } else {
                // Clicked on the card itself, not a button
                showPlaylistSoundboardView(playlistId);
            }
        });


        // --- INITIALIZATION ---
        function initialize() {
            initializeColorPalette();
            loadPlaylistsFromStorage();
            renderPlaylistGrid();
            // This is where you would initialize the full soundboard script
            // e.g., initializeFullSoundboardLogic();
        }

        initialize();
        
        // NOTE: The full, complex soundboard logic from soundboard.html would need to be
        // included and refactored here to work with the dynamic playlist view.
        // Specifically, the sound playing logic needs to be attached to buttons
        // created inside `loadSoundsForPlaylist`. This file provides the complete
        // UI and data management structure as requested.
    });
    </script>
</body>
</html>
