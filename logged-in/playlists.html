<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - PLAYLISTS</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="../panic-key.js"></script>

    <style>
        /* --- Base styles from soundboard.html --- */
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
            --sound-search-bar-container-width: 530px;
        }
        body { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: var(--v4-font-primary); background: var(--v4-bg-gradient); color: var(--v4-text-primary); line-height: 1.6; }
        .soundboard-container-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: visible; }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em; }
        .marquee-content { display: inline-block; padding-left: 100%; transform: translateX(0); animation: none; line-height: 1.8em; }
        .marquee-active { animation: scroll-left-soundboard 12s linear infinite; }
        @keyframes scroll-left-soundboard { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .user-info .username { font-family: var(--v4-font-primary); font-size: 1.3em; margin-bottom: 8px; line-height: 0.2em; font-weight: bold;}
        .user-info .email { font-family: var(--v4-font-secondary); font-size: 0.9em; color: #bbb; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: var(--v4-font-primary); text-transform: uppercase; position: relative; overflow: hidden; font-size: 1em; }
        .sidebar nav a:hover, .sidebar nav a.active { background: var(--v4-purple-gradient); transform: translateX(5px); color: #fff; }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .sidebar.collapsed nav a .label { display: none; }
        .main-soundboard-content { flex: 1; padding: 30px; background: var(--v4-bg-gradient); overflow-y: auto; display: flex; flex-direction: column; padding-bottom: 120px; position: relative; }
        .soundboard-header-v4 { margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .soundboard-title-v4 { font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .is-hidden { display: none !important; }
        .view-container { transition: opacity 0.3s ease-in-out; }
        
        /* --- ALL REQUIRED STYLES for soundboard controls --- */
        /* These are copied directly from the original soundboard.html to ensure full compatibility */
        .settings-tab-container { background: var(--v4-card-bg); border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); margin-bottom: 25px; overflow: visible; }
        .settings-header { display: flex; flex-direction: column; padding: 0 15px; border-bottom: 1px solid var(--v4-border-softer); }
        .settings-top-row { display: flex; justify-content: space-between; align-items: center; width: 100%;}
        nav.settings-tabs { display: flex; flex-wrap: wrap; }
        .tab-link { background: none; border: none; padding: 15px 20px; cursor: pointer; font-size: 1.1em; font-family: var(--v4-font-primary); color: var(--v4-text-secondary); border-bottom: 3px solid transparent; margin-bottom: -1px; transition: all 0.2s ease-in-out; }
        .tab-link.active, .tab-link:hover { color: var(--v4-purple-accent); }
        .tab-link.active { border-bottom-color: var(--v4-purple-accent); font-weight: bold; }
        .settings-buttons-group { display: flex; gap: 8px; }
        #resetSettingsBtn, #saveSettingsBtn { background: none; border: 1px solid var(--v4-border-light); color: var(--v4-text-secondary); font-size: 0.8em; padding: 5px 10px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-family: var(--v4-font-secondary); white-space: nowrap; }
        #resetSettingsBtn:hover { border-color: #dc3545; background-color: #dc3545; color: white; }
        #saveSettingsBtn:hover { border-color: #0d6efd; background-color: #0d6efd; color: white;}
        #resetEqBtn { margin-top: 10px; padding: 8px; width: 100%; background-color: var(--v4-input-bg); border: 1px solid var(--v4-border-light); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-family: var(--v4-font-primary); color: var(--v4-text-secondary); }
        #resetEqBtn:hover { border-color: var(--v4-purple-accent); background-color: #f0e8ff; }
        #settingsSearch { width: 100%; padding: 10px 15px; margin: 10px 0; border-radius: 12px; border: 1px solid var(--v4-border-light); font-family: var(--v4-font-secondary); font-size: 1em; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
        #settingsSearch:focus { border-color: var(--v4-purple-accent); box-shadow: 0 0 0 2px rgba(103, 32, 189, 0.2); }
        .tab-content { display: none; padding: 15px 25px 25px 25px; gap: 15px 25px; overflow: visible; }
        .tab-content.active { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .settings-tab-container.search-active .tab-content.active { display: none; }
        #effects.active, #equalizer.active { grid-template-columns: 1fr 1fr; }
        .control-group { position: relative; display: flex; flex-direction: column; margin-bottom: 10px; transition: opacity 0.3s ease; border-radius: 8px; }
        .control-group.hidden-by-search { display: none; }
        .control-group.highlight { box-shadow: 0 0 0 2px var(--v4-purple-accent); border-radius: 8px; transition: box-shadow 0.3s ease-in-out; }
        .control-group.disabled, .control-group.locked { opacity: 0.4; pointer-events: none; cursor: not-allowed; }
        .control-group.locked * { pointer-events: none; cursor: not-allowed; }
        .control-group label, .checkbox-label-v4 { font-family: var(--v4-font-primary); font-weight: 600; font-size: 0.95em; color: var(--v4-text-secondary); margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        .slider-input-container { display: flex; align-items: center; gap: 12px; }
        .control-group input[type="range"] { -webkit-appearance: none; appearance: none; flex-grow: 1; height: 8px; background: var(--v4-border-light); outline: none; border-radius: 5px; transition: opacity 0.2s; }
        .control-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--v4-purple-accent); cursor: pointer; border-radius: 50%; }
        .control-group input[type="number"], .control-group select, .control-group input[type="text"]:not(#settingsSearch) { padding: 8px; background-color: var(--v4-input-bg); border: 1px solid var(--v4-input-border); border-radius: 6px; color: var(--v4-text-primary); font-family: var(--v4-font-secondary); font-size: 0.9em; outline: none; box-sizing: border-box; }
        input.slider-value-input { width: 70px; text-align: center; }
        .checkbox-label-v4 { padding: 8px 0; flex-wrap: wrap; }
        .control-group input[type="checkbox"] { margin-left: 12px; transform: scale(1.1); accent-color: var(--v4-purple-accent); }
        .radio-group-container { display: flex; gap: 20px; background-color: var(--v4-input-bg); padding: 10px; border-radius: 8px; border: 1px solid var(--v4-input-border); }
        .radio-label { display: flex; align-items: center; cursor: pointer; }
        .radio-label input[type="radio"] { margin-right: 8px; accent-color: var(--v4-purple-accent); transform: scale(1.1); }
        .device-display { background-color: var(--v4-input-bg); border: 1px solid var(--v4-border-light); border-radius: 8px; padding: 10px; margin-top: 5px; font-size: 0.85em; color: var(--v4-text-secondary); }
        #searchResultsContainer { display: none; max-height: 350px; overflow-y: auto; padding: 0 25px 25px 25px; }
        #searchResultsContainer .search-result-item { padding: 12px; border-bottom: 1px solid var(--v4-border-softer); cursor: pointer; transition: background-color 0.2s ease; display: flex; justify-content: space-between; align-items: center; }
        #searchResultsContainer .search-result-item:hover { background-color: var(--v4-input-bg); }
        .search-result-category { font-size: 0.8em; text-transform: uppercase; color: var(--v4-text-secondary); background-color: #e9ecef; padding: 2px 6px; border-radius: 4px; }
        #mic-permission-prompt { padding: 15px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; text-align: center; grid-column: 1 / -1; }
        .mode-description { display: block; width: 100%; font-family: var(--v4-font-secondary); font-size: 0.85em; color: #777; margin-top: -5px; margin-bottom: 5px; padding-left: 2px; font-style: italic; font-weight: 400; }
        .spatial-audio-control { grid-column: 1 / -1; padding: 10px; border: 1px solid transparent; border-radius: 12px; transition: background-color 0.4s ease, border-color 0.4s ease; }
        .spatial-audio-control:has(input:checked) { background-color: #f8f9fa; border-color: var(--v4-border-softer); }
        .spatial-audio-panel { overflow: hidden; max-height: 0; opacity: 0; transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out, margin-top 0.5s ease-in-out; margin-top: 0; }
        .spatial-audio-control:has(input:checked) .spatial-audio-panel { max-height: 400px; opacity: 1; margin-top: 15px; }
        #spatial-pad { position: relative; width: 180px; height: 180px; border-radius: 50%; background-color: #e9e9e9; border: 1px solid #d1d1d1; cursor: crosshair; }
        #spatial-puck { position: absolute; top: 50%; left: 50%; width: 24px; height: 24px; background-color: #222; border: 2px solid var(--v4-purple-accent); border-radius: 50%; transform: translate(-50%, -50%); cursor: grab; z-index: 10; }
        .sound-category-v4 { margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); transition: opacity 0.3s ease-in-out; }
        .sound-category-v4 h2 { font-size: 1.5em; color: var(--v4-text-primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--v4-border-softer); text-transform: uppercase; }
        .sound-buttons-grid-v4 { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .sound-button-v4 { background-color: var(--v4-input-bg); color: var(--v4-text-secondary); border: 1px solid var(--v4-input-border); padding: 8px 12px; font-size: 1em; text-align: center; cursor: pointer; transition: all 0.2s ease, opacity 0.3s ease-in-out; text-transform: uppercase; font-family: var(--v4-font-primary); border-radius: 12px; }
        .sound-button-v4:hover { background-color: #e9ecef; border-color: var(--v4-purple-accent); color: var(--v4-purple-accent); transform: translateY(-2px); }
        .sound-button-v4.playing { background-color: var(--v4-purple-accent); color: white; border: 2px solid var(--v4-purple-accent-darker); }
        .sound-button-v4.pulsating { animation: pulsePlayingSoundboardV4 1.5s infinite; }
        @keyframes pulsePlayingSoundboardV4 { 0% { box-shadow: 0 0 0 0px var(--v4-purple-accent); } 100% { box-shadow: 0 0 0 8px rgba(103, 32, 189, 0); } }
        #bottom-fixed-bar { position: fixed; bottom: 15px; right: 15px; left: auto; z-index: 1001; display: flex; align-items: center; gap: 12px; padding: 10px 10px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1)); backdrop-filter: blur(4px) saturate(3); -webkit-backdrop-filter: blur(2px) saturate(1.2); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15); width: var(--sound-search-bar-container-width); transition: opacity 0.3s ease; }
        #bottom-fixed-bar input[type="text"] { background: transparent; border: none; border-bottom: 1px solid rgba(50,50,50,0.6); color: var(--v4-text-primary); padding: 8px 5px; font-size: 1em; outline: none; font-family: var(--v4-font-secondary); flex-grow: 1; width: auto; }
        #clearSoundsBtn { padding: 10px 12px; background: rgba(255, 5, 5, 0.85); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; cursor: pointer; font-size: 0.95em; text-transform: uppercase; transition: all 0.25s ease; font-family: var(--v4-font-primary); flex-shrink: 0; }
        .mute-status { display: none; background-color: #c41e3a; color: #fff; padding: 10px 15px; border-radius: 10px; font-size: 0.9em; font-weight: bold; text-transform: uppercase; pointer-events: none; }
        .mute-status.visible { display: inline-block; }
        .status-message-v4 { display: none; padding: 15px 25px; margin: 0 auto 20px auto; border-radius: 12px; text-align: center; max-width: 600px; text-transform: uppercase; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); color: white; }
        .status-message-v4.success { background: linear-gradient(135deg, #1c7430, #155724); }
        .status-message-v4.error { background: linear-gradient(135deg, #8f262a, #721c24); }
        .status-message-v4.info { background: linear-gradient(135deg, #004085, #002752); }


        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: scale(0.95); } }
        .fade-out { animation: fadeOut 0.4s ease-in forwards; }

        /* --- PLAYLIST GRID STYLES --- */
        #playlists-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .playlist-card, .add-playlist-card { background-color: var(--v4-card-bg); border-radius: 15px; padding: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.07); cursor: pointer; transition: all 0.3s ease; position: relative; border-left: 8px solid; overflow: hidden; }
        .playlist-card:hover, .add-playlist-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .playlist-card h3 { margin: 0 0 8px 0; font-size: 1.4em; color: var(--v4-text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 60px; /* Space for buttons */ }
        .playlist-card p { margin: 0; color: var(--v4-text-secondary); font-size: 0.9em; height: 2.7em; /* approx 2 lines */ overflow: hidden; }
        .playlist-card-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; opacity: 0; transition: opacity 0.3s ease; }
        .playlist-card:hover .playlist-card-actions { opacity: 1; }
        .playlist-action-btn { background: rgba(0,0,0,0.05); border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1em; cursor: pointer; display:flex; align-items:center; justify-content:center; transition: background-color 0.2s; }
        .playlist-action-btn:hover { background: rgba(0,0,0,0.1); }
        .add-playlist-card { border-left-color: var(--v4-border-light); border-style: dashed; border-width: 2px; border-left-width: 2px; color: var(--v4-text-secondary); display: flex; align-items: center; justify-content: center; flex-direction: column; min-height: 120px; }
        .add-playlist-card-plus { font-size: 3em; line-height: 1; }
        #no-playlists-message { grid-column: 1 / -1; text-align: center; padding: 50px; background: var(--v4-card-bg); border-radius: 15px; color: var(--v4-text-secondary); font-size: 1.2em; }

        /* --- PLAYLIST SOUNDBOARD VIEW STYLES --- */
        #playlist-soundboard-view .settings-tab-container, #playlist-soundboard-view .sound-category-v4 { opacity: 0; animation: fadeIn 0.5s ease-out forwards; animation-delay: 0.2s; }
        #back-to-grid-btn { background: none; border: 1px solid var(--v4-border-light); color: var(--v4-text-secondary); font-size: 1em; padding: 8px 15px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        #back-to-grid-btn:hover { border-color: var(--v4-purple-accent); background-color: var(--v4-input-bg); color: var(--v4-purple-accent); }

        /* --- MODAL STYLES --- */
        .playlist-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .playlist-modal-overlay.visible { display: flex; opacity: 1; }
        .playlist-modal-content { background: var(--v4-card-bg); padding: 30px 40px; border-radius: 20px; width: 90%; max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.3s ease; }
        .playlist-modal-overlay.visible .playlist-modal-content { transform: scale(1); }
        .playlist-modal-content h2 { font-size: 1.8em; margin-top: 0; color: var(--v4-purple-accent); }
        .playlist-modal-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .playlist-modal-input-group { display: flex; flex-direction: column; }
        .playlist-modal-input-group label, .feature-category h4 { margin-bottom: 8px; font-weight: 600; color: var(--v4-text-secondary); }
        .playlist-modal-input-group input, .playlist-modal-input-group textarea { padding: 12px; background-color: var(--v4-input-bg); border: 1px solid var(--v4-input-border); border-radius: 8px; font-size: 1em; font-family: var(--v4-font-secondary); }
        .playlist-modal-input-group textarea { resize: vertical; min-height: 60px; }
        .color-palette { display: flex; gap: 10px; flex-wrap: wrap; }
        .color-palette .color-choice { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; transition: all 0.2s ease; border: 3px solid transparent; }
        .color-palette .color-choice.selected { border-color: var(--v4-card-bg); box-shadow: 0 0 0 3px var(--v4-purple-accent); transform: scale(1.1); }
        #modal-sounds-container { height: 200px; overflow-y: auto; background: #f8f9fa; border: 1px solid var(--v4-border-softer); border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .modal-sound-button { background-color: var(--v4-card-bg); color: var(--v4-text-secondary); border: 1px solid var(--v4-border-light); padding: 8px 12px; font-size: 0.9em; text-align: center; cursor: pointer; transition: all 0.2s ease; text-transform: uppercase; font-family: var(--v4-font-primary); border-radius: 8px; }
        .modal-sound-button.selected { background: var(--v4-purple-accent); color: white; border-color: var(--v4-purple-accent-darker); font-weight: bold; }
        #enabled-features-container { background: #f8f9fa; border: 1px solid var(--v4-border-softer); border-radius: 10px; padding: 15px; }
        .feature-category { margin-bottom: 10px; }
        .feature-category:last-child { margin-bottom: 0; }
        .feature-checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; }
        .feature-checkbox-label { display: flex; align-items: center; font-size: 0.9em; cursor: pointer; }
        .feature-checkbox-label input { margin-right: 8px; accent-color: var(--v4-purple-accent); transform: scale(1.2); }
        .playlist-modal-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 25px; }
        .modal-btn { padding: 12px 25px; border-radius: 8px; border: none; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.2s ease; }
        .modal-btn-primary { background: var(--v4-purple-gradient); color: white; }
        .modal-btn-secondary { background: #e9ecef; color: var(--v4-text-secondary); }

    </style>
</head>
<body class="playlists-page">

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="soundboard-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar">
             <button id="toggleSidebar">☰</button>
            <div class="user-info">
                <div class="marquee-container"> <span id="userName" class="marquee-content username">Loading…</span> </div>
                <div class="marquee-container"> <span id="userEmail" class="marquee-content email">Loading…</span> </div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">🛡️</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="playlists.html" class="active"><span class="icon">✨</span><span class="label">Playlists</span></a></li>
                    <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-soundboard-content" id="playlists-main-content">
            
            <div id="playlist-grid-view" class="view-container">
                <div class="soundboard-header-v4">
                    <h1 class="soundboard-title-v4">My Playlists</h1>
                </div>
                <div id="playlists-container">
                    </div>
            </div>

            <div id="playlist-soundboard-view" class="view-container is-hidden">
                <div class="soundboard-header-v4">
                    <button id="back-to-grid-btn">&larr; Back to Playlists</button>
                    <h2 id="playlist-soundboard-title" class="soundboard-title-v4"></h2>
                </div>
                
                <div class="status-message-v4" id="statusMessageV4"></div>

                <div class="settings-tab-container">
                    <div class="settings-header">
                        <div class="settings-top-row">
                            <nav class="settings-tabs">
                                <button class="tab-link active" data-tab="playback">Playback</button>
                                <button class="tab-link" data-tab="autoclicker">Autoclicker</button>
                                <button class="tab-link" data-tab="modes">Audio Modes</button>
                                <button class="tab-link" data-tab="equalizer">Equalizer</button>
                                <button class="tab-link" data-tab="effects">Effects</button>
                            </nav>
                            <div class="settings-buttons-group">
                                <button id="saveSettingsBtn">Save</button>
                                <button id="resetSettingsBtn">Reset</button>
                            </div>
                        </div>
                        <input type="text" id="settingsSearch" placeholder="Search settings...">
                    </div>
                    <div id="searchResultsContainer"></div>
                     <div id="playback" class="tab-content active">
                           <div class="control-group" data-search-terms="allow multiple sounds"><label class="checkbox-label-v4">Allow Multiple Sounds <input type="checkbox" id="allowMultipleSounds" data-setting="allowMultiple"></label></div>
                           <div class="control-group" data-search-terms="sound looping"><label class="checkbox-label-v4">Sound Looping <input type="checkbox" id="soundLooping" data-setting="looping"></label></div>
                           <div id="masterVolumeControlGroup" class="control-group" data-search-terms="master volume"><label for="masterVolume">Master Volume: <span id="masterVolumeValue">100%</span></label><div class="slider-input-container"><input type="range" id="masterVolume" min="0" max="1" step="0.01" value="1" data-setting="masterVolume"><input type="number" id="masterVolumeInput" class="slider-value-input" data-slider-id="masterVolume" min="0" max="100" step="1"></div></div>
                     </div>
                     <div id="autoclicker" class="tab-content">
                         <div class="control-group" data-search-terms="autoclicker enable"><label class="checkbox-label-v4">Enable Autoclicker <input type="checkbox" id="autoclickerEnabled" data-setting="autoclickerEnabled"></label></div>
                         <div class="control-group" data-search-terms="autoclicker interval speed"><label for="clickInterval">Click Interval (ms)</label><input type="number" id="clickInterval" value="200" min="50" data-setting="clickInterval"></div>
                     </div>
                     <div id="modes" class="tab-content">
                          <div class="spatial-audio-control" data-search-terms="spatial audio"><label class="checkbox-label-v4">Spatial Audio<input type="checkbox" id="modeSpatial" data-setting="modeSpatial"></label><div class="spatial-audio-panel"><div class="spatial-interactive-area"><div id="spatial-pad"><div id="spatial-puck"></div></div></div></div></div>
                          <div class="control-group" data-search-terms="vintage warmth"><label class="checkbox-label-v4">Vintage Warmth <input type="checkbox" data-setting="modeVintageWarmth"></label></div>
                          <div class="control-group" data-search-terms="party mode"><label class="checkbox-label-v4">Party Mode <input type="checkbox" id="modeParty" data-setting="modeParty"></label></div>
                     </div>
                     <div id="equalizer" class="tab-content">
                          <div class="control-group" data-search-terms="equalizer eq bass"><label for="eqBass">Bass: <span id="eqBassValue">0 dB</span></label><div class="slider-input-container"><input type="range" id="eqBass" min="-40" max="80" step="1" value="0" data-setting="eqBass"><input type="number" class="slider-value-input" data-slider-id="eqBass" min="-40" max="80" step="1"></div></div>
                          <div class="control-group" data-search-terms="equalizer eq mid"><label for="eqMid">Mid: <span id="eqMidValue">0 dB</span></label><div class="slider-input-container"><input type="range" id="eqMid" min="-20" max="20" step="1" value="0" data-setting="eqMid"><input type="number" class="slider-value-input" data-slider-id="eqMid" min="-20" max="20" step="1"></div></div>
                          <div class="control-group" data-search-terms="equalizer eq treble highs"><label for="eqTreble">Treble: <span id="eqTrebleValue">0 dB</span></label><div class="slider-input-container"><input type="range" id="eqTreble" min="-30" max="30" step="1" value="0" data-setting="eqTreble"><input type="number" class="slider-value-input" data-slider-id="eqTreble" min="-30" max="30" step="1"></div></div>
                     </div>
                     <div id="effects" class="tab-content">
                          <div class="control-group" data-search-terms="fade in"><label for="fadeIn">Fade In (sec): <span id="fadeInValue">0.1s</span></label><div class="slider-input-container"><input type="range" id="fadeIn" min="0" max="5" step="0.1" value="0.1" data-setting="fadeIn"><input type="number" class="slider-value-input" data-slider-id="fadeIn" min="0" max="5" step="0.1"></div></div>
                          <div class="control-group" data-search-terms="fade out"><label for="fadeOut">Fade Out (sec): <span id="fadeOutValue">0.1s</span></label><div class="slider-input-container"><input type="range" id="fadeOut" min="0" max="5" step="0.1" value="0.1" data-setting="fadeOut"><input type="number" class="slider-value-input" data-slider-id="fadeOut" min="0" max="5" step="0.1"></div></div>
                          <div class="control-group" data-search-terms="speed rate tempo"><label for="speed">Speed: <span id="speedValue">1.00x</span></label><div class="slider-input-container"><input type="range" id="speed" min="0.25" max="4" step="0.01" value="1" data-setting="speed"><input type="number" class="slider-value-input" data-slider-id="speed" min="0.25" max="4" step="0.01"></div></div>
                          <div class="control-group" data-search-terms="pitch shift detune"><label for="pitch">Pitch: <span id="pitchValue">0</span></label><div class="slider-input-container"><input type="range" id="pitch" min="-2000" max="2000" step="10" value="0" data-setting="pitch"><input type="number" class="slider-value-input" data-slider-id="pitch" min="-2000" max="2000" step="10"></div></div>
                     </div>
                </div>

                <div id="playlistSoundCategoriesContainer"></div>
            </div>
        </main>
    </div>

    <div id="bottom-fixed-bar" class="is-hidden">
        <span id="muteIndicator" class="mute-status">Muted</span>
        <input type="text" id="soundSearchInput" placeholder="Search sounds...">
        <button id="clearSoundsBtn">Clear Sounds</button>
    </div>

    <div id="playlist-modal" class="playlist-modal-overlay">
        <div class="playlist-modal-content">
            <h2 id="modal-title">Create a New Playlist</h2>
            <div class="playlist-modal-form-grid">
                <div class="playlist-modal-input-group">
                    <label for="playlist-name">Playlist Name (Max 24)</label>
                    <input type="text" id="playlist-name" maxlength="24" placeholder="e.g., Epic Movie Moments">
                </div>
                <div class="playlist-modal-input-group">
                    <label>Accent Color</label>
                    <div id="playlist-color-palette" class="color-palette"></div>
                </div>
                <div class="playlist-modal-input-group" style="grid-column: 1 / -1;">
                    <label for="playlist-desc">Description (Max 64)</label>
                    <textarea id="playlist-desc" maxlength="64" placeholder="Sounds for intense gaming sessions."></textarea>
                </div>
            </div>
            
            <label style="margin-bottom: 8px; font-weight: 600; color: var(--v4-text-secondary);">Select Sounds</label>
            <div id="modal-sounds-container"></div>

            <div id="enabled-features-container">
                <div class="feature-category">
                    <h4>Enabled Features</h4>
                    <div id="feature-checkbox-group" class="feature-checkbox-group">
                        </div>
                </div>
            </div>

            <div class="playlist-modal-actions">
                <button id="modal-cancel-btn" class="modal-btn modal-btn-secondary">Cancel</button>
                <button id="modal-save-btn" class="modal-btn modal-btn-primary">Save Playlist</button>
            </div>
        </div>
    </div>


    <script>
    // --- Standard Setup (Auth, Sidebar) ---
    const initStandardSetup = () => {
        try {
            const dbRef_ = () => firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid);
            const marqueeEls_ = document.querySelectorAll('.marquee-content');
            firebase.auth().onAuthStateChanged(async user => {
                if (!user) { window.location.href = '../login.html'; }
                else {
                    const userEmailEl = document.getElementById('userEmail');
                    const userNameEl = document.getElementById('userName');
                    if (userEmailEl) userEmailEl.textContent = user.email;
                    if (userNameEl) {
                        try {
                            const doc = await dbRef_().get();
                            userNameEl.textContent = (doc.exists && doc.data().username) ? doc.data().username : (user.displayName || 'User');
                        } catch (error) { userNameEl.textContent = 'User'; console.error("Error fetching username:", error); }
                    }
                    updateMarquees_();
                }
            });
            document.getElementById('logoutBtn')?.addEventListener('click', () => { firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
            document.getElementById('signOutLink')?.addEventListener('click', (e) => { e.preventDefault(); firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
            const sidebar_ = document.getElementById('sidebar');
            const toggleSidebarBtn_ = document.getElementById('toggleSidebar');
            if (toggleSidebarBtn_ && sidebar_) { toggleSidebarBtn_.addEventListener('click', () => { sidebar_.classList.toggle('collapsed'); setTimeout(updateMarquees_, 550); }); }
            function updateMarquees_() {
                marqueeEls_.forEach(el => {
                    if (!el || !el.parentElement) return;
                    const parent = el.parentElement; const overflow = el.scrollWidth > parent.clientWidth;
                    const shouldScroll = sidebar_.classList.contains('collapsed') || (overflow && !sidebar_.classList.contains('collapsed'));
                    el.classList.toggle('marquee-active', shouldScroll);
                    if (!overflow && !sidebar_.classList.contains('collapsed')) { el.classList.remove('marquee-active'); }
                });
            }
            window.addEventListener('resize', updateMarquees_);
        } catch (e) {
            console.warn("Firebase not configured. User authentication will be skipped.");
        }
    };

    // --- FULLY IMPLEMENTED SOUNDBOARD CLASS ---
    class SoundboardApp {
        constructor() {
            this.audioContext = null;
            this.nodes = {};
            this.activeSounds = new Map();
            this.soundCache = new Map();
            this.controls = {};
            this.eventListeners = [];
            this.animationFrameId = null;
            this.awarenessEngine = null;
            this.isMuted = false;
            this.lastVolumeBeforeMute = 1;
            this.volumeBeforeNightMode = 1;
        }

        init(options) {
            this.options = options;
            this.soundButtonsContainer = options.soundButtonsContainer;
            
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this._unlockAudioContext();

            this._setupAudioNodes();
            this._setupControls();
            this._renderSoundButtons();
            this._attachAllEventListeners();
            
            this.updateButtonVisuals = this.updateButtonVisuals.bind(this);
            this.animationFrameId = requestAnimationFrame(this.updateButtonVisuals);
        }

        destroy() {
            this.clearSounds();
            if (this.animationFrameId) {
                cancelAnimationFrame(this.animationFrameId);
            }
            this.eventListeners.forEach(({ element, type, handler }) => {
                element.removeEventListener(type, handler);
            });
            if (this.awarenessEngine) this.awarenessEngine.stop();
            if (this.audioContext && this.audioContext.state !== 'closed') {
                this.audioContext.close().catch(console.error);
            }
            this.soundButtonsContainer.innerHTML = '';
        }

        _addEventListener(element, type, handler) {
            const boundHandler = handler.bind(this);
            element.addEventListener(type, boundHandler);
            this.eventListeners.push({ element, type, handler: boundHandler });
        }
        
        _unlockAudioContext() {
            const unlock = () => {
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
                document.body.removeEventListener('click', unlock);
                document.body.removeEventListener('touchstart', unlock);
            };
            this._addEventListener(document.body, 'click', unlock);
            this._addEventListener(document.body, 'touchstart', unlock);
        }

        _setupAudioNodes() {
            this.masterGain = this.audioContext.createGain();
            this.nodes = {
                eqBass: new BiquadFilterNode(this.audioContext, { type: 'lowshelf', frequency: 100, gain: 0 }),
                bassWaveShaper: this.audioContext.createWaveShaper(),
                eqMid: new BiquadFilterNode(this.audioContext, { type: 'peaking', frequency: 1200, Q: 1.0, gain: 0 }),
                eqTreble: new BiquadFilterNode(this.audioContext, { type: 'highshelf', frequency: 6000, gain: 0 }),
                vintageWarmer: this.audioContext.createWaveShaper(),
                partyMode: { bass: new BiquadFilterNode(this.audioContext, { type: 'lowshelf', frequency: 120 }), comp: new DynamicsCompressorNode(this.audioContext, { threshold: -18, ratio: 8 }) },
                spatialInput: this.audioContext.createGain(),
                mainPanner: new PannerNode(this.audioContext, { panningModel: 'HRTF' }),
            };
            this.nodes.spatialInput.connect(this.nodes.mainPanner).connect(this.masterGain);
            this.masterGain.connect(this.nodes.partyMode.bass)
                .connect(this.nodes.eqBass)
                .connect(this.nodes.bassWaveShaper)
                .connect(this.nodes.eqMid)
                .connect(this.nodes.eqTreble)
                .connect(this.nodes.vintageWarmer)
                .connect(this.audioContext.destination);
                
            this.nodes.bassWaveShaper.curve = this._makeDistortionCurve(0);
            this.nodes.vintageWarmer.curve = this._makeVintageCurve(0);
        }

        _setupControls() {
            this.controls = Object.fromEntries(
                Array.from(document.querySelectorAll('#playlist-soundboard-view [data-setting]'))
                .map(el => [el.dataset.setting || el.value, el])
            );
        }

        _renderSoundButtons() {
            this.soundButtonsContainer.innerHTML = '';
            const soundsData = this.options.soundsData;
            if (Object.keys(soundsData).length === 0) {
                 this.soundButtonsContainer.innerHTML = '<p style="text-align:center; color: #777;">This playlist has no sounds.</p>';
                 return;
            }
            for (const categoryKey in soundsData) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'sound-category-v4';
                categoryDiv.innerHTML = `<h2>${categoryKey.replace(/([A-Z])/g, ' $1').trim()}</h2>`;
                const buttonsGrid = document.createElement('div');
                buttonsGrid.className = 'sound-buttons-grid-v4';
                soundsData[categoryKey].forEach(fileName => {
                    const button = document.createElement('button');
                    button.className = 'sound-button-v4';
                    button.textContent = fileName.replace(/\.mp3$/i, '').replace(/_/g, ' ');
                    button.dataset.soundFile = fileName;
                    this._addEventListener(button, 'click', () => this.playSound(fileName));
                    buttonsGrid.appendChild(button);
                });
                categoryDiv.appendChild(buttonsGrid);
                this.soundButtonsContainer.appendChild(categoryDiv);
            }
        }

        async playSound(fileName) {
            if (!this.controls.allowMultiple.checked) this.clearSounds();
            
            const onEnd = (soundInstance) => {
                const instances = this.activeSounds.get(fileName) || [];
                const filtered = instances.filter(s => s !== soundInstance);
                if (filtered.length > 0) this.activeSounds.set(fileName, filtered);
                else this.activeSounds.delete(fileName);
            };

            const sound = new Sound(fileName, onEnd, this);
            this.activeSounds.set(fileName, [...(this.activeSounds.get(fileName) || []), sound]);
            
            await sound.play({
                looping: this.controls.looping.checked,
                fadeTime: parseFloat(this.controls.fadeIn.value),
                speed: parseFloat(this.controls.speed.value),
                pitch: parseFloat(this.controls.pitch.value)
            });
        }

        clearSounds() {
            for (const [_, instances] of this.activeSounds.entries()) {
                [...instances].forEach(sound => sound.stop(parseFloat(this.controls.fadeOut.value)));
            }
        }

        updateButtonVisuals() {
            document.querySelectorAll('#playlist-soundboard-view .sound-button-v4[data-sound-file]').forEach(button => {
                const fileName = button.dataset.soundFile;
                const isPlaying = this.activeSounds.has(fileName);
                button.classList.toggle('playing', isPlaying);
            });
            this.animationFrameId = requestAnimationFrame(this.updateButtonVisuals);
        }
        
        _attachAllEventListeners() {
            // Settings Tabs
            this._addEventListener(document.querySelector('#playlist-soundboard-view .settings-tabs'), 'click', e => {
                if (e.target.matches('.tab-link')) {
                    document.querySelectorAll('#playlist-soundboard-view .tab-link, #playlist-soundboard-view .tab-content').forEach(el => el.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(e.target.dataset.tab).classList.add('active');
                }
            });

            // Sliders and Checkboxes
            Object.values(this.controls).forEach(el => {
                const eventType = (el.type === 'checkbox' || el.type === 'radio') ? 'change' : 'input';
                this._addEventListener(el, eventType, e => this._updateSetting(e.target.dataset.setting, e.target.type === 'checkbox' ? e.target.checked : e.target.value));
            });
            
            // Number inputs linked to sliders
            document.querySelectorAll('#playlist-soundboard-view .slider-value-input').forEach(numInput => {
                this._addEventListener(numInput, 'change', e => {
                    const slider = document.getElementById(e.target.dataset.sliderId);
                    if (slider) {
                        let value = parseFloat(e.target.value);
                        if (slider.id === 'masterVolume') value /= 100;
                        slider.value = value;
                        slider.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                });
            });

            // Bottom bar controls
            this._addEventListener(document.getElementById('clearSoundsBtn'), 'click', this.clearSounds);
            this._addEventListener(document.getElementById('soundSearchInput'), 'input', this._handleSoundSearch);
        }

        _updateSetting(key, value) {
            switch (key) {
                case 'masterVolume':
                    this.masterGain.gain.value = parseFloat(value);
                    document.getElementById('masterVolumeValue').textContent = `${Math.round(value * 100)}%`;
                    document.getElementById('masterVolumeInput').value = Math.round(value * 100);
                    break;
                case 'eqBass': this.nodes.eqBass.gain.value = parseFloat(value); document.getElementById('eqBassValue').textContent = `${value} dB`; break;
                case 'eqMid': this.nodes.eqMid.gain.value = parseFloat(value); document.getElementById('eqMidValue').textContent = `${value} dB`; break;
                case 'eqTreble': this.nodes.eqTreble.gain.value = parseFloat(value); document.getElementById('eqTrebleValue').textContent = `${value} dB`; break;
                case 'speed': this.activeSounds.forEach(instances => instances.forEach(s => s.sourceNode.playbackRate.value = parseFloat(value))); document.getElementById('speedValue').textContent = `${parseFloat(value).toFixed(2)}x`; break;
                case 'pitch': this.activeSounds.forEach(instances => instances.forEach(s => s.sourceNode.detune.value = parseFloat(value))); document.getElementById('pitchValue').textContent = value; break;
                case 'modeVintageWarmth': this.nodes.vintageWarmer.curve = this._makeVintageCurve(value ? 1.5 : 0); break;
                case 'modeParty': this.nodes.partyMode.bass.gain.setTargetAtTime(value ? 6 : 0, this.audioContext.currentTime, 0.02); break;
                case 'fadeIn': document.getElementById('fadeInValue').textContent = `${parseFloat(value).toFixed(1)}s`; break;
                case 'fadeOut': document.getElementById('fadeOutValue').textContent = `${parseFloat(value).toFixed(1)}s`; break;
            }
        }
        
        _handleSoundSearch(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            document.querySelectorAll('#playlistSoundCategoriesContainer .sound-button-v4').forEach(button => {
                const soundName = button.textContent.toLowerCase();
                button.classList.toggle('is-hidden', searchTerm && !soundName.includes(searchTerm));
            });
             document.querySelectorAll('#playlistSoundCategoriesContainer .sound-category-v4').forEach(category => {
                const hasVisibleButton = category.querySelector('.sound-button-v4:not(.is-hidden)');
                category.classList.toggle('is-hidden', !hasVisibleButton);
            });
        }
        
        _makeDistortionCurve(amount) { const k = typeof amount === 'number' ? amount : 50, n_samples = 44100, curve = new Float32Array(n_samples), deg = Math.PI / 180; for (let i = 0; i < n_samples; i++) { const x = i * 2 / n_samples - 1; curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x)); } return curve; }
        _makeVintageCurve(amount) { const n_samples = 44100, curve = new Float32Array(n_samples); if (amount === 0) { for (let i = 0; i < n_samples; i++) curve[i] = i * 2 / n_samples - 1; } else { for (let i = 0; i < n_samples; i++) { const x = i * 2 / n_samples - 1; curve[i] = Math.tanh(x * amount); } } return curve; }
    }

    class Sound {
        constructor(fileName, onEnd, app) {
            this.fileName = fileName;
            this.onEnd = onEnd;
            this.app = app; // Reference to the main SoundboardApp
            this.audioContext = app.audioContext;
            this.sourceNode = null;
            this.gainNode = this.audioContext.createGain();
            this.spatialOnGain = this.audioContext.createGain();
            this.spatialOffGain = this.audioContext.createGain();
            
            this.gainNode.connect(this.spatialOnGain).connect(this.app.nodes.spatialInput);
            this.gainNode.connect(this.spatialOffGain).connect(this.app.masterGain);
            
            this._toggleSpatial(this.app.controls.modeSpatial.checked);
        }

        _toggleSpatial(isOn) {
            const onValue = isOn ? 1.0 : 0.0;
            this.spatialOnGain.gain.setTargetAtTime(onValue, this.audioContext.currentTime, 0.05);
            this.spatialOffGain.gain.setTargetAtTime(1.0 - onValue, this.audioContext.currentTime, 0.05);
        }
        
        async load() {
            if (this.app.soundCache.has(this.fileName)) {
                return this.app.soundCache.get(this.fileName);
            }
            const response = await fetch(`../Sounds/${this.fileName}`);
            const arrayBuffer = await response.arrayBuffer();
            const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
            this.app.soundCache.set(this.fileName, audioBuffer);
            return audioBuffer;
        }

        async play(options) {
            const audioBuffer = await this.load();
            this.sourceNode = this.audioContext.createBufferSource();
            this.sourceNode.buffer = audioBuffer;
            this.sourceNode.loop = options.looping;
            this.sourceNode.detune.value = options.pitch;
            this.sourceNode.playbackRate.value = options.speed;
            this.sourceNode.connect(this.gainNode);
            
            this.gainNode.gain.setValueAtTime(0.0001, this.audioContext.currentTime).linearRampToValueAtTime(1, this.audioContext.currentTime + options.fadeTime);
            this.sourceNode.start(0);
            
            this.sourceNode.onended = () => { if (this.gainNode.gain.value > 0.0001) this.onEnd(this); };
        }

        stop(fadeTime) {
            if (!this.sourceNode) return;
            const stopTime = this.audioContext.currentTime + fadeTime;
            this.gainNode.gain.cancelScheduledValues(this.audioContext.currentTime);
            this.gainNode.gain.setTargetAtTime(0.0001, this.audioContext.currentTime, fadeTime / 4);
            try { this.sourceNode.stop(stopTime + 0.1); } catch (e) { /* Ignore */ }
        }
    }

    // --- Main Playlist Application Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        initStandardSetup(); // Run user auth and sidebar logic

        const PLAYLIST_STORAGE_KEY = 'userPlaylistsV2';
        let playlists = [];
        let allSoundsData = null;
        let editingPlaylistId = null;
        let soundboardApp = null; 

        const gridView = document.getElementById('playlist-grid-view');
        const soundboardView = document.getElementById('playlist-soundboard-view');
        const playlistsContainer = document.getElementById('playlists-container');
        const backToGridBtn = document.getElementById('back-to-grid-btn');
        const modal = document.getElementById('playlist-modal');

        const availableFeatures = { 'Playback': 'playback', 'Autoclicker': 'autoclicker', 'Audio Modes': 'modes', 'Equalizer': 'equalizer', 'Effects': 'effects' };

        function loadPlaylistsFromStorage() { playlists = JSON.parse(localStorage.getItem(PLAYLIST_STORAGE_KEY) || '[]'); }
        function savePlaylistsToStorage() { localStorage.setItem(PLAYLIST_STORAGE_KEY, JSON.stringify(playlists)); }
        async function fetchAllSounds() { if (allSoundsData) return allSoundsData; try { const r = await fetch('../SoundboardNames.json'); allSoundsData = await r.json(); return allSoundsData; } catch (e) { return {}; } }

        function renderPlaylistGrid() {
            playlistsContainer.innerHTML = '';
            const addCard = document.createElement('div');
            addCard.className = 'add-playlist-card';
            addCard.innerHTML = `<div class="add-playlist-card-plus">+</div><div>Create Playlist</div>`;
            addCard.addEventListener('click', () => openModal());
            playlistsContainer.appendChild(addCard);

            if (playlists.length > 0) {
                playlists.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'playlist-card';
                    card.dataset.playlistId = p.id;
                    card.style.borderLeftColor = p.color;
                    card.innerHTML = `<h3></h3><p></p><div class="playlist-card-actions"><button class="playlist-action-btn edit-btn" title="Edit">✏️</button><button class="playlist-action-btn delete-btn" title="Delete">🗑️</button></div>`;
                    card.querySelector('h3').textContent = p.name;
                    card.querySelector('p').textContent = p.description;
                    playlistsContainer.appendChild(card);
                });
            }
        }

        function switchView(viewToShow) {
            [gridView, soundboardView].forEach(v => v.style.display = 'none');
            viewToShow.style.display = 'block';
            viewToShow.style.opacity = '0';
            setTimeout(() => viewToShow.style.opacity = '1', 10);
            document.getElementById('bottom-fixed-bar').classList.toggle('is-hidden', viewToShow !== soundboardView);
        }

        async function showPlaylistSoundboardView(playlistId) {
            const playlist = playlists.find(p => p.id === playlistId);
            if (!playlist) return;

            switchView(soundboardView);
            document.getElementById('playlist-soundboard-title').textContent = playlist.name;
            
            Object.entries(availableFeatures).forEach(([_, tabId]) => {
                const isEnabled = playlist.enabledFeatures[tabId];
                soundboardView.querySelector(`.tab-link[data-tab="${tabId}"]`).style.display = isEnabled ? '' : 'none';
                if(document.getElementById(tabId)) document.getElementById(tabId).classList.remove('active');
            });
            const firstVisibleTab = soundboardView.querySelector('.tab-link:not([style*="display: none"])');
            if (firstVisibleTab) {
                firstVisibleTab.classList.add('active');
                if (document.getElementById(firstVisibleTab.dataset.tab)) document.getElementById(firstVisibleTab.dataset.tab).classList.add('active');
            }

            const allSounds = await fetchAllSounds();
            const playlistSoundData = {};
            for (const category in allSounds) {
                const soundsInCategory = allSounds[category].filter(sf => playlist.sounds.includes(sf));
                if (soundsInCategory.length > 0) playlistSoundData[category] = soundsInCategory;
            }
            
            soundboardApp = new SoundboardApp();
            soundboardApp.init({
                soundsData: playlistSoundData,
                soundButtonsContainer: document.getElementById('playlistSoundCategoriesContainer'),
                settings: playlist.enabledFeatures
            });
        }
        
        backToGridBtn.addEventListener('click', () => {
            if (soundboardApp) soundboardApp.destroy();
            soundboardApp = null;
            switchView(gridView);
        });

        function setupModal() {
            const colorPalette = ['#6720bd', '#8a2be2', '#4169e1', '#00ced1', '#3cb371', '#ff8c00', '#ff4500', '#e91e63', '#9c27b0', '#795548'];
            const colorContainer = document.getElementById('playlist-color-palette');
            colorContainer.innerHTML = colorPalette.map(c => `<div class="color-choice" data-color="${c}" style="background-color:${c};"></div>`).join('');
            colorContainer.addEventListener('click', e => { if (e.target.classList.contains('color-choice')) { colorContainer.querySelectorAll('.selected').forEach(el => el.classList.remove('selected')); e.target.classList.add('selected'); } });
            document.getElementById('feature-checkbox-group').innerHTML = Object.entries(availableFeatures).map(([name, id]) => `<label class="feature-checkbox-label"><input type="checkbox" data-feature-id="${id}" checked><span>${name}</span></label>`).join('');
        }

        async function openModal(playlistId = null) {
            editingPlaylistId = playlistId;
            const soundsData = await fetchAllSounds();
            document.getElementById('modal-sounds-container').innerHTML = Object.values(soundsData).flat().map(file => `<button class="modal-sound-button" data-sound-file="${file}">${file.replace('.mp3','').replace(/_/g,' ')}</button>`).join('');
            
            if (playlistId) {
                const p = playlists.find(p => p.id === playlistId);
                document.getElementById('modal-title').textContent = 'Edit Playlist';
                document.getElementById('playlist-name').value = p.name;
                document.getElementById('playlist-desc').value = p.description;
                document.querySelector(`.color-choice[data-color="${p.color}"]`)?.classList.add('selected');
                p.sounds.forEach(sf => document.querySelector(`.modal-sound-button[data-sound-file="${sf}"]`)?.classList.add('selected'));
                Object.entries(p.enabledFeatures).forEach(([id, enabled]) => { if (document.querySelector(`input[data-feature-id="${id}"]`)) document.querySelector(`input[data-feature-id="${id}"]`).checked = enabled; });
            } else {
                document.getElementById('modal-title').textContent = 'Create a New Playlist';
                document.getElementById('playlist-name').value = '';
                document.getElementById('playlist-desc').value = '';
                document.querySelector('.color-choice').classList.add('selected');
                document.querySelectorAll('input[data-feature-id]').forEach(cb => cb.checked = true);
            }
            modal.classList.add('visible');
        }

        function handleSavePlaylist() {
            const name = document.getElementById('playlist-name').value.trim();
            if (!name) return alert("Please provide a name for the playlist.");
            const enabledFeatures = {};
            document.querySelectorAll('input[data-feature-id]').forEach(cb => enabledFeatures[cb.dataset.featureId] = cb.checked);
            const newPlaylistData = { name, description: document.getElementById('playlist-desc').value.trim(), color: document.querySelector('.color-choice.selected').dataset.color, sounds: Array.from(document.querySelectorAll('.modal-sound-button.selected')).map(n => n.dataset.soundFile), enabledFeatures };
            if (editingPlaylistId) {
                const index = playlists.findIndex(p => p.id === editingPlaylistId);
                playlists[index] = { ...playlists[index], ...newPlaylistData };
            } else {
                const newId = `p_${Date.now()}`;
                playlists.push({ id: newId, ...newPlaylistData });
                editingPlaylistId = newId; // To highlight the new card
            }
            savePlaylistsToStorage();
            renderPlaylistGrid();
            const newCard = document.querySelector(`.playlist-card[data-playlist-id="${editingPlaylistId}"]`);
            if (newCard) newCard.classList.add('fade-in');
            closeModal();
        }

        function closeModal() { modal.classList.remove('visible'); editingPlaylistId = null; }

        document.getElementById('modal-save-btn').addEventListener('click', handleSavePlaylist);
        document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
        modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
        playlistsContainer.addEventListener('click', e => {
            const card = e.target.closest('.playlist-card');
            if (!card) return;
            const playlistId = card.dataset.playlistId;
            if (e.target.closest('.edit-btn')) openModal(playlistId);
            else if (e.target.closest('.delete-btn')) {
                if (confirm("Are you sure you want to delete this playlist?")) {
                    card.classList.add('fade-out');
                    card.addEventListener('animationend', () => {
                        playlists = playlists.filter(p => p.id !== playlistId);
                        savePlaylistsToStorage();
                        renderPlaylistGrid();
                    }, { once: true });
                }
            } else showPlaylistSoundboardView(playlistId);
        });

        setupModal();
        loadPlaylistsFromStorage();
        renderPlaylistGrid();
    });
    </script>
</body>
</html>
