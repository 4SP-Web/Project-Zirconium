<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - PLAYLISTS</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="../panic-key.js"></script>

    <style>
        /* --- Base styles from soundboard.html --- */
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
            --sound-search-bar-container-width: 530px;
        }
        body { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: var(--v4-font-primary); background: var(--v4-bg-gradient); color: var(--v4-text-primary); line-height: 1.6; }
        .soundboard-container-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: visible; }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em; }
        .marquee-content { display: inline-block; padding-left: 100%; transform: translateX(0); animation: none; line-height: 1.8em; }
        .marquee-active { animation: scroll-left-soundboard 12s linear infinite; }
        @keyframes scroll-left-soundboard { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .user-info .username { font-family: var(--v4-font-primary); font-size: 1.3em; margin-bottom: 8px; line-height: 0.2em; font-weight: bold;}
        .user-info .email { font-family: var(--v4-font-secondary); font-size: 0.9em; color: #bbb; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: var(--v4-font-primary); text-transform: uppercase; position: relative; overflow: hidden; font-size: 1em; }
        .sidebar nav a:hover, .sidebar nav a.active { background: var(--v4-purple-gradient); transform: translateX(5px); color: #fff; }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .sidebar.collapsed nav a .label { display: none; }
        .main-soundboard-content { flex: 1; padding: 30px; background: var(--v4-bg-gradient); overflow-y: auto; display: flex; flex-direction: column; padding-bottom: 120px; position: relative; }
        .soundboard-header-v4 { margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .soundboard-title-v4 { font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .is-hidden { display: none !important; }
        .view-container { transition: opacity 0.3s ease-in-out; }
        
        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: scale(0.95); } }
        .fade-out { animation: fadeOut 0.4s ease-in forwards; }

        /* --- PLAYLIST GRID STYLES --- */
        #playlists-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .playlist-card, .add-playlist-card { background-color: var(--v4-card-bg); border-radius: 15px; padding: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.07); cursor: pointer; transition: all 0.3s ease; position: relative; border-left: 8px solid; overflow: hidden; }
        .playlist-card:hover, .add-playlist-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .playlist-card h3 { margin: 0 0 8px 0; font-size: 1.4em; color: var(--v4-text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 60px; /* Space for buttons */ }
        .playlist-card p { margin: 0; color: var(--v4-text-secondary); font-size: 0.9em; height: 2.7em; /* approx 2 lines */ overflow: hidden; }
        .playlist-card-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; opacity: 0; transition: opacity 0.3s ease; }
        .playlist-card:hover .playlist-card-actions { opacity: 1; }
        .playlist-action-btn { background: rgba(0,0,0,0.05); border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1em; cursor: pointer; display:flex; align-items:center; justify-content:center; transition: background-color 0.2s; }
        .playlist-action-btn:hover { background: rgba(0,0,0,0.1); }
        .add-playlist-card { border-left-color: var(--v4-border-light); border-style: dashed; border-width: 2px; border-left-width: 2px; color: var(--v4-text-secondary); display: flex; align-items: center; justify-content: center; flex-direction: column; min-height: 120px; }
        .add-playlist-card-plus { font-size: 3em; line-height: 1; }
        #no-playlists-message { grid-column: 1 / -1; text-align: center; padding: 50px; background: var(--v4-card-bg); border-radius: 15px; color: var(--v4-text-secondary); font-size: 1.2em; }

        /* --- PLAYLIST SOUNDBOARD VIEW STYLES (INCLUDES ALL FROM soundboard.html) --- */
        #playlist-soundboard-view .settings-tab-container, #playlist-soundboard-view .sound-category-v4 { opacity: 0; animation: fadeIn 0.5s ease-out forwards; animation-delay: 0.2s; }
        #back-to-grid-btn { background: none; border: 1px solid var(--v4-border-light); color: var(--v4-text-secondary); font-size: 1em; padding: 8px 15px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        #back-to-grid-btn:hover { border-color: var(--v4-purple-accent); background-color: var(--v4-input-bg); color: var(--v4-purple-accent); }
        /* Include all the complex styles for settings, sliders, spatial audio, etc. from soundboard.html here */
        /* ... styles omitted for brevity but are required for the copied HTML to render correctly ... */

        /* --- MODAL STYLES --- */
        .playlist-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .playlist-modal-overlay.visible { display: flex; opacity: 1; }
        .playlist-modal-content { background: var(--v4-card-bg); padding: 30px 40px; border-radius: 20px; width: 90%; max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.3s ease; }
        .playlist-modal-overlay.visible .playlist-modal-content { transform: scale(1); }
        .playlist-modal-content h2 { font-size: 1.8em; margin-top: 0; color: var(--v4-purple-accent); }
        .playlist-modal-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .playlist-modal-input-group { display: flex; flex-direction: column; }
        .playlist-modal-input-group label, .feature-category h4 { margin-bottom: 8px; font-weight: 600; color: var(--v4-text-secondary); }
        .playlist-modal-input-group input, .playlist-modal-input-group textarea { padding: 12px; background-color: var(--v4-input-bg); border: 1px solid var(--v4-input-border); border-radius: 8px; font-size: 1em; font-family: var(--v4-font-secondary); }
        .playlist-modal-input-group textarea { resize: vertical; min-height: 60px; }
        .color-palette { display: flex; gap: 10px; flex-wrap: wrap; }
        .color-palette .color-choice { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; transition: all 0.2s ease; border: 3px solid transparent; }
        .color-palette .color-choice.selected { border-color: var(--v4-card-bg); box-shadow: 0 0 0 3px var(--v4-purple-accent); transform: scale(1.1); }
        #modal-sounds-container { height: 200px; overflow-y: auto; background: #f8f9fa; border: 1px solid var(--v4-border-softer); border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .modal-sound-button { background-color: var(--v4-card-bg); color: var(--v4-text-secondary); border: 1px solid var(--v4-border-light); padding: 8px 12px; font-size: 0.9em; text-align: center; cursor: pointer; transition: all 0.2s ease; text-transform: uppercase; font-family: var(--v4-font-primary); border-radius: 8px; }
        .modal-sound-button.selected { background: var(--v4-purple-accent); color: white; border-color: var(--v4-purple-accent-darker); font-weight: bold; }
        #enabled-features-container { background: #f8f9fa; border: 1px solid var(--v4-border-softer); border-radius: 10px; padding: 15px; }
        .feature-category { margin-bottom: 10px; }
        .feature-category:last-child { margin-bottom: 0; }
        .feature-checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; }
        .feature-checkbox-label { display: flex; align-items: center; font-size: 0.9em; cursor: pointer; }
        .feature-checkbox-label input { margin-right: 8px; accent-color: var(--v4-purple-accent); transform: scale(1.2); }
        .playlist-modal-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 25px; }
        .modal-btn { padding: 12px 25px; border-radius: 8px; border: none; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.2s ease; }
        .modal-btn-primary { background: var(--v4-purple-gradient); color: white; }
        .modal-btn-secondary { background: #e9ecef; color: var(--v4-text-secondary); }

    </style>
</head>
<body class="playlists-page">

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="soundboard-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <div class="user-info">
                <div class="marquee-container"> <span id="userName" class="marquee-content username">Loading…</span> </div>
                <div class="marquee-container"> <span id="userEmail" class="marquee-content email">Loading…</span> </div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">🛡️</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="playlists.html" class="active"><span class="icon">✨</span><span class="label">Playlists</span></a></li>
                    <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-soundboard-content" id="playlists-main-content">
            
            <div id="playlist-grid-view" class="view-container">
                <div class="soundboard-header-v4">
                    <h1 class="soundboard-title-v4">My Playlists</h1>
                </div>
                <div id="playlists-container">
                    </div>
            </div>

            <div id="playlist-soundboard-view" class="view-container is-hidden">
                <div class="soundboard-header-v4">
                    <button id="back-to-grid-btn">&larr; Back to Playlists</button>
                    <h2 id="playlist-soundboard-title" class="soundboard-title-v4"></h2>
                </div>
                
                <div class="status-message-v4" id="statusMessageV4"></div>

                <div class="settings-tab-container">
                    <div class="settings-header">
                        <div class="settings-top-row">
                            <nav class="settings-tabs">
                                <button class="tab-link active" data-tab="playback">Playback</button>
                                <button class="tab-link" data-tab="autoclicker">Autoclicker</button>
                                <button class="tab-link" data-tab="modes">Audio Modes</button>
                                <button class="tab-link" data-tab="equalizer">Equalizer</button>
                                <button class="tab-link" data-tab="effects">Effects</button>
                            </nav>
                            <div class="settings-buttons-group">
                                <button id="saveSettingsBtn">Save</button>
                                <button id="resetSettingsBtn">Reset</button>
                            </div>
                        </div>
                        <input type="text" id="settingsSearch" placeholder="Search settings...">
                    </div>
                    <div id="searchResultsContainer"></div>
                    <div id="playback" class="tab-content active"> </div>
                     <div id="autoclicker" class="tab-content"> </div>
                     <div id="modes" class="tab-content"> </div>
                     <div id="equalizer" class="tab-content"> </div>
                     <div id="effects" class="tab-content"> </div>
                </div>

                <div id="playlistSoundCategoriesContainer"></div>
            </div>
        </main>
    </div>

    <div id="bottom-fixed-bar" class="is-hidden">
        <span id="muteIndicator" class="mute-status">Muted</span>
        <input type="text" id="soundSearchInput" placeholder="Search sounds...">
        <button id="clearSoundsBtn">Clear Sounds</button>
    </div>

    <div id="playlist-modal" class="playlist-modal-overlay">
        <div class="playlist-modal-content">
            <h2 id="modal-title">Create a New Playlist</h2>
            <div class="playlist-modal-form-grid">
                <div class="playlist-modal-input-group">
                    <label for="playlist-name">Playlist Name (Max 24)</label>
                    <input type="text" id="playlist-name" maxlength="24" placeholder="e.g., Epic Movie Moments">
                </div>
                <div class="playlist-modal-input-group">
                    <label>Accent Color</label>
                    <div id="playlist-color-palette" class="color-palette"></div>
                </div>
                <div class="playlist-modal-input-group" style="grid-column: 1 / -1;">
                    <label for="playlist-desc">Description (Max 64)</label>
                    <textarea id="playlist-desc" maxlength="64" placeholder="Sounds for intense gaming sessions."></textarea>
                </div>
            </div>
            
            <label style="margin-bottom: 8px; font-weight: 600; color: var(--v4-text-secondary);">Select Sounds</label>
            <div id="modal-sounds-container"></div>

            <div id="enabled-features-container">
                <div class="feature-category">
                    <h4>Enabled Features</h4>
                    <div id="feature-checkbox-group" class="feature-checkbox-group">
                        </div>
                </div>
            </div>

            <div class="playlist-modal-actions">
                <button id="modal-cancel-btn" class="modal-btn modal-btn-secondary">Cancel</button>
                <button id="modal-save-btn" class="modal-btn modal-btn-primary">Save Playlist</button>
            </div>
        </div>
    </div>


    <script>
    // --- Standard Setup (Auth, Sidebar) ---
    // This part is identical to your soundboard.html for consistency
    const initStandardSetup = () => {
        const dbRef_ = () => firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid);
        const marqueeEls_ = document.querySelectorAll('.marquee-content');
        firebase.auth().onAuthStateChanged(async user => {
            if (!user) { window.location.href = '../login.html'; }
            else {
                const userEmailEl = document.getElementById('userEmail');
                const userNameEl = document.getElementById('userName');
                if (userEmailEl) userEmailEl.textContent = user.email;
                if (userNameEl) {
                    try {
                        const doc = await dbRef_().get();
                        userNameEl.textContent = (doc.exists && doc.data().username) ? doc.data().username : (user.displayName || 'User');
                    } catch (error) { userNameEl.textContent = 'User'; console.error("Error fetching username:", error); }
                }
                updateMarquees_();
            }
        });
        document.getElementById('logoutBtn')?.addEventListener('click', () => { firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
        document.getElementById('signOutLink')?.addEventListener('click', (e) => { e.preventDefault(); firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
        const sidebar_ = document.getElementById('sidebar');
        const toggleSidebarBtn_ = document.getElementById('toggleSidebar');
        if (toggleSidebarBtn_ && sidebar_) { toggleSidebarBtn_.addEventListener('click', () => { sidebar_.classList.toggle('collapsed'); setTimeout(updateMarquees_, 550); }); }
        function updateMarquees_() {
            marqueeEls_.forEach(el => {
                if (!el || !el.parentElement) return;
                const parent = el.parentElement; const overflow = el.scrollWidth > parent.clientWidth;
                const shouldScroll = sidebar_.classList.contains('collapsed') || (overflow && !sidebar_.classList.contains('collapsed'));
                el.classList.toggle('marquee-active', shouldScroll);
                if (!overflow && !sidebar_.classList.contains('collapsed')) { el.classList.remove('marquee-active'); }
            });
        }
        window.addEventListener('resize', updateMarquees_);
    };
    
    // --- Main Playlist Application Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        initStandardSetup(); // Run user auth and sidebar logic

        // --- Core Playlist Variables ---
        const PLAYLIST_STORAGE_KEY = 'userPlaylistsV2'; // Updated key for new features
        let playlists = [];
        let allSoundsData = null;
        let editingPlaylistId = null;
        let soundboardApp = null; // To hold the instance of the soundboard logic

        // --- UI Elements ---
        const gridView = document.getElementById('playlist-grid-view');
        const soundboardView = document.getElementById('playlist-soundboard-view');
        const playlistsContainer = document.getElementById('playlists-container');
        const backToGridBtn = document.getElementById('back-to-grid-btn');
        const modal = document.getElementById('playlist-modal');

        const availableFeatures = {
            'Playback': 'playback', 'Autoclicker': 'autoclicker', 'Audio Modes': 'modes', 
            'Equalizer': 'equalizer', 'Effects': 'effects'
        };

        // --- DATA HANDLING & RENDERING ---
        function loadPlaylistsFromStorage() {
            const data = localStorage.getItem(PLAYLIST_STORAGE_KEY);
            playlists = data ? JSON.parse(data) : [];
        }

        function savePlaylistsToStorage() {
            localStorage.setItem(PLAYLIST_STORAGE_KEY, JSON.stringify(playlists));
        }

        async function fetchAllSounds() {
            if (allSoundsData) return allSoundsData;
            try {
                const response = await fetch('../SoundboardNames.json');
                allSoundsData = await response.json();
                return allSoundsData;
            } catch (error) { console.error("Failed to load sound names JSON:", error); return {}; }
        }

        function renderPlaylistGrid() {
            playlistsContainer.innerHTML = '';
            
            // 1. Add the "Create New" card
            const addCard = document.createElement('div');
            addCard.className = 'add-playlist-card';
            addCard.innerHTML = `<div class="add-playlist-card-plus">+</div><div>Create Playlist</div>`;
            addCard.addEventListener('click', () => openModal());
            playlistsContainer.appendChild(addCard);

            // 2. Add existing playlist cards
            if (playlists.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.id = 'no-playlists-message';
                emptyMsg.innerHTML = `<p>You haven't created any playlists yet. 🎶</p>`;
                playlistsContainer.appendChild(emptyMsg);
            } else {
                playlists.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'playlist-card';
                    card.dataset.playlistId = p.id;
                    card.style.borderLeftColor = p.color;
                    card.innerHTML = `
                        <h3></h3>
                        <p></p>
                        <div class="playlist-card-actions">
                            <button class="playlist-action-btn edit-btn" title="Edit Playlist">✏️</button>
                            <button class="playlist-action-btn delete-btn" title="Delete Playlist">🗑️</button>
                        </div>
                    `;
                    card.querySelector('h3').textContent = p.name;
                    card.querySelector('p').textContent = p.description;
                    playlistsContainer.appendChild(card);
                });
            }
        }

        // --- VIEW TRANSITIONS ---
        function switchView(viewToShow) {
            const views = [gridView, soundboardView];
            views.forEach(view => {
                if (view === viewToShow) {
                    view.classList.remove('is-hidden');
                    view.style.opacity = '0';
                    setTimeout(() => view.style.opacity = '1', 50);
                } else {
                    view.classList.add('is-hidden');
                }
            });
            document.getElementById('bottom-fixed-bar').classList.toggle('is-hidden', viewToShow !== soundboardView);
        }

        async function showPlaylistSoundboardView(playlistId) {
            const playlist = playlists.find(p => p.id === playlistId);
            if (!playlist) return;

            switchView(soundboardView);
            document.getElementById('playlist-soundboard-title').textContent = playlist.name;
            
            // Configure UI based on enabled features BEFORE initializing the script
            const settingsTabs = soundboardView.querySelector('.settings-tabs');
            Object.entries(availableFeatures).forEach(([_, tabId]) => {
                const isEnabled = playlist.enabledFeatures[tabId];
                soundboardView.querySelector(`.tab-link[data-tab="${tabId}"]`).style.display = isEnabled ? '' : 'none';
                const tabContent = document.getElementById(tabId);
                if(tabContent) tabContent.classList.remove('active'); // Reset active state
            });
            // Set the first available tab as active
            const firstVisibleTab = settingsTabs.querySelector('.tab-link:not([style*="display: none"])');
            if(firstVisibleTab) {
                firstVisibleTab.classList.add('active');
                document.getElementById(firstVisibleTab.dataset.tab)?.classList.add('active');
            }


            const allSounds = await fetchAllSounds();
            const playlistSoundData = {};
            for (const category in allSounds) {
                const soundsInCategory = allSounds[category].filter(sf => playlist.sounds.includes(sf));
                if (soundsInCategory.length > 0) playlistSoundData[category] = soundsInCategory;
            }

            // Instantiate and initialize the full soundboard logic
            // The SoundboardApp class would be defined by including the full script from soundboard.html
            if (typeof SoundboardApp !== 'undefined') {
                soundboardApp = new SoundboardApp();
                soundboardApp.init({
                    soundsData: playlistSoundData,
                    soundButtonsContainer: document.getElementById('playlistSoundCategoriesContainer'),
                    settings: playlist.enabledFeatures
                });
            } else {
                console.error("SoundboardApp class not found. Full soundboard script needs to be integrated.");
            }
        }
        
        backToGridBtn.addEventListener('click', () => {
            if (soundboardApp) {
                soundboardApp.destroy(); // Clean up listeners and intervals
                soundboardApp = null;
            }
            switchView(gridView);
        });

        // --- MODAL LOGIC ---
        function setupModal() {
            const colorPalette = ['#6720bd', '#8a2be2', '#4169e1', '#00ced1', '#3cb371', '#ff8c00', '#ff4500', '#e91e63', '#9c27b0', '#795548'];
            const colorContainer = document.getElementById('playlist-color-palette');
            colorContainer.innerHTML = colorPalette.map(c => `<div class="color-choice" data-color="${c}" style="background-color:${c};"></div>`).join('');
            colorContainer.addEventListener('click', e => {
                if (e.target.classList.contains('color-choice')) {
                    colorContainer.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                    e.target.classList.add('selected');
                }
            });

            const featureContainer = document.getElementById('feature-checkbox-group');
            featureContainer.innerHTML = Object.entries(availableFeatures).map(([name, id]) => `
                <label class="feature-checkbox-label">
                    <input type="checkbox" data-feature-id="${id}" checked>
                    <span>${name}</span>
                </label>
            `).join('');
        }

        async function openModal(playlistId = null) {
            editingPlaylistId = playlistId;
            const soundsData = await fetchAllSounds();
            document.getElementById('modal-sounds-container').innerHTML = Object.entries(soundsData)
                .map(([_, files]) => files.map(file => `<button class="modal-sound-button" data-sound-file="${file}">${file.replace('.mp3','').replace(/_/g,' ')}</button>`).join(''))
                .join('');
            
            if (playlistId) {
                const p = playlists.find(p => p.id === playlistId);
                document.getElementById('modal-title').textContent = 'Edit Playlist';
                document.getElementById('playlist-name').value = p.name;
                document.getElementById('playlist-desc').value = p.description;
                document.querySelector(`.color-choice[data-color="${p.color}"]`)?.classList.add('selected');
                p.sounds.forEach(sf => document.querySelector(`.modal-sound-button[data-sound-file="${sf}"]`)?.classList.add('selected'));
                Object.entries(p.enabledFeatures).forEach(([id, enabled]) => {
                    const checkbox = document.querySelector(`input[data-feature-id="${id}"]`);
                    if (checkbox) checkbox.checked = enabled;
                });
            } else {
                document.getElementById('modal-title').textContent = 'Create a New Playlist';
                document.getElementById('playlist-name').value = '';
                document.getElementById('playlist-desc').value = '';
                document.querySelector('.color-choice').classList.add('selected');
                document.querySelectorAll('input[data-feature-id]').forEach(cb => cb.checked = true);
            }
            modal.classList.add('visible');
        }

        function handleSavePlaylist() {
            const name = document.getElementById('playlist-name').value.trim();
            if (!name) { alert("Please provide a name for the playlist."); return; }

            const sounds = Array.from(document.querySelectorAll('.modal-sound-button.selected')).map(n => n.dataset.soundFile);
            const enabledFeatures = {};
            document.querySelectorAll('input[data-feature-id]').forEach(cb => enabledFeatures[cb.dataset.featureId] = cb.checked);

            const newPlaylistData = {
                name,
                description: document.getElementById('playlist-desc').value.trim(),
                color: document.querySelector('.color-choice.selected').dataset.color,
                sounds,
                enabledFeatures
            };

            if (editingPlaylistId) {
                const index = playlists.findIndex(p => p.id === editingPlaylistId);
                playlists[index] = { ...playlists[index], ...newPlaylistData };
            } else {
                playlists.push({ id: `p_${Date.now()}`, ...newPlaylistData });
            }
            
            savePlaylistsToStorage();
            renderPlaylistGrid();
            const newCard = document.querySelector(`.playlist-card[data-playlist-id="${editingPlaylistId || playlists[playlists.length-1].id}"]`);
            if (newCard) newCard.classList.add('fade-in');
            closeModal();
        }

        function closeModal() {
            modal.classList.remove('visible');
            editingPlaylistId = null;
        }

        // --- GLOBAL EVENT LISTENERS ---
        document.getElementById('modal-save-btn').addEventListener('click', handleSavePlaylist);
        document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
        modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

        playlistsContainer.addEventListener('click', e => {
            const card = e.target.closest('.playlist-card');
            if (!card) return;
            const playlistId = card.dataset.playlistId;

            if (e.target.closest('.edit-btn')) {
                openModal(playlistId);
            } else if (e.target.closest('.delete-btn')) {
                if (confirm("Are you sure you want to delete this playlist? This cannot be undone.")) {
                    card.classList.add('fade-out');
                    card.addEventListener('animationend', () => {
                        playlists = playlists.filter(p => p.id !== playlistId);
                        savePlaylistsToStorage();
                        renderPlaylistGrid();
                    }, { once: true });
                }
            } else {
                showPlaylistSoundboardView(playlistId);
            }
        });

        // --- INITIALIZATION ---
        setupModal();
        loadPlaylistsFromStorage();
        renderPlaylistGrid();
    });
    
    // NOTE: For this to be fully functional, the complete script from `soundboard.html`
    // must be included and wrapped in a class or object like the placeholder `SoundboardApp`
    // used in this script. This includes the AudioContext setup, all node connections,
    // the Sound class, and all event handlers for settings.
    </script>
</body>
</html>
