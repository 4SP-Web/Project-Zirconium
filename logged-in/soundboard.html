<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - SOUNDBOARD</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="../ban-enforcer.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js"></script>

    <style>
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
            --sound-search-bar-container-width: 530px;
        }
        body {
            display: flex; flex-direction: column; min-height: 100vh;
            margin: 0; font-family: var(--v4-font-primary);
            background: var(--v4-bg-gradient); color: var(--v4-text-primary);
            line-height: 1.6;
            user-select: none;
            -webkit-user-select: none;
        }
        input[type="text"], input[type="number"], textarea {
            user-select: text;
            -webkit-user-select: text;
        }
        .soundboard-container-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; position: relative; overflow: hidden; }
        .sidebar nav a::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); transition: left 0.5s; }
        .sidebar nav a:hover::before { left: 100%; }
        .sidebar nav a.active, .sidebar nav a:hover { background: var(--v4-purple-gradient); transform: translateX(5px); }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; opacity: 1; visibility: visible; transition: opacity 0.2s ease-in-out; transition-delay: 0.4s; }
        .sidebar.collapsed nav a .label { opacity: 0; visibility: hidden; transition-delay: 0s; }
        .main-soundboard-content { flex: 1; padding: 30px; background: var(--v4-bg-gradient); overflow-y: auto; display: flex; flex-direction: column; padding-bottom: 120px; }
        .soundboard-header-v4 { margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .soundboard-title-v4 { font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .settings-action-btn { background: rgba(103, 32, 189, 0.08); border: none; cursor: pointer; padding: 8px; line-height: 1; display: inline-flex; align-items: center; justify-content: center; border-radius: 12px; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .settings-action-btn:hover { background-color: rgba(103, 32, 189, 0.15); transform: translateY(-2px); }
        .settings-action-btn img { width: 22px; height: 22px; display: block; filter: invert(0.3) brightness(100%); }
        #settingsSearch { width: 100%; padding: 10px 15px; margin: 10px 0; border-radius: 12px; border: 1px solid var(--v4-border-light); font-family: var(--v4-font-primary); font-size: 1em; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
        #settingsSearch:focus { border-color: var(--v4-purple-accent); box-shadow: 0 0 0 2px rgba(103, 32, 189, 0.2); }
        .tab-panel { flex-shrink: 0; width: 100%; box-sizing: border-box; display: grid; gap: 12px 18px; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
        .control-group { position: relative; display: flex; flex-direction: column; transition: opacity 0.3s ease; border-radius: 8px; }
        .control-group label, .checkbox-label-v4 { font-weight: 600; font-size: 0.95em; color: var(--v4-text-secondary); margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; }
        .slider-input-container { display: flex; align-items: center; gap: 12px; }
        .control-group input[type="range"] { -webkit-appearance: none; appearance: none; flex-grow: 1; height: 8px; background: var(--v4-border-light); outline: none; border-radius: 5px; }
        .control-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--v4-purple-accent); cursor: pointer; border-radius: 50%; }
        .control-group input[type="number"], .control-group select { padding: 8px; background-color: var(--v4-input-bg); border: 1px solid var(--v4-input-border); border-radius: 6px; color: var(--v4-text-primary); font-family: var(--v4-font-primary); font-size: 0.9em; outline: none; box-sizing: border-box; }
        input.slider-value-input { width: 70px; text-align: center; }
        .checkbox-label-v4 { padding: 4px 0; flex-wrap: wrap; }
        .control-group input[type="checkbox"] { margin-left: 12px; transform: scale(1.1); accent-color: var(--v4-purple-accent); }
        .radio-group-container { display: flex; flex-wrap: wrap; gap: 4px 12px; background-color: var(--v4-input-bg); padding: 6px 8px; border-radius: 8px; border: 1px solid var(--v4-input-border); }
        .radio-label { display: flex; align-items: center; cursor: pointer; font-size: 0.95em; }
        .radio-label input[type="radio"] { margin-right: 6px; accent-color: var(--v4-purple-accent); transform: scale(1.1); }
        .mode-description { display: block; width: 100%; font-size: 0.85em; color: #777; margin-top: -5px; margin-bottom: 5px; padding-left: 2px; font-style: italic; }
        .sound-category-v4 { margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); }
        .sound-category-v4 h2 { font-size: 1.5em; color: var(--v4-text-primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--v4-border-softer); text-transform: uppercase; }
        .sound-buttons-grid-v4 { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .sound-button-v4 { background-color: var(--v4-input-bg); color: var(--v4-text-secondary); border: 1px solid var(--v4-input-border); padding: 8px 12px; font-size: 1em; text-align: center; cursor: pointer; transition: all 0.2s ease; text-transform: uppercase; font-family: var(--v4-font-primary); border-radius: 12px; }
        .sound-button-v4:hover { background-color: #e9ecef; border-color: var(--v4-purple-accent); color: var(--v4-purple-accent); transform: translateY(-2px); }
        .sound-button-v4.playing { background-color: var(--v4-purple-accent); color: white; border: 2px solid var(--v4-purple-accent-darker); }
        .is-hidden { display: none !important; }
        #bottom-fixed-bar { position: fixed; bottom: 15px; right: 15px; z-index: 1001; display: flex; align-items: center; gap: 12px; padding: 10px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1)); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(2px); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15); width: var(--sound-search-bar-container-width); }
        #bottom-fixed-bar input[type="text"] { background: transparent; border: none; border-bottom: 1px solid rgba(50,50,50,0.6); border-radius: 0; color: var(--v4-text-primary); padding: 8px 5px; font-size: 1em; outline: none; flex-grow: 1; }
        #clearSoundsBtn { padding: 10px 12px; background: rgba(255, 5, 5, 0.85); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; cursor: pointer; font-size: 0.95em; text-transform: uppercase; transition: all 0.25s ease; flex-shrink: 0; }
        .status-message-v4 { display: none; padding: 15px 25px; margin: 0 auto 20px auto; border-radius: 12px; text-align: center; max-width: 600px; text-transform: uppercase; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); color: white; }
        .status-message-v4.success { background: linear-gradient(135deg, #1c7430, #155724); }
        .status-message-v4.error { background: linear-gradient(135deg, #8f262a, #721c24); }
        .status-message-v4.info { background: linear-gradient(135deg, #004085, #002752); }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; visibility: hidden; opacity: 0; transition: opacity 0.25s ease-out, visibility 0s linear 0.25s; }
        .modal-backdrop.visible { visibility: visible; opacity: 1; transition: opacity 0.25s ease-out, visibility 0s linear 0s; }
        .modal-content { background: var(--v4-card-bg); width: 90%; max-width: 800px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 90vh; transform: scale(0.95); transition: transform 0.3s ease; padding: 0; }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--v4-border-softer); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.5em; color: var(--v4-text-primary); }
        .modal-close-btn { color: #aaa; font-size: 30px; font-weight: 300; background: none; border: none; cursor: pointer; line-height: 1; transition: color 0.2s ease; }
        .modal-close-btn:hover { color: var(--v4-purple-accent); }
        .modal-body { flex-grow: 1; overflow-y: auto; padding: 0 20px 15px; }
        .modal-footer { padding: 15px 25px; border-top: 1px solid var(--v4-border-softer); display: flex; justify-content: flex-end; gap: 10px; background-color: #f8f9fa; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; }
        .settings-tabs { display: flex; background-color: #f8f9fa; padding: 5px; border-radius: 12px; margin: 10px 0; gap: 5px; }
        .tab-button { flex: 1; padding: 8px; background: none; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em; color: #555; transition: all 0.2s ease; }
        .tab-button.active { background: #fff; color: var(--v4-purple-accent); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .tab-panels-wrapper { position: relative; overflow: hidden; min-height: 350px; }
        .tab-panels-container { display: flex; transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .btn-primary { background: var(--v4-purple-gradient); color: white; border: none; padding: 10px 20px; border-radius: 8px; text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(103, 32, 189, 0.4); }
        .btn-secondary { background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; }
        .btn-secondary:hover { background: #5a6268; }
        /* New styles for a more "filled out" autoclicker tab */
        .autoclicker-panel-content { display: flex; flex-direction: column; gap: 20px; }
        .autoclicker-setting { background-color: var(--v4-input-bg); border: 1px solid var(--v4-border-softer); border-radius: 12px; padding: 15px; }
        .autoclicker-setting label { font-size: 1.1em; font-weight: 600; }
        .autoclicker-setting .mode-description { margin-top: 8px; font-size: 0.9em; }
        .autoclicker-delay-control { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .autoclicker-delay-control input { width: 100px; text-align: center; }
        .autoclicker-delay-control .btn-primary { padding: 8px 15px; text-transform: none; font-size: 0.9em; }
    </style>
</head>
<body class="soundboard-page">

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="soundboard-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="soundboard.html" class="active"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="apps.html"><span class="icon">✨</span><span class="label">Apps</span></a></li>
                    <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-soundboard-content">
            <div class="soundboard-header-v4"> 
                <h2 class="soundboard-title-v4">Soundboard</h2>
                <button id="openSettingsBtn" class="settings-action-btn" title="Settings"><img src="../images/gear-dark.png" alt="Settings"></button>
            </div>
            <div class="status-message-v4" id="statusMessageV4"></div>

            <div id="soundCategoriesContainerV4"> <p>Loading sounds...</p> </div>
        </main>
    </div>

    <div id="bottom-fixed-bar">
        <input type="text" id="soundSearchInput" placeholder="Search sounds...">
        <button id="clearSoundsBtn">Clear Sounds</button>
    </div>

    <div id="soundboardSettingsModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Soundboard Settings</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                     <button class="tab-button active" data-tab="general">General</button>
                     <button class="tab-button" data-tab="autoclicker">Autoclicker</button>
                </div>

                <div class="tab-panels-wrapper">
                    <div class="tab-panels-container">
                        <div id="general" class="tab-panel">
                             <div class="control-group" data-search-terms="allow multiple sounds overlay">
                                 <label class="checkbox-label-v4">Allow Sound Overlay <input type="checkbox" data-setting="allowMultiple"></label>
                             </div>
                             <div class="control-group" data-search-terms="sort order alphabetical oldest newest a-z z-a">
                                 <label>Sort Sounds By</label>
                                 <div class="radio-group-container">
                                     <label class="radio-label"><input type="radio" name="soundSortOrder" value="alpha-asc" data-setting="soundSortOrder" checked><span>A-Z</span></label>
                                     <label class="radio-label"><input type="radio" name="soundSortOrder" value="alpha-desc" data-setting="soundSortOrder"><span>Z-A</span></label>
                                     <label class="radio-label"><input type="radio" name="soundSortOrder" value="oldest" data-setting="soundSortOrder"><span>Oldest</span></label>
                                     <label class="radio-label"><input type="radio" name="soundSortOrder" value="newest" data-setting="soundSortOrder"><span>Newest</span></label>
                                 </div>
                             </div>
                             <div class="control-group" data-search-terms="speed rate tempo" style="grid-column: 1 / -1;">
                                <label for="playbackSpeedSlider">Playback Speed: <span data-display-for="playbackRate">1.0x</span></label>
                                <div class="slider-input-container">
                                    <input type="range" data-setting="playbackRate" id="playbackSpeedSlider" min="0.1" max="5" step="0.1" value="1">
                                </div>
                            </div>
                        </div>

                        <div id="autoclicker" class="tab-panel">
                            <div class="autoclicker-panel-content" style="grid-column: 1 / -1;">
                                <div class="autoclicker-setting">
                                    <label class="checkbox-label-v4">Enable Autoclicker
                                        <input type="checkbox" data-setting="autoclickerEnabled">
                                    </label>
                                    <p class="mode-description">When enabled, hovering your mouse over a sound button will repeatedly trigger it based on the delay you set below.</p>
                                </div>
                                <div class="autoclicker-setting">
                                    <label for="autoClickDelay">Repetition Delay</label>
                                    <p class="mode-description">Set the time in milliseconds (ms) between each automatic click. A lower number is faster. 0 is as fast as possible.</p>
                                    <div class="autoclicker-delay-control">
                                        <input type="number" data-setting="clickInterval" id="autoClickDelayInput" value="200" min="0">
                                        <span>ms</span>
                                        <button id="applyDelayBtn" class="btn-primary">Apply</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveSettingsBtn" class="btn-primary">Save Settings</button>
            </div>
        </div>
    </div>
    
    <script>
    class SoundboardApp {
        constructor() {
            this.uiManager = new UIManager();
            this.state = {
                settings: this.loadSettings(),
                playingAudios: [],
                currentlyHoveredButton: null,
                autoClickInterval: null,
                requestAnimationFrameId: null,
            };
        }

        init() {
            this.uiManager.init();
            this.bindEvents();
            this.applyAllSettings();
            this.loadSoundFiles();
        }

        bindEvents() {
            this.uiManager.elements.openSettingsBtn.addEventListener('click', () => this.uiManager.toggleModal(true));
            this.uiManager.elements.modal.addEventListener('click', (e) => {
                if (e.target === this.uiManager.elements.modal || e.target.classList.contains('modal-close-btn')) {
                    this.uiManager.toggleModal(false);
                }
            });
            this.uiManager.elements.tabsContainer.addEventListener('click', e => this.uiManager.handleTabClick(e));
            this.uiManager.elements.clearSoundsBtn.addEventListener('click', () => this.stopAllSounds());
            this.uiManager.elements.saveSettingsBtn.addEventListener('click', () => this.saveSettings());
            
            // Sound button listeners using delegation
            this.uiManager.elements.soundCategoriesContainer.addEventListener('click', e => this.handleSoundButtonClick(e));
            this.uiManager.elements.soundCategoriesContainer.addEventListener('mouseenter', e => this.handleAutoclicker(e, 'start'), true);
            this.uiManager.elements.soundCategoriesContainer.addEventListener('mouseleave', e => this.handleAutoclicker(e, 'stop'), true);
            
            // Settings listeners
            document.querySelector('[data-setting="allowMultiple"]').addEventListener('change', (e) => {
                this.state.settings.allowMultiple = e.target.checked;
                if (!e.target.checked) this.stopAllSounds();
            });
            document.querySelectorAll('[data-setting="soundSortOrder"]').forEach(radio => radio.addEventListener('change', () => this.loadSoundFiles()));
            document.querySelector('[data-setting="playbackRate"]').addEventListener('input', (e) => {
                this.state.settings.playbackRate = parseFloat(e.target.value);
                this.uiManager.updateDisplayValue('playbackRate', this.state.settings.playbackRate);
                this.state.playingAudios.forEach(audio => audio.playbackRate = this.state.settings.playbackRate);
            });
            document.querySelector('[data-setting="autoclickerEnabled"]').addEventListener('change', (e) => {
                this.state.settings.autoclickerEnabled = e.target.checked;
                if (!e.target.checked) this.stopAutoClicker();
            });
            document.getElementById('applyDelayBtn').addEventListener('click', () => {
                const delayInput = document.getElementById('autoClickDelayInput');
                const delay = parseInt(delayInput.value, 10);
                if (!isNaN(delay) && delay >= 0) {
                    this.state.settings.clickInterval = delay;
                    this.uiManager.showStatus(`Autoclicker delay set to ${delay}ms`, 'info');
                    if (this.state.settings.autoclickerEnabled && this.state.currentlyHoveredButton) {
                        this.startAutoClicker(); // Restart with new delay
                    }
                } else {
                    delayInput.value = this.state.settings.clickInterval; // Revert if invalid
                    this.uiManager.showStatus('Invalid delay value.', 'error');
                }
            });
        }
        
        handleSoundButtonClick(e) {
            const button = e.target.closest('.sound-button-v4');
            if (!button) return;

            const soundPath = button.dataset.soundFile;
            if (!soundPath) return;

            if (!this.state.settings.allowMultiple) {
                this.stopAllSounds();
            }

            try {
                const audio = new Audio(soundPath);
                audio.playbackRate = this.state.settings.playbackRate;
                audio.addEventListener('ended', () => {
                    this.state.playingAudios = this.state.playingAudios.filter(a => a !== audio);
                });
                this.state.playingAudios.push(audio);
                audio.play().catch(err => {
                    console.error(`Error playing sound: ${soundPath}`, err);
                    this.uiManager.showStatus(`Could not play sound`, 'error');
                });
            } catch (err) {
                console.error(`Error creating Audio object for: ${soundPath}`, err);
            }
        }
        
        stopAllSounds() {
            this.state.playingAudios.forEach(audio => {
                audio.pause();
                audio.currentTime = 0;
            });
            this.state.playingAudios = [];
        }

        // --- Autoclicker logic from old version ---
        handleAutoclicker(event, type) {
            const button = event.target.closest('.sound-button-v4');
            if (type === 'start' && button) {
                this.state.currentlyHoveredButton = button;
                if (this.state.settings.autoclickerEnabled) {
                    this.startAutoClicker();
                }
            } else if (type === 'stop' && button) {
                if (this.state.currentlyHoveredButton === button) {
                    this.state.currentlyHoveredButton = null;
                    this.stopAutoClicker();
                }
            }
        }

        fastClicker() {
            if (this.state.currentlyHoveredButton && this.state.settings.autoclickerEnabled) {
                this.state.currentlyHoveredButton.click();
                this.state.requestAnimationFrameId = requestAnimationFrame(() => this.fastClicker());
            }
        }

        startAutoClicker() {
            this.stopAutoClicker();
            if (!this.state.currentlyHoveredButton || !this.state.settings.autoclickerEnabled) return;
            
            const delay = this.state.settings.clickInterval;
            if (delay === 0) {
                this.state.requestAnimationFrameId = requestAnimationFrame(() => this.fastClicker());
            } else {
                this.state.autoClickInterval = setInterval(() => {
                    if (this.state.currentlyHoveredButton) {
                        this.state.currentlyHoveredButton.click();
                    } else {
                        this.stopAutoClicker();
                    }
                }, delay);
            }
        }

        stopAutoClicker() {
            if (this.state.autoClickInterval) {
                clearInterval(this.state.autoClickInterval);
                this.state.autoClickInterval = null;
            }
            if (this.state.requestAnimationFrameId) {
                cancelAnimationFrame(this.state.requestAnimationFrameId);
                this.state.requestAnimationFrameId = null;
            }
        }

        // --- Sound & Settings Loading ---
        async loadSoundFiles() {
            try {
                const response = await fetch('SoundboardSN.json');
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                this.uiManager.renderSoundboard(data, this.state.settings.soundSortOrder);
            } catch (error) {
                console.error("Failed to load sound list:", error);
                this.uiManager.showStatus('Error loading sound list.', 'error');
            }
        }

        loadSettings() {
            const defaults = {
                allowMultiple: false,
                soundSortOrder: "alpha-asc",
                playbackRate: 1.0,
                autoclickerEnabled: false,
                clickInterval: 200,
            };
            const saved = localStorage.getItem('soundboardSettings');
            return saved ? { ...defaults, ...JSON.parse(saved) } : defaults;
        }

        saveSettings() {
            localStorage.setItem('soundboardSettings', JSON.stringify(this.state.settings));
            this.uiManager.showStatus('Settings Saved!', 'success');
            this.uiManager.toggleModal(false);
        }

        applyAllSettings() {
            document.querySelector('[data-setting="allowMultiple"]').checked = this.state.settings.allowMultiple;
            document.querySelector(`[data-setting="soundSortOrder"][value="${this.state.settings.soundSortOrder}"]`).checked = true;
            const playbackRateSlider = document.querySelector('[data-setting="playbackRate"]');
            playbackRateSlider.value = this.state.settings.playbackRate;
            this.uiManager.updateDisplayValue('playbackRate', this.state.settings.playbackRate);
            document.querySelector('[data-setting="autoclickerEnabled"]').checked = this.state.settings.autoclickerEnabled;
            document.querySelector('[data-setting="clickInterval"]').value = this.state.settings.clickInterval;
        }
    }

    class UIManager {
        constructor() { this.elements = {}; }

        init() {
            this.elements = {
                modal: document.getElementById('soundboardSettingsModal'),
                openSettingsBtn: document.getElementById('openSettingsBtn'),
                saveSettingsBtn: document.getElementById('saveSettingsBtn'),
                clearSoundsBtn: document.getElementById('clearSoundsBtn'),
                soundCategoriesContainer: document.getElementById('soundCategoriesContainerV4'),
                tabsContainer: document.querySelector('.settings-tabs'),
                tabPanelContainer: document.querySelector('.tab-panels-container'),
                statusMessage: document.getElementById('statusMessageV4'),
            };
        }

        renderSoundboard(soundData, sortOrder) {
            this.elements.soundCategoriesContainer.innerHTML = '';
            const categories = Object.keys(soundData);

            categories.forEach(categoryKey => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'sound-category-v4';
                categoryDiv.innerHTML = `<h2>${categoryKey.replace(/([A-Z])/g, ' $1').trim()}</h2>`;
                const buttonsGrid = document.createElement('div');
                buttonsGrid.className = 'sound-buttons-grid-v4';

                let soundList = [...soundData[categoryKey]];
                if (sortOrder === 'alpha-asc') soundList.sort();
                if (sortOrder === 'alpha-desc') soundList.sort().reverse();

                soundList.forEach(fileName => {
                    const soundName = fileName.replace('.mp3', '').replace(/_/g, ' ');
                    const button = document.createElement('button');
                    button.className = 'sound-button-v4';
                    button.textContent = soundName;
                    // The path is constructed relative to the HTML file's location
                    button.dataset.soundFile = `../Sounds/${categoryKey}/${fileName}`;
                    buttonsGrid.appendChild(button);
                });
                categoryDiv.appendChild(buttonsGrid);
                this.elements.soundCategoriesContainer.appendChild(categoryDiv);
            });
        }
        
        toggleModal(forceShow) { this.elements.modal.classList.toggle('visible', forceShow); }
        
        handleTabClick(e) {
            const clickedButton = e.target.closest('.tab-button');
            if (clickedButton) {
                const tabButtons = this.elements.tabsContainer.querySelectorAll('.tab-button');
                const tabIndex = Array.from(tabButtons).indexOf(clickedButton);
                tabButtons.forEach(btn => btn.classList.remove('active'));
                clickedButton.classList.add('active');
                this.elements.tabPanelContainer.style.transform = `translateX(-${tabIndex * 100}%)`;
            }
        }
        
        updateDisplayValue(key, value) {
            const displayEl = document.querySelector(`[data-display-for="${key}"]`);
            if (displayEl) {
                if (key === 'playbackRate') displayEl.textContent = `${parseFloat(value).toFixed(1)}x`;
            }
        }

        showStatus(message, type = 'info', duration = 3000) {
            const el = this.elements.statusMessage;
            clearTimeout(el.timeoutId);
            el.textContent = message;
            el.className = `status-message-v4 ${type}`;
            el.style.display = 'block';
            el.timeoutId = setTimeout(() => el.style.display = 'none', duration);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const app = new SoundboardApp();
        app.init();
    });
    </script>
</body>
</html>
