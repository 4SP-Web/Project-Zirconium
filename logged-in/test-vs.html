<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vernsocial</title>
    <!-- External stylesheet referenced from notes.html -->
    <link rel="stylesheet" href="../css/style.css">
    <!-- Tailwind CSS for utility classes and responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom styles inspired by notes.html for this specific page -->
    <style>
        /* Using a common font for consistency */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrolling on the body */
        }

        /* Replicating the dashboard layout from notes.html */
        .dashboard-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar styling inspired by notes.html */
        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #444;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .sidebar-tab {
            flex-grow: 1;
            padding: 12px;
            text-align: center;
            background-color: #333;
            border: none;
            color: #ccc;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .sidebar-tab.active-tab {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            font-weight: 600;
        }

        /* Main content area styling */
        .main-content {
            flex-grow: 1;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* Custom scrollbar for chat areas */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Chat bubble styling */
        .chat-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 20px;
            word-wrap: break-word;
        }
        .chat-bubble.sent {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
            border-bottom-right-radius: 5px;
        }
        .chat-bubble.received {
            background-color: #e2e8f0; /* Slate-200 */
            color: #1e293b; /* Slate-800 */
            border-bottom-left-radius: 5px;
        }
        
        /* Animation for modals and pop-ups */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-content {
            animation: fadeIn 0.2s ease-out;
        }

        /* Hide elements utility */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="bg-slate-800">

    <!-- Auth Container: Shown when user is not logged in -->
    <div id="auth-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-xl modal-content">
            <h2 id="auth-title" class="text-3xl font-extrabold text-center text-slate-900">Welcome to Vernsocial</h2>
            <div id="auth-view">
                <!-- Login form -->
                <form id="login-form" class="space-y-4">
                    <p class="text-center text-slate-600">Please log in to continue.</p>
                    <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                    <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                    <button type="submit" class="w-full py-3 text-white bg-blue-600 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Login</button>
                    <p class="text-center text-sm">Don't have an account? <a href="#" id="show-signup" class="font-medium text-blue-600 hover:text-blue-500">Sign up</a></p>
                </form>
                <!-- Signup form -->
                <form id="signup-form" class="hidden space-y-4">
                    <p class="text-center text-slate-600">Create your account.</p>
                    <input type="text" id="signup-username" placeholder="Username (unique, 3-20 chars)" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                    <input type="email" id="signup-email" placeholder="Email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                    <input type="password" id="signup-password" placeholder="Password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                    <button type="submit" class="w-full py-3 text-white bg-green-600 rounded-lg font-semibold hover:bg-green-700 transition-colors">Sign Up</button>
                    <p class="text-center text-sm">Already have an account? <a href="#" id="show-login" class="font-medium text-blue-600 hover:text-blue-500">Login</a></p>
                </form>
            </div>
            <p id="auth-error" class="text-center text-sm text-red-500"></p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="dashboard-container hidden">
        
        <!-- Sidebar -->
        <aside class="sidebar flex flex-col">
            <!-- User Profile & Logout -->
            <div class="p-4 border-b border-gray-700">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center text-white text-xl font-bold" id="user-avatar"></div>
                    <div>
                        <h3 class="font-bold text-lg" id="current-username">Loading...</h3>
                        <p class="text-sm text-gray-400" id="current-user-id">Loading...</p>
                    </div>
                </div>
                <button id="logout-btn" class="mt-4 w-full text-left py-2 px-3 rounded-lg text-sm font-medium bg-red-600 hover:bg-red-700 transition-colors">Logout</button>
            </div>

            <!-- Sidebar Navigation Tabs -->
            <div class="flex border-b border-gray-700">
                <button class="sidebar-tab active-tab" data-tab="chats">Chats</button>
                <button class="sidebar-tab" data-tab="friends">Friends</button>
                <button class="sidebar-tab" data-tab="pins">Pins</button>
            </div>
            
            <div class="flex-grow overflow-y-auto custom-scrollbar">
                <!-- Chats Tab Content -->
                <div id="chats-tab" class="sidebar-content">
                    <div class="p-4">
                        <button id="create-group-btn" class="w-full py-2 px-3 rounded-lg text-sm font-medium bg-green-600 hover:bg-green-700 transition-colors">Create Group Chat</button>
                    </div>
                    <ul id="chats-list" class="space-y-1 p-2">
                        <!-- Chat list items will be dynamically inserted here -->
                    </ul>
                </div>

                <!-- Friends Tab Content -->
                <div id="friends-tab" class="sidebar-content hidden">
                    <!-- Add Friends -->
                    <div class="p-4 border-b border-gray-700">
                        <h4 class="font-bold mb-2">Add Friend</h4>
                        <div class="flex space-x-2">
                            <input type="text" id="search-username-input" placeholder="Enter exact username..." class="flex-grow bg-gray-700 border border-gray-600 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="search-user-btn" class="bg-blue-600 text-white rounded-lg px-4 font-semibold hover:bg-blue-700">Search</button>
                        </div>
                        <div id="search-results" class="mt-2 text-sm"></div>
                    </div>
                    <!-- Friend Lists (Requests, Friends, Blocked) -->
                    <div id="friend-lists" class="p-2">
                        <!-- Friend Requests -->
                        <div id="friend-requests-section">
                            <h5 class="font-semibold p-2">Friend Requests</h5>
                            <ul id="friend-requests-list" class="space-y-1"></ul>
                        </div>
                        <!-- Friends List -->
                        <div id="friends-list-section" class="mt-4">
                            <h5 class="font-semibold p-2">Friends</h5>
                            <ul id="friends-list" class="space-y-1"></ul>
                        </div>
                        <!-- Blocked Users -->
                        <div id="blocked-list-section" class="mt-4">
                            <h5 class="font-semibold p-2">Blocked Users</h5>
                            <ul id="blocked-users-list" class="space-y-1"></ul>
                        </div>
                    </div>
                </div>
                
                <!-- Pinned Messages Tab Content -->
                <div id="pins-tab" class="sidebar-content hidden p-2">
                    <h4 class="font-bold p-2">Pinned Messages (<span id="pinned-count">0</span>/10)</h4>
                    <ul id="pinned-messages-list" class="space-y-2">
                        <!-- Pinned messages will be dynamically inserted here -->
                    </ul>
                </div>
            </div>
        </aside>

        <!-- Main Chat Content -->
        <main class="main-content">
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="flex flex-col items-center justify-center h-full">
                <h2 class="text-3xl font-bold text-slate-800">Welcome to Vernsocial!</h2>
                <p class="text-slate-600 mt-2">Select a chat from the sidebar to start messaging.</p>
            </div>

            <!-- Chat View -->
            <div id="chat-view" class="hidden flex flex-col h-full">
                <!-- Chat Header -->
                <header class="flex-shrink-0 p-4 border-b border-slate-300 bg-white flex justify-between items-center">
                    <h3 id="chat-name" class="text-xl font-bold"></h3>
                    <div id="chat-members" class="text-sm text-slate-500"></div>
                </header>

                <!-- Messages Area -->
                <div id="messages-container" class="flex-grow p-4 overflow-y-auto custom-scrollbar">
                    <!-- Messages will be dynamically inserted here -->
                </div>

                <!-- Message Input Area -->
                <footer class="flex-shrink-0 p-4 bg-white border-t border-slate-300">
                    <div class="relative">
                        <textarea id="message-input" placeholder="Type a message..." maxlength="250" class="w-full p-3 pr-20 bg-slate-100 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        <button id="send-btn" class="absolute right-3 top-1/2 -translate-y-1/2 bg-blue-600 text-white rounded-md px-4 py-1.5 font-semibold hover:bg-blue-700 transition-colors">Send</button>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Press <kbd>Enter</kbd> to send, <kbd>Shift</kbd> + <kbd>Enter</kbd> for a new line. <span id="char-counter">0/250</span></p>
                </footer>
            </div>
        </main>
    </div>

    <!-- Modals (e.g., Create Group, Reactions) will be appended here by JS -->

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <!-- Firebase Configuration -->
    <script src="../firebase-config.js"></script>

    <!-- Main Application Logic -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Initialization ---
        if (typeof firebaseConfig === 'undefined') {
            console.error("Firebase config is not loaded. Make sure firebase-config.js is correct.");
            alert("Application cannot start: Firebase configuration is missing.");
            return;
        }
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const authError = document.getElementById('auth-error');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        
        const logoutBtn = document.getElementById('logout-btn');
        const currentUserAvatar = document.getElementById('user-avatar');
        const currentUsernameEl = document.getElementById('current-username');
        const currentUserIdEl = document.getElementById('current-user-id');

        const sidebarTabs = document.querySelectorAll('.sidebar-tab');
        const chatsListEl = document.getElementById('chats-list');
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatView = document.getElementById('chat-view');
        const chatNameEl = document.getElementById('chat-name');
        const chatMembersEl = document.getElementById('chat-members');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const charCounter = document.getElementById('char-counter');

        const searchUserInput = document.getElementById('search-username-input');
        const searchUserBtn = document.getElementById('search-user-btn');
        const searchResultsEl = document.getElementById('search-results');
        const friendRequestsList = document.getElementById('friend-requests-list');
        const friendsList = document.getElementById('friends-list');
        const blockedUsersList = document.getElementById('blocked-users-list');

        const pinnedMessagesList = document.getElementById('pinned-messages-list');
        const pinnedCountEl = document.getElementById('pinned-count');

        const createGroupBtn = document.getElementById('create-group-btn');

        // --- App State ---
        let currentUser = null;
        let currentChatId = null;
        let unsubscribeCurrentChat = null;
        let unsubscribeAllListeners = [];
        let localFriendships = [];

        // --- Auth State Change ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                initializeAppForUser(user.uid);
            } else {
                currentUser = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                cleanupListeners();
                resetUI();
            }
        });

        // --- Auth Form Logic ---
        showSignup.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); authError.textContent = ''; });
        showLogin.addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); authError.textContent = ''; });
        
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            authError.textContent = '';
            if (username.length < 3 || username.length > 20) { authError.textContent = 'Username must be between 3 and 20 characters.'; return; }
            const usernameCheck = await db.collection('users').where('username', '==', username).get();
            if (!usernameCheck.empty) { authError.textContent = 'Username is already taken.'; return; }
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection('users').doc(userCredential.user.uid).set({ username: username, email: email, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            } catch (error) { authError.textContent = error.message; }
        });
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authError.textContent = '';
            try { await auth.signInWithEmailAndPassword(email, password); } catch (error) { authError.textContent = error.message; }
        });

        logoutBtn.addEventListener('click', () => { auth.signOut(); });

        // --- App Initialization ---
        async function initializeAppForUser(uid) {
            cleanupListeners();
            const userDoc = await db.collection('users').doc(uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                currentUsernameEl.textContent = userData.username;
                currentUserAvatar.textContent = userData.username.charAt(0).toUpperCase();
            }
            currentUserIdEl.textContent = `UID: ${uid.substring(0, 8)}...`;
            listenForFriendships(uid);
            listenForChats(uid);
            listenForPins(uid);
        }
        
        // --- Cleanup and UI Reset ---
        function cleanupListeners() {
            unsubscribeAllListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeAllListeners = [];
            if (unsubscribeCurrentChat) { unsubscribeCurrentChat(); unsubscribeCurrentChat = null; }
        }
        
        function resetUI() {
            chatsListEl.innerHTML = '';
            friendRequestsList.innerHTML = '';
            friendsList.innerHTML = '';
            blockedUsersList.innerHTML = '';
            pinnedMessagesList.innerHTML = '';
            welcomeScreen.classList.remove('hidden');
            chatView.classList.add('hidden');
            localFriendships = [];
        }

        // --- Sidebar Tab Navigation ---
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                sidebarTabs.forEach(t => t.classList.remove('active-tab'));
                tab.classList.add('active-tab');
                document.querySelectorAll('.sidebar-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`${tab.dataset.tab}-tab`).classList.remove('hidden');
            });
        });

        // --- Helper to get user data ---
        const userCache = new Map();
        async function getUserData(uid) {
            if (userCache.has(uid)) return userCache.get(uid);
            const userDoc = await db.collection('users').doc(uid).get();
            if(userDoc.exists) {
                const data = { id: uid, ...userDoc.data() };
                userCache.set(uid, data);
                return data;
            }
            return null;
        }

        // --- Friend Management Logic ---
        function listenForFriendships(uid) {
            const friendshipsQuery = db.collection('friendships').where('users', 'array-contains', uid);
            const unsubscribe = friendshipsQuery.onSnapshot(async snapshot => {
                const friendshipPromises = snapshot.docs.map(async doc => ({ id: doc.id, ...(await getUserDataForFriendship(doc.data(), uid)) }));
                localFriendships = await Promise.all(friendshipPromises);
                
                // Categorize and render lists
                const requests = localFriendships.filter(f => f.status === 'pending' && f.requester !== uid);
                const friends = localFriendships.filter(f => f.status === 'friends');
                const blocked = localFriendships.filter(f => f.status === 'blocked' && f.blocker === uid);

                renderFriendRequestsList(requests);
                renderFriendsList(friends);
                renderBlockedUsersList(blocked);
            });
            unsubscribeAllListeners.push(unsubscribe);
        }

        async function getUserDataForFriendship(friendshipData, currentUserId) {
            const otherUserId = friendshipData.users.find(id => id !== currentUserId);
            const otherUser = await getUserData(otherUserId);
            return { ...friendshipData, otherUser: otherUser, otherUserId: otherUserId };
        }

        function renderFriendRequestsList(requests) {
            friendRequestsList.innerHTML = '';
            if (requests.length === 0) { friendRequestsList.innerHTML = '<li class="text-xs text-gray-400 px-2">No new requests.</li>'; return; }
            requests.forEach(req => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-2 rounded-lg bg-gray-600';
                li.innerHTML = `<span>${req.otherUser.username}</span>
                                <div class="flex space-x-1">
                                    <button data-id="${req.id}" class="accept-friend-btn bg-green-500 text-xs px-2 py-1 rounded">Accept</button>
                                    <button data-id="${req.id}" class="decline-friend-btn bg-red-500 text-xs px-2 py-1 rounded">Decline</button>
                                </div>`;
                friendRequestsList.appendChild(li);
            });
            friendRequestsList.querySelectorAll('.accept-friend-btn').forEach(b => b.addEventListener('click', (e) => acceptFriendRequest(e.target.dataset.id)));
            friendRequestsList.querySelectorAll('.decline-friend-btn').forEach(b => b.addEventListener('click', (e) => declineFriendRequest(e.target.dataset.id)));
        }

        function renderFriendsList(friends) {
            friendsList.innerHTML = '';
            if (friends.length === 0) { friendsList.innerHTML = '<li class="text-xs text-gray-400 px-2">No friends yet.</li>'; return; }
            friends.forEach(friend => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-gray-700';
                li.innerHTML = `<span>${friend.otherUser.username}</span>
                                <div class="flex space-x-1">
                                    <button data-id="${friend.otherUserId}" class="message-friend-btn bg-blue-500 text-xs px-2 py-1 rounded">Message</button>
                                    <button data-id="${friend.id}" class="unfriend-btn bg-yellow-500 text-xs px-2 py-1 rounded">Unfriend</button>
                                </div>`;
                friendsList.appendChild(li);
            });
            friendsList.querySelectorAll('.message-friend-btn').forEach(b => b.addEventListener('click', (e) => startDmChat(e.target.dataset.id)));
            friendsList.querySelectorAll('.unfriend-btn').forEach(b => b.addEventListener('click', (e) => unfriend(e.target.dataset.id)));
        }

        function renderBlockedUsersList(blocked) {
            blockedUsersList.innerHTML = '';
            if (blocked.length === 0) { blockedUsersList.innerHTML = '<li class="text-xs text-gray-400 px-2">No blocked users.</li>'; return; }
            blocked.forEach(b => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-2 rounded-lg bg-gray-800';
                li.innerHTML = `<span>${b.otherUser.username}</span>
                                <button data-id="${b.id}" class="unblock-btn bg-gray-500 text-xs px-2 py-1 rounded">Unblock</button>`;
                blockedUsersList.appendChild(li);
            });
        }
        
        searchUserBtn.addEventListener('click', async () => {
            const username = searchUserInput.value.trim();
            if (!username) { searchResultsEl.innerHTML = '<p class="text-red-400">Please enter a username.</p>'; return; }
            
            searchResultsEl.innerHTML = 'Searching...';
            const querySnapshot = await db.collection('users').where('username', '==', username).get();
            
            if (querySnapshot.empty) {
                searchResultsEl.innerHTML = '<p class="text-yellow-400">User not found.</p>';
            } else {
                const userDoc = querySnapshot.docs[0];
                const userId = userDoc.id;
                if (userId === currentUser.uid) {
                    searchResultsEl.innerHTML = '<p class="text-blue-400">You can\'t add yourself.</p>';
                    return;
                }
                const existing = localFriendships.find(f => f.otherUserId === userId);
                if (existing) {
                    searchResultsEl.innerHTML = `<p class="text-green-400">You are already connected with this user (${existing.status}).</p>`;
                } else {
                    searchResultsEl.innerHTML = `<div>
                                                    <p>Found: <strong>${userDoc.data().username}</strong></p>
                                                    <button id="add-friend-btn" class="mt-1 bg-green-600 text-white w-full py-1 rounded-lg">Add Friend</button>
                                               </div>`;
                    document.getElementById('add-friend-btn').addEventListener('click', () => sendFriendRequest(userId));
                }
            }
        });

        async function sendFriendRequest(targetUid) {
            const friendshipId = [currentUser.uid, targetUid].sort().join('_');
            try {
                await db.collection('friendships').doc(friendshipId).set({
                    users: [currentUser.uid, targetUid],
                    status: 'pending',
                    requester: currentUser.uid,
                });
                searchResultsEl.innerHTML = '<p class="text-green-400">Friend request sent!</p>';
            } catch (error) {
                console.error("Error sending friend request:", error);
                searchResultsEl.innerHTML = '<p class="text-red-400">Could not send request.</p>';
            }
        }

        async function acceptFriendRequest(friendshipId) {
            const friendshipRef = db.collection('friendships').doc(friendshipId);
            try {
                const friendshipDoc = await friendshipRef.get();
                if (!friendshipDoc.exists) {
                    console.error("Cannot accept: Friendship document not found.", friendshipId);
                    return;
                }
                const users = friendshipDoc.data().users;
                // Create the chat document for the two users.
                const chatId = users.sort().join('_');
                const chatRef = db.collection('chats').doc(chatId);
                await chatRef.set({
                    members: users,
                    type: 'dm',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    messages: {}
                }, { merge: true }); // Use merge to avoid overwriting existing chat data.

                // Finally, update the friendship status to 'friends'.
                await friendshipRef.update({ status: 'friends' });
            } catch (error) {
                console.error("Error accepting friend request:", error);
            }
        }

        async function declineFriendRequest(friendshipId) {
            await db.collection('friendships').doc(friendshipId).delete();
        }
        
        async function unfriend(friendshipId) {
            if (confirm("Are you sure you want to unfriend this user?")) {
                await db.collection('friendships').doc(friendshipId).delete();
            }
        }
        
        // --- Chat & Messaging Logic ---
        function listenForChats(uid) {
            const chatsQuery = db.collection('chats').where('members', 'array-contains', uid);
            const unsubscribe = chatsQuery.onSnapshot(async snapshot => {
                const chatPromises = snapshot.docs.map(async doc => {
                    const chatData = doc.data();
                    const otherMembers = chatData.members.filter(m => m !== uid);
                    let chatName = chatData.groupName || "Group Chat";
                    if (chatData.type === 'dm' && otherMembers.length > 0) {
                        const otherUser = await getUserData(otherMembers[0]);
                        chatName = otherUser ? otherUser.username : "Unknown User";
                    }
                    return { id: doc.id, name: chatName, data: chatData };
                });
                const chats = await Promise.all(chatPromises);
                renderChatsList(chats);
            });
            unsubscribeAllListeners.push(unsubscribe);
        }

        function renderChatsList(chats) {
            chatsListEl.innerHTML = '';
            if (chats.length === 0) { chatsListEl.innerHTML = `<li class="p-3 text-center text-gray-400 text-sm">No chats yet.</li>`; return; }
            chats.forEach(chat => {
                const li = document.createElement('li');
                li.className = "p-3 rounded-lg hover:bg-gray-700 cursor-pointer";
                li.textContent = chat.name;
                li.dataset.chatId = chat.id;
                li.addEventListener('click', () => openChat(chat.id, chat.name));
                chatsListEl.appendChild(li);
            });
        }
        
        async function startDmChat(otherUserId) {
            const otherUser = await getUserData(otherUserId);
            if (!otherUser) {
                console.error("Could not find user data for UID:", otherUserId);
                return;
            }

            const chatId = [currentUser.uid, otherUserId].sort().join('_');
            const chatRef = db.collection('chats').doc(chatId);
            
            try {
                const chatDoc = await chatRef.get();

                if (!chatDoc.exists) {
                    // This case should be less frequent now, but is kept as a fallback.
                    await chatRef.set({
                        members: [currentUser.uid, otherUserId],
                        type: 'dm',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        messages: {} 
                    });
                }
                
                openChat(chatId, otherUser.username);

            } catch (error) {
                console.error("Error starting DM chat:", error);
            }
        }
        
        function openChat(chatId, name) {
            currentChatId = chatId;
            welcomeScreen.classList.add('hidden');
            chatView.classList.remove('hidden');
            chatNameEl.textContent = name;
            
            if (unsubscribeCurrentChat) unsubscribeCurrentChat();
            
            messagesContainer.innerHTML = `<div class="text-center text-gray-500">Loading messages...</div>`;

            unsubscribeCurrentChat = db.collection('chats').doc(chatId).onSnapshot(async doc => {
                 if (doc.exists) {
                    const chatData = doc.data();
                    renderMessages(chatData.messages || {});
                 }
            });
        }
        
        async function renderMessages(messages) {
            messagesContainer.innerHTML = '';
            const messagePromises = Object.entries(messages).map(async ([uid, msg]) => {
                const user = await getUserData(uid);
                return { uid, user, ...msg };
            });
            
            const messagesWithUserData = await Promise.all(messagePromises);
            messagesWithUserData.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

            messagesWithUserData.forEach(msg => {
                const isSent = msg.uid === currentUser.uid;
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex mb-4 ${isSent ? 'justify-end' : 'justify-start'}`;
                let senderName = isSent ? "You" : (msg.user ? msg.user.username : "...");
                let timestamp = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleString() : '';
                messageWrapper.innerHTML = `<div class="flex items-end ${isSent ? 'flex-row-reverse' : ''}">
                         <div class="w-8 h-8 rounded-full bg-gray-500 flex items-center justify-center text-white font-bold mx-2 flex-shrink-0">${senderName.charAt(0).toUpperCase()}</div>
                         <div>
                            <p class="text-xs ${isSent ? 'text-right' : 'text-left'} text-gray-500 mb-1">${senderName}</p>
                            <div class="chat-bubble ${isSent ? 'sent' : 'received'}">
                               <p>${msg.text.replace(/\n/g, '<br>')}</p>
                               <div class="text-xs mt-1 ${isSent ? 'text-blue-200' : 'text-slate-500'}">${timestamp}</div>
                            </div>
                         </div></div>`;
                messagesContainer.appendChild(messageWrapper);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentChatId) return;
            const chatRef = db.collection('chats').doc(currentChatId);
            const messagePayload = { text: text, timestamp: firebase.firestore.FieldValue.serverTimestamp(), reactions: {}, replyTo: null };
            try {
                await chatRef.update({
                    [`messages.${currentUser.uid}`]: messagePayload,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                messageInput.value = '';
                updateCharCounter();
            } catch (error) {
                console.error("Error sending message:", error);
                if (error.code === 'not-found') {
                    await chatRef.set({ messages: { [currentUser.uid]: messagePayload } }, { merge: true });
                    messageInput.value = '';
                    updateCharCounter();
                } else {
                    console.error("A critical error occurred while sending the message.");
                }
            }
        }
        
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        function updateCharCounter() { charCounter.textContent = `${messageInput.value.length}/250`; }
        messageInput.addEventListener('input', updateCharCounter);

        // --- Placeholder for Pinning and Group Chat logic ---
        function listenForPins(uid) { /* ... Full logic needed ... */ }
        createGroupBtn.addEventListener('click', () => { alert('Group chat creation not implemented yet.'); });

    });
    </script>
</body>
</html>
