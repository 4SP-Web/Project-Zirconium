<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - PLANNER</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="../panic-key.js"></script>
    <script src="../ban-enforcer.js"></script>
    <script src="../url-changer.js"></script>
    <style>
        /* Base Layout & Theme */
        body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: 'PrimaryFont', sans-serif; }
        .dashboard-container { display: flex; flex: 1; }
        .main-content { flex: 1; padding: 30px; background: #f4f7fa; overflow-y: auto; }

        /* Sidebar */
        .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
        .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; opacity: 1; visibility: visible; transition: opacity 0.2s ease-in-out 0.4s; }
        .sidebar.collapsed nav a .label { opacity: 0; visibility: hidden; transition-delay: 0s; }

        /* Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-title { font-size: 2.2em; font-weight: bold; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0; }
        .header-actions { display: flex; gap: 10px; }
        .btn { border: none; padding: 10px 20px; border-radius: 8px; font-family: 'PrimaryFont', sans-serif; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(103, 32, 189, 0.25); }
        .btn-secondary { background: #e9ecef; color: #333; }
        .btn-secondary:hover { background: #d1d9e6; }
        .btn-icon { background: #f0f2f5; color: #555; width: 40px; height: 40px; padding: 0; justify-content: center; font-size: 1.2em; border-radius: 50%; }
        .btn-icon:hover { background: #e1e5ea; color: #000; }

        /* Animations */
        @keyframes card-fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes modal-fade-in-scale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes marquee-animation { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        @keyframes slide-in-left { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slide-out-right { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        @keyframes slide-in-right { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slide-out-left { from { transform: translateX(0); opacity: 1; } to { transform: translateX(-100%); opacity: 0; } }

        /* Marquee Title Styles */
        .marquee-container { overflow: hidden; width: 100%; position: relative; }
        .marquee-container.active .marquee-content { display: inline-block; width: max-content; animation: marquee-animation 10s linear infinite; }
        .marquee-container.active .marquee-content span:first-of-type { padding-right: 20px; }

        /* Task Sections */
        .task-section { margin-bottom: 30px; }
        .task-section-header { font-size: 1.5em; font-weight: bold; color: #333; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 2px solid #e8eaf0; }
        .task-section.late .task-section-header { color: #d9534f; border-color: #f5c6cb; }
        .task-section.due-soon .task-section-header { color: #f0ad4e; border-color: #ffeeba; }
        .task-list-container { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
        .taskList { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; list-style: none; padding: 0; margin: 0; }
        .task-card { background-color: #fdfdff; border: 1px solid #e8eaf0; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 10px; transition: all 0.3s ease; position: relative; animation: card-fade-in 0.5s ease-out forwards; }
        .task-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); border-color: #d1d9e6; }
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .task-title { font-size: 1.2em; font-weight: 600; color: #333; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .task-actions { display: flex; gap: 5px; flex-shrink: 0; margin-left: 10px;}
        .task-action-btn { background: #f0f2f5; border: 1px solid #e0e4e9; color: #555; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .task-action-btn:hover { background: #e1e5ea; color: #000; }
        .task-body { display: flex; flex-direction: column; gap: 8px; }
        .task-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; color: white; }
        .badge-event { background: linear-gradient(135deg, #06b6d4, #3b82f6); }
        .badge-assignment { background: linear-gradient(135deg, #f97316, #ef4444); }
        .badge-work { background: linear-gradient(135deg, #10b981, #22c55e); }
        .badge-custom { background: linear-gradient(135deg, #64748b, #475569); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .dot-not-done { background-color: #ef4444; }
        .dot-working { background-color: #f97316; }
        .dot-done { background-color: #22c55e; }
        .task-footer { border-top: 1px solid #f0f2f5; padding-top: 10px; margin-top: 10px; color: #777; font-size: 0.8em; }
        
        /* Modal & Form Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal-content { background: #fff; padding: 35px 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 750px; animation: modal-fade-in-scale 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        .modal-header { text-align: center; margin-bottom: 30px; }
        .modal-header h3 { margin: 0; font-size: 1.8em; color: #333; }
        #taskForm { display: flex; flex-direction: column; gap: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #444; }
        .form-control { width: 100%; box-sizing: border-box; padding: 12px 15px; font-size: 1em; border: 2px solid #e9ecef; border-radius: 8px; transition: all 0.2s ease; background-color: #f8f9fa; font-family: 'SecondaryFont', sans-serif; }
        .form-control:focus { border-color: #8a2be2; box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.15); outline: none; background-color: #fff; }
        .category-input-wrapper { display: flex; gap: 15px; align-items: center; }
        #taskCategory { flex-basis: 100%; transition: flex-basis 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        #customCategoryInput { flex-basis: 0; width: 0; padding-left: 0; padding-right: 0; border-left: 0; border-right: 0; opacity: 0; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .category-group.custom-active #taskCategory { flex-basis: 40%; }
        .category-group.custom-active #customCategoryInput { flex-basis: 60%; width: auto; padding-left: 15px; padding-right: 15px; border-left-width: 2px; border-right-width: 2px; opacity: 1; }
        .custom-checkbox-wrapper { display: flex; align-items: center; gap: 10px; background-color: #f8f9fa; border-radius: 8px; padding: 12px; border: 2px solid transparent; }
        .custom-checkbox { display: block; position: relative; padding-left: 35px; margin-bottom: 0; cursor: pointer; font-size: 1em; user-select: none; font-weight: 600; color: #444; }
        .custom-checkbox input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .checkmark { position: absolute; top: 50%; left: 0; transform: translateY(-50%); height: 24px; width: 24px; background-color: #e0e4e9; border-radius: 6px; transition: all 0.2s ease-in-out; }
        .custom-checkbox:hover input ~ .checkmark { background-color: #c8ced6; }
        .custom-checkbox input:checked ~ .checkmark { background-color: #6720bd; }
        .checkmark:after { content: ""; position: absolute; display: none; left: 9px; top: 5px; width: 5px; height: 10px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
        .custom-checkbox input:checked ~ .checkmark:after { display: block; }
        .modal-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        
        /* Settings Modal */
        #settingsModal .modal-content { padding: 0; }
        #settingsModal .modal-header { padding: 20px 30px; border-bottom: 1px solid #eee; }
        .settings-tabs { display: flex; background-color: #f8f9fa; padding: 5px; border-radius: 12px; margin: 20px 30px; gap: 5px; }
        .tab-button { flex: 1; padding: 10px; background: none; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em; color: #555; transition: all 0.2s ease; }
        .tab-button.active { background: #fff; color: #6720bd; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .tab-panel { display: none; padding: 0 30px 30px; }
        .tab-panel.active { display: block; }
        .view-toggle-wrapper { display: flex; gap: 10px; }
        .view-toggle-wrapper input[type="radio"] { display: none; }
        .view-toggle-wrapper label { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .view-toggle-wrapper input[type="radio"]:checked + label { background-color: #6720bd; border-color: #8a2be2; color: white; box-shadow: 0 2px 8px rgba(103, 32, 189, 0.3); }

        /* Calendar View */
        .calendar-wrapper { overflow: hidden; position: relative; }
        .calendar-container { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
        .calendar-container.slide-out-left { animation: slide-out-left 0.3s forwards; }
        .calendar-container.slide-in-right { animation: slide-in-right 0.3s forwards; }
        .calendar-container.slide-out-right { animation: slide-out-right 0.3s forwards; }
        .calendar-container.slide-in-left { animation: slide-in-left 0.3s forwards; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; text-align: center; }
        #monthYear { font-size: 1.8em; font-weight: bold; }
        #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-header, .day { border-radius: 8px; padding: 8px; }
        .day-header { font-weight: bold; background-color: #f8f9fa; }
        .day { border: 1px solid #e9ecef; min-height: 120px; transition: background-color 0.2s; }
        .day.other-month .day-number { color: #ccc; }
        .day.today .day-number { background-color: #6720bd; color: white; border-radius: 50%; width: 28px; height: 28px; line-height: 28px; display: inline-block; text-align: center; }
        .day-number { font-weight: bold; margin-bottom: 5px; display: block; text-align: left; }
        .calendar-tasks { list-style: none; padding: 0; margin: 0; font-size: 0.8em; max-height: 85px; overflow-y: auto; }
        .calendar-task { background-color: #6720bd; color: white; border-radius: 4px; padding: 3px 6px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .calendar-task:hover { background-color: #8a2be2; }

        /* Custom Flatpickr & Scrollbar Styles */
        .flatpickr-calendar { font-family: 'PrimaryFont', sans-serif; background: #fff; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .flatpickr-day.selected { background: #6720bd !important; border-color: #6720bd !important; }
        .calendar-tasks::-webkit-scrollbar { width: 5px; }
        .calendar-tasks::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }

    </style>
</head>

<body class="dashboard-page">
    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" /></a></div>
            <div class="auth-buttons"><button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button><button id="logoutBtn" class="btn btn-login">LOG OUT</button></div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="apps.html" class="active"><span class="icon">✨</span><span class="label">Apps</span></a></li>
                    <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">Online Planner</h2>
                <div class="header-actions">
                    <button id="newTaskBtn" class="btn btn-primary"><i class="fas fa-plus"></i> New Task</button>
                    <button id="settingsBtn" class="btn btn-icon" title="Settings"><i class="fas fa-cog"></i></button>
                </div>
            </div>

            <div id="listView"></div>
            <div id="calendarView" class="calendar-wrapper" style="display: none;"></div>
        </main>
    </div>

    <div id="taskModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"> <h3 id="modalTitle">Create a New Task</h3> </div>
            <form id="taskForm">
                <div class="form-group"> <label for="taskTitle">Title</label> <input type="text" id="taskTitle" class="form-control" placeholder="What do you need to do?" required> </div>
                <div class="form-group category-group"> <label for="taskCategory">Category</label> <div class="category-input-wrapper"> <select id="taskCategory" class="form-control"> <option value="event">Event</option> <option value="work">Work</option> <option value="assignment">Assignment</option> <option value="custom">Custom</option> </select> <input type="text" id="customCategoryInput" class="form-control" placeholder="Enter custom name..."> </div> </div>
                <div class="form-group" id="dueDateContainer" style="display: none;"> <label>Due Date</label> <div class="custom-checkbox-wrapper"> <label class="custom-checkbox">Set a due date and time <input type="checkbox" id="dueDateToggle"> <span class="checkmark"></span> </label> </div> <input type="text" id="dueDateTimePicker" class="form-control" placeholder="Select date and time..." style="display: none; margin-top: 10px;"> </div>
                <div class="modal-actions"> <button type="button" id="cancelTaskBtn" class="btn btn-secondary">Cancel</button> <button type="submit" class="btn btn-primary">Save Task</button> </div>
            </form>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"> <h3>Settings</h3> </div>
            <div class="settings-tabs"> <button class="tab-button active" data-tab="view">View Options</button> </div>
            <div class="tab-panel active" id="view-tab">
                <div class="settings-section">
                    <label>Default View</label>
                    <div class="view-toggle-wrapper">
                        <input type="radio" id="viewList" name="viewMode" value="list" checked>
                        <label for="viewList">List View</label>
                        <input type="radio" id="viewCalendar" name="viewMode" value="calendar">
                        <label for="viewCalendar">Calendar View</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="menu-overlay"></div>
    <ul id="adminStatusMenu"> <div class="admin-menu-header">SET STATUS</div> <hr class="admin-menu-divider"> <li data-status="not-done">Not Done</li> <li data-status="working">Working On It</li> <li data-status="done">Done</li> </ul>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const auth = firebase.auth();
            let currentUser, db, datePicker, editingTaskId = null, currentView = 'list';
            let calendarDate = new Date();

            const dom = {
                listView: document.getElementById('listView'),
                calendarView: document.getElementById('calendarView'),
                taskModal: document.getElementById('taskModal'),
                taskForm: document.getElementById('taskForm'),
                cancelTaskBtn: document.getElementById('cancelTaskBtn'),
                taskCategorySelect: document.getElementById('taskCategory'),
                customCategoryInput: document.getElementById('customCategoryInput'),
                categoryGroup: document.querySelector('.category-group'),
                dueDateContainer: document.getElementById('dueDateContainer'),
                dueDateToggle: document.getElementById('dueDateToggle'),
                dueDateTimePicker: document.getElementById('dueDateTimePicker'),
                adminStatusMenu: document.getElementById('adminStatusMenu'),
                menuOverlay: document.getElementById('menu-overlay'),
                settingsModal: document.getElementById('settingsModal'),
            };

            datePicker = flatpickr(dom.dueDateTimePicker, { enableTime: true, dateFormat: "Y-m-d H:i", altInput: true, altFormat: "F j, Y at h:i K" });

            function openDB() {
                return new Promise((resolve, reject) => {
                    const r = indexedDB.open(`plannerDB_${currentUser.uid}`, 1);
                    r.onupgradeneeded = e => { if (!e.target.result.objectStoreNames.contains('tasks')) { const s = e.target.result.createObjectStore('tasks', { keyPath: 'id' }); s.createIndex('createdAt', 'createdAt', { unique: false }); } };
                    r.onsuccess = () => resolve(r.result);
                    r.onerror = () => reject(r.error);
                });
            }

            auth.onAuthStateChanged(async user => {
                if (user) { currentUser = user; db = await openDB(); loadInitialView(); } 
                else { window.location.href = '../login.html'; }
            });

            async function loadInitialView() {
                currentView = localStorage.getItem('plannerView') || 'list';
                document.querySelector(`input[name="viewMode"][value="${currentView}"]`).checked = true;
                await switchView(currentView, false);
            }

            async function switchView(view, save = true) {
                currentView = view;
                if (save) localStorage.setItem('plannerView', view);
                dom.listView.style.display = view === 'list' ? 'block' : 'none';
                dom.calendarView.style.display = view === 'calendar' ? 'block' : 'none';
                if (view === 'list') await loadTasksToList(); else await renderCalendar();
            }

            async function loadTasksToList() {
                const tasks = await getAllTasks();
                const now = new Date(), endOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                const threeDaysFromNow = new Date(now); threeDaysFromNow.setDate(now.getDate() + 3);

                const sections = {
                    late: tasks.filter(t => t.dueDate && new Date(t.dueDate) < endOfToday && t.status !== 'done'),
                    dueSoon: tasks.filter(t => t.dueDate && new Date(t.dueDate) >= endOfToday && new Date(t.dueDate) <= threeDaysFromNow && t.status !== 'done'),
                    toDo: tasks.filter(t => t.dueDate && new Date(t.dueDate) > threeDaysFromNow && t.status !== 'done'),
                    general: tasks.filter(t => !t.dueDate && t.status !== 'done'),
                    done: tasks.filter(t => t.status === 'done')
                };

                dom.listView.innerHTML = '';
                const sectionOrder = [{key: 'late', title: 'Late'}, {key: 'dueSoon', title: 'Due Soon'}, {key: 'toDo', title: 'To Do'}, {key: 'general', title: 'General'}, {key: 'done', title: 'Done'}];
                
                let tasksFound = false;
                sectionOrder.forEach(({key, title}) => {
                    if (sections[key].length > 0) {
                        tasksFound = true;
                        const sectionEl = document.createElement('div');
                        sectionEl.className = `task-section ${key}`;
                        sectionEl.innerHTML = `<h3 class="task-section-header">${title}</h3><div class="task-list-container"><ul id="${key}-list" class="taskList"></ul></div>`;
                        dom.listView.appendChild(sectionEl);
                        const listEl = document.getElementById(`${key}-list`);
                        sections[key].sort((a,b) => (a.dueDate || Infinity) - (b.dueDate || Infinity)).forEach(task => listEl.appendChild(createTaskCard(task)));
                    }
                });
                if(!tasksFound) dom.listView.innerHTML = '<p>No tasks found. Create one to get started!</p>';
            }

            async function renderCalendar(animationClass = '') {
                const calendarContainerHTML = `
                    <div class="calendar-container ${animationClass}">
                        <div class="calendar-header">
                            <button id="prevMonth" class="btn btn-icon"><i class="fas fa-chevron-left"></i></button>
                            <h2 id="monthYear"></h2>
                            <button id="nextMonth" class="btn btn-icon"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div id="calendar"></div>
                    </div>`;
                dom.calendarView.innerHTML = calendarContainerHTML;
                
                const monthYearEl = document.getElementById('monthYear');
                const calendarGridEl = document.getElementById('calendar');

                monthYearEl.textContent = calendarDate.toLocaleDateString('default', { month: 'long', year: 'numeric' });
                
                const month = calendarDate.getMonth();
                const year = calendarDate.getFullYear();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysInPrevMonth = new Date(year, month, 0).getDate();

                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                    const header = document.createElement('div'); header.className = 'day-header'; header.textContent = day; calendarGridEl.appendChild(header);
                });

                const allTasks = await getAllTasks();
                const gridCells = [];

                for (let i = firstDayOfMonth; i > 0; i--) {
                    gridCells.push({ day: daysInPrevMonth - i + 1, month: month - 1, year: year, isCurrentMonth: false });
                }
                for (let i = 1; i <= daysInMonth; i++) {
                    gridCells.push({ day: i, month: month, year: year, isCurrentMonth: true });
                }
                const remainingCells = 42 - gridCells.length;
                for (let i = 1; i <= remainingCells; i++) {
                    gridCells.push({ day: i, month: month + 1, year: year, isCurrentMonth: false });
                }

                const today = new Date();
                gridCells.forEach(cellData => {
                    const cellDate = new Date(cellData.year, cellData.month, cellData.day);
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day';
                    if (!cellData.isCurrentMonth) dayCell.classList.add('other-month');
                    if (cellData.day === today.getDate() && cellData.month === today.getMonth() && cellData.year === today.getFullYear()) {
                        dayCell.classList.add('today');
                    }
                    dayCell.innerHTML = `<span class="day-number">${cellData.day}</span><ul class="calendar-tasks"></ul>`;
                    const taskListEl = dayCell.querySelector('.calendar-tasks');
                    
                    allTasks.filter(task => {
                        if (!task.dueDate) return false;
                        const taskDate = new Date(task.dueDate);
                        return taskDate.getFullYear() === cellDate.getFullYear() && taskDate.getMonth() === cellDate.getMonth() && taskDate.getDate() === cellDate.getDate();
                    }).forEach(task => {
                        const taskEl = document.createElement('li');
                        taskEl.className = 'calendar-task';
                        taskEl.textContent = task.title;
                        taskEl.dataset.taskId = task.id;
                        taskListEl.appendChild(taskEl);
                        applyMarqueeIfNeeded(taskEl);
                    });
                    
                    calendarGridEl.appendChild(dayCell);
                });
                
                document.getElementById('prevMonth').addEventListener('click', () => changeMonth(-1));
                document.getElementById('nextMonth').addEventListener('click', () => changeMonth(1));
            }

            function changeMonth(direction) {
                const container = document.querySelector('.calendar-container');
                const outClass = direction === 1 ? 'slide-out-left' : 'slide-out-right';
                const inClass = direction === 1 ? 'slide-in-right' : 'slide-in-left';
                container.classList.add(outClass);
                container.addEventListener('animationend', () => {
                    calendarDate.setMonth(calendarDate.getMonth() + direction);
                    renderCalendar(inClass);
                }, { once: true });
            }

            const dbWrite = (action, data) => new Promise(resolve => { const tx = db.transaction('tasks', 'readwrite'), s = tx.objectStore('tasks'); (action === 'delete' ? s.delete(data) : s.put(data)).onsuccess = resolve; });
            const getAllTasks = () => new Promise(resolve => { db.transaction('tasks', 'readonly').objectStore('tasks').getAll().onsuccess = e => resolve(e.target.result); });
            const getTaskById = (id) => new Promise(resolve => { db.transaction('tasks', 'readonly').objectStore('tasks').get(id).onsuccess = e => resolve(e.target.result); });
            
            const deleteTask = async (id) => { await dbWrite('delete', id); refreshCurrentView(); };
            const saveTask = async (data) => { await dbWrite('put', data); refreshCurrentView(); };
            const refreshCurrentView = () => switchView(currentView, false);

            async function updateTaskStatus(taskId, newStatus) {
                const task = await getTaskById(taskId);
                if (task) { task.status = newStatus; await saveTask(task); }
            }

            function applyMarqueeIfNeeded(element) {
                if (element.scrollWidth > element.clientWidth) {
                    const container = document.createElement('div');
                    container.className = 'marquee-container active';
                    const content = document.createElement('div');
                    content.className = 'marquee-content';
                    content.innerHTML = `<span>${element.textContent}</span><span aria-hidden="true">${element.textContent}</span>`;
                    element.innerHTML = '';
                    element.appendChild(container);
                    container.appendChild(content);
                }
            }

            function createTaskCard(task) {
                const li = document.createElement('li');
                li.className = 'task-card';
                li.dataset.id = task.id;
                const statusInfo = { 'not-done': { text: 'Not Done', dotClass: 'dot-not-done' }, 'working': { text: 'Working On It', dotClass: 'dot-working' }, 'done': { text: 'Done', dotClass: 'dot-done' } }[task.status] || {};
                const categoryName = task.category.name || 'Task';
                const badgeClass = `badge-${task.category.isCustom ? 'custom' : categoryName.toLowerCase()}`;
                const dueDateHTML = task.dueDate ? `<div class="task-footer">Due: <span class="due-date">${new Date(task.dueDate).toLocaleString()}</span></div>` : '';
                li.innerHTML = `<div class="task-header"><div class="marquee-container"><h4 class="task-title">${task.title}</h4></div><div class="task-actions"><button class="task-action-btn status-btn" title="Change Status"><i class="fas fa-list-ul"></i></button><button class="task-action-btn edit-btn" title="Edit Task"><i class="fas fa-edit"></i></button><button class="task-action-btn delete-btn" title="Delete Task"><i class="fas fa-trash"></i></button></div></div><div class="task-body"><div class="task-details"><span class="task-badge ${badgeClass}">${categoryName}</span></div><div class="task-status-indicator" style="display:flex; align-items:center; gap:6px; font-size:0.9em; font-weight:500;"><span class="status-dot ${statusInfo.dotClass}"></span><span>${statusInfo.text}</span></div></div>${dueDateHTML}`;
                li.querySelector('.status-btn').addEventListener('click', e => { e.stopPropagation(); openStatusMenu(e.currentTarget, task.id); });
                li.querySelector('.edit-btn').addEventListener('click', () => openModal(dom.taskModal, task));
                li.querySelector('.delete-btn').addEventListener('click', async () => { if (confirm('Are you sure?')) await deleteTask(task.id); });
                
                setTimeout(() => applyMarqueeIfNeeded(li.querySelector('.task-title')), 0);
                return li;
            }

            function openStatusMenu(button, taskId) {
                const rect = button.getBoundingClientRect();
                dom.adminStatusMenu.style.top = `${rect.bottom + 8}px`;
                dom.adminStatusMenu.style.left = `${rect.right - dom.adminStatusMenu.offsetWidth}px`;
                dom.adminStatusMenu.dataset.taskId = taskId;
                dom.menuOverlay.classList.add('show');
                dom.adminStatusMenu.classList.add('show');
            }
            function closeStatusMenu() { dom.menuOverlay.classList.remove('show'); dom.adminStatusMenu.classList.remove('show'); }

            function openModal(modal, task = null) {
                if(modal.id === 'taskModal') {
                    editingTaskId = task ? task.id : null;
                    document.getElementById('modalTitle').textContent = task ? 'Edit Task' : 'Create a New Task';
                    dom.taskForm.reset();
                    if (task) {
                        document.getElementById('taskTitle').value = task.title;
                        dom.taskCategorySelect.value = task.category.isCustom ? 'custom' : task.category.name.toLowerCase();
                        if (task.category.isCustom) dom.customCategoryInput.value = task.category.name;
                        dom.dueDateToggle.checked = !!task.dueDate;
                        if (task.dueDate) datePicker.setDate(new Date(task.dueDate));
                    }
                    dom.taskCategorySelect.dispatchEvent(new Event('change'));
                    dom.dueDateToggle.dispatchEvent(new Event('change'));
                }
                modal.classList.add('visible');
            }
            function closeModal(modal) { modal.classList.remove('visible'); }

            // Event Listeners
            document.getElementById('newTaskBtn').addEventListener('click', () => openModal(dom.taskModal));
            document.getElementById('settingsBtn').addEventListener('click', () => openModal(dom.settingsModal));
            dom.cancelTaskBtn.addEventListener('click', () => closeModal(dom.taskModal));
            dom.taskModal.addEventListener('click', e => { if (e.target === dom.taskModal) closeModal(dom.taskModal); });
            dom.settingsModal.addEventListener('click', e => { if (e.target.closest('.modal-content') === null) closeModal(dom.settingsModal); });
            dom.menuOverlay.addEventListener('click', closeStatusMenu);
            dom.adminStatusMenu.addEventListener('click', e => { if (e.target.tagName === 'LI') { updateTaskStatus(dom.adminStatusMenu.dataset.taskId, e.target.dataset.status); closeStatusMenu(); } });
            
            dom.calendarView.addEventListener('click', async (e) => {
                const taskEl = e.target.closest('.calendar-task');
                if (taskEl && taskEl.dataset.taskId) {
                    const task = await getTaskById(taskEl.dataset.taskId);
                    if(task) openModal(dom.taskModal, task);
                }
            });

            dom.taskCategorySelect.addEventListener('change', () => {
                const selected = dom.taskCategorySelect.value;
                dom.categoryGroup.classList.toggle('custom-active', selected === 'custom');
                const showDueDateOption = selected === 'work' || selected === 'assignment';
                dom.dueDateContainer.style.display = showDueDateOption ? 'block' : 'none';
                if (!showDueDateOption) { dom.dueDateToggle.checked = false; dom.dueDateToggle.dispatchEvent(new Event('change')); }
            });
            
            dom.dueDateToggle.addEventListener('change', () => { dom.dueDateTimePicker.style.display = dom.dueDateToggle.checked ? 'block' : 'none'; });
            
            dom.taskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const task = await (editingTaskId ? getTaskById(editingTaskId) : {});
                const taskData = {
                    id: editingTaskId || `task_${Date.now()}`,
                    title: document.getElementById('taskTitle').value,
                    category: { isCustom: dom.taskCategorySelect.value === 'custom', name: dom.taskCategorySelect.value === 'custom' ? dom.customCategoryInput.value : dom.taskCategorySelect.options[dom.taskCategorySelect.selectedIndex].text },
                    status: editingTaskId ? task.status : 'not-done',
                    dueDate: dom.dueDateToggle.checked && datePicker.selectedDates.length > 0 ? datePicker.selectedDates[0] : null,
                    createdAt: editingTaskId ? task.createdAt : new Date()
                };
                await saveTask(taskData);
                closeModal(dom.taskModal);
            });

            document.querySelectorAll('input[name="viewMode"]').forEach(radio => { radio.addEventListener('change', (e) => switchView(e.target.value)); });
            document.getElementById('toggleSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
            document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
            document.getElementById('signOutLink').addEventListener('click', (e) => { e.preventDefault(); auth.signOut(); });
        });
    </script>
</body>
</html>
