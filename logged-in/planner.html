<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - PLANNER</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="../panic-key.js"></script>
    <script src="../ban-enforcer.js"></script>
    <script src="../url-changer.js"></script>
    <style>
        /* Base Layout & Theme */
        body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: 'PrimaryFont', sans-serif; }
        .dashboard-container { display: flex; flex: 1; }
        .main-content { flex: 1; padding: 30px; background: #f4f7fa; overflow-y: auto; }

        /* Sidebar */
        .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
        .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; opacity: 1; visibility: visible; transition: opacity 0.2s ease-in-out 0.4s; }
        .sidebar.collapsed nav a .label { opacity: 0; visibility: hidden; transition-delay: 0s; }

        /* Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-title { font-size: 2.2em; font-weight: bold; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0; }
        .btn-primary { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); border: none; color: #fff; padding: 10px 20px; border-radius: 8px; font-family: 'PrimaryFont', sans-serif; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(103, 32, 189, 0.25); }

        /* Task List */
        .task-list-container { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
        #taskList { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; list-style: none; padding: 0; margin: 0; }
        .task-card { background-color: #fdfdff; border: 1px solid #e8eaf0; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 10px; transition: all 0.3s ease; position: relative; }
        .task-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); border-color: #d1d9e6; }
        
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .task-title { font-size: 1.2em; font-weight: 600; color: #333; margin: 0; word-break: break-word; }
        .task-actions { display: flex; gap: 5px; flex-shrink: 0; margin-left: 10px;}
        .task-action-btn { background: #f0f2f5; border: 1px solid #e0e4e9; color: #555; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .task-action-btn:hover { background: #e1e5ea; color: #000; }

        .task-body { display: flex; flex-direction: column; gap: 8px; }
        .task-details { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .task-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; color: white; }
        .badge-event { background: linear-gradient(135deg, #06b6d4, #3b82f6); }
        .badge-assignment { background: linear-gradient(135deg, #f97316, #ef4444); }
        .badge-work { background: linear-gradient(135deg, #10b981, #22c55e); }
        .badge-custom { background: linear-gradient(135deg, #64748b, #475569); }
        
        .task-status-indicator { display: flex; align-items: center; gap: 6px; font-size: 0.9em; font-weight: 500; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .dot-not-done { background-color: #ef4444; }
        .dot-working { background-color: #f97316; }
        .dot-done { background-color: #22c55e; }
        
        .task-footer { border-top: 1px solid #f0f2f5; padding-top: 10px; margin-top: 10px; color: #777; font-size: 0.8em; }
        .due-date { font-weight: 600; }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal-content { background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 550px; transform: scale(0.95); transition: transform 0.3s ease; position: relative; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content::before { content: ''; display: block; padding-top: 56.25%; /* 16:9 aspect ratio */ }
        .modal-content-inner { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; padding: 30px; }
        .modal-content h3 { margin: 0 0 25px; font-size: 1.6em; color: #333; text-align: center; flex-shrink: 0; }
        #taskForm { flex-grow: 1; overflow-y: auto; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; box-sizing: border-box; padding: 12px; font-size: 1em; border: 1px solid #ccc; border-radius: 8px; transition: all 0.2s ease; }
        .form-group input:focus, .form-group select:focus { border-color: #8a2be2; box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.15); outline: none; }
        .modal-actions { margin-top: 30px; display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; }
        .btn-secondary { background: #6c757d; border: none; color: #fff; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .due-date-toggle { display: flex; align-items: center; gap: 10px; margin-top: 10px; }

        /* Admin Menus */
        #adminStatusMenu { opacity: 0; visibility: hidden; transform: translateY(10px); transition: opacity 0.25s ease-out, transform 0.25s ease-out, visibility 0.25s; position: fixed; z-index: 1001; background-color: #ffffff; min-width: 180px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); border-radius: 16px; overflow: hidden; list-style: none; padding: 0; margin: 0; }
        #adminStatusMenu.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .admin-menu-header { padding: 12px 16px; font-family: 'PrimaryFont', sans-serif; color: #333; cursor: default; font-weight: bold; }
        .admin-menu-divider { height: 1px; margin: 0 10px; border: none; background-color: #e0e0e0; }
        #adminStatusMenu li { color: #333; padding: 12px 16px; text-decoration: none; display: block; text-align: left; transition: background-color 0.2s ease-in-out; cursor: pointer; }
        #adminStatusMenu li:hover { background-color: #f1f1f1; }
        #menu-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; background-color: rgba(0,0,0,0.1); z-index: 1000; }
        #menu-overlay.show { opacity: 1; pointer-events: auto; display: block; }

    </style>
</head>

<body class="dashboard-page">
    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" /></a></div>
            <div class="auth-buttons"><button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button><button id="logoutBtn" class="btn btn-login">LOG OUT</button></div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <button id="toggleSidebar">‚ò∞</button>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="apps.html" class="active"><span class="icon">‚ú®</span><span class="label">Apps</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">Online Planner</h2>
                <button id="newTaskBtn" class="btn-primary"><i class="fas fa-plus"></i> New Task</button>
            </div>
            <div class="task-list-container">
                <ul id="taskList"></ul>
            </div>
        </main>
    </div>

    <div id="taskModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-content-inner">
                <h3 id="modalTitle">New Task</h3>
                <form id="taskForm">
                    <div class="form-group">
                        <label for="taskTitle">Title</label>
                        <input type="text" id="taskTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="taskCategory">Category</label>
                        <select id="taskCategory">
                            <option value="work">Work</option>
                            <option value="event">Event</option>
                            <option value="assignment">Assignment</option>
                            <option value="custom">Custom</option>
                        </select>
                        <input type="text" id="customCategoryInput" placeholder="Enter custom category name" style="display: none; margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <div class="due-date-toggle">
                            <input type="checkbox" id="dueDateToggle" style="width: auto; margin-right: 8px;">
                            <label for="dueDateToggle">Has Due Date</label>
                        </div>
                        <input type="text" id="dueDateTimePicker" placeholder="Select due date and time..." style="display: none; margin-top: 10px;">
                    </div>
                </form>
                <div class="modal-actions">
                    <button type="button" id="cancelTaskBtn" class="btn-secondary">Cancel</button>
                    <button type="submit" form="taskForm" class="btn-primary">Save Task</button>
                </div>
            </div>
        </div>
    </div>

    <div id="menu-overlay"></div>
    <ul id="adminStatusMenu">
      <div class="admin-menu-header">SET STATUS</div>
      <hr class="admin-menu-divider">
      <li data-status="not-done">Not Done</li>
      <li data-status="working">Working On It</li>
      <li data-status="done">Done</li>
    </ul>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const auth = firebase.auth();
            let currentUser;
            let db;
            let datePicker;

            // DOM Elements
            const taskList = document.getElementById('taskList');
            const newTaskBtn = document.getElementById('newTaskBtn');
            const taskModal = document.getElementById('taskModal');
            const taskForm = document.getElementById('taskForm');
            const cancelTaskBtn = document.getElementById('cancelTaskBtn');
            const taskCategorySelect = document.getElementById('taskCategory');
            const customCategoryInput = document.getElementById('customCategoryInput');
            const dueDateToggle = document.getElementById('dueDateToggle');
            const dueDateTimePicker = document.getElementById('dueDateTimePicker');
            const adminStatusMenu = document.getElementById('adminStatusMenu');
            const menuOverlay = document.getElementById('menu-overlay');
            let editingTaskId = null;

            // Initialize Flatpickr
            datePicker = flatpickr(dueDateTimePicker, {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                altInput: true,
                altFormat: "F j, Y at h:i K",
            });
            
            // --- IndexedDB ---
            function openDB() {
                return new Promise((resolve, reject) => {
                    const dbName = `plannerDB_${currentUser.uid}`;
                    const request = indexedDB.open(dbName, 1);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('tasks')) {
                           const store = db.createObjectStore('tasks', { keyPath: 'id' });
                           store.createIndex('createdAt', 'createdAt', { unique: false });
                        }
                    };
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            auth.onAuthStateChanged(async user => {
                if (user) {
                    currentUser = user;
                    db = await openDB();
                    loadTasks();
                } else {
                    window.location.href = '../login.html';
                }
            });

            async function loadTasks() {
                taskList.innerHTML = '<li>Loading tasks...</li>';
                const transaction = db.transaction('tasks', 'readonly');
                const store = transaction.objectStore('tasks');
                const index = store.index('createdAt');
                const request = index.getAll();

                request.onsuccess = () => {
                    const tasks = request.result.sort((a,b) => b.createdAt - a.createdAt); // Manual sort descending
                    if (tasks.length === 0) {
                        taskList.innerHTML = '<li>No tasks found. Create one to get started!</li>';
                        return;
                    }
                    taskList.innerHTML = '';
                    tasks.forEach(task => {
                        const card = createTaskCard(task);
                        taskList.appendChild(card);
                    });
                };
                 request.onerror = () => {
                    taskList.innerHTML = '<li>Error loading tasks.</li>';
                }
            }
            
            async function deleteTask(taskId) {
                const transaction = db.transaction('tasks', 'readwrite');
                const store = transaction.objectStore('tasks');
                const request = store.delete(taskId);
                request.onsuccess = () => loadTasks();
            }
            
            async function saveTask(taskData) {
                 const transaction = db.transaction('tasks', 'readwrite');
                 const store = transaction.objectStore('tasks');
                 const request = store.put(taskData);
                 request.onsuccess = () => loadTasks();
            }

            async function updateTaskStatus(taskId, newStatus) {
                const transaction = db.transaction('tasks', 'readwrite');
                const store = transaction.objectStore('tasks');
                const request = store.get(taskId);

                request.onsuccess = () => {
                    const task = request.result;
                    if (task) {
                        task.status = newStatus;
                        const updateRequest = store.put(task);
                        updateRequest.onsuccess = () => loadTasks();
                    }
                };
            }

            function createTaskCard(task) {
                const li = document.createElement('li');
                li.className = 'task-card';
                li.dataset.id = task.id;

                const statusInfo = {
                    'not-done': { text: 'Not Done', dotClass: 'dot-not-done' },
                    'working': { text: 'Working On It', dotClass: 'dot-working' },
                    'done': { text: 'Done', dotClass: 'dot-done' }
                }[task.status] || { text: 'Unknown', dotClass: '' };
                
                let categoryHTML = '';
                if (task.category.isCustom) {
                    categoryHTML = `<span class="task-badge badge-custom">${task.category.name}</span>`;
                } else {
                    const badgeClass = `badge-${task.category.name.toLowerCase()}`;
                    categoryHTML = `<span class="task-badge ${badgeClass}">${task.category.name}</span>`;
                }
                
                let dueDateHTML = '';
                if(task.dueDate) {
                    const date = new Date(task.dueDate);
                    dueDateHTML = `<div class="task-footer">Due: <span class="due-date">${date.toLocaleString()}</span></div>`;
                }

                li.innerHTML = `
                    <div class="task-header">
                        <h4 class="task-title">${task.title}</h4>
                        <div class="task-actions">
                            <button class="task-action-btn status-btn"><i class="fas fa-list-ul"></i></button>
                            <button class="task-action-btn edit-btn"><i class="fas fa-edit"></i></button>
                            <button class="task-action-btn delete-btn"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="task-body">
                         <div class="task-details">
                            <span class="task-badge badge-${task.type}">${task.category.name}</span>
                         </div>
                        <div class="task-status-indicator">
                            <span class="status-dot ${statusInfo.dotClass}"></span>
                            <span>${statusInfo.text}</span>
                        </div>
                    </div>
                    ${dueDateHTML}
                `;

                li.querySelector('.status-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openStatusMenu(e.currentTarget, task.id);
                });
                li.querySelector('.edit-btn').addEventListener('click', () => openModal(task));
                li.querySelector('.delete-btn').addEventListener('click', async () => {
                    if (confirm('Are you sure you want to delete this task?')) {
                       await deleteTask(task.id);
                    }
                });

                return li;
            }

            function openStatusMenu(button, taskId) {
                const rect = button.getBoundingClientRect();
                adminStatusMenu.style.top = `${rect.bottom + 8}px`;
                adminStatusMenu.style.left = `${rect.right - adminStatusMenu.offsetWidth}px`;
                adminStatusMenu.dataset.taskId = taskId;
                menuOverlay.classList.add('show');
                adminStatusMenu.classList.add('show');
            }

            function closeStatusMenu() {
                menuOverlay.classList.remove('show');
                adminStatusMenu.classList.remove('show');
            }

            function openModal(task = null) {
                editingTaskId = task ? task.id : null;
                document.getElementById('modalTitle').textContent = task ? 'Edit Task' : 'New Task';
                taskForm.reset();
                
                if (task) {
                    document.getElementById('taskTitle').value = task.title;
                    
                    if(task.category.isCustom) {
                        taskCategorySelect.value = 'custom';
                        customCategoryInput.style.display = 'block';
                        customCategoryInput.value = task.category.name;
                    } else {
                        taskCategorySelect.value = task.category.name.toLowerCase();
                        customCategoryInput.style.display = 'none';
                    }
                    
                    if(task.dueDate) {
                        dueDateToggle.checked = true;
                        dueDateTimePicker.style.display = 'block';
                        datePicker.setDate(new Date(task.dueDate));
                    } else {
                        dueDateToggle.checked = false;
                        dueDateTimePicker.style.display = 'none';
                        datePicker.clear();
                    }

                } else {
                    customCategoryInput.style.display = 'none';
                    dueDateTimePicker.style.display = 'none';
                    dueDateToggle.checked = false;
                    datePicker.clear();
                }
                
                taskModal.classList.add('visible');
            }

            function closeModal() {
                taskModal.classList.remove('visible');
            }

            // Event Listeners
            newTaskBtn.addEventListener('click', () => openModal());
            cancelTaskBtn.addEventListener('click', closeModal);
            taskModal.addEventListener('click', (e) => {
                if (e.target === taskModal) closeModal();
            });
            menuOverlay.addEventListener('click', closeStatusMenu);
            adminStatusMenu.addEventListener('click', (e) => {
                if (e.target.tagName === 'LI') {
                    const taskId = adminStatusMenu.dataset.taskId;
                    const newStatus = e.target.dataset.status;
                    if (taskId && newStatus) {
                        updateTaskStatus(taskId, newStatus);
                    }
                    closeStatusMenu();
                }
            });

            taskCategorySelect.addEventListener('change', () => {
                customCategoryInput.style.display = taskCategorySelect.value === 'custom' ? 'block' : 'none';
            });
            
            dueDateToggle.addEventListener('change', () => {
                dueDateTimePicker.style.display = dueDateToggle.checked ? 'block' : 'none';
            });

            taskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const taskData = {
                    id: editingTaskId || `task_${Date.now()}`,
                    title: document.getElementById('taskTitle').value,
                    category: {
                        isCustom: taskCategorySelect.value === 'custom',
                        name: taskCategorySelect.value === 'custom' ? customCategoryInput.value : taskCategorySelect.options[taskCategorySelect.selectedIndex].text
                    },
                    status: 'not-done', // Default status for new/edited tasks
                    dueDate: dueDateToggle.checked && datePicker.selectedDates.length > 0 ? datePicker.selectedDates[0] : null,
                    createdAt: editingTaskId ? undefined : new Date() // Only set on creation
                };

                // Retrieve existing data if editing to preserve status and createdAt
                if (editingTaskId) {
                    const transaction = db.transaction('tasks', 'readonly');
                    const store = transaction.objectStore('tasks');
                    const request = store.get(editingTaskId);
                    request.onsuccess = () => {
                        const existingTask = request.result;
                        if(existingTask) {
                           taskData.createdAt = existingTask.createdAt;
                           taskData.status = existingTask.status; // Preserve existing status
                        }
                        saveTask(taskData);
                    }
                } else {
                      await saveTask(taskData);
                }

                closeModal();
            });

            // Sidebar and Logout
            document.getElementById('toggleSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
            document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
            document.getElementById('signOutLink').addEventListener('click', (e) => { e.preventDefault(); auth.signOut(); });
        });
    </script>
</body>
</html>
