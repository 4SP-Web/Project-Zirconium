<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - APPLE MUSIC</title>
  <link rel="stylesheet" href="../css/style.css" />
  <script src="../panic-key.js"></script>
  <script src="../ban-enforcer.js"></script>
  <script src="../url-changer.js"></script>

  <style>
    :root {
      --bg-primary: #121212;
      --bg-secondary: #1c1c1e;
      --bg-tertiary: #2c2c2e;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --text-tertiary: #7d7d7d;
      --accent-pink: #fa2d55;
      --border-color: #38383a;
      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    /* --- Base Layout --- */
    html { box-sizing: border-box; }
    *, *:before, *:after { box-sizing: inherit; }
    
    body {
      margin: 0;
      font-family: var(--font-family);
      background-color: var(--bg-primary);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden; /* Prevent body scroll */
    }

    .hidden { display: none !important; }

    .music-app-layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      grid-template-rows: 1fr auto;
      height: 100vh;
      width: 100vw;
    }

    /* --- Sidebar --- */
    .sidebar {
      grid-column: 1 / 2;
      grid-row: 1 / 2;
      background-color: var(--bg-secondary);
      padding: 20px 8px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border-color);
    }
    
    .sidebar-search {
      padding: 0 12px 20px 12px;
    }
    .sidebar-search input {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 14px;
    }
    .sidebar-search input::placeholder { color: var(--text-tertiary); }
    .sidebar-search input:focus { outline: none; border-color: var(--accent-pink); }

    .sidebar nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .sidebar nav li a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      text-decoration: none;
      color: var(--text-secondary);
      font-weight: 500;
      border-radius: 6px;
      transition: background-color 0.2s, color 0.2s;
    }
    .sidebar nav li a:hover {
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
    }
    .sidebar nav li a.active {
      background-color: var(--accent-pink);
      color: var(--text-primary);
    }
    .sidebar .nav-section {
      padding: 10px 0;
    }
    .sidebar .nav-section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-tertiary);
      padding: 0 12px 8px 12px;
      text-transform: uppercase;
    }

    /* --- Main Content --- */
    .main-content {
      grid-column: 2 / 3;
      grid-row: 1 / 2;
      overflow-y: auto;
      padding: 30px;
    }

    .view-header { font-size: 28px; font-weight: 700; margin: 0 0 30px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
    
    .content-shelf { margin-bottom: 40px; }
    .shelf-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 15px; }
    .shelf-title { font-size: 20px; font-weight: 600; margin: 0; }
    .shelf-more { font-size: 14px; color: var(--accent-pink); text-decoration: none; font-weight: 500; }
    
    .shelf-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 20px;
    }
    .shelf-row {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding-bottom: 15px; /* For scrollbar */
      /* Hide scrollbar visually */
      scrollbar-width: none; /* Firefox */
    }
    .shelf-row::-webkit-scrollbar { display: none; }
    .shelf-row .content-card { flex-shrink: 0; width: 160px; }

    .content-card {
      cursor: pointer;
    }
    .content-card-artwork {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 8px;
      background-color: var(--bg-tertiary);
      margin-bottom: 10px;
      overflow: hidden;
      transition: transform 0.2s ease;
    }
    .content-card:hover .content-card-artwork { transform: scale(1.03); }
    .content-card-artwork img { width: 100%; height: 100%; object-fit: cover; }
    .content-card-title { font-size: 14px; font-weight: 500; color: var(--text-primary); margin: 0 0 4px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .content-card-subtitle { font-size: 13px; color: var(--text-secondary); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* Search/Library List View */
    .list-view-item {
        display: grid;
        grid-template-columns: 50px 1fr auto auto;
        gap: 15px;
        align-items: center;
        padding: 10px;
        border-radius: 8px;
        transition: background-color 0.2s;
    }
    .list-view-item:hover { background-color: var(--bg-secondary); }
    .list-view-item:hover .list-view-actions { opacity: 1; }
    .list-view-artwork img { width: 40px; height: 40px; border-radius: 4px; }
    .list-view-info { display: flex; flex-direction: column; overflow: hidden; }
    .list-view-title { font-size: 15px; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .list-view-subtitle { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .list-view-duration { font-size: 14px; color: var(--text-secondary); }
    .list-view-actions { opacity: 0; transition: opacity 0.2s; }
    .list-view-actions button { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 18px; padding: 5px; }
    .list-view-actions button:hover { color: var(--text-primary); }

    /* --- Player Bar --- */
    .player-bar {
      grid-column: 1 / 3;
      grid-row: 2 / 3;
      height: 90px;
      background-color: #000;
      border-top: 1px solid var(--border-color);
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      align-items: center;
      padding: 0 30px;
      gap: 30px;
    }
    
    .player-song-info { display: flex; align-items: center; gap: 12px; overflow: hidden; }
    .player-song-info img { width: 50px; height: 50px; border-radius: 4px; }
    .player-song-info div { overflow: hidden; }
    #player-title { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #player-artist { font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .player-center-controls { display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .player-buttons { display: flex; align-items: center; gap: 20px; }
    .player-buttons button { background: none; border: none; color: var(--text-primary); cursor: pointer; font-size: 18px; }
    .player-buttons .play-pause-btn { font-size: 28px; }
    
    .progress-container { display: flex; align-items: center; width: 100%; gap: 10px; }
    .progress-container span { font-size: 11px; color: var(--text-tertiary); }
    #progress-bar { flex-grow: 1; -webkit-appearance: none; appearance: none; height: 4px; background: #4d4d4d; border-radius: 2px; outline: none; cursor: pointer; }
    #progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; background: var(--text-primary); border-radius: 50%; }

    .player-right-controls { display: flex; justify-content: flex-end; align-items: center; gap: 15px; }
    .player-right-controls button { background: none; border: none; color: var(--text-primary); cursor: pointer; font-size: 18px; }
    .volume-container { display: flex; align-items: center; gap: 8px; }
    #volume-slider { -webkit-appearance: none; width: 100px; height: 4px; background: #4d4d4d; border-radius: 2px; cursor: pointer; }
    #volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--text-primary); border-radius: 50%; }

    /* Utility */
    .empty-state { text-align: center; padding: 50px; color: var(--text-secondary); }
    .loader { margin: 40px auto; width: 40px; height: 40px; border: 4px solid var(--bg-tertiary); border-top-color: var(--accent-pink); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>
  <div class="music-app-layout">
    
    <aside class="sidebar">
      <div class="sidebar-search">
        <input type="search" id="sidebarSearchInput" placeholder="Search Library">
      </div>
      <nav>
        <ul class="nav-section">
          <li><a href="#" class="active" data-view="home">üè† Home</a></li>
          <li><a href="#">‚ú® New</a></li>
          <li><a href="#">üìª Radio</a></li>
        </ul>
        <div class="nav-section-title">Library</div>
        <ul class="nav-section">
          <li><a href="#" data-view="library">üéµ Songs</a></li>
          <li><a href="#" data-view="playlists">üé∂ Playlists</a></li>
          <li><a href="#">üé§ Artists</a></li>
          <li><a href="#">üíø Albums</a></li>
          <li><a href="#">‚ûï Recently Added</a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content" id="main-content-area">
      </main>

    <footer class="player-bar">
      <div class="player-song-info">
        <img id="player-thumbnail" src="" alt="">
        <div>
          <div id="player-title">Select a song to play</div>
          <div id="player-artist"></div>
        </div>
      </div>

      <div class="player-center-controls">
        <div class="player-buttons">
          <button id="prev-btn" title="Previous">‚èÆÔ∏è</button>
          <button id="play-pause-btn" class="play-pause-btn" title="Play/Pause">‚ñ∂Ô∏è</button>
          <button id="next-btn" title="Next">‚è≠Ô∏è</button>
        </div>
        <div class="progress-container">
          <span id="current-time">0:00</span>
          <input type="range" id="progress-bar" value="0" min="0" max="100">
          <span id="total-time">0:00</span>
        </div>
      </div>

      <div class="player-right-controls">
        <button title="Lyrics">üí¨</button>
        <button title="Queue">‚ò∞</button>
        <div class="volume-container">
          <span>üîâ</span>
          <input type="range" id="volume-slider" min="0" max="100" value="100">
        </div>
      </div>
    </footer>

  </div>

  <div id="youtube-player" style="position: absolute; top: -9999px; left: -9999px;"></div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>
  <script>
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    // --- APPLICATION LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        firebase.auth().onAuthStateChanged(user => { 
            if (!user) location.href = '../login.html';
            else initializeApp(user);
        });
    });

    // --- GLOBAL STATE ---
    let ytPlayer, db;
    let currentQueue = [];
    let currentQueueIndex = -1;
    let progressInterval;
    
    // ===================================================================================
    // ===================================================================================
    //
    //   IMPORTANT: YOUTUBE DATA API v3 KEY
    //
    //   You MUST provide your own API key here for the application to work.
    //   This key enables searching for songs and fetching their details.
    //
    //   How to get a key:
    //   1. Go to the Google Cloud Console: https://console.cloud.google.com/
    //   2. Create a new project.
    //   3. In the project dashboard, go to "APIs & Services" > "Library".
    //   4. Search for "YouTube Data API v3" and enable it.
    //   5. Go to "APIs & Services" > "Credentials".
    //   6. Click "Create Credentials" > "API key".
    //   7. Copy the generated key and paste it below.
    //
    // ===================================================================================
    // ===================================================================================
    const YOUTUBE_API_KEY = "AIzaSyDr-7S85ZIgyhN0DDvT_IUJUMtqJqb3X00"; // <--- PASTE YOUR API KEY HERE (e.g., "AIzaSy..._YOUR_KEY")

    async function initializeApp(user) {
        db = await initDB();
        
        setupNavigation();
        setupPlayerControls();

        switchView('home');
        
        const searchInput = document.getElementById('sidebarSearchInput');
        searchInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') {
                const query = searchInput.value.trim();
                if(query) {
                    document.querySelector('.sidebar nav a.active').classList.remove('active');
                    switchView('search', query);
                }
            }
        });
    }

    // --- YOUTUBE PLAYER & DATA API ---
    function onYouTubeIframeAPIReady() { ytPlayer = new YT.Player('youtube-player', { height: '1', width: '1', playerVars: { 'autoplay': 0, 'controls': 0, 'rel': 0 }, events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }}); }
    function onPlayerReady(event) { event.target.setVolume(document.getElementById('volume-slider').value); }
    function onPlayerStateChange(event) { if (event.data === YT.PlayerState.ENDED) playNextSong(); document.getElementById('play-pause-btn').innerHTML = (event.data === YT.PlayerState.PLAYING) ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'; if (event.data === YT.PlayerState.PLAYING) startProgressInterval(); else stopProgressInterval(); }

    async function searchYouTube(query) {
        if (!YOUTUBE_API_KEY) { alert('ERROR: The YouTube API Key is missing from the code.'); return []; }
        const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&maxResults=50&key=${YOUTUBE_API_KEY}`;
        try {
            const response = await fetch(url);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error (${response.status}): ${errorData.error.message}`);
            }
            const data = await response.json();
            return data.items;
        } catch (error) {
            console.error("YouTube Search API error:", error);
            alert(`Search failed: ${error.message}\n\nThis is often caused by an invalid or restricted API key.`);
            return [];
        }
    }
    
    async function getVideoDetails(videoId) {
        if (!YOUTUBE_API_KEY) { alert('ERROR: The YouTube API Key is missing from the code.'); return null; }
        const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${videoId}&key=${YOUTUBE_API_KEY}`;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`API Error (${response.status})`);
            const data = await response.json();
            return data.items[0];
        } catch (error) {
            console.error("YouTube Video Details API error:", error);
            return null;
        }
    }

    // --- INDEXEDDB HELPERS ---
    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open("AppleMusicCloneDB_v1", 1);
            request.onerror = e => reject("DB error: " + e.target.errorCode);
            request.onsuccess = e => resolve(e.target.result);
            request.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains("songs")) {
                    const songStore = db.createObjectStore("songs", { keyPath: "id" });
                    songStore.createIndex("addedAt", "addedAt");
                }
                if (!db.objectStoreNames.contains("playlists")) db.createObjectStore("playlists", { keyPath: "id", autoIncrement: true });
                if (!db.objectStoreNames.contains("history")) db.createObjectStore("history", { keyPath: "playedAt" });
            };
        });
    }

    function dbRequest(storeName, mode, action, data) {
        return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, mode);
            const store = tx.objectStore(storeName);
            const req = store[action](data);
            tx.oncomplete = () => resolve(action === 'getAll' || action === 'get' || action === 'getAllKeys' ? req.result : undefined);
            tx.onerror = e => reject(`Transaction error on ${storeName}: ${e.target.error}`);
        });
    }

    // --- API & HELPERS ---
    async function censorText(text) { if (!text) return ''; try { const r = await fetch(`https://www.purgomalum.com/service/json?text=${encodeURIComponent(text)}`); if (!r.ok) return text; const d = await r.json(); return d.result; } catch (e) { return text; } }
    function formatTime(s) { const min = Math.floor(s / 60); const sec = Math.floor(s % 60).toString().padStart(2, '0'); return `${min}:${sec}`; }
    function parseYTDuration(iso) { const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/); return (parseInt(m[1] || 0) * 3600) + (parseInt(m[2] || 0) * 60) + (parseInt(m[3] || 0)); }

    // --- CORE FUNCTIONALITY ---
    async function addSongToLibrary(videoId) {
        if (await dbRequest('songs', 'readonly', 'get', videoId)) { alert("This song is already in your library."); return; }
        const details = await getVideoDetails(videoId);
        if (!details) { alert("Could not fetch song details."); return; }
        const censoredTitle = await censorText(details.snippet.title);
        const newSong = { id: videoId, title: details.snippet.title, censoredTitle: censoredTitle, artist: details.snippet.channelTitle, thumbnailUrl: details.snippet.thumbnails.high.url, duration: parseYTDuration(details.contentDetails.duration), addedAt: new Date().toISOString() };
        await dbRequest('songs', 'readwrite', 'add', newSong);
        alert(`"${newSong.title}" added to library!`);
    }

    async function playSong(songId) {
        const song = await dbRequest('songs', 'readonly', 'get', songId);
        if(!song) { alert("Song not in library. Please add it first."); return; }

        currentQueue = [songId];
        currentQueueIndex = 0;
        await loadAndPlayCurrentSong();
    }

    async function loadAndPlayCurrentSong() {
        if (currentQueueIndex < 0 || currentQueueIndex >= currentQueue.length) { document.getElementById('player-title').textContent = "Queue finished."; return; }
        const songId = currentQueue[currentQueueIndex];
        const song = await dbRequest('songs', 'readonly', 'get', songId);
        if (!song) { playNextSong(); return; }
        ytPlayer.loadVideoById(songId);
        document.getElementById('player-title').textContent = song.censoredTitle;
        document.getElementById('player-artist').textContent = song.artist;
        document.getElementById('player-thumbnail').src = song.thumbnailUrl;
        
        // Add to history
        await dbRequest('history', 'readwrite', 'put', { songId: song.id, playedAt: new Date().toISOString() });
    }
    
    function playNextSong() { if (currentQueueIndex < currentQueue.length - 1) { currentQueueIndex++; loadAndPlayCurrentSong(); } }
    function playPrevSong() { if (ytPlayer.getCurrentTime() > 3 || currentQueueIndex === 0) ytPlayer.seekTo(0); else if (currentQueueIndex > 0) { currentQueueIndex--; loadAndPlayCurrentSong(); } }

    // --- UI RENDERING & NAVIGATION ---
    const mainContentArea = document.getElementById('main-content-area');

    function setupNavigation() { 
        document.querySelectorAll('.sidebar nav a[data-view]').forEach(link => link.addEventListener('click', e => { 
            e.preventDefault(); 
            document.querySelector('.sidebar nav a.active')?.classList.remove('active');
            link.classList.add('active');
            switchView(link.dataset.view); 
        }));
    }

    async function switchView(viewName, query = null) {
        mainContentArea.innerHTML = '<div class="loader"></div>';
        let viewHtml = '';

        switch (viewName) {
            case 'home':
                viewHtml = await renderHomeView();
                break;
            case 'search':
                viewHtml = await renderSearchView(query);
                break;
            case 'library':
                viewHtml = await renderLibraryView();
                break;
            case 'playlists':
                viewHtml = await renderPlaylistsView();
                break;
            default:
                viewHtml = `<h1 class="view-header">Page not found</h1>`;
        }
        mainContentArea.innerHTML = viewHtml;
        attachEventListenersForView(viewName);
    }

    async function renderHomeView() {
        const recentlyAddedTx = db.transaction('songs', 'readonly');
        const addedIndex = recentlyAddedTx.objectStore('songs').index('addedAt');
        const recentlyAdded = await new Promise(resolve => {
            const songs = [];
            const request = addedIndex.openCursor(null, 'prev'); // Get newest first
            request.onsuccess = e => {
                const cursor = e.target.result;
                if (cursor && songs.length < 10) {
                    songs.push(cursor.value);
                    cursor.continue();
                } else {
                    resolve(songs);
                }
            };
        });

        const playlists = await dbRequest('playlists', 'readonly', 'getAll');

        return `
            <h1 class="view-header">Home</h1>
            ${playlists.length > 0 ? `
            <section class="content-shelf">
                <div class="shelf-header"><h2 class="shelf-title">Your Playlists</h2></div>
                <div class="shelf-row">${playlists.map(p => createCardHTML(p, 'playlist')).join('')}</div>
            </section>` : ''}
            ${recentlyAdded.length > 0 ? `
            <section class="content-shelf">
                <div class="shelf-header"><h2 class="shelf-title">Recently Added</h2></div>
                <div class="shelf-row">${recentlyAdded.map(s => createCardHTML(s, 'song')).join('')}</div>
            </section>` : '<div class="empty-state">Add some music to get started!</div>'}
        `;
    }
    
    async function renderSearchView(query) {
        const searchResults = await searchYouTube(query);
        const songsInLibrary = await dbRequest('songs', 'readonly', 'getAllKeys');
        
        let content = '';
        if (searchResults.length === 0) {
            content = '<div class="empty-state">No results found for "' + query + '".</div>';
        } else {
            content = searchResults.map(item => {
                const videoId = item.id.videoId;
                const inLibrary = songsInLibrary.includes(videoId);
                return createListItemHTML({
                    id: videoId,
                    thumbnailUrl: item.snippet.thumbnails.default.url,
                    censoredTitle: item.snippet.title,
                    artist: item.snippet.channelTitle
                }, 'search', inLibrary);
            }).join('');
        }
        return `<h1 class="view-header">Search Results for "${query}"</h1><div>${content}</div>`;
    }

    async function renderLibraryView() {
        const songs = await dbRequest('songs', 'readonly', 'getAll');
        if (!songs || songs.length === 0) {
            return `<h1 class="view-header">Songs</h1><div class="empty-state">Your library is empty.</div>`;
        }
        songs.sort((a,b) => a.title.localeCompare(b.title));
        const songList = songs.map(song => createListItemHTML(song, 'library')).join('');
        return `<h1 class="view-header">Songs (${songs.length})</h1><div>${songList}</div>`;
    }
    
    async function renderPlaylistsView() {
        const playlists = await dbRequest('playlists', 'readonly', 'getAll');
         if (!playlists || playlists.length === 0) {
            return `<h1 class="view-header">Playlists</h1><div class="empty-state">You have no playlists.</div>`;
        }
        const playlistGrid = playlists.map(p => createCardHTML(p, 'playlist')).join('');
        return `<h1 class="view-header">Playlists</h1><div class="shelf-grid">${playlistGrid}</div>`;
    }

    function createCardHTML(item, type) {
        if (type === 'song') {
            return `
                <div class="content-card" data-song-id="${item.id}">
                    <div class="content-card-artwork"><img src="${item.thumbnailUrl}" alt="${item.title}" loading="lazy"></div>
                    <div class="content-card-title">${item.censoredTitle}</div>
                    <div class="content-card-subtitle">${item.artist}</div>
                </div>`;
        }
        if (type === 'playlist') {
            return `
                <div class="content-card" data-playlist-id="${item.id}">
                    <div class="content-card-artwork" style="background-color: #333; display:flex; align-items:center; justify-content:center; font-size:40px;">üé∂</div>
                    <div class="content-card-title">${item.name}</div>
                    <div class="content-card-subtitle">${item.songIds.length} Songs</div>
                </div>`;
        }
    }

    function createListItemHTML(item, context, inLibrary = false) {
        const actions = context === 'search'
            ? `<button title="Add to Library" class="add-btn" ${inLibrary ? 'disabled' : ''}>${inLibrary ? '‚úîÔ∏è' : '‚ûï'}</button>`
            : `<button title="Play" class="play-btn">‚ñ∂Ô∏è</button>`;

        return `
            <div class="list-view-item" data-song-id="${item.id}">
                <div class="list-view-artwork"><img src="${item.thumbnailUrl}" loading="lazy"></div>
                <div class="list-view-info">
                    <div class="list-view-title">${item.censoredTitle}</div>
                    <div class="list-view-subtitle">${item.artist}</div>
                </div>
                <div class="list-view-duration">${item.duration ? formatTime(item.duration) : ''}</div>
                <div class="list-view-actions">${actions}</div>
            </div>
        `;
    }
    
    function attachEventListenersForView(viewName) {
        if (viewName === 'home' || viewName === 'playlists') {
            mainContentArea.querySelectorAll('.content-card[data-song-id]').forEach(card => 
                card.addEventListener('click', e => playSong(e.currentTarget.dataset.songId))
            );
        }
        if (viewName === 'search') {
            mainContentArea.querySelectorAll('.list-view-item .add-btn:not(:disabled)').forEach(btn => 
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const songId = e.currentTarget.closest('.list-view-item').dataset.songId;
                    addSongToLibrary(songId);
                    e.currentTarget.textContent = '‚úîÔ∏è';
                    e.currentTarget.disabled = true;
                })
            );
        }
        if(viewName === 'library') {
             mainContentArea.querySelectorAll('.list-view-item .play-btn').forEach(btn => 
                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    const songId = e.currentTarget.closest('.list-view-item').dataset.songId;
                    playSong(songId);
                })
            );
        }
    }
    
    // --- PLAYER UI & MODALS ---
    function setupPlayerControls() {
        document.getElementById('play-pause-btn').addEventListener('click', () => { if (!ytPlayer) return; const s = ytPlayer.getPlayerState(); if (s === YT.PlayerState.PLAYING) ytPlayer.pauseVideo(); else ytPlayer.playVideo(); });
        document.getElementById('next-btn').addEventListener('click', playNextSong);
        document.getElementById('prev-btn').addEventListener('click', playPrevSong);
        document.getElementById('progress-bar').addEventListener('input', e => { const d = ytPlayer.getDuration(); ytPlayer.seekTo(d * (e.target.value / 100), true); });
        document.getElementById('volume-slider').addEventListener('input', e => { ytPlayer.setVolume(e.target.value); });
    }

    function startProgressInterval() { stopProgressInterval(); progressInterval = setInterval(() => { const c = ytPlayer.getCurrentTime(), d = ytPlayer.getDuration(); document.getElementById('current-time').textContent = formatTime(c); document.getElementById('total-time').textContent = formatTime(d); document.getElementById('progress-bar').value = d > 0 ? (c / d) * 100 : 0; }, 500); }
    function stopProgressInterval() { clearInterval(progressInterval); }
  </script>
</body>
</html>
