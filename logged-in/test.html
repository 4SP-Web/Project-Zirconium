<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - VERN SOCIAL (Remastered)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles & Overrides */
        :root {
            --color-accent: #6720bd;
            --color-accent-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
        }
        .chat-messages-container {
            background-color: #e5ddd5;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        /* Scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden flex flex-col">

    <header class="bg-white shadow-md z-30">
        <div class="container mx-auto px-4 py-2 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">Vern Social</h1>
            <div class="flex items-center gap-4">
                <span id="currentUserDisplay" class="text-sm text-gray-600 hidden"></span>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-80 bg-gray-800 text-white flex flex-col p-3 space-y-4">
            <div class="sidebar-header">
                <h2 class="text-lg font-semibold">Groups</h2>
                <button id="createGroupBtn" class="w-full mt-2 bg-indigo-500 hover:bg-indigo-600 p-2 rounded-lg flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> New Group
                </button>
            </div>
            <div class="flex-1 overflow-y-auto">
                <ul id="groupChatsList" class="space-y-2">
                    <li class="p-3 text-gray-400">Loading groups...</li>
                </ul>
            </div>
            <div class="border-t border-gray-700 pt-3">
                 <button id="settingsBtn" class="w-full bg-gray-700 hover:bg-gray-600 p-2 rounded-lg flex items-center justify-center gap-2">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-white">
            <div id="chatPlaceholder" class="flex-1 flex flex-col items-center justify-center text-center text-gray-500">
                <i class="fas fa-comments text-6xl text-gray-300"></i>
                <h2 class="mt-4 text-2xl font-semibold">Welcome to Vern Social</h2>
                <p class="mt-2">Select a group to start chatting.</p>
            </div>

            <div id="chatWrapper" class="hidden flex-1 flex flex-col">
                <div class="bg-gray-50 border-b border-gray-200 p-4 flex justify-between items-center">
                    <h3 id="chatHeaderInfo" class="text-xl font-bold text-gray-800"></h3>
                    <div class="actions">
                        <button id="clearChatBtn" class="hidden bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm flex items-center gap-2">
                            <i class="fas fa-trash-alt"></i> Clear Chat
                        </button>
                    </div>
                </div>

                <div id="messagesContainer" class="flex-1 p-6 overflow-y-auto chat-messages-container space-y-4">
                    </div>

                <div class="bg-gray-100 p-4 border-t border-gray-200">
                    <form id="messageForm" class="flex items-center gap-4">
                        <input id="messageInput" type="text" placeholder="Type a message..." autocomplete="off" class="w-full p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500" disabled>
                        <button id="sendMessageBtn" type="submit" class="bg-indigo-500 text-white rounded-full w-12 h-12 flex-shrink-0 flex items-center justify-center hover:bg-indigo-600 disabled:bg-gray-400" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Settings</h2>
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Chat Wallpaper</h3>
                    <p class="text-sm text-gray-500 mb-4">Choose a background for your message windows.</p>
                    <h4 class="font-medium mb-2">Solid Colors</h4>
                    <div id="colorWallpaperList" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-3">
                        </div>
                    <h4 class="font-medium mt-6 mb-2">Image Presets</h4>
                    <div id="imageWallpaperList" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        </div>
                </div>
            </div>
            <div class="mt-8 text-right">
                <button id="closeSettingsModalBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // =========================================================================
        // === Firebase Configuration (REPLACE WITH YOUR ACTUAL CONFIG) ===
        // =========================================================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();


        // =========================================================================
        // === WALLPAPER CONFIGURATION (EASY TO EXTEND) ===
        // =========================================================================
        const WALLPAPER_CONFIG = {
            colors: [
                { name: 'Default', value: '#e5ddd5' },
                { name: 'Slate', value: '#475569' },
                { name: 'Rose', value: '#be123c' },
                { name: 'Teal', value: '#0d9488' },
                { name: 'Navy', value: '#1e3a8a' },
                { name: 'Charcoal', value: '#334155' },
            ],
            images: [
                // NOTE: Replace these placeholder URLs with your actual image paths
                // These placeholders are 1600x900 (a 16:9 ratio)
                { name: 'Red', url: 'https://placehold.co/1600x900/ef4444/white?text=Red+Abstract' },
                { name: 'Blue', url: 'https://placehold.co/1600x900/3b82f6/white?text=Blue+Abstract' },
                { name: 'Space', url: 'https://placehold.co/1600x900/1e293b/f8fafc?text=Space' },
                { name: 'Glow', url: 'https://placehold.co/1600x900/a855f7/f3e8ff?text=Glow' },
            ]
        };


        // =========================================================================
        // === APPLICATION STATE & UTILITIES ===
        // =========================================================================
        const appState = {
            currentUser: null,
            activeChat: {
                id: null,
                name: null,
                creatorId: null
            },
            listeners: [], // To store Firestore listeners for cleanup
        };

        // --- Encryption Utilities ---
        const getEncryptionKey = (groupId) => `key_${groupId}`;
        const encryptMessage = (text, key) => CryptoJS.AES.encrypt(text, key).toString();
        const decryptMessage = (ciphertext, key) => {
            try {
                const bytes = CryptoJS.AES.decrypt(ciphertext, key);
                const originalText = bytes.toString(CryptoJS.enc.Utf8);
                return originalText || '[Empty]';
            } catch (e) {
                console.error("Decryption failed:", e);
                return '[Decryption Error]';
            }
        };

        // --- DOM Element References ---
        const DOMElements = {
            logoutBtn: document.getElementById('logoutBtn'),
            currentUserDisplay: document.getElementById('currentUserDisplay'),
            createGroupBtn: document.getElementById('createGroupBtn'),
            groupChatsList: document.getElementById('groupChatsList'),
            chatPlaceholder: document.getElementById('chatPlaceholder'),
            chatWrapper: document.getElementById('chatWrapper'),
            chatHeaderInfo: document.getElementById('chatHeaderInfo'),
            clearChatBtn: document.getElementById('clearChatBtn'),
            messagesContainer: document.getElementById('messagesContainer'),
            messageForm: document.getElementById('messageForm'),
            messageInput: document.getElementById('messageInput'),
            sendMessageBtn: document.getElementById('sendMessageBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            settingsModal: document.getElementById('settingsModal'),
            closeSettingsModalBtn: document.getElementById('closeSettingsModalBtn'),
            colorWallpaperList: document.getElementById('colorWallpaperList'),
            imageWallpaperList: document.getElementById('imageWallpaperList'),
        };


        // =========================================================================
        // === AUTHENTICATION LOGIC ===
        // =========================================================================
        auth.onAuthStateChanged(user => {
            if (user) {
                appState.currentUser = user;
                DOMElements.currentUserDisplay.textContent = `Logged in as ${user.email || user.uid}`;
                DOMElements.currentUserDisplay.classList.remove('hidden');
                initApp();
            } else {
                // For this example, we'll use anonymous auth if not logged in.
                // Replace with your actual login flow (e.g., redirect to login page).
                auth.signInAnonymously().catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                    alert("Could not connect to the service.");
                });
            }
        });

        DOMElements.logoutBtn.addEventListener('click', () => {
            auth.signOut();
            // In a real app, you'd redirect to a login page.
            window.location.reload(); 
        });


        // =========================================================================
        // === CORE APPLICATION LOGIC ===
        // =========================================================================
        function initApp() {
            loadGroups();
            setupEventListeners();
            loadAndApplyWallpaper();
        }

        function cleanupListeners() {
            appState.listeners.forEach(unsubscribe => unsubscribe());
            appState.listeners = [];
        }

        // --- Group Management ---
        function loadGroups() {
            db.collection('groups').orderBy('name').onSnapshot(snapshot => {
                const groups = [];
                snapshot.forEach(doc => {
                    groups.push({ id: doc.id, ...doc.data() });
                });
                renderGroupList(groups);
            });
        }

        async function createGroup() {
            const groupName = prompt("Enter a name for the new group:");
            if (groupName && groupName.trim() !== "") {
                try {
                    await db.collection('groups').add({
                        name: groupName.trim(),
                        creatorId: appState.currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error("Error creating group:", error);
                    alert("Failed to create group.");
                }
            }
        }

        // --- Chat Functionality ---
        function openChat(groupId, groupName, creatorId) {
            cleanupListeners(); // Stop listening to previous chat's messages
            
            appState.activeChat = { id: groupId, name: groupName, creatorId };

            // Update UI
            DOMElements.chatWrapper.classList.remove('hidden');
            DOMElements.chatPlaceholder.classList.add('hidden');
            DOMElements.chatHeaderInfo.textContent = groupName;
            DOMElements.messageInput.disabled = false;
            DOMElements.sendMessageBtn.disabled = false;
            DOMElements.messagesContainer.innerHTML = '';

            // Show/Hide "Clear Chat" button
            if (appState.currentUser.uid === creatorId) {
                DOMElements.clearChatBtn.classList.remove('hidden');
            } else {
                DOMElements.clearChatBtn.classList.add('hidden');
            }

            // Listen for new messages in the selected group
            const messagesRef = db.collection('groups').doc(groupId).collection('messages').orderBy('createdAt', 'asc');
            const messageListener = messagesRef.onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        renderMessage(change.doc.data());
                    }
                });
                scrollToBottom();
            });
            appState.listeners.push(messageListener);
        }

        async function sendMessage() {
            const text = DOMElements.messageInput.value.trim();
            if (!text || !appState.activeChat.id) return;

            const encryptionKey = getEncryptionKey(appState.activeChat.id);
            const encryptedText = encryptMessage(text, encryptionKey);

            const messageData = {
                text: encryptedText,
                senderId: appState.currentUser.uid,
                senderEmail: appState.currentUser.email || 'Anonymous',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            DOMElements.messageForm.reset();
            
            try {
                await db.collection('groups').doc(appState.activeChat.id).collection('messages').add(messageData);
            } catch (error) {
                console.error("Error sending message:", error);
                alert("Message could not be sent.");
                // Restore input if sending failed
                DOMElements.messageInput.value = text;
            }
        }
        
        async function clearChatMessages() {
            if (!appState.activeChat.id || appState.currentUser.uid !== appState.activeChat.creatorId) {
                alert("You do not have permission to clear this chat.");
                return;
            }

            const isConfirmed = confirm(`Are you sure you want to permanently delete all messages in "${appState.activeChat.name}"?\nThis action cannot be undone.`);
            if (!isConfirmed) return;

            const messagesRef = db.collection('groups').doc(appState.activeChat.id).collection('messages');
            
            try {
                const snapshot = await messagesRef.get();
                if (snapshot.empty) return;

                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                DOMElements.messagesContainer.innerHTML = ''; // Clear UI immediately
                alert("Chat history cleared successfully.");

            } catch (error) {
                console.error("Error clearing chat:", error);
                alert("Could not clear chat history. Please try again.");
            }
        }


        // =========================================================================
        // === UI RENDERING & EVENT LISTENERS ===
        // =========================================================================
        
        function renderGroupList(groups) {
            const listEl = DOMElements.groupChatsList;
            listEl.innerHTML = '';
            if (groups.length === 0) {
                listEl.innerHTML = `<li class="p-3 text-gray-400">No groups found. Create one!</li>`;
                return;
            }
            groups.forEach(group => {
                const li = document.createElement('li');
                li.className = 'p-3 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors';
                li.textContent = group.name;
                li.addEventListener('click', () => {
                     // Highlight active chat
                    document.querySelectorAll('#groupChatsList li').forEach(el => el.classList.remove('bg-indigo-600', 'font-bold'));
                    li.classList.add('bg-indigo-600', 'font-bold');
                    openChat(group.id, group.name, group.creatorId);
                });
                listEl.appendChild(li);
            });
        }
        
        function renderMessage(data) {
            const isSentByUser = data.senderId === appState.currentUser.uid;
            const wrapper = document.createElement('div');
            wrapper.className = `flex items-end gap-2 ${isSentByUser ? 'justify-end' : 'justify-start'}`;

            const encryptionKey = getEncryptionKey(appState.activeChat.id);
            const decryptedText = decryptMessage(data.text, encryptionKey);
            const time = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-md p-3 rounded-2xl ${isSentByUser ? 'bg-indigo-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'}`;
            
            const senderEmail = documentcreateElement('div');
            senderEmail.className = 'text-xs font-bold mb-1 opacity-80';
            senderEmail.textContent = isSentByUser ? 'You' : (data.senderEmail || 'User');
            
            const messageText = document.createElement('p');
            messageText.textContent = decryptedText;

            const timeText = document.createElement('div');
            timeText.className = 'text-xs mt-1 opacity-70 text-right';
            timeText.textContent = time;

            bubble.appendChild(senderEmail);
            bubble.appendChild(messageText);
            bubble.appendChild(timeText);
            
            wrapper.appendChild(bubble);
            DOMElements.messagesContainer.appendChild(wrapper);
        }

        function scrollToBottom() {
            DOMElements.messagesContainer.scrollTop = DOMElements.messagesContainer.scrollHeight;
        }

        // --- Wallpaper Settings ---
        function renderWallpaperOptions() {
            // Colors
            DOMElements.colorWallpaperList.innerHTML = '';
            WALLPAPER_CONFIG.colors.forEach(color => {
                const el = document.createElement('button');
                el.className = 'w-12 h-12 rounded-full border-2 border-transparent focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 transition';
                el.title = color.name;
                el.style.backgroundColor = color.value;
                el.addEventListener('click', () => applyWallpaper({ type: 'color', value: color.value }));
                DOMElements.colorWallpaperList.appendChild(el);
            });

            // Images
            DOMElements.imageWallpaperList.innerHTML = '';
            WALLPAPER_CONFIG.images.forEach(image => {
                const el = document.createElement('button');
                el.className = 'aspect-video bg-cover bg-center rounded-lg border-2 border-transparent focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 overflow-hidden';
                el.style.backgroundImage = `url('${image.url}')`;
                el.title = image.name;
                el.addEventListener('click', () => applyWallpaper({ type: 'image', value: `url('${image.url}')` }));
                DOMElements.imageWallpaperList.appendChild(el);
            });
        }
        
        function applyWallpaper(wallpaper) {
            // Persist the choice in localStorage
            localStorage.setItem('chatWallpaper', JSON.stringify(wallpaper));
            
            // Apply style
            if (wallpaper.type === 'color') {
                DOMElements.messagesContainer.style.backgroundColor = wallpaper.value;
                DOMElements.messagesContainer.style.backgroundImage = 'none';
            } else if (wallpaper.type === 'image') {
                DOMElements.messagesContainer.style.backgroundImage = wallpaper.value;
            }
        }
        
        function loadAndApplyWallpaper() {
            const savedWallpaper = localStorage.getItem('chatWallpaper');
            if (savedWallpaper) {
                applyWallpaper(JSON.parse(savedWallpaper));
            } else {
                // Apply default wallpaper if none is saved
                applyWallpaper({ type: 'color', value: WALLPAPER_CONFIG.colors[0].value });
            }
        }

        function setupEventListeners() {
            DOMElements.createGroupBtn.addEventListener('click', createGroup);
            DOMElements.clearChatBtn.addEventListener('click', clearChatMessages);
            DOMElements.messageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMessage();
            });

            // Settings Modal Listeners
            DOMElements.settingsBtn.addEventListener('click', () => {
                renderWallpaperOptions();
                DOMElements.settingsModal.classList.remove('hidden');
            });
             DOMElements.closeSettingsModalBtn.addEventListener('click', () => {
                DOMElements.settingsModal.classList.add('hidden');
            });
        }

    </script>
</body>
</html>
