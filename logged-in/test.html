<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - VERN SOCIAL</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* --- Base Dashboard Layout (mirrors provided examples) --- */
        body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: 'PrimaryFont', sans-serif; background: #f0f2f5; }
        .dashboard-container { display: flex; flex: 1; min-height: 0; }
        .sidebar { width: 280px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.3s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); flex-shrink: 0; }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.3s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
        .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .sidebar.collapsed nav a { justify-content: center; padding: 10px 0; }
        .sidebar.collapsed nav a .label, .sidebar.collapsed .sidebar-section h2 .section-title { display: none; }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: hidden; }
        .user-info .username { font-family: 'PrimaryFont', sans-serif; font-size: 1.3em; margin-bottom: 8px; font-weight: bold; }
        .user-info .email { font-family: 'SecondaryFont', sans-serif; font-size: 0.9em; color: #bbb; }
        .main-content { flex: 1; padding: 0; background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%); display: flex; flex-direction: column; min-width: 0; }

        /* --- Vern Social Specific Styles --- */
        .social-sidebar-content { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-section { padding: 15px; border-bottom: 1px solid #444; }
        .sidebar.collapsed .sidebar-section { padding: 15px 5px; text-align: center; }
        .sidebar-section h2 { font-size: 1em; text-transform: uppercase; color: #aaa; margin: 0 0 10px 0; display: flex; align-items: center; justify-content: space-between; }
        .sidebar.collapsed .sidebar-section h2 i { margin: auto; }
        .sidebar-section h2 .badge { background-color: #8a2be2; color: white; font-size: 0.8em; padding: 2px 6px; border-radius: 8px; }
        .sidebar-section input[type="text"] { width: 100%; background: #555; border: 1px solid #666; color: #fff; padding: 8px; border-radius: 5px; font-family: 'SecondaryFont', sans-serif; }
        .sidebar.collapsed .sidebar-section input { display: none; }
        .sidebar-section ul { list-style: none; padding: 0; margin: 0; }
        .item-list li { display: flex; align-items: center; justify-content: space-between; padding: 8px 5px; border-radius: 5px; transition: background-color 0.2s; }
        .sidebar.collapsed .item-list li { justify-content: center; }
        .item-list li:hover:not(.empty-state) { background-color: #3a3a3a; }
        .item-list .item-name { cursor: pointer; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sidebar.collapsed .item-list .item-name, .sidebar.collapsed .item-list .item-actions { display: none; }
        .item-list .item-actions { display: flex; gap: 5px; }
        .item-list .item-actions button { background: none; border: none; color: #ccc; cursor: pointer; font-size: 0.9em; padding: 4px; border-radius: 3px; }
        .item-list .item-actions button:hover { background-color: #555; color: #fff; }
        .item-list .item-actions .accept-btn:hover { color: #4caf50; }
        .item-list .item-actions .decline-btn:hover, .item-list .item-actions .remove-btn:hover { color: #f44336; }
        .item-list .empty-state { color: #888; font-size: 0.9em; font-style: italic; }

        #friendsList .item-name.active-chat { color: #8a2be2; font-weight: bold; }

        /* --- Chat Area --- */
        .chat-area { display: flex; flex: 1; min-height: 0; }
        .chat-wrapper { flex-grow: 1; display: flex; flex-direction: column; background: #fff; margin: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .chat-placeholder { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: #aaa; padding: 20px; }
        .chat-placeholder i { font-size: 4em; margin-bottom: 20px; }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-size: 1.2em; font-weight: bold; color: #333; }
        .messages-container { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .message { display: flex; margin-bottom: 15px; max-width: 70%; }
        .message-content { padding: 10px 15px; border-radius: 15px; line-height: 1.4; }
        .message.sent { margin-left: auto; flex-direction: row-reverse; }
        .message.sent .message-content { background: #8a2be2; color: white; border-bottom-right-radius: 3px; }
        .message.received { margin-right: auto; }
        .message.received .message-content { background: #e9e9eb; color: #333; border-bottom-left-radius: 3px; }
        .message-timestamp { font-size: 0.7em; color: #999; margin-top: 5px; }
        .message.sent .message-timestamp { text-align: right; }
        .chat-footer { padding: 20px; border-top: 1px solid #eee; }
        #messageForm { display: flex; gap: 10px; }
        #messageInput { flex-grow: 1; border: 1px solid #ddd; border-radius: 20px; padding: 10px 15px; font-family: 'SecondaryFont', sans-serif; font-size: 1em; }
        #messageInput:focus { outline: none; border-color: #8a2be2; box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.2); }
        #sendMessageBtn { background: #8a2be2; color: white; border: none; border-radius: 50%; width: 42px; height: 42px; font-size: 1.2em; cursor: pointer; flex-shrink: 0; }

        /* General Helper Classes */
        .hidden { display: none !important; }
        .fade-in { animation: fadeInGeneral 0.5s ease-out; }
        @keyframes fadeInGeneral { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body class="dashboard-page">
    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" /></a></div>
            <div class="auth-buttons"><button id="logoutBtn" class="btn btn-login">LOG OUT</button></div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <button id="toggleSidebar">â˜°</button>
            <div class="user-info">
                <p class="username" id="userName">Loading...</p>
                <p class="email" id="userEmail">...</p>
            </div>
            <div class="social-sidebar-content">
                <!-- User Search Section -->
                <div class="sidebar-section">
                    <h2><i class="fas fa-search"></i> <span class="section-title">Find Users</span></h2>
                    <input type="text" id="userSearchInput" placeholder="Search by exact username...">
                    <ul id="userSearchResults" class="item-list"></ul>
                </div>

                <!-- Friend Requests Section -->
                <div class="sidebar-section">
                    <h2>
                        <i class="fas fa-user-plus"></i> <span class="section-title">Requests</span>
                        <span id="requestsCountBadge" class="badge hidden">0</span>
                    </h2>
                    <ul id="friendRequestsList" class="item-list">
                        <li class="empty-state">No new requests.</li>
                    </ul>
                </div>

                <!-- Friends List Section -->
                <div class="sidebar-section">
                    <h2><i class="fas fa-users"></i> <span class="section-title">Friends</span></h2>
                    <ul id="friendsList" class="item-list">
                        <li class="empty-state">No friends yet.</li>
                    </ul>
                </div>

                <!-- Blocked Users Section -->
                <div class="sidebar-section" style="border-bottom: none;">
                    <h2><i class="fas fa-user-slash"></i> <span class="section-title">Blocked</span></h2>
                    <ul id="blockedList" class="item-list">
                        <li class="empty-state">No blocked users.</li>
                    </ul>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="chat-area" id="chatArea">
                <!-- This will be populated by JavaScript -->
                 <div class="chat-placeholder" id="chatPlaceholder">
                    <i class="fas fa-comments"></i>
                    <h2>Welcome to Vern Social</h2>
                    <p>Select a friend to start chatting.</p>
                </div>
                <div class="chat-wrapper hidden" id="chatWrapper">
                    <div class="chat-header" id="chatHeader">Select a Chat</div>
                    <div class="messages-container" id="messagesContainer"></div>
                    <div class="chat-footer">
                        <form id="messageForm">
                            <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" disabled>
                            <button type="submit" id="sendMessageBtn" disabled><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
        // --- DOM Elements ---
        const sidebar = document.getElementById('sidebar');
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        const logoutBtn = document.getElementById('logoutBtn');
        const userNameEl = document.getElementById('userName');
        const userEmailEl = document.getElementById('userEmail');
        
        // Social Sidebar Elements
        const userSearchInput = document.getElementById('userSearchInput');
        const userSearchResultsEl = document.getElementById('userSearchResults');
        const requestsCountBadge = document.getElementById('requestsCountBadge');
        const friendRequestsListEl = document.getElementById('friendRequestsList');
        const friendsListEl = document.getElementById('friendsList');
        const blockedListEl = document.getElementById('blockedList');

        // Chat Area Elements
        const chatPlaceholder = document.getElementById('chatPlaceholder');
        const chatWrapper = document.getElementById('chatWrapper');
        const chatHeaderEl = document.getElementById('chatHeader');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');

        // --- Global State & Firebase Refs ---
        let currentUser = null;
        let currentUserProfile = null;
        let userCache = {}; // Cache for usernames to reduce reads
        let activeChatId = null;
        let friendsUnsubscribe = () => {};
        let requestsUnsubscribe = () => {};
        let chatUnsubscribe = () => {};

        // --- Authentication & Initialization ---
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                userNameEl.textContent = 'Initializing...';
                userEmailEl.textContent = user.email;

                // Check for user profile, create if it doesn't exist
                const userDocRef = firebase.firestore().collection('users').doc(user.uid);
                const userDoc = await userDocRef.get();

                if (!userDoc.exists) {
                    try {
                        const newUsername = `user_${user.uid.substring(0, 6)}`;
                        const profileData = {
                            username: newUsername,
                            email: user.email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            authMethod: user.providerData[0]?.providerId || 'password',
                            friends: [],
                            blocked: [],
                        };
                        await userDocRef.set(profileData);
                        currentUserProfile = profileData;
                        console.log('New user profile created.');
                    } catch (error) {
                        console.error("Error creating user profile:", error);
                        alert("Could not initialize your user profile. Please try again.");
                        return;
                    }
                } else {
                    currentUserProfile = userDoc.data();
                }

                // Initial setup after profile is confirmed
                userCache[user.uid] = currentUserProfile.username;
                userNameEl.textContent = currentUserProfile.username;
                setupListeners();
            } else {
                window.location.href = '../login.html';
            }
        });

        function setupListeners() {
            // Unsubscribe from old listeners before creating new ones
            friendsUnsubscribe();
            requestsUnsubscribe();

            // Listener for the current user's document (friends, blocked lists)
            const userDocRef = firebase.firestore().collection('users').doc(currentUser.uid);
            friendsUnsubscribe = userDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    currentUserProfile = doc.data();
                    userCache[currentUser.uid] = currentUserProfile.username;
                    renderFriendsList(currentUserProfile.friends || []);
                    renderBlockedList(currentUserProfile.blocked || []);
                }
            }, (error) => console.error("Error listening to user doc:", error));

            // Listener for incoming friend requests
            const requestsRef = firebase.firestore().collection('friend_requests');
            const requestsQuery = requestsRef.where('receiverId', '==', currentUser.uid);
            requestsUnsubscribe = requestsQuery.onSnapshot((snapshot) => {
                const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFriendRequests(requests);
            }, (error) => console.error("Error listening to friend requests:", error));
        }

        // --- Rendering Functions ---
        
        async function fetchUsernames(uids) {
            const uidsToFetch = uids.filter(uid => !userCache[uid]);
            if (uidsToFetch.length === 0) return;

            // Fetch users in chunks of 10 to comply with 'in' query limit
            const fetchPromises = [];
            for (let i = 0; i < uidsToFetch.length; i += 10) {
                const chunk = uidsToFetch.slice(i, i + 10);
                const q = firebase.firestore().collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', chunk);
                fetchPromises.push(q.get());
            }

            const snapshots = await Promise.all(fetchPromises);
            snapshots.forEach(snapshot => {
                snapshot.docs.forEach(doc => {
                    userCache[doc.id] = doc.data().username || `user_${doc.id.substring(0,6)}`;
                });
            });
        }

        async function renderFriendsList(friendUids) {
            if (friendUids.length === 0) {
                friendsListEl.innerHTML = '<li class="empty-state">No friends yet.</li>';
                return;
            }
            await fetchUsernames(friendUids);
            friendsListEl.innerHTML = '';
            friendUids.forEach(uid => {
                const li = document.createElement('li');
                li.dataset.uid = uid;
                li.innerHTML = `
                    <span class="item-name">${userCache[uid] || 'Loading...'}</span>
                    <div class="item-actions">
                        <button class="remove-btn" title="Unfriend"><i class="fas fa-user-minus"></i></button>
                        <button class="block-btn" title="Block User"><i class="fas fa-user-slash"></i></button>
                    </div>
                `;
                li.querySelector('.item-name').onclick = () => openChat(uid);
                li.querySelector('.remove-btn').onclick = () => unfriendUser(uid);
                li.querySelector('.block-btn').onclick = () => blockUser(uid);

                if (uid === activeChatId) {
                    li.querySelector('.item-name').classList.add('active-chat');
                }
                friendsListEl.appendChild(li);
            });
        }

        async function renderBlockedList(blockedUids) {
            if (blockedUids.length === 0) {
                blockedListEl.innerHTML = '<li class="empty-state">No blocked users.</li>';
                return;
            }
            await fetchUsernames(blockedUids);
            blockedListEl.innerHTML = '';
            blockedUids.forEach(uid => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="item-name">${userCache[uid] || 'Loading...'}</span>
                    <div class="item-actions">
                        <button class="unblock-btn" title="Unblock User"><i class="fas fa-user-check"></i></button>
                    </div>
                `;
                li.querySelector('.unblock-btn').onclick = () => unblockUser(uid);
                blockedListEl.appendChild(li);
            });
        }

        async function renderFriendRequests(requests) {
            requestsCountBadge.textContent = requests.length;
            requestsCountBadge.classList.toggle('hidden', requests.length === 0);

            if (requests.length === 0) {
                friendRequestsListEl.innerHTML = '<li class="empty-state">No new requests.</li>';
                return;
            }
            
            const senderUids = requests.map(r => r.senderId);
            await fetchUsernames(senderUids);

            friendRequestsListEl.innerHTML = '';
            requests.forEach(req => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="item-name">${userCache[req.senderId] || 'Loading...'}</span>
                    <div class="item-actions">
                        <button class="accept-btn" title="Accept"><i class="fas fa-check"></i></button>
                        <button class="decline-btn" title="Decline"><i class="fas fa-times"></i></button>
                    </div>
                `;
                li.querySelector('.accept-btn').onclick = () => acceptFriendRequest(req.id, req.senderId);
                li.querySelector('.decline-btn').onclick = () => deleteFriendRequest(req.id);
                friendRequestsListEl.appendChild(li);
            });
        }

        // --- Social Actions (Friending, Blocking, etc.) ---

        async function handleUserSearch() {
            const searchTerm = userSearchInput.value.trim();
            if (searchTerm.length < 3) {
                userSearchResultsEl.innerHTML = '';
                return;
            }
            userSearchResultsEl.innerHTML = '<li>Searching...</li>';
            
            const usersRef = firebase.firestore().collection('users');
            const q = usersRef.where('username', '==', searchTerm);
            
            try {
                const snapshot = await q.get();
                if (snapshot.empty) {
                    userSearchResultsEl.innerHTML = '<li class="empty-state">No users found.</li>';
                    return;
                }
                userSearchResultsEl.innerHTML = '';
                snapshot.forEach(doc => {
                    if (doc.id === currentUser.uid) return; // Don't show self
                    
                    const userData = doc.data();
                    // FIX: Ensure currentUserProfile and its arrays are not null before using .includes
                    const friends = currentUserProfile?.friends || [];
                    const blocked = currentUserProfile?.blocked || [];

                    const isFriend = friends.includes(doc.id);
                    const isBlocked = blocked.includes(doc.id);

                    if (isBlocked) return; // Don't show blocked users

                    const li = document.createElement('li');
                    li.innerHTML = `<span class="item-name">${userData.username}</span>`;

                    if (!isFriend) {
                        const addButton = document.createElement('button');
                        addButton.innerHTML = '<i class="fas fa-user-plus"></i>';
                        addButton.title = 'Send Friend Request';
                        addButton.onclick = () => sendFriendRequest(doc.id);
                        const actionsDiv = document.createElement('div');
                        actionsDiv.className = 'item-actions';
                        actionsDiv.appendChild(addButton);
                        li.appendChild(actionsDiv);
                    } else {
                        const friendBadge = document.createElement('span');
                        friendBadge.textContent = 'Friend';
                        friendBadge.style.fontSize = '0.8em';
                        friendBadge.style.color = '#4caf50';
                        li.appendChild(friendBadge);
                    }
                    userSearchResultsEl.appendChild(li);
                });
            } catch (error) {
                console.error("Error searching users:", error);
                userSearchResultsEl.innerHTML = '<li class="empty-state">Error searching.</li>';
            }
        }
        userSearchInput.addEventListener('change', handleUserSearch);


        async function sendFriendRequest(receiverId) {
            // Check if a request already exists
            const requestsRef = firebase.firestore().collection('friend_requests');
            const q1 = requestsRef.where('senderId', '==', currentUser.uid).where('receiverId', '==', receiverId);
            const q2 = requestsRef.where('senderId', '==', receiverId).where('receiverId', '==', currentUser.uid);

            const [query1Snapshot, query2Snapshot] = await Promise.all([q1.get(), q2.get()]);

            if (!query1Snapshot.empty || !query2Snapshot.empty) {
                alert("A friend request already exists between you and this user.");
                return;
            }

            await requestsRef.add({
                senderId: currentUser.uid,
                receiverId: receiverId,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert('Friend request sent!');
        }
        
        async function deleteFriendRequest(requestId) {
            await firebase.firestore().collection('friend_requests').doc(requestId).delete();
        }

        async function acceptFriendRequest(requestId, senderId) {
            const db = firebase.firestore();
            const batch = db.batch();
            
            // 1. Delete the friend request
            const requestRef = db.collection('friend_requests').doc(requestId);
            batch.delete(requestRef);
            
            // 2. Add sender to current user's (receiver's) friend list
            const currentUserRef = db.collection('users').doc(currentUser.uid);
            batch.update(currentUserRef, { friends: firebase.firestore.FieldValue.arrayUnion(senderId) });
            
            // 3. Add current user to sender's friend list
            const senderRef = db.collection('users').doc(senderId);
            batch.update(senderRef, { friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
            
            await batch.commit();
        }
        
        async function unfriendUser(friendId) {
            if (!confirm(`Are you sure you want to unfriend ${userCache[friendId] || 'this user'}?`)) return;
            
            const db = firebase.firestore();
            const batch = db.batch();
            
            // Remove friend from current user's list
            const currentUserRef = db.collection('users').doc(currentUser.uid);
            batch.update(currentUserRef, { friends: firebase.firestore.FieldValue.arrayRemove(friendId) });
            
            // Remove current user from friend's list
            const friendRef = db.collection('users').doc(friendId);
            batch.update(friendRef, { friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });

            await batch.commit();

            // If this was the active chat, close it
            if (activeChatId === friendId) {
                closeActiveChat();
            }
        }
        
        async function blockUser(userIdToBlock) {
             if (!confirm(`Are you sure you want to block ${userCache[userIdToBlock] || 'this user'}? You will be unfriended and unable to interact.`)) return;

            const db = firebase.firestore();
            const batch = db.batch();

            // Add to blocked list and remove from friends list for current user
            const currentUserRef = db.collection('users').doc(currentUser.uid);
            batch.update(currentUserRef, {
                blocked: firebase.firestore.FieldValue.arrayUnion(userIdToBlock),
                friends: firebase.firestore.FieldValue.arrayRemove(userIdToBlock)
            });

            // Also remove current user from the other user's friend list
            const otherUserRef = db.collection('users').doc(userIdToBlock);
            batch.update(otherUserRef, { friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });

            await batch.commit();

             // If this was the active chat, close it
            const potentialChatId = [currentUser.uid, userIdToBlock].sort().join('_');
            const currentChatId = activeChatId ? [currentUser.uid, activeChatId].sort().join('_') : null;
            if(potentialChatId === currentChatId){
                closeActiveChat();
            }
        }

        async function unblockUser(userIdToUnblock) {
            const userRef = firebase.firestore().collection('users').doc(currentUser.uid);
            await userRef.update({
                blocked: firebase.firestore.FieldValue.arrayRemove(userIdToUnblock)
            });
        }

        // --- Chat Functionality ---
        function closeActiveChat() {
            chatUnsubscribe();
            activeChatId = null;
            chatWrapper.classList.add('hidden');
            chatPlaceholder.classList.remove('hidden');
            messageInput.disabled = true;
            sendMessageBtn.disabled = true;
            // Re-render friends list to remove 'active' class
            renderFriendsList(currentUserProfile.friends || []);
        }
        
        async function openChat(friendId) {
            if (activeChatId === friendId) return; // Already in this chat
            
            closeActiveChat(); // Unsubscribe from any previous chat
            activeChatId = friendId;
            
            chatPlaceholder.classList.add('hidden');
            chatWrapper.classList.remove('hidden');
            
            await fetchUsernames([friendId]);
            chatHeaderEl.textContent = `Chat with ${userCache[friendId]}`;
            messagesContainer.innerHTML = '<li>Loading messages...</li>';
            messageInput.disabled = false;
            sendMessageBtn.disabled = false;
            
            // Highlight the active friend in the list
            document.querySelectorAll('#friendsList li').forEach(li => {
                li.querySelector('.item-name').classList.toggle('active-chat', li.dataset.uid === friendId);
            });

            const chatId = [currentUser.uid, friendId].sort().join('_');
            const chatRef = firebase.firestore().collection('chats').doc(chatId);
            
            // Check if chat doc exists, if not create it
            const chatDoc = await chatRef.get();
            if (!chatDoc.exists) {
                await chatRef.set({
                    members: [currentUser.uid, friendId],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }

            // Listen for messages
            const messagesRef = chatRef.collection('messages').orderBy('createdAt', 'asc').limit(50);
            chatUnsubscribe = messagesRef.onSnapshot(snapshot => {
                messagesContainer.innerHTML = '';
                if (snapshot.empty) {
                    messagesContainer.innerHTML = '<li class="empty-state">No messages yet. Say hi!</li>';
                }
                snapshot.docs.forEach(doc => {
                    const msg = doc.data();
                    const msgDiv = document.createElement('div');
                    msgDiv.classList.add('message');
                    msgDiv.classList.add(msg.authorId === currentUser.uid ? 'sent' : 'received');

                    let timestamp = 'Sending...';
                    if (msg.createdAt) {
                        timestamp = msg.createdAt.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }
                    
                    msgDiv.innerHTML = `
                        <div>
                            <div class="message-content">${msg.text}</div>
                            <div class="message-timestamp">${timestamp}</div>
                        </div>`;
                    messagesContainer.appendChild(msgDiv);
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text || !activeChatId) return;
            
            messageInput.value = '';
            
            const chatId = [currentUser.uid, activeChatId].sort().join('_');
            const messagesRef = firebase.firestore().collection('chats').doc(chatId).collection('messages');
            
            await messagesRef.add({
                text: text,
                authorId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        });

        // --- Sidebar & General UI ---
        toggleSidebarBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
        });

        logoutBtn.addEventListener('click', () => {
            firebase.auth().signOut();
        });

    </script>
</body>
</html>
