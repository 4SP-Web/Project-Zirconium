<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - SETTINGS</title>
    <link rel="stylesheet" href="../css/style.css" />
    <script src="../ban-enforcer.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js"></script>
    <style>
    /* --- Settings Layout (matching dashboard structure) --- */
    body.settings-page {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        margin: 0;
        font-family: 'PrimaryFont', sans-serif;
    }
    .settings-container {
        display: flex;
        flex: 1;
    }

    /* --- Sidebar --- */
    .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.collapsed { width: 85px; }
    #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
    .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
    .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
    .sidebar nav li { margin-bottom: 10px; }
    .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
    .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
    .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
    .sidebar nav a .label { 
        margin-left: 10px; 
        white-space: nowrap; 
        opacity: 1;
        visibility: visible;
        transition: opacity 0.2s ease-in-out;
        transition-delay: 0.4s;
    }
    .sidebar.collapsed nav a .label { 
        opacity: 0;
        visibility: hidden;
        transition-delay: 0s;
    }

    /* --- Main Content & Controls (Matched dashboard's styles) --- */
    .main-content {
        flex: 1;
        padding: 40px;
        background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
        overflow-y: auto;
        position: relative;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
        background: white;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid rgba(103, 32, 189, 0.1);
    }

    .dashboard-title {
        margin: 0;
        font-size: 2.2em;
        font-weight: bold;
        background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .quick-actions {
        background: white;
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 6px 30px rgba(0,0,0,0.08);
        border: 1px solid rgba(103, 32, 189, 0.1);
    }

    .quick-actions h3 {
        margin: 0 0 20px 0;
        font-size: 1.4em;
        color: #333;
        display: flex;
        align-items: center;
    }

    .quick-actions h3::before {
        content: '⚡';
        margin-right: 10px;
        font-size: 1.2em;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: nowrap; /* Changed from wrap */
        overflow-x: auto; /* Added for horizontal scrolling */
        padding-bottom: 10px; /* Added space for scrollbar */
    }

    /* Custom scrollbar for the action buttons */
    .action-buttons::-webkit-scrollbar { height: 8px; }
    .action-buttons::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .action-buttons::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    .action-buttons::-webkit-scrollbar-thumb:hover { background: #aaa; }


    .action-btn {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px solid rgba(103, 32, 189, 0.2);
        color: #6720bd;
        padding: 12px 20px;
        border-radius: 15px;
        font-family: 'PrimaryFont', sans-serif;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0; /* Prevent buttons from shrinking */
    }
    
    #manageBansBtn { border-color: rgba(220, 53, 69, 0.3); color: #dc3545; }
    .action-btn:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); color: white; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(103, 32, 189, 0.3); }
    #manageBansBtn:hover { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3); }

    .user-info-section { background: white; border-radius: 20px; padding: 25px; margin-bottom: 30px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); border: 1px solid rgba(103, 32, 189, 0.1); }
    .user-info-section h3 { margin: 0 0 20px 0; font-size: 1.4em; color: #333; display: flex; align-items: center; }
    .user-info-section h3::before { content: '👤'; margin-right: 10px; font-size: 1.2em; }
    .user-info-detail { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #eee; }
    .user-info-detail:last-child { border-bottom: none; }
    .user-info-detail strong { color: #555; font-family: 'PrimaryFont', sans-serif; font-weight: 600; }
    .user-info-detail span { color: #666; font-family: 'SecondaryFont', sans-serif; }

    .settings-section { background: #fff; padding: 30px; border-radius: 20px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); margin-bottom: 30px; position: relative; border: 1px solid rgba(103, 32, 189, 0.1); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .settings-section:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 15px 40px rgba(103, 32, 189, 0.15); border-color: rgba(103, 32, 189, 0.3); }
    #ban-management-section { border-color: rgba(220, 53, 69, 0.2); }
    #ban-management-section:hover { box-shadow: 0 15px 40px rgba(220, 53, 69, 0.15); border-color: rgba(220, 53, 69, 0.3); }
    .settings-section h3 { font-family: 'PrimaryFont', sans-serif; margin: 0 0 20px; font-size: 1.5em; color: #333; border-bottom: 2px solid rgba(103, 32, 189, 0.1); padding-bottom: 10px; }
    #panicKeyGroupsContainer { display: grid; grid-template-rows: 1fr; transition: all 0.4s ease-in-out; }
    .panic-key-group { overflow: hidden; max-height: 0; opacity: 0; padding: 0; margin: 0; border-top: none; transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, padding 0.5s ease-in-out, margin 0.5s ease-in-out; }
    .panic-key-group.visible { max-height: 300px; opacity: 1; padding: 20px 0 0 0; margin: 15px 0 0 0; border-top: 1px solid #eee; }
    #ban-management-section h3 { color: #dc3545; border-bottom-color: rgba(220, 53, 69, 0.2); }
    
    .settings-section p { font-family: 'SecondaryFont', sans-serif; color: #666; margin-bottom: 20px; line-height: 1.5; }
    .username-limit-container { display: flex; align-items: center; justify-content: flex-end; gap: 10px; margin-top: -15px; margin-bottom: 15px; }
    .username-limit-counter { font-family: 'PrimaryFont', sans-serif; font-weight: 600; font-size: 0.9em; color: #555; background-color: #f0f2f5; padding: 4px 8px; border-radius: 6px; }
    .username-limit-info-btn { background: none; border: 1px solid #ccc; color: #777; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; position: relative; }
    .username-limit-info-btn:hover { background-color: #6720bd; color: white; border-color: #6720bd; }
    .username-limit-tooltip { display: none; position: absolute; bottom: 120%; right: 0; background-color: #333; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.85em; white-space: nowrap; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-family: 'PrimaryFont', sans-serif; }
    .username-limit-info-btn:hover .username-limit-tooltip { display: block; }
    .limit-info { padding: 10px 15px; margin-bottom: 20px; border-radius: 8px; background-color: #f8f9fa; border: 1px solid #e9ecef; font-family: 'SecondaryFont', sans-serif; color: #495057; font-size: 0.95em; text-align: center; transition: all 0.3s ease; }
    .limit-info.on-cooldown { background-color: #fff8e1; border-color: #ffecb3; color: #856404; }
    .limit-info strong { color: #6720bd; font-weight: 600; }
    .limit-info.on-cooldown strong { color: #856404; }
    .settings-form { display: flex; flex-direction: column; gap: 15px; margin-top: 10px; position: relative; }
    .username-status-message { text-align: right; font-size: 0.85em; color: #856404; font-family: 'SecondaryFont', sans-serif; min-height: 1.2em; margin-top: -10px; margin-bottom: 10px; transition: opacity 0.3s; }
    
    .settings-section.disabled { position: relative; }
    .settings-section.disabled::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(240, 240, 240, 0.8); border-radius: 20px; z-index: 5; transition: opacity 1s ease; }
    .settings-section.disabled::after { text-transform: uppercase; content: attr(data-disabled-message); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'PrimaryFont', sans-serif; font-weight: bold; color: #666; z-index: 6; background: rgba(255, 255, 255, 0.95); padding: 12px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: opacity 1s ease; text-align: center; }
    .settings-section.disabled.fadeout::before, .settings-section.disabled.fadeout::after { opacity: 0; pointer-events: none; }
    .reauth-btn { background: linear-gradient(135deg, #4285F4 0%, #3478e6 100%) !important; color: #fff !important; border: none; padding: 12px 20px; border-radius: 8px; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; overflow: hidden; }
    .reauth-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
    .reauth-btn:hover::before { left: 100%; }
    .reauth-btn:hover { background: linear-gradient(135deg, #3478e6 0%, #2b6bd8 100%) !important; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3); }
    .reauth-wrapper { position: relative; z-index: 7; }
    .reauth-btn.fadeout { opacity: 0; pointer-events: none; }
    .banned-list-container { margin-top: 25px; max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 12px; padding: 10px; }
    .banned-user-item { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s; }
    .banned-user-item:last-child { border-bottom: none; }
    .banned-user-item:hover { background-color: #fdf2f2; }
    .banned-user-info { flex-grow: 1; }
    .banned-user-info strong { font-family: 'PrimaryFont', sans-serif; color: #333; display: block; margin-bottom: 4px; word-break: break-all; }
    .banned-user-info span { font-family: 'SecondaryFont', sans-serif; color: #666; font-size: 0.9em; display: block; margin-bottom: 2px; }
    .banned-user-item button { background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s, transform 0.2s; font-size: 0.9em; margin-left: 10px; font-family: 'PrimaryFont', sans-serif;  text-transform: uppercase; font-weight: bold; }
    .banned-user-item button:hover { background: #5a6268; transform: scale(1.05); }
    .password-wrapper { position: relative; }
    .password-wrapper input[type="password"], .password-wrapper input[type="text"] { padding-right: 45px; }
    .password-toggle-btn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; transition: background-color 0.2s; }
    .password-toggle-btn:hover { background-color: #e0e0e0; }
    .password-toggle-btn svg { width: 20px; height: 20px; color: #555; }
    .fade-in { animation: fadeIn 0.6s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .slide-in { animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); } @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    #notification-container { position: fixed; bottom: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }
    .notification-popup { padding: 12px 20px; border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-family: 'PrimaryFont', sans-serif; min-width: 250px; max-width: 350px; position: relative; animation: slideInFromRight 0.4s ease-in-out forwards; }
    .notification-popup.exiting { animation: slideOutToRight 0.4s ease-in-out forwards; }
    .notification-popup.success { background: linear-gradient(135deg, #28a745, #20c997); }
    .notification-popup.error { background: linear-gradient(135deg, #dc3545, #e83e8c); }
    .notification-popup.info { background: linear-gradient(135deg, #6720bd, #8a2be2); }
    .notification-counter { position: absolute; top: -8px; right: -8px; background-color: #ffc107; color: #333; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold; border: 2px solid white; transform: scale(0); animation: popIn 0.3s ease-out forwards; }
    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } } @keyframes slideInFromRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } } @keyframes slideOutToRight { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }

    /* --- Refreshed Form Styles (from requests.html) --- */
    .settings-section h4, .panic-key-group h4 {
        font-family: 'PrimaryFont', sans-serif;
        margin: 25px 0 15px 0;
        font-size: 1.2em;
        color: #555;
        border-bottom: 1px solid #ddd;
        padding-bottom: 8px;
    }
     .settings-form {
        padding: 10px 5px;
    }
    .settings-form .form-group {
        margin-bottom: 22px;
        position: relative;
    }
    .settings-form .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #3d475c;
        font-size: 0.95em;
    }
    .settings-form input, .settings-form select {
        font-family: 'SecondaryFont', sans-serif;
        background-color: #fff;
        border: 2px solid #e9ecef !important;
        border-radius: 8px !important;
        padding: 12px;
        width: 100%;
        box-sizing: border-box;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
     .settings-form input:disabled, .settings-form select:disabled {
        background-color: #e9ecef !important;
        cursor: not-allowed;
    }
    .settings-form input:focus, .settings-form select:focus {
        border-color: #8a2be2 !important;
        box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.15) !important;
        outline: none;
    }
    #ban-management-section .settings-form input:focus {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15) !important;
    }
    
    /* Refreshed Button Styles */
    .btn {
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        font-family: 'PrimaryFont', sans-serif;
        text-transform: uppercase;
        transition: all 0.3s ease;
        align-self: flex-start;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .btn:hover {
        transform: translateY(-2px);
    }
    .btn.btn-purple {
        background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(123, 44, 191, 0.2);
    }
    .btn.btn-purple:hover {
        box-shadow: 0 6px 20px rgba(123, 44, 191, 0.3);
    }
    .btn.btn-danger {
        background: #dc3545;
        color: white;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2);
    }
    .btn.btn-danger:hover {
        background: #c82333;
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
    }
    .settings-form > button:disabled, .btn:disabled {
        background: #ccc !important;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        opacity: 0.7;
    }

    /* --- Custom Dropdown for Tab Disguise --- */
    #tab-disguise-section, #panic-key-section { z-index: 20; }
    .custom-dropdown-container { position: relative; width: 100%; }
    .custom-dropdown-selected {
        display: flex; align-items: center; width: 100%; text-align: left;
        background: #fff; border: 2px solid #e9ecef; border-radius: 8px;
        padding: 12px; font-size: 1em; cursor: pointer;
        font-family: 'SecondaryFont', sans-serif; transition: all 0.3s ease;
    }
    .custom-dropdown-selected:focus { 
        outline: none; 
        border-color: #8a2be2;
        box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.15);
    }
    .custom-dropdown-selected img { width: 20px; height: 20px; margin-right: 12px; object-fit: contain; }
    .custom-dropdown-selected .dropdown-arrow { margin-left: auto; width: 24px; height: 24px; fill: #888; transition: transform 0.3s ease; }
    .custom-dropdown-container.open .dropdown-arrow { transform: rotate(180deg); }

    .custom-dropdown-options {
        position: absolute; top: 110%; left: 0; right: 0;
        background: #fff; border: 1px solid #ddd; border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        max-height: 300px; overflow-y: auto;
        opacity: 0; visibility: hidden;
        transform: translateY(-10px);
        transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
        z-index: 1000; /* Ensure dropdown is on top */
    }
    .custom-dropdown-container.open .custom-dropdown-options { opacity: 1; visibility: visible; transform: translateY(0); }
    .dropdown-options-header {
        padding: 10px 15px; font-size: 0.9em; font-weight: bold;
        color: #888; text-transform: uppercase; letter-spacing: 0.5px;
        background-color: #f8f9fa; border-bottom: 1px solid #eee;
        position: sticky; top: 0;
    }
    .dropdown-option { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; transition: background-color 0.2s; }
    .dropdown-option:hover { background-color: #f0f2f5; }
    .dropdown-option img { width: 20px; height: 20px; margin-right: 12px; object-fit: contain; }
    .dropdown-option span { font-family: 'SecondaryFont', sans-serif; color: #333; }
    .dropdown-option.selected { background-color: #e8deff; font-weight: bold; }
    .favicon-with-shadow {
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.4));
    }
    #fetchFaviconBtn {
        padding: 10px 15px;
        border: none;
        border-radius: 12px;
        color: #fff;
        font-size: 1em;
        cursor: pointer;
        font-family: 'PrimaryFont', sans-serif;
        text-transform: uppercase;
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: auto;
        align-self: stretch;
        background: linear-gradient(135deg, #22d3ee 0%, #0891b2 100%);
        box-shadow: 0 2px 5px rgba(8, 145, 178, 0.2);
    }
    #fetchFaviconBtn:hover {
        background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(8, 145, 178, 0.4);
    }
    #fetchFaviconBtn:disabled {
        background: #99e2ed;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    /* Custom Tab Options Panel */
    .custom-tab-options {
        display: none; /* Hidden by default */
        margin-top: 20px; padding-top: 20px;
        border-top: 1px solid #eee;
        animation: fadeIn 0.5s ease-in-out;
    }
    .custom-tab-options h4 { font-size: 1.1em; margin-bottom: 15px; color: #444; }
    .favicon-picker {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
        gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 8px;
        background-color: #f8f9fa; max-height: 150px; overflow-y: auto;
    }
    .favicon-picker-item {
        width: 40px; height: 40px; padding: 5px; cursor: pointer;
        border: 2px solid transparent; border-radius: 8px;
        transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;
        user-select: none; /* Prevents highlighting */
        -webkit-user-select: none;
    }
    .favicon-picker-item:hover { background-color: #e9ecef; }
    .favicon-picker-item.selected { border-color: #6720bd; background-color: #e8deff; }
    .favicon-picker-item img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
    .favicon-fetcher { 
        display: flex; 
        gap: 10px; 
        align-items: center;
    }
    .favicon-fetcher input { flex-grow: 1; }
    .favicon-fetcher button { flex-shrink: 0; }
    .favicon-fetch-preview { 
        width: 46px; 
        height: 46px; 
        border: 1px solid #ddd; 
        border-radius: 12px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        background: #f8f9fa; 
        flex-shrink: 0;
    }
    .favicon-fetch-preview img { width: 32px; height: 32px; object-fit: contain; }

    /* --- NEW: Ban Management Redesign --- */
    #admin-reauth-prompt {
        text-align: center;
        padding: 40px 20px;
        background-color: #fdf2f2;
        border: 1px solid #fadddd;
        border-radius: 12px;
    }
    #admin-reauth-prompt p {
        margin: 0 auto 20px;
        max-width: 600px;
    }
    #admin-controls-container {
        display: none; /* Initially hidden */
    }
    .user-list-container {
        margin-top: 25px;
        border: 1px solid #eee;
        border-radius: 12px;
        background-color: #fff;
    }
    .user-list-header {
        display: flex;
        padding: 15px 20px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
    }
    .user-list-header input {
        flex-grow: 1;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-family: 'SecondaryFont', sans-serif;
    }
    #user-list {
        max-height: 175px;
        overflow-y: auto;
    }
    .user-list-item {
        display: grid;
        grid-template-columns: 2fr 3fr 1fr;
        gap: 15px;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .user-list-item:last-child { border-bottom: none; }
    .user-list-item:hover { background-color: #f9f9f9; }
    .user-list-item div {
        display: flex;
        flex-direction: column;
        word-break: break-all;
    }
    .user-list-item .label {
        font-size: 0.75em;
        font-weight: 600;
        color: #888;
        text-transform: uppercase;
        margin-bottom: 4px;
    }
    .user-list-item .value {
        font-family: 'SecondaryFont', sans-serif;
        color: #333;
    }

    /* --- NEW: Section Categories --- */
    .category-title {
        font-family: 'PrimaryFont', sans-serif;
        font-size: 1.8em;
        color: #333;
        margin-top: 40px;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 2px solid #ddd;
    }
    .category-title:first-of-type {
        margin-top: 0;
    }

    /* --- Modal styles --- */
    .modal {
        display: none; position: fixed; z-index: 1000; left: 0; top: 0;
        width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
        align-items: center; justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-content {
        background-color: #fefefe; margin: auto; padding: 25px;
        border: 1px solid #888; width: 80%; max-width: 500px;
        border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: relative; animation: modalopen 0.3s;
    }
    @keyframes modalopen { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
    .close-btn {
        color: #aaa; float: right; font-size: 28px; font-weight: bold;
        position: absolute; top: 10px; right: 20px;
    }
    .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
    
    @media (max-width: 768px) {
        .settings-container { flex-direction: column; }
        .sidebar { width: 100%; padding: 15px; }
        .sidebar.collapsed { width: 100%; }
        .main-content { padding: 20px; }
        .settings-section { padding: 20px; margin-bottom: 20px; }
        .dashboard-header { flex-direction: column; gap: 20px; text-align: center; }
        .action-buttons { justify-content: center; }
        #delete-section .reauth-btn { position: static; transform: none; margin-top: 15px; }
        .user-list-item { grid-template-columns: 1fr; }
    }
    </style>
</head>
<body class="settings-page">
    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"> <a href="../index.html"> <img src="../images/logo-dark.png" alt="4SP Logo"/> </a> </div>
            <div class="auth-buttons"> <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button> <button id="logoutBtn" class="btn btn-login">LOG OUT</button> </div>
        </div>
    </header>

    <div class="settings-container">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="apps.html"><span class="icon">✨</span><span class="label">Apps</span></a></li>
                    <li><a href="settings.html" class="active"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content fade-in">
            <div class="dashboard-header">
                <h2 class="dashboard-title">Settings</h2>
            </div>

            <div class="quick-actions">
                <h3>Quick Settings</h3>
                <div class="action-buttons">
                    <button class="action-btn" onclick="document.getElementById('panic-key-section').scrollIntoView({ behavior: 'smooth' });"><span>🚨</span> Set Panic Key</button>
                    <button class="action-btn" onclick="document.getElementById('tab-disguise-section').scrollIntoView({ behavior: 'smooth' });"><span>🎭</span> Tab Disguise</button>
                    <button class="action-btn" onclick="document.getElementById('username-section').scrollIntoView({ behavior: 'smooth' });"><span>👤</span> Edit Username</button>
                    <button class="action-btn" id="changePasswordBtn" onclick="document.getElementById('password-section').scrollIntoView({ behavior: 'smooth' });"><span>🔑</span> Change Password</button>
                    <button class="action-btn" onclick="document.getElementById('delete-section').scrollIntoView({ behavior: 'smooth' });"><span>🗑️</span> Delete Account</button>
                    <button class="action-btn" id="viewAnalyticsBtn" style="display: none;" onclick="document.getElementById('analytics-section').scrollIntoView({ behavior: 'smooth' });"><span>📊</span> View Analytics</button>
                    <button class="action-btn" id="manageBansBtn" style="display: none;" onclick="document.getElementById('ban-management-section').scrollIntoView({ behavior: 'smooth' });"><span>🚫</span> Manage Bans</button>
                </div>
            </div>
            
            <div class="user-info-section">
                <h3>Your Information</h3>
                <div class="user-info-detail"><strong>Username:</strong> <span id="displayUsername">Loading...</span></div>
                <div class="user-info-detail"><strong>Email:</strong> <span id="displayEmail">Loading...</span></div>
                <div class="user-info-detail"><strong>Account Type:</strong> <span id="displayAccountType">Loading...</span></div>
            </div>

            <h2 class="category-title">Customization</h2>

            <section class="settings-section" id="panic-key-section">
                <h3>Set Panic Keys</h3>
                <p>Configure up to 3 single-key shortcuts that will instantly redirect you to a specified URL. These settings are stored locally in this browser for privacy and speed.</p>
                <h4>Configuration</h4>
                <form class="settings-form" id="panic-key-form">
                    <div class="form-group">
                        <label>Number of Panic Keys</label>
                        <div class="custom-dropdown-container" id="panic-key-dropdown-container">
                             <button type="button" class="custom-dropdown-selected">
                                <span id="panic-key-selected-text">None</span>
                                <svg class="dropdown-arrow" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"></path></svg>
                            </button>
                            <div class="custom-dropdown-options">
                               <div class="dropdown-option" data-value="0"><span>None</span></div>
                               <div class="dropdown-option" data-value="1"><span>1</span></div>
                               <div class="dropdown-option" data-value="2"><span>2</span></div>
                               <div class="dropdown-option" data-value="3"><span>3</span></div>
                            </div>
                        </div>
                        <select id="panicKeyCountSelector" style="display: none;"><option value="0">None</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                    </div>
                    <div id="panicKeyGroupsContainer">
                        <div class="panic-key-group" id="panic-key-group-1"><h4>Panic Key 1</h4><div class="form-group"><label for="panicKey1">Key (Single, non-special character)</label><input type="text" id="panicKey1" placeholder="e.g., p" maxlength="1" /></div><div class="form-group"><label for="panicUrl1">Redirect URL</label><input type="text" id="panicUrl1" placeholder="e.g., google.com or [classroom.google.com/](https://classroom.google.com/)" /></div></div>
                        <div class="panic-key-group" id="panic-key-group-2"><h4>Panic Key 2</h4><div class="form-group"><label for="panicKey2">Key (Single, non-special character)</label><input type="text" id="panicKey2" placeholder="e.g., q" maxlength="1" /></div><div class="form-group"><label for="panicUrl2">Redirect URL</label><input type="text" id="panicUrl2" placeholder="e.g., wikipedia.org" /></div></div>
                        <div class="panic-key-group" id="panic-key-group-3"><h4>Panic Key 3</h4><div class="form-group"><label for="panicKey3">Key (Single, non-special character)</label><input type="text" id="panicKey3" placeholder='e.g., `' maxlength="1" /></div><div class="form-group"><label for="panicUrl3">Redirect URL</label><input type="text" id="panicUrl3" placeholder="e.g., my.hrw.com" /></div></div>
                    </div>
                    <button type="button" class="btn btn-purple" onclick="savePanicKeySettingsLocal()">Save Panic Keys</button>
                </form>
            </section>
            
            <section class="settings-section" id="tab-disguise-section">
                <h3>Tab Disguise</h3>
                <p>Change the appearance of the browser tab to blend in. This setting is saved locally on this browser.</p>
                <h4>Preset Selection</h4>
                <form class="settings-form" id="tab-disguise-form">
                    <div class="form-group">
                        <label for="custom-dropdown">Choose an Option</label>
                        <div class="custom-dropdown-container" id="tab-dropdown-container">
                            <button type="button" class="custom-dropdown-selected" id="tab-dropdown-selected">
                                <img src="../favicon.ico" alt="icon" id="selected-favicon">
                                <span id="selected-text">None</span>
                                <svg class="dropdown-arrow" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"></path></svg>
                            </button>
                            <div class="custom-dropdown-options" id="tab-dropdown-options"><!-- Options will be populated by JS --></div>
                        </div>
                    </div>
                    
                    <div class="custom-tab-options" id="custom-tab-options-panel">
                        <h4>Customize Your Tab</h4>
                        <div class="form-group">
                            <label for="customTabTitle">Custom Title</label>
                            <input type="text" id="customTabTitle" placeholder="Enter a title...">
                        </div>
                        <div class="form-group">
                            <label>... or Choose an Official 4SP Favicon</label>
                            <div class="favicon-picker" id="favicon-picker-4sp">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        <div class="form-group">
                             <label for="faviconFetchInput">Fetch Favicon from Website URL <em style="font-weight: normal; font-size: 0.9em; color: #666; margin-left: 8px; font-family: 'SecondaryFont', sans-serif;">Not all website icons may be available to fetch</em></label>
                             <div class="favicon-fetcher">
                                <input type="text" id="faviconFetchInput" placeholder="e.g., google.com">
                                <button type="button" id="fetchFaviconBtn">Fetch</button>
                                <div class="favicon-fetch-preview" id="favicon-fetch-preview-container"><img src="" alt="Preview" style="display: none;"></div>
                             </div>
                        </div>
                         <div class="form-group">
                            <label>... or Choose a Preset Favicon</label>
                            <div class="favicon-picker" id="favicon-picker-container"><!-- Favicons will be populated by JS --></div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-purple" id="saveTabPresetBtn">Apply Changes</button>
                </form>
            </section>
            
            <h2 class="category-title">Account Details</h2>

            <section class="settings-section" id="username-section">
                <h3>Edit Username</h3>
                <p>You can change your username up to 10 times every 30 days, with a 1-minute cooldown between each change.</p>
                <h4>Account Details</h4>
                <div class="username-limit-container" id="usernameChangeInfoContainer">
                    <span class="username-limit-counter" id="usernameChangesLeft">--/--</span>
                    <button class="username-limit-info-btn">i<span class="username-limit-tooltip" id="usernameResetTooltip">Resets in -- days</span></button>
                </div>
                <form class="settings-form" id="username-form">
                    <div class="form-group">
                        <label for="newUsername">New Username (4-16 characters)</label>
                        <input type="text" id="newUsername" placeholder="Enter your new username..." required maxlength="16"/>
                    </div>
                    <div class="username-status-message" id="username-status"></div>
                    <button type="button" class="btn btn-purple" onclick="updateUsername()">Update Username</button>
                </form>
            </section>

            <section class="settings-section" id="password-section">
                <h3>Change Password</h3>
                <p>Update your account password for enhanced security. Your new password must be at least 6 characters long and different from your current password.</p>
                <h4>Update Credentials</h4>
                <div class="limit-info" id="passwordChangeInfo"><span>Loading limit information...</span></div>
                <form class="settings-form" id="password-form">
                    <div class="form-group"><label for="oldPassword">Current Password</label><div class="password-wrapper"><input type="password" id="oldPassword" placeholder="Enter your current password..." required/><button type="button" class="password-toggle-btn" data-target="oldPassword" aria-label="Toggle password visibility"><svg class="eye-icon" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg><svg class="eye-off-icon" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg></button></div></div>
                    <div class="form-group"><label for="newPassword">New Password</label><div class="password-wrapper"><input type="password" id="newPassword" placeholder="Enter new password..." required/><button type="button" class="password-toggle-btn" data-target="newPassword" aria-label="Toggle password visibility"><svg class="eye-icon" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg><svg class="eye-off-icon" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg></button></div></div>
                    <button type="button" class="btn btn-purple" onclick="changePassword()">Change Password</button>
                </form>
            </section>

             <section class="settings-section" id="delete-section">
                <h3>Delete Account</h3>
                <p><strong>Warning:</strong> This action is permanent and cannot be undone. All your data, settings, and account information will be permanently removed from our system.</p>
                <h4>Account Deletion</h4>
                <form class="settings-form" id="delete-form" style="display: none;">
                     <p><strong>Verification successful.</strong> You may now permanently delete your account.</p>
                    <button type="button" class="btn btn-danger" onclick="deleteAccount()">Delete Account Permanently</button>
                </form>
                <div class="reauth-wrapper" id="delete-reauth-wrapper">
                    <form class="settings-form" id="email-reauth-form" style="display: none;">
                        <div class="form-group"><label for="reauthPassword">To protect your account, please confirm your password.</label><input type="password" id="reauthPassword" placeholder="Enter password & press Enter..." required></div>
                    </form>
                    <button class="reauth-btn" id="reauthBtn" style="display: none;">Reauthenticate</button>
                </div>
            </section>

            <div id="admin-panel" style="display: none;">
                <h2 class="category-title">Admin Panel</h2>
                <section class="settings-section" id="analytics-section">
                    <h3>📊 Analytics</h3>
                    <p>This page includes analytics only visible to admins, such as you.</p>
                    <h4>View Analytics Data</h4>
                    <form class="settings-form">
                        <button type="button" class="btn btn-purple" onclick="window.location.href='../logged-in/analytics.html'" style="align-self: flex-start;">View Analytics</button>
                    </form>
                </section>
                <section class="settings-section" id="ban-management-section">
                    <h3>🚫 Admin Ban Management</h3>
                    <div id="admin-reauth-prompt">
                        <p>For security, please re-authenticate to access the user management and banning tools.</p>
                        <button id="admin-reauth-btn" class="btn btn-danger">Authenticate to Manage Users</button>
                    </div>
    
                    <div id="admin-controls-container">
                         <button type="button" id="show-ban-modal-btn" class="btn btn-danger" style="margin-bottom: 20px;">Ban a User</button>
                         <h4>All Users</h4>
                         <p>View all registered users below. Click on any user row to copy their UID to your clipboard for banning.</p>
                         <div class="user-list-container">
                             <div class="user-list-header">
                                <input type="text" id="user-search-input" placeholder="Search by username, email, or UID...">
                             </div>
                             <div id="user-list">
                                 <p style="text-align: center; color: #888; padding: 20px;">Loading user list...</p>
                             </div>
                         </div>
                        <h4 style="margin-top: 30px;">Currently Banned</h4>
                        <p>View all users who are currently banned from making requests.</p>
                        <div class="user-list-container">
                            <div id="banned-user-list">
                                <p style="text-align: center; color: #888; padding: 20px;">Loading banned user list...</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="notification-container"></div>
    
    <div id="ban-user-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>Ban a User</h3>
            <form class="settings-form" id="ban-user-form">
                <div class="form-group">
                    <label for="ban-uid">User ID (UID)</label>
                    <input type="text" id="ban-uid" required placeholder="Enter the user's full UID">
                </div>
                <div class="form-group">
                    <label for="ban-reason">Reason for Ban</label>
                    <input type="text" id="ban-reason" required placeholder="e.g., Spamming requests">
                </div>
                <div class="form-group">
                    <label for="ban-duration">Ban Duration (in days)</label>
                    <input type="number" id="ban-duration" required placeholder="e.g., 7" min="1">
                </div>
                <button type="submit" class="btn btn-danger">Apply Ban</button>
            </form>
        </div>
    </div>


    <script src="[https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js](https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js)"></script>
    <script src="[https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js](https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js)"></script>
    <script src="[https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js](https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js)"></script>
    <script src="../firebase-config.js"></script>
    <script>
        // --- Globals ---
        let authMethod = 'password';
        let isReauthenticatedForDelete = false;
        let isReauthenticatedForAdmin = false;
        let isAdmin = false;
        const activeNotifications = new Map();
        const pressedKeys = new Set();
        const dbRef = () => firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid);
        let allUsersCache = []; // Cache for user search

        // --- AUTH & UI INITIALIZATION ---
        firebase.auth().onAuthStateChanged(async user => {
            if (!user) { return location.href = '../login.html'; }
            const adminEmails = ['4simpleproblems@gmail.com', 'belkwy30@minerva.sparcc.org'];
            if (adminEmails.includes(user.email)) {
                isAdmin = true;
                initializeAdminFeatures();
            }
            document.getElementById('displayEmail').textContent = user.email;
            const doc = await dbRef().get(); const userData = doc.exists ? doc.data() : {};
            const username = userData.username || user.displayName || 'No name';
            document.getElementById('displayUsername').textContent = username;
            if (userData.username) { document.getElementById('newUsername').value = userData.username; }
            
            loadPanicKeySettingsLocal();
            setupPanicKeyUI();

            const isGoogle = user.providerData.some(p => p.providerId === 'google.com');
            const isGithub = user.providerData.some(p => p.providerId === 'github.com');
            let accountTypeText = 'Email/Password Account';
            if (isGoogle) { authMethod = 'google'; accountTypeText = 'Google Account';
            } else if (isGithub) { authMethod = 'github'; accountTypeText = 'GitHub Account';
            } else { authMethod = 'password'; }
            
            document.getElementById('displayAccountType').textContent = accountTypeText;
            const passwordSection = document.getElementById('password-section');
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            if (authMethod !== 'password') {
                passwordSection.style.display = 'none';
                changePasswordBtn.style.display = 'none';
            } else {
                 passwordSection.style.display = 'block';
                 changePasswordBtn.style.display = 'flex';
            }

            await updateLimitDisplays();
            setupDeleteAccountSection();
            initializeTabDisguise();
        });

        // --- NOTIFICATION SYSTEM & GENERAL UTILS ---
        function showNotification(type, text) { const DURATION = 10000; const container = document.getElementById('notification-container'); const key = `${type}-${text}`; if (activeNotifications.has(key)) { const existing = activeNotifications.get(key); let count = parseInt(existing.counter.textContent) || 1; count++; existing.counter.textContent = count > 10 ? '10+' : count; existing.counter.style.display = 'flex'; clearTimeout(existing.timerId); existing.timerId = setTimeout(() => removeNotification(key), DURATION); return; } const notification = document.createElement('div'); notification.className = `notification-popup ${type}`; notification.textContent = text; const counter = document.createElement('span'); counter.className = 'notification-counter'; counter.style.display = 'none'; notification.appendChild(counter); const timerId = setTimeout(() => removeNotification(key), DURATION); activeNotifications.set(key, { element: notification, timerId: timerId, counter: counter }); container.appendChild(notification); }
        function removeNotification(key) { if (activeNotifications.has(key)) { const { element, timerId } = activeNotifications.get(key); clearTimeout(timerId); element.classList.add('exiting'); element.addEventListener('animationend', () => { if (element.parentNode) { element.parentNode.removeChild(element); } }, { once: true }); activeNotifications.delete(key); } }
        function clearAllNotifications() { activeNotifications.forEach((value, key) => removeNotification(key)); }
        document.addEventListener('keydown', (event) => { pressedKeys.add(event.code); if (pressedKeys.has('ShiftLeft') || pressedKeys.has('ShiftRight')) { if (pressedKeys.has('KeyC') && pressedKeys.has('KeyN')) { clearAllNotifications(); } } });
        document.addEventListener('keyup', (event) => { pressedKeys.delete(event.code); });
        document.getElementById('logoutBtn').onclick = document.getElementById('signOutLink').onclick = () => { firebase.auth().signOut().then(() => { location.href = '../login.html'; }); };
        const toggleSidebarBtn = document.getElementById('toggleSidebar'); const sidebar = document.getElementById('sidebar'); toggleSidebarBtn.addEventListener('click', () => { sidebar.classList.toggle('collapsed'); });

        // --- CUSTOM DROPDOWN ---
        function initializeCustomDropdown(containerId, onChangeCallback) {
            const container = document.getElementById(containerId);
            if (!container || container.dataset.initialized) return;

            const selectedDisplay = container.querySelector('.custom-dropdown-selected');
            const selectedTextEl = selectedDisplay.querySelector('span');
            const optionsContainer = container.querySelector('.custom-dropdown-options');

            selectedDisplay.addEventListener('click', (e) => {
                e.stopPropagation();
                container.classList.toggle('open');
            });

            optionsContainer.addEventListener('click', (e) => {
                const option = e.target.closest('.dropdown-option');
                if (option) {
                    e.stopPropagation();
                    const value = option.dataset.value;
                    const text = option.querySelector('span').textContent;
                    
                    if (optionsContainer.querySelector('.selected')) {
                        optionsContainer.querySelector('.selected').classList.remove('selected');
                    }
                    option.classList.add('selected');
                    selectedTextEl.textContent = text;
                    container.classList.remove('open');
                    if (onChangeCallback) {
                        onChangeCallback(value);
                    }
                }
            });
            
            document.addEventListener('click', () => {
                if (container.classList.contains('open')) {
                    container.classList.remove('open');
                }
            });

            container.dataset.initialized = 'true';
        }

        // --- PANIC KEY LOGIC ---
        const LOCAL_DB_NAME = 'userLocalSettingsDB'; const LOCAL_STORE_NAME = 'panicKeyStore';
        function openLocalDB() { return new Promise((resolve, reject) => { const request = indexedDB.open(LOCAL_DB_NAME, 1); request.onupgradeneeded = event => { const db = event.target.result; if (!db.objectStoreNames.contains(LOCAL_STORE_NAME)) { db.createObjectStore(LOCAL_STORE_NAME, { keyPath: 'id' }); } }; request.onsuccess = () => resolve(request.result); request.onerror = () => reject(request.error); }); }
        function updatePanicKeyVisibility() { const count = parseInt(document.getElementById('panicKeyCountSelector').value, 10); for (let i = 1; i <= 3; i++) { document.getElementById(`panic-key-group-${i}`).classList.toggle('visible', i <= count); } }
        function setupPanicKeyUI() {
            const hiddenSelect = document.getElementById('panicKeyCountSelector');
            initializeCustomDropdown('panic-key-dropdown-container', (value) => {
                hiddenSelect.value = value;
                updatePanicKeyVisibility();
            });
            updatePanicKeyVisibility();
        }
        async function loadPanicKeySettingsLocal() { try { const db = await openLocalDB(); const transaction = db.transaction(LOCAL_STORE_NAME, 'readonly'); const store = transaction.objectStore(LOCAL_STORE_NAME); const request = store.getAll(); request.onsuccess = () => { const settingsArray = request.result || []; const count = settingsArray.length; document.getElementById('panicKeyCountSelector').value = count; const customDropdownContainer = document.getElementById('panic-key-dropdown-container'); const selectedTextEl = customDropdownContainer.querySelector('#panic-key-selected-text'); const optionsContainer = customDropdownContainer.querySelector('.custom-dropdown-options'); const selectedOption = optionsContainer.querySelector(`.dropdown-option[data-value="${count}"]`); if(optionsContainer.querySelector('.selected')) { optionsContainer.querySelector('.selected').classList.remove('selected'); } if (selectedOption) { selectedTextEl.textContent = selectedOption.querySelector('span').textContent; selectedOption.classList.add('selected'); } for (let i = 1; i <= 3; i++) { document.getElementById(`panicKey${i}`).value = ''; document.getElementById(`panicUrl${i}`).value = ''; } settingsArray.forEach((setting, index) => { const i = index + 1; document.getElementById(`panicKey${i}`).value = setting.key || ''; const displayUrl = (setting.url || '').replace(/^https?:\/\//, ''); document.getElementById(`panicUrl${i}`).value = displayUrl; }); updatePanicKeyVisibility(); db.close(); }; request.onerror = () => { console.error("Error loading panic keys", request.error); db.close(); } } catch (error) { console.error("Could not open DB for loading", error); } }
        async function savePanicKeySettingsLocal() { const count = parseInt(document.getElementById('panicKeyCountSelector').value, 10); const settingsToSave = []; const keys = new Set(); for (let i = 1; i <= count; i++) { const key = document.getElementById(`panicKey${i}`).value.trim().toLowerCase(); let url = document.getElementById(`panicUrl${i}`).value.trim(); if (!key || !url) { return showNotification('error', `Panic Key ${i} is incomplete.`); } if (key.length !== 1 || /[^a-z0-9`\-=\[\];',.\/\\ ]/.test(key)) { return showNotification('error', `Key for Panic Key ${i} is invalid.`); } if (keys.has(key)) { return showNotification('error', `Duplicate key "${key}" found.`); } if (!/^(https?:\/\/)?((www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b)([-a-zA-Z0-9@:%_\+.~#?&//=]*)$/i.test(url)) { return showNotification('error', `URL for Panic Key ${i} is invalid.`); } keys.add(key); if (!/^https?:\/\//i.test(url)) { url = 'https://' + url; } settingsToSave.push({ id: `panicKey${i}`, key, url }); } try { const db = await openLocalDB(); const transaction = db.transaction(LOCAL_STORE_NAME, 'readwrite'); const store = transaction.objectStore(LOCAL_STORE_NAME); store.clear(); settingsToSave.forEach(setting => store.put(setting)); transaction.oncomplete = () => { showNotification('success', 'Panic key settings saved!'); db.close(); setTimeout(() => location.reload(), 100); }; transaction.onerror = (event) => { showNotification('error', 'Could not save settings: ' + event.target.error); db.close(); }; } catch (error) { showNotification('error', 'Could not open DB for saving: ' + error.message); } }
        
        
        // --- TAB DISGUISE (NEW & UPDATED) ---
        function initializeTabDisguise() {
            if (typeof urlChanger === 'undefined') { return console.error("url-changer.js is not loaded."); }

            const container = document.getElementById('tab-dropdown-container');
            const selectedDisplay = document.getElementById('tab-dropdown-selected');
            const selectedFavicon = document.getElementById('selected-favicon');
            const selectedText = document.getElementById('selected-text');
            const optionsContainer = document.getElementById('tab-dropdown-options');
            const customPanel = document.getElementById('custom-tab-options-panel');
            const saveBtn = document.getElementById('saveTabPresetBtn');
            const faviconPicker = document.getElementById('favicon-picker-container');
            const faviconPicker4SP = document.getElementById('favicon-picker-4sp');
            const customTitleInput = document.getElementById('customTabTitle');
            const faviconFetchInput = document.getElementById('faviconFetchInput');
            const fetchFaviconBtn = document.getElementById('fetchFaviconBtn');
            const previewImg = document.querySelector('#favicon-fetch-preview-container img');
            
            initializeCustomDropdown('tab-dropdown-container', (value) => {
                // The complex logic is handled inside selectOption, this is just a stub if needed
            });

            function createFaviconPickerItem(url, isCustom) {
                const item = document.createElement('div');
                item.className = 'favicon-picker-item';
                item.dataset.faviconUrl = url;
                item.innerHTML = `<img src="${url}" alt="Favicon" onerror="this.parentElement.style.display='none'">`;
                if (isCustom) {
                    item.dataset.custom = 'true';
                    item.addEventListener('contextmenu', e => {
                        e.preventDefault();
                        if (confirm('Are you sure you want to remove this custom favicon?')) {
                            const isCurrentlySelected = item.classList.contains('selected');
                            urlChanger.removeCustomFavicon(url);
                            item.remove();
                             if (isCurrentlySelected) {
                                urlChanger.applyCustomFavicon(urlChanger.originalFavicon);
                            }
                        }
                    });
                }
                item.addEventListener('click', () => {
                    faviconFetchInput.value = '';
                    previewImg.src = '';
                    previewImg.style.display = 'none';

                    const currentlySelectedItem = document.querySelector('.favicon-picker .selected');
                    
                    if (currentlySelectedItem === item) {
                        item.classList.remove('selected');
                        urlChanger.applyCustomFavicon(urlChanger.originalFavicon);
                    } else {
                        if (currentlySelectedItem) {
                            currentlySelectedItem.classList.remove('selected');
                        }
                        item.classList.add('selected');
                        urlChanger.applyCustomFavicon(item.dataset.faviconUrl);
                    }
                });
                return item;
            }
            
            function populateFaviconPicker() {
                faviconPicker.innerHTML = '';
                const websites = urlChanger.presets.filter(p => p.category === 'websites');
                websites.forEach(preset => {
                    faviconPicker.appendChild(createFaviconPickerItem(preset.favicon, false));
                });
                if (urlChanger.customFavicons && urlChanger.customFavicons.length > 0) {
                    urlChanger.customFavicons.forEach(url => {
                        faviconPicker.appendChild(createFaviconPickerItem(url, true));
                    });
                }
            }

            // --- Populate Dropdown ---
            optionsContainer.innerHTML = '';
            optionsContainer.appendChild(createDropdownOption({ name: 'None', favicon: urlChanger.originalFavicon, type: 'none' }));
            const websites = urlChanger.presets.filter(p => p.category === 'websites');
            if (websites.length > 0) {
                optionsContainer.appendChild(createHeader('Websites'));
                websites.forEach(preset => optionsContainer.appendChild(createDropdownOption({ ...preset, type: 'preset' })));
            }
            const liveOptions = urlChanger.presets.filter(p => p.category === 'live');
            if (liveOptions.length > 0) {
                optionsContainer.appendChild(createHeader('Live'));
                liveOptions.forEach(preset => optionsContainer.appendChild(createDropdownOption({ ...preset, type: 'preset' })));
            }
            optionsContainer.appendChild(createHeader('Other'));
            optionsContainer.appendChild(createDropdownOption({ name: 'Custom', favicon: '[https://ssl.gstatic.com/docs/doclist/images/drive_2022q3_32dp.png](https://ssl.gstatic.com/docs/doclist/images/drive_2022q3_32dp.png)', type: 'custom' }));
            
            // --- Populate 4SP Favicon Picker ---
            const fourSPIcons = [
                { name: '4SP Light', url: '../images/logo.png' },
                { name: '4SP Dark', url: '../images/logo-dark.png' }
            ];
            faviconPicker4SP.innerHTML = '';
            fourSPIcons.forEach(icon => {
                const item = createFaviconPickerItem(icon.url, false);
                if (icon.name === '4SP Light') {
                    item.querySelector('img').classList.add('favicon-with-shadow');
                }
                faviconPicker4SP.appendChild(item);
            });

            populateFaviconPicker();
            
            function createHeader(text) { const header = document.createElement('div'); header.className = 'dropdown-options-header'; header.textContent = text; return header; }
            function createDropdownOption(data) { 
                const option = document.createElement('div'); 
                option.className = 'dropdown-option'; 
                option.dataset.type = data.type; 
                option.dataset.name = data.name; 
                if(data.id) option.dataset.id = data.id; 

                let displayFavicon = data.favicon;
                if (data.type === 'none' || data.id === '_LIVE_CURRENT_TIME') {
                    displayFavicon = '../images/logo.png';
                }

                option.innerHTML = `<img src="${displayFavicon}" alt="${data.name} icon" onerror="this.src='https://placehold.co/32x32/transparent/transparent?text=?'"><span>${data.name}</span>`; 
                
                const img = option.querySelector('img');
                if (data.type === 'none' || data.id === '_LIVE_CURRENT_TIME') {
                    img.classList.add('favicon-with-shadow');
                }
                // The main click listener is now handled by initializeCustomDropdown
                // but this specific one for selectOption needs to remain.
                option.addEventListener('click', (e) => { e.stopPropagation(); selectOption(option, data); }); 
                return option; 
            }
            function updateSelectedDisplay(data) { 
                let displayFavicon = data.favicon;
                if (data.type === 'none' || data.id === '_LIVE_CURRENT_TIME') {
                    displayFavicon = '../images/logo.png';
                }
                selectedFavicon.src = displayFavicon; 

                selectedText.textContent = data.name; 
                selectedFavicon.classList.toggle('favicon-with-shadow', data.type === 'none' || data.id === '_LIVE_CURRENT_TIME');
                selectedFavicon.onerror = () => { selectedFavicon.src = '[https://placehold.co/32x32/transparent/transparent?text=](https://placehold.co/32x32/transparent/transparent?text=)?'; }; 
                const allOptions = optionsContainer.querySelectorAll('.dropdown-option'); 
                allOptions.forEach(opt => opt.classList.remove('selected')); 
                const selector = data.type === 'none' ? `[data-type="none"]` : data.id ? `[data-id="${data.id}"]` : `[data-name="${data.name}"]`; 
                const activeOption = optionsContainer.querySelector(selector); 
                if (activeOption) activeOption.classList.add('selected'); 
            }
            function selectOption(element, data) { 
                updateSelectedDisplay(data); 
                customPanel.style.display = data.type === 'custom' ? 'block' : 'none'; 
                container.classList.remove('open'); 
            }

            fetchFaviconBtn.addEventListener('click', async () => {
                let domain = faviconFetchInput.value.trim();
                if (!domain) return showNotification('error', 'Please enter a website URL.');
                if (!domain.startsWith('http')) { domain = 'https://' + domain; }
                
                fetchFaviconBtn.disabled = true;
                fetchFaviconBtn.textContent = 'Fetching...';

                try {
                    const faviconUrl = await urlChanger.fetchFavicon(domain);
                    
                    if (!urlChanger.customFavicons.includes(faviconUrl)) {
                        urlChanger.addCustomFavicon(faviconUrl);
                        const newItem = createFaviconPickerItem(faviconUrl, true);
                        faviconPicker.appendChild(newItem);
                    }
                    
                    urlChanger.applyCustomFavicon(faviconUrl);
                    
                    const currentSelected = document.querySelector('.favicon-picker .selected');
                    if (currentSelected) currentSelected.classList.remove('selected');
                    
                    const itemToSelect = document.querySelector(`.favicon-picker [data-favicon-url="${faviconUrl}"]`);
                    if(itemToSelect) itemToSelect.classList.add('selected');
                    
                    previewImg.src = faviconUrl;
                    previewImg.style.display = 'block';
                    showNotification('info', `Favicon for ${new URL(domain).hostname} found and applied.`);

                } catch (error) {
                    showNotification('error', error.message);
                    previewImg.style.display = 'none';
                } finally {
                    fetchFaviconBtn.disabled = false;
                    fetchFaviconBtn.textContent = 'Fetch';
                }
            });

            saveBtn.addEventListener('click', () => { 
                const activeOption = optionsContainer.querySelector('.dropdown-option.selected'); 
                if (!activeOption) return showNotification('info', 'Please select an option from the dropdown first.');
                const type = activeOption.dataset.type; 
                let settingsToSave = { type }; 
                if (type === 'preset') { 
                    settingsToSave.id = activeOption.dataset.id; 
                } else if (type === 'custom') { 
                    const pickedFaviconEl = document.querySelector('.favicon-picker .selected');
                    settingsToSave.title = customTitleInput.value;
                    settingsToSave.favicon = pickedFaviconEl ? pickedFaviconEl.dataset.faviconUrl : null;
                } 
                urlChanger.savePreset(settingsToSave); 
                showNotification('success', 'Tab disguise settings saved!'); 
            });
            
            // --- Load Initial State ---
            const savedSettingsJSON = localStorage.getItem('selectedUrlPreset'); 
            let savedSettings = { type: 'none' }; 
            if (savedSettingsJSON) { try { savedSettings = JSON.parse(savedSettingsJSON); } catch (e) {} } 
            let initialData; 
            if (savedSettings.type === 'preset') { 
                initialData = urlChanger.presets.find(p => p.id === savedSettings.id) || { name: 'None', favicon: urlChanger.originalFavicon, type: 'none' }; 
                initialData.type = 'preset'; 
            } else if (savedSettings.type === 'custom') { 
                initialData = { name: 'Custom', favicon: savedSettings.favicon || '[https://ssl.gstatic.com/docs/doclist/images/drive_2022q3_32dp.png](https://ssl.gstatic.com/docs/doclist/images/drive_2022q3_32dp.png)', type: 'custom' }; 
                customPanel.style.display = 'block'; 
                customTitleInput.value = savedSettings.title || ''; 
                if (savedSettings.favicon) {
                    const pickerItem = document.querySelector(`.favicon-picker [data-favicon-url="${savedSettings.favicon}"]`); 
                    if (pickerItem) { pickerItem.classList.add('selected'); }
                }
            } else { 
                initialData = { name: 'None', favicon: urlChanger.originalFavicon, type: 'none' }; 
            } 
            selectOption(null, initialData);
        }

        // --- OTHER SETTINGS SECTIONS ---
        async function updateLimitDisplays() { const user = firebase.auth().currentUser; if (!user) return; const userDoc = await dbRef().get(); const userData = userDoc.exists ? userDoc.data() : {}; const usernameChangesLeftEl = document.getElementById('usernameChangesLeft'); const usernameResetTooltipEl = document.getElementById('usernameResetTooltip'); const usernameForm = document.getElementById('username-form'); const usernameButton = usernameForm.querySelector('button'); const usernameInput = usernameForm.querySelector('input'); const usernameStatusEl = document.getElementById('username-status'); const USERNAME_CHANGE_LIMIT = 10; const PERIOD_MS = 30 * 24 * 60 * 60 * 1000; const COOLDOWN_MS = 60 * 1000; const { usernameChangeCount = 0, usernameChangePeriodStart = null, lastUsernameChange = null } = userData; let inCurrentPeriod = false; if (usernameChangePeriodStart && usernameChangePeriodStart.toDate) { if ((Date.now() - usernameChangePeriodStart.toDate().getTime()) < PERIOD_MS) { inCurrentPeriod = true; } } const remainingChanges = inCurrentPeriod ? USERNAME_CHANGE_LIMIT - usernameChangeCount : USERNAME_CHANGE_LIMIT; usernameChangesLeftEl.textContent = `${remainingChanges}/${USERNAME_CHANGE_LIMIT}`; const resetTime = usernameChangePeriodStart ? usernameChangePeriodStart.toDate().getTime() + PERIOD_MS : Date.now() + PERIOD_MS; const daysRemaining = Math.ceil((resetTime - Date.now()) / (1000 * 60 * 60 * 24)); usernameResetTooltipEl.textContent = `Resets in ${daysRemaining} day(s)`; let onMinuteCooldown = false; let cooldownMessage = ''; if (lastUsernameChange && lastUsernameChange.toDate) { const timeSinceChange = Date.now() - lastUsernameChange.toDate().getTime(); if (timeSinceChange < COOLDOWN_MS) { onMinuteCooldown = true; const secondsRemaining = Math.ceil((COOLDOWN_MS - timeSinceChange) / 1000); cooldownMessage = `Username change on cooldown for ${secondsRemaining}s.`; } } const hasNoMonthlyChanges = inCurrentPeriod && usernameChangeCount >= USERNAME_CHANGE_LIMIT; if (hasNoMonthlyChanges) { usernameStatusEl.textContent = 'You have used all username changes for this month.'; } else if (onMinuteCooldown) { usernameStatusEl.textContent = cooldownMessage; } else { usernameStatusEl.textContent = ''; } const isDisabled = onMinuteCooldown || hasNoMonthlyChanges; usernameButton.disabled = isDisabled; usernameInput.disabled = isDisabled; const passwordInfoEl = document.getElementById('passwordChangeInfo'); const passwordFormInputs = document.querySelectorAll('#password-form input, #password-form button'); if (authMethod === 'password') { const PASSWORD_COOLDOWN_MS = 14 * 24 * 60 * 60 * 1000; const { lastPasswordChange: lastPassChange } = userData; let onPasswordCooldown = false; if (lastPassChange && lastPassChange.toDate) { const timeSinceChange = Date.now() - lastPassChange.toDate().getTime(); if (timeSinceChange < PASSWORD_COOLDOWN_MS) { onPasswordCooldown = true; const daysRemainingPass = Math.ceil((PASSWORD_COOLDOWN_MS - timeSinceChange) / (1000 * 60 * 60 * 24)); passwordInfoEl.innerHTML = `You can change your password again in <strong>${daysRemainingPass} day(s)</strong>.`; passwordInfoEl.classList.add('on-cooldown'); } } if (!onPasswordCooldown) { passwordInfoEl.innerHTML = `You can change your password once every <strong>14 days</strong> for security.`; passwordInfoEl.classList.remove('on-cooldown'); } passwordFormInputs.forEach(input => input.disabled = onPasswordCooldown); } }
        
        function initializeAdminFeatures() { 
            document.getElementById('manageBansBtn').style.display = 'flex'; 
            document.getElementById('viewAnalyticsBtn').style.display = 'flex'; 
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('admin-reauth-btn').addEventListener('click', () => reauthenticate('admin')); 
            document.getElementById('user-search-input').addEventListener('input', (e) => renderUserList(e.target.value)); 
            
            // Ban Modal Logic
            const banModal = document.getElementById('ban-user-modal');
            const showBanModalBtn = document.getElementById('show-ban-modal-btn');
            const closeBtn = banModal.querySelector('.close-btn');
            const banForm = document.getElementById('ban-user-form');

            showBanModalBtn.addEventListener('click', () => banModal.classList.add('show'));
            closeBtn.addEventListener('click', () => banModal.classList.remove('show'));
            window.addEventListener('click', (event) => {
                if (event.target == banModal) {
                    banModal.classList.remove('show');
                }
            });
            banForm.addEventListener('submit', handleBanFormSubmit);
        }
        
        async function reauthenticate(purpose) {
            const user = firebase.auth().currentUser;
            if (!user) return;
            let provider;
            if (authMethod === 'google') {
                provider = new firebase.auth.GoogleAuthProvider();
            } else if (authMethod === 'github') {
                provider = new firebase.auth.GithubAuthProvider();
            }

            try {
                if (provider) {
                    await user.reauthenticateWithPopup(provider);
                } else { // Password auth
                    const password = prompt('Please enter your password to continue:');
                    if (!password) return; // User cancelled
                    const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
                    await user.reauthenticateWithCredential(credential);
                }
                
                showNotification('success', 'Authentication successful!');
                if (purpose === 'admin') {
                     isReauthenticatedForAdmin = true;
                     document.getElementById('admin-reauth-prompt').style.display = 'none';
                     document.getElementById('admin-controls-container').style.display = 'block';
                     fetchAllUsers();
                     fetchBannedUsers();
                }

            } catch (error) {
                let message = 'An unknown authentication error occurred.';
                switch (error.code) {
                    case 'auth/popup-closed-by-user':
                        message = 'Authentication cancelled. The popup was closed.';
                        break;
                    case 'auth/cancelled-popup-request':
                        message = 'Authentication cancelled. Multiple popups were opened.';
                        break;
                    case 'auth/user-mismatch':
                        message = 'Authentication failed. Please use the same account you are currently logged in with.';
                        break;
                    case 'auth/wrong-password':
                        message = 'Authentication failed. The password you entered is incorrect.';
                        break;
                    default:
                        message = `Authentication failed: ${error.message}`;
                        break;
                }
                showNotification('error', message);
                if (purpose === 'admin') {
                    isReauthenticatedForAdmin = false;
                }
            }
        }
        
        async function fetchAllUsers() {
             if (!isAdmin || !isReauthenticatedForAdmin) return;
             const userListEl = document.getElementById('user-list');
             userListEl.innerHTML = `<p style="text-align: center; color: #888; padding: 20px;">Fetching all users...</p>`;
             try {
                const usersCollection = await firebase.firestore().collection('users').get();
                allUsersCache = usersCollection.docs.map(doc => ({
                    uid: doc.id,
                    ...doc.data()
                }));
                renderUserList();
             } catch (error) {
                console.error("Error fetching users:", error);
                userListEl.innerHTML = `<p style="text-align: center; color: red; padding: 20px;">Failed to fetch users.</p>`;
             }
        }
        
        function renderUserList(searchTerm = '') {
            const userListEl = document.getElementById('user-list');
            const lowercasedFilter = searchTerm.toLowerCase();

            const filteredUsers = allUsersCache.filter(user => {
                const username = user.username?.toLowerCase() || '';
                const email = user.email?.toLowerCase() || '';
                const uid = user.uid.toLowerCase();
                return username.includes(lowercasedFilter) || email.includes(lowercasedFilter) || uid.includes(lowercasedFilter);
            });

            if (filteredUsers.length === 0) {
                 userListEl.innerHTML = `<p style="text-align: center; color: #888; padding: 20px;">No users found.</p>`;
                 return;
            }

            userListEl.innerHTML = ''; // Clear previous list
            filteredUsers.forEach(user => {
                const creationDate = user.createdAt && user.createdAt.toDate ? user.createdAt.toDate().toLocaleDateString() : 'N/A';
                const userItem = document.createElement('div');
                userItem.className = 'user-list-item';
                userItem.dataset.uid = user.uid;
                userItem.innerHTML = `
                    <div>
                        <span class="label">Username & UID</span>
                        <span class="value">${user.username || 'N/A'}</span>
                        <span class="value" style="font-size: 0.8em; color: #666;">${user.uid}</span>
                    </div>
                    <div>
                        <span class="label">Email</span>
                        <span class="value">${user.email || 'N/A'}</span>
                    </div>
                    <div>
                        <span class="label">Created On</span>
                        <span class="value">${creationDate}</span>
                    </div>
                `;
                userItem.addEventListener('click', () => {
                    navigator.clipboard.writeText(user.uid).then(() => {
                        showNotification('success', `Copied UID: ${user.uid}`);
                    }).catch(err => {
                         showNotification('error', 'Failed to copy UID.');
                    });
                });
                userListEl.appendChild(userItem);
            });
        }
        
        async function fetchBannedUsers() {
            if (!isAdmin) return;
            const bannedListEl = document.getElementById('banned-user-list');
            bannedListEl.innerHTML = `<p style="text-align: center; color: #888; padding: 20px;">Fetching banned users...</p>`;
            try {
                const now = new Date();
                const bannedUsersSnapshot = await firebase.firestore().collection('users')
                    .where('isRequestsBanned', '==', true)
                    .where('requestsBannedUntil', '>', now)
                    .get();

                if (bannedUsersSnapshot.empty) {
                    bannedListEl.innerHTML = `<p style="text-align: center; color: #888; padding: 20px;">No users are currently banned.</p>`;
                    return;
                }
                
                bannedListEl.innerHTML = '';
                bannedUsersSnapshot.docs.forEach(doc => {
                    const user = { uid: doc.id, ...doc.data() };
                    const expiryDate = user.requestsBannedUntil.toDate().toLocaleString();
                    const creationDate = user.createdAt && user.createdAt.toDate ? user.createdAt.toDate().toLocaleDateString() : 'N/A';

                    const userItem = document.createElement('div');
                    userItem.className = 'user-list-item';
                    userItem.dataset.uid = user.uid;
                    userItem.innerHTML = `
                        <div>
                            <span class="label">Username & Reason</span>
                            <span class="value">${user.username || 'N/A'}</span>
                             <span class="value" style="font-size: 0.8em; color: #666;">${user.requestsBanReason || 'No reason'}</span>
                        </div>
                        <div>
                            <span class="label">Ban Expires</span>
                            <span class="value">${expiryDate}</span>
                        </div>
                        <div>
                           <button class="btn btn-purple" style="padding: 6px 10px; font-size: 0.8em;" onclick="unbanUser('${user.uid}')">Unban</button>
                        </div>
                    `;
                    bannedListEl.appendChild(userItem);
                });


            } catch (error) {
                console.error("Error fetching banned users: ", error);
                bannedListEl.innerHTML = `<p style="text-align: center; color: red; padding: 20px;">Failed to fetch banned users.</p>`;
            }
        }
        
        async function unbanUser(uid) {
            if (!isAdmin || !confirm(`Are you sure you want to unban user ${uid}?`)) return;
            try {
                await firebase.firestore().collection('users').doc(uid).update({
                    isRequestsBanned: false,
                    requestsBanReason: firebase.firestore.FieldValue.delete(),
                    requestsBannedUntil: firebase.firestore.FieldValue.delete()
                });
                showNotification('success', `User ${uid} has been unbanned.`);
                fetchBannedUsers(); // Refresh the list
            } catch (error) {
                showNotification('error', `Failed to unban user: ${error.message}`);
            }
        }
        
        async function handleBanFormSubmit(event) {
            event.preventDefault();
            if (!isAdmin) return;

            const uid = document.getElementById('ban-uid').value.trim();
            const reason = document.getElementById('ban-reason').value.trim();
            const durationDays = parseInt(document.getElementById('ban-duration').value, 10);

            if (!uid || !reason || isNaN(durationDays) || durationDays <= 0) {
                return showNotification('error', 'Please fill out all fields correctly.');
            }

            try {
                const userRef = firebase.firestore().collection('users').doc(uid);
                const userDoc = await userRef.get();
                if (!userDoc.exists) {
                    return showNotification('error', 'No user found with that UID.');
                }

                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + durationDays);

                await userRef.update({
                    isRequestsBanned: true,
                    requestsBanReason: reason,
                    requestsBannedUntil: firebase.firestore.Timestamp.fromDate(expiryDate)
                });
                
                showNotification('success', `Successfully banned user ${uid} for ${durationDays} day(s).`);
                document.getElementById('ban-user-modal').classList.remove('show');
                document.getElementById('ban-user-form').reset();
                fetchBannedUsers(); // Refresh the list of banned users
            } catch (error) {
                showNotification('error', `Failed to ban user: ${error.message}`);
                console.error("Error banning user:", error);
            }
        }

        function setupDeleteAccountSection() { const deleteSection = document.getElementById('delete-section'); const deleteForm = document.getElementById('delete-form'); const emailReauthForm = document.getElementById('email-reauth-form'); const reauthBtn = document.getElementById('reauthBtn'); isReauthenticatedForDelete = false; deleteForm.style.display = 'none'; emailReauthForm.style.display = 'none'; reauthBtn.style.display = 'none'; deleteSection.classList.remove('disabled', 'fadeout'); if (authMethod === 'google' || authMethod === 'github') { deleteSection.classList.add('disabled'); const providerName = authMethod.charAt(0).toUpperCase() + authMethod.slice(1); deleteSection.setAttribute('data-disabled-message', `Reauthenticate with your ${providerName} account to enable account deletion`); reauthBtn.textContent = `Reauthenticate with ${providerName}`; reauthBtn.style.display = 'block'; reauthBtn.onclick = () => reauthenticate('delete'); } else { emailReauthForm.style.display = 'flex'; } }
        async function updateUsername() { if (document.getElementById('newUsername').disabled) { return; } const newNameRaw = document.getElementById('newUsername').value.trim(); const currentName = document.getElementById('displayUsername').textContent; if (newNameRaw === currentName) { return showNotification('info', 'This is already your username.'); } if (newNameRaw.length < 4 || newNameRaw.length > 16) return showNotification('error', 'Username must be 4-16 characters.'); if (!/^[a-zA-Z0-9.\?\!@#$%&*-]+$/.test(newNameRaw)) return showNotification('error', 'Username contains invalid characters.'); try { const userDoc = await dbRef().get(); const userData = userDoc.data() || {}; const { usernameChangeCount = 0, usernameChangePeriodStart = null, lastUsernameChange = null } = userData; if(lastUsernameChange && (Date.now() - lastUsernameChange.toDate().getTime() < 60000)) { await updateLimitDisplays(); return; } const isNewPeriod = !usernameChangePeriodStart || (Date.now() - usernameChangePeriodStart.toDate().getTime() > 30 * 24 * 60 * 60 * 1000); if (!isNewPeriod && usernameChangeCount >= 10) { await updateLimitDisplays(); return; } const response = await fetch(`https://www.purgomalum.com/service/json?text=${encodeURIComponent(newNameRaw)}`); if (!response.ok) throw new Error('Profanity filter unavailable.'); const data = await response.json(); const filteredName = data.result; if (filteredName.includes('*')) { showNotification('info', 'Your username contained inappropriate words and has been filtered. This still counts as a change.'); } const updatePayload = isNewPeriod ? { username: filteredName, usernameChangeCount: 1, usernameChangePeriodStart: firebase.firestore.FieldValue.serverTimestamp(), lastUsernameChange: firebase.firestore.FieldValue.serverTimestamp() } : { username: filteredName, usernameChangeCount: firebase.firestore.FieldValue.increment(1), lastUsernameChange: firebase.firestore.FieldValue.serverTimestamp() }; await dbRef().update(updatePayload); document.getElementById('displayUsername').textContent = filteredName; document.getElementById('newUsername').value = filteredName; showNotification('success', 'Username updated successfully!'); await updateLimitDisplays(); } catch (error) { showNotification('error', `Failed to update username: ${error.message}`); } }
        async function changePassword() { if (document.getElementById('newPassword').disabled) return; const user = firebase.auth().currentUser; const oldPassword = document.getElementById('oldPassword').value; const newPassword = document.getElementById('newPassword').value; if (!oldPassword || newPassword.length < 6 || oldPassword === newPassword) { return showNotification('error', 'Please check your passwords. The new password must be at least 6 characters and different from the old one.'); } try { await user.reauthenticateWithCredential(firebase.auth.EmailAuthProvider.credential(user.email, oldPassword)); await user.updatePassword(newPassword); await dbRef().update({ lastPasswordChange: firebase.firestore.FieldValue.serverTimestamp() }); document.getElementById('oldPassword').value = ''; document.getElementById('newPassword').value = ''; showNotification('success', 'Password changed successfully!'); await updateLimitDisplays(); } catch (error) { showNotification('error', `Failed to change password: ${error.code === 'auth/wrong-password' ? 'Current password is incorrect.' : error.message}`); } }
        async function deleteAccount() { if (!isReauthenticatedForDelete) { return showNotification('error', 'Please re-authenticate before deleting your account.'); } if (!confirm('Are you absolutely certain? This cannot be undone.') || !confirm('Last chance! This will permanently delete everything. Proceed?')) { return; } const user = firebase.auth().currentUser; try { await dbRef().delete(); await user.delete(); alert('Account permanently deleted. Redirecting...'); location.href = '../signup.html'; } catch (error) { let msg = 'Failed to delete account: '; if (error.code === 'auth/requires-recent-login') { msg += 'Your session has expired. Please re-authenticate and try again.'; setupDeleteAccountSection(); } else { msg += error.message; } showNotification('error', msg); } }
        document.querySelectorAll('.password-toggle-btn').forEach(btn => { btn.addEventListener('click', () => { const targetInput = document.getElementById(btn.dataset.target); const isPassword = targetInput.type === 'password'; targetInput.type = isPassword ? 'text' : 'password'; btn.querySelector('.eye-icon').style.display = isPassword ? 'none' : 'inline'; btn.querySelector('.eye-off-icon').style.display = isPassword ? 'inline' : 'none'; }); });
    </script>
</body>
</html>

