<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - AI Calculator v2</title>
    <link rel="stylesheet" href="../css/style.css" /> 
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base Styles from vern-ai.html --- */
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            font-family: 'PrimaryFont', 'Roboto', sans-serif;
        }
        .dashboard-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 200px;
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #444;
            transition: width 0.5s ease-in-out;
            position: relative;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar {
            position: absolute; top: 10px; left: 50%;
            transform: translateX(-50%); background: none; border: none;
            color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px;
            transition: transform 0.5s ease-in-out;
        }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a {
            display: flex; align-items: center; padding: 12px 15px;
            color: #fff; text-decoration: none; border-radius: 8px;
            transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif;
            text-transform: uppercase; position: relative; overflow: hidden;
            white-space: nowrap;
        }
        .sidebar nav a:hover {
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            transform: translateX(5px);
        }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; }
        .sidebar.collapsed nav a { justify-content: center; padding: 10px 0; }
        .sidebar.collapsed nav a .label { display: none; }
        .user-info {
            text-align: center; margin: 60px 0 30px;
            border-bottom: 1px solid #555; padding-bottom: 20px; overflow: visible;
        }
        .main-content {
            flex: 1; padding: 30px;
            background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .dashboard-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; background: white; padding: 20px 30px;
            border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(103, 32, 189, 0.1); flex-shrink: 0;
        }
        .dashboard-title {
            margin: 0; font-size: 2.0em; font-weight: bold;
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* --- Main Layout for Calculator & Chat --- */
        .calculator-ai-container {
            display: flex;
            flex-grow: 1;
            gap: 30px;
            min-height: 0; 
        }

        /* --- Updated Calculator Styles --- */
        .calculator-container {
            flex: 1 1 480px;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #ddd;
            padding: 20px;
        }
        .calculator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #mode-toggle-btn {
            background: #eef0f2;
            border: 1px solid #dde2e7;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'PrimaryFont', sans-serif;
            transition: all 0.2s ease;
        }
        #mode-toggle-btn:hover { background: #e6d4ff; }
        .calculator-display {
            background: #eef0f2; color: #333; border-radius: 10px;
            padding: 15px 20px; text-align: right; margin-bottom: 20px;
            font-size: 2.2em; font-weight: bold;
            min-height: 1.5em; word-wrap: break-word; overflow-x: auto;
        }
        .calculator-buttons-wrapper { flex-grow: 1; }
        .calculator-buttons {
            display: grid;
            gap: 10px;
            height: 100%;
        }
        .normal-mode-grid { grid-template-columns: repeat(5, 1fr); }
        .science-mode-grid { grid-template-columns: repeat(5, 1fr); }
        .calculator-buttons button {
            padding: 15px; font-size: 1.2em; border-radius: 8px; border: none;
            cursor: pointer; background: #f9f9f9; color: #333;
            transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .calculator-buttons button:hover { background: #e0e0e0; }
        .calculator-buttons button.operator { background-color: #e6d4ff; color: #6720bd; }
        .calculator-buttons button.function { background-color: #d1ecf1; color: #0c5460; }
        .calculator-buttons button.equals {
            grid-column: span 2;
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            color: white;
        }
        .calculator-buttons button.clear { background-color: #f8d7da; color: #721c24; }
        #science-mode-buttons { display: none; }
        .mode-science #science-mode-buttons { display: grid; }
        .mode-science #normal-mode-buttons { display: none; }

        /* --- Chat UI & History Styles --- */
        .chat-history-container {
            flex: 1 1 520px; display: flex; flex-direction: column;
            width: 100%; margin: 0 auto; background: #ffffff;
            border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #ddd; overflow: hidden;
        }
        .chat-window {
            flex-grow: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            background-color: #f9f9f9;
        }
        .message {
            padding: 10px 15px; border-radius: 18px; max-width: 80%;
            line-height: 1.5; word-wrap: break-word; color: #333;
        }
        .user-message {
            background-color: #e6d4ff; color: #3d1b63;
            align-self: flex-end; border-bottom-right-radius: 4px;
        }
        .bot-message, .error-message {
            background-color: #eef0f2; align-self: flex-start;
            border: 1px solid #dde2e7; border-bottom-left-radius: 4px;
        }
        .error-message { background-color: #f8d7da; color: #721c24; }
        .calculation-message {
            background-color: #d1ecf1; color: #0c5460; align-self: flex-end;
            border-bottom-right-radius: 4px; text-align: right;
        }
        .calculation-message .expression { font-size: 0.8em; color: #388da8; }
        .calculation-message .result { font-size: 1.2em; font-weight: bold; }
        .typing-indicator {
            align-self: flex-start; display: flex; align-items: center;
            gap: 5px; padding: 12px 18px;
        }
        .typing-indicator span {
            height: 8px; width: 8px; background-color: #aaa;
            border-radius: 50%; animation: typing 1.4s infinite ease-in-out both;
        }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .chat-input-form {
            display: flex; gap: 10px; padding: 15px;
            border-top: 1px solid #ddd; background-color: #fff;
        }
        #chat-input {
            flex-grow: 1; background-color: #f0f2f5; border: 1px solid #ccc;
            border-radius: 20px; padding: 10px 18px; color: #333;
            font-size: 1em; outline: none; transition: border-color 0.2s ease, box-shadow 0.2s ease;
            font-family: 'PrimaryFont', sans-serif;
        }
        #chat-input:focus {
            border-color: #8A2BE2;
            box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.2);
        }
        #send-btn {
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            border: none; border-radius: 50%; width: 44px; height: 44px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease; flex-shrink: 0;
        }

        /* --- Loading & Save Menu Styles --- */
        #loading-overlay { 
            position: fixed; inset: 0; background-color: #f0f2f5; z-index: 9999; 
            display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 20px; 
            transition: opacity 0.6s ease-out; 
        }
        #loading-overlay.is-hiding { opacity: 0; pointer-events: none; }
        #loading-spinner { 
            border: 4px solid #ccc; border-top: 4px solid #8A2BE2; 
            border-radius: 50%; width: 40px; height: 40px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chat-saves-menu { 
            margin-top: 30px; background: white; padding: 15px 20px; 
            border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            border: 1px solid #ddd; 
        }
        .chat-saves-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 10px; 
        }
        .chat-saves-header h3 { margin: 0; font-size: 1.2em; color: #333; }
        #saveChatBtn { 
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
            border: none; color: #fff; padding: 8px 12px; border-radius: 8px; 
            cursor: pointer; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; 
        }
        #savedChatsList { 
            list-style: none; padding: 0; max-height: 200px; overflow-y: auto; 
        }
        #savedChatsList li { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; border-bottom: 1px solid #f0f0f0; 
        }
        .save-name { font-weight: 600; color: #6720bd; }
        .save-actions button { 
            background: none; border: 1px solid transparent; padding: 5px 8px; border-radius: 8px; 
            cursor: pointer; margin-left: 8px; font-size: 0.85em; transition: all 0.2s; 
            font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; 
        }
        .save-actions .open-save-btn { color: #28a745; border-color: #28a745; }
        .save-actions .delete-save-btn { color: #dc3545; border-color: #dc3545; }
    </style>
</head>
<body class="dashboard-page">

    <div id="loading-overlay">
        <div id="loading-spinner"></div>
        <p style="color: #555;">Initializing Calculator & AI...</p>
    </div>
    
    <header class="main-header light-bg">
        <div class="container">
            <div class="logo">
                <a href="../index.html">
                    <img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" />
                </a>
            </div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="topLogoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <div class="user-info">
                <div class="marquee-container">
                    <span id="userName" class="marquee-content username">Loading…</span>
                </div>
                <div class="marquee-container">
                    <span id="userEmail" class="marquee-content email">Loading…</span>
                </div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">🛡️</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="#" class="active"><span class="icon">✨</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content fade-in">
            <div class="dashboard-header">
                <h2 class="dashboard-title">AI Calculator 2.0</h2>
            </div>

            <div class="calculator-ai-container">
                <div id="calculator-body" class="calculator-container">
                    <div class="calculator-header">
                        <h3>Calculator</h3>
                        <button id="mode-toggle-btn">Science Mode</button>
                    </div>
                    <div class="calculator-display" id="calculator-display">0</div>
                    <div class="calculator-buttons-wrapper">
                        <div class="calculator-buttons normal-mode-grid" id="normal-mode-buttons">
                            <button class="clear" data-value="AC">AC</button>
                            <button class="function" data-value="sqrt">√</button>
                            <button class="function" data-value="^">^</button>
                            <button class="function" data-value="(">(</button>
                            <button class="function" data-value=")">)</button>
                            <button data-value="7">7</button>
                            <button data-value="8">8</button>
                            <button data-value="9">9</button>
                            <button class="operator" data-value="÷">÷</button>
                            <button class="function" data-value="pi">π</button>
                            <button data-value="4">4</button>
                            <button data-value="5">5</button>
                            <button data-value="6">6</button>
                            <button class="operator" data-value="×">×</button>
                            <button data-value="del">DEL</button>
                            <button data-value="1">1</button>
                            <button data-value="2">2</button>
                            <button data-value="3">3</button>
                            <button class="operator" data-value="-">-</button>
                            <button data-value="equals" class="equals">=</button>
                            <button data-value="0">0</button>
                            <button data-value=".">.</button>
                             <button class="operator" data-value="+">+</button>
                        </div>
                        <div class="calculator-buttons science-mode-grid" id="science-mode-buttons">
                             <button class="function" data-value="sin">sin</button>
                             <button class="function" data-value="cos">cos</button>
                             <button class="function" data-value="tan">tan</button>
                             <button class="function" data-value="(">(</button>
                             <button class="function" data-value=")">)</button>
                             <button class="function" data-value="log">log</button>
                             <button class="function" data-value="ln">ln</button>
                             <button class="function" data-value="^">^</button>
                             <button class="function" data-value="sqrt">√</button>
                             <button class="function" data-value="pi">π</button>
                             <button data-value="7">7</button>
                             <button data-value="8">8</button>
                             <button data-value="9">9</button>
                             <button class="operator" data-value="÷">÷</button>
                             <button class="function" data-value="!">!</button>
                             <button data-value="4">4</button>
                             <button data-value="5">5</button>
                             <button data-value="6">6</button>
                             <button class="operator" data-value="×">×</button>
                             <button class="clear" data-value="AC">AC</button>
                             <button data-value="1">1</button>
                             <button data-value="2">2</button>
                             <button data-value="3">3</button>
                             <button class="operator" data-value="-">-</button>
                             <button data-value="del">DEL</button>
                             <button data-value="0">0</button>
                             <button data-value=".">.</button>
                             <button class="operator" data-value="+">+</button>
                             <button data-value="equals" class="equals">=</button>
                        </div>
                    </div>
                </div>

                <div class="chat-history-container">
                    <div class="chat-window" id="chat-window">
                        </div>
                    <form class="chat-input-form" id="chat-form">
                        <input type="text" id="chat-input" placeholder="Connecting..." autocomplete="off" disabled>
                        <button type="submit" id="send-btn" disabled>
                            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                        </button>
                    </form>
                </div>
            </div>

            <div class="chat-saves-menu">
                <div class="chat-saves-header">
                    <h3>Saved Logs (<span id="savedChatsCount">0</span>/100)</h3>
                    <button id="saveChatBtn">Save Current Log</button>
                </div>
                <ul id="savedChatsList">
                    </ul>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const signOutLink = document.getElementById('signOutLink');
        const topLogoutBtn = document.getElementById('topLogoutBtn');
        const saveChatBtn = document.getElementById('saveChatBtn');
        const savedChatsList = document.getElementById('savedChatsList');
        const savedChatsCount = document.getElementById('savedChatsCount');
        
        // Calculator Elements
        const calculatorBody = document.getElementById('calculator-body');
        const calculatorDisplay = document.getElementById('calculator-display');
        const calculatorButtonsWrapper = document.querySelector('.calculator-buttons-wrapper');
        const modeToggleButton = document.getElementById('mode-toggle-btn');

        // --- State Variables ---
        let GEMINI_API_KEY = null;
        let currentUser = null;
        let sessionHistory = []; // Unified history for session
        let currentCalcInput = '0';
        let isCalculating = false;
        let currentMode = 'normal'; // 'normal' or 'science'

        // --- Local Storage Logic for Saved Logs ---
        const MAX_SAVES = 100;
        const STORAGE_KEY = 'aiCalculatorSavedLogs';

        function getSavedLogs() {
            const logsJSON = localStorage.getItem(STORAGE_KEY);
            return logsJSON ? JSON.parse(logsJSON) : [];
        }

        function saveLogs(logs) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
            renderSavedLogs();
        }

        function renderSavedLogs() {
            const savedLogs = getSavedLogs();
            savedChatsList.innerHTML = '';
            savedChatsCount.textContent = savedLogs.length;

            if (savedLogs.length === 0) {
                savedChatsList.innerHTML = '<li>No calculation logs saved yet.</li>';
                return;
            }
            
            savedLogs.forEach((log, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="save-name">${log.name}</span>
                    <div class="save-actions">
                        <button class="open-save-btn" data-index="${index}">Open</button>
                        <button class="delete-save-btn" data-index="${index}">Delete</button>
                    </div>
                `;
                savedChatsList.appendChild(li);
            });
        }
        
        saveChatBtn.addEventListener('click', () => {
            const savedLogs = getSavedLogs();
            if (savedLogs.length >= MAX_SAVES) {
                alert(`You have reached the maximum of ${MAX_SAVES} saved logs.`);
                return;
            }
            if (sessionHistory.length === 0) {
                alert("Nothing to save. Perform a calculation or start a chat first.");
                return;
            }
            
            const logName = prompt("Enter a name for this log:", `Log - ${new Date().toLocaleString()}`);
            if (logName) {
                const newSave = { name: logName, history: [...sessionHistory] };
                savedLogs.push(newSave);
                saveLogs(savedLogs);
            }
        });

        savedChatsList.addEventListener('click', (e) => {
            if (!e.target.matches('button')) return;
            const button = e.target;
            const index = parseInt(button.dataset.index, 10);
            let savedLogs = getSavedLogs();

            if (button.classList.contains('open-save-btn')) {
                if (confirm("Opening a saved log will replace the current session. Are you sure?")) {
                    sessionHistory = [...savedLogs[index].history];
                    chatWindow.innerHTML = '';
                    sessionHistory.forEach(msg => {
                        if (msg.type === 'calculation') {
                            displayCalculation(msg.expression, msg.result);
                        } else {
                            displayMessage(msg.parts[0].text, msg.role === 'user' ? 'user-message' : 'bot-message');
                        }
                    });
                }
            } else if (button.classList.contains('delete-save-btn')) {
                if (confirm(`Are you sure you want to delete "${savedLogs[index].name}"?`)) {
                    savedLogs.splice(index, 1);
                    saveLogs(savedLogs);
                }
            }
        });

        // --- Calculator Logic ---
        const updateDisplay = () => {
            calculatorDisplay.textContent = currentCalcInput;
        };

        const handleCalcInput = (value) => {
            if (isCalculating) return;

            const operators = ['+', '-', '×', '÷', '^'];
            
            if (currentCalcInput === '0' || currentCalcInput === 'Error') {
                // Prevent starting with an operator unless it's a negative sign
                if (operators.includes(value) && value !== '-') {
                     currentCalcInput = '0' + value;
                } else {
                    currentCalcInput = value;
                }
            } else {
                currentCalcInput += value;
            }
            updateDisplay();
        };

        const handleFunctionInput = (func) => {
             if (isCalculating) return;
             if (currentCalcInput === '0' || currentCalcInput === 'Error') currentCalcInput = '';

             switch(func) {
                case 'sqrt': currentCalcInput += 'sqrt('; break;
                case 'pi': currentCalcInput += 'π'; break;
                case 'sin': currentCalcInput += 'sin('; break;
                case 'cos': currentCalcInput += 'cos('; break;
                case 'tan': currentCalcInput += 'tan('; break;
                case 'log': currentCalcInput += 'log('; break;
                case 'ln': currentCalcInput += 'ln('; break;
                case '!': currentCalcInput += '!'; break;
                default: currentCalcInput += func; // for ( ) ^ and operators
             }
             updateDisplay();
        };
        
        const clearCalculator = () => {
            currentCalcInput = '0';
            isCalculating = false;
            updateDisplay();
        };

        const deleteLastChar = () => {
            if (isCalculating || currentCalcInput === '0') return;
            currentCalcInput = currentCalcInput.toString().slice(0, -1);
            if (currentCalcInput === '') {
                currentCalcInput = '0';
            }
            updateDisplay();
        };

        const evaluateExpression = async () => {
            if (isCalculating || currentCalcInput === '0' || currentCalcInput === 'Error') return;
            isCalculating = true;
            const expression = currentCalcInput;
            
            const originalText = calculatorDisplay.textContent;
            calculatorDisplay.textContent = '...';

            const prompt = `You are a calculation engine. Evaluate the following mathematical expression. Your response must be ONLY the final numerical result. Do not include any of your own text, explanations, or formatting. Handle standard functions like sqrt, log, ln, sin, cos, tan, factorial (!), and constants like π. If the expression is invalid or cannot be computed, your ONLY response should be the word "Error". Expression: "${expression.replace(/×/g, '*').replace(/÷/g, '/')}"`;
            
            try {
                // Pass an empty history for pure calculation to get a clean response
                const resultText = await callGemini(prompt, []); 
                
                if (resultText) {
                     displayCalculation(expression, resultText.trim());
                     const calcEntry = { type: 'calculation', expression: expression, result: resultText.trim() };
                     sessionHistory.push(calcEntry);
                     currentCalcInput = resultText.trim();
                } else {
                    throw new Error("Empty response from AI");
                }
            } catch (error) {
                console.error("Calculation Error:", error);
                displayMessage(`Calculation failed: ${error.message}`, 'error-message');
                currentCalcInput = "Error";
            } finally {
                isCalculating = false;
                updateDisplay();
            }
        };

        calculatorButtonsWrapper.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            const { value } = e.target.dataset;

            if (value === 'AC') {
                clearCalculator();
            } else if (value === 'del') {
                deleteLastChar();
            } else if (value === 'equals') {
                evaluateExpression();
            } else if (e.target.classList.contains('function') || e.target.classList.contains('operator')) {
                handleFunctionInput(value);
            } else {
                handleCalcInput(value);
            }
        });

        // --- Keyboard Input Handling ---
        document.addEventListener('keydown', (e) => {
            // Only capture keyboard input if the user isn't typing in the chatbox
            if (document.activeElement === chatInput) return;

            e.preventDefault();
            if (e.key >= '0' && e.key <= '9') handleCalcInput(e.key);
            else if (e.key === '.') handleCalcInput(e.key);
            else if (e.key === '(' || e.key === ')') handleFunctionInput(e.key);
            else if (e.key === '+') handleFunctionInput('+');
            else if (e.key === '-') handleFunctionInput('-');
            else if (e.key === '*') handleFunctionInput('×');
            else if (e.key === '/') handleFunctionInput('÷');
            else if (e.key === '^') handleFunctionInput('^');
            else if (e.key === 'Enter' || e.key === '=') evaluateExpression();
            else if (e.key === 'Backspace') deleteLastChar();
            else if (e.key === 'Escape') clearCalculator();
        });

        // --- Mode Toggle ---
        modeToggleButton.addEventListener('click', () => {
            calculatorBody.classList.toggle('mode-science');
            if (currentMode === 'normal') {
                currentMode = 'science';
                modeToggleButton.textContent = 'Normal Mode';
            } else {
                currentMode = 'normal';
                modeToggleButton.textContent = 'Science Mode';
            }
            clearCalculator(); // Clear input when switching modes to avoid confusion
        });

        // --- Core Chat & API Logic ---
        const callGemini = async (prompt, history) => {
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
             const payload = { 
                 contents: [...history, { role: "user", parts: [{ text: prompt }] }]
             };
             const response = await fetch(apiUrl, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(payload)
             });
             if (!response.ok) {
                 const errorData = await response.json();
                 throw new Error(errorData.error?.message || `API Error: ${response.status}`);
             }
             const data = await response.json();
             // Check for safety ratings and blocked content
             if (!data.candidates || data.candidates[0].finishReason === "SAFETY") {
                return "Response blocked due to safety settings.";
             }
             if (data.candidates && data.candidates[0].content) {
                 return data.candidates[0].content.parts[0].text;
             }
             return "Sorry, I couldn't get a response.";
        };
        
        const handleFormSubmit = async (e) => {
            e.preventDefault();
            const userMessageText = chatInput.value.trim();
            if (!userMessageText || !GEMINI_API_KEY) return;

            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;
            
            displayMessage(userMessageText, 'user-message');
            const userMessage = { role: "user", parts: [{ text: userMessageText }] };
            sessionHistory.push(userMessage);
            const chatHistory = sessionHistory.filter(item => item.type !== 'calculation');
            
            const typingIndicator = displayMessage('', 'bot', true);

            try {
                const botMessageText = await callGemini(userMessageText, chatHistory);
                const botResponse = { role: "model", parts: [{ text: botMessageText }] };
                sessionHistory.push(botResponse);
                if(typingIndicator) typingIndicator.remove();
                displayMessage(botMessageText, 'bot-message');
            } catch (error) {
                console.error("Chat Error:", error);
                if(typingIndicator) typingIndicator.remove();
                displayMessage(error.message, 'error-message');
            } finally {
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        };

        // --- Display Functions for Chat Window ---
        const displayCalculation = (expression, result) => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'calculation-message');
            messageDiv.innerHTML = `
                <div class="expression">${expression} =</div>
                <div class="result">${result}</div>
            `;
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        };
        
        const displayMessage = (text, type, isTyping = false) => {
            const messageDiv = document.createElement('div');
            if (isTyping) {
                messageDiv.classList.add('typing-indicator');
                messageDiv.id = 'typing-indicator';
                messageDiv.innerHTML = `<span></span><span></span><span></span>`;
            } else {
                messageDiv.classList.add('message', type);
                // Sanitize user-generated text to prevent XSS
                const sanitizedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                messageDiv.innerHTML = sanitizedText.replace(/\n/g, '<br>');
            }
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageDiv;
        };


        // --- Authentication & Initialization ---
        const init = async (user) => {
            currentUser = user;
            document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
            document.getElementById('userEmail').textContent = user.email;
            
            try {
                const db = firebase.firestore();
                const docSnap = await db.collection('config').doc('geminikey').get();
                if (docSnap.exists) {
                    GEMINI_API_KEY = docSnap.data().APIkey;
                    chatInput.disabled = false;
                    sendBtn.disabled = false;
                    chatInput.placeholder = "Ask Gemini AI anything...";
                    loadingOverlay.classList.add('is-hiding');
                    renderSavedLogs();
                } else { 
                    throw new Error("API Key document not found in Firestore."); 
                }
            } catch (error) {
                 console.error("Fatal Error during initialization:", error);
                 loadingOverlay.innerHTML = `<p style="color: red; padding: 20px;">FATAL ERROR: ${error.message}<br>Could not initialize application. Please contact support.</p>`;
            }
        };
        
        firebase.auth().onAuthStateChanged(user => {
            if (user) { init(user); } 
            else { window.location.href = '../login.html'; }
        });

        // --- Final Event Listeners ---
        chatForm.addEventListener('submit', handleFormSubmit);
        const handleLogout = () => firebase.auth().signOut();
        topLogoutBtn.addEventListener('click', handleLogout);
        signOutLink.addEventListener('click', (e) => {
            e.preventDefault();
            handleLogout();
        });
    });
    </script>
</body>
</html>
