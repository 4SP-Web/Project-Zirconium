<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - Global Radio</title>
    <link rel="stylesheet" href="../css/style.css"> <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <style>
        :root {
            --dark-bg: #0F0F1A;
            --glass-bg: rgba(20, 20, 35, 0.5);
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0B0;
            --accent-glow: #00BFFF;
            --border-color: rgba(100, 100, 120, 0.5);
            --font-primary: 'PrimaryFont', sans-serif;
            --font-secondary: 'SecondaryFont', sans-serif;
        }
        html, body {
            overflow: hidden; /* Prevent scrollbars from globe */
        }
        body {
            background: var(--dark-bg);
            color: var(--text-primary);
        }
        .main-content {
            padding: 0 !important; /* Remove padding for full-screen globe */
            position: relative;
            background: #000;
        }
        #globe-container {
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        #globe-container:active {
            cursor: grabbing;
        }

        /* Station Display Panel */
        #station-display-panel {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 450px;
            padding: 20px;
            background: var(--glass-bg);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px) saturate(1.2);
            -webkit-backdrop-filter: blur(10px) saturate(1.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 10;
        }
        #station-info h3 {
            margin: 0 0 5px 0;
            font-size: 1.5em;
            color: #fff;
        }
        #station-info p {
            margin: 0;
            font-size: 1em;
            color: var(--text-secondary);
        }
        #visualizer-container {
            width: 100px;
            height: 100px;
            margin: 15px auto;
            position: relative;
        }
        #visualizer-canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
        }
        #play-pause-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background: rgba(0,0,0,0.3);
            cursor: pointer;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }
        #play-pause-button:hover {
            background: rgba(255,255,255,0.2);
            border-color: var(--accent-glow);
        }
        
        /* Settings Panel Anpassung */
        .settings-tab-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 350px;
            z-index: 11;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .tab-link, .control-group label, .checkbox-label-v4, #spatial-coords {
            color: var(--text-secondary) !important;
        }
        .tab-link.active, .tab-link:hover {
             color: var(--accent-glow) !important;
             border-bottom-color: var(--accent-glow) !important;
        }
        .control-group input, .control-group select {
            background-color: rgba(0,0,0,0.2) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        .control-group input[type="range"]::-webkit-slider-thumb {
            background: var(--accent-glow) !important;
        }
         #spatial-pad { background-color: rgba(0,0,0,0.2); border: 1px solid var(--border-color); }
         #spatial-puck { background-color: #333; border: 2px solid var(--accent-glow); }

        #loading-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 1.5em;
            transition: opacity 1s ease-out;
            text-align: center;
        }
    </style>
</head>
<body class="radio-page">

    <div id="loading-overlay">Loading Global Radio...</div>

    <div class="soundboard-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar">
             <button id="toggleSidebar">‚ò∞</button>
            <div class="user-info">
                <div class="marquee-container"> <span id="userName" class="marquee-content username">Loading‚Ä¶</span> </div>
                <div class="marquee-container"> <span id="userEmail" class="marquee-content email">Loading‚Ä¶</span> </div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="radio.html" class="active"><span class="icon">üìª</span><span class="label">Radio</span></a></li>
                    <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="others.html"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div id="globe-container"></div>
            
            <div id="station-display-panel">
                <div id="station-info">
                    <h3 id="stationName">Global Radio</h3>
                    <p id="stationCountry">Select a station on the globe</p>
                </div>
                <div id="visualizer-container">
                    <canvas id="visualizer-canvas"></canvas>
                    <button id="play-pause-button">‚ñ∂</button>
                </div>
            </div>

            <div class="settings-tab-container">
                <div class="settings-header" style="border: none; padding: 0;">
                     <nav class="settings-tabs" style="width: 100%;">
                         <button class="tab-link active" data-tab="modes">Audio Modes</button>
                         <button class="tab-link" data-tab="equalizer">Equalizer</button>
                     </nav>
                </div>
                <div id="modes" class="tab-content active">
                     <div class="control-group">
                         <label class="checkbox-label-v4">Spatial Audio
                             <input type="checkbox" id="modeSpatial" data-setting="modeSpatial">
                         </label>
                         <div class="spatial-audio-panel">
                            <div id="spatial-pad"><div id="spatial-puck"></div></div>
                            <div id="spatial-coords">X: 0.00, Y: 0.00, Z: 0.00</div>
                         </div>
                     </div>
                </div>
                <div id="equalizer" class="tab-content">
                    <div class="control-group">
                        <label>Bass: <span id="eqBassValue">0 dB</span></label>
                        <input type="range" id="eqBass" min="-40" max="40" step="1" value="0" data-setting="eqBass">
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
    // --- Standard Setup ---
    firebase.auth().onAuthStateChanged(user => { if (!user) window.location.href = '../login.html'; });
    
    // --- Radio Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const radioAudioElement = new Audio();
        radioAudioElement.crossOrigin = "anonymous";
        let radioSourceNode;
        
        let isPlaying = false;
        let currentStation = null;
        
        // --- UI Elements ---
        const playPauseButton = document.getElementById('play-pause-button');
        const stationNameEl = document.getElementById('stationName');
        const stationCountryEl = document.getElementById('stationCountry');
        const loadingOverlay = document.getElementById('loading-overlay');

        // --- Audio Nodes ---
        const masterGain = audioContext.createGain();
        const analyser = audioContext.createAnalyser();
        const nodes = {
            mainPanner: new PannerNode(audioContext, { panningModel: 'HRTF', distanceModel: 'inverse' }),
            eqBass: new BiquadFilterNode(audioContext, { type: 'lowshelf', frequency: 100, gain: 0 }),
        };
        
        analyser.fftSize = 256;
        masterGain.connect(nodes.mainPanner).connect(nodes.eqBass).connect(analyser).connect(audioContext.destination);

        // --- Globe and 3D Scene ---
        const globeContainer = document.getElementById('globe-container');
        let scene, camera, renderer, controls, earthMesh, stationMarkers;
        let INTERSECTED;
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        function initGlobe() {
            // Robust Loading Manager
            const manager = new THREE.LoadingManager();
            manager.onLoad = () => {
                console.log('Core assets loaded.');
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 1000);
                fetchAndPlotStations();
            };
            manager.onError = (url) => {
                console.error('Error loading asset: ' + url);
                loadingOverlay.textContent = 'Error loading assets. Please refresh.';
            };
            
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, globeContainer.clientWidth / globeContainer.clientHeight, 0.1, 1000);
            camera.position.z = 2.5;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(globeContainer.clientWidth, globeContainer.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            globeContainer.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 1.5;
            controls.maxDistance = 5;
            controls.enablePan = false;

            scene.add(new THREE.AmbientLight(0x404040, 2));
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 3, 5);
            scene.add(directionalLight);

            const textureLoader = new THREE.TextureLoader(manager);
            const earthTexture = textureLoader.load('https://i.ibb.co/b3j6wX3/earth-daymap.jpg');
            const earthSpecTexture = textureLoader.load('https://i.ibb.co/c8wWn1c/earth-specular-map.jpg');
            const starTexture = textureLoader.load('https://i.ibb.co/f2c9y4s/starfield.jpg');

            const material = new THREE.MeshPhongMaterial({
                map: earthTexture,
                specularMap: earthSpecTexture,
                shininess: 5
            });
            earthMesh = new THREE.Mesh(new THREE.SphereGeometry(1, 64, 64), material);
            scene.add(earthMesh);

            const starGeometry = new THREE.SphereGeometry(500, 64, 64);
            const starMaterial = new THREE.MeshBasicMaterial({ map: starTexture, side: THREE.BackSide });
            const stars = new THREE.Mesh(starGeometry, starMaterial);
            scene.add(stars);

            window.addEventListener('resize', onWindowResize);
            globeContainer.addEventListener('mousemove', onMouseMove);
            globeContainer.addEventListener('click', onClick);

            animate();
        }

        function onWindowResize() {
            camera.aspect = globeContainer.clientWidth / globeContainer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(globeContainer.clientWidth, globeContainer.clientHeight);
        }

        function latLonToVector3(lat, lon, radius) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);
            const x = -(radius * Math.sin(phi) * Math.cos(theta));
            const z = radius * Math.sin(phi) * Math.sin(theta);
            const y = radius * Math.cos(phi);
            return new THREE.Vector3(x, y, z);
        }
        
        async function fetchAndPlotStations() {
            try {
                const response = await fetch('https://de1.api.radio-browser.info/json/stations/search?limit=2000&order=clickcount&reverse=true&hidebroken=false');
                const stations = await response.json();
                
                stationMarkers = new THREE.Group();
                const markerMaterial = new THREE.SpriteMaterial({ color: 0x00BFFF, transparent: true, opacity: 0.6, sizeAttenuation: false });
                
                // Filter for stations that are likely online and have geo data
                stations.filter(s => s.geo_lat && s.geo_long && s.lastcheckok === 1 && (s.codec === 'MP3' || s.codec === 'AAC')).forEach(s => {
                    const position = latLonToVector3(s.geo_lat, s.geo_long, 1.01);
                    const marker = new THREE.Sprite(markerMaterial.clone());
                    marker.position.copy(position);
                    marker.scale.set(0.005, 0.005, 0.005);
                    marker.userData.station = s;
                    stationMarkers.add(marker);
                });
                scene.add(stationMarkers);

            } catch (error) {
                console.error("Failed to fetch stations", error);
                stationCountryEl.textContent = "Could not load station data.";
            }
        }
        
        function onMouseMove(event) {
            mouse.x = (event.clientX / globeContainer.clientWidth) * 2 - 1;
            mouse.y = -((event.clientY - globeContainer.offsetTop) / globeContainer.clientHeight) * 2 + 1;
        }

        function onClick() {
            if(INTERSECTED) {
                tuneToStation(INTERSECTED.userData.station);
            }
        }

        function tuneToStation(station) {
            currentStation = station;
            
            if (audioContext.state === 'suspended') audioContext.resume();
            if (!radioSourceNode) {
                radioSourceNode = audioContext.createMediaElementSource(radioAudioElement);
                radioSourceNode.connect(masterGain);
            }

            radioAudioElement.src = station.url_resolved;
            radioAudioElement.play().then(() => {
                isPlaying = true;
                playPauseButton.textContent = '‚ùö‚ùö';
            }).catch(e => console.error("Playback error:", e));

            stationNameEl.textContent = station.name;
            stationCountryEl.textContent = station.country || 'Unknown Location';

            const targetPosition = INTERSECTED.position.clone().multiplyScalar(2.5);
            new TWEEN.Tween(camera.position)
                .to(targetPosition, 1000)
                .easing(TWEEN.Easing.Cubic.Out)
                .onUpdate(() => camera.lookAt(0,0,0))
                .start();
        }

        function animate() {
            requestAnimationFrame(animate);
            TWEEN.update();
            controls.update();

            raycaster.setFromCamera(mouse, camera);
            if(stationMarkers) {
                const intersects = raycaster.intersectObjects(stationMarkers.children, false);
                if (intersects.length > 0) {
                    if (INTERSECTED != intersects[0].object) {
                        if (INTERSECTED) INTERSECTED.material.color.setHex(0x00BFFF);
                        INTERSECTED = intersects[0].object;
                        INTERSECTED.material.color.setHex(0xFFFFFF);
                        globeContainer.style.cursor = 'pointer';
                    }
                } else {
                    if (INTERSECTED) INTERSECTED.material.color.setHex(0x00BFFF);
                    INTERSECTED = null;
                    globeContainer.style.cursor = 'grab';
                }
            }
            
            drawVisualizer();
            renderer.render(scene, camera);
        }

        const canvas = document.getElementById('visualizer-canvas');
        const canvasCtx = canvas.getContext('2d');
        canvas.width = 100; canvas.height = 100; // Set canvas resolution
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        function drawVisualizer() {
            if(!isPlaying) {
                canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }
            analyser.getByteFrequencyData(dataArray);
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 35;
            const barCount = 60;

            for (let i = 0; i < barCount; i++) {
                const barHeight = (dataArray[i] / 255) * 20;
                const angle = (i / barCount) * 2 * Math.PI;

                canvasCtx.save();
                canvasCtx.translate(centerX, centerY);
                canvasCtx.rotate(angle);
                
                const gradient = canvasCtx.createLinearGradient(0, -radius, 0, -radius - barHeight);
                gradient.addColorStop(0, "rgba(0, 191, 255, 0.8)");
                gradient.addColorStop(1, "rgba(30, 144, 255, 0.4)");

                canvasCtx.fillStyle = gradient;
                canvasCtx.fillRect(-1, -radius - barHeight, 2, barHeight);
                canvasCtx.restore();
            }
        }
        
        playPauseButton.addEventListener('click', () => {
            if(!currentStation) return;
            if (isPlaying) {
                radioAudioElement.pause();
                playPauseButton.textContent = '‚ñ∂';
            } else {
                radioAudioElement.play();
                playPauseButton.textContent = '‚ùö‚ùö';
            }
            isPlaying = !isPlaying;
        });

        document.querySelectorAll('[data-setting]').forEach(setting => {
            setting.addEventListener(setting.type === 'checkbox' ? 'change' : 'input', (e) => {
                const { id, value, checked } = e.target;
                const timeConstant = 0.02;
                switch (id) {
                    case 'eqBass': nodes.eqBass.gain.setTargetAtTime(parseFloat(value), audioContext.currentTime, timeConstant); document.getElementById('eqBassValue').textContent = `${value} dB`; break;
                    case 'modeSpatial': nodes.mainPanner.panningModel = checked ? 'HRTF' : 'equalpower'; break;
                }
            });
        });
        document.querySelector('.settings-tabs').addEventListener('click', e => { if (e.target.matches('.tab-link')) { document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active')); e.target.classList.add('active'); document.getElementById(e.target.dataset.tab).classList.add('active'); } });
        
        const spatialPad = document.getElementById('spatial-pad');
        const spatialPuck = document.getElementById('spatial-puck');
        const spatialCoords = document.getElementById('spatial-coords');
        let isPuckDragging = false;
        let pannerZ = 0;
        function updatePannerPosition(x, y, z) { const scale = 10; const timeConstant = 0.015; nodes.mainPanner.positionX.setTargetAtTime(x * scale, audioContext.currentTime, timeConstant); nodes.mainPanner.positionY.setTargetAtTime(y * scale, audioContext.currentTime, timeConstant); nodes.mainPanner.positionZ.setTargetAtTime(z * scale, audioContext.currentTime, timeConstant); spatialCoords.textContent = `X: ${x.toFixed(2)}, Y: ${y.toFixed(2)}, Z: ${z.toFixed(2)}`; }
        function movePuck(e) { const rect = spatialPad.getBoundingClientRect(); const radius = rect.width / 2; let x = e.clientX - rect.left - radius; let y = e.clientY - rect.top - radius; let dist = Math.sqrt(x*x + y*y); if (dist > radius) { x = (x/dist) * radius; y = (y/dist) * radius; } spatialPuck.style.left = `${x + radius}px`; spatialPuck.style.top = `${y + radius}px`; updatePannerPosition(x / radius, -y / radius, pannerZ); }
        spatialPad.addEventListener('mousedown', (e) => { if(!document.getElementById('modeSpatial').checked) return; isPuckDragging = true; movePuck(e); });
        document.addEventListener('mousemove', (e) => { if(isPuckDragging) movePuck(e); });
        document.addEventListener('mouseup', () => { isPuckDragging = false; });
        spatialPad.addEventListener('wheel', e => { if(!document.getElementById('modeSpatial').checked) return; e.preventDefault(); pannerZ += e.deltaY * -0.01; pannerZ = Math.max(-1, Math.min(1, pannerZ)); const rect = spatialPad.getBoundingClientRect(); const radius = rect.width / 2; const currentX = (parseFloat(spatialPuck.style.left || `${radius}px`) - radius) / radius; const currentY = -(parseFloat(spatialPuck.style.top || `${radius}px`) - radius) / radius; updatePannerPosition(currentX, currentY, pannerZ); });

        // Initialize
        initGlobe();
    });
    </script>
</body>
</html>
