<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - COUNTDOWNS</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <script src="../panic-key.js"></script>
    <style>
        /* --- Dashboard Layout (from notes.html) --- */
        body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: 'PrimaryFont', sans-serif; }
        .dashboard-container { display: flex; flex: 1; }

        /* --- Sidebar (from notes.html) --- */
        .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; position: relative; overflow: hidden; }
        .sidebar nav a::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); transition: left 0.5s; }
        .sidebar nav a:hover::before { left: 100%; }
        .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .sidebar.collapsed nav a { justify-content: center; padding: 10px 0; }
        .sidebar.collapsed nav a .label { display: none; }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: visible; }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em; }
        .marquee-content { display: inline-block; padding-left: 100%; transform: translateX(0); animation: none; line-height: 1.8em; }
        .marquee-active { animation: scroll-left 12s linear infinite; }
        .sidebar.collapsed .marquee-active { animation-duration: 20s; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .user-info .username { font-family: 'PrimaryFont', sans-serif; font-size: 1.3em; margin-bottom: 8px; line-height: 0.2em; font-weight: bold; }
        .user-info .email { font-family: 'SecondaryFont', sans-serif; font-size: 0.9em; color: #bbb; }

        /* --- Main Content & Header (from notes.html) --- */
        .main-content { flex: 1; padding: 30px; background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%); overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(103, 32, 189, 0.1); flex-shrink: 0; }
        .dashboard-header-title-container { display: flex; align-items: center; gap: 12px; }
        .dashboard-title { margin: 0; font-size: 2.0em; font-weight: bold; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

        /* --- Countdown Page Specific Styles --- */
        .countdown-container { display: flex; flex-direction: column; flex-grow: 1; gap: 20px; }
        .countdown-controls { background: #fff; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .countdown-controls button { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); border: none; color: #fff; padding: 10px 15px; border-radius: 8px; font-family: 'PrimaryFont', sans-serif; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; font-weight: 600; }
        .countdown-controls button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(103, 32, 189, 0.25); }
        .countdown-controls button:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }
        
        .active-countdown-display { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        #activeCountdownName { font-family: 'PrimaryFont', sans-serif; font-size: 1.6em; margin-bottom: 15px; color: #333; font-weight: bold; }
        #timerDisplay { padding: 15px; border-radius: 8px; background: #f0f2f5; border: 1px solid #e0e0e0; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; font-size: 1.4em; color: #6720bd; font-weight: bold; display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; min-height: 2.5em; align-items: center; }
        .timer-display .time-unit { display: inline-block; }
        .timer-display .time-label { font-size: 0.5em; margin-left: 3px; }

        /* --- Collapsible Save Sections (from notes.html) --- */
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px; cursor: pointer; }
        .collapsible-header .toggle-icon { font-size: 1.2em; transition: transform 0.3s ease-out; }
        .collapsible-header.collapsed .toggle-icon { transform: rotate(-90deg); }
        .saves-content { overflow: hidden; transition: all 0.5s ease-in-out; max-height: 1000px; }
        .saves-content.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0; opacity: 0; }

        /* --- Cloud & Local Saves Sections (Styled like notes.html) --- */
        .cloud-saves-section, .local-saves-section { padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .cloud-saves-section { background: #fff; }
        .local-saves-section { background: #fffbef; border: 1px solid #ffeeba; }

        .saves-header h3 { margin-top: 0; margin-bottom: 0; font-size: 1.2em; }
        .cloud-saves-section h3 { color: #333; }
        .local-saves-section h3 { color: #856404; }

        .header-controls { display: flex; align-items: center; gap: 10px; }
        #refreshCloudSavesBtn { background: none; border: none; padding: 5px; border-radius: 50%; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; width: auto; height: auto; }
        #refreshCloudSavesBtn img { width: 18px; height: 18px; display: block; }
        #refreshCloudSavesBtn:hover { background-color: rgba(103, 32, 189, 0.1); }
        #refreshCloudSavesBtn:disabled { cursor: not-allowed; opacity: 0.5; background-color: transparent; }
        @keyframes spin-clockwise { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #refreshCloudSavesBtn.refreshing img { animation: spin-clockwise 0.8s linear infinite; }

        .save-stats { font-size: 0.85em; color: #555; padding: 10px 0; }
        
        /* --- Universal Save List Styles (from notes.html) --- */
        #cloudSavesList, #localSavesList { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; }
        #cloudSavesList li, #localSavesList li { display: flex; justify-content: space-between; align-items: center; padding: 10px; font-size: 0.9em; animation: fadeInListItem 0.4s ease-out forwards; background-color: #ffffff; margin-bottom: 5px; border-radius: 4px; border-left: 4px solid; }
        #cloudSavesList li { border-color: #8a2be2; }
        #localSavesList li { border-color: #ffc107; }
        #cloudSavesList li.loading-item, #localSavesList li.loading-item { text-align: center; color: #777; font-style: italic; padding: 20px; animation: none; border-left: none; background: transparent; }
        .save-info { flex-grow: 1; margin-right: 10px; }
        .save-name { font-weight: 600; }
        #cloudSavesList .save-name { color: #6720bd; }
        #localSavesList .save-name { color: #856404; }
        .save-details { font-size: 0.8em; color: #777; }
        .save-actions { display: flex; flex-shrink: 0; }
        .save-actions button { background: none; border: 1px solid transparent; padding: 5px 8px; border-radius: 8px; cursor: pointer; margin-left: 8px; font-size: 0.85em; transition: all 0.2s; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; white-space: nowrap; }
        .save-actions .open-save-btn { color: #28a745; border-color: #28a745; }
        .save-actions .open-save-btn:hover { background: #28a745; color: white;}
        .save-actions .edit-save-btn { color: #ffc107; border-color: #ffc107; }
        .save-actions .edit-save-btn:hover { background: #ffc107; color: #212529;}
        .save-actions .delete-save-btn { color: #dc3545; border-color: #dc3545;}
        .save-actions .delete-save-btn:hover { background: #dc3545; color: white;}

        /* --- Modal Styles (for adding/editing) --- */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 1000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        #modal-overlay.visible { display: flex; opacity: 1; }
        #modal-content { background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s ease; }
        #modal-overlay.visible #modal-content { transform: scale(1); }
        #modal-content h3 { margin-top: 0; font-family: 'PrimaryFont', sans-serif; color: #333; font-size: 1.5em; }
        #modal-content label { display: block; margin-bottom: 8px; font-size: 0.9em; color: #555; font-weight: 600; }
        #modal-content input[type="text"] { width: 100%; box-sizing: border-box; padding: 12px; font-size: 1em; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; }
        .modal-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-modal-save { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); border: none; color: #fff; padding: 10px 20px; border-radius: 8px; font-family: 'PrimaryFont', sans-serif; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        .btn-modal-cancel { background: #6c757d; border: none; color: #fff; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }

        /* Status Messages (from notes.html) */
        #statusMessages { padding: 10px; margin-top: 10px; border-radius: 5px; font-size: 0.9em; text-align: center; display: none; }
        .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
        .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
        .status-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;}
        .status-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;}
        
        /* Animations */
        .fade-in { animation: fadeInGeneral 0.5s ease-out; }
        @keyframes fadeInGeneral { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeInListItem { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body class="dashboard-page">
    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" /></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <div class="user-info">
                <div class="marquee-container"><span id="userName" class="marquee-content username">Loading…</span></div>
                <div class="marquee-container"><span id="userEmail" class="marquee-content email">Loading…</span></div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">🛡️</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="others.html" class="active"><span class="icon">✨</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content fade-in">
            <div class="dashboard-header">
                <div class="dashboard-header-title-container">
                    <h2 class="dashboard-title">COUNTDOWNS</h2>
                    <span style="font-size: 1.8em; line-height: 1;">⏱️</span>
                </div>
            </div>

            <div class="countdown-container">
                <div class="countdown-controls">
                    <button id="addCountdownBtn">✨ Add New Countdown</button>
                </div>

                <div class="active-countdown-display">
                    <h3 id="activeCountdownName">No Countdown Selected</h3>
                    <div class="timer-display" id="timerDisplay">Select or create a countdown to begin.</div>
                </div>

                <div class="cloud-saves-section">
                    <div class="cloud-saves-header collapsible-header" data-target="#cloudSavesContent">
                        <h3>☁️ Cloud Countdowns</h3>
                        <div class="header-controls">
                            <button id="refreshCloudSavesBtn" title="Refresh Cloud Saves">
                                <img src="../images/refresh-dark.png" alt="Refresh Saves">
                            </button>
                            <span class="toggle-icon">▼</span>
                        </div>
                    </div>
                    <div id="cloudSavesContent" class="saves-content">
                        <div class="save-stats">
                            Slots: <span id="cloudSaveSlotsUsed">0</span>/5 | 
                            Daily Actions Left: <span id="dailyActionsLeft">3</span>
                        </div>
                        <ul id="cloudSavesList"></ul>
                    </div>
                </div>

                <div class="local-saves-section">
                    <div class="local-saves-header collapsible-header" data-target="#localSavesContent">
                        <h3>💻 Local Countdowns</h3>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div id="localSavesContent" class="saves-content">
                        <div class="save-stats" id="localSaveStats">Loading storage info...</div>
                        <ul id="localSavesList"></ul>
                    </div>
                </div>
                <div id="statusMessages"></div>
            </div>
        </main>
    </div>

    <div id="modal-overlay">
        <div id="modal-content">
            <h3 id="modalTitle">Add New Countdown</h3>
            <form id="countdownForm">
                <label for="nameInput">Name:</label>
                <input type="text" id="nameInput" placeholder="e.g., World Domination" required maxlength="100">
                
                <label for="dateTimePicker">Target Date & Time:</label>
                <input type="text" id="dateTimePicker" placeholder="Select date and time..." required>

                <div class="modal-actions">
                    <button type="button" id="cancelFormBtn" class="btn-modal-cancel">Cancel</button>
                    <button type="submit" class="btn-modal-save">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // --- Global Config ---
        const MAX_CLOUD_SAVES = 5;
        const MAX_DAILY_ACTIONS = 3;

        // --- DOM Elements ---
        const addCountdownBtn = document.getElementById('addCountdownBtn');
        const activeCountdownNameEl = document.getElementById('activeCountdownName');
        const timerDisplayEl = document.getElementById('timerDisplay');
        const statusMessagesEl = document.getElementById('statusMessages');
        
        // Cloud DOM
        const cloudSavesListEl = document.getElementById('cloudSavesList');
        const cloudSaveSlotsUsedEl = document.getElementById('cloudSaveSlotsUsed');
        const dailyActionsLeftEl = document.getElementById('dailyActionsLeft');
        const refreshCloudSavesBtn = document.getElementById('refreshCloudSavesBtn');
        
        // Local DOM
        const localSavesListEl = document.getElementById('localSavesList');
        const localSaveStatsEl = document.getElementById('localSaveStats');

        // Modal DOM
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modalTitle');
        const countdownForm = document.getElementById('countdownForm');
        const nameInput = document.getElementById('nameInput');
        const dateTimePicker = document.getElementById('dateTimePicker');
        const cancelFormBtn = document.getElementById('cancelFormBtn');
        const modalSaveBtn = modalOverlay.querySelector('.btn-modal-save');
        
        // Sidebar DOM
        const sidebarUserNameEl = document.getElementById('userName');
        const sidebarUserEmailEl = document.getElementById('userEmail');
        
        // --- State Variables ---
        let currentUser = null;
        let countdownInterval = null;
        let flatpickrInstance;
        let editingContext = { isEditing: false, type: null, id: null };
        
        // --- Firebase Refs ---
        const userCountdownsDocRef = () => currentUser ? firebase.firestore().collection('countdownApp').doc(currentUser.uid) : null;
        const userProfileDocRef = () => currentUser ? firebase.firestore().collection('users').doc(currentUser.uid) : null;

        // --- Utility Functions (from notes.html) ---
        const showStatusMessage = (message, type = 'info', duration = 4000) => {
            statusMessagesEl.textContent = message;
            statusMessagesEl.className = ''; statusMessagesEl.classList.add(`status-${type}`);
            statusMessagesEl.style.display = 'block';
            if (duration) setTimeout(() => { statusMessagesEl.style.display = 'none'; }, duration);
        };
        const bytesToSize = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + ['Bytes', 'KB', 'MB', 'GB', 'TB'][i];
        };
        const getTodaysDateString = () => new Date().toISOString().slice(0, 10);
        const generateLocalId = () => Date.now().toString();

        // --- Countdown Timer Logic ---
        function updateTimer(targetTimestamp) {
            const now = new Date().getTime();
            const distance = targetTimestamp - now;

            if (distance < 0) {
                clearInterval(countdownInterval);
                timerDisplayEl.textContent = "🎉 Countdown Finished!";
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            let html = '';
            if (days > 0) html += `<span class="time-unit">${days}<span class="time-label">d</span></span>`;
            if (hours > 0 || html) html += `<span class="time-unit">${hours}<span class="time-label">h</span></span>`;
            if (minutes > 0 || html) html += `<span class="time-unit">${minutes}<span class="time-label">m</span></span>`;
            html += `<span class="time-unit">${seconds}<span class="time-label">s</span></span>`;
            
            timerDisplayEl.innerHTML = html;
        }

        function setActiveCountdown(countdown) {
            clearInterval(countdownInterval);
            activeCountdownNameEl.textContent = countdown.name;
            const targetTime = new Date(countdown.targetDate).getTime();
            updateTimer(targetTime);
            countdownInterval = setInterval(() => updateTimer(targetTime), 1000);
        }

        // --- Modal Logic ---
        function openModal({ isEditing = false, type = null, countdown = null }) {
            editingContext = { isEditing, type, id: countdown ? countdown.id : null };
            modalTitle.textContent = isEditing ? `Edit ${type} Countdown` : 'Add New Countdown';
            modalSaveBtn.textContent = isEditing ? 'Save Changes' : 'Save';
            nameInput.value = countdown ? countdown.name : '';
            flatpickrInstance.setDate(countdown ? new Date(countdown.targetDate) : new Date());
            modalOverlay.classList.add('visible');
        }

        function closeModal() {
            countdownForm.reset();
            flatpickrInstance.clear();
            modalOverlay.classList.remove('visible');
            editingContext = { isEditing: false, type: null, id: null };
        }

        // --- Local Saves Logic ---
        const updateLocalStorageEstimate = async () => { /* ... (same as notes.html) ... */ };
        const getLocalSaves = () => JSON.parse(localStorage.getItem('4sp_localCountdowns') || '[]');
        const saveLocalSaves = (saves) => {
            try {
                localStorage.setItem('4sp_localCountdowns', JSON.stringify(saves));
                return true;
            } catch (e) {
                showStatusMessage('Local storage quota exceeded or disabled.', 'error');
                return false;
            }
        };

        function renderLocalSaves() {
            const saves = getLocalSaves().sort((a,b) => b.id - a.id);
            localSavesListEl.innerHTML = '';
            if (saves.length === 0) {
                localSavesListEl.innerHTML = '<li class="loading-item">No local countdowns yet.</li>';
                return;
            }
            saves.forEach(save => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="save-info">
                        <span class="save-name">${save.name}</span>
                        <div class="save-details">Target: ${new Date(save.targetDate).toLocaleString()}</div>
                    </div>
                    <div class="save-actions">
                        <button class="open-save-btn" data-id="${save.id}">Open</button>
                        <button class="edit-save-btn" data-id="${save.id}">Edit</button>
                        <button class="delete-save-btn" data-id="${save.id}">Delete</button>
                    </div>`;
                localSavesListEl.appendChild(li);
            });
            updateLocalStorageEstimate();
        }

        // --- Cloud Saves Logic ---
        const updateDailyActionCountUI = (data) => {
            const record = data.dailyActionRecord || {};
            const actionsLeft = (record.date === getTodaysDateString()) ? Math.max(0, MAX_DAILY_ACTIONS - record.count) : MAX_DAILY_ACTIONS;
            dailyActionsLeftEl.textContent = actionsLeft;
        };

        async function renderCloudSaves() {
            if (!currentUser) {
                cloudSavesListEl.innerHTML = '<li class="loading-item">Login to see cloud saves.</li>';
                return;
            }
            refreshCloudSavesBtn.classList.add('refreshing'); refreshCloudSavesBtn.disabled = true;
            try {
                const docSnap = await userCountdownsDocRef().get();
                cloudSavesListEl.innerHTML = '';
                if (docSnap.exists) {
                    const data = docSnap.data();
                    const saves = (data.countdowns || []).sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                    cloudSaveSlotsUsedEl.textContent = saves.length;
                    updateDailyActionCountUI(data);

                    if (saves.length === 0) {
                        cloudSavesListEl.innerHTML = '<li class="loading-item">No cloud countdowns yet.</li>';
                    } else {
                        saves.forEach(save => {
                            const li = document.createElement('li');
                            li.innerHTML = `
                                <div class="save-info">
                                    <span class="save-name">${save.name}</span>
                                    <div class="save-details">Target: ${save.targetDate.toDate().toLocaleString()}</div>
                                </div>
                                <div class="save-actions">
                                    <button class="open-save-btn" data-id="${save.id}">Open</button>
                                    <button class="edit-save-btn" data-id="${save.id}">Edit</button>
                                    <button class="delete-save-btn" data-id="${save.id}">Delete</button>
                                </div>`;
                            cloudSavesListEl.appendChild(li);
                        });
                    }
                } else {
                    cloudSavesListEl.innerHTML = '<li class="loading-item">No cloud data. Start saving!</li>';
                    cloudSaveSlotsUsedEl.textContent = '0';
                    updateDailyActionCountUI({});
                }
            } catch (error) {
                showStatusMessage('Error fetching cloud data.', 'error');
                cloudSavesListEl.innerHTML = `<li class="loading-item">Error loading.</li>`;
            } finally {
                refreshCloudSavesBtn.classList.remove('refreshing'); refreshCloudSavesBtn.disabled = false;
            }
        }
        
        // --- Combined Save/Edit/Delete Logic ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            const name = nameInput.value.trim();
            const targetDate = flatpickrInstance.selectedDates[0];
            if (!name || !targetDate) return showStatusMessage('Name and date are required.', 'warning');
            if (targetDate < new Date()) return showStatusMessage('Target date must be in the future.', 'warning');
            
            const { isEditing, type, id } = editingContext;
            const countdownData = { id: isEditing ? id : generateLocalId(), name, targetDate: targetDate.toISOString() };
            
            // Determine save target: prompt user if it's a new countdown
            let saveTarget = type;
            if (!isEditing) {
                saveTarget = prompt("Save to 'cloud' or 'local' storage?", "local")?.toLowerCase();
                if (!['cloud', 'local'].includes(saveTarget)) return showStatusMessage('Invalid save location.', 'warning');
            }
            
            modalSaveBtn.disabled = true; modalSaveBtn.textContent = 'Saving...';
            
            if (saveTarget === 'local') {
                let saves = getLocalSaves();
                if (isEditing) {
                    const index = saves.findIndex(s => s.id === id);
                    if (index > -1) saves[index] = countdownData;
                } else {
                    saves.push(countdownData);
                }
                if (saveLocalSaves(saves)) {
                    showStatusMessage(`Countdown saved locally.`, 'success');
                    renderLocalSaves();
                    closeModal();
                }
            } else if (saveTarget === 'cloud') {
                if (!currentUser) return showStatusMessage('Must be logged in for cloud saves.', 'error');
                try {
                    await saveToCloud(countdownData, isEditing);
                    showStatusMessage(`Countdown saved to cloud.`, 'success');
                    await renderCloudSaves();
                    closeModal();
                } catch(error) {
                    showStatusMessage(`Cloud Error: ${error.message}`, 'error', 6000);
                }
            }
            modalSaveBtn.disabled = false; modalSaveBtn.textContent = isEditing ? 'Save Changes' : 'Save';
        }

        async function saveToCloud(countdownData, isEditing) {
            const docRef = userCountdownsDocRef();
            await firebase.firestore().runTransaction(async (transaction) => {
                const docSnap = await transaction.get(docRef);
                const data = docSnap.exists ? docSnap.data() : {};
                const countdowns = data.countdowns || [];
                const dailyRecord = data.dailyActionRecord || { date: '', count: 0 };
                const today = getTodaysDateString();

                if (dailyRecord.date === today && dailyRecord.count >= MAX_DAILY_ACTIONS) {
                    throw new Error(`Daily action limit of ${MAX_DAILY_ACTIONS} reached.`);
                }
                
                const newActionCount = dailyRecord.date === today ? dailyRecord.count + 1 : 1;
                const newDailyRecord = { date: today, count: newActionCount };
                const fbCountdownData = { ...countdownData, targetDate: new Date(countdownData.targetDate), createdAt: new Date() };

                if (isEditing) {
                    const index = countdowns.findIndex(c => c.id === countdownData.id);
                    if (index === -1) throw new Error("Countdown to edit not found.");
                    countdowns[index] = { ...countdowns[index], ...fbCountdownData };
                } else {
                    if (countdowns.length >= MAX_CLOUD_SAVES) throw new Error(`Cloud slot limit of ${MAX_CLOUD_SAVES} reached.`);
                    fbCountdownData.id = firebase.firestore().collection('_').doc().id; // Generate a secure cloud ID
                    countdowns.push(fbCountdownData);
                }
                transaction.set(docRef, { countdowns, dailyActionRecord: newDailyRecord }, { merge: true });
            });
        }

        async function handleDelete(type, id) {
            if (type === 'local') {
                let saves = getLocalSaves();
                const saveName = saves.find(s => s.id === id)?.name || 'this countdown';
                if (!confirm(`Delete local countdown "${saveName}"?`)) return;
                const updatedSaves = saves.filter(s => s.id !== id);
                if(saveLocalSaves(updatedSaves)) {
                    showStatusMessage('Local countdown deleted.', 'success');
                    renderLocalSaves();
                }
            } else if (type === 'cloud') {
                 if (!currentUser) return showStatusMessage('Must be logged in.', 'error');
                 const docRef = userCountdownsDocRef();
                 try {
                    const initialDoc = await docRef.get();
                    const saveName = initialDoc.data()?.countdowns?.find(c => c.id === id)?.name || 'this countdown';
                    if (!confirm(`Delete cloud countdown "${saveName}"? This is permanent.`)) return;
                    
                    await firebase.firestore().runTransaction(async (transaction) => {
                        const docSnap = await transaction.get(docRef);
                        if (!docSnap.exists) throw new Error("User data not found.");
                        let countdowns = docSnap.data().countdowns || [];
                        const updatedCountdowns = countdowns.filter(c => c.id !== id);
                        transaction.update(docRef, { countdowns: updatedCountdowns });
                    });
                    showStatusMessage('Cloud countdown deleted.', 'success');
                    await renderCloudSaves();
                 } catch (error) {
                    showStatusMessage(`Delete Error: ${error.message}`, 'error');
                 }
            }
        }
        
        // --- Event Listeners & Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // General Listeners
            addCountdownBtn.addEventListener('click', () => openModal({}));
            cancelFormBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeModal(); });
            countdownForm.addEventListener('submit', handleFormSubmit);
            refreshCloudSavesBtn.addEventListener('click', renderCloudSaves);
            
            // List click delegation
            [cloudSavesListEl, localSavesListEl].forEach(list => {
                list.addEventListener('click', async e => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const id = button.dataset.id;
                    const type = list === cloudSavesListEl ? 'cloud' : 'local';
                    
                    let countdown;
                    if (type === 'local') {
                        countdown = getLocalSaves().find(s => s.id === id);
                    } else {
                        const doc = await userCountdownsDocRef().get();
                        const cloudCountdown = doc.data().countdowns.find(c => c.id === id);
                        if (cloudCountdown) countdown = { ...cloudCountdown, targetDate: cloudCountdown.targetDate.toDate().toISOString() };
                    }
                    if (!countdown) return showStatusMessage('Countdown not found.', 'error');
                    
                    if (button.classList.contains('open-save-btn')) setActiveCountdown(countdown);
                    else if (button.classList.contains('edit-save-btn')) openModal({ isEditing: true, type, countdown });
                    else if (button.classList.contains('delete-save-btn')) await handleDelete(type, id);
                });
            });

            // UI Setup
            flatpickrInstance = flatpickr("#dateTimePicker", { enableTime: true, dateFormat: "Y-m-d H:i", altInput: true, altFormat: "F j, Y at h:i K" });
            document.querySelectorAll('.collapsible-header').forEach(h => h.addEventListener('click', () => {
                const content = document.querySelector(h.dataset.target);
                if (content) { h.classList.toggle('collapsed'); content.classList.toggle('collapsed'); }
            }));
const setupSidebar = () => {
    const sidebar = document.getElementById('sidebar');
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    if (toggleSidebarBtn && sidebar) {
        toggleSidebarBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            setTimeout(updateMarquees, 550);
        });
    }
    const navLinks = document.querySelectorAll('.sidebar nav a');
    navLinks.forEach(link => {
        link.classList.remove('active');
        const currentPageName = window.location.pathname.split('/').pop();
        const othersLink = Array.from(navLinks).find(l => l.getAttribute('href') === 'others.html');
        if (othersLink && (currentPageName === 'notes.html' || currentPageName === 'others.html' || currentPageName === 'countdowns.html')) {
            othersLink.classList.add('active');
        } else if (link.getAttribute('href') === currentPageName) {
            link.classList.add('active');
        }
    });
    document.getElementById('logoutBtn').onclick = handleLogout;
    document.getElementById('signOutLink').onclick = handleLogout;
};            setupSidebar();

            // Auth
            firebase.auth().onAuthStateChanged(async user => {
                if (!user) {
                    location.href = '../login.html';
                    return;
                }
                currentUser = user;
                // Fetch profile and data
                try {
                    const profileSnap = await userProfileDocRef().get();
                    sidebarUserNameEl.textContent = profileSnap.data()?.username || user.email;
                    sidebarUserEmailEl.textContent = user.email;
                } catch(e) { sidebarUserNameEl.textContent = user.email; }
                
                await renderCloudSaves();
                renderLocalSaves();
            });
        });
    </script>
</body>
</html>
