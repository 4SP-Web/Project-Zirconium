<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - NOTES</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <script src="../panic-key.js"></script>
  <script src="../ban-enforcer.js"></script>
  <script src="../url-changer.js"></script>
  <style>
    /* --- Dashboard Layout --- */
    body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: 'PrimaryFont', sans-serif; }
    .dashboard-container { display: flex; flex: 1; }

    /* --- Sidebar --- */
    .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.collapsed { width: 85px; }
    #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
    .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
    .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
    .sidebar nav li { margin-bottom: 10px; }
    .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; position: relative; overflow: hidden; }
    .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
    .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
    .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
    .sidebar.collapsed nav a { justify-content: center; padding: 10px 0; }
    .sidebar.collapsed nav a .label { display: none; }
    .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: visible; }
    .user-info .username { font-family: 'PrimaryFont', sans-serif; font-size: 1.3em; margin-bottom: 8px; line-height: 0.2em; font-weight: bold; }
    .user-info .email { font-family: 'SecondaryFont', sans-serif; font-size: 0.9em; color: #bbb; }
    
    /* --- Marquee --- */
    .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em; }
    .marquee-content-wrapper { display: inline-block; }
    .marquee-content-wrapper.is-scrolling { animation: marquee-scroll 15s linear infinite; }
    .marquee-content-wrapper > span { display: inline-block; padding-right: 3em; }
    .user-info .marquee-content.is-scrolling { animation-name: marquee-scroll-sidebar; }
    @keyframes marquee-scroll { from { transform: translateX(0); } to { transform: translateX(-50%); } }
    @keyframes marquee-scroll-sidebar { from { transform: translateX(0); } to { transform: translateX(-100%); } }

    /* --- Main Content & Header --- */
    .main-content { flex: 1; padding: 30px; background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%); overflow-y: auto; position: relative; display: flex; flex-direction: column; }
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(103, 32, 189, 0.1); flex-shrink: 0; }
    .dashboard-title { margin: 0; font-size: 2.0em; font-weight: bold; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

    /* --- Notes Page Specific Styles --- */
    .notes-container { display: flex; flex-direction: column; flex-grow: 1; gap: 20px; }
    .notes-controls { background: #fff; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .notes-controls button, .modal-footer button, .action-modal-buttons button { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); border: none; color: #fff; padding: 10px 15px; border-radius: 8px; font-family: 'PrimaryFont', sans-serif; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; font-weight: 600; }
    .notes-controls button:hover, .modal-footer button:hover, .action-modal-buttons button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(103, 32, 189, 0.25); }
    #importFileBtn { background: linear-gradient(135deg, #17a2b8 0%, #1f95a3 100%); }
    #importFileBtn:hover { box-shadow: 0 6px 15px rgba(23, 162, 184, 0.3); }
    #copyAllBtn { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); }
    #copyAllBtn:hover { box-shadow: 0 6px 15px rgba(108, 117, 125, 0.25); }
    #saveNoteBtn { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); }
    #saveNoteBtn:hover { box-shadow: 0 6px 15px rgba(0, 123, 255, 0.3); }

    #notesTextArea { flex-grow: 1; width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Roboto', sans-serif; font-size: 1em; line-height: 1.6; resize: vertical; min-height: 250px; box-sizing: border-box; }
    .char-count-display { font-size: 0.85em; color: #555; text-align: right; padding: 5px 0; margin-top: -15px; }

    /* --- Saves Section --- */
    .notes-storage-section { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .storage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; flex-wrap: wrap; gap: 15px; }
    .storage-header h3 { margin: 0; color: #333; font-size: 1.2em; flex-grow: 1; }
    #storageStats { font-size: 0.85em; color: #555; font-family: 'SecondaryFont', sans-serif; text-align: right; }
    .saves-content-wrapper ul { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; padding-right: 5px; }
    .no-items-message { color: #888; font-style: italic; padding: 20px; text-align: center; background: #f9f9fc; border-radius: 8px; }
    .saves-content-wrapper li { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.03); transition: all 0.3s; }
    .saves-content-wrapper li.has-custom-color { color: white; }
    .save-info { flex-grow: 1; min-width: 0; margin-right: 10px; }
    .save-name { font-weight: bold; font-size: 1.05em; color: #856404; }
    .has-custom-color .save-name { color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.4); }
    .save-details { font-size: 0.8em; color: #777; margin-top: 3px; font-family: 'SecondaryFont', sans-serif; }
    .has-custom-color .save-details { color: #eee; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
    
    /* --- Save Actions --- */
    .save-actions { display: flex; flex-shrink: 0; }
    .save-actions button { background: none; border: 1.5px solid; padding: 6px 10px; border-radius: 8px; cursor: pointer; margin-left: 4px; font-size: 0.9em; transition: all 0.2s ease-in-out; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-weight: bold; }
    .has-custom-color .save-actions button { background-color: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.4); color: white; text-shadow: 0 0 4px rgba(0,0,0,0.5); }
    .save-actions .open-save-btn { background: rgba(0, 123, 255, 0.1); border-color: #007bff; color: #007bff; }
    .save-actions .open-save-btn:hover, .has-custom-color .save-actions .open-save-btn:hover { background: #007bff; color: #fff; border-color: #007bff; box-shadow: 0 2px 6px rgba(0,123,255,0.3); }
    .save-actions .export-save-btn { background: rgba(23, 162, 184, 0.1); border-color: #17a2b8; color: #17a2b8; }
    .save-actions .export-save-btn:hover, .has-custom-color .save-actions .export-save-btn:hover { background: #17a2b8; color: #fff; border-color: #17a2b8; box-shadow: 0 2px 6px rgba(23, 162, 184, 0.3); }
    .save-actions .edit-save-btn { background: rgba(255, 193, 7, 0.1); border-color: #ffc107; color: #856404; }
    .save-actions .edit-save-btn:hover, .has-custom-color .save-actions .edit-save-btn:hover { background: #ffc107; color: #212529; border-color: #ffc107; box-shadow: 0 2px 6px rgba(255,193,7,0.3); }
    .save-actions .delete-save-btn { background: rgba(220, 53, 69, 0.1); border-color: #dc3545; color: #dc3545; }
    .save-actions .delete-save-btn:hover, .has-custom-color .save-actions .delete-save-btn:hover { background: #dc3545; color: #fff; border-color: #dc3545; box-shadow: 0 2px 6px rgba(220,53,69,0.3); }

    /* --- Modals --- */
    .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; display: flex; align-items: center; justify-content: center; }
    .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
    .modal-content { background: #fff; width: 90%; max-width: 600px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 90vh; transform: scale(0.95); transition: transform 0.3s ease; }
    #actionModal .modal-content { max-width: 450px; }
    .modal-backdrop.visible .modal-content { transform: scale(1); }
    .modal-header { padding: 20px 25px; border-bottom: 1px solid #eee; position: relative; }
    .modal-header h2 { margin: 0; font-size: 1.5em; color: #333; }
    .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; cursor: pointer; padding: 5px; line-height: 0; }
    .close-btn img { width: 20px; height: 20px; filter: invert(80%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(100%) contrast(100%); transition: filter 0.3s ease; }
    .close-btn:hover img { filter: invert(10%) sepia(10%) saturate(0%) hue-rotate(240deg) brightness(100%) contrast(100%); }
    .modal-body { flex-grow: 1; overflow-y: auto; padding: 25px; }
    .modal-body .form-group { margin-bottom: 20px; }
    .modal-body label { font-weight: bold; color: #555; margin-bottom: 8px; display: block; }
    .form-group-header { display: flex; justify-content: space-between; align-items: center; }
    .char-counter { font-size: 0.8em; font-weight: normal; color: #777; }
    .modal-body input[type="text"], .modal-body input[type="password"], .modal-body textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; background: #f8f9fa; font-family: 'SecondaryFont', sans-serif; font-size: 1em; box-sizing: border-box; }
    .modal-body textarea { resize: vertical; min-height: 80px; }
    .password-note { font-size: 0.8em; color: #777; margin-top: 5px; }
    .modal-footer { padding: 15px 25px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; align-items: center; gap: 10px; overflow: hidden; }
    #exportAs4SPBtn { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
    #exportAs4SPBtn:hover { box-shadow: 0 6px 15px rgba(40, 167, 69, 0.3); }
    .color-palette { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease; }
    .color-swatch:hover { transform: scale(1.1); }
    .color-swatch.selected { border-color: #6720bd; box-shadow: 0 0 10px rgba(103,32,189,0.5); }
    #notePreview { border-radius: 8px; margin-top: 8px; position: relative; overflow: hidden; }
    #actionModalMessage { margin-top: 0; font-size: 1.1em; line-height: 1.6; }
    .action-modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
    .action-modal-buttons .confirm-btn { background: #007bff; }
    .action-modal-buttons .delete-btn { background: #dc3545; }
    .action-modal-buttons .cancel-btn { background: #6c757d; }

    /* Status Messages */
    #statusMessages { padding: 10px; margin-top: 10px; border-radius: 5px; font-size: 0.9em; text-align: center; display: none; }
    .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
    .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
    .status-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;}
    .status-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;}

    /* Animations & Responsive */
    .fade-in { animation: fadeInGeneral 0.5s ease-out; }
    @keyframes fadeInGeneral { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 768px) {
      .main-content { padding: 15px; }
      .dashboard-header { padding: 15px 20px; margin-bottom: 15px;}
      .notes-controls { flex-direction: column; align-items: stretch; }
      .saves-content-wrapper li { flex-direction: column; align-items: flex-start; gap: 8px; }
      .save-info { margin-right: 0; }
      .save-actions { width: 100%; justify-content: flex-start; }
      .save-actions button { margin-left: 0; margin-right: 8px; }
    }
  </style>
</head>

<body class="dashboard-page">
  <header class="main-header light-bg">
    <div class="container">
      <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" /></a></div>
      <div class="auth-buttons"><button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button><button id="logoutBtn" class="btn btn-login">LOG OUT</button></div>
    </div>
  </header>

  <div class="dashboard-container">
    <aside class="sidebar" id="sidebar">
      <button id="toggleSidebar">☰</button>
      <div class="user-info">
        <div class="marquee-container"><span id="userName" class="marquee-content-wrapper"><span>Loading…</span></span></div>
        <div class="marquee-container"><span id="userEmail" class="marquee-content-wrapper"><span>Loading…</span></span></div>
      </div>
      <nav>
        <ul>
          <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
          <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
          <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
          <li><a href="others.html" class="active"><span class="icon">✨</span><span class="label">Others</span></a></li>
          <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
          <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content fade-in">
      <div class="dashboard-header">
        <div class="dashboard-header-title-container"><h2 class="dashboard-title">NOTES</h2><span style="font-size: 1.8em; line-height: 1;">📝</span></div>
      </div>

      <div class="notes-container">
        <div class="notes-controls">
            <input type="file" id="importFile" accept=".txt,.html,.css,.js,.json,text/*" style="display: none;">
            <button id="importFileBtn" onclick="document.getElementById('importFile').click();">Import File</button>
            <button id="copyAllBtn">Copy All</button>
            <button id="saveNoteBtn">Save Note</button>
        </div>

        <textarea id="notesTextArea" placeholder="Start typing your notes here..."></textarea>
        <div class="char-count-display"><span id="charCount">0</span> characters</div>

        <div class="notes-storage-section">
            <div class="storage-header"><h3>Your Saves</h3><div id="storageStats">Loading...</div></div>
            <div class="saves-content-wrapper"><ul id="savesList"></ul></div>
        </div>

        <div id="statusMessages"></div>
      </div>
    </main>
  </div>

  <div id="saveModal" class="modal-backdrop">
    <div class="modal-content">
        <div class="modal-header"><h2 id="saveModalTitle">Save New Note</h2><button id="closeSaveModalBtn" class="close-btn"><img src="../images/cross-white.png" alt="Close"></button></div>
        <div class="modal-body">
            <input type="hidden" id="saveNoteIdInput">
            <div class="form-group">
                <div class="form-group-header"><label for="saveNameInput">Note Name</label><span id="nameCharCounter" class="char-counter"></span></div>
                <input type="text" id="saveNameInput" maxlength="50" placeholder="e.g., My Brilliant Idea">
            </div>
            <div class="form-group">
                <div class="form-group-header"><label for="saveDescriptionInput">Description (Optional)</label><span id="descCharCounter" class="char-counter"></span></div>
                <textarea id="saveDescriptionInput" maxlength="150" placeholder="A short summary of the note's content..."></textarea>
            </div>
            <div class="form-group">
                <label>Color</label>
                <div class="color-palette" id="colorPalette"></div>
            </div>
            <div>
                <label>Live Preview</label>
                <div id="notePreview"></div>
            </div>
        </div>
        <div class="modal-footer"><button id="confirmSaveBtn">Save Note</button></div>
    </div>
  </div>

  <div id="exportModal" class="modal-backdrop">
    <div class="modal-content">
        <div class="modal-header"><h2 id="exportModalTitle">Export Note</h2><button id="closeExportModalBtn" class="close-btn"><img src="../images/cross-white.png" alt="Close"></button></div>
        <div class="modal-body">
            <input type="hidden" id="exportNoteIdInput">
            <p>Choose how you would like to export your note.</p>
            <div class="form-group"><label for="exportFileNameInput">Filename</label><input type="text" id="exportFileNameInput" placeholder="my_note"></div>
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            <h4>4SP Export Option</h4>
            <div class="form-group">
                <label for="exportPasswordInput">Password (Optional)</label>
                <input type="password" id="exportPasswordInput" maxlength="48" placeholder="4-48 characters for encryption">
                <p class="password-note">Leave blank for no password. The password is not recoverable.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button id="exportAsFileBtn">Export File</button>
            <button id="exportAs4SPBtn">Export as 4SP Note (.json)</button>
        </div>
    </div>
  </div>

  <div id="importPasswordModal" class="modal-backdrop">
    <div class="modal-content">
        <div class="modal-header"><h2>Password Required</h2><button id="closeImportPasswordModalBtn" class="close-btn"><img src="../images/cross-white.png" alt="Close"></button></div>
        <div class="modal-body">
            <p>This 4SP Note file is encrypted. Please enter the password to import it.</p>
            <div class="form-group"><label for="importPasswordInput">Password</label><input type="password" id="importPasswordInput" placeholder="Enter password"></div>
        </div>
        <div class="modal-footer"><button id="submitImportPasswordBtn">Import</button></div>
    </div>
  </div>

  <div id="actionModal" class="modal-backdrop">
      <div class="modal-content">
          <div class="modal-header"><h2 id="actionModalTitle"></h2></div>
          <div class="modal-body">
              <p id="actionModalMessage"></p>
              <div class="action-modal-buttons"></div>
          </div>
      </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>
  <script>
    // --- DOM Elements ---
    const notesTextArea = document.getElementById('notesTextArea');
    const charCountEl = document.getElementById('charCount');
    const importFileEl = document.getElementById('importFile');
    const copyAllBtn = document.getElementById('copyAllBtn');
    const saveNoteBtn = document.getElementById('saveNoteBtn');
    const statusMessagesEl = document.getElementById('statusMessages');
    const savesListEl = document.getElementById('savesList');
    const storageStatsEl = document.getElementById('storageStats');
    const sidebarUserNameEl = document.getElementById('userName');
    const sidebarUserEmailEl = document.getElementById('userEmail');
    
    // --- Modals ---
    const saveModal = document.getElementById('saveModal');
    const saveModalTitle = document.getElementById('saveModalTitle');
    const closeSaveModalBtn = document.getElementById('closeSaveModalBtn');
    const saveNoteIdInput = document.getElementById('saveNoteIdInput');
    const saveNameInput = document.getElementById('saveNameInput');
    const saveDescriptionInput = document.getElementById('saveDescriptionInput');
    const colorPaletteEl = document.getElementById('colorPalette');
    const notePreviewEl = document.getElementById('notePreview');
    const confirmSaveBtn = document.getElementById('confirmSaveBtn');
    const nameCharCounter = document.getElementById('nameCharCounter');
    const descCharCounter = document.getElementById('descCharCounter');

    const exportModal = document.getElementById('exportModal');
    const closeExportModalBtn = document.getElementById('closeExportModalBtn');
    const exportAsFileBtn = document.getElementById('exportAsFileBtn');
    const exportAs4SPBtn = document.getElementById('exportAs4SPBtn');
    const exportNoteIdInput = document.getElementById('exportNoteIdInput');
    const exportFileNameInput = document.getElementById('exportFileNameInput');
    const exportModalTitle = document.getElementById('exportModalTitle');
    
    const importPasswordModal = document.getElementById('importPasswordModal');
    const closeImportPasswordModalBtn = document.getElementById('closeImportPasswordModalBtn');
    const submitImportPasswordBtn = document.getElementById('submitImportPasswordBtn');
    const importPasswordInput = document.getElementById('importPasswordInput');

    const actionModal = document.getElementById('actionModal');

    // --- State & Config ---
    let currentUser = null;
    let pendingEncryptedFile = null;
    let actionModalResolve = null;
    let selectedColor = null;
    const paletteColors = ['#ffffff', '#ff595e', '#ffca3a', '#8ac926', '#1982c4', '#6a4c93', '#f94144', '#f8961e', '#90be6d', '#43aa8b', '#577590'];

    // --- Utility Functions ---
    const showStatusMessage = (message, type = 'info', duration = 4000) => { statusMessagesEl.textContent = message; statusMessagesEl.className = ''; statusMessagesEl.classList.add(`status-${type}`); statusMessagesEl.style.display = 'block'; if (duration) { setTimeout(() => { statusMessagesEl.style.display = 'none'; }, duration); } };
    const bytesToSize = (bytes) => { if (bytes === 0) return '0 Bytes'; const k = 1024; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]; };
    const updateCharacterCount = () => { charCountEl.textContent = notesTextArea.value.length.toLocaleString(); };
    const sortSaves = (savesArray) => savesArray.sort((a, b) => (a.timestamp ? new Date(a.timestamp).getTime() : 0) < (b.timestamp ? new Date(b.timestamp).getTime() : 0) ? 1 : -1);
    const xorCipher = (str, key) => str.split('').map((char, i) => String.fromCharCode(char.charCodeAt(0) ^ key.charCodeAt(i % key.length))).join('');
    const base64ToUtf8 = (str) => decodeURIComponent(escape(atob(str)));
    const utf8ToBase64 = (str) => btoa(unescape(encodeURIComponent(str)));
    const handleCharCounter = (inputEl, counterEl) => { const len = inputEl.value.length; const max = inputEl.maxLength; counterEl.textContent = `${len} / ${max}`; };

    // --- UI and General Functions ---
    function initializeMarquees() {
        document.querySelectorAll('.marquee-container').forEach(container => {
            const wrapper = container.querySelector('.marquee-content-wrapper');
            if (!wrapper) return;
            const content = wrapper.querySelector('span');
            if (!content) return;
            if (wrapper.children.length > 1) { wrapper.removeChild(wrapper.lastChild); }
            wrapper.classList.remove('is-scrolling');
            const needsScrolling = content.scrollWidth > container.clientWidth;
            if (needsScrolling) {
                const clone = content.cloneNode(true);
                wrapper.appendChild(clone);
                wrapper.classList.add('is-scrolling');
            }
        });
    }
    const handleLogout = () => firebase.auth().signOut().then(() => { location.href = '../login.html'; }).catch(error => { console.error('Logout error:', error); showStatusMessage('Logout error: ' + error.message, 'error'); });
    const setupSidebar = () => { const sidebar = document.getElementById('sidebar'); const toggleSidebarBtn = document.getElementById('toggleSidebar'); if (toggleSidebarBtn && sidebar) { toggleSidebarBtn.addEventListener('click', () => { sidebar.classList.toggle('collapsed'); setTimeout(initializeMarquees, 550); }); } document.getElementById('logoutBtn').onclick = handleLogout; document.getElementById('signOutLink').onclick = handleLogout; };

    // --- Custom Modal ---
    const showActionModal = (config) => {
        return new Promise(resolve => {
            actionModalResolve = resolve;
            document.getElementById('actionModalTitle').textContent = config.title;
            document.getElementById('actionModalMessage').textContent = config.message;
            const buttonsContainer = document.querySelector('.action-modal-buttons');
            buttonsContainer.innerHTML = '';
            config.buttons.forEach(btnConfig => {
                const button = document.createElement('button');
                button.textContent = btnConfig.text;
                button.className = btnConfig.class;
                button.onclick = () => {
                    actionModal.classList.remove('visible');
                    actionModalResolve(btnConfig.value);
                };
                buttonsContainer.appendChild(button);
            });
            actionModal.classList.add('visible');
        });
    };

    // --- Top-level Note Functions ---
    const handleFileImport = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const content = e.target.result; if (file.name.endsWith('.json')) { try { const importObject = JSON.parse(content); if (importObject.dataType === '4sp_note_v1' && importObject.data) { if (importObject.encrypted) { pendingEncryptedFile = importObject; importPasswordModal.classList.add('visible'); } else { processDecryptedData(importObject.data); } } else { throw new Error('Not a valid 4SP note file.'); } } catch (jsonError) { notesTextArea.value = content; updateCharacterCount(); showStatusMessage(`File "${file.name}" imported as plain text.`, 'success'); } } else { notesTextArea.value = content; updateCharacterCount(); showStatusMessage(`File "${file.name}" imported successfully.`, 'success'); } }; reader.onerror = () => showStatusMessage(`Error reading file "${file.name}".`, 'error'); reader.readAsText(file); event.target.value = null; };
    const handleCopyAll = () => { const content = notesTextArea.value; if (!content) { showStatusMessage('Nothing to copy.', 'warning'); return; } navigator.clipboard.writeText(content).then(() => { showStatusMessage('All text copied to clipboard!', 'success'); }).catch(err => { console.error('Failed to copy text: ', err); showStatusMessage('Failed to copy. See browser console for details.', 'error'); }); };

    // --- Saves Logic ---
    const updateStorageStats = async () => { const saves = getSaves(); const count = saves.length; if (navigator.storage && navigator.storage.estimate) { try { const estimate = await navigator.storage.estimate(); storageStatsEl.innerHTML = `Saves: <b>${count}</b> | Storage Usage: <b>${bytesToSize(estimate.usage)}</b> / ${bytesToSize(estimate.quota)} estimated`; } catch (error) { storageStatsEl.innerHTML = `Saves: <b>${count}</b>`; } } else { const totalSize = new Blob([JSON.stringify(saves)]).size; storageStatsEl.innerHTML = `Saves: <b>${count}</b> | Total Size: <b>${bytesToSize(totalSize)}</b>`; } };
    const getSaves = () => { try { const saves = localStorage.getItem('4sp_notes'); return saves ? JSON.parse(saves) : []; } catch (error) { console.error("Error parsing saves:", error); return []; } };
    const saveSaves = (savesArray) => { try { localStorage.setItem('4sp_notes', JSON.stringify(savesArray)); return true; } catch (e) { if (e.name === 'QuotaExceededError') { showStatusMessage('Browser storage quota exceeded. Please delete some saves to free up space.', 'error'); } else { showStatusMessage('Failed to save. Storage might be full or disabled.', 'error'); } console.error("Save error:", e); return false; } };

    const renderNoteListItem = (save, parentEl) => {
        const li = document.createElement('li');
        if (save.color && save.color !== '#ffffff') {
            li.classList.add('has-custom-color');
            li.style.backgroundColor = save.color;
        }
        const saveDate = save.timestamp ? new Date(save.timestamp).toLocaleString() : 'N/A';
        const charCount = save.content ? save.content.length : 0;
        
        li.innerHTML = `
            <div class="save-info">
                <div class="marquee-container">
                    <div class="marquee-content-wrapper"><span class="save-name"></span></div>
                </div>
                <div class="save-details">
                    ${save.description ? `<em>${save.description}</em><br>` : ''}
                    Chars: ${charCount.toLocaleString()} | Saved: ${saveDate}
                    ${save.imported ? ' | Imported' : ''}
                </div>
            </div>
            <div class="save-actions">
                <button class="open-save-btn" data-id="${save.id}" title="Open">📂</button>
                <button class="export-save-btn" data-id="${save.id}" title="Export">📤</button>
                <button class="edit-save-btn" data-id="${save.id}" title="Edit">✏️</button>
                <button class="delete-save-btn" data-id="${save.id}" title="Delete">🗑️</button>
            </div>`;
        li.querySelector('.save-name').textContent = save.name;
        parentEl.appendChild(li);
        return li;
    };
    
    const refreshSavesDisplay = () => {
        let saves = getSaves();
        saves = sortSaves(saves);
        savesListEl.innerHTML = '';
        if (saves.length === 0) {
            savesListEl.innerHTML = '<div class="no-items-message">No notes saved yet.</div>';
        } else {
            saves.forEach(save => renderNoteListItem(save, savesListEl));
            savesListEl.querySelectorAll('.open-save-btn').forEach(btn => btn.onclick = () => openSave(btn.dataset.id));
            savesListEl.querySelectorAll('.export-save-btn').forEach(btn => btn.onclick = () => openExportModal(btn.dataset.id));
            savesListEl.querySelectorAll('.edit-save-btn').forEach(btn => btn.onclick = () => openSaveModal(btn.dataset.id));
            savesListEl.querySelectorAll('.delete-save-btn').forEach(btn => btn.onclick = () => deleteSave(btn.dataset.id));
        }
        updateStorageStats();
        initializeMarquees();
    };
    
    const openSave = async (id) => { const saves = getSaves(); const saveToOpen = saves.find(s => s.id === id); if (saveToOpen) { notesTextArea.value = saveToOpen.content; updateCharacterCount(); showStatusMessage(`Opened "${saveToOpen.name}".`, 'success'); } else { showStatusMessage('Save not found.', 'error'); } };
    const deleteSave = async (id) => { let saves = getSaves(); const saveToDelete = saves.find(s => s.id === id); if (!saveToDelete) return; const confirmed = await showActionModal({ title: "Confirm Deletion", message: `Are you sure you want to delete the save "${saveToDelete.name}"? This cannot be undone.`, buttons: [{ text: "Delete", class: "delete-btn", value: true }, { text: "Cancel", class: "cancel-btn", value: false }] }); if (!confirmed) return; const updatedSaves = saves.filter(s => s.id !== id); if (saveSaves(updatedSaves)) { showStatusMessage(`Save "${saveToDelete.name}" deleted.`, 'success'); refreshSavesDisplay(); } };
    
    // --- Save/Edit Modal Logic ---
    const updateSavePreview = () => {
        notePreviewEl.innerHTML = '';
        const tempSave = {
            id: 'preview', name: saveNameInput.value || 'Note Name',
            description: saveDescriptionInput.value || 'Note description...',
            content: '', timestamp: new Date().toISOString(), color: selectedColor,
        };
        renderNoteListItem(tempSave, notePreviewEl);
        initializeMarquees();
    };

    const openSaveModal = (id = null) => {
        const isEditing = id !== null;
        let note = {};
        if (isEditing) {
            const saves = getSaves();
            note = saves.find(s => s.id === id);
            if (!note) { return showStatusMessage("Note not found", "error"); }
            saveModalTitle.textContent = "Edit Note";
            confirmSaveBtn.textContent = "Save Changes";
        } else {
            if (!notesTextArea.value.trim()) { return showStatusMessage("Cannot save an empty note.", 'warning'); }
            saveModalTitle.textContent = "Save New Note";
            confirmSaveBtn.textContent = "Save Note";
        }
        
        saveNoteIdInput.value = id || '';
        saveNameInput.value = note.name || '';
        saveDescriptionInput.value = note.description || '';
        selectedColor = note.color || null;

        handleCharCounter(saveNameInput, nameCharCounter);
        handleCharCounter(saveDescriptionInput, descCharCounter);

        colorPaletteEl.innerHTML = '';
        paletteColors.forEach(color => {
            const swatch = document.createElement('div');
            swatch.className = 'color-swatch';
            swatch.style.backgroundColor = color;
            if (color === '#ffffff') swatch.style.border = '1px solid #ddd';
            if ((!selectedColor && color === '#ffffff') || selectedColor === color) {
                swatch.classList.add('selected');
            }
            swatch.onclick = () => {
                document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
                swatch.classList.add('selected');
                selectedColor = color === '#ffffff' ? null : color;
                updateSavePreview();
            };
            colorPaletteEl.appendChild(swatch);
        });

        updateSavePreview();
        saveModal.classList.add('visible');
    };

    const handleConfirmSave = () => {
        const id = saveNoteIdInput.value;
        const name = saveNameInput.value.trim();
        if (!name) return showStatusMessage("Note name is required.", "error");

        const newSaveData = {
            name: name,
            description: saveDescriptionInput.value.trim(),
            color: selectedColor,
            content: id ? getSaves().find(s => s.id === id).content : notesTextArea.value,
            timestamp: new Date().toISOString()
        };

        let saves = getSaves();
        if (id) { // Editing existing
            const index = saves.findIndex(s => s.id === id);
            if (index > -1) {
                saves[index] = { ...saves[index], ...newSaveData };
            }
        } else { // Creating new
            newSaveData.id = Date.now().toString();
            saves.push(newSaveData);
        }
        
        if (saveSaves(saves)) {
            showStatusMessage(`Note "${name}" saved successfully!`, 'success');
            refreshSavesDisplay();
            saveModal.classList.remove('visible');
            if(!id) { notesTextArea.value = ''; updateCharacterCount(); }
        }
    };

    // --- Import/Export Logic ---
    function openExportModal(id) { const saves = getSaves(); const saveToExport = saves.find(s => s.id === id); if (!saveToExport) { showStatusMessage("Save not found.", "error"); return; } exportNoteIdInput.value = id; exportModalTitle.textContent = `Export "${saveToExport.name}"`; exportFileNameInput.value = saveToExport.name.replace(/[^a-z0-9]/gi, '_').toLowerCase(); document.getElementById('exportPasswordInput').value = ''; exportModal.classList.add('visible'); }
    function handleExport(is4SPFormat) { const id = exportNoteIdInput.value; const saves = getSaves(); const saveToExport = saves.find(s => s.id === id); if (!saveToExport) return showStatusMessage("Save not found.", "error"); let fileName = exportFileNameInput.value.trim(); if (!fileName) { showStatusMessage("Filename cannot be empty.", "warning"); return; } let blob; let finalFileName; if (is4SPFormat) { const password = document.getElementById('exportPasswordInput').value; if (password && (password.length < 4 || password.length > 48)) { return showStatusMessage("Password must be between 4 and 48 characters.", "error"); } const noteData = { name: saveToExport.name, description: saveToExport.description, content: saveToExport.content, timestamp: saveToExport.timestamp, color: saveToExport.color }; let jsonString = JSON.stringify(noteData); let isEncrypted = false; if (password) { jsonString = xorCipher(jsonString, password); isEncrypted = true; } const base64Data = utf8ToBase64(jsonString); const exportObject = { dataType: "4sp_note_v1", encrypted: isEncrypted, data: base64Data }; blob = new Blob([JSON.stringify(exportObject, null, 2)], { type: 'application/json' }); finalFileName = fileName.endsWith('.json') ? fileName : `${fileName}.json`; } else { blob = new Blob([saveToExport.content], { type: 'text/plain;charset=utf-8' }); finalFileName = fileName.includes('.') ? fileName : `${fileName}.txt`; } const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = finalFileName; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); showStatusMessage(`Note exported as "${finalFileName}".`, 'success'); exportModal.classList.remove('visible'); }
    function processDecryptedData(base64Data) { try { const jsonString = base64ToUtf8(base64Data); const noteData = JSON.parse(jsonString); if (!noteData.name || typeof noteData.content === 'undefined') throw new Error("Imported data is missing required fields."); let saves = getSaves(); const newSave = { id: Date.now().toString(), name: noteData.name, description: noteData.description || "", content: noteData.content, timestamp: noteData.timestamp || new Date().toISOString(), color: noteData.color || null, imported: true }; saves.push(newSave); if (saveSaves(saves)) { showStatusMessage(`Note "${newSave.name}" imported successfully!`, 'success'); refreshSavesDisplay(); } } catch (error) { showStatusMessage(`Import failed: ${error.message}`, 'error'); } }
    function handlePasswordImport() { if (!pendingEncryptedFile) return; const password = importPasswordInput.value; if (!password) { showStatusMessage("Password is required.", "warning"); return; } try { const decryptedBase64 = xorCipher(base64ToUtf8(pendingEncryptedFile.data), password); processDecryptedData(utf8ToBase64(decryptedBase64)); importPasswordModal.classList.remove('visible'); pendingEncryptedFile = null; importPasswordInput.value = ''; } catch (e) { showStatusMessage("Incorrect password or corrupted file.", "error"); } }

    // --- Auth & Initial Load ---
    firebase.auth().onAuthStateChanged(async user => { if (!user) { location.href = '../login.html'; return; } currentUser = user; sidebarUserEmailEl.querySelector('span').textContent = user.email; try { const userProfileSnap = await firebase.firestore().collection('users').doc(user.uid).get(); const username = userProfileSnap.exists ? userProfileSnap.data().username : (user.displayName || user.email.split('@')[0]); sidebarUserNameEl.querySelector('span').textContent = username; } catch (error) { sidebarUserNameEl.querySelector('span').textContent = user.displayName || user.email.split('@')[0]; } refreshSavesDisplay(); });

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        notesTextArea.addEventListener('input', updateCharacterCount);
        importFileEl.addEventListener('change', handleFileImport);
        copyAllBtn.addEventListener('click', handleCopyAll);
        saveNoteBtn.addEventListener('click', () => openSaveModal());
        
        // Save Modal Listeners
        [saveNameInput, saveDescriptionInput].forEach(el => el.addEventListener('input', updateSavePreview));
        saveNameInput.addEventListener('input', () => handleCharCounter(saveNameInput, nameCharCounter));
        saveDescriptionInput.addEventListener('input', () => handleCharCounter(saveDescriptionInput, descCharCounter));
        confirmSaveBtn.addEventListener('click', handleConfirmSave);
        closeSaveModalBtn.addEventListener('click', () => saveModal.classList.remove('visible'));

        // Export Modal Listeners
        exportAsFileBtn.addEventListener('click', () => handleExport(false));
        exportAs4SPBtn.addEventListener('click', () => handleExport(true));
        closeExportModalBtn.addEventListener('click', () => exportModal.classList.remove('visible'));

        // Import Password Modal Listeners
        submitImportPasswordBtn.addEventListener('click', handlePasswordImport);
        closeImportPasswordModalBtn.addEventListener('click', () => importPasswordModal.classList.remove('visible'));

        // Global Listeners
        [saveModal, exportModal, importPasswordModal, actionModal].forEach(modal => {
            modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('visible'); });
        });
        window.addEventListener('resize', initializeMarquees);

        setupSidebar();
        updateCharacterCount();
        updateStorageStats();
    });
  </script>
</body>
</html>
