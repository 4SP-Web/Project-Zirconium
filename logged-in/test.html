<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - VERN SOCIAL</title>
  <!-- Link to your external CSS file is preserved -->
  <link rel="stylesheet" href="../css/style.css" />
  <!-- Using a more modern CDN for Font Awesome for better icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Link to your external panic key script is preserved -->
  <script src="../panic-key.js"></script>
  <!-- TailwindCSS for modern utility-first styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* A modern, dark theme using TailwindCSS color palette for better consistency and feel */
    body, html {
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: 'Inter', sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    body {
        background-color: #111827; /* gray-900 */
        color: #d1d5db; /* gray-300 */
        display: flex;
        flex-direction: column;
    }
    .main-header {
        background-color: #1f2937; /* gray-800 */
        border-bottom: 1px solid #374151; /* gray-700 */
        flex-shrink: 0;
    }
    .main-header .container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        max-width: 1280px;
        margin: auto;
    }
    .main-header .btn {
        background-color: #4f46e5; /* indigo-600 */
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 600;
        transition: background-color 0.2s;
        text-decoration: none;
    }
    .main-header .btn:hover {
        background-color: #4338ca; /* indigo-700 */
    }
    .dashboard-container {
      display: flex;
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    .social-container {
        flex: 1;
        display: flex;
        overflow: hidden;
        width: 100%;
    }
    .chat-sidebar {
        width: 320px;
        flex-shrink: 0;
        background-color: #1f2937; /* gray-800 */
        border-right: 1px solid #374151; /* gray-700 */
        display: flex;
        flex-direction: column;
        transition: transform 0.4s ease-in-out;
    }
    .chat-sidebar-header {
        padding: 1rem;
        border-bottom: 1px solid #374151; /* gray-700 */
    }
    #userSearchInput {
        width: 100%;
        padding: 0.5rem 1rem 0.5rem 2.5rem;
        border-radius: 9999px;
        border: 1px solid #4b5563; /* gray-600 */
        background-color: #374151; /* gray-700 */
        color: #d1d5db; /* gray-300 */
        box-sizing: border-box;
    }
    #userSearchInput::placeholder { color: #9ca3af; } /* gray-400 */
    .search-bar-wrapper { position: relative; }
    .search-bar-wrapper .fa-search {
        position: absolute; left: 1rem; top: 50%;
        transform: translateY(-50%); color: #9ca3af; /* gray-400 */
    }
    .chat-list-section {
        flex-grow: 1;
        overflow-y: auto;
    }
    .chat-list-section h3 {
        font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
        color: #9ca3af; /* gray-400 */
        padding: 1.25rem 1rem 0.5rem; margin: 0;
    }
    .chat-list { list-style: none; padding: 0; margin: 0; }
    .chat-list-item {
        display: flex; align-items: center; padding: 0.75rem 1rem;
        cursor: pointer; transition: background-color 0.2s;
        border-bottom: 1px solid #374151; /* gray-700 */
    }
    .chat-list-item:hover { background-color: #374151; } /* gray-700 */
    .chat-list-item.active { background-color: #4f46e5; } /* indigo-600 */
    .chat-list-item .username { font-weight: 500; color: #f9fafb; } /* gray-50 */
    .chat-list-item .actions { margin-left: auto; display: flex; gap: 0.5rem; }
    .action-btn { background: none; border: none; cursor: pointer; font-size: 1.1em; color: #9ca3af; }
    .action-btn.accept { color: #22c55e; } /* green-500 */
    .action-btn.decline { color: #ef4444; } /* red-500 */
    .create-group-btn {
        display: block; width: calc(100% - 2rem); margin: 1rem; padding: 0.75rem;
        background-color: #4f46e5; color: white; border: none; border-radius: 0.375rem; cursor: pointer;
        text-align: center; font-weight: 600;
    }
    .create-group-btn:disabled { background-color: #4b5563; cursor: not-allowed; }
    .chat-area {
        flex-grow: 1; display: flex; flex-direction: column;
        background-color: #111827; /* gray-900 */
        transition: transform 0.4s ease-in-out;
    }
    .chat-header {
        padding: 1rem 1.25rem; background-color: #1f2937; /* gray-800 */
        border-bottom: 1px solid #374151; /* gray-700 */ flex-shrink: 0; display: flex;
        justify-content: space-between; align-items: center;
    }
    .back-to-chats-btn {
        display: none; background: none; border: none; font-size: 1.5rem;
        margin-right: 1rem; cursor: pointer; color: #9ca3af;
    }
    #chatName { font-size: 1.25em; font-weight: bold; color: white; }
    #unfriendBtn, #leaveGroupBtn, #inviteToGroupBtn { border: none; border-radius: 0.375rem; padding: 0.5rem 0.75rem; cursor: pointer; font-weight: bold; }
    #unfriendBtn { background-color: #ef4444; color: white; }
    #leaveGroupBtn { background-color: #eab308; color: #1f2937; } /* yellow-500 */
    #inviteToGroupBtn { background-color: #22c55e; color: white; }
    .messages-container {
        flex-grow: 1; padding: 1.25rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem;
    }
    .message-placeholder { margin: auto; text-align: center; color: #6b7280; }
    .message-placeholder .icon { font-size: 3em; margin-bottom: 1rem; }
    .message { display: flex; flex-direction: column; max-width: 70%; align-self: flex-start; }
    .message.current-user { align-self: flex-end; }
    .message-content {
        padding: 0.75rem 1rem; border-radius: 1.25rem; background-color: #374151; /* gray-700 */
        color: #f9fafb; line-height: 1.5; word-wrap: break-word; text-align: left;
    }
    .message.current-user .message-content {
        background-color: #4f46e5; color: white; border-bottom-right-radius: 0.375rem;
    }
    .message .message-content { border-bottom-left-radius: 0.375rem; }
    .message-info { font-size: 0.75em; color: #9ca3af; margin-top: 0.25rem; padding: 0 0.5rem; }
    .chat-input-area {
        padding: 1rem; border-top: 1px solid #374151; flex-shrink: 0; display: flex; gap: 0.5rem;
        background-color: #1f2937;
    }
    #messageInput {
        flex-grow: 1; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #4b5563;
        background-color: #374151; color: #d1d5db;
    }
    #sendMessageBtn {
        padding: 0.75rem 1rem; background-color: #4f46e5; color: white; border: none;
        border-radius: 0.5rem; cursor: pointer;
    }
    /* Modal styles for a cleaner, consistent look */
    .modal {
        display: none; position: fixed; z-index: 1050; left: 0; top: 0;
        width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
        align-items: center; justify-content: center;
    }
    .modal-content {
        background-color: #1f2937; padding: 1.5rem; border: 1px solid #374151;
        width: 90%; max-width: 450px; border-radius: 0.75rem; position: relative;
        box-shadow: 0 5px 25px rgba(0,0,0,0.3);
    }
    .modal-content h2 { margin-top: 0; color: #f9fafb; }
    .modal-content h3 { margin-top: 1rem; font-size: 1.1em; color: #d1d5db; border-bottom: 1px solid #374151; padding-bottom: 0.25rem;}
    .friend-selection-list { max-height: 150px; overflow-y: auto; border: 1px solid #374151; padding: 0.5rem; border-radius: 0.5rem; margin-top: 0.5rem; }
    .friend-selection-list .friend-item { display: flex; align-items: center; margin: 0.5rem 0; }
    .friend-selection-list .friend-item label { margin-left: 0.5rem; }
    .modal-buttons { display: flex; gap: 0.5rem; margin-top: 1.5rem; }
    .modal-confirm-btn, .modal-cancel-btn, .modal-ok-btn {
        flex: 1; padding: 0.75rem; border: none; border-radius: 0.5rem; cursor: pointer;
        font-weight: 600;
    }
    .modal-confirm-btn { background-color: #4f46e5; color: white; }
    .modal-cancel-btn { background-color: #4b5563; color: #d1d5db; }
    .modal-ok-btn { background-color: #4f46e5; color: white; margin-top: 1rem; }
    .close-btn { color: #aaa; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; }

    /* Responsive Styles for Mobile */
    @media screen and (max-width: 768px) {
        .social-container {
            width: 200%; 
        }
        .chat-sidebar, .chat-area {
            width: 50%; 
        }
        .social-container.mobile-chat-view-active {
            transform: translateX(-50%);
        }
        .back-to-chats-btn {
            display: block; 
        }
    }
  </style>
</head>

<body class="dashboard-page">

  <header class="main-header">
    <div class="container">
      <div class="logo">
        <!-- Assuming you have a logo image at this path -->
        <a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="height: 40px;"></a>
      </div>
      <div class="auth-buttons" style="display: flex; gap: 1rem;">
        <a href="dashboard.html" class="btn">DASHBOARD</a>
        <button id="logoutBtn" class="btn">LOG OUT</button>
      </div>
    </div>
  </header>

  <div class="dashboard-container">
    <main class="social-container" id="socialContainer">
      <aside class="chat-sidebar">
        <div class="chat-sidebar-header">
            <div class="search-bar-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="userSearchInput" placeholder="Find users...">
            </div>
        </div>
        <div class="chat-list-section">
            <div id="searchResultsSection"></div>
            <div id="friendRequestsSection"></div>
            <div id="friendsSection"><h3>Friends</h3><ul id="friendsList" class="chat-list"></ul></div>
            <div id="groupsSection"><h3>Groups</h3><ul id="groupsList" class="chat-list"></ul></div>
        </div>
        <button id="createGroupBtn" class="create-group-btn">Create Group</button>
      </aside>

      <section class="chat-area" id="chatArea">
        <div id="chatWelcomeScreen" class="message-placeholder">
            <div class="icon"><i class="fas fa-comments"></i></div>
            <h2>Welcome to VERN SOCIAL</h2>
            <p>Select a friend or group to start chatting.</p>
        </div>

        <div id="chatActiveScreen" style="display: none; flex-direction: column; flex-grow: 1; min-height: 0;">
            <div class="chat-header">
                <button class="back-to-chats-btn" id="backToChatsBtn"><i class="fas fa-arrow-left"></i></button>
                <h2 id="chatName"></h2>
                <div class="chat-header-actions" style="display: flex; gap: 0.5rem;">
                    <button id="inviteToGroupBtn" style="display:none;">Invite</button>
                    <button id="leaveGroupBtn" style="display:none;">Leave</button>
                    <button id="unfriendBtn" style="display:none;">Unfriend</button>
                </div>
            </div>
            <div class="messages-container" id="messagesContainer"></div>
            <div class="chat-input-area">
                <input type="text" id="messageInput" placeholder="Type a message... (500 max chars)" maxlength="500">
                <button id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
      </section>
    </main>
  </div>
  
  <!-- MODALS -->
  <div id="createGroupModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeGroupModal">&times;</span>
      <h2>Create New Group</h2>
      <input type="text" id="groupNameInput" placeholder="Enter group name" class="w-full p-2 mt-4 bg-gray-700 border border-gray-600 rounded">
      <h3>Add Friends:</h3>
      <div id="friendsToAddToGroup" class="friend-selection-list"></div>
      <button id="confirmGroupCreationBtn" class="modal-confirm-btn mt-4">Create Group</button>
    </div>
  </div>

  <div id="inviteToGroupModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeInviteModal">&times;</span>
      <h2 id="inviteModalTitle">Invite to Group</h2>
      <h3>Select friends to invite:</h3>
      <div id="friendsToInviteList" class="friend-selection-list"></div>
      <button id="confirmInviteBtn" class="modal-confirm-btn mt-4">Send Invites</button>
    </div>
  </div>

  <div id="confirmationModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeConfirmationModal">&times;</span>
      <h2 id="confirmationModalTitle"></h2>
      <p id="confirmationModalMessage" class="mt-2"></p>
      <div class="modal-buttons">
          <button id="confirmActionBtn" class="modal-confirm-btn">Confirm</button>
          <button id="cancelActionBtn" class="modal-cancel-btn">Cancel</button>
      </div>
    </div>
  </div>
  
  <div id="alertModal" class="modal">
    <div class="modal-content text-center">
      <h2 id="alertModalTitle"></h2>
      <p id="alertModalMessage" class="mt-2"></p>
      <button id="alertModalOkBtn" class="modal-ok-btn">OK</button>
    </div>
  </div>


  <!-- Firebase SDKs - It's recommended to use the latest version -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  
  <!-- Link to your firebase config file is preserved -->
  <script src="../firebase-config.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- App State & Constants ---
        let currentUser = null;
        let currentUserData = {};
        let activeChatId = null;
        let activeChatType = null;
        let activeChatData = {};
        let usersDataCache = {}; 
        let userUnsubscribe = null;
        let activeChatUnsubscribe = null;
        let messageInputDebounceTimeout;

        const GROUP_CREATION_LIMIT = 2;
        const GROUP_CREATION_WINDOW_MINS = 10;
        const MAX_GROUP_MEMBERSHIPS = 12;
        const MAX_GROUP_SIZE = 10;
        const DEBOUNCE_DELAY_MS = 400; // Time to wait after user stops typing

        // --- DOM Elements ---
        const socialContainer = document.getElementById('socialContainer');
        const userSearchInput = document.getElementById('userSearchInput');
        const searchResultsSection = document.getElementById('searchResultsSection');
        const friendRequestsSection = document.getElementById('friendRequestsSection');
        const friendsList = document.getElementById('friendsList');
        const groupsList = document.getElementById('groupsList');
        const createGroupBtn = document.getElementById('createGroupBtn');
        const chatArea = document.getElementById('chatArea');
        const chatWelcomeScreen = document.getElementById('chatWelcomeScreen');
        const chatActiveScreen = document.getElementById('chatActiveScreen');
        const backToChatsBtn = document.getElementById('backToChatsBtn');
        const chatName = document.getElementById('chatName');
        const inviteToGroupBtn = document.getElementById('inviteToGroupBtn');
        const leaveGroupBtn = document.getElementById('leaveGroupBtn');
        const unfriendBtn = document.getElementById('unfriendBtn');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Modals
        const alertModal = document.getElementById('alertModal');
        const alertModalTitle = document.getElementById('alertModalTitle');
        const alertModalMessage = document.getElementById('alertModalMessage');
        const alertModalOkBtn = document.getElementById('alertModalOkBtn');
        const confirmationModal = document.getElementById('confirmationModal');
        const closeConfirmationModalBtn = document.getElementById('closeConfirmationModal');
        const confirmationModalTitle = document.getElementById('confirmationModalTitle');
        const confirmationModalMessage = document.getElementById('confirmationModalMessage');
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        const cancelActionBtn = document.getElementById('cancelActionBtn');
        const createGroupModal = document.getElementById('createGroupModal');
        const closeGroupModal = document.getElementById('closeGroupModal');
        const groupNameInput = document.getElementById('groupNameInput');
        const friendsToAddToGroup = document.getElementById('friendsToAddToGroup');
        const confirmGroupCreationBtn = document.getElementById('confirmGroupCreationBtn');
        const inviteToGroupModal = document.getElementById('inviteToGroupModal');
        const closeInviteModal = document.getElementById('closeInviteModal');
        const inviteModalTitle = document.getElementById('inviteModalTitle');
        const friendsToInviteList = document.getElementById('friendsToInviteList');
        const confirmInviteBtn = document.getElementById('confirmInviteBtn');


        // --- Utility Functions ---
        function showAlert(title, message) {
            alertModalTitle.textContent = title;
            alertModalMessage.textContent = message;
            alertModal.style.display = 'flex';
        }

        function showConfirmation(title, message) {
            return new Promise(resolve => {
                confirmationModalTitle.textContent = title;
                confirmationModalMessage.textContent = message;
                confirmationModal.style.display = 'flex';

                const onConfirm = () => {
                    confirmationModal.style.display = 'none';
                    confirmActionBtn.removeEventListener('click', onConfirm);
                    cancelActionBtn.removeEventListener('click', onCancel);
                    resolve(true);
                };

                const onCancel = () => {
                    confirmationModal.style.display = 'none';
                    confirmActionBtn.removeEventListener('click', onConfirm);
                    cancelActionBtn.removeEventListener('click', onCancel);
                    resolve(false);
                };

                confirmActionBtn.addEventListener('click', onConfirm);
                cancelActionBtn.addEventListener('click', onCancel);
            });
        }
        
        // --- EFFICIENT MESSAGING: Debounced Send Function ---
        function debouncedSendMessage(text) {
            if (!activeChatId || !currentUser) return;
            const collectionName = activeChatType === 'group' ? 'groupChats' : 'chats';
            const chatRef = db.collection(collectionName).doc(activeChatId);
            
            const messagePayload = {
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            chatRef.update({
                [`messages.${currentUser.uid}`]: messagePayload
            }).catch(error => {
                console.error("Message send error:", error);
                showAlert("Error", "Failed to send message. Please try again.");
            });
        }

        // --- Main App Logic ---
        function setupListeners() {
            if (userUnsubscribe) userUnsubscribe();
            userUnsubscribe = db.collection('users').doc(currentUser.uid).onSnapshot(async (doc) => {
                if (!doc.exists) return;
                currentUserData = { id: doc.id, ...doc.data() };
                
                const userIdsToCache = new Set([
                    ...(currentUserData.friends || []),
                    ...(currentUserData.friendRequestsReceived || []),
                    ...(currentUserData.friendRequestsSent || [])
                ]);

                await cacheUsersData(Array.from(userIdsToCache));
                renderFriendRequests();
                await renderFriendsAndGroups();
            });
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                setupListeners();
            } else {
                window.location.href = '../login.html';
            }
        });

        async function cacheUsersData(userIds) {
            const uniqueUserIds = [...new Set(userIds)].filter(id => id && !usersDataCache[id]);
            if (uniqueUserIds.length === 0) return;
            
            const promises = [];
            for (let i = 0; i < uniqueUserIds.length; i += 10) {
                const chunk = uniqueUserIds.slice(i, i + 10);
                promises.push(db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', chunk).get());
            }

            const snapshots = await Promise.all(promises);
            snapshots.forEach(snapshot => {
                snapshot.docs.forEach(doc => {
                    usersDataCache[doc.id] = { id: doc.id, ...doc.data() };
                });
            });
        }

        function openChat(chatId, type) {
            if (activeChatUnsubscribe) activeChatUnsubscribe();

            activeChatId = chatId;
            activeChatType = type;
            chatWelcomeScreen.style.display = 'none';
            chatActiveScreen.style.display = 'flex';
            socialContainer.classList.add('mobile-chat-view-active');

            const collectionName = type === 'group' ? 'groupChats' : 'chats';
            activeChatUnsubscribe = db.collection(collectionName).doc(chatId).onSnapshot(async (doc) => {
                if (!doc.exists) {
                    showAlert("Chat Closed", "This chat no longer exists.");
                    closeActiveChat();
                    return;
                }
                activeChatData = { id: doc.id, ...doc.data() };
                renderChatHeader();
                await renderMessages();
                highlightActiveChat();
            });
        }

        function closeActiveChat() {
            if (activeChatUnsubscribe) activeChatUnsubscribe();
            activeChatId = null;
            activeChatType = null;
            activeChatData = {};
            activeChatUnsubscribe = null;
            chatActiveScreen.style.display = 'none';
            chatWelcomeScreen.style.display = 'flex';
            socialContainer.classList.remove('mobile-chat-view-active');
            highlightActiveChat();
        }

        function renderChatHeader() {
            unfriendBtn.style.display = 'none';
            leaveGroupBtn.style.display = 'none';
            inviteToGroupBtn.style.display = 'none';

            if (activeChatType === 'group') {
                chatName.textContent = activeChatData.groupName;
                leaveGroupBtn.style.display = 'inline-block';
                inviteToGroupBtn.style.display = 'inline-block';
                leaveGroupBtn.textContent = activeChatData.creatorId === currentUser.uid ? 'Delete Group' : 'Leave Group';
            } else {
                const friendId = activeChatData.members.find(id => id !== currentUser.uid);
                const friendData = usersDataCache[friendId];
                chatName.textContent = friendData ? friendData.username : 'Loading...';
                unfriendBtn.style.display = 'inline-block';
            }
        }

        async function renderMessages() {
            messagesContainer.innerHTML = '';
            if (!activeChatData.messages || Object.keys(activeChatData.messages).length === 0) {
                messagesContainer.innerHTML = `<p class="m-auto text-gray-500">No messages yet. Send the first one!</p>`;
                return;
            }

            const messages = Object.entries(activeChatData.messages).map(([uid, data]) => ({ uid, ...data }));
            await cacheUsersData(messages.map(m => m.uid));
            
            messages.sort((a,b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));

            messages.forEach(msg => {
                const user = usersDataCache[msg.uid];
                if (!user) return;

                const messageEl = document.createElement('div');
                messageEl.className = `message ${msg.uid === currentUser.uid ? 'current-user' : ''}`;
                const sentTime = msg.timestamp ? new Date(msg.timestamp.toMillis()).toLocaleTimeString() : '...';
                
                messageEl.innerHTML = `
                    <div class="message-content">${msg.text}</div>
                    <div class="message-info">${user.username} - ${sentTime}</div>
                `;
                messagesContainer.appendChild(messageEl);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function renderFriendRequests() {
            friendRequestsSection.innerHTML = '';
            if (!currentUserData.friendRequestsReceived || currentUserData.friendRequestsReceived.length === 0) return;

            friendRequestsSection.innerHTML = `<h3>Friend Requests</h3><ul class="chat-list"></ul>`;
            const listEl = friendRequestsSection.querySelector('ul');
            currentUserData.friendRequestsReceived.forEach(id => {
                const requester = usersDataCache[id];
                if (!requester) return;
                listEl.innerHTML += `
                    <li class="chat-list-item">
                        <span class="username">${requester.username}</span>
                        <div class="actions">
                            <button class="action-btn accept" data-id="${id}"><i class="fas fa-check"></i></button>
                            <button class="action-btn decline" data-id="${id}"><i class="fas fa-times"></i></button>
                        </div>
                    </li>`;
            });
        }
        
        async function renderFriendsAndGroups() {
            friendsList.innerHTML = '';
            (currentUserData.friends || []).forEach(id => {
                const friend = usersDataCache[id];
                if (!friend) return;
                const chatId = [currentUser.uid, id].sort().join('_');
                friendsList.innerHTML += `<li class="chat-list-item" data-chat-id="${chatId}" data-chat-type="private"><span class="username">${friend.username}</span></li>`;
            });

            groupsList.innerHTML = '';
            if (currentUserData.groups && currentUserData.groups.length > 0) {
                const groupSnapshots = await db.collection('groupChats').where(firebase.firestore.FieldPath.documentId(), 'in', currentUserData.groups).get();
                groupSnapshots.forEach(doc => {
                    const group = { id: doc.id, ...doc.data() };
                    groupsList.innerHTML += `<li class="chat-list-item" data-chat-id="${group.id}" data-chat-type="group"><span class="username">${group.groupName}</span></li>`;
                });
            }
            highlightActiveChat();
        }

        function highlightActiveChat() {
            document.querySelectorAll('.chat-list-item.active').forEach(el => el.classList.remove('active'));
            if (activeChatId) {
                const item = document.querySelector(`.chat-list-item[data-chat-id="${activeChatId}"]`);
                if (item) item.classList.add('active');
            }
        }
        
        async function handleConfirmGroupCreation() {
            const groupName = groupNameInput.value.trim();
            if (groupName === '') return showAlert('Invalid Name', 'Please enter a valid group name.');
            const selectedFriends = Array.from(friendsToAddToGroup.querySelectorAll('input:checked')).map(i => i.value);
            const memberIds = [currentUser.uid, ...selectedFriends];

            if (memberIds.length > MAX_GROUP_SIZE) {
                return showAlert("Group Too Large", `A group can have a maximum of ${MAX_GROUP_SIZE} members.`);
            }

            try {
                const groupRef = await db.collection('groupChats').add({
                    groupName,
                    creatorId: currentUser.uid,
                    members: memberIds,
                    messages: {}
                });
                
                const batch = db.batch();
                memberIds.forEach(id => {
                    batch.update(db.collection('users').doc(id), {
                        groups: firebase.firestore.FieldValue.arrayUnion(groupRef.id)
                    });
                });
                batch.update(db.collection('users').doc(currentUser.uid), {
                    groupsCreatedTimestamps: firebase.firestore.FieldValue.arrayUnion(Date.now())
                });
                await batch.commit();

                createGroupModal.style.display = 'none';
            } catch (error) {
                console.error("Error creating group:", error);
                showAlert("Error", "Failed to create group.");
            }
        }

        async function handleConfirmInvite() {
            const selectedToInvite = Array.from(friendsToInviteList.querySelectorAll('input:checked')).map(i => i.value);
            if (selectedToInvite.length === 0) return;
            const newTotalMembers = activeChatData.members.length + selectedToInvite.length;

            if (newTotalMembers > MAX_GROUP_SIZE) {
                return showAlert("Group Full", `This would exceed the ${MAX_GROUP_SIZE} member limit.`);
            }

            const groupRef = db.collection('groupChats').doc(activeChatId);
            const userUpdatePromises = selectedToInvite.map(id => {
                return db.collection('users').doc(id).update({
                    groups: firebase.firestore.FieldValue.arrayUnion(activeChatId)
                });
            });

            try {
                await Promise.all([
                    groupRef.update({ members: firebase.firestore.FieldValue.arrayUnion(...selectedToInvite) }),
                    ...userUpdatePromises
                ]);
                inviteToGroupModal.style.display = 'none';
            } catch (error) {
                console.error("Error inviting to group:", error);
                showAlert("Error", "Failed to send invites.");
            }
        }
        
        // --- Event Listeners ---
        messageInput.addEventListener('input', () => {
            clearTimeout(messageInputDebounceTimeout);
            const text = messageInput.value;
            if (text === '') return;
            messageInputDebounceTimeout = setTimeout(() => debouncedSendMessage(text), DEBOUNCE_DELAY_MS);
        });

        sendMessageBtn.addEventListener('click', () => {
            clearTimeout(messageInputDebounceTimeout);
            debouncedSendMessage(messageInput.value);
            messageInput.value = '';
        });

        logoutBtn.addEventListener('click', () => auth.signOut());
        alertModalOkBtn.addEventListener('click', () => alertModal.style.display = 'none');
        closeConfirmationModalBtn.addEventListener('click', () => confirmationModal.style.display = 'none');
        cancelActionBtn.addEventListener('click', () => confirmationModal.style.display = 'none');
        closeGroupModal.addEventListener('click', () => createGroupModal.style.display = 'none');
        closeInviteModal.addEventListener('click', () => inviteToGroupModal.style.display = 'none');
        backToChatsBtn.addEventListener('click', () => socialContainer.classList.remove('mobile-chat-view-active'));

        let searchTimeout;
        userSearchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const query = userSearchInput.value.trim().toLowerCase();
                if (query.length < 3) {
                    searchResultsSection.innerHTML = '';
                    return;
                }
                const snapshot = await db.collection('users').where('username_lowercase', '>=', query).where('username_lowercase', '<=', query + '\uf8ff').limit(5).get();
                searchResultsSection.innerHTML = `<h3>Search Results</h3><ul class="chat-list"></ul>`;
                const listEl = searchResultsSection.querySelector('ul');
                listEl.innerHTML = '';
                snapshot.forEach(doc => {
                     // logic to render search results
                });
            }, 300);
        });

        createGroupBtn.addEventListener('click', () => {
            if ((currentUserData.groups?.length || 0) >= MAX_GROUP_MEMBERSHIPS) {
                return showAlert("Limit Reached", `You can only be a member of ${MAX_GROUP_MEMBERSHIPS} groups.`);
            }
            const now = Date.now();
            const windowStart = now - (GROUP_CREATION_WINDOW_MINS * 60 * 1000);
            const recentCreations = (currentUserData.groupsCreatedTimestamps || []).filter(ts => ts > windowStart);
            if (recentCreations.length >= GROUP_CREATION_LIMIT) {
                return showAlert("Rate Limit Exceeded", `You can only create ${GROUP_CREATION_LIMIT} groups every ${GROUP_CREATION_WINDOW_MINS} minutes.`);
            }
            friendsToAddToGroup.innerHTML = '';
            (currentUserData.friends || []).forEach(id => {
                const friend = usersDataCache[id];
                if (friend) friendsToAddToGroup.innerHTML += `<div class="friend-item"><input type="checkbox" id="friend-${id}" value="${id}"><label for="friend-${id}">${friend.username}</label></div>`;
            });
            createGroupModal.style.display = 'flex';
        });

        confirmGroupCreationBtn.addEventListener('click', handleConfirmGroupCreation);
        confirmInviteBtn.addEventListener('click', handleConfirmInvite);
        
        document.addEventListener('click', (e) => {
            if (e.target.closest('.chat-list-item[data-chat-id]')) {
                const item = e.target.closest('.chat-list-item[data-chat-id]');
                openChat(item.dataset.chatId, item.dataset.chatType);
            }
        });

    });
  </script>
</body>
</html>
