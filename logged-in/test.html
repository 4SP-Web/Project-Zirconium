<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - Messenger</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="../ban-enforcer.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js"></script>

    <style>
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
        }
        .hidden { display: none !important; }
        body { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: var(--v4-font-primary); background: var(--v4-bg-gradient); color: var(--v4-text-primary); line-height: 1.6; }
        .messenger-container-wrapper { display: flex; flex: 1; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 280px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
        .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; opacity: 1; visibility: visible; transition: opacity 0.2s ease-in-out; transition-delay: 0.4s; }
        .sidebar.collapsed nav a .label, .sidebar.collapsed .contacts-header, .sidebar.collapsed #contactsList { opacity: 0; visibility: hidden; transition-delay: 0s; }

        .main-messenger-content { flex: 1; padding: 30px; background: var(--v4-bg-gradient); overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .messenger-header { margin-bottom: 5px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .messenger-title { font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        .chat-window { display: flex; flex-direction: column; flex-grow: 1; background: var(--v4-card-bg); border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); overflow: hidden; }
        #messages { flex-grow: 1; padding: 20px; overflow-y: auto; background: var(--v4-input-bg); }
        .message { margin-bottom: 12px; }
        .message .sender { font-weight: bold; color: var(--v4-purple-accent); }
        .message.system { color: var(--v4-text-secondary); font-style: italic; }
        
        .input-area { display: flex; gap: 10px; padding: 20px; border-top: 1px solid var(--v4-border-softer); background: #fff; }
        #message-input { flex-grow: 1; padding: 14px; border: 1px solid var(--v4-input-border); border-radius: 10px; background: var(--v4-input-bg); font-family: var(--v4-font-secondary); font-size: 1em; }
        #message-input:focus { box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.3); border-color: var(--v4-purple-accent); outline: none; }

        .btn-primary { background: var(--v4-purple-gradient); color: white; border: none; padding: 14px 24px; border-radius: 10px; font-family: var(--v4-font-primary); text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(103, 32, 189, 0.4); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }

        .status-bar { display: flex; justify-content: space-between; align-items: center; background: var(--v4-card-bg); padding: 15px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .status-info, .connection-info { font-size: 0.9em; color: var(--v4-text-secondary); }
        #my-id { font-weight: bold; color: var(--v4-text-primary); cursor: pointer; }

        /* Contacts Sidebar */
        .contacts-header { padding: 0 15px; margin-top: 30px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; white-space: nowrap; opacity: 1; transition: opacity 0.2s ease-in-out; transition-delay: 0.4s; }
        .btn-add-contact { background: none; border: 1px solid #fff; color: #fff; border-radius: 50%; width: 28px; height: 28px; font-size: 1.2em; cursor: pointer; transition: all 0.3s ease; }
        .btn-add-contact:hover { background: var(--v4-purple-accent); border-color: var(--v4-purple-accent); }
        #contactsList { list-style: none; padding: 0 15px; margin: 0; white-space: nowrap; opacity: 1; transition: opacity 0.2s ease-in-out; transition-delay: 0.4s; }
        .contact-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 8px; margin-bottom: 8px; background-color: rgba(255,255,255,0.05); }
        .contact-name { font-weight: bold; cursor: default; }
        .contact-actions { display: flex; gap: 5px; }
        .contact-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 5px; border-radius: 5px; cursor: pointer; transition: background 0.2s; font-size: 0.9em; }
        .contact-btn:hover { background: rgba(255,255,255,0.4); }

        /* Modal */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; display: flex; align-items: center; justify-content: center; }
        .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--v4-card-bg); width: 90%; max-width: 500px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 90vh; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--v4-border-softer); position: relative; }
        .modal-header h2 { margin: 0; font-size: 1.5em; color: var(--v4-text-primary); }
        .modal-body { flex-grow: 1; overflow-y: auto; padding: 25px; }
        .modal-body .form-group { margin-bottom: 20px; }
        .modal-body label { font-weight: bold; color: var(--v4-text-secondary); margin-bottom: 8px; display: block; }
        .modal-body input[type="text"] { width: 100%; padding: 12px; border: 1px solid var(--v4-input-border); border-radius: 8px; background: var(--v4-input-bg); font-family: var(--v4-font-secondary); font-size: 1em; box-sizing: border-box; }
        .modal-footer { padding: 15px 25px; border-top: 1px solid var(--v4-border-softer); display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; cursor: pointer; padding: 5px; line-height: 0; }
        .close-btn img { width: 20px; height: 20px; filter: invert(80%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(100%) contrast(100%); transition: filter 0.3s ease; }
        .close-btn:hover img { filter: invert(10%) sepia(10%) saturate(0%) hue-rotate(240deg) brightness(100%) contrast(100%); }
    </style>
</head>
<body class="messenger-page">

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="messenger-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">‚ò∞</button>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="others.html" class="active"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
            <div class="contacts-section">
                <div class="contacts-header">
                    <h3>Contacts</h3>
                    <button id="addContactBtn" class="btn-add-contact" title="Add New Contact">+</button>
                </div>
                <ul id="contactsList"></ul>
            </div>
        </aside>

        <main class="main-messenger-content">
            <div class="messenger-header"> <h2 class="messenger-title">MESSENGER üí¨</h2> </div>
            
            <div class="status-bar">
                <div class="status-info">Your ID: <strong id="my-id" title="Click to see full ID">Generating...</strong></div>
                <div class="connection-info">Status: <strong id="connection-status">Initializing...</strong></div>
            </div>

            <div class="chat-window">
                <div id="messages"></div>
                <div class="input-area">
                    <input type="text" id="message-input" placeholder="Type a message... (Press Enter to send)">
                    <button id="send-button" class="btn-primary">Send</button>
                </div>
            </div>
        </main>
    </div>

    <div id="contactModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header"> 
                <h2 id="contactModalTitle">Add New Contact</h2> 
                <button id="closeContactModalBtn" class="close-btn"><img src="../images/cross-white.png" alt="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="contactIdInput">
                <div class="form-group"> <label for="contactNicknameInput">Nickname</label> <input type="text" id="contactNicknameInput" maxlength="20" placeholder="e.g., Best Friend"> </div>
                <div class="form-group"> <label for="contactPeerIdInput">Peer ID</label> <input type="text" id="contactPeerIdInput" maxlength="30" placeholder="Enter their 18-digit code"> </div>
            </div>
            <div class="modal-footer"> 
                <button id="cancelContactModalBtn" class="btn-cancel">Cancel</button>
                <button id="saveContactBtn" class="btn-primary">Save Contact</button> 
            </div>
        </div>
    </div>

    <div id="fullIdModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header"> 
                <h2>Your Shareable ID</h2> 
                <button id="closeIdModalBtn" class="close-btn"><img src="../images/cross-white.png" alt="Close"></button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p>Share this code with a friend to connect:</p>
                <input type="text" id="fullIdDisplay" readonly style="font-size: 1.2em; text-align: center; cursor: copy;" title="Click to copy">
            </div>
            <div class="modal-footer"> 
                <button id="copyIdBtn" class="btn-primary">Copy ID</button>
            </div>
        </div>
    </div>

    <script>
    // --- AUTH & BASIC UI ---
    firebase.auth().onAuthStateChanged(user => { if (!user) { window.location.href = '../login.html'; } });
    document.getElementById('logoutBtn')?.addEventListener('click', () => { firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
    document.getElementById('signOutLink')?.addEventListener('click', (e) => { e.preventDefault(); firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
    const sidebar = document.getElementById('sidebar');
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    if (toggleSidebarBtn && sidebar) { toggleSidebarBtn.addEventListener('click', () => { sidebar.classList.toggle('collapsed'); }); }

    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Element References ---
        const myIdSpan = document.getElementById('my-id');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const connectionStatusSpan = document.getElementById('connection-status');
        const contactsList = document.getElementById('contactsList');

        // Modals
        const contactModal = document.getElementById('contactModal');
        const fullIdModal = document.getElementById('fullIdModal');
        const fullIdDisplay = document.getElementById('fullIdDisplay');

        let peer = null;
        let conn = null;
        let localPeerId = null;

        const CONTACTS_STORAGE_KEY = '4sp-messenger-contacts';

        // --- PeerJS Logic ---
        function generateId() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 18; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function initializePeer() {
            const userId = localStorage.getItem('4sp-messenger-id') || generateId();
            peer = new Peer(userId, {});

            peer.on('open', id => {
                console.log('My peer ID is: ' + id);
                localPeerId = id;
                localStorage.setItem('4sp-messenger-id', id);
                myIdSpan.textContent = `${id.substring(0, 8)}...`;
                fullIdDisplay.value = id;
                updateUiState('disconnected');
            });

            peer.on('connection', newConnection => {
                if (conn && conn.open) {
                    newConnection.close();
                    return;
                }
                conn = newConnection;
                setupConnectionEvents(conn);
            });

            peer.on('error', err => {
                console.error('PeerJS Error:', err);
                addMessage('System', `Error: ${err.message}`);
                if (err.type === 'peer-unavailable' || err.type === 'network') {
                    addMessage('System', `Could not connect. Friend may be offline or their ID is incorrect.`);
                    updateUiState('disconnected');
                }
            });
        }

        function setupConnectionEvents(connection) {
            connection.on('open', () => {
                const contact = getContacts().find(c => c.peerId === connection.peer);
                const peerName = contact ? contact.nickname : `${connection.peer.substring(0, 8)}...`;
                updateUiState('connected', peerName);
                addMessage('System', `You are now connected to ${peerName}.`);
            });

            connection.on('data', data => {
                addMessage('Friend', data);
            });

            connection.on('close', () => {
                addMessage('System', 'Your friend has disconnected.');
                conn = null;
                updateUiState('disconnected');
            });
        }

        function connectToPeer(peerId) {
            if (!peerId || peerId.trim() === '') {
                addMessage('System', 'Invalid or empty Peer ID provided.');
                return;
            }
            if (peerId === localPeerId) {
                addMessage('System', "You can't connect to yourself!");
                return;
            }
            if (conn) {
                conn.close();
            }
            clearMessages();
            const contact = getContacts().find(c => c.peerId === peerId);
            const peerName = contact ? contact.nickname : `${peerId.substring(0, 8)}...`;

            updateUiState('connecting', peerName);
            conn = peer.connect(peerId);
            setupConnectionEvents(conn);
        }

        function disconnect() {
            if (conn) {
                conn.close();
                addMessage('System', 'You have disconnected.');
            }
        }

        // --- UI & State Management ---
        function updateUiState(state, peerName = '') {
            sendButton.disabled = state !== 'connected';
            messageInput.disabled = state !== 'connected';

            switch (state) {
                case 'connected':
                    connectionStatusSpan.textContent = `Connected to ${peerName}`;
                    break;
                case 'connecting':
                    connectionStatusSpan.textContent = `Connecting to ${peerName}...`;
                    break;
                case 'disconnected':
                default:
                    connectionStatusSpan.textContent = 'Ready to connect';
                    break;
            }
        }

        function addMessage(sender, message) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('message');
            
            const senderEl = document.createElement('span');
            senderEl.classList.add('sender');
            senderEl.textContent = `${sender}: `;

            const contentEl = document.createTextNode(message);
            
            if (sender === 'System') {
                messageEl.classList.add('system');
                messageEl.appendChild(contentEl);
            } else {
                messageEl.appendChild(senderEl);
                messageEl.appendChild(contentEl);
            }
            
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function clearMessages() {
            messagesDiv.innerHTML = '';
        }

        // --- Contacts Management ---
        function getContacts() {
            return JSON.parse(localStorage.getItem(CONTACTS_STORAGE_KEY) || '[]');
        }

        function saveContacts(contacts) {
            localStorage.setItem(CONTACTS_STORAGE_KEY, JSON.stringify(contacts));
            renderContacts();
        }

        function renderContacts() {
            const contacts = getContacts();
            contactsList.innerHTML = '';
            if (contacts.length === 0) {
                 contactsList.innerHTML = `<li style="text-align:center; font-size: 0.9em; color: #aaa; padding: 10px 0;">No contacts yet.</li>`;
            }
            contacts.forEach(contact => {
                const li = document.createElement('li');
                li.className = 'contact-item';
                li.innerHTML = `
                    <span class="contact-name">${contact.nickname}</span>
                    <div class="contact-actions">
                        <button class="contact-btn chat" title="Chat with ${contact.nickname}">üí¨</button>
                        <button class="contact-btn edit" title="Edit ${contact.nickname}">‚úèÔ∏è</button>
                        <button class="contact-btn delete" title="Delete ${contact.nickname}">üóëÔ∏è</button>
                    </div>
                `;
                li.querySelector('.chat').addEventListener('click', () => connectToPeer(contact.peerId));
                li.querySelector('.edit').addEventListener('click', () => openContactModal(contact.id));
                li.querySelector('.delete').addEventListener('click', () => {
                    if (confirm(`Are you sure you want to delete ${contact.nickname}?`)) {
                        deleteContact(contact.id);
                    }
                });
                contactsList.appendChild(li);
            });
        }

        function saveContact() {
            const id = document.getElementById('contactIdInput').value;
            const nickname = document.getElementById('contactNicknameInput').value.trim();
            const peerId = document.getElementById('contactPeerIdInput').value.trim();

            if (!nickname || !peerId) {
                alert('Both Nickname and Peer ID are required.');
                return;
            }

            let contacts = getContacts();
            if (id) { // Editing
                const contact = contacts.find(c => c.id === id);
                if (contact) {
                    contact.nickname = nickname;
                    contact.peerId = peerId;
                }
            } else { // Adding new
                contacts.push({ id: Date.now().toString(), nickname, peerId });
            }
            saveContacts(contacts);
            closeContactModal();
        }
        
        function deleteContact(id) {
            let contacts = getContacts();
            contacts = contacts.filter(c => c.id !== id);
            saveContacts(contacts);
        }

        // --- Modal Handling ---
        function openContactModal(id = null) {
            const title = document.getElementById('contactModalTitle');
            const idInput = document.getElementById('contactIdInput');
            const nicknameInput = document.getElementById('contactNicknameInput');
            const peerIdInput = document.getElementById('contactPeerIdInput');

            if (id) {
                const contacts = getContacts();
                const contact = contacts.find(c => c.id === id);
                if (contact) {
                    title.textContent = 'Edit Contact';
                    idInput.value = contact.id;
                    nicknameInput.value = contact.nickname;
                    peerIdInput.value = contact.peerId;
                }
            } else {
                title.textContent = 'Add New Contact';
                idInput.value = '';
                nicknameInput.value = '';
                peerIdInput.value = '';
            }
            contactModal.classList.add('visible');
        }

        function closeContactModal() {
            contactModal.classList.remove('visible');
        }

        function openFullIdModal() {
            fullIdModal.classList.add('visible');
        }
        
        function closeFullIdModal() {
            fullIdModal.classList.remove('visible');
        }

        // --- Event Listeners ---
        sendButton.addEventListener('click', () => {
            if (conn && conn.open) {
                const msg = messageInput.value;
                if (msg) {
                    conn.send(msg);
                    addMessage('You', msg);
                    messageInput.value = '';
                }
            } else {
                addMessage('System', 'You must be connected to send a message.');
            }
        });

        messageInput.addEventListener('keyup', e => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });
        
        myIdSpan.addEventListener('click', openFullIdModal);
        document.getElementById('addContactBtn').addEventListener('click', () => openContactModal());
        document.getElementById('saveContactBtn').addEventListener('click', saveContact);
        document.getElementById('closeContactModalBtn').addEventListener('click', closeContactModal);
        document.getElementById('cancelContactModalBtn').addEventListener('click', closeContactModal);
        
        document.getElementById('closeIdModalBtn').addEventListener('click', closeFullIdModal);
        document.getElementById('copyIdBtn').addEventListener('click', () => {
             navigator.clipboard.writeText(fullIdDisplay.value).then(() => {
                alert('ID copied to clipboard!');
                closeFullIdModal();
             });
        });
        fullIdDisplay.addEventListener('click', () => {
             navigator.clipboard.writeText(fullIdDisplay.value).then(() => alert('ID copied to clipboard!'));
        });

        // --- Initializer ---
        function initializeApp() {
            initializePeer();
            renderContacts();
            addMessage('System', 'Welcome! Add a contact or connect to a friend to start chatting.');
        }

        initializeApp();
    });
    </script>
</body>
</html>
