<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - SOUNDBOARD</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <style>
        :root {
            --v5-bg: #f0f2f5;
            --v5-card-bg: #ffffff;
            --v5-text-primary: #1a1a1a;
            --v5-text-secondary: #5c5c5c;
            --v5-purple-accent: #6720bd;
            --v5-border-color: #e0e0e0;
            --v5-input-bg: #f8f9fa;
            --v5-danger-color: #dc3545;
            --v5-danger-color-darker: #c82333;
            --v5-boost-color: #ff4136;
            --v5-font-primary: 'PrimaryFont', sans-serif;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body, html { height: 100%; margin: 0; overflow: hidden; }

        body.soundboard-page {
            display: flex; flex-direction: column;
            font-family: var(--v5-font-primary);
            background: var(--v5-bg);
            color: var(--v5-text-primary);
        }
        
        .main-header { position: sticky; top: 0; z-index: 1001; background: var(--v5-card-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0; }
        .soundboard-container-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 200px; background: #1f1f1f; color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #333; transition: width 0.3s ease; }
        .sidebar.collapsed { width: 85px; }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 20px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; text-transform: uppercase; font-size: 1em; font-family: var(--v5-font-primary); }
        .sidebar nav a.active, .sidebar nav a:hover { background: var(--v5-purple-accent); }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .sidebar.collapsed .label { display: none; }
        .main-soundboard-content { flex: 1; padding: 30px; padding-bottom: 120px; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
        
        .action-button {
            padding: 10px 18px; background: var(--v5-purple-accent); color: white;
            border: none; border-radius: 8px; cursor: pointer;
            font-family: var(--v5-font-primary); font-size: 0.95em;
            text-transform: uppercase; transition: all 0.25s ease;
            box-shadow: 0 2px 8px rgba(103, 32, 189, 0.3);
        }
        .action-button:hover { background: var(--v5-purple-accent-darker); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(103, 32, 189, 0.5); }
        
        .floating-action-bar { position: fixed; bottom: 30px; right: 30px; z-index: 1000; display: flex; align-items: center; gap: 10px; }
        .fab-button {
            border-radius: 50px; width: 56px; height: 56px; padding: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5em; background: var(--v5-purple-accent);
            box-shadow: 0 4px 12px rgba(103, 32, 189, 0.4);
            color: white; border: none; cursor: pointer; transition: all 0.25s ease;
        }
        .fab-button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(103, 32, 189, 0.5); }
        #clearAllSoundsBtn { background: var(--v5-danger-color); box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4); font-size: 1.1em; width: auto; padding: 0 20px; }
        #clearAllSoundsBtn:hover { background: var(--v5-danger-color-darker); box-shadow: 0 6px 16px rgba(220, 53, 69, 0.5); }
        #soundSearchInput { width: 0; opacity: 0; border: none; outline: none; border-radius: 50px; padding: 18px 20px; font-size: 1em; font-family: var(--v5-font-primary); transition: all 0.4s ease-in-out; box-shadow: 0 4px 15px rgba(0,0,0,0.2); background: var(--v5-card-bg); margin-right: -66px; pointer-events: none; }
        .floating-action-bar.search-active #soundSearchInput { width: 250px; opacity: 1; margin-right: 0; pointer-events: auto; }
        .floating-action-bar.search-active #toggleSearchBtn { background: var(--v5-purple-accent-darker); }

        .soundboard-header-v4 { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .soundboard-title-v4 { font-size: 2.5em; font-weight: 800; color: var(--v5-purple-accent); }
        .controls-container { background: var(--v5-card-bg); border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 25px; }
        .controls-tabs { display: flex; background: var(--v5-input-bg); border-bottom: 1px solid var(--v5-border-color); }
        .tab-button {
            padding: 15px 20px; border: none; background: transparent;
            font-family: var(--v5-font-primary); font-size: 0.9em; font-weight: 600;
            color: var(--v5-text-secondary); cursor: pointer;
            position: relative; transition: color 0.3s ease;
        }
        .tab-button::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--v5-purple-accent); transform: scaleX(0); transition: transform 0.3s ease; }
        .tab-button.active { color: var(--v5-text-primary); }
        .tab-button.active::after { transform: scaleX(1); }
        .tab-button:disabled { color: #bbb; cursor: not-allowed; }

        .tab-content { padding: 25px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px 35px; }
        .control-group label { font-size: 0.9em; color: var(--v5-text-secondary); margin-bottom: 8px; font-family: var(--v5-font-primary); display: block;}
        .checkbox-label-v5 { display: flex; align-items: center; cursor: pointer; gap: 10px; padding: 5px 0; }
        .control-group input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--v5-input-bg); border-radius: 5px; border: 1px solid var(--v5-border-color); outline: none;}
        .control-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--v5-purple-accent); cursor: pointer; border-radius: 50%; border: 3px solid var(--v5-card-bg); box-shadow: 0 0 5px rgba(0,0,0,0.2); transition: all 0.2s ease-in-out; }
        
        #masterVolumeSliderV4 { --volume-percent: 100%; --track-bg: linear-gradient(to right, var(--v5-purple-accent) var(--volume-percent), var(--v5-input-bg) var(--volume-percent)); background: var(--track-bg); transition: background 0.1s ease; }
        .boosted #masterVolumeSliderV4 { --track-bg: linear-gradient(to right, var(--v5-purple-accent) 50%, var(--v5-boost-color) 50%, var(--v5-boost-color) var(--volume-percent), var(--v5-input-bg) var(--volume-percent)); background: var(--track-bg); }
        .boosted #masterVolumeSliderV4::-webkit-slider-thumb { background: var(--v5-boost-color); transform: scale(1.1); box-shadow: 0 0 10px var(--v5-boost-color); }
        
        .sound-category-v4 { margin-bottom: 25px; background: var(--v5-card-bg); padding: 25px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
        .sound-category-v4 h2 { font-size: 1.3em; font-weight: 700; color: var(--v5-text-primary); margin: -5px 0 20px 0; padding-bottom: 15px; border-bottom: 1px solid var(--v5-border-color); display: flex; align-items: center; gap: 10px;}
        .sound-buttons-grid-v4 { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; }
        .sound-button-v4 {
            background-color: var(--v5-input-bg); color: var(--v5-text-secondary); border: 1px solid var(--v5-border-color);
            padding: 10px; border-radius: 10px; font-family: var(--v5-font-primary); font-weight: 600; font-size: 0.8em;
            transition: all 0.2s ease; text-transform: uppercase;
            display: flex; align-items: center; justify-content: center; min-height: 50px; text-align: center; cursor: pointer;
        }
        .sound-button-v4:hover { border-color: var(--v5-purple-accent); color: var(--v5-purple-accent); transform: translateY(-2px); }
        .sound-button-v4.playing {
            background: var(--v5-purple-accent); color: white; border-color: var(--v5-purple-accent);
            animation: pulsePlayingSoundboardV4 1.2s infinite ease-out;
        }
        @keyframes pulsePlayingSoundboardV4 { 0% { box-shadow: 0 0 0 0 rgba(103, 32, 189, 0.5); } 100% { box-shadow: 0 0 0 12px rgba(103, 32, 189, 0); } }
    </style>
</head>
<body class="soundboard-page">

    <header class="main-header light-bg">
        </header>

    <div class="soundboard-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar">
            </aside>

        <main class="main-soundboard-content">
            <div class="soundboard-header-v4">
                <h2 class="soundboard-title-v4">Soundboard</h2>
            </div>
            
            <div class="controls-container">
                <div class="controls-tabs">
                    <button class="tab-button active" data-tab="playbackTab">Playback</button>
                    <button class="tab-button" data-tab="effectsTab">Effects</button>
                    <button class="tab-button" data-tab="equalizerTab">Equalizer</button>
                    <button class="tab-button" data-tab="spatialTab">Spatial</button>
                    <button class="tab-button" data-tab="autoclickerTab">Autoclicker</button>
                </div>
                <div class="tab-content">
                    <div id="playbackTab" class="tab-pane active">
                        <div class="controls-grid">
                            <div class="control-group">
                                <label class="checkbox-label-v5"><input type="checkbox" id="allowMultipleSoundsToggleV4" checked><span>Allow Multiple Sounds</span></label>
                                <label class="checkbox-label-v5"><input type="checkbox" id="loopSoundToggleV4"><span>Loop Sound</span></label>
                            </div>
                            <div class="control-group">
                                <label for="fadeDurationInputV4">Fade In/Out (ms)</label>
                                <input type="number" id="fadeDurationInputV4" value="100" min="0" step="50">
                            </div>
                        </div>
                    </div>
                    <div id="effectsTab" class="tab-pane">
                        <div class="controls-grid">
                            <div class="control-group">
                                <label for="playbackSpeedSliderV4">Speed: <span id="playbackSpeedValueV4">1.00x</span></label>
                                <input type="range" id="playbackSpeedSliderV4" min="0.1" max="4" step="0.05" value="1">
                            </div>
                             <div class="control-group">
                                <label for="pitchSliderV4">Pitch: <span id="pitchValueV4">0 semitones</span></label>
                                <input type="range" id="pitchSliderV4" min="-24" max="24" step="1" value="0">
                            </div>
                        </div>
                    </div>
                    <div id="equalizerTab" class="tab-pane">
                         <div class="controls-grid">
                            <div class="control-group">
                                <label for="bassSliderV4">Bass: <span id="bassValueV4">0 dB</span></label>
                                <input type="range" id="bassSliderV4" min="-12" max="12" step="1" value="0">
                            </div>
                            <div class="control-group">
                                <label for="midSliderV4">Mids: <span id="midValueV4">0 dB</span></label>
                                <input type="range" id="midSliderV4" min="-12" max="12" step="1" value="0">
                            </div>
                            <div class="control-group">
                                <label for="trebleSliderV4">Treble: <span id="trebleValueV4">0 dB</span></label>
                                <input type="range" id="trebleSliderV4" min="-12" max="12" step="1" value="0">
                            </div>
                        </div>
                    </div>
                    <div id="spatialTab" class="tab-pane">
                         <div class="controls-grid">
                             <div class="control-group">
                                <label for="panSliderV4">Pan (L/R): <span id="panValueV4">Center</span></label>
                                <input type="range" id="panSliderV4" min="-1" max="1" step="0.05" value="0">
                            </div>
                            <div class="control-group">
                                <label for="reverbSliderV4">Reverb: <span id="reverbValueV4">0%</span></label>
                                <input type="range" id="reverbSliderV4" min="0" max="1" step="0.01" value="0">
                            </div>
                         </div>
                    </div>
                    <div id="autoclickerTab" class="tab-pane">
                         <div class="autoclicker-main-group">
                                <label class="checkbox-label-v5">
                                    <input type="checkbox" id="autoClickerCheckboxV4"><span>Enable</span>
                                </label>
                                <div class="autoclicker-options-wrapper" id="autoclickerOptionsWrapper" style="display: none;">
                                    </div>
                            </div>
                    </div>
                </div>
                 <div class="control-group" style="padding: 0 25px 25px 25px; border-top: 1px solid var(--v5-border-color); margin-top: 25px; padding-top: 25px;">
                    <div id="masterVolumeContainer" class="control-group">
                        <label for="masterVolumeSliderV4">Master Volume: <span id="masterVolumeValueV4">100%</span></label>
                        <div class="volume-slider-wrapper">
                            <input type="range" id="masterVolumeSliderV4" min="0" max="1" step="0.01" value="1">
                        </div>
                    </div>
                </div>
            </div>

            <div id="soundCategoriesContainerV4"> </div>
        </main>
    </div>

    <div id="floatingActionBar" class="floating-action-bar">
        <input type="text" id="soundSearchInput" placeholder="Search sounds...">
        <button id="toggleSearchBtn" class="fab-button">🔍</button>
        <button id="clearAllSoundsBtn" class="action-button">Stop All</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- All Elements ---
            const floatingActionBar = document.getElementById('floatingActionBar');
            const toggleSearchBtn = document.getElementById('toggleSearchBtn');
            const soundSearchInput = document.getElementById('soundSearchInput');
            const clearAllSoundsBtn = document.getElementById('clearAllSoundsBtn');
            const masterVolumeSlider = document.getElementById('masterVolumeSliderV4');
            const masterVolumeContainer = document.getElementById('masterVolumeContainer').querySelector('.volume-slider-wrapper');
            const tabs = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');
            const soundCategoriesContainer = document.getElementById('soundCategoriesContainerV4');
            const allowMultipleSoundsToggle = document.getElementById('allowMultipleSoundsToggleV4');
            const loopSoundToggle = document.getElementById('loopSoundToggleV4');
            const fadeDurationInput = document.getElementById('fadeDurationInputV4');
            const playbackSpeedSlider = document.getElementById('playbackSpeedSliderV4');
            const pitchSlider = document.getElementById('pitchSliderV4');
            const bassSlider = document.getElementById('bassSliderV4');
            const midSlider = document.getElementById('midSliderV4');
            const trebleSlider = document.getElementById('trebleSliderV4');
            const panSlider = document.getElementById('panSliderV4');
            const reverbSlider = document.getElementById('reverbSliderV4');
            const autoClickerCheckbox = document.getElementById('autoClickerCheckboxV4');
            const autoClickerOptionsWrapper = document.getElementById('autoclickerOptionsWrapper');
            
            // --- Audio Nodes & State ---
            const audioContext = new(window.AudioContext || window.webkitAudioContext)();
            const globalGainNode = audioContext.createGain();
            const pannerNode = audioContext.createStereoPanner();
            const convolverNode = audioContext.createConvolver();
            const reverbWetGain = audioContext.createGain();
            const reverbDryGain = audioContext.createGain();
            const bassFilter = audioContext.createBiquadFilter();
            const midFilter = audioContext.createBiquadFilter();
            const trebleFilter = audioContext.createBiquadFilter();
            let isVolumeBoosted = false;
            let playingAudios = [];
            let audioBuffers = {};
            
            // --- Audio Chain ---
            bassFilter.type = 'lowshelf'; bassFilter.frequency.value = 300;
            midFilter.type = 'peaking'; midFilter.frequency.value = 1200; midFilter.Q.value = 1.2;
            trebleFilter.type = 'highshelf'; trebleFilter.frequency.value = 3000;
            pannerNode.connect(bassFilter).connect(midFilter).connect(trebleFilter);
            trebleFilter.connect(reverbDryGain).connect(globalGainNode);
            trebleFilter.connect(convolverNode).connect(reverbWetGain).connect(globalGainNode);
            globalGainNode.connect(audioContext.destination);
            reverbWetGain.gain.value = 0;

            // --- All Functions ---
            const setupTabControls = () => {
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        if (tab.disabled) return;
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        const targetPaneId = tab.dataset.tab;
                        tabPanes.forEach(pane => pane.classList.toggle('active', pane.id === targetPaneId));
                    });
                });
            };

            const setControlsDisabled = (disabled) => {
                const liveMixTabs = ['equalizerTab', 'spatialTab'];
                tabs.forEach(tab => { if (!liveMixTabs.includes(tab.dataset.tab)) tab.disabled = disabled; });
                ['playbackTab', 'effectsTab', 'autoclickerTab'].forEach(tabId => {
                    document.getElementById(tabId).querySelectorAll('input, select, button').forEach(el => el.disabled = disabled);
                });
            };
            
            const stopAllActiveSounds = () => {
                playingAudios.forEach(audioObj => { try { audioObj.source.stop(); } catch(e){} });
                playingAudios = [];
                document.querySelectorAll('.sound-button-v4.playing').forEach(btn => btn.classList.remove('playing'));
                setControlsDisabled(false);
            };

            const playSound = async (soundDetails, buttonElement) => {
                if (audioContext.state === 'suspended') await audioContext.resume();
                if (!allowMultipleSoundsToggle.checked) stopAllActiveSounds();
                if (playingAudios.length === 0) setControlsDisabled(true);
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffers[soundDetails.path];
                source.detune.value = parseInt(pitchSlider.value, 10) * 100;
                source.playbackRate.value = parseFloat(playbackSpeedSlider.value);
                source.loop = loopSoundToggle.checked;
                const fadeInGain = audioContext.createGain();
                const fadeSeconds = (parseInt(fadeDurationInput.value, 10) || 0) / 1000;
                if (fadeSeconds > 0) {
                    fadeInGain.gain.setValueAtTime(0.0001, audioContext.currentTime);
                    fadeInGain.gain.linearRampToValueAtTime(1, audioContext.currentTime + fadeSeconds);
                }
                source.connect(fadeInGain);
                fadeInGain.connect(pannerNode);
                const audioId = Date.now();
                playingAudios.push({ id: audioId, source: source });
                source.start(0);
                buttonElement.classList.add('playing');
                source.onended = () => {
                    buttonElement.classList.remove('playing');
                    playingAudios = playingAudios.filter(obj => obj.id !== audioId);
                    if (playingAudios.length === 0) setControlsDisabled(false);
                };
            };
            
            const loadSounds = async () => { /* ... full fetch and button creation logic ... */ };
            const startAutoClicker = (event) => { /* ... full setInterval logic ... */ };
            const stopAutoClicker = () => { /* ... full clearInterval logic ... */ };
            const setupAutoClickerControls = () => { /* ... full event listener for checkbox ... */ };
            const setupEventListeners = () => {
                 document.addEventListener('keydown', (e) => { if (e.shiftKey && e.key.toUpperCase() === 'C') { e.preventDefault(); stopAllActiveSounds(); } });
                 clearAllSoundsBtn.addEventListener('click', stopAllActiveSounds);
                 toggleSearchBtn.addEventListener('click', () => { floatingActionBar.classList.toggle('search-active'); if(floatingActionBar.classList.contains('search-active')) soundSearchInput.focus(); });
                 soundSearchInput.addEventListener('input', (e) => { const term = e.target.value.toLowerCase(); document.querySelectorAll('.sound-button-v4').forEach(btn => btn.style.display = btn.dataset.soundName.includes(term) ? 'flex' : 'none'); });
                 masterVolumeSlider.addEventListener('input', e => {
                    const value = parseFloat(e.target.value);
                    globalGainNode.gain.setValueAtTime(value, audioContext.currentTime);
                    masterVolumeContainer.nextElementSibling.textContent = `${Math.round(value * 100)}%`;
                    masterVolumeSlider.style.setProperty('--volume-percent', `${(value / masterVolumeSlider.max) * 100}%`);
                    if (value >= 1 && !isVolumeBoosted) { isVolumeBoosted = true; masterVolumeSlider.max = 2; masterVolumeContainer.classList.add('boosted'); }
                    else if (value < 1 && isVolumeBoosted) { isVolumeBoosted = false; masterVolumeSlider.max = 1; masterVolumeContainer.classList.remove('boosted'); }
                });
                // ... all other control listeners ...
            };
            const loadPreferences = () => { /* ... full localStorage logic ... */ };
            const createReverbImpulse = () => { /* ... full impulse response generation ... */ };
            
            // --- Initial Execution ---
            setupTabControls();
            loadPreferences();
            loadSounds();
            setupEventListeners();
            setupAutoClickerControls();
            createReverbImpulse();
        });
    </script>
</body>
</html>
