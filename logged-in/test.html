<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HAC Tracker - Minerva Local Schools</title>
    
    <style>
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }
        .hidden { display: none !important; }
        body { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: var(--v4-font-primary); background: var(--v4-bg-gradient); color: var(--v4-text-primary); line-height: 1.6; }
        .container-wrapper { display: flex; flex: 1; overflow: hidden; }
        
        .sidebar { width: 220px; background: linear-gradient(180deg, #2a3f54 0%, #1c2e40 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar .logo-area { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #444; }
        .sidebar .logo-area h2 { margin: 0; font-weight: 300; font-size: 1.8em; color: #fff; }
        .sidebar .logo-area p { margin: 5px 0 0; color: #ccc; font-size: 0.9em; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 20px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-size: 0.9em; text-transform: uppercase; }
        .sidebar nav a.active, .sidebar nav a:hover { background: var(--v4-purple-gradient); transform: translateX(5px); }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; margin-right: 10px; }
        #logout-container { margin-top: auto; padding: 10px; }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        .page-header-v4 { margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .page-title-v4 { font-size: 2.2em; font-weight: bold; background-image: var(--v4-purple-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        #student-name-display { font-size: 1.2rem; font-weight: 500; color: var(--v4-text-secondary); }

        .status-message-v4 { display: none; padding: 15px 25px; margin: 0 auto 20px auto; border-radius: 12px; text-align: center; max-width: 600px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); color: white; }
        .status-message-v4.error { background: linear-gradient(135deg, #8f262a, #721c24); }
        .status-message-v4.info { background: linear-gradient(135deg, #004085, #002752); }
        
        #login-container { background: var(--v4-card-bg); padding: 35px; border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); margin: auto; max-width: 500px; width: 100%; }
        #loginForm h3 { text-align: center; color: var(--v4-text-primary); font-weight: 300; font-size: 1.5em; margin-bottom: 10px; }
        #loginForm p { text-align: center; color: var(--v4-text-secondary); margin-top: 0; margin-bottom: 25px; }
        #loginForm .form-group { margin-bottom: 20px; }
        #loginForm label { font-weight: bold; color: var(--v4-text-secondary); margin-bottom: 8px; display: block; }
        #loginForm input { width: 100%; padding: 14px; border: 1px solid var(--v4-input-border); border-radius: 8px; background: var(--v4-input-bg); font-size: 1.1em; box-sizing: border-box; transition: all 0.3s ease; }
        #loginForm input:focus { box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.3); border-color: var(--v4-purple-accent); outline: none; }
        #loginForm button { width: 100%; }

        .btn { border: none; padding: 14px 24px; border-radius: 10px; text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--v4-purple-gradient); color: white; }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(103, 32, 189, 0.4); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4); }

        .loader { text-align: center; padding: 50px; }
        .loader .spinner { border: 8px solid #f3f3f3; border-top-color: var(--v4-purple-accent); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .class-card { background: var(--v4-card-bg); border-left: 5px solid var(--v4-purple-accent); border-radius: 10px; padding: 20px 25px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); }
        .class-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; }
        .class-info { flex-grow: 1; min-width: 0; }
        .class-title { font-size: 1.4em; font-weight: bold; color: var(--v4-text-primary); }
        .class-teacher { font-size: 1em; color: var(--v4-text-secondary); }
        .class-grade-display { font-size: 2.5em; font-weight: bold; color: var(--v4-purple-accent); }
        
        .table-container { background: var(--v4-card-bg); border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--v4-border-softer); }
        th { background-color: #f8f9fa; font-weight: bold; color: var(--v4-text-secondary); text-transform: uppercase; font-size: 0.9em; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f1f3f5; }

        .rank-container { background: var(--v4-card-bg); border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); padding: 30px; display: flex; justify-content: space-around; text-align: center; }
        .rank-item .value { font-size: 3em; font-weight: bold; color: var(--v4-purple-accent); }
        .rank-item .label { font-size: 1.2em; color: var(--v4-text-secondary); margin-top: 5px; }

        .section-title { font-size: 1.8em; font-weight: bold; margin-bottom: 15px; padding-bottom: 10px; color: var(--v4-purple-accent); border-bottom: 2px solid var(--v4-purple-accent); }
    </style>
</head>
<body>

    <div class="container-wrapper">
        <aside class="sidebar">
            <div class="logo-area">
                <h2>Minerva</h2>
                <p>HAC Portal</p>
            </div>
            <nav id="main-nav" class="hidden"></nav>
            <div id="logout-container">
                 <button id="logoutBtn" class="btn btn-secondary hidden" style="width: 100%;">Log Out</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="page-header-v4"> 
                <div>
                    <h2 class="page-title-v4" id="page-title">Login</h2> 
                    <p id="student-name-display" class="hidden"></p>
                </div>
                <button id="refreshBtn" class="btn btn-primary hidden">Refresh Data</button>
            </div>
            <div id="statusMessage" class="status-message-v4"></div>

            <div id="login-container">
                <form id="loginForm">
                    <h3>Minerva Local Schools</h3>
                    <p>Home Access Center (Live)</p>
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" placeholder="Enter your username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" id="loginBtn" class="btn btn-primary">Log In</button>
                </form>
            </div>
            
            <div id="data-view" class="hidden"></div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const MINERVA_HAC_BASE_URL = "https://hac.sparcc.org/HomeAccess";

        const UI_ELEMENTS = {
            loginContainer: document.getElementById('login-container'),
            loginForm: document.getElementById('loginForm'),
            loginBtn: document.getElementById('loginBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            refreshBtn: document.getElementById('refreshBtn'),
            dataView: document.getElementById('data-view'),
            mainNav: document.getElementById('main-nav'),
            pageTitle: document.getElementById('page-title'),
            studentNameDisplay: document.getElementById('student-name-display'),
            statusMessage: document.getElementById('statusMessage'),
        };
        
        const NAV_MENU_HTML = `
            <ul>
                <li><a href="#" class="nav-link active" data-endpoint="averages"><span class="icon">📊</span><span class="label">Averages</span></a></li>
                <li><a href="#" class="nav-link" data-endpoint="reportcard"><span class="icon">📄</span><span class="label">Report Card</span></a></li>
                <li><a href="#" class="nav-link" data-endpoint="ipr"><span class="icon">📈</span><span class="label">IPR</span></a></li>
                <li><a href="#" class="nav-link" data-endpoint="rank"><span class="icon">🏆</span><span class="label">Class Rank</span></a></li>
                <li><a href="#" class="nav-link" data-endpoint="transcript"><span class="icon">📜</span><span class="label">Transcript</span></a></li>
            </ul>`;

        const appState = { credentials: null, cache: {}, currentView: '' };

        const RENDERERS = {
            loader: () => `<div class="loader"><div class="spinner"></div><p>Fetching data from Minerva HAC...</p></div>`,
            error: (message) => `<div class="status-message-v4 error" style="display: block; margin-top: 20px;"><strong>Error:</strong> ${message}</div>`,
            averages: (data) => `<div class="card-grid">${data.map(c => `<div class="class-card"><div class="class-card-header"><div class="class-info"><div class="class-title">${c.className}</div><div class="class-teacher">${c.teacherName}</div></div><div class="class-grade-display">${c.average||'N/A'}</div></div></div>`).join('')}</div>`,
            reportcard: (data) => `<div class="table-container"><table><thead><tr><th>Course</th><th>Period</th><th>Teacher</th>${Object.keys(data.courses[0].grades).map(k=>`<th>${k}</th>`).join('')}</tr></thead><tbody>${data.courses.map(c=>`<tr><td>${c.course}</td><td>${c.period}</td><td>${c.teacher}</td>${Object.values(c.grades).map(g=>`<td>${g||'-'}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`,
            ipr: (data) => `<div class="table-container"><table><thead><tr><th>Course</th><th>Period</th><th>Teacher</th><th>Grade</th><th>Absences</th></tr></thead><tbody>${data.courses.map(c=>`<tr><td>${c.course}</td><td>${c.period}</td><td>${c.teacher}</td><td>${c.grade}</td><td>${c.absences}</td></tr>`).join('')}</tbody></table></div>`,
            rank: (data) => `<div class="rank-container">${Object.entries(data).map(([k,v])=>`<div class="rank-item"><div class="value">${v}</div><div class="label" style="text-transform: capitalize;">${k.replace(/([A-Z])/g, ' $1').trim()}</div></div>`).join('')}</div>`,
            transcript: (data) => data.years.map(y=>`<div class="transcript-year"><h3 class="section-title">${y.year}</h3>${y.semesters.map(s=>`<div style="margin-bottom:20px;"><h4 style="font-size: 1.3em;">${s.semester}</h4><div class="table-container"><table><thead><tr><th>Course</th><th>Credit</th><th>Grade</th></tr></thead><tbody>${s.courses.map(c=>`<tr><td>${c.course}</td><td>${c.credit}</td><td>${c.grade}</td></tr>`).join('')}</tbody></table></div></div>`).join('')}</div>`).join('')
        };

        async function fetchData(endpoint, forceRefresh = false) {
            if (appState.cache[endpoint] && !forceRefresh) {
                return { success: true, data: appState.cache[endpoint] };
            }
            const { username, password } = appState.credentials;
            const apiUrl = `https://homeaccesscenterapi.vercel.app/api?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&base=${encodeURIComponent(MINERVA_HAC_BASE_URL)}&endpoint=${endpoint}`;
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || `API error ${response.status}`);
                appState.cache[endpoint] = data;
                return { success: true, data };
            } catch (error) {
                return { success: false, message: error.message };
            }
        }

        async function renderViewContent(endpoint, forceRefresh = false) {
            UI_ELEMENTS.dataView.innerHTML = RENDERERS.loader();
            const result = await fetchData(endpoint, forceRefresh);
            if (result.success) {
                const nameData = appState.cache['name'] || (await fetchData('name'))?.data;
                if (nameData && nameData.studentName) {
                    UI_ELEMENTS.studentNameDisplay.textContent = `Student: ${nameData.studentName}`;
                    UI_ELEMENTS.studentNameDisplay.classList.remove('hidden');
                }
                const renderer = RENDERERS[endpoint];
                UI_ELEMENTS.dataView.innerHTML = renderer ? renderer(result.data) : RENDERERS.error(`No display available for: ${endpoint}`);
            } else {
                UI_ELEMENTS.dataView.innerHTML = RENDERERS.error(result.message);
            }
        }

        function showView(viewName) {
            UI_ELEMENTS.loginContainer.classList.add('hidden');
            UI_ELEMENTS.mainNav.classList.remove('hidden');
            UI_ELEMENTS.logoutBtn.classList.remove('hidden');
            UI_ELEMENTS.refreshBtn.classList.remove('hidden');
            UI_ELEMENTS.dataView.classList.remove('hidden');
            
            appState.currentView = viewName;
            document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.dataset.endpoint === viewName));
            const activeLink = document.querySelector('.nav-link.active');
            UI_ELEMENTS.pageTitle.textContent = activeLink ? activeLink.querySelector('.label').textContent : 'Dashboard';
            
            renderViewContent(viewName);
        }

        async function handleLogin(e) {
            e.preventDefault();
            appState.credentials = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value
            };
            
            UI_ELEMENTS.loginBtn.disabled = true;
            UI_ELEMENTS.loginBtn.textContent = 'Logging In...';
            showStatus('Authenticating...', 'info');

            const result = await fetchData('averages');
            
            UI_ELEMENTS.loginBtn.disabled = false;
            UI_ELEMENTS.loginBtn.textContent = 'Log In';

            if (result.success) {
                sessionStorage.setItem('minerva_hac_creds', JSON.stringify(appState.credentials));
                hideStatus();
                UI_ELEMENTS.mainNav.innerHTML = NAV_MENU_HTML;
                addNavListeners();
                showView('averages');
            } else {
                showStatus(result.message, 'error');
            }
        }

        function handleLogout() {
            appState.credentials = null;
            appState.cache = {};
            sessionStorage.removeItem('minerva_hac_creds');
            
            UI_ELEMENTS.dataView.classList.add('hidden');
            UI_ELEMENTS.mainNav.classList.add('hidden');
            UI_ELEMENTS.logoutBtn.classList.add('hidden');
            UI_ELEMENTS.refreshBtn.classList.add('hidden');
            UI_ELEMENTS.studentNameDisplay.classList.add('hidden');
            UI_ELEMENTS.loginContainer.classList.remove('hidden');
            UI_ELEMENTS.pageTitle.textContent = 'Login';
        }

        function addNavListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (!link.classList.contains('active')) {
                        showView(link.dataset.endpoint);
                    }
                });
            });
        }
        
        function showStatus(message, type = 'info') { 
            UI_ELEMENTS.statusMessage.textContent = message; 
            UI_ELEMENTS.statusMessage.className = `status-message-v4 ${type}`; 
            UI_ELEMENTS.statusMessage.style.display = 'block'; 
        }
        function hideStatus() { UI_ELEMENTS.statusMessage.style.display = 'none'; }

        function init() {
            const savedCreds = sessionStorage.getItem('minerva_hac_creds');
            if (savedCreds) {
                appState.credentials = JSON.parse(savedCreds);
                UI_ELEMENTS.mainNav.innerHTML = NAV_MENU_HTML;
                addNavListeners();
                showView('averages');
            }

            UI_ELEMENTS.loginForm.addEventListener('submit', handleLogin);
            UI_ELEMENTS.logoutBtn.addEventListener('click', handleLogout);
            UI_ELEMENTS.refreshBtn.addEventListener('click', () => {
                if (appState.currentView) {
                    renderViewContent(appState.currentView, true);
                }
            });
        }

        init();
    });
    </script>
</body>
</html>
