<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - Advanced Web Radio</title>
    <link rel="stylesheet" href="../css/style.css"> <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    
    <style>
        /* Core Styles (re-used and adapted from soundboard) */
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
        }
        body {
            display: flex; flex-direction: column; min-height: 100vh;
            margin: 0; font-family: var(--v4-font-primary);
            background: var(--v4-bg-gradient); color: var(--v4-text-primary);
            line-height: 1.6;
        }
        .soundboard-container-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar {
            width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff; padding: 20px 10px; display: flex; flex-direction: column;
            border-right: 1px solid #444; transition: width 0.5s ease-in-out;
            position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: none; border: none; color: #fff; font-size: 1.2em;
            cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out;
        }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: visible; }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em; }
        .marquee-content { display: inline-block; padding-left: 100%; transform: translateX(0); animation: none; line-height: 1.8em; }
        .marquee-active { animation: scroll-left-soundboard 12s linear infinite; }
        @keyframes scroll-left-soundboard { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .user-info .username { font-family: var(--v4-font-primary); font-size: 1.3em; margin-bottom: 8px; line-height: 0.2em; font-weight: bold;}
        .user-info .email { font-family: var(--v4-font-secondary); font-size: 0.9em; color: #bbb; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a {
            display: flex; align-items: center; padding: 12px 15px; color: #fff;
            text-decoration: none; border-radius: 8px; transition: all 0.3s ease;
            font-family: var(--v4-font-primary); text-transform: uppercase;
            position: relative; overflow: hidden; font-size: 1em;
        }
        .sidebar nav a:hover, .sidebar nav a.active { background: var(--v4-purple-gradient); transform: translateX(5px); color: #fff; }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .sidebar.collapsed nav a .label { display: none; }
        .main-content {
            flex: 1; padding: 30px; background: var(--v4-bg-gradient);
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .content-header-v4 {
            margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .content-title-v4 {
            font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .settings-tab-container {
            background: var(--v4-card-bg); border-radius: 15px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.08);
            margin-top: 25px;
        }
        .settings-header { display: flex; flex-direction: column; padding: 0 15px; border-bottom: 1px solid var(--v4-border-softer); }
        nav.settings-tabs { display: flex; flex-wrap: wrap; }
        .tab-link {
            background: none; border: none; padding: 15px 20px; cursor: pointer;
            font-size: 1.1em; font-family: var(--v4-font-primary); color: var(--v4-text-secondary);
            border-bottom: 3px solid transparent; margin-bottom: -1px; transition: all 0.2s ease-in-out;
        }
        .tab-link.active, .tab-link:hover { color: var(--v4-purple-accent); }
        .tab-link.active { border-bottom-color: var(--v4-purple-accent); font-weight: bold; }
        .tab-content {
            display: none;
            padding: 25px;
            gap: 15px 25px;
        }
        .tab-content.active {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .control-group { position: relative; display: flex; flex-direction: column; margin-bottom: 10px; }
        .control-group.locked { opacity: 0.4; pointer-events: none; }
        .control-group label, .checkbox-label-v4 { font-family: var(--v4-font-primary); font-weight: 600; font-size: 0.95em; color: var(--v4-text-secondary); margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        .control-group input, .control-group select {
            padding: 8px; background-color: var(--v4-input-bg); border: 1px solid var(--v4-input-border);
            border-radius: 6px; color: var(--v4-text-primary); font-family: var(--v4-font-secondary); font-size: 1em;
        }
        .control-group input[type="range"] { -webkit-appearance: none; appearance: none; flex-grow: 1; height: 8px; background: var(--v4-border-light); outline: none; padding: 0;}
        .control-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--v4-purple-accent); cursor: pointer; border-radius: 50%; }
        .control-group input[type="checkbox"] { margin-left: 12px; transform: scale(1.1); accent-color: var(--v4-purple-accent); }
        .mode-description { font-family: var(--v4-font-secondary); font-size: 0.85em; color: #777; margin-top: -5px; margin-bottom: 5px; padding-left: 2px; font-style: italic; font-weight: 400; }
        .spatial-audio-panel { margin-top: 15px; border-top: 1px solid var(--v4-border-softer); padding-top: 15px; display: none; }
        .control-group:has(#modeSpatial:checked) .spatial-audio-panel { display: block; }
        #spatial-pad { position: relative; width: 150px; height: 150px; border-radius: 50%; background-color: #e9e9e9; border: 1px solid #d1d1d1; box-shadow: inset 0 2px 8px rgba(0,0,0,0.1); cursor: crosshair; touch-action: none; -webkit-user-select: none; user-select: none; margin: 10px auto; }
        #spatial-puck { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; background-color: #222; border: 2px solid var(--v4-purple-accent); border-radius: 50%; transform: translate(-50%, -50%); cursor: grab; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.5); transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s; }
        #spatial-coords { text-align: center; font-family: var(--v4-font-secondary); margin-top: 10px; }
        
        /* Radio Specific Styles */
        .radio-player-container {
            padding: 30px;
            background: var(--v4-card-bg);
            border-radius: 15px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .radio-display {
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
            text-align: center;
            position: relative;
            overflow: hidden; /* For static overlay */
        }
        #staticOverlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZmlsdGVyIGlkPSJzIj48ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iMS4yIiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1ciAoI3MpIiBvcGFjaXR5PSIwLjM1Ii8+PC9zdmc+');
            z-index: 1;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            animation: static-flicker 0.15s infinite;
        }
        @keyframes static-flicker {
            0%, 100% { transform: translate(0,0); }
            25% { transform: translate(-2px, 2px); }
            50% { transform: translate(2px, -2px); }
            75% { transform: translate(2px, 2px); }
        }
        .station-name {
            font-size: 1.75em;
            font-weight: bold;
            min-height: 1.2em;
            position: relative; z-index: 2;
        }
        .station-genre {
            font-size: 1em;
            color: var(--v4-text-secondary);
            font-style: italic;
            min-height: 1.2em;
            position: relative; z-index: 2;
        }
        .search-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }
        .search-grid label {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--v4-text-secondary);
            text-align: left;
            margin-bottom: 5px;
        }
        .search-input-group {
            display: contents; /* Allows inputs to be direct children of the grid */
        }
        .btn-primary {
            padding: 8px 15px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid transparent;
            background: var(--v4-purple-gradient);
            color: #fff;
            transition: all 0.2s ease;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(103, 32, 189, 0.3); }
        .btn-secondary {
            padding: 8px 15px;
            font-size: 1em;
            border-radius: 6px;
            cursor: pointer;
            background-color: var(--v4-input-bg);
            border: 1px solid var(--v4-input-border);
            color: var(--v4-text-primary);
        }
        .power-button {
            padding: 10px 15px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        .power-button.off { background-color: #dc3545; border-color: #c82333; color: #fff; }
        .power-button.on { background-color: #28a745; border-color: #218838; color: #fff; }
        hr.divider { border: none; border-top: 1px solid var(--v4-border-softer); margin: 20px 0; }
        #searchResultsModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1002;
        }
        .modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--v4-card-bg); padding: 20px; border-radius: 15px;
            width: 90%; max-width: 500px; max-height: 70vh; overflow-y: auto;
            border: 1px solid var(--v4-border-light);
        }
        .modal-content h3 { margin-top: 0; }
        .result-item { padding: 10px; border-bottom: 1px solid var(--v4-border-softer); cursor: pointer; }
        .result-item:hover { background: var(--v4-input-bg); }
        .result-item:last-child { border-bottom: none; }
    </style>
</head>
<body class="radio-page">

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="soundboard-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <div class="user-info">
                <div class="marquee-container"> <span id="userName" class="marquee-content username">Loading…</span> </div>
                <div class="marquee-container"> <span id="userEmail" class="marquee-content email">Loading…</span> </div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">🛡️</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="radio.html" class="active"><span class="icon">📻</span><span class="label">Radio</span></a></li>
                    <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="others.html"><span class="icon">✨</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="content-header-v4">
                <h2 class="content-title-v4">Advanced Web Radio</h2>
            </div>

            <div class="radio-player-container">
                <div class="radio-display">
                    <div id="staticOverlay"></div>
                    <h3 id="stationName" class="station-name">OFF</h3>
                    <p id="stationGenre" class="station-genre">---</p>
                </div>
                
                <div class="search-grid">
                    <label for="stationSearchInput">Search by Name / Genre</label>
                    <label for="freqSearchInput">Search by Frequency</label>
                    
                    <div class="search-input-group">
                        <input type="text" id="stationSearchInput" placeholder="e.g., rock cleveland">
                        <button id="searchNameButton" class="btn-primary">Tune</button>
                    </div>

                    <div class="search-input-group">
                        <input type="text" id="freqSearchInput" placeholder="e.g., 92.5">
                        <button id="searchFreqButton" class="btn-primary">Tune</button>
                    </div>
                </div>

                <hr class="divider">

                <div class="custom-station-controls">
                    <input type="text" id="customStationName" placeholder="Custom Station Name" style="flex-basis: 30%; flex-grow: 1;">
                    <input type="url" id="customStationUrl" placeholder="https://your-stream-url.mp3" style="flex-basis: 60%; flex-grow: 2;">
                    <button id="addCustomStationButton" class="btn-primary">Add & Play</button>
                </div>
                <div class="custom-station-controls">
                     <select id="customStationSelect" style="flex-grow: 1;" title="Your Saved Stations"></select>
                     <button id="removeCustomStationButton" class="btn-secondary">Remove</button>
                </div>
            </div>

            <div id="power-volume-controls" style="text-align:center; margin-top: 20px;">
                <button id="powerButton" class="power-button off">POWER</button>
            </div>

            <div class="settings-tab-container">
                <div class="settings-header">
                     <nav class="settings-tabs">
                         <button class="tab-link active" data-tab="modes">Audio Modes</button>
                         <button class="tab-link" data-tab="equalizer">Equalizer</button>
                     </nav>
                </div>
                <div id="modes" class="tab-content active">
                     <div class="control-group">
                         <label class="checkbox-label-v4">Spatial Audio
                             <input type="checkbox" id="modeSpatial" data-setting="modeSpatial">
                         </label>
                         <div class="spatial-audio-panel">
                            <div id="spatial-pad"><div id="spatial-puck"></div></div>
                            <div id="spatial-coords">X: 0.00, Y: 0.00, Z: 0.00</div>
                         </div>
                     </div>
                </div>
                <div id="equalizer" class="tab-content">
                    <div class="control-group">
                        <label>Bass: <span id="eqBassValue">0 dB</span></label>
                        <input type="range" id="eqBass" min="-40" max="40" step="1" value="0" data-setting="eqBass">
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="searchResultsModal">
        <div class="modal-content">
            <h3 id="modalTitle">Search Results</h3>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
    // --- Standard Setup (Auth, Sidebar, etc.) ---
    firebase.auth().onAuthStateChanged(user => { if (!user) window.location.href = '../login.html'; });
    // --- End Standard Setup ---
    
    // --- Radio Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let radioAudioElement = new Audio();
        radioAudioElement.crossOrigin = "anonymous";
        let radioSourceNode, staticSourceNode;

        const staticAudioBuffer = createStaticBuffer();

        let isPowerOn = false;

        // --- UI Elements ---
        const powerButton = document.getElementById('powerButton');
        const stationNameEl = document.getElementById('stationName');
        const stationGenreEl = document.getElementById('stationGenre');
        const searchInput = document.getElementById('stationSearchInput');
        const searchNameButton = document.getElementById('searchNameButton');
        const freqInput = document.getElementById('freqSearchInput');
        const searchFreqButton = document.getElementById('searchFreqButton');
        const customNameInput = document.getElementById('customStationName');
        const customUrlInput = document.getElementById('customStationUrl');
        const addCustomBtn = document.getElementById('addCustomStationButton');
        const customSelect = document.getElementById('customStationSelect');
        const removeCustomBtn = document.getElementById('removeCustomStationButton');
        const staticOverlay = document.getElementById('staticOverlay');
        const searchResultsModal = document.getElementById('searchResultsModal');
        const modalBody = document.getElementById('modalBody');
        const modalTitle = document.getElementById('modalTitle');
        
        // --- Audio Nodes ---
        const masterGain = audioContext.createGain();
        const staticGain = audioContext.createGain();
        const nodes = {
            mainPanner: new PannerNode(audioContext, { panningModel: 'HRTF', distanceModel: 'inverse' }),
            eqBass: new BiquadFilterNode(audioContext, { type: 'lowshelf', frequency: 100, gain: 0 }),
        };

        // --- Audio Graph Wiring ---
        masterGain.connect(nodes.mainPanner).connect(nodes.eqBass).connect(audioContext.destination);
        staticGain.connect(audioContext.destination);

        // --- Station Logic ---
        function createStaticBuffer() {
            const bufferSize = audioContext.sampleRate * 2; // 2 seconds of static
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }
            return buffer;
        }

        function playStatic() {
            if (staticSourceNode) { staticSourceNode.stop(); }
            staticSourceNode = audioContext.createBufferSource();
            staticSourceNode.buffer = staticAudioBuffer;
            staticSourceNode.loop = true;
            staticSourceNode.connect(staticGain);
            staticSourceNode.start(0);
        }

        function setStaticLevel(strength) { // strength is 0.0 (max static) to 1.0 (no static)
            const staticValue = Math.max(0, 1 - strength);
            staticGain.gain.setTargetAtTime(staticValue * 0.1, audioContext.currentTime, 0.1); // Audio static
            staticOverlay.style.opacity = staticValue * 0.4; // Visual static
        }
        
        function playStream(station) {
            if (!isPowerOn) return;
            stationNameEl.textContent = station.name;
            stationGenreEl.textContent = station.tags || station.genre || 'Stream';
            
            // Normalize signal strength (votes) to a 0-1 scale
            // Using a logarithmic scale makes it feel more natural
            const maxVotes = 500; // An arbitrary reasonable max for normalization
            const signalStrength = Math.min(1, Math.log1p(station.votes || 0) / Math.log1p(maxVotes));
            setStaticLevel(signalStrength);

            radioAudioElement.src = station.url_resolved || station.url;
            radioAudioElement.play().catch(e => {
                stationNameEl.textContent = "Error";
                stationGenreEl.textContent = "Could not play stream.";
                setStaticLevel(0); // Full static on error
            });
        }
        
        async function performSearch(query, searchType) {
            if (!query) return;
            stationNameEl.textContent = "Searching...";
            stationGenreEl.textContent = `for "${query}"`;
            setStaticLevel(0.5); // Static while tuning
            try {
                const searchParams = new URLSearchParams({
                    limit: '200',
                    order: 'clickcount',
                    reverse: 'true'
                });
                if(searchType === 'name') searchParams.set('name', query);
                if(searchType === 'tag') searchParams.set('tag', query);

                const response = await fetch(`https://de1.api.radio-browser.info/json/stations/search?${searchParams.toString()}`);
                const data = await response.json();
                
                const results = data.filter(s => s.url_resolved);

                if (results.length > 0) {
                    showSearchResults(results, query);
                } else {
                    stationNameEl.textContent = "Not Found";
                    stationGenreEl.textContent = `No results for "${query}"`;
                    setStaticLevel(1); // No signal, full static
                }
            } catch (error) {
                console.error("API search error:", error);
                stationNameEl.textContent = "API Error";
                stationGenreEl.textContent = "Could not perform search.";
            }
        }

        function showSearchResults(stations, query) {
            modalTitle.textContent = `Results for "${query}"`;
            modalBody.innerHTML = '';
            stations.forEach(station => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `<strong>${station.name}</strong><br><small>${station.countrycode || ''} - ${station.tags.split(',')[0]}</small>`;
                item.onclick = () => {
                    playStream(station);
                    searchResultsModal.style.display = 'none';
                };
                modalBody.appendChild(item);
            });
            searchResultsModal.style.display = 'block';
        }
        searchResultsModal.onclick = (e) => { if (e.target === searchResultsModal) e.target.style.display = 'none'; };

        // --- Custom Station Logic ---
        function getCustomStations() { return JSON.parse(localStorage.getItem('customRadioStations') || '[]'); }
        function saveCustomStations(stations) { localStorage.setItem('customRadioStations', JSON.stringify(stations)); }
        function populateCustomStations() {
            const stations = getCustomStations();
            customSelect.innerHTML = '<option value="">Play a saved station...</option>';
            stations.forEach((station, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = station.name;
                customSelect.appendChild(option);
            });
        }
        addCustomBtn.addEventListener('click', () => {
            const name = customNameInput.value.trim();
            const url = customUrlInput.value.trim();
            if (!name || !url) return alert('Please enter both a name and a URL.');
            const newStation = { name, url, votes: 10000 }; // Assume custom stations have max signal
            const stations = getCustomStations();
            stations.push(newStation);
            saveCustomStations(stations);
            populateCustomStations();
            customNameInput.value = ''; customUrlInput.value = '';
            customSelect.value = stations.length - 1;
            if (isPowerOn) playStream(newStation);
        });
        removeCustomBtn.addEventListener('click', () => {
            const selectedIndex = customSelect.value;
            if (selectedIndex === "") return;
            let stations = getCustomStations();
            stations.splice(selectedIndex, 1);
            saveCustomStations(stations);
            populateCustomStations();
        });
        customSelect.addEventListener('change', () => {
            const selectedIndex = customSelect.value;
            if (selectedIndex === "") return;
            const stations = getCustomStations();
            const station = stations[selectedIndex];
            if (station && isPowerOn) playStream(station);
        });

        // --- Event Listeners ---
        powerButton.addEventListener('click', () => {
            isPowerOn = !isPowerOn;
            powerButton.classList.toggle('on', isPowerOn);
            powerButton.classList.toggle('off', !isPowerOn);
            if (isPowerOn) {
                if (audioContext.state === 'suspended') audioContext.resume();
                if (!radioSourceNode) {
                    radioSourceNode = audioContext.createMediaElementSource(radioAudioElement);
                    radioSourceNode.connect(masterGain);
                }
                playStatic();
                stationGenreEl.textContent = "Ready to tune.";
                stationNameEl.textContent = "Radio ON";
                setStaticLevel(1);
            } else {
                radioAudioElement.pause();
                radioAudioElement.src = '';
                if(staticSourceNode) staticSourceNode.stop();
                stationNameEl.textContent = 'OFF';
                stationGenreEl.textContent = '---';
            }
        });
        searchNameButton.addEventListener('click', () => performSearch(searchInput.value, 'name'));
        searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') performSearch(searchInput.value, 'name'); });
        searchFreqButton.addEventListener('click', () => performSearch(freqInput.value, 'name'));
        freqInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') performSearch(freqInput.value, 'name'); });

        // Settings Logic
        document.querySelectorAll('[data-setting]').forEach(setting => {
            setting.addEventListener(setting.type === 'checkbox' ? 'change' : 'input', (e) => {
                const { id, value, checked } = e.target;
                const timeConstant = 0.02;
                switch (id) {
                    case 'eqBass': nodes.eqBass.gain.setTargetAtTime(parseFloat(value), audioContext.currentTime, timeConstant); document.getElementById('eqBassValue').textContent = `${value} dB`; break;
                    case 'modeSpatial': nodes.mainPanner.panningModel = checked ? 'HRTF' : 'equalpower'; break;
                }
            });
        });
        document.querySelector('.settings-tabs').addEventListener('click', e => { if (e.target.matches('.tab-link')) { document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active')); e.target.classList.add('active'); document.getElementById(e.target.dataset.tab).classList.add('active'); } });

        // Spatial Pad Logic
        const spatialPad = document.getElementById('spatial-pad');
        const spatialPuck = document.getElementById('spatial-puck');
        const spatialCoords = document.getElementById('spatial-coords');
        let isPuckDragging = false;
        let pannerZ = 0;
        function updatePannerPosition(x, y, z) { const scale = 10; const timeConstant = 0.015; nodes.mainPanner.positionX.setTargetAtTime(x * scale, audioContext.currentTime, timeConstant); nodes.mainPanner.positionY.setTargetAtTime(y * scale, audioContext.currentTime, timeConstant); nodes.mainPanner.positionZ.setTargetAtTime(z * scale, audioContext.currentTime, timeConstant); spatialCoords.textContent = `X: ${x.toFixed(2)}, Y: ${y.toFixed(2)}, Z: ${z.toFixed(2)}`; }
        function movePuck(e) { const rect = spatialPad.getBoundingClientRect(); const radius = rect.width / 2; let x = e.clientX - rect.left - radius; let y = e.clientY - rect.top - radius; let dist = Math.sqrt(x*x + y*y); if (dist > radius) { x = (x/dist) * radius; y = (y/dist) * radius; } spatialPuck.style.left = `${x + radius}px`; spatialPuck.style.top = `${y + radius}px`; updatePannerPosition(x / radius, -y / radius, pannerZ); }
        spatialPad.addEventListener('mousedown', (e) => { if(!document.getElementById('modeSpatial').checked) return; isPuckDragging = true; movePuck(e); });
        document.addEventListener('mousemove', (e) => { if(isPuckDragging) movePuck(e); });
        document.addEventListener('mouseup', () => { isPuckDragging = false; });
        spatialPad.addEventListener('wheel', e => { if(!document.getElementById('modeSpatial').checked) return; e.preventDefault(); pannerZ += e.deltaY * -0.01; pannerZ = Math.max(-1, Math.min(1, pannerZ)); const rect = spatialPad.getBoundingClientRect(); const radius = rect.width / 2; const currentX = (parseFloat(spatialPuck.style.left || `${radius}px`) - radius) / radius; const currentY = -(parseFloat(spatialPuck.style.top || `${radius}px`) - radius) / radius; updatePannerPosition(currentX, currentY, pannerZ); });

        populateCustomStations();
    });
    </script>
</body>
</html>
