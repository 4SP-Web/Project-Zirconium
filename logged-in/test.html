<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - VERN SOCIAL</title>
    <!-- External Stylesheet -->
    <link rel="stylesheet" href="../css/style.css">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- CryptoJS for Encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* --- Root Variables & Base Styles --- */
        :root {
            --font-primary: 'PrimaryFont', 'Segoe UI', 'Roboto', sans-serif;
            --font-secondary: 'SecondaryFont', 'serif';
            --color-accent: #6720bd;
            --color-accent-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --color-danger: #dc3545;
            --color-success: #28a745;
            --color-warning: #ffc107;
            --color-info: #0dcaf0;
            --color-online: #28a745;
            --color-offline: #6c757d;
            --color-gaming: #fd7e14;
            --color-working: #0d6efd;
            --color-sleeping: #343a40;
            --light-bg: #f0f2f5;
        }

        html, body {
            height: 100%; margin: 0; font-family: var(--font-primary);
            background-color: var(--light-bg); overflow: hidden;
        }

        * { box-sizing: border-box; }

        /* --- Main Layout --- */
        body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; }
        .dashboard-container { display: flex; flex: 1; min-height: 0; }
        .hidden { display: none !important; }

        /* --- Main Header --- */
        .main-header {
            flex-shrink: 0;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 0 20px;
        }
        .main-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }
        .main-header .logo img { max-height: 40px; }
        .main-header .auth-buttons { display: flex; gap: 10px; }
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-family: var(--font-primary);
        }
        .btn-primary { background: var(--color-accent-gradient); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(103, 32, 189, 0.3); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-login { background: transparent; color: #333; font-weight: bold; }

        /* --- Sidebar --- */
        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff;
            display: flex; flex-direction: column;
            border-right: 1px solid #444;
            transition: width 0.3s ease-in-out;
            position: relative;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
            padding: 10px;
        }
        .sidebar.collapsed { width: 80px; }
        #toggleSidebar {
            position: absolute; top: 15px; right: -15px;
            width: 30px; height: 30px;
            background: #2a2a2a; border: 1px solid #444;
            color: #fff; font-size: 1.2em; cursor: pointer;
            border-radius: 50%; z-index: 10;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s ease, right 0.3s ease;
        }
        .sidebar.collapsed #toggleSidebar { transform: rotate(180deg); }

        .sidebar.collapsed .sidebar-section h2 .label,
        .sidebar.collapsed .item-info .item-name,
        .sidebar.collapsed .user-profile-area .user-details,
        .sidebar.collapsed .sidebar-settings-menu .label { display: none; }
        .sidebar.collapsed .user-profile-area { justify-content: center; padding: 15px 5px; }
        .sidebar.collapsed .item-list li { justify-content: center; }
        .sidebar.collapsed .item-info .icon { margin-right: 0; }
        .sidebar.collapsed .sidebar-section h2 .action-btn { margin-right: 0; }
        .sidebar.collapsed .sidebar-settings-menu a { justify-content: center; }

        /* Sidebar Content */
        .user-profile-area {
            padding: 10px 5px; text-align: center;
            border-bottom: 1px solid #444; flex-shrink: 0;
            display: flex; align-items: center; gap: 15px; margin-bottom: 10px;
        }
        .status-indicator {
            width: 12px; height: 12px; border-radius: 50%;
            border: 2px solid #fff; flex-shrink: 0;
            transition: background-color 0.3s;
        }
        .status-indicator.online { background-color: var(--color-online); }
        .status-indicator.offline { background-color: var(--color-offline); }
        .status-indicator.gaming { background-color: var(--color-gaming); }
        .status-indicator.working { background-color: var(--color-working); }
        .status-indicator.sleeping { background-color: var(--color-sleeping); }

        .user-details { text-align: left; overflow: hidden; }
        .user-details .username { font-family: var(--font-secondary); font-size: 1.1em; font-weight: 600; margin: 0; white-space: nowrap; }
        .user-details .email { font-size: 0.8em; color: #bbb; margin: 2px 0 0; white-space: nowrap; }

        .social-sidebar-content { flex-grow: 1; overflow-y: auto; overflow-x: hidden; }
        .sidebar-section { padding: 15px 5px; border-bottom: 1px solid #444; }
        .sidebar-section:last-of-type { border-bottom: none; }
        .sidebar-section h2 {
            font-size: 0.9em; text-transform: uppercase; color: #aaa;
            margin: 0 0 15px 5px; font-weight: 600;
            display: flex; justify-content: space-between; align-items: center; gap: 5px;
        }
        .sidebar-section h2 .action-btn {
            background: none; border: none; color: #aaa; font-size: 1.1em; cursor: pointer;
            padding: 5px; border-radius: 5px; transition: color 0.2s, background-color 0.2s;
        }
        .sidebar-section h2 .action-btn:hover { color: #fff; background-color: rgba(255,255,255,0.1); }
        .sidebar-section input[type="text"] {
            width: 100%; background: #3A3A3A; border: 1px solid #555;
            color: #E4E6EB; padding: 10px; border-radius: 8px;
            box-sizing: border-box; font-family: var(--font-primary); transition: border-color 0.2s;
        }
        .sidebar-section input[type="text"]:focus { border-color: var(--color-accent); outline: none; }

        .item-list { list-style: none; padding: 0; margin: 0; }
        .item-list li {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 8px; border-radius: 8px;
            transition: all 0.2s ease; cursor: pointer;
        }
        .item-list li:hover:not(.empty-state), .item-list li.active-chat {
            background: var(--color-accent-gradient);
            transform: translateX(5px);
        }
        .item-list .item-info {
            display: flex; align-items: center; gap: 12px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .item-info .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .item-info .item-name { font-weight: 500; font-family: var(--font-secondary); }
        .item-list .empty-state { color: #888; font-style: italic; padding: 10px 5px; cursor: default; }

        .item-actions button {
            background: none; border: none; color: #ccc; cursor: pointer;
            font-size: 1em; padding: 8px; border-radius: 50%; transition: all 0.2s;
        }
        .item-actions button:hover { color: #fff; background-color: rgba(255,255,255,0.2); transform: scale(1.1); }
        .item-actions .accept-btn:hover { color: var(--color-success); }
        .item-actions .decline-btn:hover { color: var(--color-danger); }
        .item-actions .unblock-btn:hover { color: var(--color-warning); }
        .item-list .pin-chat-btn { opacity: 0; transition: opacity 0.2s; }
        .item-list li:hover .pin-chat-btn { opacity: 1; }
        .item-list li.pinned-chat { order: -1; background: rgba(103, 32, 189, 0.3); }


        .sidebar-settings-menu { padding: 15px 0; border-top: 1px solid #444; flex-shrink: 0; }
        .sidebar-settings-menu ul { list-style: none; padding: 0; margin: 0; }
        .sidebar-settings-menu li a {
            display: flex; align-items: center; gap: 15px; padding: 12px 15px;
            border-radius: 8px; text-decoration: none; color: #ccc;
            font-weight: 500; transition: all 0.2s ease;
        }
        .sidebar-settings-menu li a:hover {
            background: var(--color-accent-gradient); color: #fff; transform: translateX(5px);
        }
        .sidebar-settings-menu li a i { width: 24px; text-align: center; font-size: 1.2em; }

        /* --- Main Content & Chat Area --- */
        .main-content {
            flex: 1; padding: 25px;
            background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            overflow-y: hidden;
            display: flex; flex-direction: column;
        }
        .chat-area-wrapper {
            flex-grow: 1;
            display: flex; flex-direction: column;
            background: white; border-radius: 20px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.08);
            border: 1px solid rgba(103, 32, 189, 0.1);
            overflow: hidden;
            position: relative; /* Positioning context for the chat footer */
        }

        .chat-placeholder {
            flex-grow: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center; color: #999; padding: 20px;
        }
        .chat-placeholder i { font-size: 6em; margin-bottom: 20px; color: #d0d5db; }
        .chat-placeholder h2 { font-family: var(--font-secondary); font-size: 2em; color: #555; }

        .chat-wrapper { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        
        /* Chat Header */
        .chat-header {
            padding: 15px 20px; border-bottom: 1px solid #ddd;
            font-family: var(--font-secondary);
            font-size: 1.3em; font-weight: bold; color: #1C1E21;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0; background: rgba(248,249,250, 0.8);
             backdrop-filter: blur(5px);
        }
        .chat-header .chat-info { text-align: left; flex-grow: 1; }
        .chat-header .chat-actions button {
            background: none; border: none; font-size: 1.2em; color: #666;
            cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s;
        }
        .chat-header .chat-actions button:hover { background-color: #e0e0e0; }

        /* Messages */
        .messages-container {
            background-color: #e5ddd5;
            background-size: cover; 
            background-position: center;
            background-repeat: no-repeat;
            flex-grow: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 5px;
            transition: background-image 0.5s ease;
            padding-bottom: 120px; /* Space for the floating footer */
        }
        /* Wallpaper Styles */
        .messages-container.wp-default { background-image: url('https://i.imgur.com/pD2iB3k.png'); background-size: initial; }
        .messages-container.wp-red { background-image: url('../vs-wallpapers/red.jpg'); }
        .messages-container.wp-orange { background-image: url('../vs-wallpapers/orange.jpg'); }
        .messages-container.wp-yellow { background-image: url('../vs-wallpapers/yellow.jpg'); }
        .messages-container.wp-green { background-image: url('../vs-wallpapers/green.jpg'); }
        .messages-container.wp-blue { background-image: url('../vs-wallpapers/blue.jpg'); }
        .messages-container.wp-purple { background-image: url('../vs-wallpapers/purple.jpg'); }
        .messages-container.wp-galaxy { background-image: url('../vs-wallpapers/galaxy.jpg'); }
        .messages-container.wp-stars { background-image: url('../vs-wallpapers/stars.jpg'); }
        .messages-container.wp-abyss { background-image: url('../vs-wallpapers/abyss.jpg'); }
        
        /* Message Bubbles */
        .message-wrapper { 
            display: flex; 
            flex-direction: column; 
            max-width: 65%; 
            position: relative; 
            margin-bottom: 5px;
            transition: transform 0.2s ease;
        }
        .message-wrapper:hover .pin-message-btn { opacity: 1; }
        .message-wrapper.sent { align-self: flex-end; align-items: flex-end; }
        .message-wrapper.received { align-self: flex-start; align-items: flex-start; }

        .message-content {
            padding: 10px 15px; border-radius: 18px; line-height: 1.5;
            word-break: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            position: relative;
        }
        .message-wrapper.sent .message-content { background: var(--color-accent-gradient); color: white; border-top-right-radius: 4px; }
        .message-wrapper.received .message-content { background: #fff; color: #333; border-top-left-radius: 4px; }
        .message-wrapper .sender-name { font-weight: bold; color: var(--color-accent); display: block; margin-bottom: 5px; font-size: 0.9em; font-family: var(--font-secondary);}
        
        .message-meta { display: flex; align-items: center; gap: 8px; font-size: 0.75em; padding: 4px 8px; color: #f0f0f0; text-shadow: 0 1px 2px rgba(0,0,0,0.5);}
        .message-wrapper.sent .message-meta { justify-content: flex-end; }
        .message-meta .edited-tag { font-style: italic; }
        .message-meta .status-icon { font-size: 1.1em; }
        .message-meta .status-icon .fa-check { color: #f0f0f0; } /* Sent */
        .message-meta .status-icon .fa-check-double { color: #f0f0f0; } /* Delivered */
        .message-meta .status-icon .fa-check-double.read { color: #4fc3f7; } /* Read */
        .message-wrapper.pinned .message-content {
            border: 2px solid var(--color-warning);
            box-shadow: 0 2px 10px rgba(255, 193, 7, 0.5);
        }
        .pin-message-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.5); color: white;
            border: none; border-radius: 50%; width: 28px; height: 28px;
            cursor: pointer; opacity: 0; transition: opacity 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .message-wrapper.sent .pin-message-btn { left: -35px; }
        .message-wrapper.received .pin-message-btn { right: -35px; }
        .pin-message-btn.pinned { color: var(--color-warning); }


        /* Chat Footer - NEW FLOATING STYLE */
        .chat-footer {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 800px;
            z-index: 10;
        }
        #messageFormInner {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px) saturate(1.8);
            -webkit-backdrop-filter: blur(20px) saturate(1.8);
            border-radius: 28px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
        }

        #messageInput {
            flex-grow: 1;
            background: transparent;
            border: none;
            padding: 12px 15px;
            font-size: 1em;
            resize: none;
            color: #111;
            font-family: var(--font-primary);
            font-weight: 500;
            max-height: 120px; /* Limit height */
            overflow-y: auto;
        }

        #messageInput::placeholder {
            color: rgba(0, 0, 0, 0.6);
            font-weight: 400;
        }

        #messageInput:focus { outline: none; box-shadow: none; }
        
        #sendMessageBtn {
            background: var(--color-accent);
            color: white; border: none; border-radius: 50%;
            width: 48px; height: 48px; font-size: 1.3em; cursor: pointer; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #sendMessageBtn:hover { transform: scale(1.1); box-shadow: 0 4px 15px rgba(103, 32, 189, 0.4); }
        #sendMessageBtn:disabled { background: #aaa; cursor: not-allowed; transform: none; box-shadow: none; }
        
        #charCounter { display: none; }

        /* --- Modals --- */
        .modal-overlay {
            display: flex; align-items: center; justify-content: center;
            position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            visibility: hidden; opacity: 0;
            transition: opacity 0.25s ease-out, visibility 0s linear 0.25s;
        }
        .modal-overlay.visible {
            visibility: visible; opacity: 1;
            transition: opacity 0.25s ease-out, visibility 0s linear 0s;
        }
        .modal {
            background-color: #fefefe; padding: 30px; border: 1px solid #bbb;
            width: 90%; max-width: 600px; border-radius: 18px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.25); position: relative;
            color: #333; transform: scale(0.9);
            transition: transform 0.3s ease-out;
            display: flex; flex-direction: column; gap: 15px;
        }
        .modal-overlay.visible .modal { transform: scale(1); }
        .modal-header { padding: 0 0 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 {
            margin: 0; font-size: 1.8em;
            font-family: var(--font-secondary);
            font-weight: bold; color: var(--color-accent);
        }
        .modal-close-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #888; padding: 5px; }
        .modal-body { padding: 15px 5px; max-height: 65vh; overflow-y: auto; }
        .modal-footer {
            padding: 15px 0 0; border-top: 1px solid #eee;
            text-align: right; display: flex; justify-content: flex-end; gap: 10px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px;
            font-size: 1em; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.2);
        }
        #wallpaper-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .wallpaper-option { cursor: pointer; border-radius: 8px; overflow: hidden; border: 3px solid transparent; transition: border-color 0.2s; }
        .wallpaper-option:hover { border-color: var(--color-accent); }
        .wallpaper-option.selected { border-color: var(--color-success); }
        .wallpaper-option img { width: 100%; height: auto; display: block; aspect-ratio: 16 / 9; object-fit: cover; }
        
        /* Styles for Create Group Modal */
        #createGroupFriendsList label { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; cursor: pointer; }
        #createGroupFriendsList label:hover { background-color: #f0f0f0; }
        
        /* Animations & Banners */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .notification-banner {
            position: fixed; top: 80px; left: 50%;
            transform: translateX(-50%) translateY(-150%);
            padding: 12px 25px; border-radius: 8px; color: #fff;
            font-size: 1em; font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 9999;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; align-items: center; gap: 10px;
        }
        .notification-banner.show { transform: translateX(-50%) translateY(0); }
        .notification-banner.success { background: var(--color-success); }
        .notification-banner.danger { background: var(--color-danger); }
        .notification-banner.warning { background: var(--color-warning); color: #333; }
        .notification-banner.info { background: var(--color-accent-gradient); }

    </style>
</head>
<body class="dashboard-page">

    <header class="main-header">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" onerror="this.style.display='none'"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='dashboard.html'">DASHBOARD</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container" id="dashboardContainer">
        <aside class="sidebar" id="sidebar">
            <button id="toggleSidebar"><i class="fas fa-chevron-left"></i></button>
            <div class="user-profile-area">
                <div id="currentUserStatus" class="status-indicator offline"></div>
                <div class="user-details">
                    <p class="username" id="userName">Loading...</p>
                    <p class="email" id="userEmail">...</p>
                </div>
            </div>
            <div class="social-sidebar-content">
                <div class="sidebar-section">
                    <h2><i class="fas fa-search"></i> <span class="label">Find Users</span></h2>
                    <input type="text" id="userSearchInput" placeholder="Search by exact username...">
                    <ul id="userSearchResults" class="item-list"></ul>
                </div>
                <div class="sidebar-section">
                    <h2><i class="fas fa-user-plus"></i> <span class="label">Requests</span></h2>
                    <ul id="friendRequestsList" class="item-list"></ul>
                </div>
                <div class="sidebar-section">
                    <h2><i class="fas fa-users-cog"></i> <span class="label">Groups</span> <button id="createGroupBtn" class="action-btn" title="Create Group"><i class="fas fa-plus"></i></button></h2>
                    <ul id="groupChatsList" class="item-list"><li class="empty-state">No groups yet.</li></ul>
                </div>
                <div class="sidebar-section">
                    <h2><i class="fas fa-users"></i> <span class="label">Friends</span></h2>
                    <ul id="friendsList" class="item-list"></ul>
                </div>
                <div class="sidebar-section">
                    <h2><i class="fas fa-user-slash"></i> <span class="label">Blocked</span></h2>
                    <ul id="blockedUsersList" class="item-list"></ul>
                </div>
            </div>
            <div class="sidebar-settings-menu">
                <ul>
                    <li><a href="#" id="manageSettingsBtn"><i class="fas fa-cog"></i> <span class="label">Settings</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content fade-in">
             <div class="chat-area-wrapper">
                <div class="chat-placeholder" id="chatPlaceholder">
                    <i class="fas fa-comments"></i>
                    <h2>Welcome to Vern Social</h2>
                    <p>Select a friend or group to start chatting.</p>
                </div>
                <div class="chat-wrapper hidden" id="chatWrapper">
                    <div class="chat-header">
                        <div class="chat-info" id="chatHeaderInfo">Select a Chat</div>
                        <div class="chat-actions">
                            <button id="pinListBtn" title="Pinned Messages"><i class="fas fa-thumbtack"></i></button>
                            <button id="chatSettingsBtn" title="Chat Settings"><i class="fas fa-ellipsis-v"></i></button>
                        </div>
                    </div>
                    <div class="messages-container wp-default" id="messagesContainer"></div>
                    <div class="chat-footer">
                        <form id="messageForm">
                            <div id="messageFormInner">
                                <textarea id="messageInput" placeholder="Type a message..." rows="1" maxlength="2000" disabled></textarea>
                                <button type="submit" id="sendMessageBtn" disabled><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="pinnedMessagesModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-thumbtack"></i> Pinned Messages</h3>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body" id="pinnedMessagesList">
                <p>No messages have been pinned in this chat yet.</p>
            </div>
        </div>
    </div>

    <div id="chatSettingsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> Chat Settings</h3>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="nicknameSection">
                    <h4>Nicknames</h4>
                    <div id="nicknameInputsContainer"></div>
                </div>
                <hr style="margin: 20px 0;">
                <h4>Chat Wallpaper</h4>
                <div id="wallpaper-selector"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-close-btn">Close</button>
                <button id="saveChatSettingsBtn" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="createGroupModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-users-cog"></i> Create New Group</h3>
                <button class="modal-close-btn">&times;</button>
            </div>
            <form id="createGroupForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="groupNameInput">Group Name</label>
                        <input type="text" id="groupNameInput" required maxlength="50" placeholder="My Awesome Group">
                    </div>
                    <div class="form-group">
                        <label>Select Members</label>
                        <div id="createGroupFriendsList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 5px;">
                            <p>No friends to add.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Group</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
    // =================================================================================
    // --- DOM ELEMENT REFERENCES ---
    // =================================================================================
    const logoutBtn = document.getElementById('logoutBtn');
    const sidebar = document.getElementById('sidebar');
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    const userNameEl = document.getElementById('userName');
    const userEmailEl = document.getElementById('userEmail');
    const currentUserStatusEl = document.getElementById('currentUserStatus');
    const userSearchInput = document.getElementById('userSearchInput');
    const userSearchResultsEl = document.getElementById('userSearchResults');
    const friendRequestsListEl = document.getElementById('friendRequestsList');
    const groupChatsListEl = document.getElementById('groupChatsList');
    const friendsListEl = document.getElementById('friendsList');
    const blockedUsersListEl = document.getElementById('blockedUsersList');
    const createGroupBtn = document.getElementById('createGroupBtn');
    const manageSettingsBtn = document.getElementById('manageSettingsBtn');
    const chatPlaceholder = document.getElementById('chatPlaceholder');
    const chatWrapper = document.getElementById('chatWrapper');
    const chatHeaderInfoEl = document.getElementById('chatHeaderInfo');
    const pinListBtn = document.getElementById('pinListBtn');
    const chatSettingsBtn = document.getElementById('chatSettingsBtn');
    const messagesContainer = document.getElementById('messagesContainer');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    
    // Modal Elements
    const pinnedMessagesModal = document.getElementById('pinnedMessagesModal');
    const pinnedMessagesList = document.getElementById('pinnedMessagesList');
    const chatSettingsModal = document.getElementById('chatSettingsModal');
    const nicknameInputsContainer = document.getElementById('nicknameInputsContainer');
    const wallpaperSelector = document.getElementById('wallpaper-selector');
    const saveChatSettingsBtn = document.getElementById('saveChatSettingsBtn');
    const createGroupModal = document.getElementById('createGroupModal');
    const createGroupForm = document.getElementById('createGroupForm');
    const groupNameInput = document.getElementById('groupNameInput');
    const createGroupFriendsList = document.getElementById('createGroupFriendsList');

    // --- GLOBAL STATE ---
    let currentUser, currentUserProfile;
    let userCache = {};
    let unsubscribes = [];
    let activeChat = { id: null, type: null, name: '', partnerId: null, members: [], settings: {} };
    
    // =================================================================================
    // --- UTILITY FUNCTIONS ---
    // =================================================================================
    function showNotification(message, type = 'info', duration = 3000) {
        const existingNotification = document.querySelector('.notification-banner');
        if(existingNotification) existingNotification.remove();

        const notification = document.createElement('div');
        notification.className = `notification-banner ${type}`;
        
        let iconClass = 'fas fa-info-circle';
        if (type === 'success') iconClass = 'fas fa-check-circle';
        if (type === 'danger') iconClass = 'fas fa-exclamation-circle';
        if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
        
        notification.innerHTML = `<i class="${iconClass}"></i><span>${message}</span>`;
        document.body.appendChild(notification);
        
        setTimeout(() => { notification.classList.add('show'); }, 100);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => { if (document.body.contains(notification)) document.body.removeChild(notification); }, 500);
        }, duration);
    }

    function setupModal(modalElement) {
        const closeButtons = modalElement.querySelectorAll('.modal-close-btn');
        closeButtons.forEach(btn => btn.addEventListener('click', () => modalElement.classList.remove('visible')));
        modalElement.addEventListener('click', (e) => {
            if (e.target === modalElement) {
                modalElement.classList.remove('visible');
            }
        });
    }

    function getChatSecret(chatId, type, partnerId) {
        if (type === 'group') return chatId;
        if (!currentUser || !partnerId) return 'default_secret';
        return CryptoJS.SHA256([currentUser.uid, partnerId].sort().join("_4spSecretKey")).toString();
    }

    function encryptMessage(plainText, key) { return CryptoJS.AES.encrypt(plainText, key).toString(); }
    function decryptMessage(cipherText, key) {
        try {
            const bytes = CryptoJS.AES.decrypt(cipherText, key);
            return bytes.toString(CryptoJS.enc.Utf8) || '[Empty message]';
        } catch (e) { return '[Error decrypting]'; }
    }
    
    // =================================================================================
    // --- FIREBASE & AUTHENTICATION ---
    // =================================================================================
    firebase.auth().onAuthStateChanged(async user => {
        if (user) {
            currentUser = user;
            const userDocRef = firebase.firestore().collection('users').doc(currentUser.uid);
            await userDocRef.update({ 'status.current': 'online', 'status.lastChanged': firebase.firestore.FieldValue.serverTimestamp() }).catch(() => {});
            
            window.addEventListener('beforeunload', () => {
                if (currentUser) {
                    userDocRef.update({ 'status.current': 'offline', 'status.lastChanged': firebase.firestore.FieldValue.serverTimestamp() });
                }
            });

            await setupUserProfile(userDocRef);
            setupListeners();
            initializeUI();
        } else {
            window.location.href = '../login.html';
        }
    });

    async function setupUserProfile(userDocRef) {
        const userDoc = await userDocRef.get();
        if (!userDoc.exists) {
            // Create user profile matching the security rules
            const newUserProfile = {
                username: currentUser.displayName || `user_${currentUser.uid.substring(0, 6)}`,
                email: currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                friends: [],
                blocked: [],
                nicknames: {},
                pinnedChats: [],
                status: { current: 'online', lastChanged: firebase.firestore.FieldValue.serverTimestamp() }
            };
            await userDocRef.set(newUserProfile);
        }
    }
    
    // =================================================================================
    // --- UI INITIALIZATION & EVENT LISTENERS ---
    // =================================================================================
    function initializeUI() {
        toggleSidebarBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            const icon = toggleSidebarBtn.querySelector('i');
            icon.classList.toggle('fa-chevron-left');
            icon.classList.toggle('fa-chevron-right');
        });
        
        setupModal(pinnedMessagesModal);
        setupModal(chatSettingsModal);
        setupModal(createGroupModal);

        pinListBtn.addEventListener('click', showPinnedMessages);
        chatSettingsBtn.addEventListener('click', showChatSettings);
        saveChatSettingsBtn.addEventListener('click', handleSaveChatSettings);
        createGroupBtn.addEventListener('click', showCreateGroupModal);
        createGroupForm.addEventListener('submit', handleCreateGroup);

        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = (messageInput.scrollHeight) + 'px';
        });

        messageForm.addEventListener('submit', handleSendMessage);
        userSearchInput.addEventListener('input', handleUserSearch);
        
        document.querySelector('.social-sidebar-content').addEventListener('click', handleSidebarClick);
        messagesContainer.addEventListener('click', handleMessagesContainerClick);
    }

    function setupListeners() {
        // Clear all previous listeners
        unsubscribes.forEach(unsub => unsub());
        unsubscribes = [];

        // User profile listener
        const userDocUnsub = firebase.firestore().collection('users').doc(currentUser.uid).onSnapshot(doc => {
            currentUserProfile = { id: doc.id, ...doc.data() };
            userCache[currentUser.uid] = { ...currentUserProfile };
            userNameEl.textContent = getDisplayName(currentUser.uid, true);
            userEmailEl.textContent = currentUserProfile.email;
            updateUserStatusIndicator(currentUserStatusEl, currentUserProfile.status?.current);
            renderFriendsList();
            renderGroupChatsList();
            // renderBlockedList();
        });
        unsubscribes.push(userDocUnsub);

        // Group chats listener
        const groupsUnsub = firebase.firestore().collection('groups').where('members', 'array-contains', currentUser.uid)
            .onSnapshot(snapshot => {
                const groups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGroupChatsList(groups);
            });
        unsubscribes.push(groupsUnsub);
    }

    // =================================================================================
    // --- EVENT HANDLERS ---
    // =================================================================================
    async function handleSendMessage(e) {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (!text || !activeChat.id) return;
        
        const secretKey = getChatSecret(activeChat.id, activeChat.type, activeChat.partnerId);
        const collectionPath = activeChat.type === 'group' ? `groups/${activeChat.id}/messages` : `chats/${activeChat.id}/messages`;
        
        const messageData = {
            text: encryptMessage(text, secretKey),
            authorId: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            pinned: false,
        };

        const tempMessageInput = messageInput.value;
        messageInput.value = '';
        messageInput.style.height = 'auto';
       
        try {
            await firebase.firestore().collection(collectionPath).add(messageData);
        } catch (error) {
            console.error("Error sending message:", error);
            showNotification("Failed to send message.", "danger");
            messageInput.value = tempMessageInput;
        }
    }

    function handleSidebarClick(e) {
        const pinBtn = e.target.closest('.pin-chat-btn');
        if (pinBtn) {
            e.stopPropagation();
            const chatId = pinBtn.dataset.chatId;
            togglePinChat(chatId);
            return;
        }

        const li = e.target.closest('li[data-chat-id]');
        if (li && li.parentElement.id !== 'userSearchResults') {
            const chatConfig = {
                id: li.dataset.chatId,
                type: li.dataset.chatType,
                name: li.dataset.chatName,
                partnerId: li.dataset.partnerId || null,
                members: (li.dataset.members || '').split(',').filter(Boolean)
            };
            openChat(chatConfig);
        }
    }

    function handleMessagesContainerClick(e) {
        const pinBtn = e.target.closest('.pin-message-btn');
        if (pinBtn) {
            const messageId = pinBtn.dataset.messageId;
            togglePinMessage(messageId);
        }
    }
    
    // =================================================================================
    // --- CHAT & MESSAGE LOGIC ---
    // =================================================================================
    
    function openChat(chatConfig) {
        // Clear previous message listener if it exists
        const oldMsgUnsub = unsubscribes.find(u => u.type === 'messages');
        if (oldMsgUnsub) {
            oldMsgUnsub();
            unsubscribes = unsubscribes.filter(u => u.type !== 'messages');
        }
        
        activeChat = chatConfig;
        
        chatWrapper.classList.remove('hidden');
        chatPlaceholder.classList.add('hidden');
        messageInput.disabled = false;
        sendMessageBtn.disabled = false;
        
        updateChatHeader();
        document.querySelectorAll('.item-list li').forEach(li => li.classList.remove('active-chat'));
        const activeLi = document.querySelector(`[data-chat-id="${activeChat.id}"]`);
        if (activeLi) activeLi.classList.add('active-chat');

        const chatDocRef = activeChat.type === 'group' 
            ? firebase.firestore().collection('groups').doc(activeChat.id)
            : firebase.firestore().collection('chats').doc(activeChat.id);

        chatDocRef.get().then(doc => {
            activeChat.settings = doc.exists ? doc.data().settings || {} : {};
            applyChatSettings();
            updateChatHeader();
        });

        messagesContainer.innerHTML = ''; 

        const collectionPath = activeChat.type === 'group' ? `groups/${activeChat.id}/messages` : `chats/${activeChat.id}/messages`;
        const messagesRef = firebase.firestore().collection(collectionPath).orderBy('createdAt').limitToLast(50);
        
        const messagesUnsub = messagesRef.onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === "added") {
                    renderMessage(change.doc.id, change.doc.data());
                } else if (change.type === "modified") {
                    updateMessage(change.doc.id, change.doc.data());
                }
            });
            setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 100);
        }, error => console.error("Error fetching messages:", error));
        
        messagesUnsub.type = 'messages';
        unsubscribes.push(messagesUnsub);
    }
    
    async function renderMessage(docId, data) {
        const wrapper = document.createElement('div');
        wrapper.className = `message-wrapper ${data.authorId === currentUser.uid ? 'sent' : 'received'}`;
        wrapper.dataset.messageId = docId;
        if(data.pinned) wrapper.classList.add('pinned');

        await fetchUsers([data.authorId]);
        const senderName = getDisplayName(data.authorId);
        const secretKey = getChatSecret(activeChat.id, activeChat.type, activeChat.partnerId);
        const decryptedText = decryptMessage(data.text, secretKey);
        
        const pinIconClass = data.pinned ? 'fas fa-thumbtack pinned' : 'fas fa-thumbtack';
        const pinButton = `<button class="pin-message-btn" data-message-id="${docId}"><i class="${pinIconClass}"></i></button>`;

        const messageContentHTML = `
            <div class="message-content">
                ${activeChat.type === 'group' && data.authorId !== currentUser.uid ? `<strong class="sender-name">${senderName}</strong>` : ''}
                <span class="message-text">${decryptedText.replace(/\n/g, '<br>')}</span>
            </div>`;
        
        const readableTime = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : '';
        const metaHTML = `<div class="message-meta"><span>${readableTime}</span></div>`;
        
        wrapper.innerHTML = pinButton + messageContentHTML + metaHTML;
        
        messagesContainer.appendChild(wrapper);
        wrapper.classList.add('fade-in');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function updateMessage(docId, data) {
        const messageEl = document.querySelector(`.message-wrapper[data-message-id="${docId}"]`);
        if (!messageEl) return;
        
        if (data.pinned) {
            messageEl.classList.add('pinned');
            messageEl.querySelector('.pin-message-btn i').classList.add('pinned');
        } else {
            messageEl.classList.remove('pinned');
            messageEl.querySelector('.pin-message-btn i').classList.remove('pinned');
        }
    }
    
    function getDisplayName(userId, isSelf = false) {
        if (!isSelf && activeChat.settings?.nicknames?.[userId]) {
            return activeChat.settings.nicknames[userId];
        }
        return userCache[userId]?.username || `User...`;
    }

    function updateChatHeader() {
        chatHeaderInfoEl.textContent = activeChat.type === 'group' 
            ? activeChat.name 
            : getDisplayName(activeChat.partnerId);
    }

    // =================================================================================
    // --- LIST RENDERING ---
    // =================================================================================
    async function fetchUsers(uids) {
        const uidsToFetch = [...new Set(uids)].filter(uid => uid && !userCache[uid]);
        if (uidsToFetch.length > 0) {
            const snapshot = await firebase.firestore().collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', uidsToFetch).get();
            snapshot.forEach(doc => userCache[doc.id] = { id: doc.id, ...doc.data() });
        }
    }
    
    function updateUserStatusIndicator(element, status) {
        element.className = 'status-indicator';
        element.classList.add(status || 'offline');
    }

    function renderFriendsList() {
        friendsListEl.innerHTML = '';
        const friends = currentUserProfile?.friends || [];
        if (friends.length === 0) {
            friendsListEl.innerHTML = `<li class="empty-state">No friends yet.</li>`;
            return;
        }

        fetchUsers(friends).then(() => {
            const pinnedChats = currentUserProfile.pinnedChats || [];
            const sortedFriends = [...friends].sort((a, b) => {
                const aChatId = [currentUser.uid, a].sort().join('_');
                const bChatId = [currentUser.uid, b].sort().join('_');
                return (pinnedChats.includes(bChatId) ? 1 : 0) - (pinnedChats.includes(aChatId) ? 1 : 0);
            });
            
            sortedFriends.forEach(uid => {
                const friendData = userCache[uid];
                if (!friendData) return;
                
                const li = document.createElement('li');
                const chatId = [currentUser.uid, uid].sort().join('_');
                const isPinned = pinnedChats.includes(chatId);

                li.dataset.chatId = chatId;
                li.dataset.chatType = 'dm';
                li.dataset.partnerId = uid;
                li.dataset.chatName = friendData.username;
                if (isPinned) li.classList.add('pinned-chat');

                li.innerHTML = `
                    <div class="item-info">
                        <i class="fas fa-user icon"></i> 
                        <span class="item-name">${friendData.username}</span>
                    </div>
                    <div class="item-actions">
                        <button class="pin-chat-btn" data-chat-id="${chatId}" title="${isPinned ? 'Unpin Chat' : 'Pin Chat'}">
                            <i class="fas fa-thumbtack ${isPinned ? 'active' : ''}"></i>
                        </button>
                    </div>`;
                friendsListEl.appendChild(li);
            });
        });
    }

    function renderGroupChatsList(groups = []) {
        groupChatsListEl.innerHTML = '';
        if (groups.length === 0) {
            groupChatsListEl.innerHTML = `<li class="empty-state">No groups yet.</li>`;
            return;
        }

        const pinnedChats = currentUserProfile.pinnedChats || [];
        groups.sort((a, b) => (pinnedChats.includes(b.id) ? 1 : 0) - (pinnedChats.includes(a.id) ? 1 : 0));

        groups.forEach(group => {
            const li = document.createElement('li');
            const isPinned = pinnedChats.includes(group.id);
            li.dataset.chatId = group.id;
            li.dataset.chatType = 'group';
            li.dataset.chatName = group.name;
            li.dataset.members = group.members.join(',');
            if (isPinned) li.classList.add('pinned-chat');

            li.innerHTML = `
                <div class="item-info">
                    <i class="fas fa-users icon"></i> 
                    <span class="item-name">${group.name}</span>
                </div>
                <div class="item-actions">
                    <button class="pin-chat-btn" data-chat-id="${group.id}" title="${isPinned ? 'Unpin Chat' : 'Pin Chat'}">
                        <i class="fas fa-thumbtack ${isPinned ? 'active' : ''}"></i>
                    </button>
                </div>`;
            groupChatsListEl.appendChild(li);
        });
    }

    // =================================================================================
    // --- FEATURE LOGIC (Pinning, Settings, Groups) ---
    // =================================================================================
    async function togglePinMessage(messageId) {
        if (!activeChat.id) return;
        const collectionPath = activeChat.type === 'group' ? `groups/${activeChat.id}/messages` : `chats/${activeChat.id}/messages`;
        const messageRef = firebase.firestore().collection(collectionPath).doc(messageId);
        
        try {
            const doc = await messageRef.get();
            if (doc.exists) {
                const isPinned = !doc.data().pinned;
                await messageRef.update({ pinned: isPinned });
                showNotification(isPinned ? 'Message pinned!' : 'Message unpinned.', 'info');
            }
        } catch (error) {
            console.error("Error pinning message:", error);
            showNotification("Could not update pin status.", 'danger');
        }
    }

    async function togglePinChat(chatId) {
        if (!currentUser || !currentUserProfile) return;
        const userRef = firebase.firestore().collection('users').doc(currentUser.uid);
        const pinnedChats = currentUserProfile.pinnedChats || [];
        
        const isPinned = pinnedChats.includes(chatId);
        const newPinnedChats = isPinned 
            ? pinnedChats.filter(id => id !== chatId)
            : [...pinnedChats, chatId];

        try {
            await userRef.update({ pinnedChats: newPinnedChats });
            showNotification(isPinned ? 'Chat unpinned' : 'Chat pinned!', 'info');
        } catch (error) {
            console.error('Error pinning chat:', error);
            showNotification('Could not pin chat.', 'danger');
        }
    }


    async function showPinnedMessages() {
        if (!activeChat.id) return;
        pinnedMessagesList.innerHTML = '<p>Loading pinned messages...</p>';
        pinnedMessagesModal.classList.add('visible');

        const collectionPath = activeChat.type === 'group' ? `groups/${activeChat.id}/messages` : `chats/${activeChat.id}/messages`;
        const messagesRef = firebase.firestore().collection(collectionPath).where('pinned', '==', true).orderBy('createdAt');

        const snapshot = await messagesRef.get();
        if (snapshot.empty) {
            pinnedMessagesList.innerHTML = '<p>No messages have been pinned in this chat yet.</p>';
            return;
        }

        const userIds = snapshot.docs.map(doc => doc.data().authorId);
        await fetchUsers(userIds);

        pinnedMessagesList.innerHTML = '';
        snapshot.forEach(doc => {
            const data = doc.data();
            const secretKey = getChatSecret(activeChat.id, activeChat.type, activeChat.partnerId);
            const decryptedText = decryptMessage(data.text, secretKey);
            const senderName = getDisplayName(data.authorId);
            const time = new Date(data.createdAt.toDate()).toLocaleString();

            const messageEl = document.createElement('div');
            messageEl.style.borderBottom = '1px solid #eee';
            messageEl.style.padding = '10px 0';
            messageEl.innerHTML = `
                <strong>${senderName}</strong> <small>(${time})</small>
                <p style="margin-top: 5px;">${decryptedText}</p>
            `;
            pinnedMessagesList.appendChild(messageEl);
        });
    }

    async function showChatSettings() {
        if (!activeChat.id) return;

        nicknameInputsContainer.innerHTML = '';
        const membersToFetch = activeChat.members;
        await fetchUsers(membersToFetch);

        membersToFetch.forEach(uid => {
            if (!uid) return;
            const currentNickname = activeChat.settings?.nicknames?.[uid] || '';
            const originalName = userCache[uid]?.username || '...';
            const label = uid === currentUser.uid ? `Your Nickname (in this chat)` : `Nickname for ${originalName}`;
            
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';
            formGroup.innerHTML = `
                <label for="nickname-${uid}">${label}</label>
                <input type="text" id="nickname-${uid}" data-uid="${uid}" value="${currentNickname}" placeholder="${originalName}">
            `;
            nicknameInputsContainer.appendChild(formGroup);
        });
        
        const wallpapers = ['default', 'red', 'orange', 'yellow', 'green', 'blue', 'purple', 'galaxy', 'stars', 'abyss'];
        wallpaperSelector.innerHTML = '';
        wallpapers.forEach(wp => {
            const option = document.createElement('div');
            option.className = 'wallpaper-option';
            option.dataset.wallpaper = `wp-${wp}`;
            option.innerHTML = `<img src="${wp === 'default' ? 'https://i.imgur.com/pD2iB3k.png' : `../vs-wallpapers/${wp}.jpg`}" alt="${wp} wallpaper">`;
            
            if ((activeChat.settings?.wallpaper || 'wp-default') === `wp-${wp}`) {
                option.classList.add('selected');
            }

            option.addEventListener('click', () => {
                wallpaperSelector.querySelector('.selected')?.classList.remove('selected');
                option.classList.add('selected');
            });
            wallpaperSelector.appendChild(option);
        });
        
        chatSettingsModal.classList.add('visible');
    }
    
    async function handleSaveChatSettings() {
        if (!activeChat.id) return;
        const chatDocRef = activeChat.type === 'group' 
            ? firebase.firestore().collection('groups').doc(activeChat.id)
            : firebase.firestore().collection('chats').doc(activeChat.id);

        const newNicknames = { ...activeChat.settings?.nicknames };
        nicknameInputsContainer.querySelectorAll('input').forEach(input => {
            newNicknames[input.dataset.uid] = input.value.trim();
        });

        const selectedWallpaper = wallpaperSelector.querySelector('.selected')?.dataset.wallpaper || 'wp-default';

        try {
            await chatDocRef.set({
                settings: {
                    nicknames: newNicknames,
                    wallpaper: selectedWallpaper
                }
            }, { merge: true });
            
            activeChat.settings = { nicknames: newNicknames, wallpaper: selectedWallpaper };
            applyChatSettings();
            showNotification('Settings saved!', 'success');
            chatSettingsModal.classList.remove('visible');
        } catch (error) {
            console.error("Error saving settings:", error);
            showNotification('Failed to save settings. Check security rules.', 'danger');
        }
    }

    function applyChatSettings() {
        messagesContainer.className = 'messages-container';
        messagesContainer.classList.add(activeChat.settings?.wallpaper || 'wp-default');
    }

    async function showCreateGroupModal() {
        createGroupFriendsList.innerHTML = '';
        const friends = currentUserProfile?.friends || [];
        if(friends.length === 0) {
            createGroupFriendsList.innerHTML = '<p>You have no friends to add to a group.</p>';
            createGroupModal.classList.add('visible');
            return;
        }

        await fetchUsers(friends);
        friends.forEach(uid => {
            const friend = userCache[uid];
            if(!friend) return;
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${uid}"> ${friend.username}`;
            createGroupFriendsList.appendChild(label);
        });
        createGroupModal.classList.add('visible');
    }

    async function handleCreateGroup(e) {
        e.preventDefault();
        const groupName = groupNameInput.value.trim();
        if(!groupName) {
            showNotification('Group name is required.', 'warning');
            return;
        }
        const selectedMembers = Array.from(createGroupFriendsList.querySelectorAll('input:checked')).map(input => input.value);
        
        const allMembers = [currentUser.uid, ...selectedMembers];

        try {
            await firebase.firestore().collection('groups').add({
                name: groupName,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                members: allMembers,
                settings: {
                    nicknames: {},
                    wallpaper: 'wp-default'
                }
            });
            showNotification(`Group "${groupName}" created!`, 'success');
            createGroupModal.classList.remove('visible');
            createGroupForm.reset();
        } catch(error) {
            console.error("Error creating group: ", error);
            showNotification('Failed to create group.', 'danger');
        }
    }


</script>
</body>
</html>
