<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - Vern Social</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    /* --- Base Dashboard Layout (from template) --- */
    body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: PrimaryFont, sans-serif; }
    .dashboard-container { display: flex; flex: 1; }
    .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.collapsed { width: 85px; }
    #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
    .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
    .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
    .sidebar nav li { margin-bottom: 10px; }
    .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: PrimaryFont, sans-serif; text-transform: uppercase; position: relative; overflow: hidden; }
    .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
    .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
    .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
    .sidebar.collapsed nav a { justify-content: center; padding: 10px 0; }
    .sidebar.collapsed nav a .label { display: none; }
    .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: hidden; }
    .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em; }
    .marquee-content { display: inline-block; padding-left: 100%; animation: scroll-left 12s linear infinite; }
    .user-info .username { font-family: PrimaryFont, sans-serif; font-size: 1.3em; margin-bottom: 8px; line-height: 0.2em; font-weight: bold; }
    .user-info .email { font-family: SecondaryFont, sans-serif; font-size: 0.9em; color: #bbb; }
    @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    .main-content { flex: 1; padding: 30px; background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%); overflow-y: auto; position: relative; display: flex; gap: 20px; }
    
    /* --- VERN SOCIAL SPECIFIC STYLES --- */
    .social-container { flex: 3; display: flex; flex-direction: column; gap: 20px; }
    .chat-container { flex: 2; background: #fff; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.07); display: flex; flex-direction: column; overflow: hidden; transition: all 0.3s ease; max-width: 450px; }
    .chat-container.hidden { flex: 0; width: 0; padding: 0; border: none; margin:0; }
    
    .card { background: #fff; padding: 20px 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
    .tabs { display: flex; gap: 10px; border-bottom: 2px solid #eee; margin-bottom: 20px; }
    .tab-btn { background: none; border: none; padding: 10px 15px; font-size: 1em; font-weight: 600; cursor: pointer; color: #777; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
    .tab-btn.active { color: #6720bd; border-bottom-color: #6720bd; }
    .tab-content { display: none; animation: fadeInView 0.5s; }
    .tab-content.active { display: block; }

    #allUsersView .search-bar { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 15px; box-sizing: border-box; }
    .user-list { list-style: none; padding: 0; margin: 0; max-height: 500px; overflow-y: auto; }
    .user-list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 8px; border-bottom: 1px solid #f0f0f0; }
    .user-list-item:last-child { border-bottom: none; }
    .user-list-item .user-details .username { font-weight: bold; color: #333; }
    .user-list-item .user-details .email { font-size: 0.85em; color: #888; }
    
    .action-btn { border: none; padding: 8px 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.8em; transition: all 0.2s ease; margin-left: 5px; }
    .action-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-add { background-color: #28a745; color: white; }
    .btn-accept { background-color: #007bff; color: white; }
    .btn-cancel, .btn-decline { background-color: #6c757d; color: white; }
    .btn-unfriend, .btn-block { background-color: #dc3545; color: white; }
    .btn-unblock { background-color: #ffc107; color: #212529; }
    .btn-chat { background-color: #17a2b8; color: white; }
    .btn-pending { background-color: #ffc107; color: #212529; cursor: default; }

    .requests-section h4 { margin-top: 20px; margin-bottom: 10px; color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
    #incomingRequestsList, #outgoingRequestsList { margin-top: 10px; }

    /* CHAT STYLES */
    #chatHeader { padding: 15px 20px; border-bottom: 1px solid #eee; background-color: #f8f9fa; }
    #chatHeader h3 { margin: 0; font-size: 1.2em; color: #333; }
    #chatHeader #closeChatBtn { float: right; background: none; border: none; font-size: 1.5em; cursor: pointer; color: #888; line-height: 1; }
    #chatMessages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
    #chatMessagesContainer { display: flex; flex-direction: column; gap: 12px; }
    .message-bubble { max-width: 75%; padding: 10px 15px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; }
    .message-bubble.sent { background: #6720bd; color: white; border-bottom-right-radius: 4px; align-self: flex-end; }
    .message-bubble.received { background: #e9ecef; color: #212529; border-bottom-left-radius: 4px; align-self: flex-start; }
    .message-bubble .timestamp { font-size: 0.7em; opacity: 0.7; display: block; margin-top: 5px; text-align: right; }
    #chatInputForm { display: flex; padding: 15px; border-top: 1px solid #eee; gap: 10px; }
    #chatInput { flex-grow: 1; border: 1px solid #ccc; padding: 10px; border-radius: 20px; }
    #sendMsgBtn { background: #6720bd; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2em; cursor: pointer; }
    #chatWelcome { text-align: center; color: #888; margin: auto; padding: 20px; }

    @keyframes fadeInView { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body class="dashboard-page">
  <header class="main-header light-bg">
    <div class="container">
      <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" /></a></div>
      <div class="auth-buttons"><button id="logoutBtn" class="btn btn-login">LOG OUT</button></div>
    </div>
  </header>
  
  <div class="dashboard-container">
    <aside class="sidebar" id="sidebar">
      <button id="toggleSidebar">‚ò∞</button>
      <div class="user-info">
        <div class="marquee-container"><span id="userName" class="marquee-content username">Loading‚Ä¶</span></div>
        <div class="marquee-container"><span id="userEmail" class="marquee-content email">Loading‚Ä¶</span></div>
      </div>
      <nav>
        <ul>
          <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
          <li><a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">Proxies</span></a></li>
          <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
          <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
          <li><a href="others.html" class="active"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
          <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
          <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
        </ul>
      </nav>
    </aside>
    
    <main class="main-content">
        <div class="social-container">
            <div class="card">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="allUsersView">Find People</button>
                    <button class="tab-btn" data-tab="friendsView">Friends</button>
                    <button class="tab-btn" data-tab="requestsView">Requests</button>
                    <button class="tab-btn" data-tab="blockedView">Blocked</button>
                </div>

                <div id="allUsersView" class="tab-content active">
                    <input type="search" id="userSearch" class="search-bar" placeholder="Search for users by name or email...">
                    <ul id="allUsersList" class="user-list"><li>Loading...</li></ul>
                </div>

                <div id="friendsView" class="tab-content">
                    <ul id="friendsList" class="user-list"><li>Loading...</li></ul>
                </div>

                <div id="requestsView" class="tab-content">
                    <div class="requests-section">
                        <h4><i class="fas fa-inbox"></i> Incoming Requests</h4>
                        <ul id="incomingRequestsList" class="user-list"><li>No new requests.</li></ul>
                    </div>
                    <div class="requests-section">
                        <h4><i class="fas fa-paper-plane"></i> Outgoing Requests</h4>
                        <ul id="outgoingRequestsList" class="user-list"><li>No pending requests.</li></ul>
                    </div>
                </div>

                <div id="blockedView" class="tab-content">
                    <ul id="blockedList" class="user-list"><li>Loading...</li></ul>
                </div>
            </div>
        </div>

        <div id="chatContainer" class="chat-container hidden">
            <div id="chatHeader">
                <button id="closeChatBtn">&times;</button>
                <h3 id="chattingWith"></h3>
            </div>
            <div id="chatMessages">
                <div id="chatMessagesContainer"></div>
            </div>
            <p id="chatWelcome">Select a friend to start chatting.</p>
            <form id="chatInputForm" style="display: none;">
                <input type="text" id="chatInput" placeholder="Type a message..." autocomplete="off">
                <button type="submit" id="sendMsgBtn"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase & Global State ---
        const db = firebase.firestore();
        let currentUser = null;
        let localState = {
            profile: null,
            users: [],
            requests: [],
        };
        let listeners = {}; // To store unsubscribe functions

        // --- DOM Elements ---
        const sidebarUserNameEl = document.getElementById('userName');
        const sidebarUserEmailEl = document.getElementById('userEmail');
        const allUsersListEl = document.getElementById('allUsersList');
        const userSearchEl = document.getElementById('userSearch');
        const friendsListEl = document.getElementById('friendsList');
        const incomingRequestsListEl = document.getElementById('incomingRequestsList');
        const outgoingRequestsListEl = document.getElementById('outgoingRequestsList');
        const blockedListEl = document.getElementById('blockedList');
        const chatContainer = document.getElementById('chatContainer');
        const chatWelcomeEl = document.getElementById('chatWelcome');
        const chatMessages = document.getElementById('chatMessages');
        const chattingWithEl = document.getElementById('chattingWith');
        const chatMessagesContainer = document.getElementById('chatMessagesContainer');
        const chatInputForm = document.getElementById('chatInputForm');
        const chatInput = document.getElementById('chatInput');
        const closeChatBtn = document.getElementById('closeChatBtn');

        // --- Utility Functions ---
        const escapeHTML = (str) => {
            const p = document.createElement("p");
            p.textContent = str;
            return p.innerHTML;
        };

        const showStatus = (message, type = 'info') => {
            console.log(`[${type.toUpperCase()}] ${message}`);
            // In a real app, you'd want a proper notification UI element here.
        };

        // --- Initialization & Auth ---
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                sidebarUserEmailEl.textContent = user.email;
                await attachRealtimeListeners();
            } else {
                detachAllListeners();
                window.location.href = '../login.html';
            }
        });

        function detachAllListeners() {
            Object.values(listeners).forEach(unsub => unsub && unsub());
            listeners = {};
        }

        async function attachRealtimeListeners() {
            if (!currentUser) return;
            detachAllListeners(); // Clean up previous listeners

            // 1. Listen to current user's profile changes
            listeners.profile = db.collection('users').doc(currentUser.uid)
                .onSnapshot(async (doc) => {
                    if (doc.exists) {
                        localState.profile = { id: doc.id, ...doc.data() };
                        sidebarUserNameEl.textContent = localState.profile.username || 'User';
                        renderAllTabs(); // Re-render when profile changes (friends/blocked list)
                    } else {
                        // Create profile if it doesn't exist
                        const profile = {
                            email: currentUser.email,
                            username: currentUser.email.split('@')[0],
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            authMethod: 'email', friends: [], blocked: []
                        };
                        await db.collection('users').doc(currentUser.uid).set(profile);
                    }
                }, err => console.error("Profile listener error: ", err));

            // 2. Listen to all users collection
            listeners.users = db.collection('users').onSnapshot((snapshot) => {
                localState.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllTabs();
            }, err => console.error("Users listener error: ", err));

            // 3. Listen to relevant friend requests
            listeners.incomingRequests = db.collection('friend_requests').where('receiverId', '==', currentUser.uid)
                .onSnapshot(handleRequestSnapshot, err => console.error("Incoming req listener error:", err));
            listeners.outgoingRequests = db.collection('friend_requests').where('senderId', '==', currentUser.uid)
                .onSnapshot(handleRequestSnapshot, err => console.error("Outgoing req listener error:", err));
        }

        function handleRequestSnapshot(snapshot) {
            snapshot.docChanges().forEach((change) => {
                const docData = { id: change.doc.id, ...change.doc.data() };
                const existingIndex = localState.requests.findIndex(r => r.id === docData.id);

                if (change.type === "added") {
                    if (existingIndex === -1) localState.requests.push(docData);
                }
                if (change.type === "modified") {
                    if (existingIndex > -1) localState.requests[existingIndex] = docData;
                }
                if (change.type === "removed") {
                    if (existingIndex > -1) localState.requests.splice(existingIndex, 1);
                }
            });
            renderAllTabs();
        }

        function renderAllTabs() {
            if (!localState.profile) return;
            renderAllUsers();
            renderFriendsList();
            renderRequests();
            renderBlockedList();
        }
        
        // --- RELATIONSHIP LOGIC ---
        function getRelationship(otherUserId) {
            const profile = localState.profile;
            if (!profile) return { status: 'loading' };
            if (profile.id === otherUserId) return { status: 'self' };
            if (profile.blocked?.includes(otherUserId)) return { status: 'blocked' };
            if (profile.friends?.includes(otherUserId)) return { status: 'friend' };
            
            const incoming = localState.requests.find(r => r.senderId === otherUserId && r.receiverId === profile.id);
            if (incoming) return { status: 'incoming_request', requestId: incoming.id };
            
            const outgoing = localState.requests.find(r => r.senderId === profile.id && r.receiverId === otherUserId);
            if (outgoing) return { status: 'outgoing_request', requestId: outgoing.id };
            
            return { status: 'none' };
        }

        function renderUserListItem(user, container) {
            const relationship = getRelationship(user.id);
            if (relationship.status === 'self') return;
            
            const li = document.createElement('li');
            li.className = 'user-list-item';
            li.dataset.userId = user.id;

            let buttonsHTML = '';
            switch (relationship.status) {
                case 'none':
                    buttonsHTML = `<button class="action-btn btn-add" data-action="add">Add Friend</button>`;
                    break;
                case 'friend':
                    buttonsHTML = `<button class="action-btn btn-chat" data-action="chat">Chat</button>
                                 <button class="action-btn btn-unfriend" data-action="unfriend">Unfriend</button>
                                 <button class="action-btn btn-block" data-action="block">Block</button>`;
                    break;
                case 'incoming_request':
                    buttonsHTML = `<button class="action-btn btn-accept" data-action="accept" data-request-id="${relationship.requestId}">Accept</button>
                                 <button class="action-btn btn-decline" data-action="decline" data-request-id="${relationship.requestId}">Decline</button>`;
                    break;
                case 'outgoing_request':
                    buttonsHTML = `<button class="action-btn btn-pending" disabled>Pending</button>
                                 <button class="action-btn btn-cancel" data-action="cancel" data-request-id="${relationship.requestId}">Cancel</button>`;
                    break;
                case 'blocked':
                    buttonsHTML = `<button class="action-btn btn-unblock" data-action="unblock">Unblock</button>`;
                    break;
                default:
                    buttonsHTML = `<span>Loading...</span>`;
            }
            li.innerHTML = `
                <div class="user-details">
                    <div class="username">${escapeHTML(user.username)}</div>
                    <div class="email">${escapeHTML(user.email)}</div>
                </div>
                <div class="user-actions">${buttonsHTML}</div>`;
            container.appendChild(li);
        }

        // --- UI Rendering ---
        function renderAllUsers() {
            allUsersListEl.innerHTML = '';
            const query = userSearchEl.value.toLowerCase();
            const filteredUsers = localState.users.filter(u => u.username.toLowerCase().includes(query) || u.email.toLowerCase().includes(query));
            if (filteredUsers.length === 0) allUsersListEl.innerHTML = '<li>No users found.</li>';
            else filteredUsers.forEach(user => renderUserListItem(user, allUsersListEl));
        }

        function renderFriendsList() {
            friendsListEl.innerHTML = '';
            const friendIds = localState.profile?.friends || [];
            if (friendIds.length === 0) {
                friendsListEl.innerHTML = '<li>You have no friends yet. Find some!</li>';
                return;
            }
            const friends = localState.users.filter(user => friendIds.includes(user.id));
            friends.forEach(friend => renderUserListItem(friend, friendsListEl));
        }
        
        function renderRequests() {
            incomingRequestsListEl.innerHTML = '';
            outgoingRequestsListEl.innerHTML = '';
            const incoming = localState.requests.filter(r => r.receiverId === currentUser.uid);
            const outgoing = localState.requests.filter(r => r.senderId === currentUser.uid);

            if (incoming.length > 0) incoming.forEach(req => {
                const sender = localState.users.find(u => u.id === req.senderId);
                if (sender) renderUserListItem(sender, incomingRequestsListEl);
            }); else incomingRequestsListEl.innerHTML = '<li>No incoming requests.</li>';
            
            if (outgoing.length > 0) outgoing.forEach(req => {
                const receiver = localState.users.find(u => u.id === req.receiverId);
                if (receiver) renderUserListItem(receiver, outgoingRequestsListEl);
            }); else outgoingRequestsListEl.innerHTML = '<li>No outgoing requests.</li>';
        }
        
        function renderBlockedList() {
            blockedListEl.innerHTML = '';
            const blockedIds = localState.profile?.blocked || [];
            if (blockedIds.length === 0) {
                blockedListEl.innerHTML = '<li>You have not blocked anyone.</li>';
                return;
            }
            const blockedUsers = localState.users.filter(user => blockedIds.includes(user.id));
            blockedUsers.forEach(user => renderUserListItem(user, blockedListEl));
        }

        // --- Social Actions ---
        async function sendFriendRequest(receiverId) {
            await db.collection('friend_requests').add({
                senderId: currentUser.uid, receiverId, status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(e => showStatus(`Error sending request: ${e.message}`, 'error'));
        }
        
        async function cancelOrDeclineRequest(requestId) {
            await db.collection('friend_requests').doc(requestId).delete()
                .catch(e => showStatus(`Error declining request: ${e.message}`, 'error'));
        }

        async function acceptFriendRequest(senderId, requestId) {
            const batch = db.batch();
            batch.delete(db.collection('friend_requests').doc(requestId));
            batch.update(db.collection('users').doc(currentUser.uid), { friends: firebase.firestore.FieldValue.arrayUnion(senderId) });
            batch.update(db.collection('users').doc(senderId), { friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
            await batch.commit().catch(e => showStatus(`Error accepting request: ${e.message}`, 'error'));
        }
        
        async function unfriendUser(friendId) {
            const batch = db.batch();
            batch.update(db.collection('users').doc(currentUser.uid), { friends: firebase.firestore.FieldValue.arrayRemove(friendId) });
            batch.update(db.collection('users').doc(friendId), { friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
            await batch.commit().catch(e => showStatus(`Error unfriending: ${e.message}`, 'error'));
        }
        
        async function blockUser(userIdToBlock) {
            const batch = db.batch();
            const currentUserRef = db.collection('users').doc(currentUser.uid);
            batch.update(currentUserRef, {
                blocked: firebase.firestore.FieldValue.arrayUnion(userIdToBlock),
                friends: firebase.firestore.FieldValue.arrayRemove(userIdToBlock)
            });
            batch.update(db.collection('users').doc(userIdToBlock), { friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
            await batch.commit().catch(e => showStatus(`Error blocking user: ${e.message}`, 'error'));
        }
        
        async function unblockUser(userIdToUnblock) {
            await db.collection('users').doc(currentUser.uid).update({
                blocked: firebase.firestore.FieldValue.arrayRemove(userIdToUnblock)
            }).catch(e => showStatus(`Error unblocking user: ${e.message}`, 'error'));
        }

        // --- Chat ---
        function openChatWith(friendUser) {
            chatContainer.classList.remove('hidden');
            chatWelcomeEl.style.display = 'none';
            chatInputForm.style.display = 'flex';
            chattingWithEl.textContent = friendUser.username;
            const chatId = [currentUser.uid, friendUser.id].sort().join('_');
            
            if (listeners.chat) listeners.chat();
            
            chatMessagesContainer.innerHTML = '';
            const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('createdAt', 'desc').limit(50);
            
            listeners.chat = messagesRef.onSnapshot(snapshot => {
                snapshot.docChanges().reverse().forEach(change => {
                    if (change.type === 'added') {
                        renderMessage(change.doc.data());
                    }
                });
            }, err => console.error("Chat listener error:", err));
            
            chatInputForm.onsubmit = (e) => { e.preventDefault(); sendMessage(chatId, friendUser.id); };
        }
        
        async function sendMessage(chatId, friendId) {
            const text = chatInput.value.trim();
            if (!text) return;
            chatInput.value = '';
            
            const chatRef = db.collection('chats').doc(chatId);
            const msgRef = chatRef.collection('messages').doc();

            const batch = db.batch();
            batch.set(chatRef, { members: [currentUser.uid, friendId] }, { merge: true });
            batch.set(msgRef, {
                text, authorId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await batch.commit();
        }

        function renderMessage(msg) {
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble ' + (msg.authorId === currentUser.uid ? 'sent' : 'received');
            const time = msg.createdAt?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || '';
            bubble.innerHTML = `<div>${escapeHTML(msg.text)}</div><span class="timestamp">${time}</span>`;
            chatMessagesContainer.appendChild(bubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function closeChat() {
            chatContainer.classList.add('hidden');
            chatWelcomeEl.style.display = 'block';
            chatInputForm.style.display = 'none';
            if (listeners.chat) { listeners.chat(); delete listeners.chat; }
            chatInputForm.onsubmit = null;
        }

        // --- Event Listeners ---
        document.querySelector('.tabs').addEventListener('click', e => {
            if (e.target.matches('.tab-btn')) {
                document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById(e.target.dataset.tab).classList.add('active');
            }
        });

        document.querySelector('.social-container').addEventListener('click', async (e) => {
            const button = e.target.closest('.action-btn');
            if (!button || button.disabled) return;
        
            const li = button.closest('.user-list-item');
            if (!li) return;
        
            button.disabled = true; 
        
            const action = button.dataset.action;
            const userId = li.dataset.userId;
            const requestId = button.dataset.requestId;
        
            try {
                if (action === 'unfriend') {
                    const friendToUnfriend = localState.users.find(u => u.id === userId);
                    const friendName = friendToUnfriend ? friendToUnfriend.username : 'this user';
                    if (confirm(`Are you sure you want to unfriend ${friendName}?`)) {
                        await unfriendUser(userId);
                    }
                } else if (action === 'block') {
                    const userToBlock = localState.users.find(u => u.id === userId);
                    const userName = userToBlock ? userToBlock.username : 'this user';
                    if (confirm(`Blocking ${userName} will also unfriend them. Are you sure?`)) {
                        await blockUser(userId);
                    }
                } else {
                    // For non-confirm actions, proceed directly
                    switch (action) {
                        case 'add': await sendFriendRequest(userId); break;
                        case 'accept': await acceptFriendRequest(userId, requestId); break;
                        case 'cancel': await cancelOrDeclineRequest(requestId); break;
                        case 'decline': await cancelOrDeclineRequest(requestId); break;
                        case 'unblock': await unblockUser(userId); break;
                        case 'chat':
                            const friend = localState.users.find(u => u.id === userId);
                            if (friend) openChatWith(friend);
                            break;
                    }
                }
            } catch (err) {
                showStatus(`Action '${action}' failed: ${err.message}`, 'error');
                console.error("Action failed:", err);
            } finally {
                // The realtime listener will handle redrawing, which re-enables the button if appropriate.
                // We no longer manually re-enable here to prevent race conditions.
            }
        });
        
        userSearchEl.addEventListener('input', renderAllUsers);
        closeChatBtn.addEventListener('click', closeChat);
        document.getElementById('logoutBtn').addEventListener('click', () => firebase.auth().signOut());
        document.getElementById('signOutLink').addEventListener('click', () => firebase.auth().signOut());
        document.getElementById('toggleSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
    });
  </script>
</body>
</html>
