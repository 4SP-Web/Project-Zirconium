<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - SETTINGS</title>
    <link rel="stylesheet" href="../css/style.css" />
    <script src="../ban-enforcer.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js"></script>
    <style>
    /* --- Settings Layout (matching dashboard structure) --- */
    body.settings-page {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        margin: 0;
        font-family: 'PrimaryFont', sans-serif;
    }
    .settings-container {
        display: flex;
        flex: 1;
    }

    /* --- Sidebar --- */
    .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.collapsed { width: 85px; }
    #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
    .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
    .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
    .sidebar nav li { margin-bottom: 10px; }
    .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
    .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
    .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
    .sidebar nav a .label { 
        margin-left: 10px; 
        white-space: nowrap; 
        opacity: 1;
        visibility: visible;
        transition: opacity 0.2s ease-in-out;
        transition-delay: 0.4s;
    }
    .sidebar.collapsed nav a .label { 
        opacity: 0;
        visibility: hidden;
        transition-delay: 0s;
    }

    /* --- Main Content & Controls (Matched dashboard's styles) --- */
    .main-content {
        flex: 1;
        padding: 40px;
        background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
        overflow-y: auto;
        position: relative;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
        background: white;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid rgba(103, 32, 189, 0.1);
    }

    .dashboard-title {
        margin: 0;
        font-size: 2.2em;
        font-weight: bold;
        background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .quick-actions {
        background: white;
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 6px 30px rgba(0,0,0,0.08);
        border: 1px solid rgba(103, 32, 189, 0.1);
    }

    .quick-actions h3 {
        margin: 0 0 20px 0;
        font-size: 1.4em;
        color: #333;
        display: flex;
        align-items: center;
    }

    .quick-actions h3::before {
        content: '⚡';
        margin-right: 10px;
        font-size: 1.2em;
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .action-btn {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px solid rgba(103, 32, 189, 0.2);
        color: #6720bd;
        padding: 12px 20px;
        border-radius: 15px;
        font-family: 'PrimaryFont', sans-serif;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    #manageBansBtn {
        border-color: rgba(220, 53, 69, 0.3);
        color: #dc3545;
    }

    .action-btn:hover {
        background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(103, 32, 189, 0.3);
    }

    #manageBansBtn:hover {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
    }

    .user-info-section {
        background: white;
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 6px 30px rgba(0,0,0,0.08);
        border: 1px solid rgba(103, 32, 189, 0.1);
    }

    .user-info-section h3 {
        margin: 0 0 20px 0;
        font-size: 1.4em;
        color: #333;
        display: flex;
        align-items: center;
    }

    .user-info-section h3::before {
        content: '👤';
        margin-right: 10px;
        font-size: 1.2em;
    }

    .user-info-detail {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px dashed #eee;
    }

    .user-info-detail:last-child {
        border-bottom: none;
    }

    .user-info-detail strong {
        color: #555;
        font-family: 'PrimaryFont', sans-serif;
        font-weight: 600;
    }

    .user-info-detail span {
        color: #666;
        font-family: 'SecondaryFont', sans-serif;
    }

    .settings-section {
        background: #fff;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 6px 30px rgba(0,0,0,0.08);
        margin-bottom: 30px;
        position: relative;
        border: 1px solid rgba(103, 32, 189, 0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .settings-section:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 40px rgba(103, 32, 189, 0.15);
        border-color: rgba(103, 32, 189, 0.3);
    }
    
    #ban-management-section, #data-management-section {
        border-color: rgba(220, 53, 69, 0.2);
    }

    #data-management-section {
        border-color: rgba(32, 153, 189, 0.2);
    }
    #data-management-section:hover {
        box-shadow: 0 15px 40px rgba(32, 153, 189, 0.15);
        border-color: rgba(32, 153, 189, 0.3);
    }

    #ban-management-section:hover {
        box-shadow: 0 15px 40px rgba(220, 53, 69, 0.15);
        border-color: rgba(220, 53, 69, 0.3);
    }


    .settings-section h3 {
        font-family: 'PrimaryFont', sans-serif;
        margin: 0 0 20px;
        font-size: 1.5em;
        color: #333;
        border-bottom: 2px solid rgba(103, 32, 189, 0.1);
        padding-bottom: 10px;
    }
    
    #ban-management-section h3 {
        color: #dc3545;
        border-bottom-color: rgba(220, 53, 69, 0.2);
    }

    #data-management-section h3 {
        color: #2099bd;
        border-bottom-color: rgba(32, 153, 189, 0.2);
    }
    
    #ban-management-section h4 {
        font-family: 'PrimaryFont', sans-serif;
        margin: 25px 0 15px 0;
        font-size: 1.2em;
        color: #555;
        border-bottom: 1px solid #ddd;
        padding-bottom: 8px;
    }

    .settings-section p {
        font-family: 'SecondaryFont', sans-serif;
        color: #666;
        margin-bottom: 20px;
        line-height: 1.5;
    }
    
    .username-limit-container { display: flex; align-items: center; justify-content: flex-end; gap: 10px; margin-top: -15px; margin-bottom: 15px; }
    .username-limit-counter { font-family: 'PrimaryFont', sans-serif; font-weight: 600; font-size: 0.9em; color: #555; background-color: #f0f2f5; padding: 4px 8px; border-radius: 6px; }
    .username-limit-info-btn { background: none; border: 1px solid #ccc; color: #777; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; position: relative; }
    .username-limit-info-btn:hover { background-color: #6720bd; color: white; border-color: #6720bd; }
    .username-limit-tooltip { display: none; position: absolute; bottom: 120%; right: 0; background-color: #333; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.85em; white-space: nowrap; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-family: 'PrimaryFont', sans-serif; }
    .username-limit-info-btn:hover .username-limit-tooltip { display: block; }

    .limit-info {
        padding: 10px 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        font-family: 'SecondaryFont', sans-serif;
        color: #495057;
        font-size: 0.95em;
        text-align: center;
        transition: all 0.3s ease;
    }
    .limit-info.on-cooldown {
        background-color: #fff8e1;
        border-color: #ffecb3;
        color: #856404;
    }
    .limit-info strong {
        color: #6720bd;
        font-weight: 600;
    }
    .limit-info.on-cooldown strong {
        color: #856404;
    }

    .settings-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 10px;
        position: relative;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        border-radius: 12px;
    }
    
    .username-status-message {
        text-align: right;
        font-size: 0.85em;
        color: #856404; /* Muted warning color */
        font-family: 'SecondaryFont', sans-serif;
        min-height: 1.2em; /* Prevents layout shift */
        margin-top: -10px;
        margin-bottom: 10px;
        transition: opacity 0.3s;
    }

    .settings-form label {
        font-family: 'SecondaryFont', sans-serif;
        font-weight: bold;
        color: #555;
        font-size: 0.95em;
    }

    .settings-form input,
    .settings-form select {
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 12px !important;
        font-size: 1em;
        font-family: 'SecondaryFont', sans-serif;
        transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s;
        background: #fff;
    }
    
    .settings-form input:disabled,
    .settings-form select:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .settings-form input:focus,
    .settings-form select:focus {
        outline: none;
        border-color: #6720bd;
        box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.1);
    }
    
    #ban-management-section input:focus, #data-management-section input:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15);
    }
    #data-management-section input:focus {
        border-color: #2099bd;
        box-shadow: 0 0 0 3px rgba(32, 153, 189, 0.15);
    }

    /* --- CORRECTED: Main Form Button Styles --- */
    .settings-form > button {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        background: #6720bd;
        color: #fff;
        font-size: 1em;
        cursor: pointer;
        font-family: 'PrimaryFont', sans-serif;
        text-transform: uppercase;
        transition: all 0.3s ease;
        align-self: flex-start;
        min-width: 150px;
        position: relative;
        overflow: hidden;
    }
    
    .settings-form > button:disabled {
        background: #9e8fbe;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .settings-form > button:disabled:hover::before {
        display: none;
    }

    .settings-form > button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    .settings-form > button:hover::before {
        left: 100%;
    }

    .settings-form > button:hover {
        background: #5a1aa8;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(103, 32, 189, 0.3);
    }

    .settings-form > button.delete, #ban-management-section .settings-form > button {
        background: #dc3545;
        color: #fff;
    }

    #data-management-section .settings-form > button {
        background: #2099bd;
    }
    #data-management-section .settings-form > button:hover {
        background: #1a7c97;
        box-shadow: 0 4px 12px rgba(32, 153, 189, 0.3);
    }

    .settings-form > button.delete:hover, #ban-management-section .settings-form > button:hover {
        background: #c82333;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }

    .settings-form > button.secondary {
        background: #6c757d;
    }

    .settings-form > button.secondary:hover {
        background: #5a6268;
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }

    .settings-section.disabled {
        position: relative;
    }

    .settings-section.disabled::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(240, 240, 240, 0.8);
        border-radius: 20px;
        z-index: 5;
        transition: opacity 1s ease;
    }

    .settings-section.disabled::after {
        text-transform: uppercase;
        content: attr(data-disabled-message);
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: 'PrimaryFont', sans-serif;
        font-weight: bold;
        color: #666;
        z-index: 6;
        background: rgba(255, 255, 255, 0.95);
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: opacity 1s ease;
        text-align: center;
    }

    .settings-section.disabled.fadeout::before,
    .settings-section.disabled.fadeout::after {
        opacity: 0;
        pointer-events: none;
    }

    .reauth-btn {
        background: linear-gradient(135deg, #4285F4 0%, #3478e6 100%) !important;
        color: #fff !important;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-family: 'PrimaryFont', sans-serif;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9em;
        overflow: hidden;
    }

    .reauth-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    .reauth-btn:hover::before {
        left: 100%;
    }

    .reauth-btn:hover {
        background: linear-gradient(135deg, #3478e6 0%, #2b6bd8 100%) !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
    }
    
    .reauth-wrapper {
        position: relative;
        z-index: 7;
    }

    .reauth-btn.fadeout {
        opacity: 0;
        pointer-events: none;
    }
    
    .banned-list-container {
        margin-top: 25px;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 10px;
    }
    
    .banned-user-item { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s; }
    .banned-user-item:last-child { border-bottom: none; }
    .banned-user-item:hover { background-color: #fdf2f2; }
    .banned-user-info { flex-grow: 1; }
    .banned-user-info strong { font-family: 'PrimaryFont', sans-serif; color: #333; display: block; margin-bottom: 4px; word-break: break-all; }
    .banned-user-info span { font-family: 'SecondaryFont', sans-serif; color: #666; font-size: 0.9em; display: block; margin-bottom: 2px; }
    .banned-user-item button { background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s, transform 0.2s; font-size: 0.9em; margin-left: 10px; font-family: 'PrimaryFont', sans-serif;  text-transform: uppercase; font-weight: bold; }
    .banned-user-item button:hover { background: #5a6268; transform: scale(1.05); }

    /* --- Data Management Section Styles --- */
    .data-management-content { display: none; }
    .data-management-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; }
    .data-section-column h4 { font-size: 1.2em; color: #333; margin: 0 0 15px; }

    .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .custom-checkbox { display: block; position: relative; padding-left: 35px; margin-bottom: 12px; cursor: pointer; font-size: 1em; -webkit-user-select: none; user-select: none; color: #444; }
    .custom-checkbox input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
    .checkmark { position: absolute; top: 0; left: 0; height: 25px; width: 25px; background-color: #eee; border-radius: 6px; transition: background-color 0.2s; }
    .custom-checkbox:hover input ~ .checkmark { background-color: #ccc; }
    .custom-checkbox input:checked ~ .checkmark { background-color: #2099bd; }
    .checkmark:after { content: ""; position: absolute; display: none; }
    .custom-checkbox input:checked ~ .checkmark:after { display: block; }
    .custom-checkbox .checkmark:after { left: 9px; top: 5px; width: 5px; height: 10px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
    
    /* --- NEW: Improved Password Validation List --- */
    #password-validation-list {
        list-style: none;
        padding: 0;
        margin: 15px 0 5px 0;
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        font-size: 0.9em;
        font-family: 'SecondaryFont', sans-serif;
    }

    #password-validation-list li {
        color: #8c96a3; /* Muted default color */
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        font-weight: 500;
    }

    #password-validation-list li::before {
        content: '●'; /* Small circle icon */
        font-size: 0.8em;
        margin-right: 8px;
        color: #e57373; /* Reddish circle for invalid */
        transition: all 0.3s ease;
    }

    #password-validation-list li.valid {
        color: #333; /* Darker text for valid */
    }

    #password-validation-list li.valid::before {
        content: '✔'; /* Checkmark for valid */
        color: #4CAF50; /* Green for valid */
        transform: scale(1.1);
    }
    
    /* --- NEW: Improved File Import Area --- */
    .import-area label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 25px 20px;
        background-color: #f8f9fa;
        color: #6c757d;
        border: 2px dashed #ced4da;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        box-sizing: border-box;
    }

    .import-area label:hover,
    .import-area label.dragover { /* Class for drag-and-drop feedback */
        background-color: #eef8ff;
        border-color: #2099bd;
        color: #2099bd;
    }

    .import-area label .import-icon {
        font-size: 2.5em;
        margin-bottom: 10px;
    }

    .import-area label .import-text {
        font-weight: 600;
        font-family: 'PrimaryFont', sans-serif;
    }

    .import-area input[type="file"] {
        display: none;
    }

    #fileNameDisplay {
        font-size: 0.9em;
        color: #555;
        margin-top: 8px;
        font-family: 'SecondaryFont', sans-serif;
        font-style: normal;
        font-weight: 500;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        padding: 0 10px;
    }
    
    /* --- Password Toggle Button Styles --- */
    .password-wrapper {
        position: relative;
    }
    .password-wrapper input[type="password"],
    .password-wrapper input[type="text"] {
        /* This padding is inherited from the generic .settings-form input rule */
        /* We just need to ensure there's enough space on the right */
        padding-right: 45px;
    }

    .password-toggle-btn {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        width: 32px;
        height: 32px;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        transition: background-color 0.2s;
    }

    .password-toggle-btn:hover {
        background-color: #e0e0e0;
    }

    .password-toggle-btn svg {
        width: 20px;
        height: 20px;
        color: #555;
    }

    .fade-in { animation: fadeIn 0.6s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .slide-in { animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    #notification-container { position: fixed; bottom: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }
    .notification-popup { padding: 12px 20px; border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-family: 'PrimaryFont', sans-serif; min-width: 250px; max-width: 350px; position: relative; animation: slideInFromRight 0.4s ease-in-out forwards; }
    .notification-popup.exiting { animation: slideOutToRight 0.4s ease-in-out forwards; }
    .notification-popup.success { background: linear-gradient(135deg, #28a745, #20c997); }
    .notification-popup.error { background: linear-gradient(135deg, #dc3545, #e83e8c); }
    .notification-popup.info { background: linear-gradient(135deg, #6720bd, #8a2be2); }
    .notification-counter { position: absolute; top: -8px; right: -8px; background-color: #ffc107; color: #333; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold; border: 2px solid white; transform: scale(0); animation: popIn 0.3s ease-out forwards; }
    @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
    @keyframes slideInFromRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideOutToRight { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
    @media (max-width: 768px) {
        .settings-container { flex-direction: column; }
        .sidebar { width: 100%; padding: 15px; }
        .sidebar.collapsed { width: 100%; }
        .main-content { padding: 20px; }
        .settings-section { padding: 20px; margin-bottom: 20px; }
        .dashboard-header { flex-direction: column; gap: 20px; text-align: center; }
        .action-buttons { justify-content: center; }
        #delete-section .reauth-btn { position: static; transform: none; margin-top: 15px; }
        .data-management-grid { grid-template-columns: 1fr; }
        #password-validation-list { grid-template-columns: 1fr; }
    }
    </style>
</head>
<body class="settings-page">
    <header class="main-header light-bg">
        <div class="container">
            <div class="logo">
                <a href="../index.html">
                    <img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer"/>
                </a>
            </div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="settings-container">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="others.html"><span class="icon">✨</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html" class="active"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content fade-in">
            <div class="dashboard-header">
                <h2 class="dashboard-title">Settings</h2>
            </div>

            <div class="quick-actions">
                <h3>Quick Settings</h3>
                <div class="action-buttons">
                    <button class="action-btn" onclick="document.getElementById('username-section').scrollIntoView({ behavior: 'smooth' });">
                        <span>👤</span> Edit Username
                    </button>
                    <button class="action-btn" id="changePasswordBtn" onclick="document.getElementById('password-section').scrollIntoView({ behavior: 'smooth' });">
                        <span>🔑</span> Change Password
                    </button>
                    <button class="action-btn" onclick="document.getElementById('panic-key-section').scrollIntoView({ behavior: 'smooth' });">
                        <span>🚨</span> Set Panic Key
                    </button>
                     <button class="action-btn" onclick="document.getElementById('tab-disguise-section').scrollIntoView({ behavior: 'smooth' });">
                        <span>🎭</span> Tab Disguise
                    </button>
                    <button class="action-btn" onclick="document.getElementById('data-management-section').scrollIntoView({ behavior: 'smooth' });">
                        <span>💾</span> Import/Export Data
                    </button>
                    <button class="action-btn" id="manageBansBtn" style="display: none;" onclick="document.getElementById('ban-management-section').scrollIntoView({ behavior: 'smooth' });">
                        <span>🚫</span> Manage Bans
                    </button>
                    <button class="action-btn" onclick="document.getElementById('delete-section').scrollIntoView({ behavior: 'smooth' });">
                        <span>🗑️</span> Delete Account
                    </button>
                </div>
            </div>
            
            <div class="user-info-section">
                <h3>Your Information</h3>
                <div class="user-info-detail">
                    <strong>Username:</strong> <span id="displayUsername">Loading...</span>
                </div>
                <div class="user-info-detail">
                    <strong>Email:</strong> <span id="displayEmail">Loading...</span>
                </div>
                <div class="user-info-detail">
                    <strong>Account Type:</strong> <span id="displayAccountType">Loading...</span>
                </div>
            </div>

            <section class="settings-section" id="username-section">
                <h3>Edit Username</h3>
                <p>You can change your username up to 10 times every 30 days, with a 1-minute cooldown between each change.</p>
                <div class="username-limit-container" id="usernameChangeInfoContainer">
                    <span class="username-limit-counter" id="usernameChangesLeft">--/--</span>
                    <button class="username-limit-info-btn">
                        i
                        <span class="username-limit-tooltip" id="usernameResetTooltip">Resets in -- days</span>
                    </button>
                </div>
                <form class="settings-form" id="username-form">
                    <div class="form-group">
                        <label for="newUsername">New Username (4-16 characters)</label>
                        <input type="text" id="newUsername" placeholder="Enter your new username..." required maxlength="16"/>
                    </div>
                    <div class="username-status-message" id="username-status"></div>
                    <button type="button" onclick="updateUsername()">Update Username</button>
                </form>
            </section>

            <section class="settings-section" id="panic-key-section">
                <h3>Set Panic Key</h3>
                <p>Configure a single key that will instantly redirect you to a specified URL. This setting is stored locally in this browser for privacy and speed.</p>
                <form class="settings-form" id="panic-key-form">
                    <div class="form-group">
                        <label for="panicKey">Key (Single, non-special character)</label>
                        <input type="text" id="panicKey" placeholder="e.g., p" required maxlength="1" />
                    </div>
                    <div class="form-group">
                        <label for="panicUrl">Redirect URL</label>
                        <input type="text" id="panicUrl" placeholder="e.g., google.com or classroom.google.com/" required />
                    </div>
                    <button type="button" onclick="savePanicKeySettingsLocal()">Save Panic Key</button>
                </form>
            </section>
            
            <section class="settings-section" id="tab-disguise-section">
                <h3>Tab Disguise</h3>
                <p>Change the appearance of the browser tab to blend in. This setting is saved locally on this browser and has a 5 second cooldown.</p>
                <form class="settings-form" id="tab-disguise-form">
                    <div class="form-group">
                        <label for="tab-preset">Choose a Preset</label>
                        <select id="tab-preset"></select>
                    </div>
                    <button type="button" id="saveTabPresetBtn">Save Preset</button>
                </form>
            </section>

            <section class="settings-section" id="password-section" data-disabled-message="PASSWORD CHANGES AREN'T AVAILABLE FOR OAUTH ACCOUNTS">
                <h3>Change Password</h3>
                <p>Update your account password for enhanced security. Your new password must be at least 6 characters long and different from your current password.</p>
                <div class="limit-info" id="passwordChangeInfo">
                    <span>Loading limit information...</span>
                </div>
                <form class="settings-form" id="password-form">
                    <div class="form-group">
                        <label for="oldPassword">Current Password</label>
                        <div class="password-wrapper">
                            <input type="password" id="oldPassword" placeholder="Enter your current password..." required/>
                            <button type="button" class="password-toggle-btn" data-target="oldPassword" aria-label="Toggle password visibility">
                                <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                <svg class="eye-off-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <div class="password-wrapper">
                            <input type="password" id="newPassword" placeholder="Enter new password..." required/>
                            <button type="button" class="password-toggle-btn" data-target="newPassword" aria-label="Toggle password visibility">
                                <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                <svg class="eye-off-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>
                            </button>
                        </div>
                    </div>
                    <button type="button" onclick="changePassword()">Change Password</button>
                </form>
            </section>

            <section class="settings-section" id="data-management-section">
                <h3>Import/Export Data</h3>
                <p>Securely back up your data to a file or restore from a backup. Your data is protected using industry-standard <strong>AES-GCM 256-bit</strong> encryption with a key derived from your password using <strong>PBKDF2 (SHA-256)</strong> with <strong>250,000 iterations</strong>, ensuring your backup is safe and secure.</p>
                <div class="data-management-content" id="data-management-content">
                    <div class="data-management-grid">
                        <div class="data-section-column">
                            <h4>Export Data</h4>
                            <p style="font-size: 0.9em; margin-top:-10px; margin-bottom: 20px;">Select which data categories you want to include in your backup file.</p>
                            <div class="checkbox-grid">
                                <label class="custom-checkbox">User Content
                                    <input type="checkbox" data-export-category="content" checked>
                                    <span class="checkmark"></span>
                                </label>
                                <label class="custom-checkbox">App Settings
                                    <input type="checkbox" data-export-category="configs" checked>
                                    <span class="checkmark"></span>
                                </label>
                                <label class="custom-checkbox">Page Layouts
                                    <input type="checkbox" data-export-category="layouts" checked>
                                    <span class="checkmark"></span>
                                </label>
                                <label class="custom-checkbox">Game Favorites
                                    <input type="checkbox" data-export-category="game_favorites" checked>
                                    <span class="checkmark"></span>
                                </label>
                                <label class="custom-checkbox">App State
                                    <input type="checkbox" data-export-category="states" checked>
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                            <form class="settings-form" id="export-data-form">
                                <div class="form-group">
                                    <label for="exportPassword">Create a Secure Password</label>
                                    <div class="password-wrapper">
                                        <input type="password" id="exportPassword" placeholder="Enter a strong password..." required>
                                        <button type="button" class="password-toggle-btn" data-target="exportPassword" aria-label="Toggle password visibility">
                                            <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                            <svg class="eye-off-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>
                                        </button>
                                    </div>
                                    <ul id="password-validation-list">
                                        <li id="length-check">At least 6 characters</li>
                                        <li id="number-check">Contains a number</li>
                                        <li id="special-check">Contains a special character</li>
                                    </ul>
                                </div>
                                <button type="button" id="exportDataBtn" disabled>Export Data</button>
                            </form>
                        </div>

                        <div class="data-section-column">
                            <h4>Import Data</h4>
                            <p style="font-size: 0.9em; margin-top:-10px; margin-bottom: 20px;">
                                <strong>Warning:</strong> Importing data will overwrite current data. This action cannot be undone.
                            </p>
                            <form class="settings-form" id="import-data-form">
                                <div class="form-group import-area">
                                     <label for="importFile" id="importFileLabel">
                                        <span class="import-icon">📤</span>
                                        <span class="import-text">Click or drag & drop a .4spdata file</span>
                                        <span id="fileNameDisplay">No file selected</span>
                                    </label>
                                    <input type="file" id="importFile" accept=".4spdata" />
                                </div>
                                <div class="form-group">
                                    <label for="importPassword">Enter Password</label>
                                    <div class="password-wrapper">
                                        <input type="password" id="importPassword" placeholder="Password for the backup file..." required>
                                        <button type="button" class="password-toggle-btn" data-target="importPassword" aria-label="Toggle password visibility">
                                            <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                            <svg class="eye-off-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>
                                        </button>
                                    </div>
                                    </div>
                                <button type="button" id="importDataBtn">Import Data</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="reauth-wrapper" id="data-reauth-wrapper">
                    <p style="text-align:center;"><strong>To protect your data, please re-authenticate to access this feature.</strong></p>
                    <form class="settings-form" id="data-email-reauth-form" style="display: none;">
                        <div class="form-group">
                            <input type="password" id="data-reauthPassword" placeholder="Enter password & press Enter..." required>
                        </div>
                    </form>
                    <button class="reauth-btn" id="data-reauthBtn" style="display: none; margin: 15px auto 0; display: block;">Reauthenticate</button>
                </div>
            </section>
            <section class="settings-section" id="ban-management-section" style="display: none;">
                <h3>🚫 Admin Ban Management</h3>
                <p>This panel is for site administrators only. You can ban existing accounts by their User ID (UID), or prevent new signups by banning an email address directly.</p>
                <h4>Ban User by UID</h4>
                <p style="font-size: 0.9em; color: #777;">Bans an existing user account, locking them out immediately. Find the UID on their profile or in the Firestore 'users' collection.</p>
                <form class="settings-form" id="uid-ban-form">
                    <div class="form-group">
                        <label for="banUserId">User ID to Ban</label>
                        <input type="text" id="banUserId" placeholder="Enter the full User ID (UID) of the user" required />
                    </div>
                    <div class="form-group">
                        <label for="uidBanReason">Reason for UID Ban</label>
                        <input type="text" id="uidBanReason" placeholder="e.g., Abusive behavior, spam" required />
                    </div>
                    <button type="button" onclick="addUidBan()">Add UID Ban</button>
                </form>
                <div class="banned-list-container" id="banned-uids-list">
                    <p style="text-align: center; color: #888; padding: 20px;">Loading banned UID list...</p>
                </div>

                <h4>Ban Email Address</h4>
                <p style="font-size: 0.9em; color: #777;">Prevents a new account from being created with this email address. Does not affect existing accounts.</p>
                <form class="settings-form" id="email-ban-form">
                    <div class="form-group">
                        <label for="banEmail">Email to Ban</label>
                        <input type="email" id="banEmail" placeholder="Enter the full email address to ban" required />
                    </div>
                    <div class="form-group">
                        <label for="emailBanReason">Reason for Email Ban</label>
                        <input type="text" id="emailBanReason" placeholder="e.g., Known spammer, ban evasion" required />
                    </div>
                    <button type="button" onclick="addEmailBan()">Add Email Ban</button>
                </form>
                <div class="banned-list-container" id="banned-emails-list">
                    <p style="text-align: center; color: #888; padding: 20px;">Loading banned email list...</p>
                </div>
            </section>
            
            <section class="settings-section" id="delete-section">
                <h3>Delete Account</h3>
                <p><strong>Warning:</strong> This action is permanent and cannot be undone. All your data, settings, and account information will be permanently removed from our system.</p>
                <form class="settings-form" id="delete-form" style="display: none;">
                     <p><strong>Verification successful.</strong> You may now permanently delete your account.</p>
                    <button type="button" class="delete" onclick="deleteAccount()">Delete Account Permanently</button>
                </form>
                <div class="reauth-wrapper" id="delete-reauth-wrapper">
                    <form class="settings-form" id="email-reauth-form" style="display: none;">
                        <div class="form-group">
                            <label for="reauthPassword">To protect your account, please confirm your password.</label>
                            <input type="password" id="reauthPassword" placeholder="Enter password & press Enter..." required>
                        </div>
                    </form>
                    <button class="reauth-btn" id="reauthBtn" style="display: none;">Reauthenticate</button>
                </div>
            </section>
        </main>
    </div>

    <div id="notification-container"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
        // --- Globals ---
        let authMethod = 'password';
        let isReauthenticatedForDelete = false;
        let isReauthenticatedForData = false;
        let currentPanicSettings = null;
        let isAdmin = false;
        let tabCooldownInterval = null;
        
        const activeNotifications = new Map();
        const pressedKeys = new Set();
        
        const dbRef = () => firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid);

        // --- Existing Page Logic (updateLimitDisplays, auth listener, etc.) ---
        // NOTE: The original JavaScript for this page is included here, with modifications
        // and new additions for the data management feature.

        async function updateLimitDisplays() {
            const user = firebase.auth().currentUser; if (!user) return;
            const userDoc = await dbRef().get(); const userData = userDoc.exists ? userDoc.data() : {};
            const usernameChangesLeftEl = document.getElementById('usernameChangesLeft');
            const usernameResetTooltipEl = document.getElementById('usernameResetTooltip');
            const usernameForm = document.getElementById('username-form');
            const usernameButton = usernameForm.querySelector('button');
            const usernameInput = usernameForm.querySelector('input');
            const usernameStatusEl = document.getElementById('username-status');
            const USERNAME_CHANGE_LIMIT = 10;
            const PERIOD_MS = 30 * 24 * 60 * 60 * 1000;
            const COOLDOWN_MS = 60 * 1000;
            const { usernameChangeCount = 0, usernameChangePeriodStart = null, lastUsernameChange = null } = userData;
            let inCurrentPeriod = false;
            if (usernameChangePeriodStart && usernameChangePeriodStart.toDate) {
                if ((Date.now() - usernameChangePeriodStart.toDate().getTime()) < PERIOD_MS) { inCurrentPeriod = true; }
            }
            const remainingChanges = inCurrentPeriod ? USERNAME_CHANGE_LIMIT - usernameChangeCount : USERNAME_CHANGE_LIMIT;
            usernameChangesLeftEl.textContent = `${remainingChanges}/${USERNAME_CHANGE_LIMIT}`;
            const resetTime = usernameChangePeriodStart ? usernameChangePeriodStart.toDate().getTime() + PERIOD_MS : Date.now() + PERIOD_MS;
            const daysRemaining = Math.ceil((resetTime - Date.now()) / (1000 * 60 * 60 * 24));
            usernameResetTooltipEl.textContent = `Resets in ${daysRemaining} day(s)`;
            let onMinuteCooldown = false;
            let cooldownMessage = '';
            if (lastUsernameChange && lastUsernameChange.toDate) {
                const timeSinceChange = Date.now() - lastUsernameChange.toDate().getTime();
                if (timeSinceChange < COOLDOWN_MS) {
                    onMinuteCooldown = true;
                    const secondsRemaining = Math.ceil((COOLDOWN_MS - timeSinceChange) / 1000);
                    cooldownMessage = `Username change on cooldown for ${secondsRemaining}s.`;
                }
            }
            const hasNoMonthlyChanges = inCurrentPeriod && usernameChangeCount >= USERNAME_CHANGE_LIMIT;
            if (hasNoMonthlyChanges) {
                 usernameStatusEl.textContent = 'You have used all username changes for this month.';
            } else if (onMinuteCooldown) {
                 usernameStatusEl.textContent = cooldownMessage;
            } else {
                 usernameStatusEl.textContent = '';
            }
            const isDisabled = onMinuteCooldown || hasNoMonthlyChanges;
            usernameButton.disabled = isDisabled;
            usernameInput.disabled = isDisabled;

            const passwordInfoEl = document.getElementById('passwordChangeInfo');
            const passwordSection = document.getElementById('password-section');
            const passwordFormInputs = document.querySelectorAll('#password-form input, #password-form button');
            if (authMethod === 'google' || authMethod === 'github') {
                passwordSection.classList.add('disabled');
                passwordSection.setAttribute('data-disabled-message', `PASSWORD CHANGES AREN'T AVAILABLE FOR ${authMethod.toUpperCase()} ACCOUNTS`);
                passwordInfoEl.style.display = 'none';
                return; 
            }
            passwordSection.classList.remove('disabled');
            passwordInfoEl.style.display = 'block';
            const PASSWORD_COOLDOWN_MS = 14 * 24 * 60 * 60 * 1000;
            const { lastPasswordChange: lastPassChange } = userData;
            let onPasswordCooldown = false;
            if (lastPassChange && lastPassChange.toDate) {
                const timeSinceChange = Date.now() - lastPassChange.toDate().getTime();
                if (timeSinceChange < PASSWORD_COOLDOWN_MS) {
                    onPasswordCooldown = true;
                    const daysRemainingPass = Math.ceil((PASSWORD_COOLDOWN_MS - timeSinceChange) / (1000 * 60 * 60 * 24));
                    passwordInfoEl.innerHTML = `You can change your password again in <strong>${daysRemainingPass} day(s)</strong>.`;
                    passwordInfoEl.classList.add('on-cooldown');
                }
            }
            if (!onPasswordCooldown) {
                passwordInfoEl.innerHTML = `You can change your password once every <strong>14 days</strong> for security.`;
                passwordInfoEl.classList.remove('on-cooldown');
            }
            passwordFormInputs.forEach(input => input.disabled = onPasswordCooldown);
        }

        firebase.auth().onAuthStateChanged(async user => {
            if (!user) { return location.href = '../login.html'; }
            if (user.email === '4simpleproblems@gmail.com') { isAdmin = true; initializeAdminFeatures(); }
            document.getElementById('displayEmail').textContent = user.email;
            const doc = await dbRef().get(); const userData = doc.exists ? doc.data() : {};
            const username = userData.username || user.displayName || 'No name';
            document.getElementById('displayUsername').textContent = username;
            if (userData.username) { document.getElementById('newUsername').value = userData.username; }
            loadPanicKeySettingsLocal();
            const isGoogle = user.providerData.some(p => p.providerId === 'google.com');
            const isGithub = user.providerData.some(p => p.providerId === 'github.com');
            let accountTypeText = 'Email/Password Account';
            if (isGoogle) { authMethod = 'google'; accountTypeText = 'Google Account';
            } else if (isGithub) { authMethod = 'github'; accountTypeText = 'GitHub Account';
            } else { authMethod = 'password'; }
            document.getElementById('displayAccountType').textContent = accountTypeText;
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            changePasswordBtn.style.display = (authMethod !== 'password') ? 'none' : 'flex';
            await updateLimitDisplays();
            setupDeleteAccountSection();
            setupDataManagementSection(); // New function call
            initializeTabDisguise();
        });
        
        const LOCAL_DB_NAME = 'userLocalSettingsDB';
        const LOCAL_STORE_NAME = 'panicKeyStore';
        const LOCAL_SETTINGS_ID = 'currentPanicSettings';

        function openLocalDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(LOCAL_DB_NAME, 1);
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(LOCAL_STORE_NAME)) {
                        db.createObjectStore(LOCAL_STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function loadPanicKeySettingsLocal() {
            try {
                const db = await openLocalDB();
                const transaction = db.transaction(LOCAL_STORE_NAME, 'readonly');
                const store = transaction.objectStore(LOCAL_STORE_NAME);
                const request = store.get(LOCAL_SETTINGS_ID);
                request.onsuccess = () => {
                    const settings = request.result;
                    if (settings) {
                        currentPanicSettings = settings; 
                        document.getElementById('panicKey').value = settings.key || '';
                        const displayUrl = (settings.url || '').replace(/^https?:\/\//, '');
                        document.getElementById('panicUrl').value = displayUrl;
                    }
                    db.close();
                };
                request.onerror = () => { console.error("Error loading panic key from local DB", request.error); db.close(); }
            } catch (error) { console.error("Could not open local DB for loading", error); }
        }

        async function savePanicKeySettingsLocal() {
            const key = document.getElementById('panicKey').value;
            let url = document.getElementById('panicUrl').value.trim();
            if (!key || key.length !== 1) return showNotification('error', 'Please enter a single character for the panic key.');
            if (/[!@#$%^&*()_+~{}|:"<>?]/.test(key) || key !== key.toLowerCase()) return showNotification('error', 'Panic key cannot be a capital letter or a special character.');
            if (!url) return showNotification('error', 'Please enter a URL for redirection.');
            const urlRegex = /^((https?):\/\/)?(www.)?([a-zA-Z0-9]+(-[a-zA-Z0-9]+)*\.)+[a-zA-Z]{2,}\/?$/;
            if (!urlRegex.test(url)) { return showNotification('error', 'Invalid URL. Enter a domain like "google.com".'); }
            if (!/^https?:\/\//i.test(url)) { url = 'https://' + url; }
            const newSettings = { id: LOCAL_SETTINGS_ID, key, url };
            try {
                const db = await openLocalDB();
                const transaction = db.transaction(LOCAL_STORE_NAME, 'readwrite');
                const store = transaction.objectStore(LOCAL_STORE_NAME);
                const request = store.put(newSettings);
                request.onsuccess = () => { currentPanicSettings = newSettings; showNotification('success', 'Panic key settings saved successfully!'); };
                request.onerror = () => showNotification('error', 'Could not save settings locally: ' + request.error);
                transaction.oncomplete = () => db.close();
            } catch (error) { showNotification('error', 'Could not open local DB for saving: ' + error.message); }
        }

        function initializeTabDisguise() {
            if (typeof urlChanger === 'undefined') { return; }
            const select = document.getElementById('tab-preset');
            const saveBtn = document.getElementById('saveTabPresetBtn');
            const COOLDOWN_SECONDS = 5;
            select.innerHTML = ''; 
            urlChanger.presets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.name;
                option.textContent = preset.name;
                select.appendChild(option);
            });
            const savedPreset = localStorage.getItem('selectedUrlPreset') || 'None';
            select.value = savedPreset;
            function handleCooldown() {
                if (tabCooldownInterval) clearInterval(tabCooldownInterval);
                const lastSave = parseInt(localStorage.getItem('tabPresetLastSave') || '0');
                const now = Date.now();
                const timeSinceSave = (now - lastSave);
                const cooldownMillis = COOLDOWN_SECONDS * 1000;
                if (timeSinceSave < cooldownMillis) {
                    saveBtn.disabled = true;
                    const updateTimer = () => {
                        const newTimeLeft = Math.ceil((cooldownMillis - (Date.now() - lastSave)) / 1000);
                        if (newTimeLeft <= 0) {
                            clearInterval(tabCooldownInterval);
                            saveBtn.disabled = false;
                            saveBtn.textContent = 'Save Preset';
                        } else {
                            saveBtn.textContent = `Wait ${newTimeLeft}s`;
                        }
                    };
                    updateTimer();
                    tabCooldownInterval = setInterval(updateTimer, 1000);
                } else {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Preset';
                }
            }
            saveBtn.addEventListener('click', () => {
                const selectedValue = select.value;
                urlChanger.savePreset(selectedValue);
                localStorage.setItem('tabPresetLastSave', Date.now().toString());
                showNotification('success', `Tab preset saved as "${selectedValue}".`);
                handleCooldown();
            });
            handleCooldown();
        }
        
        function initializeAdminFeatures() { document.getElementById('manageBansBtn').style.display = 'flex'; document.getElementById('ban-management-section').style.display = 'block'; listenForUidBans(); listenForEmailBans(); }
        function listenForUidBans() { const uidBansRef = firebase.firestore().collection('bans'); const bannedUidsList = document.getElementById('banned-uids-list'); uidBansRef.orderBy('bannedAt', 'desc').onSnapshot(snapshot => { bannedUidsList.innerHTML = snapshot.empty ? '<p style="text-align: center; color: #888; padding: 20px;">No users are currently banned by UID.</p>' : ''; snapshot.forEach(doc => renderBanItem(doc, bannedUidsList, 'UID', 'removeUidBan')); }, error => console.error("Error listening to UID ban collection:", error)); }
        function listenForEmailBans() { const emailBansRef = firebase.firestore().collection('bannedEmails'); const bannedEmailsList = document.getElementById('banned-emails-list'); emailBansRef.orderBy('bannedAt', 'desc').onSnapshot(snapshot => { bannedEmailsList.innerHTML = snapshot.empty ? '<p style="text-align: center; color: #888; padding: 20px;">No emails are currently banned.</p>' : ''; snapshot.forEach(doc => renderBanItem(doc, bannedEmailsList, 'Email', 'removeEmailBan')); }, error => console.error("Error listening to email ban collection:", error)); }
        function renderBanItem(doc, listElement, type, removeFunction) { const banData = doc.data(); const banDate = banData.bannedAt ? banData.bannedAt.toDate().toLocaleString() : 'N/A'; const item = document.createElement('div'); item.className = 'banned-user-item'; item.innerHTML = `<div class="banned-user-info"><strong>${type}:</strong><span>${doc.id}</span><strong>Reason:</strong><span>${banData.reason || 'N/A'}</span><strong>Banned By:</strong><span>${banData.bannedBy || 'N/A'} on ${banDate}</span></div><button onclick="${removeFunction}('${doc.id}')">Remove Ban</button>`; listElement.appendChild(item); }
        async function addUidBan() { if (!isAdmin) return; const userIdToBan = document.getElementById('banUserId').value.trim(); const reason = document.getElementById('uidBanReason').value.trim(); if (!userIdToBan || !reason) return showNotification('error', 'Please enter a User ID and a reason.'); const userDoc = await firebase.firestore().collection('users').doc(userIdToBan).get(); if (!userDoc.exists) return showNotification('error', 'Cannot ban: No user found with that ID.'); addBan('bans', userIdToBan, reason, 'banUserId', 'uidBanReason'); }
        async function addEmailBan() { if (!isAdmin) return; const emailToBan = document.getElementById('banEmail').value.trim().toLowerCase(); const reason = document.getElementById('emailBanReason').value.trim(); if (!emailToBan || !reason) return showNotification('error', 'Please enter an email and a reason.'); if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailToBan)) return showNotification('error', 'Invalid email format.'); addBan('bannedEmails', emailToBan, reason, 'banEmail', 'emailBanReason'); }
        async function addBan(collection, id, reason, inputId, reasonInputId) { try { await firebase.firestore().collection(collection).doc(id).set({ reason: reason, bannedBy: firebase.auth().currentUser.email, bannedAt: firebase.firestore.FieldValue.serverTimestamp() }); showNotification('success', `${id} has been successfully banned.`); document.getElementById(inputId).value = ''; document.getElementById(reasonInputId).value = ''; } catch (error) { showNotification('error', `Failed to add ban: ${error.message}`); } }
        async function removeUidBan(uid) { removeBan('bans', uid); }
        async function removeEmailBan(email) { removeBan('bannedEmails', email); }
        async function removeBan(collection, id) { if (!isAdmin) return; if (!confirm(`Are you sure you want to remove this ban for ${id}?`)) return; try { await firebase.firestore().collection(collection).doc(id).delete(); showNotification('success', `Ban for ${id} has been successfully removed.`); } catch (error) { showNotification('error', `Failed to remove ban: ${error.message}`); } }
        function setupDeleteAccountSection() { const deleteSection = document.getElementById('delete-section'); const deleteForm = document.getElementById('delete-form'); const emailReauthForm = document.getElementById('email-reauth-form'); const reauthBtn = document.getElementById('reauthBtn'); isReauthenticatedForDelete = false; deleteForm.style.display = 'none'; emailReauthForm.style.display = 'none'; reauthBtn.style.display = 'none'; deleteSection.classList.remove('disabled', 'fadeout'); if (authMethod === 'google' || authMethod === 'github') { deleteSection.classList.add('disabled'); const providerName = authMethod.charAt(0).toUpperCase() + authMethod.slice(1); deleteSection.setAttribute('data-disabled-message', `Reauthenticate with your ${providerName} account to enable account deletion`); reauthBtn.textContent = `Reauthenticate with ${providerName}`; reauthBtn.style.display = 'block'; reauthBtn.onclick = () => reauthenticate('delete'); } else { emailReauthForm.style.display = 'flex'; } }
        async function updateUsername() { if (document.getElementById('newUsername').disabled) { return; } const newNameRaw = document.getElementById('newUsername').value.trim(); const currentName = document.getElementById('displayUsername').textContent; if (newNameRaw === currentName) { return showNotification('info', 'This is already your username.'); } if (newNameRaw.length < 4 || newNameRaw.length > 16) return showNotification('error', 'Username must be 4-16 characters.'); if (!/^[a-zA-Z0-9.\?\!@#$%&*-]+$/.test(newNameRaw)) return showNotification('error', 'Username contains invalid characters.'); try { const userDoc = await dbRef().get(); const userData = userDoc.data() || {}; const { usernameChangeCount = 0, usernameChangePeriodStart = null, lastUsernameChange = null } = userData; if(lastUsernameChange && (Date.now() - lastUsernameChange.toDate().getTime() < 60000)) { await updateLimitDisplays(); return; } const isNewPeriod = !usernameChangePeriodStart || (Date.now() - usernameChangePeriodStart.toDate().getTime() > 30 * 24 * 60 * 60 * 1000); if (!isNewPeriod && usernameChangeCount >= 10) { await updateLimitDisplays(); return; } const response = await fetch(`https://www.purgomalum.com/service/json?text=${encodeURIComponent(newNameRaw)}`); if (!response.ok) throw new Error('Profanity filter unavailable.'); const data = await response.json(); const filteredName = data.result; if (filteredName.includes('*')) { showNotification('info', 'Your username contained inappropriate words and has been filtered. This still counts as a change.'); } const updatePayload = isNewPeriod ? { username: filteredName, usernameChangeCount: 1, usernameChangePeriodStart: firebase.firestore.FieldValue.serverTimestamp(), lastUsernameChange: firebase.firestore.FieldValue.serverTimestamp() } : { username: filteredName, usernameChangeCount: firebase.firestore.FieldValue.increment(1), lastUsernameChange: firebase.firestore.FieldValue.serverTimestamp() }; await dbRef().update(updatePayload); document.getElementById('displayUsername').textContent = filteredName; document.getElementById('newUsername').value = filteredName; showNotification('success', 'Username updated successfully!'); await updateLimitDisplays(); } catch (error) { showNotification('error', `Failed to update username: ${error.message}`); } }
        async function changePassword() { if (document.getElementById('newPassword').disabled) return; const user = firebase.auth().currentUser; const oldPassword = document.getElementById('oldPassword').value; const newPassword = document.getElementById('newPassword').value; if (!oldPassword || newPassword.length < 6 || oldPassword === newPassword) { return showNotification('error', 'Please check your passwords. The new password must be at least 6 characters and different from the old one.'); } try { await user.reauthenticateWithCredential(firebase.auth.EmailAuthProvider.credential(user.email, oldPassword)); await user.updatePassword(newPassword); await dbRef().update({ lastPasswordChange: firebase.firestore.FieldValue.serverTimestamp() }); document.getElementById('oldPassword').value = ''; document.getElementById('newPassword').value = ''; showNotification('success', 'Password changed successfully!'); await updateLimitDisplays(); } catch (error) { showNotification('error', `Failed to change password: ${error.code === 'auth/wrong-password' ? 'Current password is incorrect.' : error.message}`); } }
        async function deleteAccount() { if (!isReauthenticatedForDelete) { return showNotification('error', 'Please re-authenticate before deleting your account.'); } if (!confirm('Are you absolutely certain? This cannot be undone.') || !confirm('Last chance! This will permanently delete everything. Proceed?')) { return; } const user = firebase.auth().currentUser; try { await dbRef().delete(); await user.delete(); alert('Account permanently deleted. Redirecting...'); location.href = '../signup.html'; } catch (error) { let msg = 'Failed to delete account: '; if (error.code === 'auth/requires-recent-login') { msg += 'Your session has expired. Please re-authenticate and try again.'; setupDeleteAccountSection(); } else { msg += error.message; } showNotification('error', msg); } }
        function showNotification(type, text) { const DURATION = 10000; const container = document.getElementById('notification-container'); const key = `${type}-${text}`; if (activeNotifications.has(key)) { const existing = activeNotifications.get(key); let count = parseInt(existing.counter.textContent) || 1; count++; existing.counter.textContent = count > 10 ? '10+' : count; existing.counter.style.display = 'flex'; clearTimeout(existing.timerId); existing.timerId = setTimeout(() => removeNotification(key), DURATION); return; } const notification = document.createElement('div'); notification.className = `notification-popup ${type}`; notification.textContent = text; const counter = document.createElement('span'); counter.className = 'notification-counter'; counter.style.display = 'none'; notification.appendChild(counter); const timerId = setTimeout(() => removeNotification(key), DURATION); activeNotifications.set(key, { element: notification, timerId: timerId, counter: counter }); container.appendChild(notification); }
        function removeNotification(key) { if (activeNotifications.has(key)) { const { element, timerId } = activeNotifications.get(key); clearTimeout(timerId); element.classList.add('exiting'); element.addEventListener('animationend', () => { if (element.parentNode) { element.parentNode.removeChild(element); } }, { once: true }); activeNotifications.delete(key); } }
        function clearAllNotifications() { activeNotifications.forEach((value, key) => removeNotification(key)); }
        document.addEventListener('keydown', (event) => { pressedKeys.add(event.code); if (pressedKeys.has('ShiftLeft') || pressedKeys.has('ShiftRight')) { if (pressedKeys.has('KeyC') && pressedKeys.has('KeyN')) { clearAllNotifications(); } } });
        document.addEventListener('keyup', (event) => { pressedKeys.delete(event.code); });
        document.getElementById('logoutBtn').onclick = document.getElementById('signOutLink').onclick = () => { firebase.auth().signOut().then(() => { location.href = '../login.html'; }); };
        const toggleSidebarBtn = document.getElementById('toggleSidebar'); const sidebar = document.getElementById('sidebar'); toggleSidebarBtn.addEventListener('click', () => { sidebar.classList.toggle('collapsed'); });
        
        // --- START: NEW & IMPROVED DATA MANAGEMENT SCRIPT ---

        // This DataManager object is designed to be robust, especially for handling IndexedDB operations.
        const DataManager = {
            // Helper to open a DB and ensure the object store exists.
            _openDBAndEnsureStore: (dbName, storeName) => new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onerror = () => reject(`Failed to open DB: ${dbName}`);
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(storeName)) {
                        // All relevant stores use 'id' as the keyPath.
                        db.createObjectStore(storeName, { keyPath: 'id' });
                    }
                };
                request.onsuccess = event => resolve(event.target.result);
            }),

            _getAllFromDB: async (dbName, storeName) => {
                try {
                    const db = await DataManager._openDBAndEnsureStore(dbName, storeName);
                    return new Promise((resolve, reject) => {
                        const transaction = db.transaction(storeName, 'readonly');
                        const store = transaction.objectStore(storeName);
                        const getAllRequest = store.getAll();
                        getAllRequest.onsuccess = () => resolve(getAllRequest.result);
                        getAllRequest.onerror = () => reject(`Failed to read from store: ${storeName}`);
                        transaction.oncomplete = () => db.close();
                    });
                } catch (e) {
                     // If the DB can't be opened, resolve with an empty array.
                    console.error(`Error in _getAllFromDB for ${dbName}:`, e);
                    return [];
                }
            },

            _clearAndWriteToDB: async (dbName, storeName, data) => {
                const db = await DataManager._openDBAndEnsureStore(dbName, storeName);
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(storeName, 'readwrite');
                    transaction.oncomplete = () => { db.close(); resolve(); };
                    transaction.onerror = () => reject(`Transaction error while writing to ${storeName}`);
                    
                    const store = transaction.objectStore(storeName);
                    const clearRequest = store.clear();
                    clearRequest.onsuccess = () => {
                        if (data && data.length > 0) {
                            data.forEach(item => store.put(item));
                        }
                    };
                });
            },

            gatherData: async (categories) => {
                const user = firebase.auth().currentUser;
                if (!user) throw new Error("User not authenticated.");
                const dataToExport = {};
                
                const keyMap = {
                    content: { 
                        idb: [['NotesDB', 'notes'], ['PlaylistsDB', 'playlists'], ['GradesDB_v2', 'folders']], 
                        ls_user: ['countdowns', 'slotz_balance', 'slotz_scores'] 
                    },
                    configs: { 
                        idb: [['userLocalSettingsDB', 'panicKeyStore']], 
                        ls_global: ['soundboardSettingsV21', 'playlistsSettings_v1', 'weatherWidgetSettings', '4sp_quickActions_v1', 'selectedUrlPreset'] 
                    },
                    layouts: { 
                        ls_global: ['4sp_dashboardLayout_v2_super', '4sp_othersPageLayout_v16_list'] 
                    },
                    states: { 
                        ls_global: ['4sp_stopwatchState_v4', '4sp_timerState_v4', 'hasSeenWelcomePopup'], 
                        ls_user: ['lastActiveId', 'fsColor'] 
                    },
                    game_favorites: { 
                        ls_global: ['gnGameFavorites_v1'] 
                    }
                };
                
                dataToExport.indexedDBData = {};
                dataToExport.localStorageData = {};

                for (const category of categories) {
                    const catKeys = keyMap[category];
                    if (catKeys.idb) {
                        for (const [dbName, storeName] of catKeys.idb) {
                            const dbData = await DataManager._getAllFromDB(dbName, storeName);
                            if (!dataToExport.indexedDBData[dbName]) dataToExport.indexedDBData[dbName] = {};
                            dataToExport.indexedDBData[dbName][storeName] = dbData;
                        }
                    }
                    if (catKeys.ls_global) {
                        catKeys.ls_global.forEach(key => {
                            const value = localStorage.getItem(key);
                            if (value !== null) dataToExport.localStorageData[key] = value;
                        });
                    }
                    if (catKeys.ls_user) {
                        catKeys.ls_user.forEach(key => {
                            const userKey = `4sp_${key}_${user.uid}`;
                            const value = localStorage.getItem(userKey);
                            if (value !== null) dataToExport.localStorageData[userKey] = value;
                        });
                    }
                }
                return dataToExport;
            },

            applyData: async (dataObject) => {
                const user = firebase.auth().currentUser;
                if (!user) throw new Error("User not authenticated.");
                const applyPromises = [];

                if (dataObject.indexedDBData) {
                    for (const dbName in dataObject.indexedDBData) {
                        for (const storeName in dataObject.indexedDBData[dbName]) {
                            const data = dataObject.indexedDBData[dbName][storeName];
                            applyPromises.push(DataManager._clearAndWriteToDB(dbName, storeName, data));
                        }
                    }
                }

                if (dataObject.localStorageData) {
                    // It's safer to clear certain localStorage keys before importing
                    // to avoid conflicts, but for this app, overwriting is sufficient.
                    for (const key in dataObject.localStorageData) {
                        localStorage.setItem(key, dataObject.localStorageData[key]);
                    }
                }
                await Promise.all(applyPromises);
            },

            _getPasswordKey: (password) => window.crypto.subtle.importKey('raw', new TextEncoder().encode(password), 'PBKDF2', false, ['deriveKey']),
            _deriveKey: (passwordKey, salt, keyUsage) => window.crypto.subtle.deriveKey({ name: 'PBKDF2', salt, iterations: 250000, hash: 'SHA-256' }, passwordKey, { name: 'AES-GCM', length: 256 }, true, keyUsage),
            
            encrypt: async (data, password) => {
                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const passwordKey = await DataManager._getPasswordKey(password);
                const aesKey = await DataManager._deriveKey(passwordKey, salt, ['encrypt']);
                const encryptedContent = await window.crypto.subtle.encrypt({ name: 'AES-GCM', iv }, aesKey, new TextEncoder().encode(JSON.stringify(data)));
                const bufferToBase64 = buffer => btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)));
                return JSON.stringify({ salt: bufferToBase64(salt), iv: bufferToBase64(iv), data: bufferToBase64(encryptedContent) });
            },
            
            decrypt: async (encryptedData, password) => {
                const base64ToBuffer = b64 => Uint8Array.from(atob(b64), c => c.charCodeAt(0));
                const { salt: b64Salt, iv: b64Iv, data: b64Data } = JSON.parse(encryptedData);
                const salt = base64ToBuffer(b64Salt);
                const iv = base64ToBuffer(b64Iv);
                const data = base64ToBuffer(b64Data);
                const passwordKey = await DataManager._getPasswordKey(password);
                const aesKey = await DataManager._deriveKey(passwordKey, salt, ['decrypt']);
                const decryptedContent = await window.crypto.subtle.decrypt({ name: 'AES-GCM', iv }, aesKey, data);
                return JSON.parse(new TextDecoder().decode(decryptedContent));
            }
        };

        function setupDataManagementSection() {
            const dataContent = document.getElementById('data-management-content');
            const reauthWrapper = document.getElementById('data-reauth-wrapper');
            const emailReauthForm = document.getElementById('data-email-reauth-form');
            const reauthBtn = document.getElementById('data-reauthBtn');
            const reauthPasswordInput = document.getElementById('data-reauthPassword');
            isReauthenticatedForData = false;
            dataContent.style.display = 'none';
            reauthWrapper.style.display = 'block';
            emailReauthForm.style.display = 'none';
            reauthBtn.style.display = 'none';
            if (authMethod === 'google' || authMethod === 'github') {
                const providerName = authMethod.charAt(0).toUpperCase() + authMethod.slice(1);
                reauthBtn.textContent = `Reauthenticate with ${providerName}`;
                reauthBtn.style.display = 'block';
                reauthBtn.onclick = () => reauthenticate('data');
            } else { emailReauthForm.style.display = 'block'; }
            reauthPasswordInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') { event.preventDefault(); reauthenticateWithPassword('data', reauthPasswordInput.value); } });
        }
        
        async function reauthenticateWithPassword(section, password) {
            const user = firebase.auth().currentUser;
            const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
            try {
                await user.reauthenticateWithCredential(credential);
                if (section === 'delete') {
                    isReauthenticatedForDelete = true;
                    document.getElementById('email-reauth-form').style.display = 'none';
                    document.getElementById('delete-form').style.display = 'flex';
                } else if (section === 'data') {
                    isReauthenticatedForData = true;
                    document.getElementById('data-reauth-wrapper').style.display = 'none';
                    document.getElementById('data-management-content').style.display = 'block';
                }
            } catch (error) { const msg = error.code === 'auth/wrong-password' ? 'Authentication failed. Incorrect password.' : `Auth failed: ${error.message}`; showNotification('error', msg); }
        }
        
        async function reauthenticate(section) {
            let provider;
            if (authMethod === 'google') provider = new firebase.auth.GoogleAuthProvider();
            else if (authMethod === 'github') provider = new firebase.auth.GithubAuthProvider();
            else return;
            try {
                await firebase.auth().currentUser.reauthenticateWithPopup(provider);
                if (section === 'delete') {
                    isReauthenticatedForDelete = true;
                    const sectionEl = document.getElementById('delete-section');
                    sectionEl.classList.add('fadeout');
                    document.getElementById('delete-reauth-wrapper').style.display = 'none';
                    setTimeout(() => { sectionEl.classList.remove('disabled', 'fadeout'); document.getElementById('delete-form').style.display = 'flex'; }, 1000);
                } else if (section === 'data') {
                    isReauthenticatedForData = true;
                    document.getElementById('data-reauth-wrapper').style.display = 'none';
                    document.getElementById('data-management-content').style.display = 'block';
                }
            } catch (error) { showNotification('error', `Reauthentication failed: ${error.message}`); }
        }
        
        const exportPasswordInput = document.getElementById('exportPassword');
        const exportBtn = document.getElementById('exportDataBtn');
        const validationChecks = { length: document.getElementById('length-check'), number: document.getElementById('number-check'), special: document.getElementById('special-check') };
        exportPasswordInput.addEventListener('input', () => {
            const pw = exportPasswordInput.value;
            const validations = { length: pw.length >= 6, number: /\d/.test(pw), special: /[!@#$%^&*(),.?":{}|<>]/.test(pw) };
            let allValid = true;
            for (const key in validations) { validationChecks[key].classList.toggle('valid', validations[key]); if (!validations[key]) allValid = false; }
            exportBtn.disabled = !allValid;
        });

        exportBtn.addEventListener('click', async () => {
            const password = exportPasswordInput.value;
            if (exportBtn.disabled) { showNotification('error', 'Password does not meet the requirements.'); return; }
            exportBtn.textContent = 'Gathering...'; exportBtn.disabled = true;
            const selectedCategories = [...document.querySelectorAll('[data-export-category]:checked')].map(cb => cb.dataset.exportCategory);
            if (selectedCategories.length === 0) { showNotification('info', 'Please select at least one data category to export.'); exportBtn.textContent = 'Export Data'; exportPasswordInput.dispatchEvent(new Event('input')); return; }
            try {
                const data = await DataManager.gatherData(selectedCategories);
                exportBtn.textContent = 'Encrypting...';
                const encryptedData = await DataManager.encrypt(data, password);
                const blob = new Blob([encryptedData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().slice(0, 10);
                a.download = `4sp_backup_${date}.4spdata`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('success', 'Data exported successfully!');
            } catch (err) { console.error("Export failed:", err); showNotification('error', `Export failed: ${err.message}`); } 
            finally { exportBtn.textContent = 'Export Data'; exportPasswordInput.dispatchEvent(new Event('input')); }
        });
        
        const importFileEl = document.getElementById('importFile');
        const importBtn = document.getElementById('importDataBtn');

        importBtn.addEventListener('click', () => {
            const file = importFileEl.files[0];
            const password = document.getElementById('importPassword').value;
            if (!file) { return showNotification('error', 'Please select a file to import.'); }
            if (!password) { return showNotification('error', 'Please enter the password for the file.'); }
            if (!confirm("Are you sure? Importing this file will overwrite existing data in the categories backed up in the file. This cannot be undone.")) {
                return;
            }
            const reader = new FileReader();
            reader.onload = async (event) => {
                importBtn.textContent = 'Importing...'; importBtn.disabled = true;
                try {
                    const decryptedData = await DataManager.decrypt(event.target.result, password);
                    await DataManager.applyData(decryptedData);
                    showNotification('success', 'Data imported successfully! The page will now reload.');
                    setTimeout(() => window.location.reload(), 2000);
                } catch (err) { console.error("Import failed:", err); showNotification('error', 'Import failed. Check password or file integrity.'); importBtn.textContent = 'Import Data'; importBtn.disabled = false; }
            };
            reader.readAsText(file);
        });

        // --- NEW: File Import UI and Drag & Drop Logic ---
        const importLabel = document.getElementById('importFileLabel');
        const importInput = document.getElementById('importFile');
        const importFileName = document.getElementById('fileNameDisplay');
        const importText = importLabel.querySelector('.import-text');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          importLabel.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
          document.body.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
          importLabel.addEventListener(eventName, () => importLabel.classList.add('dragover'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
          importLabel.addEventListener(eventName, () => importLabel.classList.remove('dragover'), false);
        });
        importLabel.addEventListener('drop', (e) => {
          const files = e.dataTransfer.files;
          if (files.length > 0 && files[0].name.endsWith('.4spdata')) {
            importInput.files = files;
            importInput.dispatchEvent(new Event('change')); // Trigger change event
          } else {
            showNotification('error', 'Please drop a valid .4spdata file.');
          }
        }, false);
        importInput.addEventListener('change', () => {
          if (importInput.files.length > 0) {
            importFileName.textContent = importInput.files[0].name;
            importText.textContent = "File selected. Ready to import.";
          } else {
            importFileName.textContent = 'No file selected';
            importText.textContent = "Click or drag & drop a .4spdata file";
          }
        });

        // --- UPDATED: Password Toggle Logic ---
        document.querySelectorAll('.password-toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetInput = document.getElementById(btn.dataset.target);
                const isPassword = targetInput.type === 'password';
                targetInput.type = isPassword ? 'text' : 'password';
                btn.querySelector('.eye-icon').style.display = isPassword ? 'none' : 'inline';
                btn.querySelector('.eye-off-icon').style.display = isPassword ? 'inline' : 'none';
            });
        });
    </script>
</body>
</html>
