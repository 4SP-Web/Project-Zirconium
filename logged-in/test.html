<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - Vern Social</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    /* --- Base Dashboard Layout (from template) --- */
    body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: PrimaryFont, sans-serif; }
    .dashboard-container { display: flex; flex: 1; }
    .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.collapsed { width: 85px; }
    #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
    .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
    .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
    .sidebar nav li { margin-bottom: 10px; }
    .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: PrimaryFont, sans-serif; text-transform: uppercase; position: relative; overflow: hidden; }
    .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
    .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
    .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
    .sidebar.collapsed nav a { justify-content: center; padding: 10px 0; }
    .sidebar.collapsed nav a .label { display: none; }
    .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: hidden; }
    .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em; }
    .marquee-content { display: inline-block; padding-left: 100%; animation: scroll-left 12s linear infinite; }
    .user-info .username { font-family: PrimaryFont, sans-serif; font-size: 1.3em; margin-bottom: 8px; line-height: 0.2em; font-weight: bold; }
    .user-info .email { font-family: SecondaryFont, sans-serif; font-size: 0.9em; color: #bbb; }
    @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    .main-content { flex: 1; padding: 30px; background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%); overflow-y: auto; position: relative; display: flex; gap: 20px; }
    
    /* --- VERN SOCIAL SPECIFIC STYLES --- */
    .social-container { flex: 3; display: flex; flex-direction: column; gap: 20px; }
    .chat-container { flex: 2; background: #fff; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.07); display: flex; flex-direction: column; overflow: hidden; transition: all 0.3s ease; max-width: 450px; }
    .chat-container.hidden { flex: 0; width: 0; padding: 0; border: none; }
    
    .card { background: #fff; padding: 20px 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
    .tabs { display: flex; gap: 10px; border-bottom: 2px solid #eee; margin-bottom: 20px; }
    .tab-btn { background: none; border: none; padding: 10px 15px; font-size: 1em; font-weight: 600; cursor: pointer; color: #777; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
    .tab-btn.active { color: #6720bd; border-bottom-color: #6720bd; }
    .tab-content { display: none; animation: fadeInView 0.5s; }
    .tab-content.active { display: block; }

    #allUsersView .search-bar { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 15px; }
    .user-list { list-style: none; padding: 0; margin: 0; max-height: 500px; overflow-y: auto; }
    .user-list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 8px; border-bottom: 1px solid #f0f0f0; }
    .user-list-item:last-child { border-bottom: none; }
    .user-list-item .user-details .username { font-weight: bold; color: #333; }
    .user-list-item .user-details .email { font-size: 0.85em; color: #888; }
    
    .action-btn { border: none; padding: 8px 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.8em; transition: all 0.2s ease; }
    .btn-add { background-color: #28a745; color: white; }
    .btn-accept { background-color: #007bff; color: white; }
    .btn-cancel, .btn-decline { background-color: #6c757d; color: white; }
    .btn-unfriend, .btn-block { background-color: #dc3545; color: white; }
    .btn-unblock { background-color: #ffc107; color: #212529; }
    .btn-chat { background-color: #17a2b8; color: white; }
    .btn-pending { background-color: #ffc107; color: #212529; cursor: not-allowed; }
    .btn-friend-status { background-color: #e9ecef; color: #495057; cursor: default; }

    .requests-section h4 { margin-top: 20px; margin-bottom: 10px; color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
    #incomingRequestsList, #outgoingRequestsList, #friendsList, #blockedList { margin-top: 10px; }

    /* CHAT STYLES */
    #chatHeader { padding: 15px 20px; border-bottom: 1px solid #eee; background-color: #f8f9fa; }
    #chatHeader h3 { margin: 0; font-size: 1.2em; color: #333; }
    #chatHeader #closeChatBtn { float: right; background: none; border: none; font-size: 1.5em; cursor: pointer; color: #888; line-height: 1; }
    #chatMessages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
    #chatMessagesContainer { display: flex; flex-direction: column; gap: 12px; }
    .message-bubble { max-width: 75%; padding: 10px 15px; border-radius: 18px; line-height: 1.4; word-wrap: break-word; }
    .message-bubble.sent { background: #6720bd; color: white; border-bottom-right-radius: 4px; align-self: flex-end; }
    .message-bubble.received { background: #e9ecef; color: #212529; border-bottom-left-radius: 4px; align-self: flex-start; }
    .message-bubble .timestamp { font-size: 0.7em; opacity: 0.7; display: block; margin-top: 5px; text-align: right; }
    #chatInputForm { display: flex; padding: 15px; border-top: 1px solid #eee; gap: 10px; }
    #chatInput { flex-grow: 1; border: 1px solid #ccc; padding: 10px; border-radius: 20px; }
    #sendMsgBtn { background: #6720bd; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.2em; cursor: pointer; }
    #chatWelcome { text-align: center; color: #888; margin: auto; padding: 20px; }

    @keyframes fadeInView { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body class="dashboard-page">
  <header class="main-header light-bg">
    <div class="container">
      <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" /></a></div>
      <div class="auth-buttons"><button id="logoutBtn" class="btn btn-login">LOG OUT</button></div>
    </div>
  </header>
  
  <div class="dashboard-container">
    <aside class="sidebar" id="sidebar">
      <button id="toggleSidebar">‚ò∞</button>
      <div class="user-info">
        <div class="marquee-container"><span id="userName" class="marquee-content username">Loading‚Ä¶</span></div>
        <div class="marquee-container"><span id="userEmail" class="marquee-content email">Loading‚Ä¶</span></div>
      </div>
      <nav>
        <ul>
          <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
          <li><a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">Proxies</span></a></li>
          <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
          <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
          <li><a href="others.html" class="active"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
          <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
          <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
        </ul>
      </nav>
    </aside>
    
    <main class="main-content">
        <div class="social-container">
            <div class="card">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="allUsersView">Find People</button>
                    <button class="tab-btn" data-tab="friendsView">Friends</button>
                    <button class="tab-btn" data-tab="requestsView">Requests</button>
                    <button class="tab-btn" data-tab="blockedView">Blocked</button>
                </div>

                <div id="allUsersView" class="tab-content active">
                    <input type="search" id="userSearch" class="search-bar" placeholder="Search for users by name or email...">
                    <ul id="allUsersList" class="user-list"><li>Loading...</li></ul>
                </div>

                <div id="friendsView" class="tab-content">
                    <ul id="friendsList" class="user-list"><li>Loading...</li></ul>
                </div>

                <div id="requestsView" class="tab-content">
                    <div class="requests-section">
                        <h4><i class="fas fa-inbox"></i> Incoming Requests</h4>
                        <ul id="incomingRequestsList" class="user-list"><li>No new requests.</li></ul>
                    </div>
                    <div class="requests-section">
                        <h4><i class="fas fa-paper-plane"></i> Outgoing Requests</h4>
                        <ul id="outgoingRequestsList" class="user-list"><li>No pending requests.</li></ul>
                    </div>
                </div>

                <div id="blockedView" class="tab-content">
                    <ul id="blockedList" class="user-list"><li>Loading...</li></ul>
                </div>
            </div>
        </div>

        <div id="chatContainer" class="chat-container hidden">
            <div id="chatHeader">
                <button id="closeChatBtn">&times;</button>
                <h3 id="chattingWith"></h3>
            </div>
            <div id="chatMessages">
                <div id="chatMessagesContainer"></div>
            </div>
            <p id="chatWelcome">Select a friend to start chatting.</p>
            <form id="chatInputForm" style="display: none;">
                <input type="text" id="chatInput" placeholder="Type a message..." autocomplete="off">
                <button type="submit" id="sendMsgBtn"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </main>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase & Global State ---
        const db = firebase.firestore();
        let currentUser = null;
        let currentUserProfile = null;
        let allUsersCache = [];
        let friendRequestsCache = [];
        let activeChatListener = null;

        // --- DOM Elements ---
        const sidebarUserNameEl = document.getElementById('userName');
        const sidebarUserEmailEl = document.getElementById('userEmail');
        const allUsersListEl = document.getElementById('allUsersList');
        const userSearchEl = document.getElementById('userSearch');
        const friendsListEl = document.getElementById('friendsList');
        const incomingRequestsListEl = document.getElementById('incomingRequestsList');
        const outgoingRequestsListEl = document.getElementById('outgoingRequestsList');
        const blockedListEl = document.getElementById('blockedList');
        const chatContainer = document.getElementById('chatContainer');
        const chatWelcomeEl = document.getElementById('chatWelcome');
        const chatHeader = document.getElementById('chatHeader');
        const chattingWithEl = document.getElementById('chattingWith');
        const chatMessagesEl = document.getElementById('chatMessages');
        const chatMessagesContainer = document.getElementById('chatMessagesContainer');
        const chatInputForm = document.getElementById('chatInputForm');
        const chatInput = document.getElementById('chatInput');
        const closeChatBtn = document.getElementById('closeChatBtn');

        // --- Utility Functions ---
        const escapeHTML = (str) => {
            const p = document.createElement("p");
            p.textContent = str;
            return p.innerHTML;
        };

        // --- Initialization & Auth ---
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                sidebarUserEmailEl.textContent = user.email;
                await initializeSocialFeatures();
            } else {
                window.location.href = '../login.html';
            }
        });

        async function initializeSocialFeatures() {
            if (!currentUser) return;
            // Fetch all necessary data in parallel
            const [userProfileSnap, allUsersSnap, friendRequestsSnap] = await Promise.all([
                db.collection('users').doc(currentUser.uid).get(),
                db.collection('users').get(),
                db.collection('friend_requests').get() // Fetch all for initial caching
            ]);

            // Process current user profile
            if (userProfileSnap.exists) {
                currentUserProfile = { id: userProfileSnap.id, ...userProfileSnap.data() };
                sidebarUserNameEl.textContent = currentUserProfile.username || 'User';
            } else {
                // If user has no profile, create one. This is a fallback.
                const profile = {
                    email: currentUser.email,
                    username: currentUser.email.split('@')[0],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    authMethod: 'email',
                    friends: [],
                    blocked: []
                };
                await db.collection('users').doc(currentUser.uid).set(profile);
                currentUserProfile = { id: currentUser.uid, ...profile };
                sidebarUserNameEl.textContent = currentUserProfile.username;
            }

            // Process all users cache
            allUsersCache = allUsersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Process friend requests cache
            friendRequestsCache = friendRequestsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Initial render
            renderAllTabs();
        }
        
        function renderAllTabs() {
            renderAllUsers();
            renderFriendsList();
            renderRequests();
            renderBlockedList();
        }

        // --- User & Relationship Rendering ---
        function getUserRelationship(otherUserId) {
            if (currentUserProfile.id === otherUserId) return { status: 'self', text: 'You' };
            if (currentUserProfile.blocked?.includes(otherUserId)) return { status: 'blocked', text: 'Unblock' };
            if (currentUserProfile.friends?.includes(otherUserId)) return { status: 'friend', text: 'Friend' };
            
            const incoming = friendRequestsCache.find(req => req.senderId === otherUserId && req.receiverId === currentUserProfile.id);
            if (incoming) return { status: 'incoming_request', text: 'Accept', requestId: incoming.id };

            const outgoing = friendRequestsCache.find(req => req.senderId === currentUserProfile.id && req.receiverId === otherUserId);
            if (outgoing) return { status: 'outgoing_request', text: 'Pending', requestId: outgoing.id };

            return { status: 'none', text: 'Add Friend' };
        }
        
        function renderUserListItem(user, container) {
            if (user.id === currentUser.uid) return; // Don't render self
            const li = document.createElement('li');
            li.className = 'user-list-item';
            li.dataset.userId = user.id;

            const relationship = getUserRelationship(user.id);
            let buttonsHTML = '';
            
            switch (relationship.status) {
                case 'none':
                    buttonsHTML = `<button class="action-btn btn-add" data-action="add" data-user-id="${user.id}">Add Friend</button>`;
                    break;
                case 'friend':
                    buttonsHTML = `<button class="action-btn btn-chat" data-action="chat" data-user-id="${user.id}">Chat</button>
                                 <button class="action-btn btn-unfriend" data-action="unfriend" data-user-id="${user.id}">Unfriend</button>
                                 <button class="action-btn btn-block" data-action="block" data-user-id="${user.id}">Block</button>`;
                    break;
                case 'incoming_request':
                    buttonsHTML = `<button class="action-btn btn-accept" data-action="accept" data-user-id="${user.id}" data-request-id="${relationship.requestId}">Accept</button>
                                 <button class="action-btn btn-decline" data-action="decline" data-request-id="${relationship.requestId}">Decline</button>`;
                    break;
                case 'outgoing_request':
                    buttonsHTML = `<button class="action-btn btn-pending" disabled>Pending</button>
                                 <button class="action-btn btn-cancel" data-action="cancel" data-request-id="${relationship.requestId}">Cancel</button>`;
                    break;
                case 'blocked':
                     buttonsHTML = `<button class="action-btn btn-unblock" data-action="unblock" data-user-id="${user.id}">Unblock</button>`;
                     break;
            }

            li.innerHTML = `
                <div class="user-details">
                    <div class="username">${escapeHTML(user.username)}</div>
                    <div class="email">${escapeHTML(user.email)}</div>
                </div>
                <div class="user-actions">${buttonsHTML}</div>`;
            container.appendChild(li);
        }

        function renderAllUsers() {
            allUsersListEl.innerHTML = '';
            const query = userSearchEl.value.toLowerCase();
            const filteredUsers = allUsersCache.filter(u => u.username.toLowerCase().includes(query) || u.email.toLowerCase().includes(query));
            
            if (filteredUsers.length === 0) {
                allUsersListEl.innerHTML = '<li>No users found.</li>';
                return;
            }
            filteredUsers.forEach(user => renderUserListItem(user, allUsersListEl));
        }

        function renderFriendsList() {
            friendsListEl.innerHTML = '';
            const friendIds = currentUserProfile.friends || [];
            if (friendIds.length === 0) {
                friendsListEl.innerHTML = '<li>You have no friends yet. Find some!</li>';
                return;
            }
            const friends = allUsersCache.filter(user => friendIds.includes(user.id));
            friends.forEach(friend => renderUserListItem(friend, friendsListEl));
        }
        
        function renderRequests() {
            incomingRequestsListEl.innerHTML = '';
            outgoingRequestsListEl.innerHTML = '';

            const incoming = friendRequestsCache.filter(req => req.receiverId === currentUser.uid);
            const outgoing = friendRequestsCache.filter(req => req.senderId === currentUser.uid);

            if (incoming.length > 0) {
                incoming.forEach(req => {
                    const sender = allUsersCache.find(u => u.id === req.senderId);
                    if(sender) renderUserListItem(sender, incomingRequestsListEl);
                });
            } else {
                incomingRequestsListEl.innerHTML = '<li>No incoming requests.</li>';
            }

            if (outgoing.length > 0) {
                outgoing.forEach(req => {
                    const receiver = allUsersCache.find(u => u.id === req.receiverId);
                    if(receiver) renderUserListItem(receiver, outgoingRequestsListEl);
                });
            } else {
                outgoingRequestsListEl.innerHTML = '<li>No outgoing requests.</li>';
            }
        }
        
        function renderBlockedList() {
            blockedListEl.innerHTML = '';
            const blockedIds = currentUserProfile.blocked || [];
             if (blockedIds.length === 0) {
                blockedListEl.innerHTML = '<li>You have not blocked anyone.</li>';
                return;
            }
            const blockedUsers = allUsersCache.filter(user => blockedIds.includes(user.id));
            blockedUsers.forEach(user => renderUserListItem(user, blockedListEl));
        }

        // --- Social Actions ---
        async function sendFriendRequest(receiverId) {
            const request = {
                senderId: currentUser.uid,
                receiverId: receiverId,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            const newRequestRef = await db.collection('friend_requests').add(request);
            friendRequestsCache.push({id: newRequestRef.id, ...request});
            renderAllTabs();
        }
        
        async function cancelOrDeclineRequest(requestId) {
            await db.collection('friend_requests').doc(requestId).delete();
            friendRequestsCache = friendRequestsCache.filter(r => r.id !== requestId);
            renderAllTabs();
        }

        async function acceptFriendRequest(senderId) {
            // First, find and delete the request
            const request = friendRequestsCache.find(req => req.senderId === senderId && req.receiverId === currentUser.uid);
            if(request) await db.collection('friend_requests').doc(request.id).delete();
            
            // Use batch write for atomicity
            const batch = db.batch();
            const currentUserRef = db.collection('users').doc(currentUser.uid);
            const senderUserRef = db.collection('users').doc(senderId);

            batch.update(currentUserRef, { friends: firebase.firestore.FieldValue.arrayUnion(senderId) });
            batch.update(senderUserRef, { friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
            
            await batch.commit();

            // Update local state and re-render
            currentUserProfile.friends.push(senderId);
            friendRequestsCache = friendRequestsCache.filter(r => r.id !== request.id);
            renderAllTabs();
        }
        
        async function unfriendUser(friendId) {
            if (!confirm("Are you sure you want to unfriend this user?")) return;
            
            const batch = db.batch();
            const currentUserRef = db.collection('users').doc(currentUser.uid);
            const friendUserRef = db.collection('users').doc(friendId);
            
            batch.update(currentUserRef, { friends: firebase.firestore.FieldValue.arrayRemove(friendId) });
            batch.update(friendUserRef, { friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
            
            await batch.commit();
            
            currentUserProfile.friends = currentUserProfile.friends.filter(id => id !== friendId);
            renderAllTabs();
        }
        
        async function blockUser(userIdToBlock) {
             if (!confirm("Are you sure you want to block this user? This will also unfriend them if you are friends.")) return;

            const isFriend = currentUserProfile.friends?.includes(userIdToBlock);
            const batch = db.batch();
            const currentUserRef = db.collection('users').doc(currentUser.uid);
            
            // Add to blocked list
            batch.update(currentUserRef, { blocked: firebase.firestore.FieldValue.arrayUnion(userIdToBlock) });
            
            // If they are friends, unfriend them
            if (isFriend) {
                const friendUserRef = db.collection('users').doc(userIdToBlock);
                batch.update(currentUserRef, { friends: firebase.firestore.FieldValue.arrayRemove(userIdToBlock) });
                batch.update(friendUserRef, { friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
            }
            
            await batch.commit();
            
            // Update local state
            if (!currentUserProfile.blocked) currentUserProfile.blocked = [];
            currentUserProfile.blocked.push(userIdToBlock);
            if(isFriend) currentUserProfile.friends = currentUserProfile.friends.filter(id => id !== userIdToBlock);
            
            renderAllTabs();
        }
        
        async function unblockUser(userIdToUnblock) {
            await db.collection('users').doc(currentUser.uid).update({
                blocked: firebase.firestore.FieldValue.arrayRemove(userIdToUnblock)
            });
            currentUserProfile.blocked = currentUserProfile.blocked.filter(id => id !== userIdToUnblock);
            renderAllTabs();
        }

        // --- Chat ---
        function openChatWith(friendUser) {
            chatContainer.classList.remove('hidden');
            chatWelcomeEl.style.display = 'none';
            chatInputForm.style.display = 'flex';
            chattingWithEl.textContent = friendUser.username;

            // Generate a consistent chat ID
            const chatId = [currentUser.uid, friendUser.id].sort().join('_');

            // Detach any previous listener
            if (activeChatListener) activeChatListener();
            
            chatMessagesContainer.innerHTML = ''; // Clear previous messages
            
            // Attach new listener
            const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('createdAt', 'desc');
            activeChatListener = messagesRef.onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        renderMessage(change.doc.data());
                    }
                });
            });
            
            chatInputForm.onsubmit = (e) => {
                e.preventDefault();
                sendMessage(chatId);
            };
        }

        function closeChat() {
            chatContainer.classList.add('hidden');
            chatWelcomeEl.style.display = 'block';
            chatInputForm.style.display = 'none';
            if (activeChatListener) {
                activeChatListener();
                activeChatListener = null;
            }
            chatInputForm.onsubmit = null;
        }

        function renderMessage(msg) {
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            const messageClass = msg.authorId === currentUser.uid ? 'sent' : 'received';
            bubble.classList.add(messageClass);
            
            const time = msg.createdAt?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || '';
            bubble.innerHTML = `<div>${escapeHTML(msg.text)}</div><span class="timestamp">${time}</span>`;
            
            // Insert at the beginning of the container because of flex-direction: column-reverse
            chatMessagesContainer.insertBefore(bubble, chatMessagesContainer.firstChild);
        }

        async function sendMessage(chatId) {
            const text = chatInput.value.trim();
            if (!text) return;

            chatInput.value = '';
            
            const members = chatId.split('_');

            const message = {
                text: text,
                authorId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            const chatRef = db.collection('chats').doc(chatId);
            
            // Check if chat doc exists, if not create it with members array
            const chatDoc = await chatRef.get();
            if (!chatDoc.exists) {
                await chatRef.set({ members: members });
            }
            
            await chatRef.collection('messages').add(message);
        }

        // --- Event Listeners ---
        document.querySelector('.tabs').addEventListener('click', e => {
            if (e.target.classList.contains('tab-btn')) {
                document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById(e.target.dataset.tab).classList.add('active');
            }
        });

        document.querySelector('.social-container').addEventListener('click', e => {
            const button = e.target.closest('.action-btn');
            if (!button) return;
            
            const action = button.dataset.action;
            const userId = button.dataset.userId;
            const requestId = button.dataset.requestId;

            switch (action) {
                case 'add': sendFriendRequest(userId); break;
                case 'accept': acceptFriendRequest(userId); break;
                case 'cancel':
                case 'decline': cancelOrDeclineRequest(requestId); break;
                case 'unfriend': unfriendUser(userId); break;
                case 'block': blockUser(userId); break;
                case 'unblock': unblockUser(userId); break;
                case 'chat': 
                    const friend = allUsersCache.find(u => u.id === userId);
                    if(friend) openChatWith(friend);
                    break;
            }
        });
        
        userSearchEl.addEventListener('input', renderAllUsers);
        closeChatBtn.addEventListener('click', closeChat);
        document.getElementById('logoutBtn').addEventListener('click', () => firebase.auth().signOut());
        document.getElementById('signOutLink').addEventListener('click', () => firebase.auth().signOut());
        document.getElementById('toggleSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
    });
  </script>
</body>
</html>
