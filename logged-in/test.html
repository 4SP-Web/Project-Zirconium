<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - VERN MAX</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link id="dynamic-favicon" rel="shortcut icon" type="image/x-icon" href="">
  <script src="../panic-key.js"></script>
  <style>
    :root {
        --dark-bg-primary: #121212;
        --dark-bg-secondary: #1e1e1e;
        --dark-bg-tertiary: #2a2a2a;
        --dark-text-primary: #e0e0e0;
        --dark-text-secondary: #b0b0b0;
        --dark-border-color: #3a3a3a;
        --dark-accent-purple: #6720bd;
    }
    html, body {
      height: 100%; margin: 0; font-family: 'Roboto', sans-serif;
      background-color: var(--dark-bg-primary); color: var(--dark-text-primary);
      overflow: hidden;
    }
    body { display: flex; flex-direction: column; }

    #loading-overlay, #time-limit-overlay {
        position: fixed; inset: 0; display: flex;
        justify-content: center; align-items: center;
        background-color: var(--dark-bg-primary);
        z-index: 9999; font-family: 'PrimaryFont', sans-serif;
    }
    .overlay-content { text-align: center; }
    #loading-spinner {
        border: 4px solid var(--dark-bg-tertiary);
        border-top: 4px solid var(--dark-accent-purple);
        border-radius: 50%; width: 30px; height: 30px;
        animation: spin 1s linear infinite; margin: 20px auto;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    #time-limit-overlay { z-index: 9998; }
    .limit-container h1 { font-size: 2.5em; color: var(--dark-accent-purple); margin-bottom: 10px; }
    .limit-container p { font-size: 1.2em; color: var(--dark-text-secondary); margin-bottom: 30px; }
    .limit-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
    .limit-buttons button {
        background-color: var(--dark-bg-tertiary); color: var(--dark-text-primary);
        border: 1px solid var(--dark-border-color); padding: 12px 24px;
        border-radius: 12px; cursor: pointer; font-family: 'PrimaryFont', sans-serif;
        font-weight: bold; transition: background-color 0.2s ease;
        text-transform: uppercase; font-size: 1em;
    }
    .limit-buttons button:hover { background-color: #333; }

    #app-container {
      visibility: hidden; opacity: 0; height: 100%;
      display: flex; flex-direction: column;
      transition: opacity 0.5s ease-in;
    }
    #app-container.is-visible { visibility: visible; opacity: 1; }

    .main-header {
        background: var(--dark-bg-secondary); padding: 10px 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        border-bottom: 1px solid var(--dark-border-color);
    }
    .main-header .container {
        display: flex; justify-content: space-between; align-items: center;
        width: 100%; margin: 0 auto; max-width: 1400px;
    }
    .logo-timer-group { display: flex; align-items: center; gap: 25px; }
    .main-header .logo img { height: 40px; }
    #timer-display {
        font-family: 'PrimaryFont', sans-serif; color: #c7c7c7;
        font-size: 16px; font-weight: bold; display: none;
    }
    .main-header .auth-buttons { display: flex; gap: 15px; align-items: center; }
    /* Other button styles as before... */
  </style>
</head>
<body>
  <div id="loading-overlay">
    <div class="overlay-content">
      <p>AUTHENTICATING...</p>
      <div id="loading-spinner"></div>
    </div>
  </div>

  <div id="time-limit-overlay" style="display: none;">
      <div class="limit-container">
          <h1>Time's Up!</h1>
          <p>Your 1-hour time limit for today has been reached.</p>
          <div class="limit-buttons">
              <button onclick="window.location.href='../logged-in/dashboard.html'">Go to Dashboard</button>
              <button onclick="window.location.href='vernmini.html'">Go to VernMini</button>
          </div>
      </div>
  </div>

  <div id="app-container">
    <header class="main-header">
      <div class="container">
        <div class="logo-timer-group">
            <div class="logo">
              <a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" /></a>
            </div>
            <div id="timer-display"></div>
        </div>
        <div class="auth-buttons">
          </div>
      </div>
    </header>
    <main style="flex: 1; display: flex;">
        <iframe id="proxyFrame" style="width:100%; height:100%; border:none;" src="about:blank"></iframe>
    </main>
  </div>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- Element References ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const appContainer = document.getElementById('app-container');
    const timeLimitOverlay = document.getElementById('time-limit-overlay');
    const timerDisplay = document.getElementById('timer-display');
    const proxyFrame = document.getElementById('proxyFrame');

    // --- Configuration ---
    const ADMIN_EMAILS = ["4simpleproblems@gmail.com", "belkwy30@minerva.sparcc.org"];
    const FULL_DURATION_SECONDS = 3600; // 1 hour

    // --- Core Authentication ---
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            if (ADMIN_EMAILS.includes(user.email)) {
                console.log("Admin user detected. No time limit.");
                loadApplication();
            } else {
                console.log("Regular user detected. Initializing timer.");
                handleUserTimer();
            }
        } else {
            console.log("No authenticated user. Redirecting to login.");
            window.location.href = '/login.html';
        }
    });

    /**
     * Loads the main application content without any time limits.
     * This is called for admin users.
     */
    function loadApplication() {
        loadingOverlay.style.display = 'none';
        appContainer.classList.add('is-visible');
        // initializeProxy(); // You would call your proxy loading function here
    }

    /**
     * Handles the logic for checking, initializing, and starting the user's timer.
     */
    function handleUserTimer() {
        const today = new Date().toISOString().split('T')[0];
        let timerData = JSON.parse(localStorage.getItem('userActiveTimer')) || {};

        // If the stored data is not for today, reset the timer.
        if (timerData.date !== today) {
            timerData = {
                date: today,
                remainingSeconds: FULL_DURATION_SECONDS
            };
        }
        
        // Persist the potentially updated data.
        localStorage.setItem('userActiveTimer', JSON.stringify(timerData));

        if (timerData.remainingSeconds <= 0) {
            // If the user has no time left, show the limit screen immediately.
            showTimeUpScreen();
        } else {
            // If time remains, load the app and start the active countdown.
            loadApplication();
            initializeActiveTimer(timerData.remainingSeconds);
        }
    }

    /**
     * The core of the new timer logic. It only counts down when the page is visible.
     * @param {number} secondsLeft The initial number of seconds remaining.
     */
    function initializeActiveTimer(secondsLeft) {
        let remainingSeconds = secondsLeft;
        let timerInterval = null;

        // Function to save the current remaining time to localStorage.
        const saveTime = () => {
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem('userActiveTimer', JSON.stringify({
                date: today,
                remainingSeconds: remainingSeconds
            }));
            console.log(`Time saved: ${remainingSeconds} seconds remaining.`);
        };

        // Function to start the countdown.
        const startTimer = () => {
            // Prevent multiple intervals from running at the same time.
            if (timerInterval) return; 
            
            console.log("Timer started.");
            timerInterval = setInterval(() => {
                remainingSeconds--;
                updateTimerDisplay(remainingSeconds);

                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    saveTime(); // Save the final state (0 seconds)
                    if (document.fullscreenElement) {
                        window.location.reload();
                    } else {
                        showTimeUpScreen();
                    }
                }
            }, 1000);
        };

        // Function to pause the countdown.
        const pauseTimer = () => {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null; // Clear the interval ID
                saveTime(); // Save progress when paused
                console.log("Timer paused.");
            }
        };

        // Listen for the page's visibility changing (e.g., user switches tabs).
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // When the tab becomes visible again, restart the timer.
                startTimer();
            } else {
                // When the tab is hidden, pause the timer.
                pauseTimer();
            }
        });
        
        // Listen for the user closing the tab or browser to ensure time is saved.
        window.addEventListener('beforeunload', pauseTimer);
        
        // Initial setup
        timerDisplay.style.display = 'block';
        updateTimerDisplay(remainingSeconds);
        startTimer(); // Start the timer when the app loads.
    }

    /**
     * Updates the time display element in the header.
     * @param {number} totalSeconds The total seconds to format and display.
     */
    function updateTimerDisplay(totalSeconds) {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        const paddedHours = String(hours).padStart(2, '0');
        const paddedMinutes = String(minutes).padStart(2, '0');
        const paddedSeconds = String(seconds).padStart(2, '0');
        
        timerDisplay.textContent = `Time Left: ${paddedHours}:${paddedMinutes}:${paddedSeconds}`;
    }

    /**
     * Hides the main app and shows the "Time's Up" overlay.
     */
    function showTimeUpScreen() {
        loadingOverlay.style.display = 'none';
        appContainer.classList.remove('is-visible');
        appContainer.style.display = 'none'; // Ensure it's hidden
        timeLimitOverlay.style.display = 'flex';
        proxyFrame.src = 'about:blank';
    }
  });
  </script>
</body>
</html>
