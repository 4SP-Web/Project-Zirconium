<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - VERN SOCIAL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --font-primary: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --color-accent: #007aff;
            --color-accent-gradient: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
            --color-danger: #ff3b30;
            --color-success: #34c759;
            --color-warning: #ff9500;
            --glass-bg-dark: rgba(28, 28, 30, 0.65);
            --glass-bg-light: rgba(255, 255, 255, 0.25);
            --glass-border-color: rgba(255, 255, 255, 0.2);
            --blur-radius: 20px;
            --text-primary: #f5f5f7;
            --text-secondary: #c7c7cc;
            --text-tertiary: #8e8e93;
            --online-indicator: #34c759;
            --offline-indicator: #8e8e93;
            --gaming-indicator: #ff9500;
            --working-indicator: #5ac8fa;
            --sleeping-indicator: #5856d6;
        }
        html, body {
            height: 100%; margin: 0; font-family: var(--font-primary);
            background-color: #000;
            background-image: url('https://images.unsplash.com/photo-1554189097-90d836021d44?q=80&w=2536&auto=format&fit=crop');
            background-size: cover; background-position: center; overflow: hidden; color: var(--text-primary);
        }
        * { box-sizing: border-box; }
        body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; }
        .dashboard-container { display: flex; flex: 1; min-height: 0; padding: 15px; gap: 15px; }
        .main-header { flex-shrink: 0; background-color: #1C1C1E; border-bottom: 1px solid #3A3A3C; }
        .hidden { display: none !important; }
        .main-header .container { display: flex; align-items: center; justify-content: space-between; padding: 0 20px; height: 60px; }
        .main-header .logo img { height: 35px; width: auto; display: block; }
        .main-header .auth-buttons .btn { background: none; border: 1px solid var(--text-secondary); color: var(--text-secondary); padding: 8px 15px; border-radius: 20px; cursor: pointer; transition: all 0.2s ease; }
        .main-header .auth-buttons .btn:hover { background: var(--color-accent); border-color: var(--color-accent); color: white; }

        .sidebar { width: 320px; background: var(--glass-bg-dark); backdrop-filter: blur(var(--blur-radius)); -webkit-backdrop-filter: blur(var(--blur-radius)); border: 1px solid var(--glass-border-color); border-radius: 20px; color: var(--text-primary); display: flex; flex-direction: column; transition: width 0.3s ease; flex-shrink: 0; padding: 10px; }
        .user-profile-area { padding: 15px 10px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--glass-border-color); }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; border: 2px solid #000; flex-shrink: 0; transition: background-color 0.3s ease; }
        .status-indicator.online { background-color: var(--online-indicator); }
        .status-indicator.offline { background-color: var(--offline-indicator); }
        .status-indicator.gaming { background-color: var(--gaming-indicator); }
        .status-indicator.working { background-color: var(--working-indicator); }
        .status-indicator.sleeping { background-color: var(--sleeping-indicator); }
        .user-details .username { font-size: 1.1em; font-weight: 600; margin: 0; }
        .user-details .email { font-size: 0.8em; color: var(--text-secondary); margin: 2px 0 0; }
        .social-sidebar-content { flex-grow: 1; overflow-y: auto; overflow-x: hidden; padding-top: 10px; }
        .sidebar-section { padding: 10px 5px; }
        .sidebar-section h2 { font-size: 1em; font-weight: 600; color: var(--text-secondary); margin: 0 0 15px 5px; padding-left: 5px; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-section input[type="text"] { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border-color); color: var(--text-primary); padding: 12px 15px; border-radius: 12px; font-family: var(--font-primary); font-size: 1em; }
        .item-list { list-style: none; padding: 0; margin: 0; }
        .item-list li { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 12px; transition: background-color 0.2s ease; cursor: pointer; margin-bottom: 5px; }
        .item-list li:hover:not(.empty-state) { background-color: rgba(255,255,255,0.1); }
        .item-list .active-chat { background-color: var(--color-accent) !important; color: white; }
        .item-list .item-info { display: flex; align-items: center; gap: 12px; font-weight: 500; }
        .item-actions button { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1em; padding: 5px; border-radius: 50%; width: 30px; height: 30px; transition: all 0.2s ease; }
        .item-actions button:hover { background: rgba(255,255,255,0.15); }
        .item-actions .accept-btn:hover { color: var(--color-success); }
        .item-actions .decline-btn:hover { color: var(--color-danger); }
        .sidebar-settings-menu { padding: 10px 0; border-top: 1px solid var(--glass-border-color); }
        .sidebar-settings-menu li a { display: flex; align-items: center; gap: 12px; padding: 12px 15px; border-radius: 12px; text-decoration: none; color: var(--text-secondary); font-weight: 500; }
        .sidebar-settings-menu li a:hover { background-color: rgba(255,255,255,0.1); color: #fff; }

        .chat-area { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; position: relative; background: var(--glass-bg-dark); backdrop-filter: blur(var(--blur-radius)); -webkit-backdrop-filter: blur(var(--blur-radius)); border: 1px solid var(--glass-border-color); border-radius: 20px; overflow: hidden; }
        .messages-container { background-size: cover; background-position: center; flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        .chat-placeholder { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: var(--text-secondary); }
        .chat-placeholder i { font-size: 6em; margin-bottom: 20px; color: var(--text-tertiary); }

        .chat-header { padding: 10px 20px; height: 60px; border-bottom: 1px solid var(--glass-border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background: rgba(0,0,0,0.2); }
        .chat-info { text-align: left; font-size: 1.2em; font-weight: 600; }
        .chat-actions { display: flex; align-items: center; gap: 5px; }
        .chat-actions button { background: none; border: none; font-size: 1.2em; color: var(--text-secondary); cursor: pointer; width: 36px; height: 36px; border-radius: 50%; display: grid; place-items: center; }
        .chat-actions button:hover { background-color: rgba(255,255,255,0.1); color: #fff; }
        
        @keyframes newMessageAnimation { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-wrapper { display: flex; flex-direction: column; max-width: 70%; position: relative; margin-bottom: 8px; animation: newMessageAnimation 0.3s ease-out; }
        .message-wrapper.sent { align-self: flex-end; align-items: flex-end; }
        .message-wrapper.received { align-self: flex-start; align-items: flex-start; }
        .reply-context { background: rgba(0,0,0,0.2); border-left: 3px solid var(--color-accent); padding: 6px 10px; margin-bottom: -5px; border-radius: 8px 8px 0 0; font-size: 0.85em; max-width: 100%; }
        .reply-context strong { color: var(--color-accent); }
        .reply-context p { margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-secondary); }
        .message-content { padding: 10px 15px; border-radius: 18px; line-height: 1.5; word-break: break-word; position: relative; color: var(--text-primary); }
        .message-wrapper.sent .message-content { background: var(--color-accent-gradient); border-top-right-radius: 4px; }
        .message-wrapper.received .message-content { background: var(--glass-bg-dark); backdrop-filter: blur(5px); border: 1px solid var(--glass-border-color); border-top-left-radius: 4px; }
        .message-text.deleted { font-style: italic; color: var(--text-tertiary); }
        .message-meta { display: flex; align-items: center; gap: 8px; font-size: 0.75em; padding: 4px 8px; color: var(--text-secondary); }
        .message-actions { position: absolute; top: 50%; transform: translateY(-50%); background: var(--glass-bg-dark); border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; gap: 2px; padding: 4px; opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 10; }
        .message-wrapper:hover .message-actions { opacity: 1; pointer-events: auto; }
        .message-wrapper.sent .message-actions { left: -10px; transform: translate(-100%, -50%); }
        .message-wrapper.received .message-actions { right: -10px; transform: translate(100%, -50%); }
        .message-actions button { background: none; border: none; font-size: 0.9em; color: var(--text-secondary); cursor: pointer; padding: 6px; border-radius: 50%; width: 30px; height: 30px; }
        .message-actions button:hover { background-color: rgba(255,255,255,0.1); color: #fff; }

        .reactions-container { position: absolute; bottom: -12px; left: 10px; display: flex; gap: 4px; z-index: 5; }
        .message-wrapper.sent .reactions-container { right: 10px; left: auto; }
        .reaction-chip { background: var(--glass-bg-dark); border: 1px solid var(--glass-border-color); border-radius: 12px; padding: 2px 8px; font-size: 0.8em; display: flex; align-items: center; gap: 4px; cursor: pointer; }
        .reaction-chip .count { font-weight: bold; font-size: 0.9em; }

        .chat-footer { padding: 10px 15px; border-top: 1px solid var(--glass-border-color); flex-shrink: 0; background: rgba(0,0,0,0.2); }
        #reply-preview-bar { background: rgba(0,0,0,0.25); padding: 8px 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9em; position: relative; }
        #reply-preview-bar p { margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #cancel-reply-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-secondary); padding: 0 5px; }
        #messageFormInner { display: flex; align-items: flex-end; gap: 10px; }
        #messageInput { flex-grow: 1; border: none; background: var(--glass-bg-light); backdrop-filter: blur(10px); border: 1px solid var(--glass-border-color); border-radius: 22px; padding: 10px 18px; font-size: 1em; resize: none; color: var(--text-primary); max-height: 120px; }
        #messageInput::placeholder { color: var(--text-secondary); }
        #sendMessageBtn, #voiceMessageBtn { background: var(--color-accent); color: white; border: none; border-radius: 50%; width: 44px; height: 44px; font-size: 1.2em; cursor: pointer; flex-shrink: 0; display: grid; place-items: center; transition: transform 0.2s ease, background-color 0.2s ease; }
        #sendMessageBtn:hover, #voiceMessageBtn:hover { transform: scale(1.1); }
        #voiceMessageBtn.recording { background-color: var(--color-danger); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal { background: var(--glass-bg-dark); backdrop-filter: blur(var(--blur-radius)); border: 1px solid var(--glass-border-color); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 90%; max-width: 550px; transform: scale(0.95); transition: transform 0.3s ease; color: var(--text-primary); overflow: hidden; }
        .modal-overlay.visible .modal { transform: scale(1); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--glass-border-color); font-size: 1.3em; font-weight: 600; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--glass-border-color); display: flex; justify-content: flex-end; gap: 10px; }
        .btn { padding: 10px 20px; border-radius: 20px; border: none; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--color-accent); color: white; }
        .btn-secondary { background: rgba(255,255,255,0.2); color: white; }
        
        #mainSettingsModal .modal-body { padding: 0; }
        .settings-container { display: flex; }
        .settings-nav { width: 180px; background: rgba(0,0,0,0.2); border-right: 1px solid var(--glass-border-color); padding: 15px 0; }
        .settings-nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 20px; border: none; width: 100%; background: none; cursor: pointer; font-size: 1em; color: var(--text-secondary); border-left: 3px solid transparent; }
        .settings-nav-link:hover { background: rgba(255,255,255,0.05); }
        .settings-nav-link.active { border-left-color: var(--color-accent); background: rgba(0, 122, 255, 0.2); font-weight: 600; color: var(--text-primary); }
        .settings-content { flex-grow: 1; padding: 25px; max-height: 65vh; overflow-y: auto; }
        .wallpaper-color-options { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; }
        .wallpaper-color-swatch { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.2s; }
        .wallpaper-color-swatch:hover { transform: scale(1.1); }
        .wallpaper-color-swatch.selected { border-color: var(--color-accent); }
        .nickname-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--glass-border-color); }
        
        #reaction-menu { position: absolute; background: var(--glass-bg-dark); backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(0,0,0,0.4); border-radius: 25px; padding: 8px; display: flex; gap: 8px; z-index: 1001; opacity: 0; transform: scale(0.9) translateY(10px); transition: opacity 0.2s, transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; }
        #reaction-menu.visible { opacity: 1; transform: scale(1) translateY(0); pointer-events: auto; }
        #reaction-menu .emoji-btn { font-size: 1.8em; cursor: pointer; background: none; border: none; padding: 5px; border-radius: 50%; transition: transform 0.1s ease; }
        #reaction-menu .emoji-btn:hover { transform: scale(1.2); }

        #emoji-picker-modal .modal-header { display: flex; flex-direction: column; gap: 15px; }
        #emoji-picker-search { width: 100%; padding: 12px; border: 1px solid var(--glass-border-color); border-radius: 10px; background: rgba(0,0,0,0.2); color: var(--text-primary); }
        #emoji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px; }
        #emoji-grid .emoji-btn { font-size: 1.8em; cursor: pointer; background: none; border: none; padding: 5px; border-radius: 10px; transition: background 0.2s ease; }
        #emoji-grid .emoji-btn:hover { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body class="dashboard-page">

    <header class="main-header">
        <div class="container">
            <div class="logo"><a href="#"><img src="../images/logo.png" alt="4SP Logo"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../logged-in/dashboard.html'">DASHBOARD</button>
                <button id="logoutBtn" class="btn">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar">
             <div class="user-profile-area">
                <div id="currentUserStatus" class="status-indicator offline"></div>
                <div class="user-details">
                    <p class="username" id="userName">Loading...</p>
                    <p class="email" id="userEmail">...</p>
                </div>
            </div>
            <div class="social-sidebar-content">
                <div class="sidebar-section">
                    <h2><i class="fas fa-search"></i> Find Users</h2>
                    <input type="text" id="userSearchInput" placeholder="Search by exact username...">
                    <ul id="userSearchResults" class="item-list"></ul>
                </div>
                <div class="sidebar-section">
                    <h2><i class="fas fa-user-plus"></i> Requests</h2>
                    <ul id="friendRequestsList" class="item-list"></ul>
                </div>
                <div class="sidebar-section">
                    <h2>Groups <button id="createGroupBtn" class="action-btn" title="Create Group"><i class="fas fa-plus"></i></button></h2>
                    <ul id="groupChatsList" class="item-list"><li class="empty-state">No groups yet.</li></ul>
                </div>
                <div class="sidebar-section">
                    <h2><i class="fas fa-users"></i> Friends</h2>
                    <ul id="friendsList" class="item-list"></ul>
                </div>
                 <div class="sidebar-section">
                    <h2><i class="fas fa-user-slash"></i> Blocked Users</h2>
                    <ul id="blockedUsersList" class="item-list"></ul>
                </div>
            </div>
            <div class="sidebar-settings-menu">
                <ul>
                    <li><a href="#" id="manageSettingsBtn"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="chat-area">
            <div class="chat-placeholder" id="chatPlaceholder">
                <i class="fas fa-comments"></i>
                <h2>Vern Social</h2>
                <p>Select a friend or group to start chatting.</p>
            </div>
            <div class="chat-wrapper hidden" id="chatWrapper">
                <div class="chat-header">
                    <div class="chat-info" id="chatHeaderInfo"></div>
                    <div class="chat-actions">
                        <button id="chatSettingsBtn" title="Chat Settings"><i class="fas fa-ellipsis-h"></i></button>
                    </div>
                </div>
                <div class="messages-container" id="messagesContainer"></div>
                <div class="chat-footer">
                    <div id="reply-preview-bar" class="hidden">
                        <button id="cancel-reply-btn">&times;</button>
                        <p>Replying to <strong>...</strong></p>
                        <p id="reply-text-snippet">...</p>
                    </div>
                    <form id="messageForm" autocomplete="off">
                        <div id="messageFormInner">
                            <textarea id="messageInput" placeholder="Type a message..." rows="1" maxlength="2000" disabled></textarea>
                            <button type="button" id="voiceMessageBtn" disabled><i class="fas fa-microphone"></i></button>
                            <button type="submit" id="sendMessageBtn" disabled><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <div id="reaction-menu" class="hidden"></div>

    <div class="modal-overlay" id="emoji-picker-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>React with an emoji</h3>
                <input type="search" id="emoji-picker-search" placeholder="Search for an emoji...">
            </div>
            <div class="modal-body" id="emoji-grid"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close>Close</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="mainSettingsModal">
        <div class="modal">
            <div class="modal-header"><h3>Settings</h3></div>
            <div class="modal-body">
                <div class="settings-container">
                    <nav class="settings-nav">
                        <button class="settings-nav-link active" data-tab="status-settings"><i class="fas fa-user-circle"></i> Status</button>
                        <button class="settings-nav-link" data-tab="wallpaper-settings"><i class="fas fa-palette"></i> Wallpaper</button>
                        <button class="settings-nav-link" data-tab="nickname-settings"><i class="fas fa-user-tag"></i> Nicknames</button>
                    </nav>
                    <div class="settings-content">
                        <div id="status-settings" class="tab-content">
                            <h4>Set Your Status</h4>
                            <select id="status-select" style="width:100%; padding:10px; background:rgba(0,0,0,0.3); color:white; border-radius:8px;"></select>
                        </div>
                        <div id="wallpaper-settings" class="tab-content hidden">
                            <h4>Chat Wallpaper</h4>
                            <div class="wallpaper-color-options"></div>
                        </div>
                        <div id="nickname-settings" class="tab-content hidden">
                            <h4>Manage Nicknames</h4>
                            <div id="nickname-list-container"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" data-close>Close</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="chatSettingsModal">
        <div class="modal">
            <div class="modal-header"><h3>Chat Settings</h3></div>
            <div class="modal-body">
                <button class="btn btn-secondary" id="unfriendBtn" style="width:100%; margin-bottom:10px;">Remove Friend</button>
                <button class="btn btn-danger" id="blockUserBtn" style="width:100%;">Block User</button>
            </div>
             <div class="modal-footer"><button class="btn btn-secondary" data-close>Close</button></div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {

    const EMOJI_LIST = ['😀','😃','😄','😁','😆','😅','😂','🤣','😊','😇','🙂','🙃','😉','😌','😍','🥰','😘','😗','😙','😚','😋','😛','😝','😜','🤪','🤨','🧐','🤓','😎','🤩','🥳','😏','😒','😞','😔','😟','😕','🙁','☹️','😣','😖','😫','😩','🥺','😢','😭','😤','😠','😡','🤬','🤯','😳','🥵','🥶','😱','😨','😰','😥','😓','🤗','🤔','🤭','🤫','🤥','😶','😐','😑','😬','🙄','😯','😦','😧','😮','😲','🥱','😴','🤤','😪','😵','🤐','🥴','🤢','🤮','🤧','😷','🤒','🤕','🤑','🤠','😈','👿','👹','👺','🤡','💩','👻','💀','☠️','👽','👾','🤖','🎃','😺','😸','😹','😻','😼','😽','🙀','😿','😾', '👍', '👎', '❤️', '🔥', '💯'];
    const PRESET_REACTIONS = ['👍', '❤️', '😂', '😮', '😢', '🙏'];
    const STATUS_OPTIONS = { online: 'Online', gaming: 'Gaming', working: 'Working', sleeping: 'Sleeping' };
    const PRESET_WALLPAPERS = {'Default': 'transparent', 'Dusk': '#34495e', 'Mint': '#bde0d2', 'Lavender': '#e6e6fa', 'Sunset': '#ffcaa6', 'Ocean': '#a2d5f2'};

    let currentUser, currentUserProfile, activeChat = { id: null, type: null, name: '' }, activeReply = {}, activeMessageElement;
    let unsubscribes = [];

    // DOM Refs
    const dom = {
        logoutBtn: document.getElementById('logoutBtn'),
        userNameEl: document.getElementById('userName'),
        userEmailEl: document.getElementById('userEmail'),
        currentUserStatusEl: document.getElementById('currentUserStatus'),
        friendRequestsListEl: document.getElementById('friendRequestsList'),
        groupChatsListEl: document.getElementById('groupChatsList'),
        friendsListEl: document.getElementById('friendsList'),
        blockedUsersListEl: document.getElementById('blockedUsersList'),
        chatPlaceholder: document.getElementById('chatPlaceholder'),
        chatWrapper: document.getElementById('chatWrapper'),
        chatHeaderInfoEl: document.getElementById('chatHeaderInfo'),
        messagesContainer: document.getElementById('messagesContainer'),
        messageForm: document.getElementById('messageForm'),
        messageInput: document.getElementById('messageInput'),
        sendMessageBtn: document.getElementById('sendMessageBtn'),
        replyPreviewBar: document.getElementById('reply-preview-bar'),
        cancelReplyBtn: document.getElementById('cancel-reply-btn'),
        reactionMenu: document.getElementById('reaction-menu'),
        emojiPickerModal: document.getElementById('emoji-picker-modal'),
        emojiGrid: document.getElementById('emoji-grid'),
        emojiPickerSearch: document.getElementById('emoji-picker-search'),
        mainSettingsModal: document.getElementById('mainSettingsModal'),
        chatSettingsBtn: document.getElementById('chatSettingsBtn'),
        chatSettingsModal: document.getElementById('chatSettingsModal'),
        unfriendBtn: document.getElementById('unfriendBtn'),
        blockUserBtn: document.getElementById('blockUserBtn')
    };

    const Cache = {
        get: key => JSON.parse(localStorage.getItem(key) || 'null'),
        set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),
        getProfiles: () => Cache.get('userProfiles') || {},
        setProfiles: p => Cache.set('userProfiles', p),
    };

    const openModal = el => el.classList.add('visible');
    const closeModal = el => el.classList.remove('visible');
    const getChatSecret = (chatId, type, partnerId) => {
        if (type === 'group') return chatId;
        if (!currentUser || !partnerId) return 'default_secret';
        return CryptoJS.SHA256([currentUser.uid, partnerId].sort().join("_")).toString();
    }
    const encrypt = (text, key) => CryptoJS.AES.encrypt(text, key).toString();
    const decrypt = (text, key) => { try { return CryptoJS.AES.decrypt(text, key).toString(CryptoJS.enc.Utf8) || ''; } catch { return '' } };

    firebase.auth().onAuthStateChanged(async user => {
        if (user) {
            currentUser = user;
            const userDocRef = firebase.firestore().collection('users').doc(currentUser.uid);
            await userDocRef.update({ 'status.current': 'online' }).catch(() => {});
            window.addEventListener('beforeunload', () => userDocRef.update({ 'status.current': 'offline' }));
            await setupUserProfile(userDocRef);
            setupListeners();
            initUI();
        } else { window.location.href = '../login.html'; }
    });

    async function setupUserProfile(ref) {
        const doc = await ref.get();
        if (!doc.exists) {
            await ref.set({
                username: currentUser.email.split('@')[0], email: currentUser.email, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                friends: [], blocked: [], status: { current: 'online' }, nicknames: {}
            });
        }
    }

    function setupListeners() {
        unsubscribes.forEach(unsub => unsub());
        unsubscribes = [];
        let profiles = Cache.getProfiles();
        const unsubUser = firebase.firestore().collection('users').doc(currentUser.uid).onSnapshot(doc => {
            currentUserProfile = { id: doc.id, ...doc.data() };
            profiles[currentUser.uid] = currentUserProfile;
            Cache.setProfiles(profiles);
            dom.userNameEl.textContent = currentUserProfile.username;
            dom.userEmailEl.textContent = currentUserProfile.email;
            dom.currentUserStatusEl.className = `status-indicator ${currentUserProfile.status?.current || 'offline'}`;
            renderFriendsList();
            renderBlockedList();
        });
        const unsubReqs = firebase.firestore().collection('friend_requests').where('receiverId', '==', currentUser.uid).onSnapshot(async snapshot => {
            const reqs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            await fetchAndCacheUsers(reqs.map(r => r.senderId));
            renderList(dom.friendRequestsListEl, reqs, req => {
                const li = document.createElement('li');
                li.innerHTML = `<div class="item-info">${Cache.getProfiles()[req.senderId]?.username || '...'}</div><div class="item-actions"><button onclick="window.acceptFR('${req.id}','${req.senderId}')"><i class="fas fa-check"></i></button><button onclick="window.deleteFR('${req.id}')"><i class="fas fa-times"></i></button></div>`;
                return li;
            }, 'No new requests.');
        });
        unsubscribes.push(unsubUser, unsubReqs);
    }
    
    async function fetchAndCacheUsers(uids) {
        const profiles = Cache.getProfiles();
        const toFetch = [...new Set(uids)].filter(uid => uid && !profiles[uid]);
        if (toFetch.length === 0) return;
        const chunks = [];
        for (let i = 0; i < toFetch.length; i += 10) chunks.push(toFetch.slice(i, i + 10));
        await Promise.all(chunks.map(async chunk => {
            const snap = await firebase.firestore().collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', chunk).get();
            snap.forEach(doc => profiles[doc.id] = { id: doc.id, ...doc.data() });
        }));
        Cache.setProfiles(profiles);
    }

    function getDisplayName(userId) { return currentUserProfile?.nicknames?.[userId] || Cache.getProfiles()[userId]?.username || '...'; }
    
    function renderList(el, items, renderItem, emptyMsg) {
        el.innerHTML = '';
        if (!items || items.length === 0) { el.innerHTML = `<li class="empty-state">${emptyMsg}</li>`; return; }
        items.forEach(item => { const li = renderItem(item); if (li) el.appendChild(li); });
    }

    async function renderFriendsList() {
        if (!currentUserProfile?.friends) return;
        await fetchAndCacheUsers(currentUserProfile.friends);
        renderList(dom.friendsListEl, currentUserProfile.friends, uid => {
            const li = document.createElement('li');
            const chatId = [currentUser.uid, uid].sort().join('_');
            li.dataset.chatId = chatId;
            if (activeChat.id === chatId) li.classList.add('active-chat');
            li.innerHTML = `<div class="item-info"><i class="fas fa-user-circle"></i> <span>${getDisplayName(uid)}</span></div>`;
            li.onclick = () => openChat({ id: chatId, type: 'dm', partnerId: uid, name: getDisplayName(uid) });
            return li;
        }, 'No friends added.');
    }
    
    async function renderBlockedList() {
        if (!currentUserProfile?.blocked) return;
        await fetchAndCacheUsers(currentUserProfile.blocked);
        renderList(dom.blockedUsersListEl, currentUserProfile.blocked, uid => {
            const li = document.createElement('li');
            li.innerHTML = `<div class="item-info">${getDisplayName(uid)}</div><div class="item-actions"><button onclick="window.unblockUser('${uid}')"><i class="fas fa-unlock"></i></button></div>`;
            return li;
        }, 'No blocked users.');
    }

    async function openChat(chatConfig) {
        if (activeChat.id === chatConfig.id) return;
        activeChat = chatConfig;
        dom.chatWrapper.classList.remove('hidden');
        dom.chatPlaceholder.classList.add('hidden');
        dom.messageInput.disabled = false;
        dom.sendMessageBtn.disabled = false;
        dom.chatHeaderInfoEl.textContent = activeChat.name;
        document.querySelectorAll('.item-list li').forEach(li => li.classList.remove('active-chat'));
        document.querySelector(`[data-chat-id="${activeChat.id}"]`)?.classList.add('active-chat');
        const wallpaper = localStorage.getItem(`wallpaper_${activeChat.id}`) || 'transparent';
        dom.messagesContainer.style.backgroundColor = wallpaper;

        dom.messagesContainer.innerHTML = '';
        const chatUnsubIndex = unsubscribes.findIndex(u => u.isChatListener);
        if (chatUnsubIndex > -1) { unsubscribes[chatUnsubIndex](); unsubscribes.splice(chatUnsubIndex, 1); }

        const collPath = activeChat.type === 'group' ? `groups/${activeChat.id}/messages` : `chats/${activeChat.id}/messages`;
        const chatUnsub = firebase.firestore().collection(collPath).orderBy('createdAt').onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                const data = { id: change.doc.id, ...change.doc.data() };
                if (change.type === 'added') renderMessage(data);
                if (change.type === 'modified') {
                    const msgEl = dom.messagesContainer.querySelector(`[data-message-id="${data.id}"]`);
                    if (msgEl) msgEl.replaceWith(createMessageElement(data));
                }
                if (change.type === 'removed') dom.messagesContainer.querySelector(`[data-message-id="${data.id}"]`)?.remove();
            });
            dom.messagesContainer.scrollTop = dom.messagesContainer.scrollHeight;
        });
        chatUnsub.isChatListener = true;
        unsubscribes.push(chatUnsub);
    }
    
    function createMessageElement(data) {
        const wrapper = document.createElement('div');
        wrapper.className = `message-wrapper ${data.authorId === currentUser.uid ? 'sent' : 'received'}`;
        wrapper.dataset.messageId = data.id;

        const secretKey = getChatSecret(activeChat.id, activeChat.type, activeChat.partnerId);
        let replyHTML = '';
        if (data.replyingTo?.messageId) {
            replyHTML = `<div class="reply-context"><strong>Replying to ${getDisplayName(data.replyingTo.senderId)}</strong><p>${data.replyingTo.textSnippet}</p></div>`;
        }
        let bodyHTML = data.isDeleted ? `<span class="message-text deleted"><i class="fas fa-ban"></i> Message deleted</span>` : `<span class="message-text">${decrypt(data.text, secretKey)}</span>`;
        const time = data.createdAt?.toDate ? new Date(data.createdAt.toDate()).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : '';
        
        wrapper.innerHTML = `${replyHTML}<div class="message-content">${bodyHTML}</div><div class="message-meta">${time}${data.editedAt ? ' (edited)' : ''}</div><div class="reactions-container"></div>
            <div class="message-actions">
                <button data-action="reply"><i class="fas fa-reply"></i></button><button data-action="react"><i class="far fa-smile"></i></button>
                ${data.authorId === currentUser.uid && !data.isDeleted ? `<button data-action="edit"><i class="fas fa-pencil-alt"></i></button><button data-action="delete"><i class="fas fa-trash"></i></button>` : ''}
            </div>`;
        return wrapper;
    }

    function renderMessage(data) {
        const el = createMessageElement(data);
        dom.messagesContainer.appendChild(el);
        listenForReactions(data.id);
    }

    function listenForReactions(messageId) {
        const collPath = activeChat.type === 'group' ? `groups/${activeChat.id}/messages/${messageId}/reactions` : `chats/${activeChat.id}/messages/${messageId}/reactions`;
        const unsub = firebase.firestore().collection(collPath).onSnapshot(snapshot => {
            const reactions = {};
            snapshot.forEach(doc => {
                const emoji = doc.data().emoji;
                if (emoji) reactions[emoji] = (reactions[emoji] || 0) + 1;
            });
            const container = document.querySelector(`[data-message-id="${messageId}"] .reactions-container`);
            if (container) {
                container.innerHTML = Object.entries(reactions).map(([emoji, count]) => `<div class="reaction-chip"><span>${emoji}</span><span class="count">${count}</span></div>`).join('');
            }
        });
        unsubscribes.push(unsub);
    }
    
    dom.messageForm.addEventListener('submit', async e => {
        e.preventDefault();
        const text = dom.messageInput.value.trim();
        if (!text || !activeChat.id) return;
        const collPath = activeChat.type === 'group' ? `groups/${activeChat.id}/messages` : `chats/${activeChat.id}/messages`;
        const messageData = { text: encrypt(text, getChatSecret(activeChat.id, activeChat.type, activeChat.partnerId)), authorId: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
        if (activeReply.messageId) messageData.replyingTo = activeReply;
        await firebase.firestore().collection(collPath).add(messageData);
        dom.messageInput.value = '';
        cancelReply();
    });

    dom.messagesContainer.addEventListener('click', e => {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        activeMessageElement = btn.closest('.message-wrapper');
        const messageId = activeMessageElement.dataset.messageId;
        const action = btn.dataset.action;
        if (action === 'reply') startReply(messageId);
        if (action === 'react') showReactionMenu(btn, messageId);
        if (action === 'delete') window.deleteMessage(messageId);
    });

    function startReply(messageId) {
        const msgEl = document.querySelector(`[data-message-id="${messageId}"]`);
        const text = msgEl.querySelector('.message-text').textContent;
        const isSent = msgEl.classList.contains('sent');
        activeReply = { messageId, textSnippet: text.substring(0, 50) + (text.length > 50 ? '...' : ''), senderId: isSent ? currentUser.uid : activeChat.partnerId };
        dom.replyPreviewBar.classList.remove('hidden');
        dom.replyPreviewBar.querySelector('strong').textContent = getDisplayName(activeReply.senderId);
        dom.replyPreviewBar.querySelector('#reply-text-snippet').textContent = activeReply.textSnippet;
        dom.messageInput.focus();
    }
    
    function cancelReply() {
        activeReply = {};
        dom.replyPreviewBar.classList.add('hidden');
    }
    dom.cancelReplyBtn.addEventListener('click', cancelReply);

    function showReactionMenu(btn, messageId) {
        dom.reactionMenu.innerHTML = PRESET_REACTIONS.map(e => `<button class="emoji-btn">${e}</button>`).join('') + `<button class="emoji-btn" data-action="more"><i class="fas fa-plus"></i></button>`;
        dom.reactionMenu.dataset.messageId = messageId;
        document.body.appendChild(dom.reactionMenu);
        const rect = btn.getBoundingClientRect();
        dom.reactionMenu.style.top = `${rect.top - dom.reactionMenu.offsetHeight - 10}px`;
        dom.reactionMenu.style.left = `${rect.left + rect.width / 2 - dom.reactionMenu.offsetWidth / 2}px`;
        dom.reactionMenu.classList.add('visible');
    }

    dom.reactionMenu.addEventListener('click', e => {
        const btn = e.target.closest('.emoji-btn');
        if (!btn) return;
        const messageId = dom.reactionMenu.dataset.messageId;
        if (btn.dataset.action === 'more') {
            openModal(dom.emojiPickerModal);
            dom.emojiPickerModal.dataset.messageId = messageId;
        } else {
            toggleReaction(messageId, btn.textContent);
        }
        dom.reactionMenu.classList.remove('visible');
    });

    async function toggleReaction(messageId, emoji) {
        const collPath = activeChat.type === 'group' ? `groups/${activeChat.id}/messages/${messageId}/reactions` : `chats/${activeChat.id}/messages/${messageId}/reactions`;
        const reactionRef = firebase.firestore().collection(collPath).doc(currentUser.uid);
        const doc = await reactionRef.get();
        if (doc.exists && doc.data().emoji === emoji) await reactionRef.delete();
        else await reactionRef.set({ emoji, reactedBy: currentUser.uid });
    }
    
    function initUI() {
        populateEmojiPicker();
        dom.emojiPickerSearch.addEventListener('input', e => populateEmojiPicker(e.target.value));
        dom.emojiGrid.addEventListener('click', e => {
            const btn = e.target.closest('.emoji-btn');
            if(btn) {
                toggleReaction(dom.emojiPickerModal.dataset.messageId, btn.textContent);
                closeModal(dom.emojiPickerModal);
            }
        });
        document.addEventListener('click', e => {
            if (!dom.reactionMenu.contains(e.target) && !e.target.closest('[data-action="react"]')) dom.reactionMenu.classList.remove('visible');
        });
        document.querySelectorAll('[data-close]').forEach(el => el.addEventListener('click', () => closeModal(el.closest('.modal-overlay'))));
        initSettings();
    }
    
    function populateEmojiPicker(searchTerm = '') {
        const filtered = EMOJI_LIST.filter(e => e.includes(searchTerm));
        dom.emojiGrid.innerHTML = filtered.map(e => `<button class="emoji-btn">${e}</button>`).join('');
    }

    function initSettings() {
        const settingsModal = dom.mainSettingsModal;
        document.getElementById('manageSettingsBtn').addEventListener('click', () => openModal(settingsModal));
        settingsModal.querySelectorAll('.settings-nav-link').forEach(link => link.addEventListener('click', () => {
            settingsModal.querySelectorAll('.settings-nav-link, .tab-content').forEach(el => el.classList.remove('active', 'hidden'));
            link.classList.add('active');
            settingsModal.querySelector(`#${link.dataset.tab}`).classList.remove('hidden');
        }));
        
        // Status
        const statusSelect = document.getElementById('status-select');
        statusSelect.innerHTML = Object.entries(STATUS_OPTIONS).map(([val, txt]) => `<option value="${val}">${txt}</option>`).join('');
        statusSelect.value = currentUserProfile?.status?.current || 'online';
        statusSelect.addEventListener('change', e => firebase.firestore().collection('users').doc(currentUser.uid).update({'status.current': e.target.value}));

        // Wallpaper
        const wallpaperOptions = settingsModal.querySelector('.wallpaper-color-options');
        wallpaperOptions.innerHTML = Object.entries(PRESET_WALLPAPERS).map(([name, color]) => `<div class="wallpaper-color-swatch" style="background-color: ${color};" data-color="${color}" title="${name}"></div>`).join('');
        wallpaperOptions.addEventListener('click', e => {
            const swatch = e.target.closest('.wallpaper-color-swatch');
            if(!swatch || !activeChat.id) return;
            localStorage.setItem(`wallpaper_${activeChat.id}`, swatch.dataset.color);
            dom.messagesContainer.style.backgroundColor = swatch.dataset.color;
        });
        
        // Nicknames
        populateNicknames();
    }

    async function populateNicknames() {
        const container = document.getElementById('nickname-list-container');
        if (!currentUserProfile?.friends?.length) { container.innerHTML = '<p>No friends to set nicknames for.</p>'; return; }
        await fetchAndCacheUsers(currentUserProfile.friends);
        container.innerHTML = currentUserProfile.friends.map(id => `<div class="nickname-item"><span>${Cache.getProfiles()[id]?.username}</span><input type="text" value="${currentUserProfile.nicknames?.[id] || ''}" onchange="window.saveNickname('${id}', this.value)" placeholder="Set Nickname"></div>`).join('');
    }
    
    dom.chatSettingsBtn.addEventListener('click', () => {
        if (activeChat.type === 'dm') openModal(dom.chatSettingsModal);
    });
    dom.unfriendBtn.addEventListener('click', () => {
        if(confirm(`Are you sure you want to remove ${activeChat.name} as a friend?`)) {
            window.unfriendUser(activeChat.partnerId);
            closeModal(dom.chatSettingsModal);
        }
    });
    dom.blockUserBtn.addEventListener('click', () => {
        if(confirm(`Are you sure you want to block ${activeChat.name}? You will no longer see their messages.`)) {
            window.blockUser(activeChat.partnerId);
            closeModal(dom.chatSettingsModal);
        }
    });

    });

    // Global Functions for inline events
    window.acceptFR = async (reqId, senderId) => {
        const db = firebase.firestore();
        const batch = db.batch();
        batch.update(db.collection('users').doc(window.currentUser.uid), { friends: firebase.firestore.FieldValue.arrayUnion(senderId) });
        batch.update(db.collection('users').doc(senderId), { friends: firebase.firestore.FieldValue.arrayUnion(window.currentUser.uid) });
        batch.delete(db.collection('friend_requests').doc(reqId));
        await batch.commit();
    };
    window.deleteFR = reqId => firebase.firestore().collection('friend_requests').doc(reqId).delete();
    window.unblockUser = uid => firebase.firestore().collection('users').doc(window.currentUser.uid).update({ blocked: firebase.firestore.FieldValue.arrayRemove(uid) });
    window.deleteMessage = msgId => {
        if(!confirm('Delete this message?')) return;
        const collPath = window.activeChat.type === 'group' ? `groups/${window.activeChat.id}/messages` : `chats/${window.activeChat.id}/messages`;
        firebase.firestore().collection(collPath).doc(msgId).update({ text: '', isDeleted: true });
    };
    window.saveNickname = (friendId, newName) => {
        firebase.firestore().collection('users').doc(window.currentUser.uid).update({ [`nicknames.${friendId}`]: newName.trim() });
    };
    window.unfriendUser = friendId => {
        const db = firebase.firestore();
        const batch = db.batch();
        batch.update(db.collection('users').doc(window.currentUser.uid), { friends: firebase.firestore.FieldValue.arrayRemove(friendId) });
        batch.update(db.collection('users').doc(friendId), { friends: firebase.firestore.FieldValue.arrayRemove(window.currentUser.uid) });
        batch.commit().catch(err => {
            // If rules prevent updating other user, do a one-sided removal
            db.collection('users').doc(window.currentUser.uid).update({ friends: firebase.firestore.FieldValue.arrayRemove(friendId) });
        });
    };
    window.blockUser = userId => {
        window.unfriendUser(userId); // Also unfriend them
        firebase.firestore().collection('users').doc(window.currentUser.uid).update({ blocked: firebase.firestore.FieldValue.arrayUnion(userId) });
    };
    </script>
</body>
</html>
