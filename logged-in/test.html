<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4SP - DASHBOARD</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="../panic-key.js"></script>
  <script src="../ban-enforcer.js"></script>
  <script src="../url-changer.js"></script>

  <style>
    /* --- Dashboard Layout --- */
    body.dashboard-page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
      font-family: 'PrimaryFont', sans-serif;
    }

    .dashboard-container {
      display: flex;
      flex: 1;
    }

    /* --- Sidebar --- */
    .sidebar {
      width: 200px;
      background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
      color: #fff;
      padding: 20px 10px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #444;
      transition: width 0.5s ease-in-out;
      position: relative;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }

    .sidebar.collapsed {
      width: 85px;
    }

    #toggleSidebar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2em;
      cursor: pointer;
      padding: 4px;
      transition: transform 0.5s ease-in-out;
    }

    .sidebar.collapsed #toggleSidebar {
      transform: translateX(-50%) rotate(180deg);
    }

    .sidebar nav ul {
      list-style: none;
      padding: 0;
      margin: 60px 0 0;
    }

    .sidebar nav li {
      margin-bottom: 10px;
    }

    .sidebar nav a {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: #fff;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-family: 'PrimaryFont', sans-serif;
      text-transform: uppercase;
    }

    .sidebar nav a.active,
    .sidebar nav a:hover {
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      transform: translateX(5px);
    }

    .sidebar nav a .icon {
      font-size: 1.2em;
      width: 24px;
      text-align: center;
    }

    .sidebar nav a .label {
      margin-left: 10px;
      white-space: nowrap;
      opacity: 1;
      visibility: visible;
      transition: opacity 0.2s ease-in-out;
      transition-delay: 0.4s;
    }

    .sidebar.collapsed nav a .label {
      opacity: 0;
      visibility: hidden;
      transition-delay: 0s;
    }

    /* --- Main Content & Controls --- */
    .main-content {
      flex: 1;
      padding: 40px;
      background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
      overflow-y: auto;
      position: relative;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(103, 32, 189, 0.1);
      position: relative;
    }

    .dashboard-title {
      margin: 0;
      font-size: 2.2em;
      font-weight: bold;
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* --- Dashboard Grid & Cards --- */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      position: relative;
    }

    @media (min-width: 768px) {
      .dashboard-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
    }

    @media (min-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: repeat(6, 1fr);
      }
    }

    .dashboard-card {
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 6px 30px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(103, 32, 189, 0.1);
      position: relative;
      user-select: none;
      z-index: 2;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
      min-height: 200px;
      grid-column: span 1;
    }

    @media (min-width: 1200px) {
      .dashboard-card[data-card-type="medium"] {
        grid-column: span 3;
      }
      .dashboard-card[data-card-type="small"] {
        grid-column: span 2;
      }
      .dashboard-card[data-card-type="full"] {
        grid-column: span 6;
      }
    }

    .dashboard-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 15px 40px rgba(103, 32, 189, 0.15);
      border-color: rgba(103, 32, 189, 0.3);
    }

    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(103, 32, 189, 0.1);
      justify-content: flex-start;
      flex-shrink: 0;
      position: relative;
    }

    .card-icon {
      font-size: 2em;
      margin-right: 12px;
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 2px 4px rgba(103, 32, 189, 0.2));
    }

    .card-title {
      font-size: 1.3em;
      font-weight: bold;
      margin: 0;
      color: #333;
      flex-grow: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-header-buttons {
      position: relative;
      margin-left: auto;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .weather-action-btn {
      background: rgba(103, 32, 189, 0.08);
      border: none;
      cursor: pointer;
      padding: 8px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      z-index: 5;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .weather-action-btn img {
      width: 22px;
      height: 22px;
      display: block;
      filter: invert(0.3) brightness(100%);
    }

    .weather-action-btn:hover {
      background-color: rgba(103, 32, 189, 0.15);
      transform: translateY(-2px);
    }

    .weather-action-btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      transform: translateY(0);
    }

    @keyframes spin-clockwise {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    .weather-refresh-btn.refreshing img {
      animation: spin-clockwise 0.8s linear infinite;
    }

    .card-content-inner {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    /* --- Super Widget Specific Styles --- */
    .super-widget-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      height: 100%;
      flex-grow: 1;
    }

    .super-widget-clock-section {
      flex: 1 1 300px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .super-widget-weather-section {
      flex: 2 1 400px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      border-left: 1px solid rgba(103, 32, 189, 0.1);
      padding-left: 20px;
    }

    @media (max-width: 900px) {
      .super-widget-weather-section {
        border-left: none;
        padding-left: 0;
        border-top: 1px solid rgba(103, 32, 189, 0.1);
        padding-top: 20px;
      }
    }

    .weather-large-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      justify-content: flex-start;
    }

    .current-weather-layout {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(103, 32, 189, 0.08);
      width: 100%;
      box-sizing: border-box;
    }

    .weather-icon-large {
      font-size: 3.2em;
      color: #6720bd;
      flex-shrink: 0;
    }

    .current-weather-main-info {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      flex-grow: 1;
    }

    .temp-large {
      font-size: 2.3em;
      font-weight: bold;
      color: #333;
      line-height: 1.1;
    }

    .condition-large {
      font-size: 0.95em;
      color: #555;
    }

    .current-weather-details-aside {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      font-size: 0.75em;
      color: #777;
      line-height: 1.4;
      flex-shrink: 0;
      padding-left: 12px;
      border-left: 1px solid rgba(103, 32, 189, 0.1);
      text-align: right;
    }

    .current-weather-details-aside p {
      margin: 0;
    }

    .forecast-large {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 4px;
      padding: 6px 0px;
      margin-bottom: 8px;
    }

    .forecast-day {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      padding: 8px 4px;
      background-color: #ffffff;
      border-radius: 12px;
      min-width: 70px;
      text-align: center;
      border: 1.25px solid rgba(103, 32, 189, 0.2);
      cursor: pointer;
      transition: all 0.2s ease;
      height: 82.5px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .forecast-day:hover {
      background-color: rgba(103, 32, 189, 0.1);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(103, 32, 189, 0.1);
    }

    .forecast-day .day-name {
      font-size: 0.75em;
      font-weight: 600;
      color: #555;
    }

    .forecast-day .icon {
      font-size: 1.6em;
      color: #6720bd;
      line-height: 1;
    }

    .forecast-day .temps {
      font-size: 0.8em;
      color: #333;
    }

    .clock-display {
      font-size: 3.5em;
      font-weight: bold;
      color: #333;
      text-align: left;
      margin-bottom: 5px;
    }

    .date-display {
      font-size: 1.5em;
      color: #666;
      text-align: left;
    }

    .dashboard-countdown-section {
      margin-top: 15px;
      border-top: 1px solid rgba(103, 32, 189, 0.1);
      padding-top: 15px;
    }

    .dashboard-countdown-display-name {
      font-size: 1em;
      font-weight: 600;
      color: #444;
      margin: 0 0 5px 0;
      text-align: left;
    }

    .dashboard-countdown-display-timer {
      font-size: 1.5em;
      font-weight: bold;
      color: #6720bd;
      text-align: left;
      min-height: 1.5em;
    }

    .dashboard-countdown-display-timer .time-unit {
      display: inline-block;
      margin: 0 4px;
      text-align: center;
    }

    .dashboard-countdown-display-timer .time-label {
      display: block;
      font-size: 0.5em;
      color: #888;
      font-weight: normal;
    }

    .quick-actions-list button {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 12px 15px;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      text-align: left;
      font-family: 'PrimaryFont', sans-serif;
      font-size: 1.1em;
      text-transform: uppercase;
      color: #495057;
      cursor: pointer;
      transition: all .2s ease;
      height: 42.5px;
    }

    .quick-actions-list button:hover {
      background-color: #e9ecef;
      border-color: #dee2e6;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, .05);
    }

    .quick-actions-list button .icon {
      font-size: 1.5em;
      margin-right: 12px;
      color: #6720bd;
    }

    /* --- Settings Modal Redesign --- */
    .overview-settings-modal .modal-content {
      max-width: 850px;
      width: 95%;
      gap: 0;
      padding: 0;
    }

    .overview-settings-modal .modal-header {
      padding: 20px 30px;
      border-bottom: 1px solid #eee;
      position: relative;
    }

    .overview-settings-modal h3 {
      margin: 0;
      text-align: center;
      font-size: 1.8em;
      color: #6720bd;
      font-weight: bold;
    }

    .overview-settings-modal .modal-close-btn {
      position: absolute;
      top: 50%;
      right: 25px;
      transform: translateY(-50%);
    }

    .settings-tabs {
      display: flex;
      background-color: #f9fafd;
      padding: 5px;
      border-bottom: 1px solid #e0e4e9;
    }

    .settings-tab-btn {
      flex: 1;
      padding: 12px 10px;
      border: none;
      background-color: transparent;
      font-family: 'PrimaryFont', sans-serif;
      font-size: 1em;
      font-weight: 600;
      color: #555;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }

    .settings-tab-btn.active {
      color: #6720bd;
      border-bottom-color: #6720bd;
    }

    .settings-tab-content {
      display: none;
      padding: 30px;
    }

    .settings-tab-content.active {
      display: block;
    }

    .settings-section {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 25px;
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .settings-section label,
    .settings-section .section-label {
      font-weight: 600;
      color: #333;
      font-size: 1.1em;
      margin-bottom: 5px;
    }

    #overviewLocationInput {
      width: 100%;
      padding: 12px 15px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      font-family: 'PrimaryFont', sans-serif;
    }

    #overviewUseCurrentLocationBtn {
      padding: 10px 15px;
      font-size: 0.95em;
      font-weight: 600;
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'PrimaryFont', sans-serif;
    }

    .unit-toggle-wrapper {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 10px;
    }

    .data-source-selector input[type="radio"]:checked+label {
      background-color: #6720bd;
      border-color: #8a2be2;
      color: white;
    }

    /* --- Fullscreen Additions --- */
    #fullscreen-weather-display {
      position: absolute;
      top: 20px;
      right: 80px;
      text-align: right;
      font-size: 1.5vw;
      text-shadow: 0 0 10px black;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: right 0.5s ease-in-out;
    }

    #fullscreen-weather-display .icon {
      font-size: 2em;
    }

    #fullscreen-weather-display .temp {
      font-weight: bold;
    }

    #fullscreen-weather-display .condition {
      font-size: 0.7em;
    }

    #clock-fs-color-palette .color-swatch-custom {
      background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);
    }

    #color-picker-input {
      visibility: hidden;
      width: 0;
      height: 0;
      position: absolute;
    }

    #clock-fullscreen-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      color: white;
      z-index: 2000;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
      background: #0a0a14;
      transition: background 0.5s ease;
      user-select: none;
    }

    #clock-fullscreen-overlay.active {
      display: flex;
    }

    #clock-fullscreen-overlay.inactive-cursor {
      cursor: none;
    }

    #clock-fs-main-time {
      font-size: 12vw;
      font-weight: bold;
    }

    #clock-fs-main-date {
      font-size: 2.5vw;
      margin-top: -1vh;
    }

    #clock-fs-countdown-section {
      margin-top: 5vh;
      min-height: 15vh;
      width: 100%;
    }

    #clock-fs-countdown-name {
      font-size: 2vw;
      font-weight: 500;
    }

    #clock-fs-countdown-timer {
      font-size: 4vw;
      font-weight: bold;
    }

    #clock-fs-countdown-timer .time-unit {
      display: inline-block;
      margin: 0 0.5vw;
    }

    #clock-fs-countdown-timer .time-label {
      font-size: 0.3em;
      display: block;
      margin-top: -0.5vh;
    }

    .clock-fs-controls,
    .clock-fs-right-controls {
      opacity: 1;
      visibility: visible;
      position: absolute;
      top: 20px;
      transition: opacity 0.5s ease-in-out;
    }

    .clock-fs-controls {
      left: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .clock-fs-right-controls {
      right: 20px;
    }

    .clock-fs-controls.controls-hidden,
    .clock-fs-right-controls.controls-hidden {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease-in-out, visibility 0s linear 0.5s;
    }

    #clock-fs-color-toggle {
      font-size: 1.8em;
      cursor: pointer;
      transition: transform 0.3s;
    }

    #clock-fs-color-toggle:hover {
      transform: rotate(45deg);
    }

    #clock-fs-color-palette {
      position: absolute;
      top: 70px;
      right: 20px;
      width: 152px;
      background: rgba(255, 255, 255, .1);
      backdrop-filter: blur(5px);
      border-radius: 12px;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      z-index: 2001;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s;
    }

    #clock-fs-color-palette.visible {
      opacity: 1;
      visibility: visible;
    }

    .color-swatch {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid white;
      transition: transform 0.2s;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
    }

    .color-swatch:hover {
      transform: scale(1.1);
    }

    .custom-select-wrapper {
      position: relative;
      font-family: 'PrimaryFont', sans-serif;
    }

    .custom-select-trigger {
      background: rgba(255, 255, 255, .15);
      color: white;
      border: 1px solid rgba(255, 255, 255, .3);
      border-radius: 12px;
      padding: 10px 30px 10px 15px;
      cursor: pointer;
      position: relative;
      width: 250px;
      transition: background-color 0.2s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 1em;
    }

    #overviewSettingsModal .custom-select-trigger {
      background: #fff;
      color: #333;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }

    .custom-select-trigger:hover {
      background: rgba(255, 255, 255, .25);
    }

    #overviewSettingsModal .custom-select-trigger:hover {
      background-color: #f0f2f5;
    }

    .custom-select-trigger::after {
      content: "▼";
      font-size: .7em;
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      transition: transform .2s;
    }

    .custom-select.open .custom-select-trigger::after {
      transform: translateY(-50%) rotate(180deg);
    }

    .custom-options {
      position: absolute;
      top: 105%;
      left: 0;
      right: 0;
      background: rgba(40, 40, 40, .7);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, .2);
      border-radius: 12px;
      z-index: 10;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }

    #overviewSettingsModal .custom-options {
      background: white;
      border: 1px solid #ddd;
      color: #333;
    }

    .custom-select.open .custom-options {
      display: block;
    }

    .custom-option {
      display: block;
      padding: 12px 15px;
      cursor: pointer;
      transition: background-color 0.2s;
      white-space: normal;
      word-break: break-word;
    }

    .custom-option:hover {
      background-color: rgba(255, 255, 255, .1);
    }

    #overviewSettingsModal .custom-option:hover {
      background-color: #f0f2f5;
    }

    .custom-option.selected {
      background-color: rgba(138, 43, 226, .5);
      font-weight: bold;
    }

    #overviewSettingsModal .custom-option.selected {
      background-color: #e9ecef;
    }
  </style>
</head>
<body class="dashboard-page">
  <header class="main-header light-bg">
    <div class="container">
      <div class="logo">
        <a href="../index.html"> <img src="../images/logo-dark.png" alt="4SP Logo" /> </a>
      </div>
      <div class="auth-buttons">
        <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
        <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
      </div>
    </div>
  </header>
  <div class="dashboard-container">
    <aside class="sidebar" id="sidebar">
      <button id="toggleSidebar">☰</button>
      <nav>
        <ul>
          <li><a href="dashboard.html" class="active"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
          <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
          <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
          <li><a href="apps.html"><span class="icon">✨</span><span class="label">Apps</span></a></li>
          <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
          <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
        </ul>
      </nav>
    </aside>
    <main class="main-content">
      <div class="dashboard-header">
        <h2 class="dashboard-title">Dashboard</h2>
      </div>
      <div class="dashboard-grid" id="dashboardGrid"></div>
    </main>
  </div>

  <div id="clock-fullscreen-overlay">
    <div id="fullscreen-weather-display" style="display: none;"></div>
    <div class="clock-fs-controls">
      <div class="custom-select-wrapper" id="fullscreen-countdown-select-wrapper">
        <div class="custom-select">
          <div class="custom-select-trigger"><span>No Countdown</span></div>
          <div class="custom-options"> <span class="custom-option selected" data-value="">No Countdown</span> </div>
        </div>
      </div>
    </div>
    <div class="clock-fs-right-controls">
      <div id="clock-fs-color-toggle" title="Change Background">🎨</div>
    </div>
    <div id="clock-fs-color-palette">
      <div class="color-swatch" style="background: #0a0a14;" data-color="#0a0a14"></div>
      <div class="color-swatch" style="background: linear-gradient(135deg, #23074d, #cc5333);" data-color="linear-gradient(135deg, #23074d, #cc5333)"></div>
      <div class="color-swatch" style="background: linear-gradient(135deg, #1f4037, #99f2c8);" data-color="linear-gradient(135deg, #1f4037, #99f2c8)"></div>
      <div class="color-swatch" style="background: linear-gradient(135deg, #780206, #061161);" data-color="linear-gradient(135deg, #780206, #061161)"></div>
      <div class="color-swatch" style="background: #2c3e50;" data-color="#2c3e50"></div>
      <div class="color-swatch color-swatch-custom" title="Custom Color"></div>
      <input type="color" id="color-picker-input">
    </div>
    <div id="clock-fs-main-time">00:00:00</div>
    <div id="clock-fs-main-date">Day, Month Date, Year</div>
    <div id="clock-fs-countdown-section">
      <h3 id="clock-fs-countdown-name"></h3>
      <div id="clock-fs-countdown-timer"></div>
    </div>
  </div>

  <div id="forecastDetailModal" class="modal">
    <div class="modal-content">
      <button class="modal-close-btn">&times;</button>
      <div class="modal-header-section">
        <h3 id="modalDayDate">Day, Date</h3>
        <p class="date-subtitle" id="modalFullDateSubtitle"></p>
      </div>
      <div class="modal-current-weather-summary"> <span id="modalWeatherIcon" class="modal-icon-large">❓</span>
        <div class="modal-temp-and-desc">
          <div class="modal-temp-display"> <span id="modalMaxTemp">--</span> / <span id="modalMinTemp">--</span> </div>
          <div id="modalWeatherDesc">Description</div>
        </div>
      </div>
      <div class="modal-details-grid">
        <p><strong><span class="detail-icon">🌡️</span>Feels Like:</strong> <span id="modalFeelsLike">--</span></p>
        <p><strong><span class="detail-icon">💧</span>Humidity:</strong> <span id="modalHumidity">--</span>%</p>
        <p><strong><span class="detail-icon">🌧️</span>Precipitation:</strong> <span id="modalPrecipSum">--</span> mm</p>
        <p><strong><span class="detail-icon">☔</span>Precip. Chance:</strong> <span id="modalPrecipProb">--</span>%</p>
        <p><strong><span class="detail-icon">💨</span>Max Wind:</strong> <span id="modalWindSpeed">--</span></p>
        <p><strong><span class="detail-icon">🧭</span>Wind Direction:</strong> <span id="modalWindDirection">--</span></p>
        <p><strong><span class="detail-icon">☀️</span>Sunrise:</strong> <span id="modalSunriseTime">--:--</span></p>
        <p><strong><span class="detail-icon">🌇</span>Sunset:</strong> <span id="modalSunsetTime">--:--</span></p>
        <p><strong><span class="detail-icon">💡</span>Daylight:</strong> <span id="modalDaylightDuration">--</span></p>
      </div>
      <div class="modal-advice-section">
        <h4><span class="detail-icon">💡</span> Daily Advice</h4>
        <div id="modalDailyAdvice">Checking the forecast for tips...</div>
      </div>
    </div>
  </div>

  <div id="overviewSettingsModal" class="modal overview-settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Overview Settings</h3>
        <button class="modal-close-btn">&times;</button>
      </div>
      <div class="settings-tabs">
        <button class="settings-tab-btn active" data-tab="tab-general">General</button>
        <button class="settings-tab-btn" data-tab="tab-weather">Weather</button>
        <button class="settings-tab-btn" data-tab="tab-countdown">Countdown</button>
      </div>
      <div class="settings-tab-content active" id="tab-general">
        <div class="settings-section">
          <span class="section-label">Title Bar Display</span>
          <p style="font-size: 0.9em; color: #666; margin-top: -10px;">Choose what appears in the browser tab title when the fullscreen clock is active.</p>
          <div class="custom-select-wrapper" id="overview-title-select-wrapper">
            <div class="custom-select">
              <div class="custom-select-trigger"><span>None</span></div>
              <div class="custom-options">
                <span class="custom-option" data-value="none">None</span>
                <span class="custom-option" data-value="time">Current Time</span>
                <span class="custom-option" data-value="countdown">Current Countdown</span>
              </div>
            </div>
          </div>
        </div>
        <div class="settings-section">
          <span class="section-label">Fullscreen Options</span>
          <div class="unit-toggle-wrapper">
            <span>Show Weather in Fullscreen</span>
            <label class="switch"><input type="checkbox" id="fullscreenWeatherToggle"><span class="slider"></span></label>
          </div>
        </div>
      </div>
      <div class="settings-tab-content" id="tab-weather">
        <div class="settings-section">
          <label for="overviewLocationInput">Location</label>
          <div class="location-input-wrapper">
            <input type="text" id="overviewLocationInput" placeholder="Enter a city name...">
            <ul id="overviewLocationSuggestions"></ul>
          </div>
          <button id="overviewUseCurrentLocationBtn">📍 Use My Current Location</button>
        </div>
        <div class="settings-section">
          <label>Data Source</label>
          <div class="data-source-selector">
            <input type="radio" id="sourceOpenMeteo" name="dataSource" value="open-meteo" checked>
            <label for="sourceOpenMeteo">Open-Meteo</label>
            <input type="radio" id="sourceNWS" name="dataSource" value="nws">
            <label for="sourceNWS">NWS (USA)</label>
          </div>
          <p id="nwsApiNote" style="display: none;">The NWS API is only for locations in the United States.</p>
        </div>
        <div class="settings-section">
          <label>Units</label>
          <div class="unit-toggle-wrapper">
            <span>Imperial (°F) / Metric (°C)</span>
            <label class="switch">
              <input type="checkbox" id="overviewUnitToggle">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
      <div class="settings-tab-content" id="tab-countdown">
        <div class="settings-section">
          <span class="section-label">Active Countdown / Group</span>
          <p style="font-size: 0.9em; color: #666; margin-top: -10px;">Select a single countdown or a group to display on the dashboard and in fullscreen mode.</p>
          <div class="custom-select-wrapper" id="overview-countdown-select-wrapper">
            <div class="custom-select">
              <div class="custom-select-trigger"><span>-- None --</span></div>
              <div class="custom-options"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="../firebase-config.js"></script>
  <script>
    const getStorageKey = (key) => firebase.auth().currentUser ? `4sp_${key}_${firebase.auth().currentUser.uid}` : `4sp_${key}_guest`;
    const WMO_CODES = {
      0: { d: "Clear sky", i: "☀️" }, 1: { d: "Mainly clear", i: "🌤️" }, 2: { d: "Partly cloudy", i: "🌥️" }, 3: { d: "Overcast", i: "☁️" }, 45: { d: "Fog", i: "🌫️" }, 48: { d: "Rime fog", i: "🌫️" }, 51: { d: "Light drizzle", i: "🌦️" }, 53: { d: "Drizzle", i: "🌦️" }, 55: { d: "Dense drizzle", i: "🌧️" }, 56: { d: "Light freezing drizzle", i: "🌨️" }, 57: { d: "Dense freezing drizzle", i: "🌨️" }, 61: { d: "Slight rain", i: "🌧️" }, 63: { d: "Rain", i: "🌧️" }, 65: { d: "Heavy rain", i: "🌧️" }, 66: { d: "Light freezing rain", i: "🌨️" }, 67: { d: "Heavy freezing rain", i: "🌨️" }, 71: { d: "Slight snow", i: "❄️" }, 73: { d: "Snow", i: "❄️" }, 75: { d: "Heavy snow", i: "❄️" }, 77: { d: "Snow grains", i: "❄️" }, 80: { d: "Slight showers", i: "🌦️" }, 81: { d: "Showers", i: "🌦️" }, 82: { d: "Violent showers", i: "⛈️" }, 85: { d: "Slight snow showers", i: "🌨️" }, 86: { d: "Heavy snow showers", i: "🌨️" }, 95: { d: "Thunderstorm", i: "⛈️" }, 96: { d: "Thunderstorm, slight hail", i: "⛈️" }, 99: { d: "Thunderstorm, heavy hail", i: "⛈️" }
    };

    const dashboardGrid = document.getElementById('dashboardGrid');
    const defaultDashboardLayout = ['time_weather_super_widget', 'stopwatch_widget', 'timer_widget', 'quick_actions_widget'];
    const pageSuggestions = [{ name: 'Dashboard', url: 'dashboard.html' }, { name: 'Games', url: 'games.html' }, { name: 'Soundboard', url: 'soundboard.html' }, { name: 'Notes', url: 'notes.html' }, { name: 'Countdowns', url: 'countdowns.html' }, { name: 'Requests', url: 'requests.html' }, { name: 'Apps', url: 'apps.html' }, { name: 'Weather', url: 'weather.html' }, { name: 'Settings', url: 'settings.html' }];
    const defaultQuickActions = [{ icon: "🎓", text: "Classroom", type: "url", value: "https://classroom.google.com/" }, { icon: "📝", text: "Notes", type: "page", value: "notes.html" }, { icon: "🗓️", text: "Countdowns", type: "page", value: "countdowns.html" }, { icon: "🎵", text: "Requests", type: "page", value: "requests.html" }];
    let currentQuickActions = [...defaultQuickActions];
    const defaultWeatherSettings = { dataSource: 'open-meteo', location: { label: 'New York, NY', latitude: 40.71, longitude: -74.01 }, units: 'imperial', showWeatherInFullscreen: false };
    let weatherSettings = { ...defaultWeatherSettings };
    let userCoords = null,
      userCountry = null,
      fullWeatherData = null;
    let titleUpdateInterval = null;

    function saveWeatherSettings() {
      localStorage.setItem(getStorageKey('weatherWidgetSettings'), JSON.stringify(weatherSettings));
    }

    function loadWeatherSettings() {
      const s = localStorage.getItem(getStorageKey('weatherWidgetSettings'));
      if (s) {
        try {
          const loaded = JSON.parse(s);
          weatherSettings = { ...defaultWeatherSettings, ...loaded
          };
          return true;
        } catch (e) {}
      }
      return false;
    }

    async function determineUserCountry() {
      try {
        const r = await fetch('https://ipapi.co/json/');
        if (!r.ok) return;
        const d = await r.json();
        userCountry = d.country_code ? .toUpperCase();
      } catch (e) {}
    }

    function mapNWSKeywordsToWMO(f) {
      if (!f) return 0;
      f = f.toLowerCase();
      if (f.includes("thunderstorm") || f.includes("t-storm")) return 95;
      if (f.includes("snow") || f.includes("flurr")) return 73;
      if (f.includes("rain") || f.includes("shower")) return 63;
      if (f.includes("drizzle")) return 53;
      if (f.includes("fog")) return 45;
      if (f.includes("overcast") || f.includes("cloudy")) return 3;
      if (f.includes("partly cloudy") || f.includes("mostly cloudy")) return 2;
      if (f.includes("mostly clear") || f.includes("partly sunny")) return 1;
      if (f.includes("sunny") || f.includes("clear")) return 0;
      return 0;
    }

    function transformNWSData(daily, hourly) {
      const t = {
        latitude: weatherSettings.location.latitude,
        longitude: weatherSettings.location.longitude,
        utc_offset_seconds: new Date().getTimezoneOffset() * -60,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        current: {},
        hourly: {},
        daily: {}
      };
      const now = hourly.periods[0];
      t.current = {
        time: now.startTime,
        temperature_2m: now.temperature,
        relative_humidity_2m: now.relativeHumidity.value,
        apparent_temperature: now.temperature,
        weather_code: mapNWSKeywordsToWMO(now.shortForecast),
        wind_speed_10m: parseInt(now.windSpeed.split(' ')[0], 10)
      };
      const dailyPeriods = [];
      for (let i = 0; i < daily.periods.length; i++) {
        if (daily.periods[i].isDaytime) {
          const night = (daily.periods[i + 1] && !daily.periods[i + 1].isDaytime) ? daily.periods[i + 1] : daily.periods[i];
          dailyPeriods.push({
            day: daily.periods[i],
            night
          });
        }
      }
      t.daily = {
        time: dailyPeriods.map(p => p.day.startTime.split('T')[0]),
        weather_code: dailyPeriods.map(p => mapNWSKeywordsToWMO(p.day.shortForecast)),
        temperature_2m_max: dailyPeriods.map(p => p.day.temperature),
        temperature_2m_min: dailyPeriods.map(p => p.night.temperature),
        precipitation_sum: dailyPeriods.map(() => null),
        precipitation_probability_max: dailyPeriods.map(p => Math.max(p.day.probabilityOfPrecipitation.value || 0, p.night.probabilityOfPrecipitation.value || 0)),
        wind_speed_10m_max: dailyPeriods.map(p => parseInt(p.day.windSpeed.split(' ')[0], 10)),
        sunrise: dailyPeriods.map(() => null),
        sunset: dailyPeriods.map(() => null),
        daylight_duration: dailyPeriods.map(() => null),
        wind_direction_10m_dominant: dailyPeriods.map(() => null),
        uv_index_max: dailyPeriods.map(() => null),
        relative_humidity_2m_mean: dailyPeriods.map(() => null)
      };
      return t;
    }

    const fetchWeather = async () => {
      const widget = document.querySelector('.dashboard-card[data-template-id="time_weather_super_widget"]');
      const refreshBtn = widget ? .querySelector('.weather-refresh-btn');
      if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.querySelector('img') ? .classList.add('refreshing');
      }
      try {
        if (weatherSettings.dataSource === 'nws') {
          const {
            latitude,
            longitude
          } = weatherSettings.location;
          const r = await fetch(`https://api.weather.gov/points/${latitude},${longitude}`);
          if (!r.ok) throw new Error("Outside NWS (USA) coverage.");
          const d = await r.json();
          const [forecastRes, hourlyRes] = await Promise.all([fetch(d.properties.forecast), fetch(d.properties.forecastHourly)]);
          if (!forecastRes.ok || !hourlyRes.ok) throw new Error("Failed to get NWS forecast details.");
          const [dailyData, hourlyData] = await Promise.all([forecastRes.json(), hourlyRes.json()]);
          fullWeatherData = transformNWSData(dailyData.properties, hourlyData.properties);
        } else {
          const {
            units,
            location
          } = weatherSettings;
          const p = new URLSearchParams({
            current: "temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m",
            daily: "weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,wind_speed_10m_max,sunrise,sunset,daylight_duration,wind_direction_10m_dominant,uv_index_max,relative_humidity_2m_mean",
            timezone: "auto",
            forecast_days: 7,
            temperature_unit: units === 'metric' ? 'celsius' : 'fahrenheit',
            wind_speed_unit: units === 'metric' ? 'kmh' : 'mph'
          });
          const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${location.latitude}&longitude=${location.longitude}&${p}`);
          if (!r.ok) throw new Error(`API Error: ${r.status}`);
          fullWeatherData = await r.json();
        }
        if (window.renderWeatherInDashboard) window.renderWeatherInDashboard(fullWeatherData);
      } catch (error) {
        if (window.renderWeatherErrorInDashboard) window.renderWeatherErrorInDashboard(error.message);
      } finally {
        if (refreshBtn) {
          refreshBtn.disabled = false;
          refreshBtn.querySelector('img') ? .classList.remove('refreshing');
        }
      }
    };

    function formatDaylightDuration(s) {
      if (s == null) return 'N/A';
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      return `${h}h ${m}m`;
    }

    function degreesToCardinal(d) {
      if (d == null) return 'N/A';
      const v = Math.floor((d / 22.5) + 0.5);
      const a = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
      return a[(v % 16)];
    }

    function openForecastModal(dayData) {
      const tempS = weatherSettings.units === 'metric' ? '°C' : '°F';
      const speedS = weatherSettings.units === 'metric' ? 'km/h' : 'mph';
      const utcDate = new Date(dayData.dateStr + 'T12:00:00Z');
      document.getElementById('modalDayDate').textContent = utcDate.toLocaleDateString(undefined, {
        weekday: 'long'
      });
      document.getElementById('modalFullDateSubtitle').textContent = utcDate.toLocaleDateString(undefined, {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      const codeInfo = WMO_CODES[dayData.weatherCode] || {
        d: "Unknown",
        i: "❓"
      };
      document.getElementById('modalWeatherIcon').textContent = codeInfo.i;
      document.getElementById('modalWeatherDesc').textContent = codeInfo.d;
      document.getElementById('modalMaxTemp').textContent = `${Math.round(dayData.tempMax)}${tempS}`;
      document.getElementById('modalMinTemp').textContent = `${Math.round(dayData.tempMin)}${tempS}`;
      document.getElementById('modalPrecipSum').textContent = `${dayData.precipSum != null ? dayData.precipSum : '--'} ${weatherSettings.units === 'metric' ? 'mm' : 'in'}`;
      document.getElementById('modalPrecipProb').textContent = `${dayData.precipProb != null ? dayData.precipProb : '--'}%`;
      document.getElementById('modalWindSpeed').textContent = `${dayData.windSpeedMax != null ? Math.round(dayData.windSpeedMax) : '--'} ${speedS}`;
      document.getElementById('modalWindDirection').textContent = degreesToCardinal(dayData.windDirection);
      document.getElementById('modalDaylightDuration').textContent = formatDaylightDuration(dayData.daylightDuration);
      document.getElementById('modalSunriseTime').textContent = dayData.sunrise ? new Date(dayData.sunrise).toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit'
      }) : 'N/A';
      document.getElementById('modalSunsetTime').textContent = dayData.sunset ? new Date(dayData.sunset).toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit'
      }) : 'N/A';
      document.getElementById('modalFeelsLike').textContent = `${dayData.feelsLike != null ? Math.round(dayData.feelsLike) : '--'}${tempS}`;
      document.getElementById('modalHumidity').textContent = `${dayData.humidity != null ? dayData.humidity : '--'}%`;
      document.getElementById('modalDailyAdvice').innerHTML = "Checking advice..."; // Placeholder
      document.getElementById('forecastDetailModal').classList.add('modal-open');
    }

    const clockFsOverlay = document.getElementById('clock-fullscreen-overlay'),
      clockFsTime = document.getElementById('clock-fs-main-time'),
      clockFsDate = document.getElementById('clock-fs-main-date'),
      clockFsCountdownName = document.getElementById('clock-fs-countdown-name'),
      clockFsCountdownTimer = document.getElementById('clock-fs-countdown-timer');
    let clockFsInterval, clockFsCountdownTimeout, inactivityTimer, activeCountdownGroup = null,
      countdownGroupInterval = null;

    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      const controls = document.querySelectorAll('.clock-fs-controls, .clock-fs-right-controls');
      const weatherDisplay = document.getElementById('fullscreen-weather-display');
      clockFsOverlay.classList.remove('inactive-cursor');
      controls.forEach(c => c.classList.remove('controls-hidden'));
      if (weatherDisplay.style.display !== 'none') {
        weatherDisplay.style.right = '80px';
      }
      inactivityTimer = setTimeout(() => {
        clockFsOverlay.classList.add('inactive-cursor');
        controls.forEach(c => c.classList.add('controls-hidden'));
        if (weatherDisplay.style.display !== 'none') {
          weatherDisplay.style.right = '20px';
        }
      }, 2500);
    }

    function openClockFullscreen() {
      const savedColor = localStorage.getItem(getStorageKey('clockFsColor'));
      if (savedColor) clockFsOverlay.style.background = savedColor;
      clockFsOverlay.classList.add('active');
      updateFullscreenClock();
      clockFsInterval = setInterval(updateFullscreenClock, 1000);
      clockFsOverlay.requestFullscreen().catch(err => {
        console.error("Fullscreen request failed:", err);
        closeClockFullscreen()
      });
      populateAndInitFullscreenCountdownDropdown();
      updateFullscreenWeatherDisplay();
      clockFsOverlay.addEventListener('mousemove', resetInactivityTimer);
      resetInactivityTimer();
    }

    function closeClockFullscreen() {
      clockFsOverlay.classList.remove('active');
      clearInterval(clockFsInterval);
      clearTimeout(clockFsCountdownTimeout);
      clearTimeout(inactivityTimer);
      clearInterval(countdownGroupInterval);
      clockFsOverlay.removeEventListener('mousemove', resetInactivityTimer);
      clockFsOverlay.classList.remove('inactive-cursor');
      document.querySelectorAll('.clock-fs-controls, .clock-fs-right-controls').forEach(c => c.classList.remove('controls-hidden'));
      if (window.updateDashboardCountdownDisplay) window.updateDashboardCountdownDisplay();
      stopTitleUpdate();
    }
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) closeClockFullscreen()
    });

    function updateFullscreenClock() {
      const n = new Date();
      clockFsTime.textContent = n.toLocaleTimeString();
      clockFsDate.textContent = n.toLocaleDateString(undefined, {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      })
    }

    function updateFullscreenWeatherDisplay() {
      const container = document.getElementById('fullscreen-weather-display');
      if (weatherSettings.showWeatherInFullscreen && fullWeatherData) {
        const {
          current
        } = fullWeatherData;
        const codeInfo = WMO_CODES[current.weather_code] || {
          d: '',
          i: '❓'
        };
        const tempSuffix = weatherSettings.units === 'metric' ? '°C' : '°F';
        container.innerHTML = `<div class="icon">${codeInfo.i}</div><div><div class="temp">${Math.round(current.temperature_2m)}${tempSuffix}</div><div class="condition">${codeInfo.d}</div></div>`;
        container.style.display = 'flex';
      } else {
        container.style.display = 'none';
      }
    }

    function formatCountdown(targetDate) {
      const end = new Date(targetDate);
      const now = new Date();
      if (end <= now) {
        return "🎉 Finished!";
      }
      const diff = end - now;
      const w = Math.floor(diff / 604800000);
      const d = Math.floor((diff % 604800000) / 86400000);
      const h = Math.floor((diff % 86400000) / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      const units = [{
        v: w,
        l: 'wks'
      }, {
        v: d,
        l: 'days'
      }, {
        v: h,
        l: 'hrs'
      }, {
        v: m,
        l: 'mins'
      }, {
        v: s,
        l: 'secs'
      }];
      const visibleUnits = units.filter((unit, idx) => units.slice(0, idx).reduce((acc, p) => acc + p.v, 0) + unit.v > 0);
      return visibleUnits.map(unit => `<span class="time-unit">${unit.v}<span class="time-label">${unit.l}</span></span>`).join('') || `<span class="time-unit">0<span class="time-label">secs</span></span>`;
    }

    function setFullscreenCountdown(id) {
      clearTimeout(clockFsCountdownTimeout);
      clearInterval(countdownGroupInterval);
      localStorage.setItem(getStorageKey('selectedDashboardCountdownId'), id);
      if (!id) {
        clockFsCountdownName.textContent = '';
        clockFsCountdownTimer.innerHTML = '';
        return;
      }
      if (id.startsWith('group_')) {
        activeCountdownGroup = id;
        startCountdownGroup(id);
      } else {
        activeCountdownGroup = null;
        const countdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
        const countdown = countdowns.find(cd => cd.id === id);
        if (countdown) {
          clockFsCountdownName.textContent = countdown.name;
          const tick = () => {
            const formattedTime = formatCountdown(countdown.targetTimestamp);
            clockFsCountdownTimer.innerHTML = formattedTime;
            if (formattedTime.includes("Finished")) {
              clearTimeout(clockFsCountdownTimeout);
              return;
            }
            const msUntilNextSecond = 1000 - new Date().getMilliseconds();
            clockFsCountdownTimeout = setTimeout(tick, msUntilNextSecond);
          };
          tick();
        }
      }
    }

    function populateAndInitFullscreenCountdownDropdown() {
      const wrapper = document.getElementById('fullscreen-countdown-select-wrapper');
      const customOptions = wrapper.querySelector('.custom-options');
      const customSelectTrigger = wrapper.querySelector('.custom-select-trigger span');
      const countdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
      const countdownGroups = JSON.parse(localStorage.getItem(getStorageKey('countdownGroups')) || '{}');
      customOptions.innerHTML = '<span class="custom-option" data-value="">No Countdown</span>';
      countdowns.filter(cd => new Date(cd.targetTimestamp) > new Date()).sort((a, b) => new Date(a.targetTimestamp) - new Date(b.targetTimestamp)).forEach(cd => {
        const option = document.createElement('span');
        option.className = 'custom-option';
        option.dataset.value = cd.id;
        option.textContent = cd.name;
        customOptions.appendChild(option);
      });
      Object.keys(countdownGroups).forEach(groupId => {
        const group = countdownGroups[groupId];
        const option = document.createElement('span');
        option.className = 'custom-option';
        option.dataset.value = groupId;
        option.textContent = `GROUP: ${group.name}`;
        customOptions.appendChild(option);
      });
      const savedId = localStorage.getItem(getStorageKey('selectedDashboardCountdownId'));
      const selectedOption = customOptions.querySelector(`.custom-option[data-value="${savedId}"]`) || customOptions.querySelector('.custom-option[data-value=""]');
      selectedOption.classList.add('selected');
      customSelectTrigger.textContent = selectedOption.textContent;
      setFullscreenCountdown(savedId);
      initializeCustomSelect(wrapper, (value) => {
        setFullscreenCountdown(value);
      });
    }

    function startCountdownGroup(groupId) {
      clearInterval(countdownGroupInterval);
      const updateGroup = () => {
        const countdownGroups = JSON.parse(localStorage.getItem(getStorageKey('countdownGroups')) || '{}');
        const group = countdownGroups[groupId];
        if (!group || group.countdownIds.length === 0) {
          clockFsCountdownName.textContent = "Empty Group";
          clockFsCountdownTimer.innerHTML = "";
          return;
        }

        const allCountdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
        const now = new Date();

        let groupCountdowns = group.countdownIds
          .map(id => allCountdowns.find(cd => cd.id === id))
          .filter(Boolean)
          .map(cd => ({ ...cd,
            nextOccurrence: new Date(calculateNextOccurrence(cd))
          }))
          .filter(cd => cd.nextOccurrence > now);

        if (group.order === 'ending_soonest') {
          groupCountdowns.sort((a, b) => a.nextOccurrence - b.nextOccurrence);
        }

        if (groupCountdowns.length > 0) {
          const currentCountdown = groupCountdowns[0];
          clockFsCountdownName.textContent = `${group.name}: ${currentCountdown.name}`;
          clockFsCountdownTimer.innerHTML = formatCountdown(currentCountdown.nextOccurrence);
        } else {
          clockFsCountdownName.textContent = `${group.name}: All Finished`;
          clockFsCountdownTimer.innerHTML = "";
          clearInterval(countdownGroupInterval);
        }
      };
      updateGroup();
      countdownGroupInterval = setInterval(updateGroup, 1000);
    }

    function calculateNextOccurrence(countdown) {
      if (!countdown.repeat) return new Date(countdown.targetTimestamp);
      let lastTarget = new Date(countdown.targetTimestamp);
      let now = new Date();
      if (lastTarget > now) return lastTarget;
      let nextTarget = new Date(lastTarget);
      if (countdown.repeat.type === 'daily') {
        const diffDays = Math.ceil((now - nextTarget) / 86400000);
        nextTarget.setDate(nextTarget.getDate() + diffDays);
        if (nextTarget <= now) nextTarget.setDate(nextTarget.getDate() + 1);
      } else if (countdown.repeat.type === 'weekly' && countdown.repeat.days.length > 0) {
        const sortedDays = countdown.repeat.days.map(d => parseInt(d)).sort((a, b) => a - b);
        while (nextTarget <= now) {
          let currentDay = nextTarget.getDay();
          let nextDay = sortedDays.find(d => d > currentDay);
          if (nextDay !== undefined) {
            nextTarget.setDate(nextTarget.getDate() + (nextDay - currentDay));
          } else {
            nextTarget.setDate(nextTarget.getDate() + (7 - currentDay + sortedDays[0]));
          }
        }
      }
      return nextTarget;
    }

    const availableCardTemplates = [{
      templateId: 'time_weather_super_widget',
      title: 'Overview',
      icon: '🌐',
      type: 'full',
      onMount: async (cardElement) => {
        const timeEl = cardElement.querySelector('#clockTime');
        const dateEl = cardElement.querySelector('#clockDate');
        const fullscreenBtn = cardElement.querySelector('.clock-fullscreen-btn');

        function updateClock() {
          const now = new Date();
          timeEl.textContent = now.toLocaleTimeString();
          dateEl.textContent = now.toLocaleDateString(undefined, {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
        }
        updateClock();
        setInterval(updateClock, 1000);
        if (fullscreenBtn) fullscreenBtn.addEventListener('click', openClockFullscreen);
        const countdownNameEl = cardElement.querySelector('.dashboard-countdown-display-name'),
          countdownTimerEl = cardElement.querySelector('.dashboard-countdown-display-timer'),
          countdownSectionEl = cardElement.querySelector('.dashboard-countdown-section');
        window.dashboardCountdownTimeout = null;
        window.dashboardGroupInterval = null;

        function renderCountdownInDashboard(id) {
          clearTimeout(window.dashboardCountdownTimeout);
          clearInterval(window.dashboardGroupInterval);
          if (!id) {
            countdownSectionEl.style.display = 'none';
            return;
          }
          countdownSectionEl.style.display = 'block';
          if (id.startsWith('group_')) {
            window.dashboardGroupInterval = setInterval(() => updateGroupDisplay(id), 1000);
            updateGroupDisplay(id);
          } else {
            const countdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
            const countdown = countdowns.find(cd => cd.id === id);
            if (!countdown || new Date(countdown.targetTimestamp) <= new Date()) {
              countdownSectionEl.style.display = 'none';
              return;
            }
            countdownNameEl.textContent = countdown.name;
            const tick = () => {
              const formattedTime = formatCountdown(countdown.targetTimestamp);
              countdownTimerEl.innerHTML = formattedTime;
              if (formattedTime.includes("Finished")) {
                clearTimeout(window.dashboardCountdownTimeout);
                return;
              }
              window.dashboardCountdownTimeout = setTimeout(tick, 1000 - new Date().getMilliseconds());
            };
            tick();
          }
        }

        function updateGroupDisplay(groupId) {
          const groups = JSON.parse(localStorage.getItem(getStorageKey('countdownGroups')) || '{}');
          const group = groups[groupId];
          if (!group) {
            countdownSectionEl.style.display = 'none';
            return;
          }
          const allCountdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
          const now = new Date();
          let groupCds = group.countdownIds.map(id => allCountdowns.find(cd => cd.id === id)).filter(Boolean).map(cd => ({ ...cd,
            next: new Date(calculateNextOccurrence(cd))
          })).filter(cd => cd.next > now);
          if (group.order === 'ending_soonest') groupCds.sort((a, b) => a.next - b.next);
          if (groupCds.length > 0) {
            const current = groupCds[0];
            countdownNameEl.textContent = `${group.name}: ${current.name}`;
            countdownTimerEl.innerHTML = formatCountdown(current.next);
          } else {
            countdownNameEl.textContent = `${group.name}: All Finished`;
            countdownTimerEl.innerHTML = "";
          }
        }
        window.updateDashboardCountdownDisplay = () => {
          renderCountdownInDashboard(localStorage.getItem(getStorageKey('selectedDashboardCountdownId')));
        };
        window.updateDashboardCountdownDisplay();
        const refreshBtn = cardElement.querySelector('.weather-refresh-btn'),
          settingsBtn = cardElement.querySelector('.overview-settings-btn');
        window.renderWeatherErrorInDashboard = (message) => {
          const els = {
            c: cardElement.querySelector('.condition-large'),
            i: cardElement.querySelector('.weather-icon-large'),
            t: cardElement.querySelector('.temp-large'),
            f: cardElement.querySelector('.forecast-large')
          };
          if (els.c) els.c.textContent = message;
          if (els.i) els.i.textContent = '⚠️';
          if (els.t) els.t.textContent = '--°';
          if (els.f) els.f.innerHTML = `<p style="color:red;font-size:0.9em;">${message}</p>`;
        };
        window.renderWeatherInDashboard = (data) => {
          const {
            units,
            location
          } = weatherSettings;
          const tempS = units === 'metric' ? '°C' : '°F';
          const cw = data.current;
          const codeInfo = WMO_CODES[cw.weather_code] || {
            d: "Unknown",
            i: "❓"
          };
          cardElement.querySelector('.temp-large').textContent = `${Math.round(cw.temperature_2m)}${tempS}`;
          cardElement.querySelector('.weather-icon-large').textContent = codeInfo.i;
          cardElement.querySelector('.condition-large').textContent = codeInfo.d;
          cardElement.querySelector('.feels-like-value').textContent = `${Math.round(cw.apparent_temperature)}${tempS}`;
          cardElement.querySelector('.humidity-value').textContent = `${cw.relative_humidity_2m}%`;
          cardElement.querySelector('.wind-value').textContent = `${Math.round(cw.wind_speed_10m)} ${units === 'metric' ? 'km/h' : 'mph'}`;
          cardElement.querySelector('.location-large').textContent = location.label;
          const forecastEl = cardElement.querySelector('.forecast-large');
          forecastEl.innerHTML = '';
          if (data.daily ? .time ? .length > 0) {
            data.daily.time.forEach((dateStr, i) => {
              const dayCodeInfo = WMO_CODES[data.daily.weather_code[i]] || {
                i: "❓"
              };
              const dayDiv = document.createElement('div');
              dayDiv.className = 'forecast-day';
              dayDiv.addEventListener('click', () => {
                openForecastModal({
                  dateStr,
                  weatherCode: data.daily.weather_code[i],
                  tempMax: data.daily.temperature_2m_max[i],
                  tempMin: data.daily.temperature_2m_min[i],
                  precipSum: data.daily.precipitation_sum ? .[i],
                  precipProb: data.daily.precipitation_probability_max ? .[i],
                  windSpeedMax: data.daily.wind_speed_10m_max ? .[i],
                  sunrise: data.daily.sunrise ? .[i],
                  sunset: data.daily.sunset ? .[i],
                  daylightDuration: data.daily.daylight_duration ? .[i],
                  windDirection: data.daily.wind_direction_10m_dominant ? .[i],
                  uvIndexMax: data.daily.uv_index_max ? .[i],
                  feelsLike: cw.apparent_temperature,
                  humidity: cw.relative_humidity_2m
                });
              });
              const dayName = i === 0 ? "Today" : new Date(dateStr + 'T12:00:00Z').toLocaleDateString(undefined, {
                weekday: 'short',
                timeZone: 'UTC'
              });
              dayDiv.innerHTML = `<span class="day-name">${dayName}</span><span class="icon">${dayCodeInfo.i}</span><span class="temps">${Math.round(data.daily.temperature_2m_max[i])}°/${Math.round(data.daily.temperature_2m_min[i])}°</span>`;
              forecastEl.appendChild(dayDiv);
            });
          }
          updateFullscreenWeatherDisplay();
        };
        async function initializeWeather() {
          await determineUserCountry();
          const settingsLoaded = loadWeatherSettings();
          if (!settingsLoaded && navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
              userCoords = {
                lat: pos.coords.latitude,
                lon: pos.coords.longitude
              };
              const {
                label,
                country_code
              } = await fetchCityName(userCoords.lat, userCoords.lon);
              weatherSettings.location = {
                label,
                latitude: userCoords.lat,
                longitude: userCoords.lon
              };
              weatherSettings.units = (country_code === 'us' || !country_code) ? 'imperial' : 'metric';
              saveWeatherSettings();
              await fetchWeather();
            }, async () => {
              await fetchWeather();
            });
          } else {
            await fetchWeather();
          }
        }
        if (settingsBtn) settingsBtn.addEventListener('click', () => {
          const modal = document.getElementById('overviewSettingsModal');
          modal.classList.add('modal-open');
          populateAndInitOverviewCountdownDropdown();
          populateAndInitTitleBarDropdown();
          document.getElementById('overviewLocationInput').value = weatherSettings.location.label;
          document.getElementById('overviewUnitToggle').checked = weatherSettings.units === 'metric';
          document.querySelector(`input[name="dataSource"][value="${weatherSettings.dataSource}"]`).checked = true;
          document.getElementById('fullscreenWeatherToggle').checked = weatherSettings.showWeatherInFullscreen;
          window.updateNWSAvailability();
        });
        if (refreshBtn) refreshBtn.addEventListener('click', fetchWeather);
        initializeWeather();
        setInterval(fetchWeather, 30 * 60 * 1000);
      }
    }, {
      templateId: 'stopwatch_widget',
      title: 'Stopwatch',
      icon: '⏱️',
      type: 'small',
      onMount: (cardElement) => {
        const display = cardElement.querySelector('.stopwatch-display');
        let state = {
          startTime: null,
          elapsedTime: 0,
          isRunning: false
        };
        let intervalId = null;
        const formatTime = (ms) => {
          const s = Math.floor(ms / 1000);
          const c = Math.floor((ms % 1000) / 10).toString().padStart(2, '0');
          return `${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}.${c}`;
        };
        const updateDisplay = () => display.textContent = formatTime(state.elapsedTime + (state.isRunning ? Date.now() - state.startTime : 0));
        const start = () => {
          if (state.isRunning) return;
          state.isRunning = true;
          state.startTime = Date.now();
          cardElement.querySelector('[data-action="start"]').style.display = 'none';
          cardElement.querySelector('[data-action="pause"]').style.display = 'inline-block';
          intervalId = setInterval(updateDisplay, 50);
        };
        const pause = () => {
          if (!state.isRunning) return;
          clearInterval(intervalId);
          state.elapsedTime += Date.now() - state.startTime;
          state.isRunning = false;
          cardElement.querySelector('[data-action="start"]').style.display = 'inline-block';
          cardElement.querySelector('[data-action="pause"]').style.display = 'none';
        };
        const reset = () => {
          clearInterval(intervalId);
          state = {
            startTime: null,
            elapsedTime: 0,
            isRunning: false
          };
          updateDisplay();
          cardElement.querySelector('[data-action="start"]').style.display = 'inline-block';
          cardElement.querySelector('[data-action="pause"]').style.display = 'none';
        };
        cardElement.querySelector('[data-action="start"]').addEventListener('click', start);
        cardElement.querySelector('[data-action="pause"]').addEventListener('click', pause);
        cardElement.querySelector('[data-action="reset"]').addEventListener('click', reset);
        updateDisplay();
      }
    }, {
      templateId: 'timer_widget',
      title: 'Timer',
      icon: '⌛',
      type: 'small',
      onMount: (cardElement) => {
        const display = cardElement.querySelector('.timer-display-value');
        const inputs = {
          w: cardElement.querySelector('#timer-w'),
          d: cardElement.querySelector('#timer-d'),
          h: cardElement.querySelector('#timer-h'),
          m: cardElement.querySelector('#timer-m'),
          s: cardElement.querySelector('#timer-s')
        };
        let state = {
          targetTime: null,
          remaining: 0,
          isRunning: false
        };
        let interval = null;
        const formatTime = (ms) => {
          if (ms < 0) ms = 0;
          let s = Math.floor(ms / 1000);
          let m = Math.floor(s / 60);
          s %= 60;
          let h = Math.floor(m / 60);
          m %= 60;
          let d = Math.floor(h / 24);
          h %= 24;
          let w = Math.floor(d / 7);
          d %= 7;
          return [w, d, h, m, s].map(u => String(u).padStart(2, '0')).join(':');
        };
        const update = () => {
          if (state.isRunning) state.remaining = state.targetTime - Date.now();
          display.textContent = formatTime(state.remaining);
          if (state.remaining <= 0 && state.isRunning) {
            clearInterval(interval);
            reset();
          }
        };
        const start = () => {
          if (state.isRunning || state.remaining <= 0) return;
          state.isRunning = true;
          state.targetTime = Date.now() + state.remaining;
          interval = setInterval(update, 100);
          cardElement.querySelector('.timer-inputs').classList.add('hidden');
          cardElement.querySelector('[data-action="start"]').style.display = 'none';
          cardElement.querySelector('[data-action="pause"]').style.display = 'inline-block';
        };
        const pause = () => {
          if (!state.isRunning) return;
          clearInterval(interval);
          state.isRunning = false;
          cardElement.querySelector('[data-action="start"]').style.display = 'inline-block';
          cardElement.querySelector('[data-action="pause"]').style.display = 'none';
        };
        const reset = () => {
          clearInterval(interval);
          state = {
            targetTime: null,
            remaining: 0,
            isRunning: false
          };
          cardElement.querySelector('.timer-inputs').classList.remove('hidden');
          Object.values(inputs).forEach(i => i.value = 0);
          update();
          cardElement.querySelector('[data-action="start"]').style.display = 'inline-block';
          cardElement.querySelector('[data-action="pause"]').style.display = 'none';
        };
        Object.values(inputs).forEach(i => i.addEventListener('change', () => {
          if (!state.isRunning) {
            state.remaining = (parseInt(inputs.w.value || 0) * 604800 + parseInt(inputs.d.value || 0) * 86400 + parseInt(inputs.h.value || 0) * 3600 + parseInt(inputs.m.value || 0) * 60 + parseInt(inputs.s.value || 0)) * 1000;
            update();
          }
        }));
        cardElement.querySelector('[data-action="start"]').addEventListener('click', start);
        cardElement.querySelector('[data-action="pause"]').addEventListener('click', pause);
        cardElement.querySelector('[data-action="reset"]').addEventListener('click', reset);
        update();
      }
    }, {
      templateId: 'quick_actions_widget',
      title: 'Shortcuts',
      icon: '⚡',
      type: 'small',
      onMount: (cardElement) => {
        const settingsBtn = cardElement.querySelector('.quick-actions-settings-btn');
        const contentContainer = cardElement.querySelector('.quick-actions-list');
        const renderAndAttachListeners = (actions) => {
          contentContainer.innerHTML = actions.map(action => `<button data-type="${action.type}" data-value="${action.value}"><span class="icon">${action.icon}</span><span class="text">${action.text}</span><span class="arrow">→</span></button>`).join('');
          contentContainer.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
              const {
                type,
                value
              } = btn.dataset;
              if (type === 'url') {
                window.open(value, '_blank');
              } else if (type === 'page') {
                const page = pageSuggestions.find(p => p.url === value);
                if (page && page.action) {
                  page.action();
                } else {
                  window.location.href = value;
                }
              }
            });
          });
        };
        const updateUI = () => {
          const saved = localStorage.getItem(getStorageKey('quickActions_v1'));
          currentQuickActions = saved ? JSON.parse(saved) : [...defaultQuickActions];
          renderAndAttachListeners(currentQuickActions);
        };
        window.updateQuickActionsWidget = updateUI;
        updateUI();
        if (settingsBtn) {
          settingsBtn.addEventListener('click', () => {
            document.getElementById('shortcutSettingsModal').classList.add('modal-open');
          });
        }
      }
    }, ];

    function getContentGenerator(templateId) {
      switch (templateId) {
        case 'time_weather_super_widget':
          return () => `<div class="super-widget-container"><div class="super-widget-clock-section"><div class="clock-display" id="clockTime">00:00:00</div><div class="date-display" id="clockDate"></div><div class="dashboard-countdown-section" style="display: none;"><h4 class="dashboard-countdown-display-name"></h4><div class="dashboard-countdown-display-timer"></div></div></div><div class="super-widget-weather-section"><div class="weather-large-content"><div class="current-weather-layout"><span class="weather-icon-large"></span><div class="current-weather-main-info"><span class="temp-large">--°</span><span class="condition-large">Loading...</span></div><div class="current-weather-details-aside"><p>Feels like: <span class="feels-like-value">--°</span></p><p>Humidity: <span class="humidity-value">--%</span></p><p>Wind: <span class="wind-value">--</span></p><p>Location: <span class="location-large"></span></p></div></div><div class="forecast-large"></div></div></div></div>`;
        case 'stopwatch_widget':
          return () => `<div class="card-content-inner"><div class="stopwatch-display">00:00:00.00</div><div class="controls-flex"><button data-action="start">Start</button><button data-action="pause" style="display:none;">Pause</button><button data-action="reset">Reset</button></div></div>`;
        case 'timer_widget':
          return () => `<div class="card-content-inner"><div class="timer-display-value">00:00:00</div><div class="timer-inputs"><input type="number" id="timer-w" placeholder="W" value="0">:<input type="number" id="timer-d" placeholder="D" value="0">:<input type="number" id="timer-h" placeholder="H" value="0">:<input type="number" id="timer-m" placeholder="M" value="0">:<input type="number" id="timer-s" placeholder="S" value="0"></div><div class="controls-flex"><button data-action="start">Start</button><button data-action="pause" style="display:none;">Pause</button><button data-action="reset">Reset</button></div></div>`;
        case 'quick_actions_widget':
          return () => `<div class="quick-actions-list"></div>`;
        default:
          return () => '';
      }
    }

    function createCardDOMElement(t) {
      const c = document.createElement('div');
      c.className = 'dashboard-card';
      c.dataset.templateId = t.templateId;
      c.dataset.cardType = t.type || 'full';
      c.innerHTML = `<div class="card-header"><div class="card-icon">${t.icon}</div><h4 class="card-title">${t.title}</h4><div class="card-header-buttons"></div></div><div class="card-content-inner">${getContentGenerator(t.templateId)()}</div>`;
      const b = c.querySelector('.card-header-buttons');
      if (t.templateId === 'time_weather_super_widget') {
        b.innerHTML = `<button class="weather-action-btn overview-settings-btn" title="Overview Settings"><img src="../images/gear-dark.png"></button><button class="weather-action-btn weather-refresh-btn" title="Refresh Weather"><img src="../images/refresh-dark.png"></button><button class="weather-action-btn clock-fullscreen-btn" title="Fullscreen Clock"><img src="../images/zoom-in-dark.png"></button>`
      } else if (t.templateId === 'quick_actions_widget') {
        b.innerHTML = `<button class="weather-action-btn quick-actions-settings-btn" title="Edit Shortcuts"><img src="../images/gear-dark.png"></button>`
      }
      if (t.onMount) {
        setTimeout(() => {
          try {
            t.onMount(c)
          } catch (e) {
            c.querySelector('.card-content-inner').innerHTML = `<p style="color:red;">Failed to load widget.</p>`
          }
        }, 0)
      }
      return c
    }

    function renderDashboardLayout() {
      const l = JSON.parse(localStorage.getItem('4sp_dashboardLayout_v2_super')) || defaultDashboardLayout;
      dashboardGrid.innerHTML = '';
      l.forEach(id => {
        const t = availableCardTemplates.find(t => t.templateId === id);
        if (t) dashboardGrid.appendChild(createCardDOMElement(t))
      });
      dashboardGrid.querySelectorAll('.dashboard-card').forEach((c, i) => {
        c.style.animation = 'none';
        c.offsetHeight;
        c.style.animation = `fadeIn 0.4s ease-out ${i*0.05}s forwards`
      })
    }

    function initializeCustomSelect(wrapper, onChangeCallback) {
      if (wrapper.dataset.customSelectInitialized) return;
      const select = wrapper.querySelector('.custom-select');
      const trigger = select.querySelector('.custom-select-trigger');
      const optionsContainer = select.querySelector('.custom-options');
      const handleTriggerClick = (e) => {
        e.stopPropagation();
        select.classList.toggle('open');
      };
      const handleOptionClick = (e) => {
        if (e.target.classList.contains('custom-option')) {
          const option = e.target;
          const value = option.dataset.value;
          const text = option.textContent;
          if (optionsContainer.querySelector('.selected')) {
            optionsContainer.querySelector('.selected').classList.remove('selected');
          }
          option.classList.add('selected');
          trigger.querySelector('span').textContent = text;
          select.classList.remove('open');
          if (onChangeCallback) {
            onChangeCallback(value);
          }
        }
      };
      trigger.addEventListener('click', handleTriggerClick);
      optionsContainer.addEventListener('click', handleOptionClick);
      wrapper.dataset.customSelectInitialized = true;
    }
    document.addEventListener('click', () => {
      document.querySelectorAll('.custom-select.open').forEach(select => select.classList.remove('open'));
    });

    function populateAndInitOverviewCountdownDropdown() {
      const wrapper = document.getElementById('overview-countdown-select-wrapper');
      const optionsContainer = wrapper.querySelector('.custom-options');
      const triggerSpan = wrapper.querySelector('.custom-select-trigger span');
      optionsContainer.innerHTML = '<span class="custom-option" data-value="">-- None --</span>';
      const countdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
      const countdownGroups = JSON.parse(localStorage.getItem(getStorageKey('countdownGroups')) || '{}');
      countdowns.filter(cd => new Date(cd.targetTimestamp) > new Date()).forEach(cd => {
        const opt = document.createElement('span');
        opt.className = 'custom-option';
        opt.dataset.value = cd.id;
        opt.textContent = cd.name;
        optionsContainer.appendChild(opt);
      });
      Object.keys(countdownGroups).forEach(groupId => {
        const group = countdownGroups[groupId];
        const opt = document.createElement('span');
        opt.className = 'custom-option';
        opt.dataset.value = groupId;
        opt.textContent = `GROUP: ${group.name}`;
        optionsContainer.appendChild(opt);
      });
      const savedId = localStorage.getItem(getStorageKey('selectedDashboardCountdownId')) || '';
      const selectedOption = optionsContainer.querySelector(`.custom-option[data-value="${savedId}"]`) || optionsContainer.querySelector('.custom-option[data-value=""]');
      if (selectedOption) {
        selectedOption.classList.add('selected');
        triggerSpan.textContent = selectedOption.textContent;
      }
      initializeCustomSelect(wrapper, (value) => {
        localStorage.setItem(getStorageKey('selectedDashboardCountdownId'), value);
        if (window.updateDashboardCountdownDisplay) window.updateDashboardCountdownDisplay();
      });
    }

    function populateAndInitTitleBarDropdown() {
      const wrapper = document.getElementById('overview-title-select-wrapper');
      const optionsContainer = wrapper.querySelector('.custom-options');
      const triggerSpan = wrapper.querySelector('.custom-select-trigger span');
      const savedType = localStorage.getItem(getStorageKey('urlTitleType')) || 'none';
      const selectedOption = optionsContainer.querySelector(`.custom-option[data-value="${savedType}"]`) || optionsContainer.querySelector('.custom-option[data-value="none"]');
      if (optionsContainer.querySelector('.selected')) {
        optionsContainer.querySelector('.selected').classList.remove('selected');
      }
      selectedOption.classList.add('selected');
      triggerSpan.textContent = selectedOption.textContent;
      initializeCustomSelect(wrapper, (value) => {
        startTitleUpdater(value);
      });
    }

    function startTitleUpdater(type) {
      stopTitleUpdater();
      localStorage.setItem(getStorageKey('urlTitleType'), type);
      if (type === 'none') return;
      titleUpdateInterval = setInterval(() => {
        let titleText = "4SP - DASHBOARD";
        if (type === 'time') {
          titleText = new Date().toLocaleTimeString();
        } else if (type === 'countdown') {
          titleText = getCurrentCountdownTitle();
        }
        document.title = titleText;
      }, 1000);
    }

    function stopTitleUpdater() {
      clearInterval(titleUpdateInterval);
      document.title = "4SP - DASHBOARD";
    }

    function getCurrentCountdownTitle() {
      const savedId = localStorage.getItem(getStorageKey('selectedDashboardCountdownId'));
      if (!savedId) return "4SP - DASHBOARD";
      const allCountdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
      let targetTimestamp;
      if (savedId.startsWith('group_')) {
        const groups = JSON.parse(localStorage.getItem(getStorageKey('countdownGroups')) || '{}');
        const group = groups[savedId];
        if (!group || group.countdownIds.length === 0) return "Empty Group";
        let groupCds = group.countdownIds.map(id => allCountdowns.find(cd => cd.id === id)).filter(Boolean).map(cd => ({ ...cd,
          next: new Date(calculateNextOccurrence(cd))
        })).filter(cd => cd.next > new Date());
        if (group.order === 'ending_soonest') groupCds.sort((a, b) => a.next - b.next);
        if (groupCds.length > 0) {
          targetTimestamp = groupCds[0].next;
        } else {
          return "Group Finished";
        }
      } else {
        const countdown = allCountdowns.find(c => c.id === savedId);
        if (!countdown) return "4SP - DASHBOARD";
        targetTimestamp = new Date(countdown.targetTimestamp);
      }
      const diff = targetTimestamp - new Date();
      if (diff <= 0) return "Finished!";
      const d = Math.floor(diff / (1000 * 60 * 60 * 24));
      const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const m = Math.floor((diff / 1000 / 60) % 60);
      const s = Math.floor((diff / 1000) % 60);
      if (d > 0) return `${d}d ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
      firebase.auth().onAuthStateChanged(user => {
        if (!user) location.href = '../login.html';
        else {
          renderDashboardLayout();
          const savedTitleType = localStorage.getItem(getStorageKey('urlTitleType')) || 'none';
          startTitleUpdater(savedTitleType);
        }
      });
      document.getElementById('logoutBtn').addEventListener('click', () => firebase.auth().signOut());
      document.getElementById('signOutLink').addEventListener('click', (e) => {
        e.preventDefault();
        firebase.auth().signOut();
      });
      document.getElementById('toggleSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));

      const allModals = document.querySelectorAll('.modal');
      allModals.forEach(modal => {
        const closeBtn = modal.querySelector('.modal-close-btn');
        const isSettingsModal = modal.id === 'overviewSettingsModal';
        const closeModal = () => {
          modal.classList.remove('modal-open');
          if (isSettingsModal) fetchWeather();
        };
        if (closeBtn) closeBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeModal();
        });
      });

      const wLocInput = document.getElementById('overviewLocationInput'),
        wLocSuggest = document.getElementById('overviewLocationSuggestions'),
        unitToggle = document.getElementById('overviewUnitToggle'),
        useCurrentBtn = document.getElementById('overviewUseCurrentLocationBtn');
      let debounceTimer;
      wLocInput.addEventListener('keyup', (e) => {
        clearTimeout(debounceTimer);
        const q = e.target.value;
        if (q.length < 3) {
          wLocSuggest.style.display = 'none';
          return;
        }
        debounceTimer = setTimeout(() => fetchLocationSuggestions(q), 500);
      });

      useCurrentBtn.addEventListener('click', async () => {
        if (!navigator.geolocation) return;
        useCurrentBtn.disabled = true;
        useCurrentBtn.textContent = 'Locating...';
        navigator.geolocation.getCurrentPosition(async (position) => {
          const {
            latitude,
            longitude
          } = position.coords;
          userCoords = {
            lat: latitude,
            lon: longitude
          };
          const {
            label
          } = await fetchCityName(latitude, longitude);
          weatherSettings.location = {
            label,
            latitude,
            longitude
          };
          wLocInput.value = label;
          saveWeatherSettings();
          useCurrentBtn.disabled = false;
          useCurrentBtn.textContent = '📍 Use My Current Location';
          document.getElementById('overviewSettingsModal').classList.remove('modal-open');
          fetchWeather();
        }, (error) => {
          useCurrentBtn.disabled = false;
          useCurrentBtn.textContent = '📍 Use My Current Location';
        }, {
          timeout: 10000
        });
      });

      async function fetchLocationSuggestions(query) {
        let url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`;
        if (userCoords) {
          url += `&viewbox=${userCoords.lon-1},${userCoords.lat+1},${userCoords.lon+1},${userCoords.lat-1}&bounded=1`;
        }
        try {
          const r = await fetch(url);
          const d = await r.json();
          wLocSuggest.innerHTML = '';
          if (d.length > 0) {
            wLocSuggest.style.display = 'block';
            d.forEach(p => {
              const shortLabel = getShortLocationLabel(p.address, p.display_name);
              const li = document.createElement('li');
              li.textContent = shortLabel;
              li.addEventListener('click', () => {
                weatherSettings.location = {
                  label: shortLabel,
                  latitude: parseFloat(p.lat),
                  longitude: parseFloat(p.lon)
                };
                wLocInput.value = shortLabel;
                wLocSuggest.style.display = 'none';
                saveWeatherSettings();
                document.getElementById('overviewSettingsModal').classList.remove('modal-open');
                fetchWeather();
              });
              wLocSuggest.appendChild(li);
            });
          } else {
            wLocSuggest.style.display = 'none';
          }
        } catch (e) {
          console.error("Failed to fetch location suggestions:", e);
        }
      }

      unitToggle.addEventListener('change', () => {
        weatherSettings.units = unitToggle.checked ? 'metric' : 'imperial';
        saveWeatherSettings();
      });
      document.querySelectorAll('input[name="dataSource"]').forEach(r => {
        r.addEventListener('change', (e) => {
          weatherSettings.dataSource = e.target.value;
          saveWeatherSettings();
          window.updateNWSAvailability();
        })
      });
      window.updateNWSAvailability = function(isUS = userCountry === 'US') {
        const nR = document.getElementById('sourceNWS');
        const nN = document.getElementById('nwsApiNote');
        if (isUS) {
          nR.disabled = false;
          nN.style.display = 'none';
        } else {
          if (weatherSettings.dataSource === 'nws') {
            weatherSettings.dataSource = 'open-meteo';
            saveWeatherSettings();
            document.getElementById('sourceOpenMeteo').checked = true;
          }
          nR.disabled = true;
          nN.style.display = 'block';
        }
      };
      const fsWeatherToggle = document.getElementById('fullscreenWeatherToggle');
      fsWeatherToggle.addEventListener('change', () => {
        weatherSettings.showWeatherInFullscreen = fsWeatherToggle.checked;
        saveWeatherSettings();
        updateFullscreenWeatherDisplay();
      });
      document.querySelectorAll('.settings-tab-btn').forEach(btn => btn.addEventListener('click', () => {
        document.querySelector('.settings-tab-btn.active').classList.remove('active');
        document.querySelector('.settings-tab-content.active').classList.remove('active');
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      }));

      const colorToggle = document.getElementById('clock-fs-color-toggle');
      const colorPalette = document.getElementById('clock-fs-color-palette');
      const colorPickerInput = document.getElementById('color-picker-input');
      colorToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        colorPalette.classList.toggle('visible');
      });
      document.addEventListener('click', (e) => {
        if (!colorPalette.contains(e.target) && !colorToggle.contains(e.target)) colorPalette.classList.remove('visible');
      });
      colorPalette.addEventListener('click', (e) => {
        if (e.target.classList.contains('color-swatch') && !e.target.classList.contains('color-swatch-custom')) {
          const color = e.target.dataset.color;
          document.getElementById('clock-fullscreen-overlay').style.background = color;
          localStorage.setItem(getStorageKey('clockFsColor'), color);
        }
      });
      document.querySelector('.color-swatch-custom').addEventListener('click', () => colorPickerInput.click());
      colorPickerInput.addEventListener('input', (e) => {
        const color = e.target.value;
        document.getElementById('clock-fullscreen-overlay').style.background = color;
        localStorage.setItem(getStorageKey('clockFsColor'), color);
      });
    });
  </script>
</body>
</html>
