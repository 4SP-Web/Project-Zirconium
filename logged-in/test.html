<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - VERN SOCIAL</title>
  <!-- Link to your external CSS file is preserved -->
  <link rel="stylesheet" href="../css/style.css" />
  <!-- Using a more modern CDN for Font Awesome for better icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Link to your external panic key script is preserved -->
  <script src="../panic-key.js"></script>
  <!-- TailwindCSS for modern utility-first styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* A modern, dark theme using TailwindCSS color palette for better consistency and feel */
    body, html {
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: 'Inter', sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    body {
        background-color: #111827; /* gray-900 */
        color: #d1d5db; /* gray-300 */
        display: flex;
        flex-direction: column;
    }
    .main-header {
        background-color: #1f2937; /* gray-800 */
        border-bottom: 1px solid #374151; /* gray-700 */
        flex-shrink: 0;
    }
    .dashboard-container {
      display: flex;
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    .social-container {
        flex: 1;
        display: flex;
        overflow: hidden;
        width: 100%;
    }
    .chat-sidebar {
        width: 320px;
        flex-shrink: 0;
        background-color: #1f2937; /* gray-800 */
        border-right: 1px solid #374151; /* gray-700 */
        display: flex;
        flex-direction: column;
        transition: transform 0.4s ease-in-out;
    }
    .chat-sidebar-header {
        padding: 1rem;
        border-bottom: 1px solid #374151; /* gray-700 */
    }
    #userSearchInput {
        width: 100%;
        padding: 0.5rem 1rem 0.5rem 2.5rem;
        border-radius: 9999px;
        border: 1px solid #4b5563; /* gray-600 */
        background-color: #374151; /* gray-700 */
        color: #d1d5db; /* gray-300 */
        box-sizing: border-box;
    }
    #userSearchInput::placeholder { color: #9ca3af; } /* gray-400 */
    .search-bar-wrapper { position: relative; }
    .search-bar-wrapper .fa-search {
        position: absolute; left: 1rem; top: 50%;
        transform: translateY(-50%); color: #9ca3af; /* gray-400 */
    }
    .chat-list-section {
        flex-grow: 1;
        overflow-y: auto;
    }
    .chat-list-section h3 {
        font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
        color: #9ca3af; /* gray-400 */
        padding: 1.25rem 1rem 0.5rem; margin: 0;
    }
    .chat-list { list-style: none; padding: 0; margin: 0; }
    .chat-list-item {
        display: flex; align-items: center; padding: 0.75rem 1rem;
        cursor: pointer; transition: background-color 0.2s;
        border-bottom: 1px solid #374151; /* gray-700 */
    }
    .chat-list-item:hover { background-color: #374151; } /* gray-700 */
    .chat-list-item.active { background-color: #4f46e5; } /* indigo-600 */
    .chat-list-item .username { font-weight: 500; color: #f9fafb; } /* gray-50 */
    .chat-list-item .actions { margin-left: auto; display: flex; gap: 0.5rem; }
    .action-btn { background: none; border: none; cursor: pointer; font-size: 1.1em; color: #9ca3af; }
    .action-btn.accept { color: #22c55e; } /* green-500 */
    .action-btn.decline { color: #ef4444; } /* red-500 */
    .create-group-btn {
        display: block; width: calc(100% - 2rem); margin: 1rem; padding: 0.75rem;
        background-color: #4f46e5; color: white; border: none; border-radius: 0.375rem; cursor: pointer;
        text-align: center; font-weight: 600;
    }
    .create-group-btn:disabled { background-color: #4b5563; cursor: not-allowed; }
    .chat-area {
        flex-grow: 1; display: flex; flex-direction: column;
        background-color: #111827; /* gray-900 */
        transition: transform 0.4s ease-in-out;
    }
    .chat-header {
        padding: 1rem 1.25rem; background-color: #1f2937; /* gray-800 */
        border-bottom: 1px solid #374151; /* gray-700 */ flex-shrink: 0; display: flex;
        justify-content: space-between; align-items: center;
    }
    .back-to-chats-btn {
        display: none; background: none; border: none; font-size: 1.5rem;
        margin-right: 1rem; cursor: pointer; color: #9ca3af;
    }
    #chatName { font-size: 1.25em; font-weight: bold; color: white; }
    #unfriendBtn, #leaveGroupBtn, #inviteToGroupBtn { border: none; border-radius: 0.375rem; padding: 0.5rem 0.75rem; cursor: pointer; font-weight: bold; }
    #unfriendBtn { background-color: #ef4444; color: white; }
    #leaveGroupBtn { background-color: #eab308; color: #1f2937; } /* yellow-500 */
    #inviteToGroupBtn { background-color: #22c55e; color: white; }
    .messages-container {
        flex-grow: 1; padding: 1.25rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem;
    }
    .message-placeholder { margin: auto; text-align: center; color: #6b7280; }
    .message-placeholder .icon { font-size: 3em; margin-bottom: 1rem; }
    .message { display: flex; flex-direction: column; max-width: 70%; align-self: flex-start; }
    .message.current-user { align-self: flex-end; }
    .message-content {
        padding: 0.75rem 1rem; border-radius: 1.25rem; background-color: #374151; /* gray-700 */
        color: #f9fafb; line-height: 1.5; word-wrap: break-word; text-align: left;
    }
    .message.current-user .message-content {
        background-color: #4f46e5; color: white; border-bottom-right-radius: 0.375rem;
    }
    .message .message-content { border-bottom-left-radius: 0.375rem; }
    .message-info { font-size: 0.75em; color: #9ca3af; margin-top: 0.25rem; padding: 0 0.5rem; }
    .chat-input-area {
        padding: 1rem; border-top: 1px solid #374151; flex-shrink: 0; display: flex; gap: 0.5rem;
        background-color: #1f2937;
    }
    #messageInput {
        flex-grow: 1; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #4b5563;
        background-color: #374151; color: #d1d5db;
    }
    #sendMessageBtn {
        padding: 0.75rem 1rem; background-color: #4f46e5; color: white; border: none;
        border-radius: 0.5rem; cursor: pointer;
    }
    /* Modal styles for a cleaner, consistent look */
    .modal {
        display: none; position: fixed; z-index: 1050; left: 0; top: 0;
        width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
        align-items: center; justify-content: center;
    }
    .modal-content {
        background-color: #1f2937; padding: 1.5rem; border: 1px solid #374151;
        width: 90%; max-width: 450px; border-radius: 0.75rem; position: relative;
        box-shadow: 0 5px 25px rgba(0,0,0,0.3);
    }
    .modal-content h2 { margin-top: 0; color: #f9fafb; }
    .modal-confirm-btn, .modal-cancel-btn, .modal-ok-btn {
        width: 100%; padding: 0.75rem; border: none; border-radius: 0.5rem; cursor: pointer;
        font-weight: 600;
    }
    .modal-confirm-btn { background-color: #4f46e5; color: white; }
    .modal-cancel-btn { background-color: #4b5563; color: #d1d5db; }
    .modal-ok-btn { background-color: #4f46e5; color: white; }

    /* Responsive Styles for Mobile */
    @media screen and (max-width: 768px) {
        .social-container {
            width: 200%; 
        }
        .chat-sidebar, .chat-area {
            width: 50%; 
        }
        .social-container.mobile-chat-view-active {
            transform: translateX(-50%);
        }
        .back-to-chats-btn {
            display: block; 
        }
    }
  </style>
</head>

<body class="dashboard-page">

  <header class="main-header">
      <!-- Your existing header can go here -->
  </header>

  <div class="dashboard-container">
    <main class="social-container" id="socialContainer">
      <aside class="chat-sidebar">
        <div class="chat-sidebar-header">
            <div class="search-bar-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="userSearchInput" placeholder="Find users...">
            </div>
        </div>
        <div class="chat-list-section">
            <div id="searchResultsSection"></div>
            <div id="friendRequestsSection"></div>
            <div id="friendsSection"><h3>Friends</h3><ul id="friendsList" class="chat-list"></ul></div>
            <div id="groupsSection"><h3>Groups</h3><ul id="groupsList" class="chat-list"></ul></div>
        </div>
        <button id="createGroupBtn" class="create-group-btn">Create Group</button>
      </aside>

      <section class="chat-area" id="chatArea">
        <div id="chatWelcomeScreen" class="message-placeholder">
            <div class="icon"><i class="fas fa-comments"></i></div>
            <h2>Welcome to VERN SOCIAL</h2>
            <p>Select a friend or group to start chatting.</p>
        </div>

        <div id="chatActiveScreen" style="display: none;">
            <!-- Chat Active Screen content as in your original file -->
        </div>
      </section>
    </main>
  </div>
  
  <!-- MODALS for creating groups, invites, confirmations, and alerts -->
  <div id="createGroupModal" class="modal"> <!-- ... modal content ... --> </div>
  <div id="inviteToGroupModal" class="modal"> <!-- ... modal content ... --> </div>
  <div id="confirmationModal" class="modal"> <!-- ... modal content ... --> </div>
  
  <!-- A generic modal for showing info/error alerts -->
  <div id="alertModal" class="modal">
    <div class="modal-content">
      <h2 id="alertModalTitle"></h2>
      <p id="alertModalMessage"></p>
      <div class="mt-4">
        <button id="alertModalOkBtn" class="modal-ok-btn">OK</button>
      </div>
    </div>
  </div>


  <!-- Firebase SDKs - It's recommended to use the latest version -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  
  <!-- Link to your firebase config file is preserved -->
  <script src="../firebase-config.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- App State & Constants ---
        let currentUser = null;
        let currentUserData = {};
        let activeChatId = null;
        let activeChatType = null;
        let messageInputDebounceTimeout;
        const GROUP_CREATION_LIMIT = 2;
        const GROUP_CREATION_WINDOW_MINS = 10;
        const MAX_GROUP_MEMBERSHIPS = 12;
        const MAX_GROUP_SIZE = 10;
        const DEBOUNCE_DELAY_MS = 400; // Time to wait after user stops typing

        // --- DOM Elements ---
        const alertModal = document.getElementById('alertModal');
        const alertModalTitle = document.getElementById('alertModalTitle');
        const alertModalMessage = document.getElementById('alertModalMessage');
        const alertModalOkBtn = document.getElementById('alertModalOkBtn');
        const createGroupBtn = document.getElementById('createGroupBtn');
        // ... (other DOM element selections from your file)

        // --- Custom Alert Function ---
        function showAlert(title, message) {
            alertModalTitle.textContent = title;
            alertModalMessage.textContent = message;
            alertModal.style.display = 'flex';
        }
        alertModalOkBtn.addEventListener('click', () => alertModal.style.display = 'none');

        // --- EFFICIENT MESSAGING: Debounced Send Function ---
        function debouncedSendMessage(text) {
            if (!activeChatId) return;
            const collectionName = activeChatType === 'group' ? 'groupChats' : 'chats';
            const chatRef = db.collection(collectionName).doc(activeChatId);
            
            // The payload for the message.
            const messagePayload = {
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Use an update call with dot notation to only modify the current user's message.
            // This is the core of the ephemeral messaging system.
            chatRef.update({
                [`messages.${currentUser.uid}`]: messagePayload
            }).catch(error => {
                console.error("Message send error:", error);
                showAlert("Error", "Failed to send message. Please try again.");
            });
        }
        
        // --- Event Listener for message input ---
        messageInput.addEventListener('input', () => {
            clearTimeout(messageInputDebounceTimeout);
            const text = messageInput.value.trim();
            if (text === '') return;
            
            messageInputDebounceTimeout = setTimeout(() => {
                debouncedSendMessage(text);
            }, DEBOUNCE_DELAY_MS);
        });
        
        // --- Group Creation Logic with NEW LIMITS ---
        createGroupBtn.addEventListener('click', async () => {
            // 1. Check total group membership limit
            if (currentUserData.groups && currentUserData.groups.length >= MAX_GROUP_MEMBERSHIPS) {
                return showAlert("Limit Reached", `You can only be a member of a maximum of ${MAX_GROUP_MEMBERSHIPS} groups.`);
            }

            // 2. Check group creation rate limit
            const userRef = db.collection('users').doc(currentUser.uid);
            const now = Date.now();
            const windowStart = now - (GROUP_CREATION_WINDOW_MINS * 60 * 1000);
            
            const recentCreations = (currentUserData.groupsCreatedTimestamps || []).filter(ts => ts > windowStart);
            if (recentCreations.length >= GROUP_CREATION_LIMIT) {
                return showAlert("Rate Limit Exceeded", `You can only create ${GROUP_CREATION_LIMIT} groups every ${GROUP_CREATION_WINDOW_MINS} minutes. Please try again later.`);
            }
            
            // If all checks pass, show the modal to create the group
            // (Your existing logic to show the 'createGroupModal' would go here)
        });
        
        // --- Updated Group Confirmation Logic ---
        async function handleConfirmGroupCreation() {
            const groupName = groupNameInput.value.trim();
            if (groupName === '') return showAlert('Invalid Name', 'Please enter a valid group name.');

            const selectedFriends = Array.from(friendsToAddToGroupDiv.querySelectorAll('input:checked'));
            const memberIds = [currentUser.uid, ...selectedFriends.map(input => input.value)];

            // 3. Enforce the maximum group size
            if (memberIds.length > MAX_GROUP_SIZE) {
                return showAlert("Group Too Large", `A group can have a maximum of ${MAX_GROUP_SIZE} members.`);
            }
            
            try {
                // Create the group and add a timestamp for rate-limiting
                await db.collection('groupChats').add({
                    groupName,
                    creatorId: currentUser.uid,
                    members: memberIds,
                    messages: {}
                });
                
                await db.collection('users').doc(currentUser.uid).update({
                    groupsCreatedTimestamps: firebase.firestore.FieldValue.arrayUnion(Date.now())
                });

                createGroupModal.style.display = 'none';
                groupNameInput.value = '';
            } catch (error) {
                console.error("Error creating group:", error);
                showAlert("Error", "Failed to create the group. Please try again.");
            }
        }
        
        // --- Updated Invite Logic ---
        async function handleConfirmInvite() {
            const selectedToInvite = Array.from(friendsToInviteListDiv.querySelectorAll('input:checked')).map(input => input.value);
            if (selectedToInvite.length === 0) return;
            
            const newTotalMembers = activeChatData.members.length + selectedToInvite.length;
            
            // 4. Check group size limit on invites
            if (newTotalMembers > MAX_GROUP_SIZE) {
                return showAlert("Group Full", `Inviting these members would exceed the ${MAX_GROUP_SIZE} member limit.`);
            }

            const groupRef = db.collection('groupChats').doc(activeChatId);
            try {
                // Your existing logic to update group members
                await groupRef.update({ members: firebase.firestore.FieldValue.arrayUnion(...selectedToInvite) });
                inviteToGroupModal.style.display = 'none';
            } catch (error) {
                console.error("Error inviting to group:", error);
                showAlert("Error", "Failed to send invites.");
            }
        }

        // --- Auth State Change and Initial Setup ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                // Listen to the current user's document for real-time updates on friends, groups, etc.
                db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        currentUserData = { id: doc.id, ...doc.data() };
                        // Now render UI elements based on this fresh data
                        // e.g., renderFriendsAndGroups();
                    }
                });
            } else {
                // Redirect to login if not authenticated
                window.location.href = '../login.html';
            }
        });

        // Your other functions (renderFriends, openChat, search, etc.) would be here.
        // Make sure to call handleConfirmGroupCreation and handleConfirmInvite from your modal confirm buttons.
    });
  </script>
</body>
</html>
