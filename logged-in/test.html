<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - VERN SOCIAL</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --font-primary: 'PrimaryFont', sans-serif;
            --color-accent: #6720bd;
            --color-accent-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --color-danger: #dc3545;
            --color-success: #28a745;
            --color-warning: #ffc107;
            --color-info: #0dcaf0;
            --color-online: #28a745;
            --color-offline: #6c757d;
            --color-gaming: #fd7e14;
            --color-working: #0d6efd;
            --color-sleeping: #343a40;
        }

        /* --- Base Layout & Resets --- */
        html, body {
            height: 100%; margin: 0; font-family: var(--font-primary);
            background-color: #f0f2f5; overflow: hidden;
        }
        * { box-sizing: border-box; }
        body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; }
        .dashboard-container { display: flex; flex: 1; min-height: 0; }
        .main-header { flex-shrink: 0; }
        .hidden { display: none !important; }

        /* --- Sidebar --- */
        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff;
            display: flex; flex-direction: column;
            border-right: 1px solid #444;
            transition: width 0.3s ease-in-out;
            position: relative;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
            padding: 10px;
        }
        
        .social-sidebar-content { flex-grow: 1; overflow-y: auto; overflow-x: hidden; }
        .sidebar-section { padding: 15px 5px; border-bottom: 1px solid #444; }
        .sidebar-section:last-of-type { border-bottom: none; }
        .sidebar-section h2 {
            font-size: 0.9em; text-transform: uppercase; color: #aaa;
            margin: 0 0 15px 5px; font-weight: 600;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* --- Chat Area --- */
        .chat-area {
            flex-grow: 1; display: flex; flex-direction: column;
            min-height: 0; position: relative;
        }
        .chat-wrapper { 
            flex-grow: 1; display: flex; flex-direction: column; 
            min-height: 0; position: relative; /* Required for floating footer */
        }
        .messages-container {
            background-color: #d1d7db;
            background-size: cover; background-position: center;
            flex-grow: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 2px;
            /* Add padding to the bottom to avoid being covered by the floating footer */
            padding-bottom: 120px;
        }

        /* --- Floating Frosted Glass Chat Footer --- */
        .chat-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px 20px 10px;
            /* Frosted glass effect */
            background: rgba(200, 220, 255, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 100;
            transition: all 0.3s ease;
        }
        #messageForm { display: flex; flex-direction: column; gap: 5px; }
        #messageFormInner { display: flex; align-items: center; gap: 10px; }
        #messageInput {
            flex-grow: 1;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 22px;
            padding: 10px 18px;
            font-size: 1em;
            resize: none;
            color: #000;
            outline-color: var(--color-accent);
        }
        #messageInput::placeholder {
            color: #333;
            opacity: 0.8;
        }
        #sendMessageBtn {
            background: var(--color-accent-gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.2em;
            cursor: pointer;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #charCounter { 
            font-size: 0.8em; 
            color: #111;
            text-shadow: 0 1px 1px rgba(255,255,255,0.5);
            text-align: right; 
            padding-right: 55px;
        }

        /* General Button Styling */
        .btn {
            padding: 8px 18px;
            border: 1px solid transparent;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease-in-out;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: var(--color-accent);
            color: white;
            border-color: var(--color-accent);
        }
        .btn-primary:hover {
            background: #5a1cae;
            border-color: #5a1cae;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
            border-color: #5a6268;
        }
        .btn-danger {
            background: var(--color-danger);
            color: white;
            border-color: var(--color-danger);
        }
        .btn-danger:hover {
            background: #c82333;
            border-color: #c82333;
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal {
            background: #fff; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            width: 90%; max-width: 500px;
            transform: scale(0.95); transition: transform 0.3s;
        }
        .modal-overlay.visible .modal { transform: scale(1); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; }
        .modal-header h3 { margin: 0; font-size: 1.3em; }
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .modal-body .btn { margin-right: 10px; margin-bottom: 10px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; display:flex; gap: 10px; justify-content: flex-end;}
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }

        .nickname-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .nickname-item:last-child { border-bottom: none; }
        
        #user-invite-search-results .item-list li { cursor: default; }

        /* Other inherited styles from original file are assumed to be here... */
        .user-profile-area { padding: 10px 5px; text-align: center; border-bottom: 1px solid #444; flex-shrink: 0; display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; border: 2px solid #fff; flex-shrink: 0; }
        .status-indicator.online { background-color: var(--color-online); } .status-indicator.offline { background-color: var(--color-offline); } .status-indicator.gaming { background-color: var(--color-gaming); } .status-indicator.working { background-color: var(--color-working); } .status-indicator.sleeping { background-color: var(--color-sleeping); }
        .user-details { text-align: left; overflow: hidden; } .user-details .username { font-size: 1.1em; font-weight: 600; margin: 0; white-space: nowrap; } .user-details .email { font-size: 0.8em; color: #bbb; margin: 2px 0 0; white-space: nowrap; }
        .item-list { list-style: none; padding: 0; margin: 0; }
        .item-list li { display: flex; align-items: center; justify-content: space-between; padding: 10px 8px; border-radius: 8px; transition: background-color 0.2s; cursor: pointer; }
        .item-list li:hover:not(.empty-state) { background-color: #242526; }
        .item-list .item-info { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-list .item-info small { display: block; font-size: 0.85em; color: #999; } .item-info .item-name { font-weight: 500; } .item-list .active-chat { background-color: rgba(103, 32, 189, 0.4) !important; }
        .item-list .empty-state { color: #888; font-style: italic; padding: 10px 5px; cursor: default; }
        .item-actions { display: flex; gap: 5px; flex-shrink: 0; margin-left: 10px; }
        .item-actions button { background: none; border: none; color: #ccc; cursor: pointer; font-size: 1em; padding: 5px; border-radius: 50%; }
        .item-actions button:hover { color: #fff; } .item-actions .accept-btn:hover { color: var(--color-success); } .item-actions .decline-btn:hover { color: var(--color-danger); }
        .sidebar-settings-menu { padding: 15px 0; border-top: 1px solid #444; flex-shrink: 0; }
        .sidebar-settings-menu ul { list-style: none; padding: 0; margin: 0; } .sidebar-settings-menu li a { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 6px; text-decoration: none; color: #ccc; font-weight: 500; transition: background-color 0.2s, color 0.2s; } .sidebar-settings-menu li a:hover { background-color: #242526; color: #fff; } .sidebar-settings-menu li a i { width: 18px; text-align: center; }
        .chat-placeholder { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: #999; padding: 20px; background-color: #f0f2f5; }
        .chat-placeholder i { font-size: 5em; margin-bottom: 20px; color: #d0d5db; }
        .chat-header { padding: 10px 15px; border-bottom: 1px solid #ddd; font-size: 1.2em; font-weight: 600; color: #1C1E21; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background: #f0f2f5; }
        .chat-header .chat-info { text-align: center; flex-grow: 1; } .chat-header .chat-actions button { background: none; border: none; font-size: 1.2em; color: #666; cursor: pointer; padding: 8px; border-radius: 50%; } .chat-header .chat-actions button:hover { background-color: #e0e0e0; }
        .message-wrapper { display: flex; flex-direction: column; max-width: 65%; position: relative; margin-bottom: 5px; } .message-wrapper.sent { align-self: flex-end; align-items: flex-end; } .message-wrapper.received { align-self: flex-start; align-items: flex-start; }
        .message-content { padding: 8px 12px; border-radius: 12px; line-height: 1.5; word-break: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
        .message-wrapper.sent .message-content { background: var(--color-accent-gradient); color: white; border-top-right-radius: 4px; } .message-wrapper.received .message-content { background: #fff; color: #333; border-top-left-radius: 4px; }
        .message-meta { display: flex; align-items: center; gap: 8px; font-size: 0.75em; padding-top: 4px; }
        .message-wrapper.sent .message-meta { color: #f0f0f0; text-shadow: 0 1px 1px rgba(0,0,0,0.2); justify-content: flex-end; } .message-wrapper.received .message-meta { color: #666; }
        .message-actions { position: absolute; top: -15px; background: #fff; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; gap: 5px; padding: 4px; opacity: 0; transition: opacity 0.2s, transform 0.2s; pointer-events: none; transform: translateY(5px); z-index: 10; }
        .message-wrapper:hover .message-actions { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .message-wrapper.sent .message-actions { right: 10px; } .message-wrapper.received .message-actions { left: 10px; }
        .message-actions button { background: none; border: none; font-size: 1em; color: #555; cursor: pointer; padding: 6px; border-radius: 50%; } .message-actions button:hover { background-color: #eee; }
    </style>
</head>
<body class="dashboard-page">

    <header class="main-header">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-primary" onclick="window.location.href='../logged-in/dashboard.html'">Dashboard</button>
                <button id="logoutBtn" class="btn btn-secondary">Log Out</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container" id="dashboardContainer">
        <aside class="sidebar" id="sidebar">
            <div class="user-profile-area">
                <div id="currentUserStatus" class="status-indicator offline"></div>
                <div class="user-details">
                    <p class="username" id="userName">Loading...</p>
                    <p class="email" id="userEmail">...</p>
                </div>
            </div>
            <div class="social-sidebar-content">
                <div class="sidebar-section">
                    <h2><i class="fas fa-user-plus"></i> Friend Requests</h2>
                    <ul id="friendRequestsList" class="item-list"></ul>
                </div>
                <div class="sidebar-section">
                    <h2><i class="fas fa-envelope-open-text"></i> Group Invites</h2>
                    <ul id="groupInvitesList" class="item-list"></ul>
                </div>
                <div class="sidebar-section">
                    <h2>Groups <button id="createGroupBtn" class="action-btn" title="Create Group"><i class="fas fa-plus"></i></button></h2>
                    <ul id="groupChatsList" class="item-list"></ul>
                </div>
                <div class="sidebar-section">
                    <h2><i class="fas fa-users"></i> Friends</h2>
                    <ul id="friendsList" class="item-list"></ul>
                </div>
            </div>
            <div class="sidebar-settings-menu">
                <ul>
                    <li><a href="#" id="manageSettingsBtn"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="chat-area">
            <div class="chat-placeholder" id="chatPlaceholder">
                <i class="fas fa-comments"></i>
                <h2>Welcome to Vern Social</h2>
                <p>Select a friend or group to start chatting.</p>
            </div>
            <div class="chat-wrapper hidden" id="chatWrapper">
                <div class="chat-header">
                    <div class="chat-info" id="chatHeaderInfo"></div>
                    <div class="chat-actions">
                         <button id="chatSettingsBtn" title="Chat Settings"><i class="fas fa-cog"></i></button>
                    </div>
                </div>
                <div class="messages-container" id="messagesContainer"></div>
                <footer class="chat-footer">
                    <form id="messageForm">
                        <div id="messageFormInner">
                            <textarea id="messageInput" placeholder="Type a message..." rows="1" maxlength="2000" disabled></textarea>
                            <button type="submit" id="sendMessageBtn" disabled><i class="fas fa-paper-plane"></i></button>
                        </div>
                        <div id="charCounter">0/2000</div>
                    </form>
                </footer>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="createGroupModal">
        <div class="modal">
            <div class="modal-header"><h3>Create New Group</h3></div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="groupNameInput">Group Name</label>
                    <input type="text" id="groupNameInput" placeholder="My Awesome Group">
                </div>
                <div class="form-group">
                    <label>Select Members (You are included automatically)</label>
                    <div id="groupMemberSelection" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 6px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close>Cancel</button>
                <button class="btn btn-primary" id="confirmCreateGroupBtn">Create</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="chatSettingsModal">
        <div class="modal">
            <div class="modal-header"><h3 id="chatSettingsModalTitle">Chat Settings</h3></div>
            <div class="modal-body" id="chatSettingsModalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close>Close</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="inviteUserToGroupModal">
        <div class="modal">
            <div class="modal-header"><h3>Invite User to Group</h3></div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="userInviteSearchInput">Search by exact username</label>
                    <input type="text" id="userInviteSearchInput" placeholder="Username...">
                </div>
                <div id="user-invite-search-results">
                    <ul class="item-list">
                        <li class="empty-state">Search for a user to invite.</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-close>Cancel</button>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
    // --- DOM ELEMENT REFERENCES ---
    const chatSettingsModal = document.getElementById('chatSettingsModal');
    const chatSettingsModalTitle = document.getElementById('chatSettingsModalTitle');
    const chatSettingsModalBody = document.getElementById('chatSettingsModalBody');
    const inviteUserToGroupModal = document.getElementById('inviteUserToGroupModal');
    const userInviteSearchInput = document.getElementById('userInviteSearchInput');
    const userInviteSearchResultsEl = document.querySelector('#user-invite-search-results .item-list');
    // ... other DOM refs
    const logoutBtn = document.getElementById('logoutBtn');
    const friendsListEl = document.getElementById('friendsList');
    const groupChatsListEl = document.getElementById('groupChatsList');
    const friendRequestsListEl = document.getElementById('friendRequestsList');
    const groupInvitesListEl = document.getElementById('groupInvitesList');
    const chatWrapper = document.getElementById('chatWrapper');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const chatHeaderInfoEl = document.getElementById('chatHeaderInfo');
    const chatSettingsBtn = document.getElementById('chatSettingsBtn');
    const userNameEl = document.getElementById('userName');
    const userEmailEl = document.getElementById('userEmail');
    const currentUserStatusEl = document.getElementById('currentUserStatus');
    const createGroupBtn = document.getElementById('createGroupBtn');
    const createGroupModal = document.getElementById('createGroupModal');
    const confirmCreateGroupBtn = document.getElementById('confirmCreateGroupBtn');
    const groupMemberSelection = document.getElementById('groupMemberSelection');
    const groupNameInput = document.getElementById('groupNameInput');
    const chatPlaceholder = document.getElementById('chatPlaceholder');
    const messagesContainer = document.getElementById('messagesContainer');
    
    // --- GLOBAL STATE ---
    let currentUser, currentUserProfile;
    let userCache = {};
    let unsubscribes = [];
    let activeChat = { id: null, type: null, name: '', partnerId: null, members: [], createdBy: null };

    // --- UTILITY & CORE FUNCTIONS ---
    function showNotification(message, type = 'info', duration = 3000) {
        // Implementation from previous version
    }
    function openModal(modalEl) { modalEl.classList.add('visible'); }
    function closeModal(modalEl) { modalEl.classList.remove('visible'); }

    // --- AUTH & INITIALIZATION ---
    firebase.auth().onAuthStateChanged(async user => {
        if (user) {
            currentUser = user;
            await setupUserProfile();
            setupListeners();
        } else {
            window.location.href = '../login.html';
        }
    });

    async function setupUserProfile() {
        const userDocRef = firebase.firestore().collection('users').doc(currentUser.uid);
        const userDoc = await userDocRef.get();
        if (!userDoc.exists) {
            await userDocRef.set({
                username: `user_${currentUser.uid.substring(0, 6)}`,
                email: currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                friends: [],
                status: { current: 'online' }
            }, { merge: true });
        }
    }

    function setupListeners() {
        cleanupListeners();
        const db = firebase.firestore();
        unsubscribes.push(db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
            currentUserProfile = { id: doc.id, ...doc.data() };
            userCache[currentUser.uid] = { ...currentUserProfile };
            userNameEl.textContent = currentUserProfile.username;
            userEmailEl.textContent = currentUserProfile.email;
            friendsListEl.innerHTML = ''; // Re-render friends
            currentUserProfile.friends.forEach(renderFriendListItem);
        }));
        unsubscribes.push(db.collection('friend_requests').where('receiverId', '==', currentUser.uid).onSnapshot(snapshot => renderList(friendRequestsListEl, snapshot.docs, renderFriendRequestItem, 'No new friend requests.')));
        unsubscribes.push(db.collection('group_invitations').where('receiverId', '==', currentUser.uid).onSnapshot(snapshot => renderList(groupInvitesListEl, snapshot.docs, renderGroupInviteItem, 'No new group invites.')));
        unsubscribes.push(db.collection('groups').where('members', 'array-contains', currentUser.uid).onSnapshot(snapshot => {
            renderList(groupChatsListEl, snapshot.docs, renderGroupChatItem, 'No groups yet.');
            if(activeChat.type === 'group' && !snapshot.docs.some(d => d.id === activeChat.id)) closeActiveChat();
        }));
    }
    function cleanupListeners() {
        unsubscribes.forEach(unsub => unsub());
        unsubscribes = [];
    }
    
    async function renderList(element, docs, renderFunction, emptyMessage) {
        element.innerHTML = '';
        if (docs.length === 0) {
            element.innerHTML = `<li class="empty-state">${emptyMessage}</li>`;
            return;
        }
        const uidsToFetch = docs.flatMap(doc => [doc.data().senderId, doc.data().inviterId]).filter(Boolean);
        await fetchUsers(uidsToFetch);
        docs.forEach(doc => element.appendChild(renderFunction(doc.id, doc.data())));
    }
    
    // --- UI RENDERING ---
    async function fetchUsers(uids) { /* ... implementation from previous version ... */ }
    function renderFriendListItem(friendId) { /* ... */ }
    function renderFriendRequestItem(id, data) { /* ... */ }
    function renderGroupChatItem(id, data) { /* ... */ }
    
    function renderGroupInviteItem(id, data) {
        const li = document.createElement('li');
        li.innerHTML = `
            <div class="item-info">
                <span class="item-name">Invite to <strong>${data.groupName || 'a group'}</strong></span>
                <small>from ${data.inviterName || 'a user'}</small>
            </div>
            <div class="item-actions">
                <button title="Accept" class="accept-btn" onclick="acceptGroupInvite('${id}', '${data.groupId}')"><i class="fas fa-check"></i></button>
                <button title="Decline" class="decline-btn" onclick="declineGroupInvite('${id}')"><i class="fas fa-times"></i></button>
            </div>`;
        return li;
    }

    // --- CHAT LOGIC ---
    function openChat(chatConfig) {
        activeChat = chatConfig;
        chatWrapper.classList.remove('hidden');
        chatPlaceholder.classList.add('hidden');
        messageInput.disabled = false;
        sendMessageBtn.disabled = false;
        chatHeaderInfoEl.textContent = activeChat.name;
        // ... rest of open chat logic
    }
    function closeActiveChat() { /* ... */ }
    
    // --- NEW & UPDATED GLOBAL FUNCTIONS ---
    window.acceptGroupInvite = async (inviteId, groupId) => {
        const db = firebase.firestore();
        await db.collection('groups').doc(groupId).update({ members: db.FieldValue.arrayUnion(currentUser.uid) });
        await db.collection('group_invitations').doc(inviteId).delete();
        showNotification('Joined group!', 'success');
    };
    window.declineGroupInvite = (inviteId) => firebase.firestore().collection('group_invitations').doc(inviteId).delete();
    
    window.openInviteUserToGroupModal = () => {
        userInviteSearchInput.value = '';
        userInviteSearchResultsEl.innerHTML = '<li class="empty-state">Search for a user to invite.</li>';
        closeModal(chatSettingsModal);
        openModal(inviteUserToGroupModal);
    };

    window.sendGroupInviteToUser = async (userId, username) => {
        if (!activeChat.id || activeChat.type !== 'group') return;
        
        // Check if user is already a member
        const groupDoc = await firebase.firestore().collection('groups').doc(activeChat.id).get();
        if (groupDoc.data().members.includes(userId)) {
            return showNotification(`${username} is already in this group.`, 'warning');
        }
        
        // Check for existing invite
        const inviteQuery = await firebase.firestore().collection('group_invitations')
            .where('groupId', '==', activeChat.id)
            .where('receiverId', '==', userId).get();
            
        if (!inviteQuery.empty) {
            return showNotification(`An invite has already been sent to ${username}.`, 'warning');
        }

        await firebase.firestore().collection('group_invitations').add({
            groupId: activeChat.id,
            groupName: activeChat.name,
            receiverId: userId,
            inviterId: currentUser.uid,
            inviterName: currentUserProfile.username,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showNotification(`Invite sent to ${username}!`, 'success');
    };
    
    window.kickUserFromGroup = async (userIdToKick) => {
        if (!activeChat.id || currentUser.uid !== activeChat.createdBy) return;
        const userToKickName = (await firebase.firestore().collection('users').doc(userIdToKick).get()).data().username;
        if (!confirm(`Are you sure you want to kick ${userToKickName} from the group?`)) return;
        
        await firebase.firestore().collection('groups').doc(activeChat.id).update({
            members: firebase.firestore.FieldValue.arrayRemove(userIdToKick)
        });
        showNotification(`${userToKickName} has been kicked.`, 'success');
        openChatSettingsModal(); // Refresh modal
    };
    
    async function openChatSettingsModal() {
        if (!activeChat.id) return;
        chatSettingsModalBody.innerHTML = '<div>Loading...</div>';
        openModal(chatSettingsModal);

        if (activeChat.type === 'dm') {
            // ... DM settings logic
        } else if (activeChat.type === 'group') {
            chatSettingsModalTitle.textContent = `Settings for ${activeChat.name}`;
            const groupDoc = await firebase.firestore().collection('groups').doc(activeChat.id).get();
            const groupData = groupDoc.data();
            activeChat.createdBy = groupData.createdBy; // ensure it's up to date
            await fetchUsers(groupData.members);
            
            let memberListHTML = groupData.members.map(memberId => {
                const member = userCache[memberId];
                if (!member) return '';
                const isCreator = memberId === groupData.createdBy;
                const canKick = currentUser.uid === groupData.createdBy && memberId !== currentUser.uid;
                
                return `<div class="nickname-item">
                    <span>${member.username} ${isCreator ? '<span class="badge">Creator</span>' : ''}</span>
                    ${canKick ? `<button class="btn btn-danger btn-sm" onclick="kickUserFromGroup('${memberId}')">Kick</button>` : ''}
                </div>`;
            }).join('');
            
            const isCreator = currentUser.uid === groupData.createdBy;
            let actionButtonsHTML = isCreator
                ? `<button class="btn btn-primary" onclick="openInviteUserToGroupModal()">Invite User</button><button class="btn btn-danger" onclick="deleteGroup('${activeChat.id}')">Delete Group</button>`
                : `<button class="btn btn-danger" onclick="leaveGroup('${activeChat.id}')">Leave Group</button>`;

            chatSettingsModalBody.innerHTML = `
                <h4>Members (${groupData.members.length})</h4>
                <div style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;">${memberListHTML}</div>
                <h4>Actions</h4>
                <div style="display: flex; gap: 10px;">${actionButtonsHTML}</div>
            `;
        }
    }

    // --- EVENT LISTENERS ---
    chatSettingsBtn.addEventListener('click', openChatSettingsModal);
    
    userInviteSearchInput.addEventListener('input', async (e) => {
        const searchTerm = e.target.value.trim();
        if (searchTerm.length < 2) {
            userInviteSearchResultsEl.innerHTML = '<li class="empty-state">Search for a user to invite.</li>';
            return;
        }
        
        const userQuery = await firebase.firestore().collection('users').where('username', '==', searchTerm).get();
        if (userQuery.empty) {
            userInviteSearchResultsEl.innerHTML = '<li class="empty-state">No user found with that name.</li>';
            return;
        }
        
        userInviteSearchResultsEl.innerHTML = '';
        userQuery.forEach(doc => {
            if (doc.id === currentUser.uid) return;
            const userData = doc.data();
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="item-info"><span class="item-name">${userData.username}</span></div>
                <div class="item-actions">
                    <button class="btn btn-primary btn-sm" onclick="sendGroupInviteToUser('${doc.id}', '${userData.username}')">Invite</button>
                </div>
            `;
            userInviteSearchResultsEl.appendChild(li);
        });
    });

    </script>
</body>
</html>
