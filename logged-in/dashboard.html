<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - DASHBOARD</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="../panic-key.js"></script>
  <script src="../ban-enforcer.js"></script>
  <script src="../url-changer.js"></script>

  <style>
    /* --- Dashboard Layout --- */
    body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: 'PrimaryFont', sans-serif; }
    .dashboard-container { display: flex; flex: 1; }

    /* --- Sidebar --- */
    .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.collapsed { width: 85px; }
    #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
    .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
    .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
    .sidebar nav li { margin-bottom: 10px; }
    .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
    .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
    .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
    .sidebar nav a .label { margin-left: 10px; white-space: nowrap; opacity: 1; visibility: visible; transition: opacity 0.2s ease-in-out; transition-delay: 0.4s; }
    .sidebar.collapsed nav a .label { opacity: 0; visibility: hidden; transition-delay: 0s; }

    /* --- Main Content & Controls --- */
    .main-content { flex: 1; padding: 40px; background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%); overflow-y: auto; position: relative; }
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(103, 32, 189, 0.1); position: relative; }
    .dashboard-title { margin: 0; font-size: 2.2em; font-weight: bold; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .dashboard-title-wrapper { display: flex; align-items: center; gap: 20px; flex-grow: 1; }
    .battery-status-container { display: none; flex-direction: column; font-size: 0.75em; font-weight: 500; color: #5f6368; background-color: rgba(0, 0, 0, 0.03); border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 8px; padding: 4px 8px; line-height: 1.3; }
    .battery-status-container.charging { color: #2e7d32; border-color: rgba(46, 125, 50, 0.4); }
    #battery-level.low { color: #f5c518; } #battery-level.critical { color: #e53935; } #battery-level.very-critical { color: #b71c1c; }
    
    /* --- Dashboard Grid & Cards --- */
    .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; position: relative; }
    @media (min-width: 768px) { .dashboard-grid { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); } }
    @media (min-width: 1200px) { .dashboard-grid { grid-template-columns: repeat(6, 1fr); } }
    .dashboard-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); border: 1px solid rgba(103, 32, 189, 0.1); position: relative; user-select: none; z-index: 2; display: flex; flex-direction: column; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; min-height: 200px; grid-column: span 1; }
    @media (min-width: 1200px) { .dashboard-card[data-card-type="medium"] { grid-column: span 3; } .dashboard-card[data-card-type="small"] { grid-column: span 2; } .dashboard-card[data-card-type="full"] { grid-column: span 6; } }
    .dashboard-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 15px 40px rgba(103, 32, 189, 0.15); border-color: rgba(103, 32, 189, 0.3); }
    .card-header { display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid rgba(103, 32, 189, 0.1); justify-content: flex-start; flex-shrink: 0; position: relative; }
    .card-icon { font-size: 2em; margin-right: 12px; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 2px 4px rgba(103, 32, 189, 0.2)); }
    .card-title { font-size: 1.3em; font-weight: bold; margin: 0; color: #333; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-header-buttons { position: relative; margin-left: auto; display: flex; gap: 6px; align-items: center; }
    .weather-action-btn { background: rgba(103, 32, 189, 0.08); border: none; cursor: pointer; padding: 8px; line-height: 1; display: inline-flex; align-items: center; justify-content: center; border-radius: 12px; z-index: 5; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .weather-action-btn img { width: 22px; height: 22px; display: block; filter: invert(0.3) brightness(100%); }
    .weather-action-btn:hover { background-color: rgba(103, 32, 189, 0.15); transform: translateY(-2px); }
    .weather-action-btn:disabled { cursor: not-allowed; opacity: 0.6; transform: translateY(0); }
    @keyframes spin-clockwise { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .weather-refresh-btn.refreshing img { animation: spin-clockwise 0.8s linear infinite; }
    .card-content-inner { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
    
    /* --- Super Widget Specific Styles --- */
    .super-widget-container { display: flex; flex-wrap: wrap; gap: 20px; height: 100%; flex-grow: 1; }
    .super-widget-clock-section { flex: 1 1 300px; display: flex; flex-direction: column; justify-content: center; }
    .super-widget-weather-section { flex: 2 1 400px; display: flex; flex-direction: column; justify-content: center; border-left: 1px solid rgba(103, 32, 189, 0.1); padding-left: 20px; }
    @media (max-width: 900px) { .super-widget-weather-section { border-left: none; padding-left: 0; border-top: 1px solid rgba(103, 32, 189, 0.1); padding-top: 20px; } }
    .weather-large-content { display: flex; flex-direction: column; height: 100%; justify-content: flex-start; }
    .current-weather-layout { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(103, 32, 189, 0.08); width: 100%; box-sizing: border-box; }
    .weather-icon-large { font-size: 3.2em; color: #6720bd; flex-shrink: 0; }
    .current-weather-main-info { display: flex; flex-direction: column; align-items: flex-start; flex-grow: 1; }
    .temp-large { font-size: 2.3em; font-weight: bold; color: #333; line-height: 1.1; }
    .condition-large { font-size: 0.95em; color: #555; }
    .current-weather-details-aside { display: flex; flex-direction: column; align-items: flex-end; font-size: 0.75em; color: #777; line-height: 1.4; flex-shrink: 0; padding-left: 12px; border-left: 1px solid rgba(103, 32, 189, 0.1); text-align: right; }
    .current-weather-details-aside p { margin: 0; }
    .forecast-large { display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; padding: 6px 0px; margin-bottom: 8px; }
    .forecast-day { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 8px 4px; background-color: #ffffff; border-radius: 12px; min-width: 70px; text-align: center; border: 1.25px solid rgba(103, 32, 189, 0.2); cursor: pointer; transition: all 0.2s ease; height: 82.5px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .forecast-day:hover { background-color: rgba(103, 32, 189, 0.1); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(103, 32, 189, 0.1); }
    .forecast-day .day-name { font-size: 0.75em; font-weight: 600; color: #555; }
    .forecast-day .icon { font-size: 1.6em; color: #6720bd; line-height:1; }
    .forecast-day .temps { font-size: 0.8em; color: #333; }
    .clock-display { font-size: 3.5em; font-weight: bold; color: #333; text-align: left; margin-bottom: 5px; }
    .date-display { font-size: 1.5em; color: #666; text-align: left; }
    .additional-time-info { font-size: 1em; color: #777; text-align: left; margin-top: 10px; line-height: 1.3; }
    .additional-time-info span { display: inline-block; padding: 0 5px; }
    .additional-time-info span:first-child { padding-left: 0; }
    .dashboard-countdown-section { margin-top: 15px; border-top: 1px solid rgba(103, 32, 189, 0.1); padding-top: 15px; }
    .dashboard-countdown-display-name { font-size: 1em; font-weight: 600; color: #444; margin: 0 0 5px 0; text-align: left; }
    .dashboard-countdown-display-timer { font-size: 1.5em; font-weight: bold; color: #6720bd; text-align: left; min-height: 1.5em; }
    .dashboard-countdown-display-timer .time-unit { display: inline-block; margin: 0 4px; text-align: center; }
    .dashboard-countdown-display-timer .time-label { display: block; font-size: 0.5em; color: #888; font-weight: normal; }

    /* Other Widgets */
    .stopwatch-display, .timer-display-value{font-size: 2.2em;font-weight: bold;color: #6720bd;text-align: center;margin-bottom: 15px;letter-spacing: 1px;font-family: 'PrimaryFont', sans-serif}.timer-inputs{display: flex;justify-content: center;gap: 5px;margin-bottom: 15px}.timer-inputs.hidden{display: none}.timer-inputs input{width: 40px;padding: 8px;text-align: center;border: 1px solid #ccc;border-radius: 5px;font-size: 1em;font-family: 'PrimaryFont', sans-serif}.controls-flex{display: flex;justify-content: center;gap: 10px;flex-wrap: wrap}.controls-flex button{background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);color: white;border: none;padding: 10px 15px;border-radius: 8px;cursor: pointer;font-family: 'PrimaryFont', sans-serif;font-weight: 600;transition: all .2s ease}.controls-flex button:hover{transform: translateY(-2px);box-shadow: 0 4px 10px rgba(103, 32, 189, .3)}.controls-flex button[data-action=pause]{background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%)}.controls-flex button[data-action=reset]{background: linear-gradient(135deg, #6c757d 0%, #495057 100%)}.quick-actions-list{display: flex;flex-direction: column;gap: 10px}.quick-actions-list button{display: flex;align-items: center;width: 100%;padding: 12px 15px;background-color: #f8f9fa;border: 1px solid #e9ecef;border-radius: 12px;text-align: left;font-family: 'PrimaryFont', sans-serif;font-size: 1.1em;text-transform: uppercase;color: #495057;cursor: pointer;transition: all .2s ease;height: 42.5px}.quick-actions-list button:hover{background-color: #e9ecef;border-color: #dee2e6;transform: translateY(-1px);box-shadow: 0 2px 5px rgba(0,0,0,.05)}.quick-actions-list button .icon{font-size: 1.5em;margin-right: 12px;color: #6720bd}.quick-actions-list button .text{flex-grow: 1;font-weight: 500}.quick-actions-list button .arrow{font-size: 1.2em;color: #adb5bd}
    
    /* --- Modals (General & Specific) --- */
    .modal { display: flex; align-items: center; justify-content: center; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); visibility: hidden; opacity: 0; transition: opacity 0.25s ease-out, visibility 0s linear 0.25s; }
    .modal.modal-open { visibility: visible; opacity: 1; transition: opacity 0.25s ease-out, visibility 0s linear 0s; }
    .modal-content { background-color: #fefefe; padding: 30px; border: 1px solid #bbb; width: 90%; max-width: 500px; border-radius: 18px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); position: relative; color: #333; transform: scale(0.9); transition: transform 0.3s ease-out; display: flex; flex-direction: column; gap: 15px; }
    .modal.modal-open .modal-content { transform: scale(1); }
    .modal-close-btn { color: #aaa; position: absolute; top: 15px; right: 18px; font-size: 30px; font-weight: 300; background: none; border: none; cursor: pointer; line-height: 1; transition: color 0.2s ease; }
    .modal-close-btn:hover { color: #6720bd; }
    #forecastDetailModal .modal-header-section { text-align: center; border-bottom: 1px solid rgba(103, 32, 189, 0.1); padding-bottom: 15px; margin-bottom: 15px; }
    #forecastDetailModal h3 { margin: 0 0 8px; color: #6720bd; font-size: 1.8em; } #forecastDetailModal .date-subtitle { font-size: 1.1em; color: #555; margin: 0; }
    #forecastDetailModal .modal-current-weather-summary { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; }
    #forecastDetailModal .modal-icon-large { font-size: 4em; color: #6720bd; } #forecastDetailModal .modal-temp-display { font-size: 2.8em; font-weight: bold; }
    #forecastDetailModal #modalWeatherDesc { font-size: 1.2em; color: #666; }
    #forecastDetailModal .modal-details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px 20px; }
    #forecastDetailModal .modal-details-grid p { font-size: .9em; line-height: 1.5; margin: 0; display: flex; align-items: center; gap: 8px; color: #444; }
    #forecastDetailModal .modal-details-grid p strong { font-weight: 600; display: flex; align-items: center; gap: 5px; }
    #forecastDetailModal .modal-details-grid .detail-icon { font-size: 1.1em; color: #8a2be2; }
    #forecastDetailModal .modal-advice-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(103, 32, 189, .15); }
    #forecastDetailModal .modal-advice-section h4 { margin: 0 0 10px; font-size: 1.1em; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    #forecastDetailModal .modal-advice-section ul { list-style-type: "✓  "; margin: 0 0 0 20px; padding: 0; font-size: .95em; line-height: 1.6; color: #555; }
    #forecastDetailModal .modal-advice-section li { margin-bottom: 5px; }
    .overview-settings-modal .modal-content { gap: 20px; } .overview-settings-modal h3 { margin: 0; text-align: center; font-size: 1.6em; color: #6720bd; font-weight: bold; }
    .settings-section { display: flex; flex-direction: column; gap: 12px; } .settings-section label { font-weight: 600; color: #555; font-size: 1.1em; }
    .location-input-wrapper { position: relative; }
    #overviewLocationInput { width: 100%; padding: 12px 15px; font-size: 1em; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-family: 'PrimaryFont', sans-serif;}
    #overviewLocationInput:focus { outline: none; border-color: #8a2be2; box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.2); }
    #overviewLocationSuggestions { list-style: none; padding: 0; margin: 5px 0 0 0; position: absolute; background: white; width: 100%; border: 1px solid #ddd; border-radius: 8px; max-height: 150px; overflow-y: auto; z-index: 10001; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    #overviewLocationSuggestions li { padding: 10px 15px; cursor: pointer; transition: background-color 0.2s; border-bottom: 1px solid #eee; } #overviewLocationSuggestions li:hover { background-color: #f0f2f5; }
    #overviewUseCurrentLocationBtn { padding: 10px 15px; font-size: 0.95em; font-weight: 600; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'PrimaryFont', sans-serif; }
    .unit-toggle-wrapper { display: flex; align-items: center; justify-content: space-between; padding: 10px; background-color: #f8f9fa; border-radius: 10px; }
    .switch { position: relative; display: inline-block; width: 60px; height: 34px; } .switch input { display:none; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; } .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: #6720bd; } input:checked + .slider:before { transform: translateX(26px); } .slider:after{ content:'°F'; color: white; position: absolute; transform: translate(-50%,-50%); top: 50%; left: 75%; font-size: 12px; } input#overviewUnitToggle:checked + .slider:after { content:'°C'; left: 25%; } input#fullscreenWeatherToggle:not(:checked) + .slider:after{ content:'OFF'; color: white; left: 75%; } input#fullscreenWeatherToggle:checked + .slider:after { content:'ON'; left: 25%; }
    .data-source-selector { display: flex; gap: 10px; } .data-source-selector input[type="radio"] { display: none; } .data-source-selector label { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; font-weight: 600; } .data-source-selector input[type="radio"]:checked + label { background-color: #6720bd; border-color: #8a2be2; color: white; box-shadow: 0 2px 8px rgba(103, 32, 189, 0.3); } .data-source-selector input[type="radio"]:disabled + label { background-color: #e9ecef; cursor: not-allowed; color: #999; border-color: #e0e0e0; }
    #nwsApiNote { font-size: 0.85em; color: #777; text-align: center; margin-top: 5px; }
    .new-countdown-modal .modal-content { max-width: 400px; gap: 15px; } .new-countdown-modal h3 { margin: 0; text-align: center; font-size: 1.6em; color: #6720bd; font-weight: bold; } .form-group { display: flex; flex-direction: column; gap: 5px; } .form-group label { font-weight: 600; } .form-group input { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; } #saveNewCountdownBtn { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1.1em; }
    .shortcut-settings-modal .modal-content{max-width: 600px;gap: 10px}.shortcut-settings-modal h3{margin: 0 0 10px;text-align: center;font-size: 1.6em;color: #6720bd;font-weight: 700;font-family: 'PrimaryFont', sans-serif}#shortcutSettingsForm{display: flex;flex-direction: column;gap: 20px;max-height: 60vh;overflow-y: auto;padding-right: 10px}.shortcut-editor-group{padding: 15px;border: 1px solid #ddd;border-radius: 12px;background-color: #f9f9f9}.shortcut-editor-group h4{margin-top: 0;margin-bottom: 15px;color: #333;border-bottom: 1px solid #eee;padding-bottom: 8px}.shortcut-input-row{display: flex;flex-wrap: wrap;align-items: center;gap: 10px;margin-bottom: 12px}.shortcut-input-row label{font-weight: 600;color: #555;white-space: nowrap}.shortcut-input-row input[type=text],.shortcut-input-row input[type=url],.shortcut-input-row select{padding: 8px 10px;font-size: 1em;border: 1px solid #ccc;border-radius: 6px;box-sizing: border-box;font-family: 'PrimaryFont', sans-serif;flex: 1 1 150px}.shortcut-emoji-input{flex: 0 1 60px}.shortcut-name-input{flex: 1 1 200px}.action-target-wrapper .hidden{display: none}.shortcut-modal-buttons{display: flex;justify-content: flex-end;gap: 10px;margin-top: 10px;border-top: 1px solid #eee;padding-top: 20px}.shortcut-modal-buttons button{padding: 10px 20px;border: none;border-radius: 8px;cursor: pointer;font-weight: 600;font-family: 'PrimaryFont', sans-serif;transition: all .2s ease}#saveShortcutsBtn{background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);color: #fff}#saveShortcutsBtn:hover{transform: translateY(-2px);box-shadow: 0 4px 10px rgba(103, 32, 189, .3)}#resetShortcutsBtn{background-color: #6c757d;color: #fff}#resetShortcutsBtn:hover{background-color: #5a6268}
    
    /* --- Fullscreen Additions --- */
    #fullscreen-weather-display { position: absolute; top: 20px; right: 80px; text-align: right; font-size: 1.5vw; text-shadow: 0 0 10px black; display: flex; align-items: center; gap: 10px; transition: right 0.5s ease-in-out; }
    #fullscreen-weather-display .icon { font-size: 2em; } #fullscreen-weather-display .temp { font-weight: bold; } #fullscreen-weather-display .condition { font-size: 0.7em; }
    #clock-fs-color-palette .color-swatch-custom { background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); } #color-picker-input { visibility: hidden; width: 0; height: 0; position: absolute; }
    #edit-mode-hint { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: rgba(40, 40, 40, 0.9); backdrop-filter: blur(5px); color: white; padding: 12px 25px; border-radius: 12px; z-index: 10001; font-size: 0.9em; transition: bottom 0.4s ease-in-out; display: flex; align-items: center; gap: 15px; }
    #edit-mode-hint.visible { bottom: 20px; } #edit-mode-hint kbd { background-color: #555; padding: 2px 6px; border-radius: 4px; }
    .hint-divider { width: 1px; height: 14px; background-color: #666; }
    #clock-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; color: white; z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; background: #0a0a14; transition: background 0.5s ease; user-select: none; }
    #clock-fullscreen-overlay.active { display: flex; } #clock-fullscreen-overlay.inactive-cursor { cursor: none; }
    #clock-fs-main-time { font-size: 12vw; font-weight: bold; } #clock-fs-main-date { font-size: 2.5vw; margin-top: -1vh; }
    #clock-fs-countdown-section { margin-top: 5vh; min-height: 15vh; width: 100%; }
    #clock-fs-countdown-name { font-size: 2vw; font-weight: 500; } #clock-fs-countdown-timer { font-size: 4vw; font-weight: bold; }
    #clock-fs-countdown-timer .time-unit { display: inline-block; margin: 0 0.5vw; } #clock-fs-countdown-timer .time-label { font-size: 0.3em; display: block; margin-top: -0.5vh; }
    .clock-fs-controls { position: absolute; top: 20px; left: 20px; display: flex; gap: 15px; align-items: center; transition: opacity 0.5s ease-in-out; }
    .clock-fs-right-controls { position: absolute; top: 20px; right: 20px; transition: opacity 0.5s ease-in-out; }
    .clock-fs-controls.controls-hidden, .clock-fs-right-controls.controls-hidden { opacity: 0; visibility: hidden; }
    #clock-fs-color-toggle { font-size: 1.8em; cursor: pointer; transition: transform 0.3s; } #clock-fs-color-toggle:hover { transform: rotate(45deg); }
    #clock-fs-color-palette { position: absolute; top: 70px; right: 20px; width: 152px; background: rgba(255,255,255,.1); backdrop-filter: blur(5px); border-radius: 12px; padding: 10px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; z-index: 2001; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
    #clock-fs-color-palette.visible { opacity: 1; visibility: visible; }
    .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid white; transition: transform 0.2s; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
    .color-swatch:hover { transform: scale(1.1); }
    .custom-select-wrapper { position: relative; font-family: 'PrimaryFont', sans-serif;}
    .custom-select-trigger { background: rgba(255,255,255,.15); color: white; border: 1px solid rgba(255,255,255,.3); border-radius: 12px; padding: 10px 30px 10px 15px; cursor: pointer; position: relative; width: 250px; transition: background-color 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1em; }
    #overviewSettingsModal .custom-select-trigger { background: #fff; color: #333; border: 1px solid #ccc; width: auto; }
    .custom-select-trigger:hover { background: rgba(255,255,255,.25); }
    #overviewSettingsModal .custom-select-trigger:hover { background-color: #f0f2f5; }
    .custom-select-trigger::after { content: "▼"; font-size: .7em; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); transition: transform .2s; }
    .custom-select.open .custom-select-trigger::after { transform: translateY(-50%) rotate(180deg); }
    .custom-options { position: absolute; top: 105%; left: 0; right: 0; background: rgba(40,40,40,.7); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,.2); border-radius: 12px; z-index: 10; max-height: 200px; overflow-y: auto; display: none; }
    #overviewSettingsModal .custom-options { background: white; border: 1px solid #ddd; color: #333; }
    .custom-select.open .custom-options { display: block; }
    .custom-option { display: block; padding: 12px 15px; cursor: pointer; transition: background-color 0.2s; white-space: normal; word-break: break-word; }
    .custom-option:hover { background-color: rgba(255,255,255,.1); }
    #overviewSettingsModal .custom-option:hover { background-color: #f0f2f5; }
    .custom-option.selected { background-color: rgba(138,43,226,.5); font-weight: bold; }
    #overviewSettingsModal .custom-option.selected { background-color: #e9ecef; }
    .fade-in { animation: fadeIn .6s ease-out forwards; } @keyframes fadeIn{from{opacity: 0;transform: translateY(20px)}to{opacity: 1;transform: translateY(0)}}
  </style>
</head>
<body class="dashboard-page">
  <header class="main-header light-bg">
    <div class="container">
      <div class="logo"> <a href="../index.html"> <img src="../images/logo-dark.png" alt="4SP Logo" /> </a> </div>
      <div class="auth-buttons"> <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button> <button id="logoutBtn" class="btn btn-login">LOG OUT</button> </div>
    </div>
  </header>
  <div class="dashboard-container">
    <aside class="sidebar" id="sidebar">
      <button id="toggleSidebar">☰</button>
      <nav>
        <ul>
          <li><a href="dashboard.html" class="active"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
          <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
          <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
          <li><a href="apps.html"><span class="icon">✨</span><span class="label">Apps</span></a></li>
          <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
          <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
        </ul>
      </nav>
    </aside>
    <main class="main-content">
      <div class="dashboard-header">
        <div class="dashboard-title-wrapper">
          <h2 class="dashboard-title">Dashboard</h2>
          <div id="battery-status" class="battery-status-container">
            <div id="battery-charging-status"></div> <div id="battery-level"></div>
          </div>
        </div>
      </div>
      <div class="dashboard-grid" id="dashboardGrid"></div>
    </main>
  </div>
  <div id="edit-mode-hint"></div>
  <div id="clock-fullscreen-overlay">
    <div id="fullscreen-weather-display" style="display: none;"></div>
    <div class="clock-fs-controls">
      <div class="custom-select-wrapper" id="fullscreen-countdown-select-wrapper">
        <div class="custom-select">
          <div class="custom-select-trigger"><span>No Countdown</span></div>
          <div class="custom-options"> <span class="custom-option selected" data-value="">No Countdown</span> </div>
        </div>
      </div>
    </div>
    <div class="clock-fs-right-controls"> <div id="clock-fs-color-toggle" title="Change Background">🎨</div> </div>
    <div id="clock-fs-color-palette">
        <div class="color-swatch" style="background: #0a0a14;" data-color="#0a0a14"></div>
        <div class="color-swatch" style="background: linear-gradient(135deg, #23074d, #cc5333);" data-color="linear-gradient(135deg, #23074d, #cc5333)"></div>
        <div class="color-swatch" style="background: linear-gradient(135deg, #1f4037, #99f2c8);" data-color="linear-gradient(135deg, #1f4037, #99f2c8)"></div>
        <div class="color-swatch" style="background: linear-gradient(135deg, #780206, #061161);" data-color="linear-gradient(135deg, #780206, #061161)"></div>
        <div class="color-swatch" style="background: #2c3e50;" data-color="#2c3e50"></div>
        <div class="color-swatch color-swatch-custom" title="Custom Color"></div>
        <input type="color" id="color-picker-input">
    </div>
    <div id="clock-fs-main-time">00:00:00</div>
    <div id="clock-fs-main-date">Day, Month Date, Year</div>
    <div id="clock-fs-countdown-section"> <h3 id="clock-fs-countdown-name"></h3> <div id="clock-fs-countdown-timer"></div> </div>
  </div>
  <div id="forecastDetailModal" class="modal">
    <div class="modal-content">
      <button class="modal-close-btn">&times;</button>
      <div class="modal-header-section">
        <h3 id="modalDayDate">Day, Date</h3>
        <p class="date-subtitle" id="modalFullDateSubtitle"></p>
      </div>
      <div class="modal-current-weather-summary"> <span id="modalWeatherIcon" class="modal-icon-large">❓</span>
        <div class="modal-temp-and-desc">
          <div class="modal-temp-display"> <span id="modalMaxTemp">--</span> / <span id="modalMinTemp">--</span> </div>
          <div id="modalWeatherDesc">Description</div>
        </div>
      </div>
      <div class="modal-details-grid">
        <p><strong><span class="detail-icon">🌡️</span>Feels Like:</strong> <span id="modalFeelsLike">--</span></p>
        <p><strong><span class="detail-icon">💧</span>Humidity:</strong> <span id="modalHumidity">--</span>%</p>
        <p><strong><span class="detail-icon">🌧️</span>Precipitation:</strong> <span id="modalPrecipSum">--</span> mm</p>
        <p><strong><span class="detail-icon">☔</span>Precip. Chance:</strong> <span id="modalPrecipProb">--</span>%</p>
        <p><strong><span class="detail-icon">💨</span>Max Wind:</strong> <span id="modalWindSpeed">--</span></p>
        <p><strong><span class="detail-icon">🧭</span>Wind Direction:</strong> <span id="modalWindDirection">--</span></p>
        <p><strong><span class="detail-icon">☀️</span>Sunrise:</strong> <span id="modalSunriseTime">--:--</span></p>
        <p><strong><span class="detail-icon">🌇</span>Sunset:</strong> <span id="modalSunsetTime">--:--</span></p>
        <p><strong><span class="detail-icon">💡</span>Daylight:</strong> <span id="modalDaylightDuration">--</span></p>
      </div>
      <div class="modal-advice-section">
        <h4><span class="detail-icon">💡</span> Daily Advice</h4>
        <div id="modalDailyAdvice">Checking the forecast for tips...</div>
      </div>
    </div>
  </div>
  <div id="overviewSettingsModal" class="modal overview-settings-modal">
    <div class="modal-content">
      <button class="modal-close-btn">&times;</button>
      <h3>Overview Settings</h3>
      <div class="settings-section">
        <label for="overviewLocationInput">Location</label>
        <div class="location-input-wrapper">
          <input type="text" id="overviewLocationInput" placeholder="Enter a city name...">
          <ul id="overviewLocationSuggestions"></ul>
        </div>
        <button id="overviewUseCurrentLocationBtn">📍 Use My Current Location</button>
      </div>
      <div class="settings-section">
        <label>Data Source</label>
        <div class="data-source-selector">
          <input type="radio" id="sourceOpenMeteo" name="dataSource" value="open-meteo" checked>
          <label for="sourceOpenMeteo">Open-Meteo</label>
          <input type="radio" id="sourceNWS" name="dataSource" value="nws">
          <label for="sourceNWS">NWS (USA)</label>
        </div>
        <p id="nwsApiNote" style="display: none;">The NWS API is only for locations in the United States.</p>
      </div>
      <div class="settings-section">
        <label>Units</label>
        <div class="unit-toggle-wrapper"> <span>Imperial (°F) / Metric (°C)</span>
          <label class="switch"> <input type="checkbox" id="overviewUnitToggle"> <span class="slider"></span> </label>
        </div>
      </div>
      <div class="settings-section">
          <label>Displayed Countdown</label>
          <div class="custom-select-wrapper" id="overview-countdown-select-wrapper">
              <div class="custom-select">
                  <div class="custom-select-trigger"><span>-- None --</span></div>
                  <div class="custom-options"></div>
              </div>
          </div>
      </div>
      <div class="settings-section">
          <label>Fullscreen Options</label>
          <div class="unit-toggle-wrapper">
              <span>Show Weather in Fullscreen</span>
              <label class="switch"><input type="checkbox" id="fullscreenWeatherToggle"><span class="slider"></span></label>
          </div>
      </div>
    </div>
  </div>
  <div id="shortcutSettingsModal" class="modal shortcut-settings-modal">
      <div class="modal-content">
          <button class="modal-close-btn">&times;</button>
          <h3>Edit Quick Shortcuts</h3>
          <form id="shortcutSettingsForm" onsubmit="return false;"></form>
          <div class="shortcut-modal-buttons">
              <button id="resetShortcutsBtn" type="button">Reset to Default</button>
              <button id="saveShortcutsBtn" type="button">Save Changes</button>
          </div>
      </div>
  </div>
  <div id="newCountdownModal" class="modal new-countdown-modal">
    <div class="modal-content">
      <button class="modal-close-btn">&times;</button>
      <h3>New Countdown</h3>
      <div class="form-group">
        <label for="newCountdownName">Event Name</label>
        <input type="text" id="newCountdownName" placeholder="e.g., New Year's Day">
      </div>
      <div class="form-group">
        <label for="newCountdownDateTime">Date & Time</label>
        <input type="text" id="newCountdownDateTime" placeholder="Select a future date...">
      </div>
      <button id="saveNewCountdownBtn">Save Countdown</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="../firebase-config.js"></script>
  <script>
    // --- THIS IS THE FULL, CORRECTED AND CONSOLIDATED SCRIPT ---
    
    // --- GLOBALS AND UTILITIES ---
    const getStorageKey = (key) => firebase.auth().currentUser ? `4sp_${key}_${firebase.auth().currentUser.uid}` : `4sp_${key}_guest`;
    const WMO_CODES={0:{d:"Clear sky",i:"☀️"},1:{d:"Mainly clear",i:"🌤️"},2:{d:"Partly cloudy",i:"🌥️"},3:{d:"Overcast",i:"☁️"},45:{d:"Fog",i:"🌫️"},48:{d:"Rime fog",i:"🌫️"},51:{d:"Light drizzle",i:"🌦️"},53:{d:"Drizzle",i:"🌦️"},55:{d:"Dense drizzle",i:"🌧️"},56:{d:"Light freezing drizzle",i:"🌨️"},57:{d:"Dense freezing drizzle",i:"🌨️"},61:{d:"Slight rain",i:"🌧️"},63:{d:"Rain",i:"🌧️"},65:{d:"Heavy rain",i:"🌧️"},66:{d:"Light freezing rain",i:"🌨️"},67:{d:"Heavy freezing rain",i:"🌨️"},71:{d:"Slight snow",i:"❄️"},73:{d:"Snow",i:"❄️"},75:{d:"Heavy snow",i:"❄️"},77:{d:"Snow grains",i:"❄️"},80:{d:"Slight showers",i:"🌦️"},81:{d:"Showers",i:"🌦️"},82:{d:"Violent showers",i:"⛈️"},85:{d:"Slight snow showers",i:"🌨️"},86:{d:"Heavy snow showers",i:"🌨️"},95:{d:"Thunderstorm",i:"⛈️"},96:{d:"Thunderstorm, slight hail",i:"⛈️"},99:{d:"Thunderstorm, heavy hail",i:"⛈️"}};
    
    // --- DOM Elements ---
    const dashboardGrid = document.getElementById('dashboardGrid');
    const editModeHint = document.getElementById('edit-mode-hint');

    // --- Layout Globals ---
    const dashboardLayoutStorageKey = '4sp_dashboardLayout_v2_super';
    let selectedWidgetId = null;
    const defaultDashboardLayout = ['time_weather_super_widget', 'stopwatch_widget', 'timer_widget', 'quick_actions_widget'];
    const pageSuggestions = [ { name: 'Dashboard', url: 'dashboard.html' }, { name: 'Games', url: 'games.html' }, { name: 'Soundboard', url: 'soundboard.html' }, { name: 'Notes', url: 'notes.html' }, { name: 'Countdowns', url: 'countdowns.html' }, { name: 'Requests', url: 'requests.html' }, { name: 'Apps', url: 'apps.html' }, { name: 'Weather', url: 'weather.html' }, { name: 'Settings', url: 'settings.html' }];
    
    // --- Quick Actions / Shortcuts Globals ---
    const defaultQuickActions = [
        { icon: "🎓", text: "Classroom", type: "url", value: "https://classroom.google.com/" },
        { icon: "📝", text: "Notes", type: "page", value: "notes.html" },
        { icon: "🗓️", text: "Countdowns", type: "page", value: "countdowns.html" },
        { icon: "🎵", text: "Requests", type: "page", value: "requests.html" }
    ];
    let currentQuickActions = [...defaultQuickActions];

    // --- Weather Globals ---
    const defaultWeatherSettings = { dataSource: 'open-meteo', location: { label: 'New York, NY', latitude: 40.71, longitude: -74.01 }, units: 'imperial', showWeatherInFullscreen: false };
    let weatherSettings = { ...defaultWeatherSettings };
    let userCoords = null, userCountry = null, fullWeatherData = null;

    // --- START: FULL WEATHER LOGIC ---
    function saveWeatherSettings() { localStorage.setItem(getStorageKey('weatherWidgetSettings'), JSON.stringify(weatherSettings)); }
    function loadWeatherSettings() { const s = localStorage.getItem(getStorageKey('weatherWidgetSettings')); if (s) { try { const loaded = JSON.parse(s); weatherSettings = { ...defaultWeatherSettings, ...loaded }; return true; } catch(e) { console.error("Failed to parse weather settings", e); } } return false; }
    
    async function determineUserCountry() { try { const r = await fetch('https://ipapi.co/json/'); if (!r.ok) return; const d = await r.json(); userCountry = d.country_code?.toUpperCase(); } catch (e) { console.warn("Could not determine user country from IP.", e); } }
    function mapNWSKeywordsToWMO(f) { if (!f) return 0; f=f.toLowerCase(); if (f.includes("thunderstorm")||f.includes("t-storm")) return 95; if (f.includes("snow")||f.includes("flurr")) return 73; if (f.includes("rain")||f.includes("shower")) return 63; if (f.includes("drizzle")) return 53; if (f.includes("fog")) return 45; if (f.includes("overcast")||f.includes("cloudy")) return 3; if (f.includes("partly cloudy")||f.includes("mostly cloudy")) return 2; if (f.includes("mostly clear")||f.includes("partly sunny")) return 1; if (f.includes("sunny")||f.includes("clear")) return 0; return 0; }
    
    function transformNWSData(daily, hourly) {
        const t = { latitude: weatherSettings.location.latitude, longitude: weatherSettings.location.longitude, utc_offset_seconds: new Date().getTimezoneOffset() * -60, timezone: Intl.DateTimeFormat().resolvedOptions().timeZone, current: {}, hourly: {}, daily: {} };
        const now = hourly.periods[0];
        t.current = { time: now.startTime, temperature_2m: now.temperature, relative_humidity_2m: now.relativeHumidity.value, apparent_temperature: now.temperature, weather_code: mapNWSKeywordsToWMO(now.shortForecast), wind_speed_10m: parseInt(now.windSpeed.split(' ')[0],10) };
        const dailyPeriods = []; for (let i = 0; i < daily.periods.length; i++) { if (daily.periods[i].isDaytime) { const night = (daily.periods[i+1] && !daily.periods[i+1].isDaytime) ? daily.periods[i+1] : daily.periods[i]; dailyPeriods.push({ day: daily.periods[i], night }); } }
        t.daily = { time: dailyPeriods.map(p => p.day.startTime.split('T')[0]), weather_code: dailyPeriods.map(p => mapNWSKeywordsToWMO(p.day.shortForecast)), temperature_2m_max: dailyPeriods.map(p => p.day.temperature), temperature_2m_min: dailyPeriods.map(p => p.night.temperature), precipitation_sum: dailyPeriods.map(()=>null), precipitation_probability_max: dailyPeriods.map(p=>Math.max(p.day.probabilityOfPrecipitation.value||0, p.night.probabilityOfPrecipitation.value||0)), wind_speed_10m_max: dailyPeriods.map(p=>parseInt(p.day.windSpeed.split(' ')[0],10)), sunrise: dailyPeriods.map(()=>null), sunset: dailyPeriods.map(()=>null), daylight_duration: dailyPeriods.map(()=>null), wind_direction_10m_dominant: dailyPeriods.map(()=>null), uv_index_max: dailyPeriods.map(()=>null), relative_humidity_2m_mean: dailyPeriods.map(() => null) };
        return t;
    }

    const fetchWeather = async () => {
        const widget = document.querySelector('.dashboard-card[data-template-id="time_weather_super_widget"]');
        const refreshBtn = widget?.querySelector('.weather-refresh-btn');
        const refreshImg = refreshBtn?.querySelector('img');
        if (refreshBtn) { refreshBtn.disabled = true; if(refreshImg) refreshImg.classList.add('refreshing'); }
        try {
            if (weatherSettings.dataSource === 'nws') {
                const { latitude, longitude } = weatherSettings.location; const r = await fetch(`https://api.weather.gov/points/${latitude},${longitude}`); if (!r.ok) throw new Error("Outside NWS (USA) coverage."); const d = await r.json();
                const [forecastRes, hourlyRes] = await Promise.all([fetch(d.properties.forecast), fetch(d.properties.forecastHourly)]); if (!forecastRes.ok || !hourlyRes.ok) throw new Error("Failed to get NWS forecast details.");
                const [dailyData, hourlyData] = await Promise.all([forecastRes.json(), hourlyRes.json()]); fullWeatherData = transformNWSData(dailyData.properties, hourlyData.properties);
            } else {
                const {units,location}=weatherSettings; const p=new URLSearchParams({current:"temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m",daily:"weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,wind_speed_10m_max,sunrise,sunset,daylight_duration,wind_direction_10m_dominant,uv_index_max,relative_humidity_2m_mean",timezone:"auto",forecast_days:7,temperature_unit:units==='metric'?'celsius':'fahrenheit',wind_speed_unit:units==='metric'?'kmh':'mph'});
                const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${location.latitude}&longitude=${location.longitude}&${p}`); if (!r.ok) throw new Error(`API Error: ${r.status}`); fullWeatherData = await r.json();
            }
            if (window.renderWeatherInDashboard) window.renderWeatherInDashboard(fullWeatherData);
        } catch (error) { if (window.renderWeatherErrorInDashboard) window.renderWeatherErrorInDashboard(error.message);
        } finally { if (refreshBtn) { refreshBtn.disabled = false; if(refreshImg) refreshImg.classList.remove('refreshing'); } }
    };
    // --- END: FULL WEATHER LOGIC ---

    // --- START: MODAL & ADVICE LOGIC ---
    function formatDaylightDuration(s) { if (s == null) return 'N/A'; const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); return `${h}h ${m}m`; }
    function degreesToCardinal(d) { if (d==null) return 'N/A'; const v=Math.floor((d/22.5)+0.5); const a=["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"]; return a[(v % 16)]; }

    function generateWeatherAdvice(dayData) {
        const advice = new Set(); const { tempMax, tempMin, weatherCode, precipSum, precipProb, windSpeedMax, humidity, uvIndexMax } = dayData; const units = weatherSettings.units;
        const tempMaxC = units === 'imperial' ? (tempMax - 32) * 5 / 9 : tempMax; const tempMinC = units === 'imperial' ? (tempMin - 32) * 5 / 9 : tempMin; const windSpeedMph = units === 'metric' ? windSpeedMax * 0.621371 : windSpeedMax;
        if (tempMaxC >= 32) advice.add("Extreme heat expected. Stay hydrated and avoid strenuous activity."); else if (tempMaxC >= 25) advice.add("It's going to be hot. Wear light clothing."); else if (tempMinC <= 0) advice.add("Freezing temperatures overnight. Watch for icy patches."); else if (tempMaxC <= 5) advice.add("It's quite cold. Bundle up with a thick coat.");
        if (Math.abs(tempMax - tempMin) > (units === 'imperial' ? 25 : 14)) advice.add("Large temperature swing today. Dressing in layers is a good idea.");
        if ((precipSum != null && precipSum > 0.1) || (precipProb != null && precipProb > 40)) { if ([61, 63, 65, 80, 81, 82].includes(weatherCode)) advice.add("Rain is likely. Don't forget an umbrella."); else if ([71, 73, 75, 85, 86].includes(weatherCode)) advice.add("Snow is expected! Wear a warm, waterproof coat."); else if ([95, 96, 99].includes(weatherCode)) advice.add("Thunderstorms are possible. Stay indoors if you hear thunder."); else advice.add("There's a chance of precipitation."); }
        if (windSpeedMph >= 15) advice.add("It could be quite windy. A windbreaker is recommended."); if (humidity != null && tempMaxC >= 28 && humidity >= 60) advice.add("High heat and humidity will make it feel very muggy."); if ([45, 48].includes(weatherCode)) advice.add("Foggy conditions are expected. Be extra cautious if you're driving.");
        if (uvIndexMax != null) { if (uvIndexMax >= 8) advice.add("UV index is very high. Seek shade and use strong sunscreen."); else if (uvIndexMax >= 6) advice.add("High UV index today. Sunscreen is recommended."); }
        if (advice.size === 0) { if ([0, 1].includes(weatherCode)) return "<p>Looks like a beautiful day. Perfect for outdoor activities!</p>"; if (tempMaxC > 18 && tempMaxC < 24 && (!precipProb || precipProb < 20)) return "<p>Conditions look pleasant and mild. A great day to be outside!</p>"; return "<p>Enjoy your day! Check the details above for a full forecast.</p>"; }
        return '<ul>' + [...advice].map(item => `<li>${item}</li>`).join('') + '</ul>';
    }

    function openForecastModal(dayData) {
        const tempS = weatherSettings.units === 'metric' ? '°C' : '°F'; const speedS = weatherSettings.units === 'metric' ? 'km/h' : 'mph';
        const utcDate = new Date(dayData.dateStr + 'T12:00:00Z');
        document.getElementById('modalDayDate').textContent = utcDate.toLocaleDateString(undefined, { weekday: 'long' });
        document.getElementById('modalFullDateSubtitle').textContent = utcDate.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
        const codeInfo = WMO_CODES[dayData.weatherCode] || { description: "Unknown", icon: "❓" };
        document.getElementById('modalWeatherIcon').textContent = codeInfo.icon; document.getElementById('modalWeatherDesc').textContent = codeInfo.description;
        document.getElementById('modalMaxTemp').textContent = `${Math.round(dayData.tempMax)}${tempS}`; document.getElementById('modalMinTemp').textContent = `${Math.round(dayData.tempMin)}${tempS}`;
        document.getElementById('modalPrecipSum').textContent = `${dayData.precipSum != null ? dayData.precipSum : '--'} ${weatherSettings.units === 'metric' ? 'mm' : 'in'}`;
        document.getElementById('modalPrecipProb').textContent = `${dayData.precipProb != null ? dayData.precipProb : '--'}%`;
        document.getElementById('modalWindSpeed').textContent = `${dayData.windSpeedMax != null ? Math.round(dayData.windSpeedMax) : '--'} ${speedS}`;
        document.getElementById('modalWindDirection').textContent = degreesToCardinal(dayData.windDirection);
        document.getElementById('modalDaylightDuration').textContent = formatDaylightDuration(dayData.daylightDuration);
        document.getElementById('modalSunriseTime').textContent = dayData.sunrise ? new Date(dayData.sunrise).toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'}) : 'N/A';
        document.getElementById('modalSunsetTime').textContent = dayData.sunset ? new Date(dayData.sunset).toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'}) : 'N/A';
        document.getElementById('modalFeelsLike').textContent = `${dayData.feelsLike != null ? Math.round(dayData.feelsLike) : '--'}${tempS}`;
        document.getElementById('modalHumidity').textContent = `${dayData.humidity != null ? dayData.humidity : '--'}%`;
        document.getElementById('modalDailyAdvice').innerHTML = generateWeatherAdvice(dayData);
        document.getElementById('forecastDetailModal').classList.add('modal-open');
    }
    // --- END: MODAL & ADVICE LOGIC ---
    
    // --- START: FULLSCREEN CLOCK LOGIC ---
    const clockFsOverlay=document.getElementById('clock-fullscreen-overlay'),clockFsTime=document.getElementById('clock-fs-main-time'),clockFsDate=document.getElementById('clock-fs-main-date'),clockFsCountdownName=document.getElementById('clock-fs-countdown-name'),clockFsCountdownTimer=document.getElementById('clock-fs-countdown-timer');
    let clockFsInterval, clockFsCountdownInterval, inactivityTimer;

    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        const controls = document.querySelectorAll('.clock-fs-controls, .clock-fs-right-controls');
        const weatherDisplay = document.getElementById('fullscreen-weather-display');
        
        clockFsOverlay.classList.remove('inactive-cursor');
        controls.forEach(c => c.classList.remove('controls-hidden'));
        if (weatherDisplay.style.display !== 'none') {
            weatherDisplay.style.right = '80px';
        }

        inactivityTimer = setTimeout(() => {
            clockFsOverlay.classList.add('inactive-cursor');
            controls.forEach(c => c.classList.add('controls-hidden'));
            if (weatherDisplay.style.display !== 'none') {
                weatherDisplay.style.right = '20px';
            }
        }, 2500);
    }

    function openClockFullscreen(){
        const savedColor = localStorage.getItem(getStorageKey('clockFsColor'));
        if (savedColor) clockFsOverlay.style.background = savedColor;
        clockFsOverlay.classList.add('active');
        updateFullscreenClock();
        clockFsInterval=setInterval(updateFullscreenClock, 1000);
        clockFsOverlay.requestFullscreen().catch(err=>{console.error("Fullscreen request failed:",err);closeClockFullscreen()});
        populateAndInitFullscreenCountdownDropdown();
        updateFullscreenWeatherDisplay();
        
        // Start inactivity detection
        clockFsOverlay.addEventListener('mousemove', resetInactivityTimer);
        resetInactivityTimer();
    }
    
    function closeClockFullscreen(){
        clockFsOverlay.classList.remove('active');
        clearInterval(clockFsInterval);
        clearInterval(clockFsCountdownInterval);
        
        // Stop inactivity detection
        clearTimeout(inactivityTimer);
        clockFsOverlay.removeEventListener('mousemove', resetInactivityTimer);
        
        // Ensure UI is visible when exiting
        clockFsOverlay.classList.remove('inactive-cursor');
        document.querySelectorAll('.clock-fs-controls, .clock-fs-right-controls').forEach(c => c.classList.remove('controls-hidden'));
        
        if(window.updateDashboardCountdownDisplay) window.updateDashboardCountdownDisplay();
    }
    
    document.addEventListener('fullscreenchange', ()=>{if(!document.fullscreenElement)closeClockFullscreen()});
    function updateFullscreenClock(){const n=new Date();clockFsTime.textContent=n.toLocaleTimeString();clockFsDate.textContent=n.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
    
    function updateFullscreenWeatherDisplay() {
        const container = document.getElementById('fullscreen-weather-display');
        if (weatherSettings.showWeatherInFullscreen && fullWeatherData) {
            const { current } = fullWeatherData;
            const codeInfo = WMO_CODES[current.weather_code] || { d: '', i: '❓' };
            const tempSuffix = weatherSettings.units === 'metric' ? '°C' : '°F';
            container.innerHTML = `<div class="icon">${codeInfo.i}</div><div><div class="temp">${Math.round(current.temperature_2m)}${tempSuffix}</div><div class="condition">${codeInfo.d}</div></div>`;
            container.style.display = 'flex';
        } else {
            container.style.display = 'none';
        }
    }
    
    function setFullscreenCountdown(id){clearInterval(clockFsCountdownInterval);localStorage.setItem(getStorageKey('selectedDashboardCountdownId'),id);if(!id){clockFsCountdownName.textContent='';clockFsCountdownTimer.innerHTML='';return}const countdowns=JSON.parse(localStorage.getItem(getStorageKey('countdowns'))||'[]');const c=countdowns.find(cd=>cd.id===id);if(c){clockFsCountdownName.textContent=c.name;const u=()=>clockFsCountdownTimer.innerHTML=formatCountdown(c.targetTimestamp);u();clockFsCountdownInterval=setInterval(u,1000)}}
    
    function formatCountdown(targetDate) { const end=new Date(targetDate);let now=new Date();if(end<=now){clearInterval(clockFsCountdownInterval);clearInterval(window.dashboardCountdownInterval);return"🎉 Finished!"}const diff=end-now;const w=Math.floor(diff/604800000),d=Math.floor((diff%604800000)/86400000),h=Math.floor((diff%86400000)/3600000),m=Math.floor((diff%3600000)/60000),s=Math.floor((diff%60000)/1000);const u=[{v:w,l:'wks'},{v:d,l:'days'},{v:h,l:'hrs'},{v:m,l:'mins'},{v:s,l:'secs'}];const v=u.filter((unit,idx)=>u.slice(0,idx).reduce((acc,p)=>acc+p.v,0)+unit.v>0);return v.map(unit=>`<span class="time-unit">${unit.v}<span class="time-label">${unit.l}</span></span>`).join('')||`<span class="time-unit">0<span class="time-label">secs</span></span>`}
    
    function populateAndInitFullscreenCountdownDropdown() {
        const wrapper = document.getElementById('fullscreen-countdown-select-wrapper');
        const customOptions = wrapper.querySelector('.custom-options');
        const customSelectTrigger = wrapper.querySelector('.custom-select-trigger span');
        const countdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
        customOptions.innerHTML = '<span class="custom-option" data-value="">No Countdown</span>';
        const now = new Date();
        countdowns.filter(cd => new Date(cd.targetTimestamp) > now).sort((a, b) => new Date(a.targetTimestamp) - new Date(b.targetTimestamp)).forEach(cd => {
            const option = document.createElement('span'); option.className = 'custom-option'; option.dataset.value = cd.id; option.textContent = cd.name; customOptions.appendChild(option);
        });
        const savedId = localStorage.getItem(getStorageKey('selectedDashboardCountdownId'));
        const selectedOption = customOptions.querySelector(`.custom-option[data-value="${savedId}"]`) || customOptions.querySelector('.custom-option[data-value=""]');
        customOptions.querySelector('.selected')?.classList.remove('selected');
        selectedOption.classList.add('selected');
        customSelectTrigger.textContent = selectedOption.textContent;
        setFullscreenCountdown(savedId);
        initializeCustomSelect(wrapper, (value) => {
            setFullscreenCountdown(value);
        });
    }
    // --- END: FULLSCREEN LOGIC ---

    // --- START: WIDGET TEMPLATES & LOGIC ---
    const availableCardTemplates = [
      {
        templateId: 'time_weather_super_widget', title: 'Overview', icon: '🌐', type: 'full',
        onMount: async (cardElement) => {
            const timeEl = cardElement.querySelector('#clockTime');
            const dateEl = cardElement.querySelector('#clockDate');
            const dayOfYearEl = cardElement.querySelector('#clockDayOfYear');
            const weekNumEl = cardElement.querySelector('#clockWeekNum');
            const fullscreenBtn = cardElement.querySelector('.clock-fullscreen-btn');
            
            function updateClock() {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString();
                dateEl.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                const start = new Date(now.getFullYear(), 0, 0);
                const diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
                const oneDay = 1000 * 60 * 60 * 24;
                const dayOfYear = Math.floor(diff / oneDay);
                if (dayOfYearEl) dayOfYearEl.textContent = `Day: ${dayOfYear}`;

                const tempDate = new Date(now.valueOf());
                tempDate.setDate(tempDate.getDate() + 3 - (tempDate.getDay() + 6) % 7);
                const week1 = new Date(tempDate.getFullYear(), 0, 4);
                const weekNumber = 1 + Math.round(((tempDate.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
                if (weekNumEl) weekNumEl.textContent = `Week: ${weekNumber}`;
            }
            updateClock(); setInterval(updateClock, 1000);
            if (fullscreenBtn) fullscreenBtn.addEventListener('click', openClockFullscreen);

            const countdownNameEl = cardElement.querySelector('.dashboard-countdown-display-name');
            const countdownTimerEl = cardElement.querySelector('.dashboard-countdown-display-timer');
            const countdownSectionEl = cardElement.querySelector('.dashboard-countdown-section');
            const additionalInfoEl = cardElement.querySelector('.additional-time-info');
            window.dashboardCountdownInterval = null;

            function renderCountdownInDashboard(countdownId) {
                clearInterval(window.dashboardCountdownInterval);
                const countdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
                const countdown = countdowns.find(cd => cd.id === countdownId);
                
                if (!countdown || new Date(countdown.targetTimestamp) <= new Date()) {
                    countdownSectionEl.style.display = 'none';
                    additionalInfoEl.style.display = 'block';
                    return;
                }
                
                countdownSectionEl.style.display = 'block';
                additionalInfoEl.style.display = 'none';
                countdownNameEl.textContent = countdown.name;
                const update = () => { countdownTimerEl.innerHTML = formatCountdown(countdown.targetTimestamp); };
                update();
                window.dashboardCountdownInterval = setInterval(update, 1000);
            }

            window.updateDashboardCountdownDisplay = () => {
                const savedId = localStorage.getItem(getStorageKey('selectedDashboardCountdownId'));
                renderCountdownInDashboard(savedId);
            };
            window.updateDashboardCountdownDisplay();
            
            const refreshBtn = cardElement.querySelector('.weather-refresh-btn'), settingsBtn = cardElement.querySelector('.overview-settings-btn');
            window.renderWeatherErrorInDashboard = (message) => {
                const els = { c: cardElement.querySelector('.condition-large'), i: cardElement.querySelector('.weather-icon-large'), t: cardElement.querySelector('.temp-large'), f: cardElement.querySelector('.forecast-large') };
                if(els.c) els.c.textContent = message; if(els.i) els.i.textContent = '⚠️'; if(els.t) els.t.textContent = '--°'; if(els.f) els.f.innerHTML = `<p style="color:red;font-size:0.9em;">${message}</p>`;
            };
            window.renderWeatherInDashboard = (data) => {
                const {units, location} = weatherSettings; const tempS = units === 'metric' ? '°C' : '°F';
                const cw = data.current; const codeInfo = WMO_CODES[cw.weather_code] || {d: "Unknown", i: "❓"};
                cardElement.querySelector('.temp-large').textContent = `${Math.round(cw.temperature_2m)}${tempS}`;
                cardElement.querySelector('.weather-icon-large').textContent = codeInfo.i;
                cardElement.querySelector('.condition-large').textContent = codeInfo.d;
                cardElement.querySelector('.feels-like-value').textContent = `${Math.round(cw.apparent_temperature)}${tempS}`;
                cardElement.querySelector('.humidity-value').textContent = `${cw.relative_humidity_2m}%`;
                cardElement.querySelector('.wind-value').textContent = `${Math.round(cw.wind_speed_10m)} ${units === 'metric' ? 'km/h' : 'mph'}`;
                cardElement.querySelector('.location-large').textContent = location.label;
                const forecastEl = cardElement.querySelector('.forecast-large'); forecastEl.innerHTML = '';
                if (data.daily?.time?.length > 0) {
                    data.daily.time.forEach((dateStr, i) => {
                        const dayCodeInfo = WMO_CODES[data.daily.weather_code[i]] || { i: "❓" };
                        const dayDiv = document.createElement('div'); dayDiv.className = 'forecast-day'; dayDiv.addEventListener('click', () => {
                            openForecastModal({
                                dateStr, feelsLike: cw.apparent_temperature, humidity: cw.relative_humidity_2m,
                                weatherCode: data.daily.weather_code[i], tempMax: data.daily.temperature_2m_max[i], tempMin: data.daily.temperature_2m_min[i],
                                precipSum: data.daily.precipitation_sum?.[i], precipProb: data.daily.precipitation_probability_max?.[i], windSpeedMax: data.daily.wind_speed_10m_max?.[i],
                                sunrise: data.daily.sunrise?.[i], sunset: data.daily.sunset?.[i], daylightDuration: data.daily.daylight_duration?.[i], windDirection: data.daily.wind_direction_10m_dominant?.[i],
                                uvIndexMax: data.daily.uv_index_max?.[i]
                            });
                        });
                        const dayName = i === 0 ? "Today" : new Date(dateStr + 'T12:00:00Z').toLocaleDateString(undefined, { weekday: 'short', timeZone: 'UTC' });
                        dayDiv.innerHTML = `<span class="day-name">${dayName}</span><span class="icon">${dayCodeInfo.i}</span><span class="temps">${Math.round(data.daily.temperature_2m_max[i])}°/${Math.round(data.daily.temperature_2m_min[i])}°</span>`;
                        forecastEl.appendChild(dayDiv);
                    });
                }
                updateFullscreenWeatherDisplay();
            };
            async function initializeWeather() {
                await determineUserCountry(); const settingsLoaded = loadWeatherSettings();
                if (!settingsLoaded && navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (pos) => { userCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude }; const { label, country_code } = await fetchCityName(userCoords.lat, userCoords.lon); weatherSettings.location = { label, latitude: userCoords.lat, longitude: userCoords.lon }; weatherSettings.units = (country_code === 'us' || !country_code) ? 'imperial' : 'metric'; saveWeatherSettings(); await fetchWeather(); },
                        async () => { showNotification(`Could not find you. Defaulting to NY.`, 'info'); await fetchWeather(); }
                    );
                } else { await fetchWeather(); }
            }
            if (settingsBtn) settingsBtn.addEventListener('click', () => {
                const modal = document.getElementById('overviewSettingsModal');
                modal.classList.add('modal-open');
                populateAndInitOverviewCountdownDropdown();
                document.getElementById('overviewLocationInput').value = weatherSettings.location.label;
                document.getElementById('overviewUnitToggle').checked = weatherSettings.units === 'metric';
                document.querySelector(`input[name="dataSource"][value="${weatherSettings.dataSource}"]`).checked = true;
                document.getElementById('fullscreenWeatherToggle').checked = weatherSettings.showWeatherInFullscreen;
                window.updateNWSAvailability();
            });
            if (refreshBtn) refreshBtn.addEventListener('click', fetchWeather);
            initializeWeather(); setInterval(fetchWeather, 30 * 60 * 1000);
        }
      },
      {
        templateId: 'stopwatch_widget', title: 'Stopwatch', icon: '⏱️', type: 'small',
        onMount: (cardElement) => {
            const STORAGE_KEY = getStorageKey('stopwatchState_v4');
            const display = cardElement.querySelector('.stopwatch-display');
            const startBtn = cardElement.querySelector('button[data-action="start"]');
            const pauseBtn = cardElement.querySelector('button[data-action="pause"]');
            const resetBtn = cardElement.querySelector('button[data-action="reset"]');
            let state = { startTime: null, elapsedTime: 0, isRunning: false };
            let intervalId = null;
            function saveState() { const dataToSave = { elapsedTime: state.elapsedTime, isRunning: state.isRunning, startTime: state.isRunning ? state.startTime : null }; localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave)); }
            function formatTime(ms) { const totalSeconds = Math.floor(ms / 1000); const centiseconds = Math.floor((ms % 1000) / 10).toString().padStart(2, '0'); const hours = Math.floor(totalSeconds / 3600); const minutes = Math.floor((totalSeconds % 3600) / 60); const seconds = totalSeconds % 60; return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${centiseconds}`; }
            function updateDisplay() { const totalElapsed = state.elapsedTime + (state.isRunning ? (Date.now() - state.startTime) : 0); display.textContent = formatTime(totalElapsed); }
            function start() { if (state.isRunning) return; state.isRunning = true; state.startTime = Date.now(); startBtn.style.display = 'none'; pauseBtn.style.display = 'inline-block'; intervalId = setInterval(updateDisplay, 50); saveState(); }
            function pause() { if (!state.isRunning) return; clearInterval(intervalId); state.elapsedTime += Date.now() - state.startTime; state.isRunning = false; startBtn.style.display = 'inline-block'; pauseBtn.style.display = 'none'; saveState(); }
            function reset() { clearInterval(intervalId); state = { startTime: null, elapsedTime: 0, isRunning: false }; localStorage.removeItem(STORAGE_KEY); updateDisplay(); startBtn.style.display = 'inline-block'; pauseBtn.style.display = 'none'; }
            function loadState() { const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)); if (!saved) return; state.elapsedTime = saved.elapsedTime || 0; if (saved.isRunning && saved.startTime) { state.elapsedTime += Date.now() - saved.startTime; start(); } else { updateDisplay(); } }
            startBtn.addEventListener('click', start); pauseBtn.addEventListener('click', pause); resetBtn.addEventListener('click', reset);
            loadState();
        }
      },
      {
        templateId: 'timer_widget', title: 'Timer', icon: '⌛', type: 'small',
        onMount: (cardElement) => {
            const STORAGE_KEY = getStorageKey('timerState_v4');
            const inputs = ['w', 'd', 'h', 'm', 's'].map(id => cardElement.querySelector(`#timer-${id}`));
            const display = cardElement.querySelector('.timer-display-value');
            const inputsContainer = cardElement.querySelector('.timer-inputs');
            const startBtn = cardElement.querySelector('button[data-action="start"]');
            const pauseBtn = cardElement.querySelector('button[data-action="pause"]');
            const resetBtn = cardElement.querySelector('button[data-action="reset"]');
            let state = { targetTime: null, remainingTime: 0, isRunning: false };
            let intervalId = null;
            function formatTime(ms) { if (ms < 0) ms = 0; const s = Math.round(ms / 1000); const w = Math.floor(s / 604800); const d = Math.floor((s % 604800) / 86400); const h = Math.floor((s % 86400) / 3600); const m = Math.floor((s % 3600) / 60); const secs = s % 60; const p = (n) => String(n).padStart(2,'0'); if(w > 0) return `${w}:${p(d)}:${p(h)}:${p(m)}:${p(secs)}`; if(d > 0) return `${d}:${p(h)}:${p(m)}:${p(secs)}`; return `${p(h)}:${p(m)}:${p(secs)}`; }
            function updateDisplay() { const remaining = state.isRunning ? state.targetTime - Date.now() : state.remainingTime; display.textContent = formatTime(remaining); if (state.isRunning && remaining <= 0) finish(); }
            function updateFromInputs() { if (state.isRunning) return; const [w, d, h, m, s] = inputs.map(input => parseInt(input.value) || 0); state.remainingTime = (w * 604800 + d * 86400 + h * 3600 + m * 60 + s) * 1000; updateDisplay(); }
            function toggleUI(isRunning) { inputsContainer.classList.toggle('hidden', isRunning); startBtn.style.display = isRunning ? 'none' : 'inline-block'; pauseBtn.style.display = isRunning ? 'inline-block' : 'none'; }
            function start() { if (state.isRunning) return; if (state.remainingTime <= 0) { showNotification("Please set a timer duration.", "info"); return; } state.isRunning = true; state.targetTime = Date.now() + state.remainingTime; intervalId = setInterval(updateDisplay, 100); toggleUI(true); localStorage.setItem(STORAGE_KEY, JSON.stringify({ targetTime: state.targetTime })); }
            function pause() { if (!state.isRunning) return; clearInterval(intervalId); state.remainingTime = state.targetTime - Date.now(); state.isRunning = false; toggleUI(false); localStorage.setItem(STORAGE_KEY, JSON.stringify({ remainingTime: state.remainingTime })); }
            function reset() { clearInterval(intervalId); state.isRunning = false; toggleUI(false); inputs.forEach(input => input.value = '0'); updateFromInputs(); localStorage.removeItem(STORAGE_KEY); }
            function finish() { showNotification('Timer Finished!', 'success'); try { new Audio('https://interactive-examples.mdn.mozilla.net/media/cc0-audio/bell-ringing-01.mp3').play(); } catch(e) {} reset(); }
            function loadState() { const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)); if (!saved) { updateFromInputs(); return; }; if (saved.targetTime) { state.remainingTime = saved.targetTime - Date.now(); if (state.remainingTime > 0) start(); else reset(); } else if (saved.remainingTime) { state.remainingTime = saved.remainingTime; updateDisplay(); } }
            inputs.forEach(input => input.addEventListener('input', updateFromInputs));
            startBtn.addEventListener('click', start); pauseBtn.addEventListener('click', pause); resetBtn.addEventListener('click', reset);
            loadState();
        }
      },
      {
        templateId: 'quick_actions_widget', title: 'Shortcuts', icon: '⚡', type: 'small',
        onMount: (cardElement) => {
            const settingsBtn = cardElement.querySelector('.quick-actions-settings-btn');
            const contentContainer = cardElement.querySelector('.quick-actions-list');
            const renderAndAttachListeners = (actions) => {
                contentContainer.innerHTML = actions.map(action => `<button data-type="${action.type}" data-value="${action.value}"><span class="icon">${action.icon}</span><span class="text">${action.text}</span><span class="arrow">→</span></button>`).join('');
                contentContainer.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', () => { const { type, value } = btn.dataset; if (type === 'url') { window.open(value, '_blank'); } else if (type === 'page') { const page = pageSuggestions.find(p => p.url === value); if (page && page.action) { page.action(); } else { window.location.href = value; } } });
                });
            };
            const updateUI = () => { const saved = localStorage.getItem(getStorageKey('quickActions_v1')); currentQuickActions = saved ? JSON.parse(saved) : [...defaultQuickActions]; renderAndAttachListeners(currentQuickActions); };
            window.updateQuickActionsWidget = updateUI;
            updateUI();
            if (settingsBtn) { settingsBtn.addEventListener('click', () => { populateShortcutSettingsForm(); document.getElementById('shortcutSettingsModal').classList.add('modal-open'); }); }
        }
      }
    ];
    
    function getContentGenerator(templateId) {
        switch (templateId) {
            case 'time_weather_super_widget': return () => `
                <div class="super-widget-container">
                    <div class="super-widget-clock-section">
                        <div class="clock-display" id="clockTime">00:00:00</div>
                        <div class="date-display" id="clockDate"></div>
                        <div class="additional-time-info" style="display: none;">
                            <span id="clockDayOfYear">Day: ---</span> | <span id="clockWeekNum">Week: --</span>
                        </div>
                        <div class="dashboard-countdown-section">
                            <h4 class="dashboard-countdown-display-name"></h4>
                            <div class="dashboard-countdown-display-timer"></div>
                        </div>
                    </div>
                    <div class="super-widget-weather-section">
                        <div class="weather-large-content">
                            <div class="current-weather-layout">
                                <span class="weather-icon-large"></span> <div class="current-weather-main-info"> <span class="temp-large"></span> <span class="condition-large"></span> </div>
                                <div class="current-weather-details-aside"> <p>Feels like: <span class="feels-like-value"></span></p> <p>Humidity: <span class="humidity-value"></span></p> <p>Wind: <span class="wind-value"></span></p> <p>Location: <span class="location-large"></span></p> </div>
                            </div> <div class="forecast-large"></div>
                        </div>
                    </div>
                </div>`;
            case 'stopwatch_widget': return () => `<div class="stopwatch-display">00:00:00.00</div><div class="controls-flex"><button data-action="start">Start</button><button data-action="pause" style="display:none;">Pause</button><button data-action="reset">Reset</button></div>`;
            case 'timer_widget': return () => `<div class="timer-display-value">00:00:00</div><div class="timer-inputs"><input type="number" id="timer-w" placeholder="W" min="0" max="1" value="0">:<input type="number" id="timer-d" placeholder="D" min="0" max="6" value="0">:<input type="number" id="timer-h" placeholder="HH" min="0" max="23" value="0">:<input type="number" id="timer-m" placeholder="MM" min="0" max="59" value="0">:<input type="number" id="timer-s" placeholder="SS" min="0" max="59" value="0"></div><div class="controls-flex"><button data-action="start">Start</button><button data-action="pause" style="display:none;">Pause</button><button data-action="reset">Reset</button></div>`;
            case 'quick_actions_widget': return () => `<div class="quick-actions-list"></div>`;
            default: return () => '';
        }
    }
    
    function createCardDOMElement(t){const c=document.createElement('div');c.className='dashboard-card';c.dataset.templateId=t.templateId;c.dataset.cardType=t.type||'full';c.innerHTML=`<div class="card-header"><div class="card-icon">${t.icon}</div><h4 class="card-title">${t.title}</h4><div class="card-header-buttons"></div></div><div class="card-content-inner">${getContentGenerator(t.templateId)()}</div>`;const b=c.querySelector('.card-header-buttons');if(t.templateId==='time_weather_super_widget'){b.innerHTML=`<button class="weather-action-btn overview-settings-btn" title="Overview Settings"><img src="../images/gear-dark.png"></button><button class="weather-action-btn weather-refresh-btn" title="Refresh Weather"><img src="../images/refresh-dark.png"></button><button class="weather-action-btn clock-fullscreen-btn" title="Fullscreen Clock"><img src="../images/zoom-in-dark.png"></button>`}else if(t.templateId==='quick_actions_widget'){b.innerHTML=`<button class="weather-action-btn quick-actions-settings-btn" title="Edit Shortcuts"><img src="../images/gear-dark.png"></button>`}if(t.onMount){setTimeout(()=>{try{t.onMount(c)}catch(e){console.error(`Error onMount for ${t.templateId}:`,e);c.querySelector('.card-content-inner').innerHTML=`<p style="color:red;">Failed to load widget.</p>`}},0)}return c}
    function renderDashboardLayout(){const l=getDashboardLayout();dashboardGrid.innerHTML='';l.forEach(id=>{const t=availableCardTemplates.find(t=>t.templateId===id);if(t)dashboardGrid.appendChild(createCardDOMElement(t))});dashboardGrid.querySelectorAll('.dashboard-card').forEach((c,i)=>{c.style.animation='none';c.offsetHeight;c.style.animation=`fadeIn 0.4s ease-out ${i*0.05}s forwards`})}
    function getDashboardLayout(){const s=localStorage.getItem(dashboardLayoutStorageKey);if(s){try{const p=JSON.parse(s);if(Array.isArray(p)&&p.length>0)return p}catch(e){}}return[...defaultDashboardLayout]}
    function showNotification(message,type='info',duration=3000){const n=document.createElement('div');n.className=`notification ${type}`;n.textContent=message;Object.assign(n.style,{position:'fixed',bottom:'20px',right:'20px',padding:'12px 20px',borderRadius:'8px',color:'white',fontWeight:'600',zIndex:'10000',transform:'translateY(150%)',transition:'transform 0.4s ease-in-out',background:type==='success'?'linear-gradient(135deg,#28a745,#20c997)':type==='error'?'linear-gradient(135deg,#dc3545,#e83e8c)':'linear-gradient(135deg,#6720bd,#8a2be2)'});document.body.appendChild(n);setTimeout(()=>{n.style.transform='translateY(0)'},100);setTimeout(()=>{n.style.transform='translateY(150%)';setTimeout(()=>{if(document.body.contains(n))document.body.removeChild(n)},400)},duration)}

    // --- CUSTOM SELECT DROPDOWN LOGIC ---
    function initializeCustomSelect(wrapper, onChangeCallback) {
        const select = wrapper.querySelector('.custom-select');
        const trigger = select.querySelector('.custom-select-trigger');
        const optionsContainer = select.querySelector('.custom-options');

        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            select.classList.toggle('open');
        });

        optionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('custom-option')) {
                const option = e.target;
                const value = option.dataset.value;
                const text = option.textContent;

                optionsContainer.querySelector('.selected')?.classList.remove('selected');
                option.classList.add('selected');
                trigger.querySelector('span').textContent = text;
                select.classList.remove('open');

                if (onChangeCallback) {
                    onChangeCallback(value);
                }
            }
        });
    }
    
    document.addEventListener('click', () => {
        document.querySelectorAll('.custom-select.open').forEach(select => select.classList.remove('open'));
    });

    // --- OVERVIEW SETTINGS COUNTDOWN LOGIC ---
    function populateAndInitOverviewCountdownDropdown() {
        const wrapper = document.getElementById('overview-countdown-select-wrapper');
        const optionsContainer = wrapper.querySelector('.custom-options');
        const triggerSpan = wrapper.querySelector('.custom-select-trigger span');
        
        optionsContainer.innerHTML = '<span class="custom-option" data-value="">-- None --</span>';
        
        const countdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
        countdowns.filter(cd => new Date(cd.targetTimestamp) > new Date()).forEach(cd => {
            const opt = document.createElement('span');
            opt.className = 'custom-option';
            opt.dataset.value = cd.id;
            opt.textContent = cd.name;
            optionsContainer.appendChild(opt);
        });

        const savedId = localStorage.getItem(getStorageKey('selectedDashboardCountdownId')) || '';
        const selectedOption = optionsContainer.querySelector(`.custom-option[data-value="${savedId}"]`) || optionsContainer.querySelector('.custom-option[data-value=""]');
        
        if (selectedOption) {
            selectedOption.classList.add('selected');
            triggerSpan.textContent = selectedOption.textContent;
        }

        initializeCustomSelect(wrapper, (value) => {
            localStorage.setItem(getStorageKey('selectedDashboardCountdownId'), value);
            if(window.updateDashboardCountdownDisplay) window.updateDashboardCountdownDisplay();
        });
    }

    // --- SHORTCUTS SETTINGS LOGIC ---
    function populateShortcutSettingsForm() {
        const form = document.getElementById('shortcutSettingsForm');
        form.innerHTML = '';
        currentQuickActions.forEach((action, index) => {
            const group = document.createElement('div');
            group.className = 'shortcut-editor-group';
            group.innerHTML = `
                <h4>Shortcut ${index + 1}</h4>
                <div class="shortcut-input-row">
                    <label>Icon</label>
                    <input type="text" class="shortcut-emoji-input" value="${action.icon}" maxlength="2">
                    <label>Name</label>
                    <input type="text" class="shortcut-name-input" value="${action.text}">
                </div>
                <div class="shortcut-input-row">
                    <label>Action Type</label>
                    <select class="shortcut-action-type-select">
                        <option value="url" ${action.type === 'url' ? 'selected' : ''}>Go to URL</option>
                        <option value="page" ${action.type === 'page' ? 'selected' : ''}>Go to Page</option>
                    </select>
                </div>
                <div class="shortcut-input-row action-target-wrapper">
                    <label class="url-label ${action.type !== 'url' ? 'hidden' : ''}">URL</label>
                    <input type="url" class="shortcut-url-input ${action.type !== 'url' ? 'hidden' : ''}" value="${action.type === 'url' ? action.value : 'https://'}" placeholder="https://example.com">
                    <label class="page-label ${action.type !== 'page' ? 'hidden' : ''}">Page</label>
                    <select class="shortcut-page-select ${action.type !== 'page' ? 'hidden' : ''}">
                        ${pageSuggestions.map(p => `<option value="${p.url}" ${action.type === 'page' && action.value === p.url ? 'selected' : ''}>${p.name}</option>`).join('')}
                    </select>
                </div>
            `;
            form.appendChild(group);
        });
        
        form.querySelectorAll('.shortcut-action-type-select').forEach(select => {
            select.addEventListener('change', (e) => {
                const wrapper = e.target.closest('.shortcut-editor-group').querySelector('.action-target-wrapper');
                const isUrl = e.target.value === 'url';
                wrapper.querySelector('.url-label').classList.toggle('hidden', !isUrl);
                wrapper.querySelector('.shortcut-url-input').classList.toggle('hidden', !isUrl);
                wrapper.querySelector('.page-label').classList.toggle('hidden', isUrl);
                wrapper.querySelector('.shortcut-page-select').classList.toggle('hidden', isUrl);
            });
        });
    }
    function saveShortcutSettings() {
        const newActions = [];
        const form = document.getElementById('shortcutSettingsForm');
        form.querySelectorAll('.shortcut-editor-group').forEach(group => {
            const type = group.querySelector('.shortcut-action-type-select').value;
            const value = type === 'url'
                ? group.querySelector('.shortcut-url-input').value
                : group.querySelector('.shortcut-page-select').value;
            
            newActions.push({
                icon: group.querySelector('.shortcut-emoji-input').value,
                text: group.querySelector('.shortcut-name-input').value,
                type: type,
                value: value
            });
        });
        localStorage.setItem(getStorageKey('quickActions_v1'), JSON.stringify(newActions));
        currentQuickActions = newActions;
        window.updateQuickActionsWidget();
        document.getElementById('shortcutSettingsModal').classList.remove('modal-open');
        showNotification("Shortcuts saved!", "success");
    }
    function resetShortcutSettings() {
        localStorage.removeItem(getStorageKey('quickActions_v1'));
        currentQuickActions = [...defaultQuickActions];
        populateShortcutSettingsForm();
        showNotification("Shortcuts reset to default.", "info");
    }

    // --- LOCATION HELPER FUNCTIONS ---
    function getShortLocationLabel(address, fullDisplayName) {
        if (!address) return fullDisplayName;
        const city = address.city || address.town || address.village || address.hamlet;
        if (address.road && city) { return `${address.road}, ${city}`; }
        if (city && address.state) { return `${city}, ${address.state}`; }
        if (city && address.country) { return `${city}, ${address.country}`; }
        if (city) { return city; }
        return fullDisplayName;
    }

    async function fetchCityName(lat, lon) {
        const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
        const fallbackLabel = `Lat: ${parseFloat(lat).toFixed(2)}, Lon: ${parseFloat(lon).toFixed(2)}`;
        try {
            const response = await fetch(nominatimUrl);
            if (!response.ok) {
                console.warn(`Nominatim API error: ${response.status}`);
                return { label: fallbackLabel, country_code: 'us' };
            }
            const data = await response.json();
            if (data && data.address) {
                const label = getShortLocationLabel(data.address, data.display_name);
                return { label, country_code: data.address.country_code || 'us' };
            }
            return { label: fallbackLabel, country_code: 'us' };
        } catch (error) {
            console.error("Error fetching city name:", error);
            return { label: fallbackLabel, country_code: 'us' };
        }
    }


    document.addEventListener('DOMContentLoaded', () => {
        firebase.auth().onAuthStateChanged(user => { if (!user) location.href = '../login.html'; else renderDashboardLayout(); });
        document.getElementById('logoutBtn').addEventListener('click', () => firebase.auth().signOut());
        document.getElementById('signOutLink').addEventListener('click', (e) => { e.preventDefault(); firebase.auth().signOut(); });
        document.getElementById('toggleSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
        
        const allModals = document.querySelectorAll('.modal');
        allModals.forEach(modal => {
            const closeBtn = modal.querySelector('.modal-close-btn');
            const isSettingsModal = modal.id === 'overviewSettingsModal';
            const closeModal = () => {
                modal.classList.remove('modal-open');
                if(isSettingsModal) fetchWeather();
            };
            if(closeBtn) closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });
        });

        const dateTimePicker = flatpickr("#newCountdownDateTime", { enableTime: true, dateFormat: "Y-m-d H:i", minDate: "today" });
        document.getElementById('saveNewCountdownBtn').addEventListener('click', () => { const name = document.getElementById('newCountdownName').value.trim(); const dateTime = dateTimePicker.selectedDates[0]; if (!name || !dateTime) { showNotification("Please provide a name and a future date.", "error"); return; } const newCountdown = { id: `cd_${Date.now()}`, name, targetTimestamp: dateTime.toISOString() }; const key = getStorageKey('countdowns'); const countdowns = JSON.parse(localStorage.getItem(key) || '[]'); countdowns.push(newCountdown); localStorage.setItem(key, JSON.stringify(countdowns)); showNotification("Countdown saved!", "success"); document.getElementById('newCountdownModal').classList.remove('modal-open'); document.getElementById('newCountdownName').value = ''; dateTimePicker.clear(); if (window.updateDashboardCountdownDisplay) window.updateDashboardCountdownDisplay(); if(window.populateAndInitOverviewCountdownDropdown) populateAndInitOverviewCountdownDropdown(); });
        
        // Shortcut Modal Buttons
        document.getElementById('saveShortcutsBtn').addEventListener('click', saveShortcutSettings);
        document.getElementById('resetShortcutsBtn').addEventListener('click', resetShortcutSettings);

        const wLocInput = document.getElementById('overviewLocationInput'), wLocSuggest = document.getElementById('overviewLocationSuggestions'), unitToggle = document.getElementById('overviewUnitToggle'), useCurrentBtn = document.getElementById('overviewUseCurrentLocationBtn'); let debounceTimer;
        wLocInput.addEventListener('keyup', (e) => { clearTimeout(debounceTimer); const q = e.target.value; if (q.length < 3) { wLocSuggest.style.display = 'none'; return; } debounceTimer = setTimeout(() => fetchLocationSuggestions(q), 500); });
        
        useCurrentBtn.addEventListener('click', async () => {
            if (!navigator.geolocation) {
                showNotification("Geolocation is not supported by your browser.", "error");
                return;
            }
            useCurrentBtn.disabled = true;
            useCurrentBtn.textContent = 'Locating...';
            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                userCoords = { lat: latitude, lon: longitude }; // Store for suggestions
                const { label } = await fetchCityName(latitude, longitude);
                weatherSettings.location = { label, latitude, longitude };
                wLocInput.value = label;
                saveWeatherSettings();
                showNotification(`Location updated to ${label}`, 'success');
                useCurrentBtn.disabled = false;
                useCurrentBtn.textContent = '📍 Use My Current Location';
                // Automatically close modal and refresh weather after successful location get
                document.getElementById('overviewSettingsModal').classList.remove('modal-open');
                fetchWeather();
            }, (error) => {
                console.error("Geolocation error:", error);
                showNotification("Could not get location. Please enable location services.", "error");
                useCurrentBtn.disabled = false;
                useCurrentBtn.textContent = '📍 Use My Current Location';
            }, { timeout: 10000 }); // <-- Added 10-second timeout
        });

        async function fetchLocationSuggestions(query) {
            let url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`;
            if (userCoords) {
                const R = 6371; const d = 250;
                const latRad = userCoords.lat * (Math.PI / 180);
                const lonRad = userCoords.lon * (Math.PI / 180);
                const lat1 = 180 / Math.PI * (latRad - (d/R)); const lat2 = 180 / Math.PI * (latRad + (d/R));
                const lon1 = 180 / Math.PI * (lonRad - Math.asin(d/R) / Math.cos(latRad)); const lon2 = 180 / Math.PI * (lonRad + Math.asin(d/R) / Math.cos(latRad));
                url += `&viewbox=${lon1},${lat2},${lon2},${lat1}&bounded=1`;
            }
            try {
                const r = await fetch(url); const d = await r.json();
                wLocSuggest.innerHTML = '';
                if (d.length > 0) {
                    wLocSuggest.style.display = 'block';
                    d.forEach(p => {
                        const shortLabel = getShortLocationLabel(p.address, p.display_name);
                        const li = document.createElement('li');
                        li.textContent = shortLabel;
                        li.addEventListener('click', () => {
                            weatherSettings.location = { label: shortLabel, latitude: parseFloat(p.lat), longitude: parseFloat(p.lon) };
                            wLocInput.value = shortLabel;
                            wLocSuggest.style.display = 'none';
                            saveWeatherSettings();
                            // Automatically close modal and refresh weather after selection
                            document.getElementById('overviewSettingsModal').classList.remove('modal-open');
                            fetchWeather();
                        });
                        wLocSuggest.appendChild(li);
                    });
                } else {
                     wLocSuggest.style.display = 'none';
                }
            } catch (e) { console.error("Failed to fetch location suggestions:", e); }
        }

        unitToggle.addEventListener('change', () => { weatherSettings.units = unitToggle.checked ? 'metric' : 'imperial'; saveWeatherSettings(); });
        document.querySelectorAll('input[name="dataSource"]').forEach(r => {r.addEventListener('change', (e) => { weatherSettings.dataSource = e.target.value; saveWeatherSettings(); window.updateNWSAvailability(); })});
        window.updateNWSAvailability = function(isUS = userCountry === 'US') { const nR = document.getElementById('sourceNWS'); const nN = document.getElementById('nwsApiNote'); if (isUS) { nR.disabled = false; nN.style.display = 'none'; } else { if (weatherSettings.dataSource === 'nws') { weatherSettings.dataSource = 'open-meteo'; saveWeatherSettings(); document.getElementById('sourceOpenMeteo').checked = true; } nR.disabled = true; nN.style.display = 'block'; }};
        const fsWeatherToggle = document.getElementById('fullscreenWeatherToggle'); fsWeatherToggle.addEventListener('change', () => { weatherSettings.showWeatherInFullscreen = fsWeatherToggle.checked; saveWeatherSettings(); updateFullscreenWeatherDisplay(); });
        
        // Fullscreen Color Picker Logic
        const colorToggle = document.getElementById('clock-fs-color-toggle');
        const colorPalette = document.getElementById('clock-fs-color-palette');
        const colorPickerInput = document.getElementById('color-picker-input');

        colorToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            colorPalette.classList.toggle('visible');
        });
        document.addEventListener('click', (e) => {
            if (!colorPalette.contains(e.target) && !colorToggle.contains(e.target)) {
                colorPalette.classList.remove('visible');
            }
        });
        colorPalette.addEventListener('click', (e) => {
            if(e.target.classList.contains('color-swatch') && !e.target.classList.contains('color-swatch-custom')) {
                const color = e.target.dataset.color;
                document.getElementById('clock-fullscreen-overlay').style.background = color;
                localStorage.setItem(getStorageKey('clockFsColor'), color);
            }
        });
        document.querySelector('.color-swatch-custom').addEventListener('click', () => colorPickerInput.click());
        colorPickerInput.addEventListener('input', (e) => {
            const color = e.target.value;
            document.getElementById('clock-fullscreen-overlay').style.background = color;
            localStorage.setItem(getStorageKey('clockFsColor'), color);
        });
    });
  </script>
</body>
</html>
