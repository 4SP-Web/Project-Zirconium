<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - SOUNDBOARD (Full Featured)</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <style>
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
        }
        body {
            display: flex; flex-direction: column; min-height: 100vh;
            margin: 0; font-family: var(--v4-font-primary);
            background: var(--v4-bg-gradient); color: var(--v4-text-primary);
            line-height: 1.6;
        }
        .soundboard-container-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar {
            width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff; padding: 20px 10px; display: flex; flex-direction: column;
            border-right: 1px solid #444; transition: width 0.5s ease-in-out;
            position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: none; border: none; color: #fff; font-size: 1.2em;
            cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out;
        }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: visible; }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em; }
        .marquee-content { display: inline-block; padding-left: 100%; transform: translateX(0); animation: none; line-height: 1.8em; }
        .marquee-active { animation: scroll-left-soundboard 12s linear infinite; }
        @keyframes scroll-left-soundboard { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .user-info .username { font-family: var(--v4-font-primary); font-size: 1.3em; margin-bottom: 8px; line-height: 0.2em; font-weight: bold;}
        .user-info .email { font-family: var(--v4-font-secondary); font-size: 0.9em; color: #bbb; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a {
            display: flex; align-items: center; padding: 12px 15px; color: #fff;
            text-decoration: none; border-radius: 8px; transition: all 0.3s ease;
            font-family: var(--v4-font-primary); text-transform: uppercase;
            position: relative; overflow: hidden; font-size: 1em;
        }
        .sidebar nav a:hover, .sidebar nav a.active { background: var(--v4-purple-gradient); transform: translateX(5px); color: #fff; }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .sidebar.collapsed nav a .label { display: none; }
        .main-soundboard-content {
            flex: 1; padding: 30px; background: var(--v4-bg-gradient);
            overflow-y: auto; display: flex; flex-direction: column; padding-bottom: 120px;
        }
        .soundboard-header-v4 {
            margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .soundboard-title-v4 {
            font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .settings-header { display: flex; flex-direction: column; padding: 0 15px; border-bottom: 1px solid var(--v4-border-softer); }
        .settings-top-row { display: flex; justify-content: space-between; align-items: center; width: 100%;}
        .settings-tab-container {
            background: var(--v4-card-bg); border-radius: 15px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.08); margin-bottom: 25px;
            overflow: visible;
        }
        nav.settings-tabs { display: flex; flex-wrap: wrap; }
        .tab-link {
            background: none; border: none; padding: 15px 20px; cursor: pointer;
            font-size: 1.1em; font-family: var(--v4-font-primary); color: var(--v4-text-secondary);
            border-bottom: 3px solid transparent; margin-bottom: -1px; transition: all 0.2s ease-in-out;
        }
        .tab-link.active, .tab-link:hover { color: var(--v4-purple-accent); }
        .tab-link.active { border-bottom-color: var(--v4-purple-accent); font-weight: bold; }
        #resetSettingsBtn {
            background: none; border: 1px solid var(--v4-border-light); color: var(--v4-text-secondary);
            font-size: 0.8em; padding: 5px 10px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;
            font-family: var(--v4-font-secondary); white-space: nowrap;
        }
        #resetSettingsBtn:hover { border-color: var(--v4-purple-accent); }
        #settingsSearch {
            width: 100%;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 20px;
            border: 1px solid var(--v4-border-light);
            font-family: var(--v4-font-secondary);
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #settingsSearch:focus {
            border-color: var(--v4-purple-accent);
            box-shadow: 0 0 0 2px rgba(103, 32, 189, 0.2);
        }
        .tab-content {
            display: none;
            padding: 15px 25px 25px 25px;
            gap: 15px 25px;
            overflow: visible;
        }
        .tab-content.active {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        #effects.active {
             grid-template-columns: 1fr 1fr;
        }
        .control-group { display: flex; flex-direction: column; margin-bottom: 10px; transition: opacity 0.3s ease; border-radius: 8px; }
        .control-group.hidden-by-search { display: none; }
        .control-group.highlight {
            box-shadow: 0 0 0 2px var(--v4-purple-accent);
            transition: box-shadow 0.1s ease-in-out;
        }
        .control-group.disabled { opacity: 0.4; pointer-events: none; }
        .control-group label, .checkbox-label-v4 { font-family: var(--v4-font-secondary); font-size: 0.9em; color: var(--v4-text-secondary); margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        .control-group input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--v4-border-light); outline: none; border-radius: 5px; margin-top: 5px; }
        .control-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--v4-purple-accent); cursor: pointer; border-radius: 50%; }
        .control-group input[type="number"], .control-group select, .control-group input[type="text"] { width: 100%; padding: 10px 12px; background-color: var(--v4-input-bg); border: 1px solid var(--v4-input-border); border-radius: 6px; color: var(--v4-text-primary); font-family: var(--v4-font-secondary); font-size: 0.95em; outline: none; box-sizing: border-box; }
        .checkbox-label-v4 { padding: 8px 0; }
        .control-group input[type="checkbox"] { margin-left: 12px; transform: scale(1.1); accent-color: var(--v4-purple-accent); }
        .device-display {
            background-color: var(--v4-input-bg);
            border: 1px solid var(--v4-border-light);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.85em;
            color: var(--v4-text-secondary);
        }
        #searchResultsContainer {
            display: none;
            max-height: 350px;
            overflow-y: auto;
            padding: 0 25px 25px 25px;
        }
        #searchResultsContainer::-webkit-scrollbar {
            width: 8px;
        }
        #searchResultsContainer::-webkit-scrollbar-track {
            background: var(--v4-input-bg);
            border-radius: 4px;
        }
        #searchResultsContainer::-webkit-scrollbar-thumb {
            background-color: var(--v4-border-light);
            border-radius: 4px;
        }
        #searchResultsContainer::-webkit-scrollbar-thumb:hover {
            background-color: var(--v4-text-secondary);
        }
        #searchResultsContainer .search-result-item {
            padding: 12px;
            border-bottom: 1px solid var(--v4-border-softer);
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #searchResultsContainer .search-result-item:hover {
            background-color: var(--v4-input-bg);
        }
        .search-result-category {
            font-size: 0.8em;
            text-transform: uppercase;
            color: var(--v4-text-secondary);
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
        }
        #mic-permission-prompt {
            padding: 15px;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            text-align: center;
            grid-column: 1 / -1; /* Span across all columns */
        }
        #mic-permission-prompt button {
            margin-top: 10px;
            padding: 8px 15px;
        }
        .sound-category-v4 { margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); }
        .sound-category-v4 h2 { font-size: 1.5em; color: var(--v4-text-primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--v4-border-softer); text-transform: uppercase; }
        .sound-buttons-grid-v4 { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .sound-button-v4 {
            background-color: var(--v4-input-bg); color: var(--v4-text-secondary); border: 1px solid var(--v4-input-border);
            padding: 8px 12px; font-size: 1em; text-align: center; cursor: pointer;
            transition: all 0.2s ease; text-transform: uppercase;
            font-family: var(--v4-font-primary);
            border-radius: 12px;
        }
        .sound-button-v4:hover { background-color: #e9ecef; border-color: var(--v4-purple-accent); color: var(--v4-purple-accent); transform: translateY(-2px); }
        .sound-button-v4.playing { background-color: var(--v4-purple-accent); color: white; border: 2px solid var(--v4-purple-accent-darker); }
        .sound-button-v4.pulsating { animation: pulsePlayingSoundboardV4 1.5s infinite; }
        @keyframes pulsePlayingSoundboardV4 { 0% { box-shadow: 0 0 0 0px var(--v4-purple-accent); } 100% { box-shadow: 0 0 0 8px rgba(103, 32, 189, 0); } }
        #bottom-fixed-bar {
            position: fixed; bottom: 20px; right: 20px; z-index: 1001; display: flex; align-items: center; gap: 15px; padding: 15px;
            background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px) saturate(1.5); -webkit-backdrop-filter: blur(10px) saturate(1.5);
            border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
        }
        #bottom-fixed-bar input[type="text"] {
            background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.6);
            color: var(--v4-text-primary); padding: 8px 5px; width: 200px; font-size: 1em; outline: none;
            font-family: var(--v4-font-secondary);
        }
        #clearSoundsBtn {
            padding: 10px 18px; background: rgba(220, 53, 69, 0.7); color: white;
            border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer;
            font-size: 0.95em; text-transform: uppercase; transition: all 0.25s ease;
            font-family: var(--v4-font-primary);
        }
        #clearSoundsBtn:hover { background: rgba(200, 35, 51, 0.9); transform: translateY(-1px); }
        .status-message-v4 { display: none; padding: 15px 25px; margin: 0 auto 20px auto; border-radius: 12px; text-align: center; max-width: 600px; text-transform: uppercase; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); color: white; }
        .status-message-v4.success { background: linear-gradient(135deg, #1c7430, #155724); }
        .status-message-v4.error { background: linear-gradient(135deg, #8f262a, #721c24); }
        .status-message-v4.info { background: linear-gradient(135deg, #004085, #002752); }
    </style>
</head>
<body class="soundboard-page">

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="soundboard-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <div class="user-info">
                <div class="marquee-container"> <span id="userName" class="marquee-content username">Loading…</span> </div>
                <div class="marquee-container"> <span id="userEmail" class="marquee-content email">Loading…</span> </div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">🛡️</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html" class="active"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="others.html"><span class="icon">✨</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-soundboard-content">
            <div class="soundboard-header-v4"> <h2 class="soundboard-title-v4">Soundboard</h2> </div>
            <div class="status-message-v4" id="statusMessageV4"></div>

            <div class="settings-tab-container">
                <div class="settings-header">
                     <div class="settings-top-row">
                        <nav class="settings-tabs">
                            <button class="tab-link active" data-tab="playback">Playback</button>
                            <button class="tab-link" data-tab="effects">Effects</button>
                            <button class="tab-link" data-tab="modes">Audio Modes</button>
                            <button class="tab-link" data-tab="autoclicker">Autoclicker</button>
                        </nav>
                        <button id="resetSettingsBtn">Reset Settings</button>
                    </div>
                     <input type="text" id="settingsSearch" placeholder="Search settings...">
                </div>
                
                <div id="searchResultsContainer"></div>

                <div id="playback" class="tab-content active">
                     <div class="control-group" data-search-terms="allow multiple sounds">
                        <label class="checkbox-label-v4">Allow Multiple Sounds <input type="checkbox" id="allowMultipleSounds" data-setting="allowMultiple"></label>
                     </div>
                     <div class="control-group" data-search-terms="sound looping">
                        <label class="checkbox-label-v4">Sound Looping <input type="checkbox" id="soundLooping" data-setting="looping"></label>
                     </div>
                     <div class="control-group" data-search-terms="master volume">
                        <label>Master Volume: <span id="masterVolumeValue">100%</span></label>
                        <input type="range" id="masterVolume" min="0" max="1" step="0.01" value="1" data-setting="masterVolume">
                    </div>
                     <div class="control-group" data-search-terms="audio output device speakers headphones">
                         <label for="playbackDevice">Audio Output Device</label>
                         <select id="playbackDevice" data-setting="playbackDevice"></select>
                         <div class="device-display">Currently Using: <strong id="currentOutputDevice">Default</strong></div>
                    </div>
                    <div class="control-group" data-search-terms="input microphone mic airpods">
                        <label for="microphoneDevice">Input Microphone</label>
                        <select id="microphoneDevice" data-setting="microphoneDevice"></select>
                         <div class="device-display">Currently Using: <strong id="currentInputDevice">Default</strong></div>
                    </div>
                </div>

                <div id="effects" class="tab-content">
                    <div class="control-group" data-search-terms="fade in">
                         <label for="fadeIn">Fade In (sec): <span id="fadeInValue">0.1s</span></label>
                         <input type="range" id="fadeIn" min="0" max="5" step="0.1" value="0.1" data-setting="fadeIn">
                    </div>
                     <div class="control-group" data-search-terms="fade out">
                         <label for="fadeOut">Fade Out (sec): <span id="fadeOutValue">0.1s</span></label>
                         <input type="range" id="fadeOut" min="0" max="5" step="0.1" value="0.1" data-setting="fadeOut">
                    </div>
                    <div class="control-group" data-search-terms="speed rate tempo">
                        <label for="speed">Speed: <span id="speedValue">1.00x</span></label>
                        <input type="range" id="speed" min="0.25" max="4" step="0.01" value="1" data-setting="speed">
                    </div>
                    <div class="control-group" data-search-terms="auto-pitch correction autotune vocals">
                        <label for="pitchCorrection">Auto-Pitch Correction</label>
                        <input type="range" id="pitchCorrection" min="0" max="1" step="0.01" value="0" data-setting="pitchCorrection">
                    </div>
                </div>

                <div id="modes" class="tab-content">
                    <div class="control-group" data-search-terms="spatial audio apple music 3d">
                        <label class="checkbox-label-v4">Spatial Audio <input type="checkbox" data-setting="modeSpatial"></label>
                    </div>
                     <div class="control-group" data-search-terms="binaural audio headphones 3d">
                        <label class="checkbox-label-v4">Binaural Audio (Headphones) <input type="checkbox" data-setting="modeBinaural"></label>
                    </div>
                     <div class="control-group" data-search-terms="vocal boost voice clarity">
                        <label class="checkbox-label-v4">Vocal Boost <input type="checkbox" data-setting="modeVocalBoost"></label>
                    </div>
                     <div class="control-group" data-search-terms="party mode echo bass boost">
                        <label class="checkbox-label-v4">Party Mode <input type="checkbox" data-setting="modeParty"></label>
                    </div>
                     <div class="control-group" data-search-terms="dynamic volume smart quiet loud">
                        <label class="checkbox-label-v4">Dynamic Volume <input type="checkbox" data-setting="modeDynamic"></label>
                    </div>
                     <div class="control-group" data-search-terms="stable volume normalize compression">
                        <label class="checkbox-label-v4">Stable Volume (Normalize) <input type="checkbox" data-setting="modeStable"></label>
                    </div>
                     <div class="control-group" data-search-terms="conversation awareness ducking">
                        <label class="checkbox-label-v4">Conversation Awareness <input type="checkbox" data-setting="modeAwareness"></label>
                     </div>
                      <div class="control-group" data-search-terms="night mode quiet listening">
                         <label class="checkbox-label-v4">Night Mode <input type="checkbox" data-setting="modeNight"></label>
                     </div>
                    <div id="mic-permission-prompt" style="display: none;">
                        <p>Advanced modes require microphone access.</p>
                        <button id="enable-mic-btn" class="btn">Enable Microphone</button>
                    </div>
                </div>

                <div id="autoclicker" class="tab-content">
                    <div class="control-group" data-search-terms="autoclicker enable">
                         <label class="checkbox-label-v4">Enable Autoclicker <input type="checkbox" id="autoclickerEnabled" data-setting="autoclickerEnabled"></label>
                    </div>
                    <div class="control-group" data-search-terms="autoclicker interval speed">
                        <label for="clickInterval">Click Interval (ms)</label>
                        <input type="number" id="clickInterval" value="200" min="50" data-setting="clickInterval">
                    </div>
                     <div class="control-group" data-search-terms="autoclicker click type single double">
                        <label for="clickType">Click Type</label>
                        <select id="clickType" data-setting="clickType">
                            <option value="single">Single</option>
                            <option value="double">Double</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="soundCategoriesContainerV4"> <p>Loading sounds...</p> </div>
        </main>
    </div>

    <div id="bottom-fixed-bar">
        <input type="text" id="soundSearchInput" placeholder="Search sounds...">
        <button id="clearSoundsBtn">Clear Sounds</button>
    </div>

    <script>
    // --- Standard Setup (Auth, Sidebar, User Info) ---
    const dbRef_ = () => firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid);
    const marqueeEls_ = document.querySelectorAll('.marquee-content');
    firebase.auth().onAuthStateChanged(async user => {
        if (!user) { window.location.href = '../login.html'; }
        else {
            const userEmailEl = document.getElementById('userEmail');
            const userNameEl = document.getElementById('userName');
            if (userEmailEl) userEmailEl.textContent = user.email;
            if (userNameEl) {
                try {
                    const doc = await dbRef_().get();
                    userNameEl.textContent = (doc.exists && doc.data().username) ? doc.data().username : (user.displayName || 'User');
                } catch (error) { userNameEl.textContent = 'User'; console.error("Error fetching username:", error); }
            }
            updateMarquees_();
        }
    });
    document.getElementById('logoutBtn')?.addEventListener('click', () => { firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
    document.getElementById('signOutLink')?.addEventListener('click', (e) => { e.preventDefault(); firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
    const sidebar_ = document.getElementById('sidebar');
    const toggleSidebarBtn_ = document.getElementById('toggleSidebar');
    if (toggleSidebarBtn_ && sidebar_) { toggleSidebarBtn_.addEventListener('click', () => { sidebar_.classList.toggle('collapsed'); setTimeout(updateMarquees_, 550); }); }
    function updateMarquees_() {
        marqueeEls_.forEach(el => {
            if (!el || !el.parentElement) return;
            const parent = el.parentElement; const overflow = el.scrollWidth > parent.clientWidth;
            const shouldScroll = sidebar_.classList.contains('collapsed') || (overflow && !sidebar_.classList.contains('collapsed'));
            el.classList.toggle('marquee-active', shouldScroll);
            if (!overflow && !sidebar_.classList.contains('collapsed')) { el.classList.remove('marquee-active'); }
        });
    }
    window.addEventListener('resize', updateMarquees_);
    // --- End Standard Setup ---

    // --- Soundboard Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const LOCAL_STORAGE_KEY = 'soundboardSettingsV5';
        
        let activeSounds = new Map();
        
        const masterGain = audioContext.createGain();
        const finalCompressor = new DynamicsCompressorNode(audioContext);
        const inputGain = audioContext.createGain();

        const nodes = {
            spatial: { input: audioContext.createGain(), convolver: audioContext.createConvolver(), output: audioContext.createGain() },
            binaural: { input: audioContext.createGain(), panner: new StereoPannerNode(audioContext, { pan: -0.5 }), delay: new DelayNode(audioContext, { delayTime: 0.005 }), output: audioContext.createGain() },
            party: { compressor: new DynamicsCompressorNode(audioContext, {threshold: -100, ratio: 1}), bassBoost: new BiquadFilterNode(audioContext, {type: 'lowshelf', frequency: 200, gain: 0}) },
            vocalBoost: new BiquadFilterNode(audioContext, {type: 'peaking', frequency: 2500, Q: 1.5, gain: 0}),
            nightMode: audioContext.createGain(),
            stableVolume: new DynamicsCompressorNode(audioContext, {threshold: -100, ratio: 1}),
            dynamicGain: audioContext.createGain(),
        };

        const dryBus = audioContext.createGain(); 
        const wetBus = audioContext.createGain(); 
        
        inputGain.connect(dryBus).connect(masterGain);
        inputGain.connect(wetBus);

        wetBus.connect(nodes.spatial.input).connect(nodes.spatial.convolver).connect(masterGain);
        wetBus.connect(nodes.binaural.input).connect(nodes.binaural.panner).connect(masterGain);
        wetBus.connect(nodes.binaural.input).connect(nodes.binaural.delay).connect(masterGain);
        wetBus.connect(nodes.vocalBoost).connect(masterGain);
        wetBus.connect(nodes.party.bassBoost).connect(nodes.party.compressor).connect(masterGain);
        
        masterGain.connect(nodes.stableVolume).connect(nodes.nightMode).connect(nodes.dynamicGain).connect(finalCompressor).connect(audioContext.destination);
        
        const controls = Object.fromEntries(Array.from(document.querySelectorAll('[data-setting]')).map(el => [el.dataset.setting, el]));
        
        const showStatus = (message, type = 'info', duration = 3000) => {
            const el = document.getElementById('statusMessageV4');
            clearTimeout(el.timeoutId);
            el.textContent = message;
            el.className = `status-message-v4 ${type}`;
            el.style.display = 'block';
            el.timeoutId = setTimeout(() => el.style.display = 'none', duration);
        };
        
        const awarenessEngine = {
            micStream: null, analyser: null, interval: null, isActive: false, isSpeaking: false,
            
            start(deviceId) {
                if (this.isActive || !deviceId) return;
                this.isActive = true;
                navigator.mediaDevices.getUserMedia({ audio: { deviceId: { exact: deviceId }, noiseSuppression: true, echoCancellation: true } })
                    .then(stream => {
                        this.micStream = stream;
                        this.analyser = audioContext.createAnalyser();
                        this.analyser.fftSize = 512;
                        audioContext.createMediaStreamSource(stream).connect(this.analyser);
                        this.interval = setInterval(() => this.process(), 100);
                    }).catch(err => { this.stop(); });
            },

            stop() {
                if (this.interval) clearInterval(this.interval);
                if (this.micStream) this.micStream.getTracks().forEach(track => track.stop());
                this.isActive = false;
                this.interval = this.micStream = this.analyser = null;
                this.setDucking(false);
            },

            process() {
                if (!this.analyser) return;
                const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                this.analyser.getByteFrequencyData(dataArray);

                const targetMinHz = 300, targetMaxHz = 3400;
                const binWidth = audioContext.sampleRate / this.analyser.fftSize;
                const minBin = Math.floor(targetMinHz / binWidth);
                const maxBin = Math.ceil(targetMaxHz / binWidth);

                let voiceEnergy = 0;
                for (let i = minBin; i <= maxBin; i++) voiceEnergy += dataArray[i];
                voiceEnergy /= (maxBin - minBin + 1);

                const currentlySpeaking = voiceEnergy > 20;

                if (currentlySpeaking !== this.isSpeaking) {
                    this.isSpeaking = currentlySpeaking;
                    this.setDucking(this.isSpeaking);
                }
            },
            
            setDucking(isDucking) {
                const newVolume = isDucking ? 0.3 : 1.0;
                masterGain.gain.linearRampToValueAtTime(newVolume, audioContext.currentTime + (isDucking ? 0.2 : 0.5));
            }
        };

        const clearSounds = () => {
             for (const [_, instances] of activeSounds.entries()) {
                [...instances].forEach(sound => sound.stop(parseFloat(controls.fadeOut.value || 0.1)));
            }
        };
        
        class Sound {
             constructor(fileName, onEnd) {
                this.audioElement = new Audio(`../Sounds/${fileName}`);
                this.sourceNode = audioContext.createMediaElementSource(this.audioElement);
                this.gainNode = audioContext.createGain();
                this.analyser = audioContext.createAnalyser();
                this.analyser.fftSize = 128;
                this.sourceNode.connect(this.gainNode).connect(this.analyser).connect(inputGain);
                this.onEnd = onEnd;
                this.audioElement.addEventListener('ended', () => { if (!this.audioElement.loop) this.onEnd(this); });
            }
            async play(options) {
                try {
                    const sinkId = controls.playbackDevice.value;
                    if (sinkId && typeof this.audioElement.setSinkId === 'function') await this.audioElement.setSinkId(sinkId);
                } catch (err) { console.error("Failed to set audio output device:", err); }
                this.audioElement.loop = options.looping;
                this.audioElement.playbackRate = options.speed;
                this.gainNode.gain.setValueAtTime(0.0001, audioContext.currentTime).linearRampToValueAtTime(1, audioContext.currentTime + options.fadeTime);
                await this.audioElement.play().catch(e => { console.error("Play Error:", e); this.onEnd(this); });
            }
            stop(fadeTime) {
                this.gainNode.gain.cancelScheduledValues(audioContext.currentTime);
                this.gainNode.gain.setValueAtTime(this.gainNode.gain.value, audioContext.currentTime).linearRampToValueAtTime(0.0001, audioContext.currentTime + fadeTime);
                setTimeout(() => { this.audioElement.pause(); this.onEnd(this); }, fadeTime * 1000 + 50);
            }
        }
        
        async function loadSoundsAndCreateButtons() {
            try {
                const response = await fetch('../SoundboardSN.json');
                const soundsData = await response.json();
                const container = document.getElementById('soundCategoriesContainerV4');
                container.innerHTML = ''; 
                for (const categoryKey in soundsData) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'sound-category-v4';
                    categoryDiv.innerHTML = `<h2>${categoryKey.replace(/([A-Z])/g, ' $1').trim()}</h2>`;
                    const buttonsGrid = document.createElement('div');
                    buttonsGrid.className = 'sound-buttons-grid-v4';
                    soundsData[categoryKey].sort().forEach(fileName => {
                        const displayName = fileName.replace(/\.mp3$/i, '').replace(/_/g, ' ');
                        const button = document.createElement('button');
                        button.className = 'sound-button-v4';
                        button.textContent = displayName;
                        button.dataset.soundFile = fileName;
                        button.addEventListener('click', () => {
                            if (!controls.allowMultiple.checked) clearSounds();
                            
                            const onEnd = (soundInstance) => {
                                const instances = activeSounds.get(fileName) || [];
                                const filtered = instances.filter(s => s !== soundInstance);
                                if (filtered.length > 0) activeSounds.set(fileName, filtered);
                                else activeSounds.delete(fileName);
                            };

                            const sound = new Sound(fileName, onEnd);
                            activeSounds.set(fileName, [...(activeSounds.get(fileName) || []), sound]);
                            sound.play({ 
                                looping: controls.looping.checked, 
                                fadeTime: parseFloat(controls.fadeIn.value || 0.1), 
                                speed: parseFloat(controls.speed.value || 1) 
                            });
                        });
                        buttonsGrid.appendChild(button);
                    });
                    categoryDiv.appendChild(buttonsGrid);
                    container.appendChild(categoryDiv);
                }
            } catch (error) { console.error("Failed to load sounds:", error); }
        }
        
        const updateFunctions = {
            masterVolume: v => { masterGain.gain.value = v; document.getElementById('masterVolumeValue').textContent = `${Math.round(v*100)}%`; },
            fadeIn: v => { document.getElementById('fadeInValue').textContent = `${parseFloat(v).toFixed(1)}s`; },
            fadeOut: v => { document.getElementById('fadeOutValue').textContent = `${parseFloat(v).toFixed(1)}s`; },
            speed: v => { document.getElementById('speedValue').textContent = `${parseFloat(v).toFixed(2)}x`; activeSounds.forEach(i => i.forEach(s => s.audioElement.playbackRate = v)); },
            pitchCorrection: v => { /* Logic would go here */ },
            modeSpatial: v => { 
                if (v) controls.modeBinaural.checked = false; 
                nodes.spatial.input.gain.linearRampToValueAtTime(v ? 1 : 0, 0.1);
                dryBus.gain.linearRampToValueAtTime(v ? 0 : 1, 0.1);
            },
            modeBinaural: v => {
                if (v) controls.modeSpatial.checked = false;
                nodes.binaural.input.gain.linearRampToValueAtTime(v ? 1 : 0, 0.1);
                dryBus.gain.linearRampToValueAtTime(v ? 0 : 1, 0.1);
            },
            modeVocalBoost: v => nodes.vocalBoost.gain.linearRampToValueAtTime(v ? 6 : 0, 0.1),
            modeParty: v => {
                nodes.party.compressor.threshold.value = v ? -40 : -100;
                nodes.party.bassBoost.gain.value = v ? 6 : 0;
            },
            modeDynamic: v => v ? dynamicAudioEngine.start(controls.microphoneDevice.value) : dynamicAudioEngine.stop(),
            modeAwareness: v => v ? awarenessEngine.start(controls.microphoneDevice.value) : awarenessEngine.stop(),
            modeStable: v => {
                nodes.stableVolume.threshold.value = v ? -24 : -100;
                nodes.stableVolume.ratio.value = v ? 12 : 1;
            },
            modeNight: v => {
                finalGain.gain.linearRampToValueAtTime(v ? 0.25 : 1.0, 0.1);
            }
        };
        
        function updateButtonVisuals() {
            requestAnimationFrame(updateButtonVisuals);
            document.querySelectorAll('.sound-button-v4[data-sound-file]').forEach(button => {
                const fileName = button.dataset.soundFile;
                const instances = activeSounds.get(fileName);

                if (instances && instances.length > 0) {
                    button.classList.add('playing');
                    if (instances.length > 1) {
                        button.classList.add('pulsating');
                        button.style.transform = '';
                        button.style.boxShadow = '';
                    } else {
                        button.classList.remove('pulsating');
                        const analyser = instances[0].analyser;
                        const dataArray = new Uint8Array(analyser.frequencyBinCount);
                        analyser.getByteFrequencyData(dataArray);
                        const avg = dataArray.reduce((s, v) => s + v, 0) / dataArray.length;
                        const scale = 1 + (avg / 255) * 0.05;
                        const shadowSpread = 2 + (avg / 255) * 8;
                        button.style.transform = `scale(${scale})`;
                        button.style.boxShadow = `0 0 ${shadowSpread}px rgba(103, 32, 189, 0.7)`;
                    }
                } else {
                    button.classList.remove('playing', 'pulsating');
                    button.style.transform = '';
                    button.style.boxShadow = '';
                }
            });
        }

        function updateDeviceDisplays() {
            const outEl = document.getElementById('currentOutputDevice');
            const inEl = document.getElementById('currentInputDevice');
            if (outEl && controls.playbackDevice.selectedOptions.length > 0) {
                outEl.textContent = controls.playbackDevice.selectedOptions[0].text;
            }
            if (inEl && controls.microphoneDevice.selectedOptions.length > 0) {
                inEl.textContent = controls.microphoneDevice.selectedOptions[0].text;
            } else if (inEl) {
                inEl.textContent = 'None available';
            }
        }
        
        function createImpulseResponse(context) {
            const sampleRate = context.sampleRate;
            const length = sampleRate * 0.5;
            const impulse = context.createBuffer(2, length, sampleRate);
            const left = impulse.getChannelData(0);
            const right = impulse.getChannelData(1);
            for (let i = 0; i < length; i++) {
                left[i] = (Math.random() * 0.5 - 0.25) * Math.pow(1 - i / length, 2);
                right[i] = (Math.random() * 0.5 - 0.25) * Math.pow(1 - i / length, 2.5);
            }
            return impulse;
        }

        function handleSettingsSearch(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const resultsContainer = document.getElementById('searchResultsContainer');
            const allTabs = document.querySelectorAll('.tab-content');
            resultsContainer.innerHTML = '';
            
            if (!searchTerm) {
                allTabs.forEach(t => t.style.display = 'none');
                document.querySelector('.tab-content.active').style.display = 'grid';
                resultsContainer.style.display = 'none';
                return;
            }
            
            allTabs.forEach(t => t.style.display = 'none');
            resultsContainer.style.display = 'block';
            const allControls = document.querySelectorAll('.control-group[data-search-terms]');
            let matchFound = false;

            allControls.forEach(control => {
                const searchTerms = control.dataset.searchTerms;
                if (searchTerms.includes(searchTerm)) {
                    matchFound = true;
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    
                    const label = control.querySelector('label').textContent.trim();
                    const tabPane = control.closest('.tab-content');
                    const tabId = tabPane.id;
                    const tabName = document.querySelector(`.tab-link[data-tab="${tabId}"]`).textContent;

                    resultItem.innerHTML = `<span>${label}</span> <span class="search-result-category">${tabName}</span>`;
                    resultItem.onclick = () => {
                        document.querySelector(`.tab-link[data-tab="${tabId}"]`).click();
                        document.getElementById('settingsSearch').value = '';
                         resultsContainer.style.display = 'none';
                         document.querySelector('.tab-content.active').style.display = 'grid';

                        setTimeout(() => {
                           const targetControl = document.querySelector(`#${tabId} [data-search-terms="${searchTerms}"]`);
                           targetControl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                           targetControl.classList.add('highlight');
                           setTimeout(() => targetControl.classList.remove('highlight'), 1500);
                        }, 100);
                    };
                    resultsContainer.appendChild(resultItem);
                }
            });

            if (!matchFound) {
                resultsContainer.innerHTML = '<div class="search-result-item">No settings found.</div>';
            }
        }

        async function initialize() {
            nodes.spatial.convolver.buffer = createImpulseResponse(audioContext);
            await loadSoundsAndCreateButtons();
            requestAnimationFrame(updateButtonVisuals);

            // --- Main Event Listeners ---
            document.getElementById('resetSettingsBtn').addEventListener('click', () => {
                if (!confirm('Are you sure you want to reset all settings?')) return;
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                window.location.reload();
            });
            document.getElementById('clearSoundsBtn').addEventListener('click', clearSounds);
            document.getElementById('settingsSearch').addEventListener('input', handleSettingsSearch);
            document.querySelector('.settings-tabs').addEventListener('click', e => {
                if (e.target.matches('.tab-link')) {
                    document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active'));
                    e.target.classList.add('active');
                    const activeTab = document.getElementById(e.target.dataset.tab);
                    activeTab.classList.add('active');
                     document.getElementById('settingsSearch').value = '';
                     document.getElementById('searchResultsContainer').style.display = 'none';
                }
            });
            
            const wrapper = document.querySelector('.soundboard-container-wrapper');
            if (wrapper) {
                document.querySelectorAll('select').forEach(selectEl => {
                    selectEl.addEventListener('focus', () => { wrapper.style.overflow = 'visible'; });
                    selectEl.addEventListener('blur', () => { wrapper.style.overflow = 'hidden'; });
                });
            }
        
            Object.values(controls).forEach(el => {
                const key = el.dataset.setting;
                const eventType = el.type === 'checkbox' ? 'change' : 'input';
                if(updateFunctions[key]) {
                    el.addEventListener(eventType, e => updateFunctions[key](el.type === 'checkbox' ? e.target.checked : e.target.value));
                }
            });

            controls.microphoneDevice.addEventListener('change', updateDeviceDisplays);
             controls.playbackDevice.addEventListener('change', updateDeviceDisplays);
            
             const micPrompt = document.getElementById('mic-permission-prompt');
             try {
                const permissionStatus = await navigator.permissions.query({name: 'microphone'});
                const handlePermission = (status) => {
                    const micDependentModes = document.querySelectorAll('[data-setting="modeDynamic"], [data-setting="modeAwareness"]');
                    if (status.state === 'granted') {
                        micPrompt.style.display = 'none';
                        micDependentModes.forEach(el => el.closest('.control-group').classList.remove('disabled'));
                    } else {
                        micPrompt.style.display = 'block';
                        micDependentModes.forEach(el => {
                            el.checked = false;
                            el.dispatchEvent(new Event('change'));
                            el.closest('.control-group').classList.add('disabled');
                        });
                        micPrompt.querySelector('p').textContent = status.state === 'denied' 
                            ? 'Microphone access was denied. Please enable it in your browser settings.'
                            : 'Dynamic features require microphone access.';
                        micPrompt.querySelector('button').disabled = status.state === 'denied';
                    }
                };
                
                permissionStatus.onchange = () => handlePermission(permissionStatus);
                handlePermission(permissionStatus);

                document.getElementById('enable-mic-btn').onclick = async () => {
                    try {
                        await navigator.mediaDevices.getUserMedia({ audio: true });
                    } catch(e) {
                         showStatus('Microphone access was not granted.', 'error');
                    }
                };
             } catch(e) {
                 document.querySelectorAll('[data-setting="modeDynamic"], [data-setting="modeAwareness"]').forEach(el => el.closest('.control-group').classList.add('disabled'));
             }

            async function initializeDevices() {
                 try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const audioOutputs = devices.filter(d => d.kind === 'audiooutput');
                    const audioInputs = devices.filter(d => d.kind === 'audioinput');

                    if (audioInputs.length > 0) {
                        const micSelectEl = controls.microphoneDevice;
                        const currentVal = micSelectEl.value;
                        micSelectEl.innerHTML = '';
                        audioInputs.forEach(device => {
                            const option = new Option(device.label || `Internal Mic ${micSelectEl.options.length + 1}`, device.deviceId);
                            micSelectEl.add(option);
                        });
                        if (Array.from(micSelectEl.options).some(opt => opt.value === currentVal)) {
                           micSelectEl.value = currentVal;
                        }
                    } 
                    
                    const speakerSelectEl = controls.playbackDevice;
                     const currentVal = speakerSelectEl.value;
                    speakerSelectEl.innerHTML = '';
                    audioOutputs.forEach(device => {
                        const option = new Option(device.label || `Internal Speakers ${speakerSelectEl.options.length + 1}`, device.deviceId);
                        speakerSelectEl.add(option);
                    });
                     if (Array.from(speakerSelectEl.options).some(opt => opt.value === currentVal)) {
                           speakerSelectEl.value = currentVal;
                     }
                    updateDeviceDisplays();
                } catch (err) {
                    console.error("Audio device enumeration error:", err);
                }
            }
            
            initializeDevices();
             navigator.mediaDevices.ondevicechange = initializeDevices;
        }

        initialize();
    });
    </script>
</body>
</html>
