<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - CARD</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="../panic-key.js"></script>
  <script src="../ban-enforcer.js"></script>
  <script src="../url-changer.js"></script>

  <style>
    /* Using styles from requests.html as a base and simplifying */
    body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: PrimaryFont, sans-serif; }
    .dashboard-container { display: flex; flex: 1; }
    .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.collapsed { width: 85px; }
    #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
    .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
    .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
    .sidebar nav li { margin-bottom: 10px; }
    .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
    .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
    .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
    .sidebar nav a .label { margin-left: 10px; white-space: nowrap; opacity: 1; visibility: visible; transition: opacity 0.2s ease-in-out; transition-delay: 0.4s; }
    .sidebar.collapsed nav a .label { opacity: 0; visibility: hidden; transition-delay: 0s; }
    .main-content { flex: 1; padding: 30px; background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%); overflow-y: auto; position: relative; display: flex; flex-direction: column; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: linear-gradient(to right, #ffffff, #f8f9fa); padding: 15px 20px; border-radius: 12px; box-shadow: 0 6px 25px rgba(0,0,0,0.06); }
    .header-user-info .username { font-family: PrimaryFont, sans-serif; font-size: 1.2em; font-weight: bold; color: #333; }
    .header-user-info .email { font-family: SecondaryFont, sans-serif; font-size: 0.9em; color: #777; }
    #createRequestBtn { border: none; color: #fff; padding: 10px 20px; border-radius: 10px; font-family: PrimaryFont, sans-serif; cursor: pointer; transition: all 0.3s ease; font-size: 0.95em; font-weight: 600; display: flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #7b2cbf 0%, #9d4edd 100%); box-shadow: 0 4px 15px rgba(123, 44, 191, 0.2); }
    #createRequestBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(123, 44, 191, 0.3); }
    .requests-display-card { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
    .requests-controls { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
    .requests-controls input[type="search"] { flex-grow: 1; min-width: 200px; padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; font-family: PrimaryFont, sans-serif; height: 38px; box-sizing: border-box; }
    #requestsList { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 15px; }
    .request-item { border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; background: #fdfdfd; display: flex; gap: 20px; transition: all 0.2s; position: relative; cursor: pointer; }
    .request-item:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.09); border-color: #d0d0d0; }
    .request-content { width: 100%; overflow: hidden; }
    .request-header { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
    .request-type-badge { padding: 4px 8px; border-radius: 8px; font-size: 0.8em; font-weight: bold; color: white; font-family: PrimaryFont, sans-serif; }
    .badge-sound { background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%); }
    .badge-feature { background: linear-gradient(135deg, #10b981 0%, #22c55e 100%); }
    .badge-issue { background: linear-gradient(135deg, #f97316 0%, #ef4444 100%); }
    .badge-amazing-idea { background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); }
    .request-title { font-size: 1.15em; font-weight: 600; color: #2c3e50; margin: 5px 0 8px 0; font-family: PrimaryFont, sans-serif; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .request-description { font-size: 0.9em; color: #555; font-family: SecondaryFont, sans-serif; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .request-description-container { overflow: hidden; width: 100%; position: relative; }
    .request-description-container.marquee .request-description { display: inline-block; width: max-content; animation: marquee-animation 15s linear infinite; text-overflow: clip; }
    .request-description-container.marquee .request-description span:first-of-type { padding-right: 40px; }
    @keyframes marquee-animation { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
    .admin-status-info { font-size: 0.85em; margin-top: 10px; padding: 6px 10px; border-radius: 8px; font-family: PrimaryFont, sans-serif; font-weight: 500; border-left-width: 4px; border-left-style: solid; }
    .admin-status-info small { color: #555; font-size: 0.9em; }
    .status-completed { background-color: #d4edda; border-color: #155724; color: #155724; }
    .status-in-progress { background-color: #fff8e1; border-color: #ffb300; color: #c66900; }
    .status-pending { background-color: #e2e3e5; border-color: #383d41; color: #383d41; }
    .request-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 12px; font-size: 0.8em; color: #777; border-top: 1px solid #f0f0f0; padding-top: 8px; font-family: SecondaryFont, sans-serif; }
    .card-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 5px; background: #fff; padding: 4px; border-radius: 16px; border: 1px solid #eee; }
    .card-action-btn { background: none; border: 1px solid #ddd; color: #555; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8em; transition: all 0.2s ease; }
    .card-action-btn:hover { background: #eee; color: #000; border-color: #ccc; }
    .modal-overlay, #menu-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
    .modal-overlay { background: rgba(0,0,0,0.6); z-index: 1000; display:flex; justify-content: center; align-items: center; }
    #menu-overlay { background-color: rgba(0,0,0,0.1); z-index: 1000; }
    .modal-overlay.show, #menu-overlay.show { opacity: 1; pointer-events: auto; }
    #menu-overlay.show { display: block; }
    .modal-overlay.show { display: flex; }
    .modal-content { background: white; padding: 25px 30px; border-radius: 12px; width: 100%; box-shadow: 0 5px 25px rgba(0,0,0,0.2); max-width: 600px; transform: scale(0.95); opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; }
    .modal-overlay.show .modal-content { transform: scale(1); opacity: 1; }
    .modal-close-btn-redesigned { position: absolute; top: 12px; right: 12px; background-color: #f1f1f1; border: 1px solid #ddd; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; transition: all 0.2s ease; z-index: 10; padding: 0; display: flex; align-items: center; justify-content: center; }
    .modal-close-btn-redesigned:hover { background-color: #e0e0e0; transform: rotate(90deg); }
    .modal-close-btn-redesigned img { width: 55%; height: 55%; filter: invert(1); opacity: 0.7; }
    .modal-footer-detailed { display: flex; justify-content: flex-end; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
    .modal-meta-info { text-align: right; font-family: SecondaryFont, sans-serif; color: #666; font-size: 0.9em; }
    #adminStatusMenu { opacity: 0; visibility: hidden; transform: translateY(10px); transition: opacity 0.25s ease-out, transform 0.25s ease-out, visibility 0.25s; position: fixed; z-index: 1001; background-color: #ffffff; min-width: 180px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); border-radius: 16px; overflow: hidden; list-style: none; padding: 0; margin: 0; }
    #adminStatusMenu.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .admin-menu-header { padding: 12px 16px; font-family: 'PrimaryFont', sans-serif; color: #333; cursor: default; font-weight: bold; }
    .admin-menu-divider { height: 1px; margin: 0 10px; border: none; background-color: #e0e0e0; }
    #adminStatusMenu li { color: #333; padding: 12px 16px; text-decoration: none; display: block; text-align: left; transition: background-color 0.2s ease-in-out; cursor: pointer; }
    #adminStatusMenu li:hover { background-color: #f1f1f1; }
    #adminStatusMenu li.selected-completed { background-color: #d4edda; color: #155724; }
    #adminStatusMenu li.selected-completed:hover { background-color: #c3e6cb; }
    #adminStatusMenu li.selected-in-progress { background-color: #fff8e1; color: #856404; }
    #adminStatusMenu li.selected-in-progress:hover { background-color: #ffeeba; }
    #adminStatusMenu li.selected-pending { background-color: #e2e3e5; color: #383d41; }
    #adminStatusMenu li.selected-pending:hover { background-color: #d6d8db; }
    .modal-footer { margin-top: 25px; display: flex; justify-content: flex-end; }
    .btn-purple { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .form-group { margin-bottom: 22px; position: relative; } .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #3d475c; }
    .form-group input, .form-group select, .form-group textarea { font-family: PrimaryFont, sans-serif; background-color: #fff; border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; width: 100%; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; }
    .form-group textarea { resize: vertical; min-height: 120px; font-family: SecondaryFont, sans-serif; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #8a2be2; box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.15); outline: none; }
    .char-counter { position: absolute; bottom: -18px; right: 5px; font-size: 0.75em; color: #888; font-family: SecondaryFont, sans-serif; }
    .particle { position: fixed; border-radius: 50%; pointer-events: none; z-index: 9999; }
    #reauth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 10, 10, 0.75); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); z-index: 20000; display: flex; justify-content: center; align-items: center; color: white; text-align: center; font-family: PrimaryFont, sans-serif; }
    #reauth-box { background: rgba(255, 255, 255, 0.1); padding: 40px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.2); }
    #reauth-box h2 { margin-top: 0; } #reauth-box p { margin-bottom: 25px; max-width: 400px; color: #e0e0e0; }
    #reauth-btn { font-family: 'PrimaryFont', sans-serif; background: linear-gradient(135deg, #4285F4 0%, #3478e6 100%); color: #fff; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1em; cursor: pointer; transition: all 0.3s ease; }
    #reauth-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3); }
    #reauth-password-input { margin-top: 15px; }
    #loadingIndicator { text-align: center; padding: 40px; font-size: 1.2em; color: #555; }
    .dot-flashing { position: relative; width: 10px; height: 10px; border-radius: 5px; background-color: #8a2be2; color: #8a2be2; animation: dot-flashing 1s infinite linear alternate; animation-delay: .5s; }
    .dot-flashing::before, .dot-flashing::after { content: ''; display: inline-block; position: absolute; top: 0; }
    .dot-flashing::before { left: -15px; width: 10px; height: 10px; border-radius: 5px; background-color: #8a2be2; animation: dot-flashing 1s infinite alternate; animation-delay: 0s; }
    .dot-flashing::after { left: 15px; width: 10px; height: 10px; border-radius: 5px; background-color: #8a2be2; animation: dot-flashing 1s infinite alternate; animation-delay: 1s; }
    @keyframes dot-flashing { 0% { background-color: #8a2be2; } 50%, 100% { background-color: rgba(138, 43, 226, 0.2); } }
  </style>
</head>

<body class="dashboard-page">
  <div id="reauth-overlay">
    <div id="reauth-box">
      <h2><i class="fas fa-user-shield"></i> Admin Verification Required</h2>
      <p>This is a restricted area. Please re-authenticate your account to verify your administrator status and access the dashboard.</p>
      <div id="reauth-password-wrapper" style="display: none;">
        <input type="password" id="reauth-password-input" class="form-group" placeholder="Enter password to continue..." style="text-align: center; background: rgba(0,0,0,0.2); color: white; border-color: rgba(255,255,255,0.3);">
      </div>
      <button id="reauth-btn">Verify Admin Status</button>
      <p id="reauth-status" style="margin-top: 20px; min-height: 1.2em;"></p>
    </div>
  </div>

  <header class="main-header light-bg">
    <div class="container">
      <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo"/></a></div>
      <div class="auth-buttons"><button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button><button id="logoutBtn" class="btn btn-login">LOG OUT</button></div>
    </div>
  </header>
  
  <div class="dashboard-container">
    <aside class="sidebar" id="sidebar">
      <button id="toggleSidebar">☰</button>
      <nav>
        <ul>
          <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
          <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
          <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
          <li><a href="apps.html"><span class="icon">✨</span><span class="label">Apps</span></a></li>
          <li><a href="settings.html" class="active"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
          <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content" id="mainContent" style="visibility: hidden;">
      <div class="page-header">
          <div class="header-user-info" id="headerUserInfo"><div class="username">Admin</div><div class="email">Loading...</div></div>
          <div class="header-actions"><button id="createRequestBtn" class="btn"><i class="fas fa-plus"></i>Create Request</button></div>
      </div>
      <div class="requests-display-card">
          <div class="requests-controls"><input type="search" id="searchBar" placeholder="Search admin requests..."></div>
          <ul id="requestsList"></ul>
          <div id="loadingIndicator"><div class="dot-flashing"></div></div>
      </div>
    </main>
  </div>

  <div id="detailsModal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn-redesigned"><img src="../images/cross-white.png" alt="Close"></button>
        <h3 id="modalTitle" style="margin-top: 0;">Details</h3>
        <p id="modalDescription" style="white-space: pre-wrap; word-wrap: break-word; max-height: 60vh; overflow-y: auto;"></p>
        <div class="modal-footer-detailed">
            <div class="modal-meta-info">
                <span id="modalUsername"></span>
                <span id="modalTimestamp"></span>
            </div>
        </div>
    </div>
  </div>

  <div id="formModal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn-redesigned"><img src="../images/cross-white.png" alt="Close"></button>
        <h3 style="margin-top: 0;">Create Admin Request</h3>
        <form id="requestForm">
            <div class="form-group">
                <label for="requestType">Category</label>
                <select id="requestType" required>
                    <option value="sound">Sound Request</option>
                    <option value="feature">Feature Request</option>
                    <option value="issue">Issue Report</option>
                    <option value="amazing-idea">Amazing Idea</option>
                </select>
            </div>
            <div class="form-group">
                <label for="requestTitleForm">Title (Max 50 characters)</label>
                <input type="text" id="requestTitleForm" placeholder="A brief summary..." required maxlength="50">
                <span id="titleCharCounter" class="char-counter">0/50</span>
            </div>
            <div class="form-group">
                <label for="requestDescriptionForm">Details (Max 1000 characters)</label>
                <textarea id="requestDescriptionForm" placeholder="Add details, links, or notes..." required maxlength="1000" rows="5"></textarea>
                <span id="descCharCounter" class="char-counter">0/1000</span>
            </div>
        </form>
        <div class="modal-footer"><button type="submit" form="requestForm" id="submitRequestBtn" class="btn-purple">Submit Request</button></div>
    </div>
  </div>
  
  <div id="menu-overlay"></div>
  <ul id="adminStatusMenu">
    <div class="admin-menu-header">SET STATUS</div>
    <hr class="admin-menu-divider">
    <li data-status="pending">Pending</li>
    <li data-status="in-progress">In Progress</li>
    <li data-status="completed">Completed</li>
  </ul>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>

  <script>
    // --- Configuration & Globals ---
    const ADMIN_EMAILS = ["4simpleproblems@gmail.com", "belkwy30@minerva.sparcc.org"];
    let currentUser = null;
    let authMethod = 'password';

    // --- DOM Elements ---
    const reauthOverlay = document.getElementById('reauth-overlay');
    const reauthBtn = document.getElementById('reauth-btn');
    const reauthStatus = document.getElementById('reauth-status');
    const mainContent = document.getElementById('mainContent');
    const requestsListEl = document.getElementById('requestsList');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const detailsModal = document.getElementById('detailsModal');
    const adminStatusMenu = document.getElementById('adminStatusMenu');
    const menuOverlay = document.getElementById('menu-overlay');

    // --- Utility Functions ---
    function escapeHTML(str) { if (!str) return ''; const p = document.createElement("p"); p.textContent = str; return p.innerHTML; }
    function createParticleEffect(event, color) { const count = 25; const rect = event.target.getBoundingClientRect(); const startX = rect.left + rect.width / 2; const startY = rect.top + rect.height / 2; for (let i = 0; i < count; i++) { const particle = document.createElement('div'); particle.classList.add('particle'); document.body.appendChild(particle); const size = Math.random() * 5 + 2; particle.style.width = `${size}px`; particle.style.height = `${size}px`; particle.style.backgroundColor = color; let x = startX, y = startY; const angle = Math.random() * 2 * Math.PI; const velocity = Math.random() * 4 + 2; let vx = Math.cos(angle) * velocity; let vy = Math.sin(angle) * velocity; let gravity = 0.1, opacity = 1; function animate() { x += vx; y += vy; vy += gravity; opacity -= 0.02; particle.style.transform = `translate(${x - startX}px, ${y - startY}px)`; particle.style.left = `${startX}px`; particle.style.top = `${startY}px`; particle.style.opacity = opacity; if (opacity > 0) requestAnimationFrame(animate); else particle.remove(); } requestAnimationFrame(animate); } }

    // --- Core Authentication Flow ---
    firebase.auth().onAuthStateChanged(user => {
        if (!user) {
            window.location.href = '../login.html';
            return;
        }
        currentUser = user;
        document.querySelector('#headerUserInfo .email').textContent = user.email;

        const isGoogle = user.providerData.some(p => p.providerId === 'google.com');
        const isGithub = user.providerData.some(p => p.providerId === 'github.com');
        const passwordWrapper = document.getElementById('reauth-password-wrapper');

        if (isGoogle) {
            authMethod = 'google';
            reauthBtn.innerHTML = '<i class="fab fa-google" style="margin-right: 8px;"></i> Re-authenticate with Google';
            passwordWrapper.style.display = 'none';
        } else if (isGithub) {
            authMethod = 'github';
            reauthBtn.innerHTML = '<i class="fab fa-github" style="margin-right: 8px;"></i> Re-authenticate with GitHub';
            passwordWrapper.style.display = 'none';
        } else {
            authMethod = 'password';
            reauthBtn.textContent = 'Verify Password';
            passwordWrapper.style.display = 'block';
        }

        if (sessionStorage.getItem('isAdminAuthenticated') === 'true') {
            reauthOverlay.style.display = 'none';
            mainContent.style.visibility = 'visible';
            initializeApp();
        } else {
            reauthOverlay.style.display = 'flex';
            mainContent.style.visibility = 'hidden';
        }
    });

    reauthBtn.addEventListener('click', async () => {
        reauthStatus.textContent = 'Awaiting verification...';
        try {
            if (authMethod === 'google') {
                const provider = new firebase.auth.GoogleAuthProvider();
                await currentUser.reauthenticateWithPopup(provider);
            } else if (authMethod === 'github') {
                const provider = new firebase.auth.GithubAuthProvider();
                await currentUser.reauthenticateWithPopup(provider);
            } else {
                const password = document.getElementById('reauth-password-input').value;
                if (!password) {
                    reauthStatus.textContent = 'Please enter your password.';
                    return;
                }
                const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
                await currentUser.reauthenticateWithCredential(credential);
            }
            
            await currentUser.reload();
            const updatedUser = firebase.auth().currentUser;

            if (updatedUser && ADMIN_EMAILS.includes(updatedUser.email)) {
                reauthStatus.textContent = 'Success! Accessing dashboard...';
                sessionStorage.setItem('isAdminAuthenticated', 'true');
                setTimeout(() => {
                    reauthOverlay.style.display = 'none';
                    mainContent.style.visibility = 'visible';
                    initializeApp();
                }, 1000);
            } else {
                reauthStatus.textContent = 'Access Denied. You are not a registered administrator.';
                setTimeout(() => window.location.href = 'dashboard.html', 3000);
            }
        } catch (error) {
            console.error("Re-authentication failed:", error);
            reauthStatus.textContent = (error.code === 'auth/wrong-password') ? 'Incorrect password. Please try again.' : `Error: ${error.message}`;
        }
    });
    
    function initializeApp() {
        fetchAdminRequests();
        setupEventListeners();
    }

    async function fetchAdminRequests() {
        loadingIndicator.style.display = 'block';
        requestsListEl.innerHTML = '';
        const db = firebase.firestore();
        try {
            const snapshot = await db.collection('admin_requests').orderBy('timestamp', 'desc').get();
            if (snapshot.empty) {
                requestsListEl.innerHTML = '<li>No admin requests found. Create one to get started!</li>';
            } else {
                snapshot.forEach(doc => {
                    const request = { id: doc.id, ...doc.data() };
                    const li = document.createElement('li');
                    li.className = 'request-item';
                    li.dataset.id = request.id;
                    
                    const typeInfo = { 
                        sound: { text: 'Sound', class: 'badge-sound' }, 
                        feature: { text: 'Feature', class: 'badge-feature' }, 
                        issue: { text: 'Issue', class: 'badge-issue' }, 
                        'amazing-idea': { text: 'Amazing Idea', class: 'badge-amazing-idea' } 
                    }[request.type] || { text: 'General', class: 'badge-cat-normal' };
                    
                    let statusHTML = '';
                    if (request.status) {
                        const statusText = { pending: 'Pending', 'in-progress': 'In Progress', completed: 'Completed' }[request.status] || request.status;
                        statusHTML = `<div class="admin-status-info status-${request.status}">Status: <strong>${statusText}</strong></div>`;
                    }

                    li.innerHTML = `
                        <div class="request-content">
                            <div class="request-header">
                                <span class="request-type-badge ${typeInfo.class}">${typeInfo.text}</span>
                            </div>
                            <h4 class="request-title" title="${escapeHTML(request.title)}">${escapeHTML(request.title)}</h4>
                            <div class="request-description-container">
                                <p class="request-description">${escapeHTML(request.description)}</p>
                            </div>
                            ${statusHTML}
                            <div class="request-footer">
                                <span>By <strong>${escapeHTML(request.adminEmail)}</strong> on ${request.timestamp.toDate().toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-action-btn status-menu-btn" title="Set Status"><i class="fas fa-list-ul"></i></button>
                            <button class="card-action-btn delete-btn-card" title="Delete Request"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    requestsListEl.appendChild(li);

                    const descContainer = li.querySelector('.request-description-container');
                    const descP = descContainer.querySelector('.request-description');
                    if (descP.scrollWidth > descContainer.clientWidth) {
                        descContainer.classList.add('marquee');
                        const originalText = descP.textContent;
                        descP.innerHTML = `<span>${originalText}</span><span aria-hidden="true">${originalText}</span>`;
                    }
                });
            }
        } catch (error) {
            console.error("Error fetching admin requests:", error);
            requestsListEl.innerHTML = `<li>Error: ${error.message}</li>`;
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    async function openDetailsModal(requestId) {
        try {
            const doc = await firebase.firestore().collection('admin_requests').doc(requestId).get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('modalTitle').textContent = data.title;
                document.getElementById('modalDescription').textContent = data.description;
                document.getElementById('modalUsername').innerHTML = `Posted by <strong>${escapeHTML(data.adminEmail)}</strong>`;
                document.getElementById('modalTimestamp').textContent = `on ${data.timestamp.toDate().toLocaleString()}`;
                detailsModal.classList.add('show');
            } else {
                alert('Request not found.');
            }
        } catch (error) {
            console.error("Error opening details modal:", error);
            alert('Could not load request details.');
        }
    }

    async function openAdminStatusMenu(button, requestId) {
        adminStatusMenu.querySelectorAll('li').forEach(li => li.className = '');
        try {
            const requestDoc = await firebase.firestore().collection('admin_requests').doc(requestId).get();
            if (requestDoc.exists) {
                const currentStatus = requestDoc.data().status;
                if (currentStatus) {
                    const selectedLi = adminStatusMenu.querySelector(`li[data-status="${currentStatus}"]`);
                    if (selectedLi) selectedLi.classList.add(`selected-${currentStatus}`);
                }
            }
        } catch (error) { console.error("Could not fetch request status for menu:", error); }

        const rect = button.getBoundingClientRect();
        adminStatusMenu.style.top = `${rect.bottom + 8}px`;
        adminStatusMenu.style.left = `${rect.right - adminStatusMenu.offsetWidth}px`;
        adminStatusMenu.dataset.requestId = requestId;
        menuOverlay.classList.add('show');
        adminStatusMenu.classList.add('show');
    }

    function closeAdminStatusMenu() {
        menuOverlay.classList.remove('show');
        adminStatusMenu.classList.remove('show');
    }

    async function updateAdminStatus(requestId, status) {
        const db = firebase.firestore();
        const requestRef = db.collection('admin_requests').doc(requestId);
        try {
            await requestRef.update({ 
                status: status, 
                statusUpdatedAt: firebase.firestore.FieldValue.serverTimestamp() 
            });
            fetchAdminRequests();
        } catch (error) {
            console.error("Error updating admin status:", error);
            alert("Failed to update status.");
        }
    }
    
    function setupEventListeners() {
        document.getElementById('logoutBtn').onclick = () => { sessionStorage.removeItem('isAdminAuthenticated'); firebase.auth().signOut(); };
        document.getElementById('signOutLink').onclick = (e) => { e.preventDefault(); sessionStorage.removeItem('isAdminAuthenticated'); firebase.auth().signOut(); };
        document.getElementById('toggleSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
        
        const formModal = document.getElementById('formModal');
        document.getElementById('createRequestBtn').addEventListener('click', () => formModal.classList.add('show'));
        formModal.querySelector('.modal-close-btn-redesigned').addEventListener('click', () => formModal.classList.remove('show'));
        detailsModal.querySelector('.modal-close-btn-redesigned').addEventListener('click', () => detailsModal.classList.remove('show'));
        menuOverlay.addEventListener('click', closeAdminStatusMenu);
        
        const titleInput = document.getElementById('requestTitleForm');
        const descInput = document.getElementById('requestDescriptionForm');
        const titleCounter = document.getElementById('titleCharCounter');
        const descCounter = document.getElementById('descCharCounter');
        titleInput.addEventListener('input', () => titleCounter.textContent = `${titleInput.value.length}/50`);
        descInput.addEventListener('input', () => descCounter.textContent = `${descInput.value.length}/1000`);

        document.getElementById('requestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submissionData = {
                adminEmail: currentUser.email,
                type: document.getElementById('requestType').value,
                title: titleInput.value,
                description: descInput.value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending'
            };
            try {
                await firebase.firestore().collection('admin_requests').add(submissionData);
                formModal.classList.remove('show');
                e.target.reset();
                titleCounter.textContent = '0/50';
                descCounter.textContent = '0/1000';
                fetchAdminRequests();
            } catch (error) {
                alert(`Failed to save request: ${error.message}`);
            }
        });

        requestsListEl.addEventListener('click', (e) => {
            const requestItem = e.target.closest('.request-item');
            if (!requestItem) return;
            const requestId = requestItem.dataset.id;
            const actionButton = e.target.closest('.card-action-btn');

            if (actionButton) {
                e.stopPropagation();
                if (actionButton.classList.contains('delete-btn-card')) {
                    if (confirm('Are you sure you want to delete this admin request?')) {
                        firebase.firestore().collection('admin_requests').doc(requestId).delete()
                            .then(() => fetchAdminRequests())
                            .catch(err => alert(`Error deleting: ${err.message}`));
                    }
                } else if (actionButton.classList.contains('status-menu-btn')) {
                    openAdminStatusMenu(actionButton, requestId);
                }
            } else {
                openDetailsModal(requestId);
            }
        });

        adminStatusMenu.addEventListener('click', (e) => {
            if (e.target.tagName === 'LI') {
                const requestId = adminStatusMenu.dataset.requestId;
                const newStatus = e.target.dataset.status;
                if (requestId && newStatus) {
                    const colors = { completed: '#28a745', 'in-progress': '#ffc107', pending: '#6c757d' };
                    createParticleEffect(e, colors[newStatus]);
                    updateAdminStatus(requestId, newStatus);
                }
                closeAdminStatusMenu();
            }
        });

        document.getElementById('searchBar').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('#requestsList .request-item').forEach(item => {
                item.style.display = item.textContent.toLowerCase().includes(query) ? 'flex' : 'none';
            });
        });
    }
  </script>
</body>
</html>

