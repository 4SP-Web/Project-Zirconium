<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VERN AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .ai-message .avatar {
            background: linear-gradient(135deg, #6720bd, #8a2be2);
        }
        .user-message .avatar {
            background: #e5e7eb;
            color: #4b5563;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .message-bubble {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 flex h-screen">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col transition-all duration-300">
        <div class="p-4 border-b border-gray-200">
            <h1 class="text-2xl font-bold text-gray-800">VERN AI</h1>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" class="flex items-center px-4 py-2 text-gray-700 bg-gray-200 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10 2a6 6 0 00-6 6v3.586l-1.293 1.293a1 1 0 001.414 1.414L6 12.414V15a1 1 0 001 1h6a1 1 0 001-1v-2.586l2.293 2.293a1 1 0 001.414-1.414L14 11.586V8a6 6 0 00-6-6zM8 8a2 2 0 114 0H8z" />
                </svg>
                AI Chat
            </a>
            <a href="dashboard.html" class="flex items-center px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                </svg>
                Dashboard
            </a>
        </nav>
        <div class="p-4 border-t border-gray-200">
             <div class="flex items-center">
                <div id="user-avatar" class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center font-bold text-gray-600 mr-3">
                </div>
                <div>
                    <p id="userName" class="font-semibold text-gray-700 text-sm">Loading...</p>
                    <p id="userEmail" class="text-xs text-gray-500">Loading...</p>
                </div>
            </div>
            <button id="logoutBtn" class="w-full mt-4 px-4 py-2 text-sm text-left text-red-600 hover:bg-red-50 rounded-lg flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                Logout
            </button>
        </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col">
        <header class="bg-white border-b border-gray-200 p-4">
            <h2 class="text-xl font-semibold text-gray-800">Vern AI Assistant</h2>
        </header>

        <div id="chat-container" class="chat-container flex-1 p-6 overflow-y-auto">
            <!-- Messages will be injected here -->
        </div>

        <footer class="bg-white border-t border-gray-200 p-4">
            <div class="flex items-center">
                <input type="text" id="message-input" placeholder="Type your message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                <button id="send-button" class="ml-4 px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 disabled:bg-purple-300">
                    Send
                </button>
            </div>
        </footer>
    </main>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <!-- Local Firebase Config -->
    <script src="../firebase-config.js"></script>

    <script>
        // --- DOM Elements ---
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const userNameEl = document.getElementById('userName');
        const userEmailEl = document.getElementById('userEmail');
        const userAvatarEl = document.getElementById('user-avatar');
        const logoutBtn = document.getElementById('logoutBtn');

        let db;
        let auth;
        let currentUser;
        let unsubscribeChat; // To store the listener unsubscribe function

        // --- Authentication ---
        function setupAuth() {
            auth = firebase.auth();
            db = firebase.firestore();

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    // User is signed in.
                    userNameEl.textContent = user.displayName || 'Anonymous';
                    userEmailEl.textContent = user.email;
                    userAvatarEl.textContent = (user.displayName || 'A').charAt(0).toUpperCase();

                    sendButton.disabled = false;
                    listenForMessages();
                } else {
                    // User is signed out.
                    window.location.href = '../login.html';
                }
            });
        }
        
        logoutBtn.addEventListener('click', () => {
             if (auth) {
                auth.signOut().catch(error => {
                    console.error('Logout Error:', error);
                });
            }
        });


        // --- Firestore ---
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (text === '' || !currentUser) return;

            const userMessage = {
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                sender: 'user',
                uid: currentUser.uid
            };
            
            messageInput.value = '';
            sendButton.disabled = true;

            try {
                // Add user message to their chat collection
                const chatDocRef = db.collection('vern_chats').doc(currentUser.uid).collection('messages');
                await chatDocRef.add(userMessage);
                
                // Simulate AI response
                simulateAIResponse(text);

            } catch (error) {
                console.error("Error sending message: ", error);
                displayMessage({ text: "Error: Could not send message.", sender: 'ai' });
            } finally {
                sendButton.disabled = false;
            }
        }
        
        async function simulateAIResponse(userText) {
             const aiResponse = {
                text: `You said: "${userText}". As a demo AI, I'm just echoing your message.`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                sender: 'ai',
                uid: 'vern-ai-assistant'
            };
            
            try {
                const chatDocRef = db.collection('vern_chats').doc(currentUser.uid).collection('messages');
                await chatDocRef.add(aiResponse);
            } catch (error) {
                 console.error("Error sending AI message: ", error);
            }
        }

        function listenForMessages() {
            if (!currentUser) return;
            if (unsubscribeChat) unsubscribeChat(); // Unsubscribe from previous listener

            const chatQuery = db.collection('vern_chats').doc(currentUser.uid).collection('messages').orderBy('timestamp', 'asc');
            
            unsubscribeChat = chatQuery.onSnapshot(snapshot => {
                // Clear existing messages to prevent duplicates on re-render
                chatContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    displayMessage(doc.data());
                });
                chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll to bottom
            }, error => {
                console.error("Error listening to messages: ", error);
                displayMessage({ text: "Error: Could not load chat history.", sender: 'ai' });
            });
        }

        function displayMessage(message) {
            const messageWrapper = document.createElement('div');
            const isUser = message.sender === 'user';
            
            messageWrapper.className = `flex items-start gap-3 my-4 message-bubble ${isUser ? 'justify-end user-message' : 'ai-message'}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-white';
            avatar.textContent = isUser ? (currentUser.displayName || 'U').charAt(0).toUpperCase() : 'V';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'max-w-lg';
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `px-4 py-2 rounded-lg ${isUser ? 'bg-purple-600 text-white' : 'bg-white text-gray-700 shadow-sm'}`;
            messageBubble.textContent = message.text;
            
            const timestamp = document.createElement('p');
            timestamp.className = `text-xs mt-1 ${isUser ? 'text-right text-gray-400' : 'text-left text-gray-500'}`;
            timestamp.textContent = message.timestamp ? new Date(message.timestamp.seconds * 1000).toLocaleTimeString() : 'Sending...';

            messageContent.appendChild(messageBubble);
            messageContent.appendChild(timestamp);

            if (isUser) {
                messageWrapper.appendChild(messageContent);
                messageWrapper.appendChild(avatar);
            } else {
                messageWrapper.appendChild(avatar);
                messageWrapper.appendChild(messageContent);
            }

            chatContainer.appendChild(messageWrapper);
        }

        // --- Event Listeners ---
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check for firebase config
            if (typeof firebaseConfig === 'undefined') {
                chatContainer.innerHTML = '<div class="text-center text-red-500 p-4">Firebase configuration is missing. Please check your `firebase-config.js` file.</div>';
                sendButton.disabled = true;
                messageInput.disabled = true;
                return;
            }
            firebase.initializeApp(firebaseConfig);
            setupAuth();
        });
    </script>
</body>
</html>
