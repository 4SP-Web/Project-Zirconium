<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - Vern AI</title>
  <!-- As requested, linking to your external stylesheet. Inline styles are also included to match notes.html -->
  <link rel="stylesheet" href="../css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <!-- Marked.js library to render Markdown from the AI's response -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* --- Base styles copied from notes.html for consistency --- */
    @font-face {
      font-family: 'PrimaryFont';
      src: url('https://fonts.gstatic.com/s/roboto/v27/KFOmCnqEu92Fr1Mu4mxK.woff2') format('woff2');
      font-weight: normal;
    }
    @font-face {
      font-family: 'SecondaryFont';
      src: url('https://fonts.gstatic.com/s/roboto/v27/KFOlCnqEu92Fr1MmEU9fBBc4.woff2') format('woff2');
      font-weight: 300;
    }
    body {
        margin: 0;
        font-family: 'PrimaryFont', sans-serif;
        background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
    }
    .main-header {
        background: #fff;
        padding: 10px 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        position: sticky;
        top: 0;
    }
    .main-header .container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1400px;
        margin: 0 auto;
    }
    .logo img { height: 40px; width: auto; }
    .auth-buttons .btn {
        background: none; border: 2px solid #6720bd; color: #6720bd;
        padding: 8px 15px; border-radius: 20px; cursor: pointer;
        transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif;
        text-transform: uppercase; font-weight: bold; margin-left: 10px;
    }
    .auth-buttons .btn:hover { background: #6720bd; color: white; }

    /* --- Dashboard Layout --- */
    .dashboard-page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
    }
    .dashboard-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* --- Sidebar --- */
    .sidebar {
      width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
      color: #fff; padding: 20px 10px; display: flex; flex-direction: column;
      border-right: 1px solid #444; transition: width 0.5s ease-in-out;
      position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); flex-shrink: 0;
    }
    .sidebar.collapsed { width: 85px; }
    #toggleSidebar {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      background: none; border: none; color: #fff; font-size: 1.2em;
      cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out;
    }
    .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
    .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
    .sidebar nav li { margin-bottom: 10px; }
    .sidebar nav a {
      display: flex; align-items: center; padding: 12px 15px; color: #fff;
      text-decoration: none; border-radius: 8px; transition: all 0.3s ease;
      font-family: 'PrimaryFont', sans-serif; text-transform: uppercase;
      position: relative; overflow: hidden;
    }
    .sidebar nav a.active, .sidebar nav a:hover {
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      transform: translateX(5px);
    }
    .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
    .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
    .sidebar.collapsed nav a { justify-content: center; padding: 10px 0; }
    .sidebar.collapsed nav a .label { display: none; }
    .user-info {
      text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555;
      padding-bottom: 20px; overflow: hidden;
    }
    .marquee-container {
      overflow: hidden; white-space: nowrap; position: relative;
      width: 100%; height: 1.8em; line-height: 1.8em;
    }
    .marquee-content {
      display: inline-block; padding-left: 100%; animation: scroll-left 12s linear infinite;
    }
    @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    .user-info .username {
      font-family: 'PrimaryFont', sans-serif; font-size: 1.3em; margin-bottom: 8px;
      line-height: 0.2em; font-weight: bold;
    }
    .user-info .email {
      font-family: 'SecondaryFont', sans-serif; font-size: 0.9em; color: #bbb;
    }

    /* --- Main Content --- */
    .main-content {
      flex: 1;
      background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
      position: relative;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 62px); /* Full height minus header */
      padding: 30px;
      box-sizing: border-box;
    }
    .dashboard-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 25px; background: white; padding: 20px 30px;
      border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid rgba(103, 32, 189, 0.1); flex-shrink: 0;
    }
    .dashboard-title {
      margin: 0; font-size: 2.0em; font-weight: bold;
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    
    /* --- Vern AI Chat Styles --- */
    .chat-container {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        overflow: hidden;
        position: relative;
    }
    #chat-messages {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .message {
        max-width: 80%;
        padding: 10px 15px;
        border-radius: 18px;
        line-height: 1.5;
        word-wrap: break-word;
    }
    .message.user-message {
        background-color: #6720bd;
        color: white;
        border-bottom-right-radius: 4px;
        align-self: flex-end;
        margin-left: auto;
    }
    .message.model-message {
        background-color: #e9e9eb;
        color: #333;
        border-bottom-left-radius: 4px;
        align-self: flex-start;
    }
    .model-message p:first-child { margin-top: 0; }
    .model-message p:last-child { margin-bottom: 0; }
    .model-message pre {
        background-color: #2d2d2d;
        color: #f8f8f2;
        padding: 10px;
        border-radius: 8px;
        overflow-x: auto;
    }
    .model-message code {
        font-family: 'Courier New', Courier, monospace;
    }
    .message.thinking-message {
        align-self: flex-start;
        color: #555;
        font-style: italic;
    }
    .chat-input-area {
        display: flex;
        padding: 15px;
        border-top: 1px solid #ddd;
        background-color: #f9f9f9;
        gap: 10px;
    }
    #userInput {
        flex-grow: 1;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 20px;
        font-size: 1em;
        resize: none;
    }
    #send-button {
        background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
        border: none;
        color: #fff;
        padding: 0 20px;
        border-radius: 20px;
        font-family: 'PrimaryFont', sans-serif;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1em;
        font-weight: 600;
    }
    #send-button:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(103, 32, 189, 0.3);
    }
    #send-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    #statusMessages {
        padding: 10px;
        margin-top: 10px;
        border-radius: 5px;
        font-size: 0.9em;
        text-align: center;
        display: none;
    }
    .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
    .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
    .status-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;}

    /* Animations */
    .fade-in { animation: fadeInGeneral 0.5s ease-out; }
    @keyframes fadeInGeneral { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .slide-in { animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>

<body class="dashboard-page">
  <header class="main-header light-bg">
    <div class="container">
      <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo"></a></div>
      <div class="auth-buttons"><button id="logoutBtn" class="btn">LOG OUT</button></div>
    </div>
  </header>

  <div class="dashboard-container">
    <aside class="sidebar slide-in" id="sidebar">
      <button id="toggleSidebar">‚ò∞</button>
      <div class="user-info">
        <div class="marquee-container"><span id="userName" class="marquee-content username">Loading‚Ä¶</span></div>
        <div class="marquee-container"><span id="userEmail" class="marquee-content email">Loading‚Ä¶</span></div>
      </div>
      <nav>
        <ul>
          <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
          <li><a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">Proxies</span></a></li>
          <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
          <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
          <li><a href="others.html" class="active"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
          <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
          <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content fade-in">
      <div class="dashboard-header">
        <h2 class="dashboard-title">VERN AI</h2>
      </div>

      <div class="chat-container">
        <div id="chat-messages">
          <!-- Messages will be dynamically inserted here -->
        </div>
        <div class="chat-input-area">
          <textarea id="userInput" placeholder="Ask Vern AI anything..." rows="1"></textarea>
          <button id="send-button" disabled>Send</button>
        </div>
      </div>
      <div id="statusMessages"></div>
    </main>
  </div>

  <script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    
    // This file should define a `firebaseConfig` object.
    import { firebaseConfig } from "../firebase-config.js";

    // --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DOM Elements ---
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('send-button');
    const chatMessages = document.getElementById('chat-messages');
    const statusMessagesEl = document.getElementById('statusMessages');
    const userNameEl = document.getElementById('userName');
    const userEmailEl = document.getElementById('userEmail');

    // --- Global State ---
    let currentUser = null;
    let geminiApiKey = null;
    let chatHistory = [];
    let chatDocUnsubscribe = null;

    // --- UI Functions ---
    const showStatus = (message, type = 'info', duration = 4000) => {
        statusMessagesEl.textContent = message;
        statusMessagesEl.className = `status-${type}`;
        statusMessagesEl.style.display = 'block';
        if (duration) setTimeout(() => statusMessagesEl.style.display = 'none', duration);
    };

    const scrollToBottom = () => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };
    
    const displayMessage = (role, text, isThinking = false) => {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        
        if (isThinking) {
             messageDiv.classList.add('thinking-message');
             messageDiv.innerHTML = '<i>Vern is thinking...</i>';
             messageDiv.id = 'thinking-bubble';
        } else {
            messageDiv.classList.add(role === 'user' ? 'user-message' : 'model-message');
            messageDiv.innerHTML = role === 'model' ? marked.parse(text) : text;
        }

        const oldThinkingBubble = document.getElementById('thinking-bubble');
        if (oldThinkingBubble && !isThinking) {
            oldThinkingBubble.remove();
        }

        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    };

    const renderChatHistory = (history) => {
        chatMessages.innerHTML = '';
        history.forEach(item => displayMessage(item.role, item.parts[0].text));
        if (history.length === 0) {
            displayMessage('model', 'Hello! How can I help you today?');
        }
    };
    
    // --- Core Logic ---

    const fetchApiKey = async () => {
        try {
            const configRef = doc(db, 'config', 'gemini-api');
            const docSnap = await getDoc(configRef);
            if (docSnap.exists() && docSnap.data().APIkey) {
                geminiApiKey = docSnap.data().APIkey;
                sendButton.disabled = false;
                showStatus('Vern AI is ready!', 'success');
            } else {
                showStatus('Error: API Key not found in Firestore.', 'error', null);
            }
        } catch (error) {
            showStatus('Error: Failed to fetch API key.', 'error', null);
            console.error("Error fetching API key:", error);
        }
    };

    // UPDATED: Now points to the 'vernAiChats' collection
    const listenToChatHistory = (userId) => {
        if (chatDocUnsubscribe) chatDocUnsubscribe();
        
        const chatDocRef = doc(db, 'vernAiChats', userId);
        chatDocUnsubscribe = onSnapshot(chatDocRef, (docSnap) => {
            if (docSnap.exists() && docSnap.data().history) {
                chatHistory = docSnap.data().history;
            } else {
                chatHistory = []; // Start fresh if no history exists
            }
            renderChatHistory(chatHistory);
        }, (error) => {
            console.error("Error listening to chat history:", error);
            showStatus("Couldn't load chat history.", "error");
        });
    };

    const callGeminiApi = async (prompt) => {
        if (!geminiApiKey) {
            showStatus('API Key not available.', 'error');
            return;
        }

        displayMessage('user', prompt);
        displayMessage('model', '', true);
        sendButton.disabled = true;
        userInput.disabled = true;

        const apiEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`;

        const fullChatHistory = [...chatHistory, { role: 'user', parts: [{ text: prompt }] }];

        try {
            const response = await fetch(apiEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: fullChatHistory })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            const modelResponse = result.candidates[0].content.parts[0].text;

            // UPDATED: Saves the new history to 'vernAiChats'
            const newHistory = [...fullChatHistory, { role: 'model', parts: [{ text: modelResponse }] }];
            const chatDocRef = doc(db, 'vernAiChats', currentUser.uid);
            await setDoc(chatDocRef, { history: newHistory });

        } catch (error) {
            console.error('Gemini API Error:', error);
            showStatus(`Error from Vern AI: ${error.message}`, 'error', 6000);
            const thinkingBubble = document.getElementById('thinking-bubble');
            if (thinkingBubble) thinkingBubble.remove();
            displayMessage('model', `Sorry, I encountered an error. Please try again.`);
        } finally {
            sendButton.disabled = false;
            userInput.disabled = false;
            userInput.focus();
        }
    };

    const handleSendMessage = () => {
        const prompt = userInput.value.trim();
        if (prompt && currentUser) {
            callGeminiApi(prompt);
            userInput.value = '';
            userInput.style.height = 'auto';
        }
    };

    // --- Auth & Event Listeners ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            userNameEl.textContent = user.displayName || user.email.split('@')[0];
            userEmailEl.textContent = user.email;
            await fetchApiKey();
            listenToChatHistory(user.uid);
        } else {
            currentUser = null;
            if (chatDocUnsubscribe) chatDocUnsubscribe();
            geminiApiKey = null;
            userNameEl.textContent = 'Not Logged In';
            userEmailEl.textContent = 'Please log in';
            chatMessages.innerHTML = '';
            displayMessage('model', 'Please log in to start chatting with Vern AI.');
            sendButton.disabled = true;
        }
    });

    sendButton.addEventListener('click', handleSendMessage);
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSendMessage();
        }
    });
    userInput.addEventListener('input', () => {
        userInput.style.height = 'auto';
        userInput.style.height = (userInput.scrollHeight) + 'px';
    });
    
    const handleLogout = () => signOut(auth).catch(err => console.error('Logout error:', err));
    document.getElementById('logoutBtn').onclick = handleLogout;
    document.getElementById('signOutLink').onclick = handleLogout;

    document.getElementById('toggleSidebar').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('collapsed');
    });

  </script>
</body>
</html>
