<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - VERN SOCIAL</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* --- Base Layout --- */
        :root { --accent-color: #8a2be2; --accent-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); }
        html, body { height: 100%; margin: 0; font-family: 'PrimaryFont', sans-serif; background-color: #f0f2f5; overflow: hidden; }
        .dashboard-page { display: flex; flex-direction: column; height: 100%; }
        .main-header { flex-shrink: 0; }
        .dashboard-container { display: flex; flex: 1; min-height: 0; }

        /* --- Desktop Sidebar --- */
        .sidebar { width: 280px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; display: flex; flex-direction: column; border-right: 1px solid #444; flex-shrink: 0; transition: width 0.3s ease-in-out; }
        .user-info { text-align: center; padding: 20px 10px; border-bottom: 1px solid #555; }
        .user-info .username { font-size: 1.2em; font-weight: bold; }
        .social-sidebar-content { flex-grow: 1; overflow-y: auto; }
        .sidebar-section { padding: 15px; border-bottom: 1px solid #444; }
        .sidebar-section h2 { font-size: 1em; text-transform: uppercase; color: #aaa; margin: 0 0 10px 0; display: flex; align-items: center; justify-content: space-between; }
        .sidebar-section h2 .badge { background-color: var(--accent-color); color: white; font-size: 0.8em; padding: 2px 6px; border-radius: 8px; }
        .sidebar-section input[type="text"] { width: 100%; background: #555; border: 1px solid #666; color: #fff; padding: 8px; border-radius: 5px; box-sizing: border-box; }
        .item-list { list-style: none; padding: 0; margin: 0; }
        .item-list li { display: flex; align-items: center; justify-content: space-between; padding: 8px 5px; border-radius: 5px; transition: background-color 0.2s; }
        .item-list li:hover:not(.empty-state) { background-color: #3a3a3a; }
        .item-list .item-name { cursor: pointer; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-list .item-actions button { background: none; border: none; color: #ccc; cursor: pointer; font-size: 0.9em; padding: 4px; border-radius: 3px; }
        .item-list .item-actions button:hover { color: #fff; }
        .item-list .empty-state { color: #888; font-style: italic; padding: 10px 5px; }
        #friendsList .item-name.active-chat { color: var(--accent-color); font-weight: bold; }
        
        /* --- Chat Area (Desktop) --- */
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        .chat-wrapper { flex-grow: 1; display: flex; flex-direction: column; background: #fff; margin: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .chat-placeholder { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: #aaa; padding: 20px; }
        .chat-placeholder i { font-size: 4em; margin-bottom: 20px; }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-size: 1.2em; font-weight: bold; color: #333; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        #chatSettingsBtn { background: none; border: none; font-size: 1.2em; color: #888; cursor: pointer; }
        .messages-container { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .message { display: flex; margin-bottom: 15px; max-width: 70%; position: relative; }
        .message-content { padding: 10px 15px; border-radius: 15px; line-height: 1.4; word-break: break-word; }
        .message.sent { margin-left: auto; flex-direction: row-reverse; }
        .message.sent .message-content { background: var(--accent-gradient); color: white; border-bottom-right-radius: 3px; }
        .message.received { margin-right: auto; }
        .message.received .message-content { background: #e9e9eb; color: #333; border-bottom-left-radius: 3px; }
        .message .unsend-btn { display: none; background: none; border: none; position: absolute; top: 50%; transform: translateY(-50%); cursor: pointer; opacity: 0.7; font-size: 1.1em; }
        .message.sent:hover .unsend-btn { display: block; left: -25px; color: #aaa; }
        .message.sent:hover .unsend-btn:hover { color: #f44336; }
        .chat-footer { padding: 15px; border-top: 1px solid #eee; flex-shrink: 0; }
        #messageForm { display: flex; gap: 10px; align-items: center; }
        #messageInput { flex-grow: 1; border: 1px solid #ddd; border-radius: 20px; padding: 10px 15px; font-size: 1em; resize: none; max-height: 120px; font-family: 'SecondaryFont', sans-serif; }
        #charCounter { font-size: 0.8em; color: #aaa; }
        #sendMessageBtn { background: var(--accent-gradient); color: white; border: none; border-radius: 50%; width: 42px; height: 42px; font-size: 1.2em; cursor: pointer; flex-shrink: 0; }
        #sendMessageBtn:disabled { background: #ccc; }

        /* --- Mobile Layout --- */
        .mobile-nav, .mobile-page-container, .main-mobile-view { display: none; }

        @media (max-width: 768px) {
            .main-header, .sidebar, .chat-area { display: none; }
            .dashboard-container { flex-direction: column; }
            .mobile-nav { display: flex; justify-content: space-around; align-items: center; background: #2a2a2a; color: white; position: fixed; bottom: 0; left: 0; right: 0; height: 60px; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); }
            .mobile-nav button { background: none; border: none; color: #aaa; font-size: 1.5em; flex-grow: 1; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px 0; }
            .mobile-nav button .nav-label { font-size: 0.5em; margin-top: 4px; }
            .mobile-nav button.active { color: var(--accent-color); }
            
            .mobile-page-container { display: block; position: fixed; top: 0; left: 0; right: 0; bottom: 60px; background: #fff; z-index: 999; transform: translateX(100%); transition: transform 0.3s ease-in-out; overflow-y: auto; }
            .mobile-page-container.active { transform: translateX(0); }
            .mobile-page-header { background: #fff; padding: 15px; font-size: 1.2em; font-weight: bold; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 1; }
            .mobile-page-header .back-btn { background: none; border: none; font-size: 1.2em; cursor: pointer; }
            
            .main-mobile-view { display: flex; flex-direction: column; height: 100%; }
            .main-mobile-view .chat-wrapper { margin: 0; border-radius: 0; flex-grow: 1; }
            .main-mobile-view .chat-placeholder { padding-bottom: 60px; }
            .main-mobile-view .chat-footer { margin-bottom: 60px; }
        }

        /* --- Modal Styles --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1001; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; transform: scale(0.95); transition: transform 0.3s; }
        .modal.active .modal-content { transform: scale(1); }
        .modal h3 { margin-top: 0; }
        .modal .form-group { margin-bottom: 15px; }
        .modal label { display: block; margin-bottom: 5px; font-size: 0.9em; color: #555; }
        .modal input, .modal select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .modal-actions { margin-top: 20px; text-align: right; }
        .modal-actions button { padding: 8px 15px; border-radius: 5px; border: none; cursor: pointer; margin-left: 10px; }
        .modal-actions .btn-secondary { background: #ccc; }
        .modal-actions .btn-primary { background: var(--accent-gradient); color: #fff; }

        .hidden { display: none !important; }
    </style>
</head>

<body class="dashboard-page">

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo"/></a></div>
            <div class="auth-buttons"><button id="logoutBtn" class="btn btn-login">LOG OUT</button></div>
        </div>
    </header>

    <!-- DESKTOP VIEW -->
    <div class="dashboard-container">
        <aside class="sidebar" id="desktopSidebar">
            <div class="user-info">
                <p class="username" id="userName">Loading...</p>
                <p class="email" id="userEmail">...</p>
            </div>
            <div class="social-sidebar-content">
                <div class="sidebar-section">
                    <h2><i class="fas fa-search"></i> <span>Find Users</span></h2>
                    <input type="text" id="userSearchInput" placeholder="Search by exact username...">
                    <ul id="userSearchResults" class="item-list"></ul>
                </div>
                <div class="sidebar-section">
                    <h2><i class="fas fa-user-plus"></i> <span>Requests</span><span id="requestsCountBadge" class="badge hidden">0</span></h2>
                    <ul id="friendRequestsList" class="item-list"><li class="empty-state">No new requests.</li></ul>
                </div>
                <div class="sidebar-section">
                    <h2><i class="fas fa-users"></i> <span>Friends</span></h2>
                    <ul id="friendsList" class="item-list"><li class="empty-state">No friends yet.</li></ul>
                </div>
            </div>
        </aside>

        <main class="chat-area">
            <div class="chat-placeholder" id="desktopChatPlaceholder">
                <i class="fas fa-comments"></i>
                <h2>Welcome to Vern Social</h2>
                <p>Select a friend to start chatting.</p>
            </div>
            <div class="chat-wrapper hidden" id="chatWrapper">
                <div class="chat-header" id="chatHeader"></div>
                <div class="messages-container" id="messagesContainer"></div>
                <div class="chat-footer">
                    <form id="messageForm">
                        <textarea id="messageInput" placeholder="Type a message..." rows="1" maxlength="2000" disabled></textarea>
                        <div id="charCounter">0/2000</div>
                        <button type="submit" id="sendMessageBtn" disabled><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- MOBILE VIEW -->
    <div class="main-mobile-view">
        <div class="chat-placeholder" id="mobileChatPlaceholder">
            <i class="fas fa-comments"></i>
            <h2>Select a Friend</h2>
            <p>Tap the friends icon to begin.</p>
        </div>
        <div class="chat-wrapper hidden" id="mobileChatWrapper">
             <!-- Mobile chat header, messages, and footer will be dynamically cloned here -->
        </div>
    </div>

    <div class="mobile-page-container" id="mobileFriendsPage">
        <div class="mobile-page-header"><button class="back-btn" data-target="friends"><i class="fas fa-arrow-left"></i></button> Friends</div>
        <div class="sidebar-section" style="border-top: 1px solid #eee;">
            <ul id="mobileFriendsList" class="item-list"></ul>
        </div>
    </div>
    <div class="mobile-page-container" id="mobileRequestsPage">
        <div class="mobile-page-header"><button class="back-btn" data-target="requests"><i class="fas fa-arrow-left"></i></button> Friend Requests</div>
        <div class="sidebar-section" style="border-top: 1px solid #eee;">
            <ul id="mobileRequestsList" class="item-list"></ul>
        </div>
    </div>
     <div class="mobile-page-container" id="mobileSearchPage">
        <div class="mobile-page-header"><button class="back-btn" data-target="search"><i class="fas fa-arrow-left"></i></button> Search Users</div>
        <div class="sidebar-section" style="border-top: 1px solid #eee;">
            <input type="text" id="mobileUserSearchInput" placeholder="Search by exact username...">
            <ul id="mobileUserSearchResults" class="item-list"></ul>
        </div>
    </div>

    <nav class="mobile-nav">
        <button id="navChatBtn" class="active"><i class="fas fa-comments"></i> <span class="nav-label">Chat</span></button>
        <button id="navFriendsBtn"><i class="fas fa-users"></i> <span class="nav-label">Friends</span></button>
        <button id="navRequestsBtn"><i class="fas fa-user-plus"></i> <span class="nav-label">Requests</span></button>
        <button id="navSearchBtn"><i class="fas fa-search"></i> <span class="nav-label">Search</span></button>
    </nav>
    
    <!-- MODALS -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3>Chat Settings</h3>
            <div class="form-group">
                <label for="nicknameInput">Nickname for this friend</label>
                <input type="text" id="nicknameInput" placeholder="Enter a nickname" maxlength="50">
            </div>
            <div class="form-group">
                <label for="deleteSettingsSelect">Auto-hide messages after</label>
                <select id="deleteSettingsSelect">
                    <option value="never">Never</option>
                    <option value="1">1 Day</option>
                    <option value="3">3 Days</option>
                    <option value="7">7 Days</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" id="cancelSettingsBtn">Cancel</button>
                <button type="button" class="btn-primary" id="saveSettingsBtn">Save</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
        // --- DOM Elements ---
        const desktopSidebar = document.getElementById('desktopSidebar');
        const userNameEl = document.getElementById('userName');
        const userEmailEl = document.getElementById('userEmail');
        const userSearchInput = document.getElementById('userSearchInput');
        const userSearchResultsEl = document.getElementById('userSearchResults');
        const requestsCountBadge = document.getElementById('requestsCountBadge');
        const friendsListEl = document.getElementById('friendsList');
        const friendRequestsListEl = document.getElementById('friendRequestsList');
        
        const desktopChatPlaceholder = document.getElementById('desktopChatPlaceholder');
        const chatWrapper = document.getElementById('chatWrapper');
        const chatHeaderEl = document.getElementById('chatHeader');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const charCounter = document.getElementById('charCounter');
        
        // Mobile elements
        const mainMobileView = document.querySelector('.main-mobile-view');
        const mobileNav = document.querySelector('.mobile-nav');
        const mobilePages = document.querySelectorAll('.mobile-page-container');
        const mobileFriendsPage = document.getElementById('mobileFriendsPage');
        const mobileRequestsPage = document.getElementById('mobileRequestsPage');
        const mobileSearchPage = document.getElementById('mobileSearchPage');
        const mobileFriendsList = document.getElementById('mobileFriendsList');
        const mobileRequestsList = document.getElementById('mobileRequestsList');
        const mobileUserSearchInput = document.getElementById('mobileUserSearchInput');
        const mobileUserSearchResults = document.getElementById('mobileUserSearchResults');
        
        // Settings Modal
        const settingsModal = document.getElementById('settingsModal');
        const nicknameInput = document.getElementById('nicknameInput');
        const deleteSettingsSelect = document.getElementById('deleteSettingsSelect');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');

        // --- Global State ---
        let currentUser, currentUserProfile;
        let userCache = {};
        let friendSettings = {}; // In-memory cache for { friendId: { nickname, deleteAfterDays } }
        let activeChatId = null;
        let friendsUnsubscribe = () => {}, requestsUnsubscribe = () => {}, chatUnsubscribe = () => {}, settingsUnsubscribe = () => {};

        // --- Auth & Initialization ---
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await setupUserProfile();
                setupListeners();
                checkAuthAndRun();
            } else {
                window.location.href = '../login.html';
            }
        });
        
        async function setupUserProfile() {
            const userDocRef = firebase.firestore().collection('users').doc(currentUser.uid);
            const userDoc = await userDocRef.get();
            if (!userDoc.exists) {
                const newUsername = `user_${currentUser.uid.substring(0, 6)}`;
                await userDocRef.set({
                    username: newUsername, email: currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    friends: [], blocked: [],
                });
            }
        }

        function checkAuthAndRun() {
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                setupMobileView();
            } else {
                 document.querySelector('.main-mobile-view').style.display = 'none';
                 document.querySelector('.mobile-nav').style.display = 'none';
            }
        }

        function setupListeners() {
            friendsUnsubscribe(); requestsUnsubscribe(); settingsUnsubscribe();
            
            // Listen for profile changes (friends, blocked)
            friendsUnsubscribe = firebase.firestore().collection('users').doc(currentUser.uid).onSnapshot(doc => {
                currentUserProfile = doc.data();
                userCache[currentUser.uid] = currentUserProfile.username;
                userNameEl.textContent = currentUserProfile.username;
                userEmailEl.textContent = currentUserProfile.email;
                renderFriendsList();
            });

            // Listen for incoming friend requests
            requestsUnsubscribe = firebase.firestore().collection('friend_requests').where('receiverId', '==', currentUser.uid).onSnapshot(snapshot => {
                const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFriendRequests(requests);
            });
            
            // Listen for friend settings changes
            settingsUnsubscribe = firebase.firestore().collection('friend_settings').doc(currentUser.uid).onSnapshot(doc => {
                friendSettings = doc.exists ? doc.data() : {};
                if(activeChatId) updateChatHeader();
                renderFriendsList(); 
            });
        }
        
        // --- Rendering ---
        async function fetchUsernames(uids) {
            const uidsToFetch = uids.filter(uid => !userCache[uid]);
            if (uidsToFetch.length === 0) return Promise.resolve();
            const usersRef = firebase.firestore().collection('users');
            const promises = [];
            for (let i = 0; i < uidsToFetch.length; i += 10) {
                const chunk = uidsToFetch.slice(i, i + 10);
                promises.push(usersRef.where(firebase.firestore.FieldPath.documentId(), 'in', chunk).get());
            }
            const snapshots = await Promise.all(promises);
            snapshots.forEach(snapshot => snapshot.forEach(doc => userCache[doc.id] = doc.data().username));
        }

        function getDisplayName(uid) {
            return friendSettings[uid]?.nickname || userCache[uid] || 'Loading...';
        }

        async function renderFriendsList() {
            const friendUids = currentUserProfile?.friends || [];
            await fetchUsernames(friendUids);
            
            const createFriendLi = (uid) => {
                const li = document.createElement('li');
                li.dataset.uid = uid;
                li.innerHTML = `<span class="item-name">${getDisplayName(uid)}</span>`;
                li.querySelector('.item-name').onclick = () => openChat(uid);
                if (uid === activeChatId) li.querySelector('.item-name').classList.add('active-chat');
                return li;
            };

            friendsListEl.innerHTML = '';
            mobileFriendsList.innerHTML = '';

            if (friendUids.length === 0) {
                const emptyState = '<li class="empty-state">No friends yet.</li>';
                friendsListEl.innerHTML = emptyState;
                mobileFriendsList.innerHTML = emptyState;
                return;
            }
            friendUids.forEach(uid => {
                friendsListEl.appendChild(createFriendLi(uid));
                mobileFriendsList.appendChild(createFriendLi(uid));
            });
        }
        
        async function renderFriendRequests(requests) {
             const createRequestLi = (req) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="item-name">${userCache[req.senderId] || '...'}</span>
                    <div class="item-actions">
                        <button title="Accept" onclick="acceptFriendRequest('${req.id}', '${req.senderId}')"><i class="fas fa-check"></i></button>
                        <button title="Decline" onclick="deleteFriendRequest('${req.id}')"><i class="fas fa-times"></i></button>
                    </div>`;
                return li;
            };

            requestsCountBadge.textContent = requests.length;
            requestsCountBadge.classList.toggle('hidden', requests.length === 0);
            
            friendRequestsListEl.innerHTML = '';
            mobileRequestsList.innerHTML = '';

            if(requests.length === 0) {
                const emptyState = '<li class="empty-state">No new requests.</li>';
                friendRequestsListEl.innerHTML = emptyState;
                mobileRequestsList.innerHTML = emptyState;
                return;
            }

            await fetchUsernames(requests.map(r => r.senderId));
            requests.forEach(req => {
                friendRequestsListEl.appendChild(createRequestLi(req));
                mobileRequestsList.appendChild(createRequestLi(req));
            });
        }
        
        // --- Social Actions ---
        async function handleUserSearch(inputEl, resultsEl) {
            const searchTerm = inputEl.value.trim();
            resultsEl.innerHTML = '';
            if (searchTerm.length < 3) return;
            resultsEl.innerHTML = '<li class="empty-state">Searching...</li>';
            
            const q = firebase.firestore().collection('users').where('username', '==', searchTerm);
            const snapshot = await q.get();

            if (snapshot.empty) {
                resultsEl.innerHTML = '<li class="empty-state">No users found.</li>';
                return;
            }
            snapshot.forEach(doc => {
                if (doc.id === currentUser.uid) return;
                const userData = doc.data();
                const isFriend = currentUserProfile.friends.includes(doc.id);

                const li = document.createElement('li');
                li.innerHTML = `<span class="item-name">${userData.username}</span>`;
                if (!isFriend) {
                    const actions = document.createElement('div');
                    actions.className = 'item-actions';
                    actions.innerHTML = `<button title="Add" onclick="sendFriendRequest('${doc.id}')"><i class="fas fa-user-plus"></i></button>`;
                    li.appendChild(actions);
                }
                resultsEl.appendChild(li);
            });
        }
        
        // --- Chat & Messaging ---
        function updateChatHeader() {
            const settingsBtn = document.createElement('button');
            settingsBtn.id = 'chatSettingsBtn';
            settingsBtn.innerHTML = '<i class="fas fa-cog"></i>';
            settingsBtn.onclick = () => openSettingsModal();
            
            chatHeaderEl.innerHTML = `<span>${getDisplayName(activeChatId)}</span>`;
            chatHeaderEl.appendChild(settingsBtn);
        }

        async function openChat(friendId) {
            if (activeChatId === friendId && !chatWrapper.classList.contains('hidden')) return;
            
            activeChatId = friendId;
            chatUnsubscribe();
            await fetchUsernames([friendId]);
            
            updateChatHeader();
            messagesContainer.innerHTML = '<li class="empty-state">Loading...</li>';
            
            const targetWrapper = window.innerWidth <= 768 ? document.getElementById('mobileChatWrapper') : chatWrapper;
            const targetPlaceholder = window.innerWidth <= 768 ? document.getElementById('mobileChatPlaceholder') : desktopChatPlaceholder;
            
            targetPlaceholder.classList.add('hidden');
            targetWrapper.classList.remove('hidden');

            messageInput.disabled = false;
            sendMessageBtn.disabled = false;
            
            renderFriendsList(); // To update active chat highlight
            
            const chatId = [currentUser.uid, friendId].sort().join('_');
            const messagesRef = firebase.firestore().collection('chats').doc(chatId).collection('messages').orderBy('createdAt', 'asc');
            
            chatUnsubscribe = messagesRef.onSnapshot(snapshot => {
                messagesContainer.innerHTML = '';
                const retentionDays = friendSettings[activeChatId]?.deleteAfterDays;
                const now = new Date();
                
                snapshot.docs.forEach(doc => {
                    const msg = doc.data();
                    const msgDate = msg.createdAt?.toDate();
                    if(retentionDays && retentionDays !== 'never') {
                        const cutoff = new Date(now.setDate(now.getDate() - parseInt(retentionDays)));
                        if (msgDate < cutoff) return; // Skip rendering old message
                    }
                    renderMessage(doc.id, msg);
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }
        
        function renderMessage(id, msg) {
             const msgDiv = document.createElement('div');
             msgDiv.className = `message ${msg.authorId === currentUser.uid ? 'sent' : 'received'}`;
             msgDiv.dataset.id = id;
             
             let content = msg.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
             
             let unsendBtn = msg.authorId === currentUser.uid 
                ? `<button class="unsend-btn" title="Unsend" onclick="unsendMessage('${id}')"><i class="fas fa-trash"></i></button>` 
                : '';

             msgDiv.innerHTML = `
                ${unsendBtn}
                <div class="message-content">${content}</div>`;
             messagesContainer.appendChild(msgDiv);
        }
        
        async function unsendMessage(messageId) {
            if (!activeChatId || !confirm("Are you sure you want to unsend this message?")) return;
            const chatId = [currentUser.uid, activeChatId].sort().join('_');
            await firebase.firestore().collection('chats').doc(chatId).collection('messages').doc(messageId).delete();
        }

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text || !activeChatId) return;
            messageInput.value = '';
            charCounter.textContent = '0/2000';
            const chatId = [currentUser.uid, activeChatId].sort().join('_');
            await firebase.firestore().collection('chats').doc(chatId).collection('messages').add({
                text: text, authorId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        });

        // --- Settings Modal ---
        function openSettingsModal() {
            if (!activeChatId) return;
            const settings = friendSettings[activeChatId] || {};
            nicknameInput.value = settings.nickname || '';
            deleteSettingsSelect.value = settings.deleteAfterDays || 'never';
            settingsModal.classList.add('active');
        }

        async function saveSettings() {
            const newNickname = nicknameInput.value.trim();
            const newDeleteSetting = deleteSettingsSelect.value;
            
            const settingsRef = firebase.firestore().collection('friend_settings').doc(currentUser.uid);
            await settingsRef.set({
                [activeChatId]: {
                    nickname: newNickname,
                    deleteAfterDays: newDeleteSetting
                }
            }, { merge: true });

            settingsModal.classList.remove('active');
        }

        // --- Mobile UI Logic ---
        function setupMobileView() {
            mainMobileView.innerHTML = '';
            mainMobileView.appendChild(document.getElementById('mobileChatPlaceholder'));
            const mobileChat = document.getElementById('mobileChatWrapper');
            mobileChat.appendChild(document.getElementById('chatHeader'));
            mobileChat.appendChild(document.getElementById('messagesContainer'));
            mobileChat.appendChild(document.getElementById('messageForm').parentElement);
            mainMobileView.appendChild(mobileChat);
            mainMobileView.style.display = 'flex';
            mobileNav.style.display = 'flex';
        }
        
        function switchMobilePage(pageId) {
            mobilePages.forEach(p => p.classList.remove('active'));
            if(pageId) document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.mobile-nav button').forEach(b => b.classList.remove('active'));
            if(pageId) document.querySelector(`#nav${pageId.replace('mobile', '').replace('Page', '')}Btn`)?.classList.add('active');
            else document.getElementById('navChatBtn').classList.add('active');
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
             // Search listeners for both views
            userSearchInput.addEventListener('input', () => handleUserSearch(userSearchInput, userSearchResultsEl));
            mobileUserSearchInput.addEventListener('input', () => handleUserSearch(mobileUserSearchInput, mobileUserSearchResults));
            
            // Mobile Nav
            navChatBtn.onclick = () => switchMobilePage(null);
            navFriendsBtn.onclick = () => switchMobilePage('mobileFriendsPage');
            navRequestsBtn.onclick = () => switchMobilePage('mobileRequestsPage');
            navSearchBtn.onclick = () => switchMobilePage('mobileSearchPage');
            document.querySelectorAll('.back-btn').forEach(b => b.onclick = () => switchMobilePage(null));

            // Settings Modal
            saveSettingsBtn.onclick = saveSettings;
            cancelSettingsBtn.onclick = () => settingsModal.classList.remove('active');

            // Character counter
            messageInput.addEventListener('input', () => {
                charCounter.textContent = `${messageInput.value.length}/2000`;
            });
            
            // Logout
            document.getElementById('logoutBtn').onclick = () => firebase.auth().signOut();
        });
        
        // --- Simple Action Functions (global for onclick) ---
        window.sendFriendRequest = async (receiverId) => {
            const requestsRef = firebase.firestore().collection('friend_requests');
            const [q1, q2] = await Promise.all([
                requestsRef.where('senderId', '==', currentUser.uid).where('receiverId', '==', receiverId).get(),
                requestsRef.where('senderId', '==', receiverId).where('receiverId', '==', currentUser.uid).get()
            ]);
            if (!q1.empty || !q2.empty) return alert("Request already exists.");
            await requestsRef.add({
                senderId: currentUser.uid, receiverId, status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert('Friend request sent!');
        };
        window.deleteFriendRequest = (reqId) => firebase.firestore().collection('friend_requests').doc(reqId).delete();
        window.acceptFriendRequest = async (reqId, senderId) => {
            const db = firebase.firestore();
            const batch = db.batch();
            batch.delete(db.collection('friend_requests').doc(reqId));
            batch.update(db.collection('users').doc(currentUser.uid), { friends: firebase.firestore.FieldValue.arrayUnion(senderId) });
            batch.update(db.collection('users').doc(senderId), { friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
            await batch.commit();
        };

    </script>
</body>
</html>
