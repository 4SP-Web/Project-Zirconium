<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VS (Vern Social) - 4SP</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* --- EMBEDDED CSS --- */
        /* Font Imports */
        @font-face {
            font-family: 'PrimaryFont';
            src: url('../fonts/primary.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'SecondaryFont';
            src: url('../fonts/secondary.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        /* Basic Resets & Global Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'PrimaryFont', sans-serif;
            line-height: 1.6; color: #333; background-color: #f0f2f5;
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }
        /* Main Header */
        .main-header {
            background-color: #fff; border-bottom: 1px solid #eee; display: flex;
            align-items: center; flex-shrink: 0; position: relative; z-index: 1001;
        }
        .main-header .container {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; height: 60px;
        }
        .logo img { height: 60px; width: auto; display: block; }
        .auth-buttons { display: flex; gap: 15px; align-items: center; }
        /* Buttons */
        .btn {
            display: inline-block; padding: 8px 18px; border-radius: 12px; font-weight: bold;
            cursor: pointer; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif;
            text-transform: uppercase; font-size: 0.9em;
        }
        .btn-login { background-color: transparent; color: #555; border: 1px solid #ccc; }
        .btn-login:hover { background-color: #eee; }
        /* Dashboard Container */
        .dashboard-container { display: flex; flex-grow: 1; overflow: hidden; }
        /* Sidebar */
        .sidebar {
            width: 220px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff;
            padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444;
            transition: width 0.4s ease; position: relative; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            flex-shrink: 0; z-index: 1000;
        }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: none;
            border: none; color: #fff; font-size: 1.3em; cursor: pointer; padding: 5px;
            transition: transform 0.4s ease;
        }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .user-info {
            text-align: center; margin: 70px 0 30px; border-bottom: 1px solid #555;
            padding-bottom: 20px; overflow: hidden;
        }
        .user-info .username {
            font-size: 1.3em; font-weight: bold; font-family: 'PrimaryFont', sans-serif;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .user-info .email {
            font-size: 0.9em; color: #bbb; font-family: 'SecondaryFont', sans-serif;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .sidebar nav { flex-grow: 1; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a {
            display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none;
            border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif;
            text-transform: uppercase; position: relative; overflow: hidden; font-weight: 600; cursor: pointer;
        }
        .sidebar nav a.active, .sidebar nav a:hover {
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            transform: translateX(5px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .sidebar nav a .icon { font-size: 1.3em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 15px; white-space: nowrap; transition: opacity 0.3s ease; }
        .sidebar.collapsed nav a { justify-content: center; }
        .sidebar.collapsed nav a .label { opacity: 0; display: none; }
        .request-badge {
            background-color: #dc3545; color: white; font-size: 0.7em; font-weight: bold;
            border-radius: 50%; width: 20px; height: 20px; display: flex;
            justify-content: center; align-items: center; margin-left: auto;
        }
        /* Main Content */
        .main-content {
            flex-grow: 1; display: flex; padding: 20px; gap: 20px; overflow: hidden;
        }
        .panel {
            background-color: #fff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .list-panel { width: 300px; flex-shrink: 0; }
        .chat-panel { flex-grow: 1; }
        .panel-header {
            padding: 15px 20px; border-bottom: 1px solid #eee; flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between;
        }
        .panel-header h3 { margin: 0; font-family: 'PrimaryFont', sans-serif; font-size: 1.4em; color: #333; }
        .search-container { padding: 10px 15px; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .search-container input {
            width: 100%; padding: 10px 15px; border-radius: 48px; border: 1px solid #ddd;
            font-family: 'SecondaryFont', sans-serif; font-size: 0.9em;
        }
        .item-list { list-style: none; padding: 10px; margin: 0; overflow-y: auto; flex-grow: 1; }
        .item-list-message { text-align: center; padding: 20px; color: #999; font-family: 'SecondaryFont', sans-serif; }
        .list-item { display: flex; align-items: center; padding: 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .list-item.active, .list-item:hover { background-color: #f0f2f5; }
        .list-item .avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; flex-shrink: 0; background-color: #e0e0e0; }
        .list-item .item-info { overflow: hidden; flex-grow: 1; }
        .list-item .item-name { font-weight: bold; font-family: 'PrimaryFont', sans-serif; color: #333; }
        .list-item .item-preview { font-size: 0.9em; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: 'SecondaryFont', sans-serif;}
        .list-item .item-actions { display: flex; gap: 8px; }
        .item-actions .btn-sm { padding: 4px 10px; font-size: 0.8em; border-radius: 8px; }
        .item-actions .btn-accept { background-color: #28a745; color: white; border: none; }
        .item-actions .btn-decline { background-color: #dc3545; color: white; border: none; }
        
        /* Chat Window */
        .chat-header { display: flex; align-items: center; padding: 12px 20px; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .message-area { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .message-wrapper { display: flex; flex-direction: column; margin-bottom: 15px; max-width: 70%; }
        .message-bubble { padding: 12px 18px; border-radius: 20px; line-height: 1.5; font-family: 'SecondaryFont', sans-serif; }
        .message-timestamp { font-size: 0.75em; color: #999; margin: 4px 15px 0; }
        .message-wrapper.sent { align-self: flex-end; align-items: flex-end; }
        .message-wrapper.sent .message-bubble { background-color: #6720bd; color: #fff; border-bottom-right-radius: 5px; }
        .message-wrapper.received { align-self: flex-start; align-items: flex-start; }
        .message-wrapper.received .message-bubble { background-color: #e9ecef; color: #333; border-bottom-left-radius: 5px; }
        .chat-input-area { padding: 15px 20px; border-top: 1px solid #eee; flex-shrink: 0; background-color: #f9f9f9; }
        .chat-input-area form { display: flex; align-items: center; gap: 10px; }
        #messageInput {
            flex-grow: 1; padding: 12px 20px; border-radius: 48px; border: 1px solid #ddd;
            font-size: 1em; font-family: 'SecondaryFont', sans-serif; resize: none;
        }
        #sendMessageBtn {
            background-color: #6720bd; color: #fff; border: none; border-radius: 50%; width: 48px;
            height: 48px; font-size: 1.2em; cursor: pointer; transition: background-color 0.2s; flex-shrink: 0;
        }
        #chat-placeholder {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; color: #aaa; text-align: center; font-family: 'PrimaryFont', sans-serif;
        }
        #chat-placeholder i { font-size: 4em; margin-bottom: 20px; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 1002;
        }
        .modal-overlay.visible { display: flex; }
        .modal-content {
            background: #fff; padding: 25px; border-radius: 16px; width: 90%; max-width: 500px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-title { font-size: 1.5em; font-family: 'PrimaryFont', sans-serif; }
        .modal-close-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #999; }
        .modal-body .info-group { margin-bottom: 15px; }
        .modal-body .info-group label { display: block; font-weight: bold; color: #555; font-size: 0.9em; margin-bottom: 5px; }
        .modal-body .info-group p, .modal-body .info-group input { font-size: 1em; color: #333; font-family: 'SecondaryFont', sans-serif; }
        .modal-body .info-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
        .disclaimer { font-size: 0.8em; color: #888; background-color: #f5f5f5; padding: 8px; border-radius: 8px; margin-top: 10px; }
        .modal-footer { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-danger { background-color: #dc3545; color: white; border: none; }

        /* Utility */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="container">
            <div class="logo">
                <a href="#"><img src="../images/logo-dark.png" alt="4SP Logo"></a>
            </div>
            <div class="auth-buttons">
                <button class="btn btn-login">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
            <div class="user-info">
                <div class="username" id="userName">Loading...</div>
                <div class="email" id="userEmail"></div>
            </div>
            <nav>
                <ul>
                    <li><a class="nav-link active" data-target="chats-panel"><i class="fa-solid fa-comments icon"></i><span class="label">Chats</span></a></li>
                    <li><a class="nav-link" data-target="friends-panel"><i class="fa-solid fa-user-friends icon"></i><span class="label">Friends</span></a></li>
                    <li><a class="nav-link" data-target="requests-panel"><i class="fa-solid fa-user-plus icon"></i><span class="label">Requests</span><span id="requests-badge" class="request-badge hidden">0</span></a></li>
                    <li><a class="nav-link" data-target="add-friends-panel"><i class="fa-solid fa-search icon"></i><span class="label">Add Friends</span></a></li>
                    <li><a class="nav-link" data-target="settings-panel"><i class="fa-solid fa-cog icon"></i><span class="label">Settings</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div id="chats-panel" class="panel list-panel"><div class="panel-header"><h3>Chats</h3></div><ul class="item-list" id="chat-list-items"><li class="item-list-message">No chats yet.</li></ul></div>
            <div id="friends-panel" class="panel list-panel hidden"><div class="panel-header"><h3>Friends</h3></div><ul class="item-list" id="friend-list-items"><li class="item-list-message">Your friends will appear here.</li></ul></div>
            <div id="requests-panel" class="panel list-panel hidden"><div class="panel-header"><h3>Friend Requests</h3></div><ul class="item-list" id="request-list-items"><li class="item-list-message">No new friend requests.</li></ul></div>
            <div id="settings-panel" class="panel list-panel hidden"><div class="panel-header"><h3>Settings</h3></div><ul class="item-list"><li class="list-item"><div class="item-info">Profile Settings</div></li></ul></div>
            
            <div id="add-friends-panel" class="panel list-panel hidden">
                <div class="panel-header"><h3>Add Friends</h3></div>
                <div class="search-container"><input type="search" id="userSearchInput" placeholder="Search by username..."></div>
                <ul class="item-list" id="user-search-results"></ul>
            </div>

            <div id="main-chat-panel" class="panel chat-panel">
                 <div id="chat-placeholder"><i class="fa-regular fa-comments"></i><h2>Select a chat to begin</h2></div>
                 <div id="chat-window" class="hidden">
                    <div class="chat-header" id="chat-window-header"></div>
                    <div class="message-area" id="message-area"></div>
                    <div class="chat-input-area"><form id="messageForm"><input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off"><button id="sendMessageBtn" type="submit"><i class="fa-regular fa-paper-plane"></i></button></form></div>
                </div>
            </div>
        </main>
    </div>

    <div id="friend-details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="friend-modal-username">Friend Details</h3>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-group">
                    <label>Email</label>
                    <p id="friend-modal-email"></p>
                </div>
                <div class="info-group">
                    <label>Date of Birth (Personal Note)</label>
                    <input type="text" id="friend-modal-dob" placeholder="Add a date...">
                </div>
                <p class="disclaimer">Note: The Date of Birth field is only visible to you and does not grant or restrict access to any features.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="remove-friend-btn">Remove Friend</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM ELEMENTS ---
            const sidebar = document.getElementById('sidebar');
            const toggleSidebarBtn = document.getElementById('toggleSidebar');
            const logoutBtn = document.getElementById('logoutBtn');
            const userNameEl = document.getElementById('userName');
            const userEmailEl = document.getElementById('userEmail');
            const userSearchInput = document.getElementById('userSearchInput');
            const userSearchResultsEl = document.getElementById('user-search-results');
            const requestListEl = document.getElementById('request-list-items');
            const friendListEl = document.getElementById('friend-list-items');
            const requestsBadgeEl = document.getElementById('requests-badge');
            const friendDetailsModal = document.getElementById('friend-details-modal');

            // --- APP STATE ---
            let currentUser = null;
            let db;
            let friends = [], requestsSent = [], requestsReceived = [];

            // --- AUTHENTICATION ---
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    db = firebase.firestore();
                    initializeApp(user);
                } else {
                    window.location.href = '../login.html';
                }
            });
            
            async function initializeApp(user) {
                setupEventListeners();
                listenForUserData(user.uid);
            }

            // --- REAL-TIME DATA LISTENERS ---
            function listenForUserData(userId) {
                db.collection('users').doc(userId).onSnapshot(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        userNameEl.textContent = userData.username || 'User';
                        userEmailEl.textContent = userData.email;
                        
                        friends = userData.friends || [];
                        requestsSent = userData.friendRequestsSent || [];
                        requestsReceived = userData.friendRequestsReceived || [];

                        updateFriendList();
                        updateRequestList();
                    }
                }, error => console.error("Error listening for user data:", error));
            }
            
            // --- UI RENDERING ---
            async function updateFriendList() {
                friendListEl.innerHTML = '';
                if (friends.length === 0) {
                    friendListEl.innerHTML = '<li class="item-list-message">Add some friends to get started!</li>';
                    return;
                }
                for (const friendId of friends) {
                    const doc = await db.collection('users').doc(friendId).get();
                    if (doc.exists) {
                        const friendData = doc.data();
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.dataset.friendId = doc.id;
                        li.innerHTML = `<img src="https://via.placeholder.com/50" alt="Avatar" class="avatar"><div class="item-info"><div class="item-name">${friendData.username}</div></div>`;
                        li.addEventListener('click', () => openFriendDetails(friendId, friendData));
                        friendListEl.appendChild(li);
                    }
                }
            }

            async function updateRequestList() {
                requestListEl.innerHTML = '';
                if (requestsReceived.length > 0) {
                    requestsBadgeEl.textContent = requestsReceived.length;
                    requestsBadgeEl.classList.remove('hidden');
                } else {
                    requestsBadgeEl.classList.add('hidden');
                    requestListEl.innerHTML = '<li class="item-list-message">No new friend requests.</li>';
                    return;
                }

                for (const requesterId of requestsReceived) {
                    const doc = await db.collection('users').doc(requesterId).get();
                    if (doc.exists) {
                        const requesterData = doc.data();
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.innerHTML = `
                            <img src="https://via.placeholder.com/50" alt="Avatar" class="avatar">
                            <div class="item-info"><div class="item-name">${requesterData.username}</div></div>
                            <div class="item-actions">
                                <button class="btn btn-sm btn-accept" data-id="${doc.id}">Accept</button>
                                <button class="btn btn-sm btn-decline" data-id="${doc.id}">Decline</button>
                            </div>`;
                        requestListEl.appendChild(li);
                    }
                }
            }

            // --- FRIEND & REQUEST ACTIONS ---
            async function handleUserSearch() {
                const searchTerm = userSearchInput.value.trim().toLowerCase();
                userSearchResultsEl.innerHTML = '';
                if (searchTerm.length < 3) return;

                const querySnapshot = await db.collection('users')
                    .where('username', '>=', searchTerm)
                    .where('username', '<=', searchTerm + '\uf8ff')
                    .limit(10)
                    .get();
                
                querySnapshot.forEach(doc => {
                    if (doc.id === currentUser.uid) return; // Don't show self
                    const userData = doc.data();
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    
                    let buttonHtml = `<button class="btn btn-sm btn-accept" data-id="${doc.id}">Add Friend</button>`;
                    if(friends.includes(doc.id)) buttonHtml = '<span>Friends</span>';
                    if(requestsSent.includes(doc.id)) buttonHtml = '<span>Sent</span>';

                    li.innerHTML = `
                        <img src="https://via.placeholder.com/50" alt="Avatar" class="avatar">
                        <div class="item-info"><div class="item-name">${userData.username}</div></div>
                        <div class="item-actions">${buttonHtml}</div>`;
                    userSearchResultsEl.appendChild(li);
                });
            }
            
            async function sendFriendRequest(targetId) {
                const batch = db.batch();
                const currentUserRef = db.collection('users').doc(currentUser.uid);
                const targetUserRef = db.collection('users').doc(targetId);

                batch.update(currentUserRef, { friendRequestsSent: firebase.firestore.FieldValue.arrayUnion(targetId) });
                batch.update(targetUserRef, { friendRequestsReceived: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
                
                await batch.commit();
                handleUserSearch(); // Refresh search results to show "Sent"
            }

            async function acceptFriendRequest(requesterId) {
                const batch = db.batch();
                const currentUserRef = db.collection('users').doc(currentUser.uid);
                const requesterRef = db.collection('users').doc(requesterId);
                
                batch.update(currentUserRef, {
                    friends: firebase.firestore.FieldValue.arrayUnion(requesterId),
                    friendRequestsReceived: firebase.firestore.FieldValue.arrayRemove(requesterId)
                });
                batch.update(requesterRef, {
                    friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
                    friendRequestsSent: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                });
                
                await batch.commit();
            }
            
            async function declineFriendRequest(requesterId) {
                 const batch = db.batch();
                const currentUserRef = db.collection('users').doc(currentUser.uid);
                const requesterRef = db.collection('users').doc(requesterId);
                
                batch.update(currentUserRef, { friendRequestsReceived: firebase.firestore.FieldValue.arrayRemove(requesterId) });
                batch.update(requesterRef, { friendRequestsSent: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
                
                await batch.commit();
            }

            // --- MODAL LOGIC ---
            function openFriendDetails(friendId, friendData) {
                friendDetailsModal.querySelector('#friend-modal-username').textContent = friendData.username;
                friendDetailsModal.querySelector('#friend-modal-email').textContent = friendData.email;
                friendDetailsModal.querySelector('#friend-modal-dob').value = ''; // Reset
                friendDetailsModal.querySelector('#remove-friend-btn').dataset.id = friendId;
                friendDetailsModal.classList.add('visible');
            }

            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                if (logoutBtn) logoutBtn.addEventListener('click', () => firebase.auth().signOut());
                if (toggleSidebarBtn) toggleSidebarBtn.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
                
                userSearchInput.addEventListener('input', handleUserSearch);
                
                userSearchResultsEl.addEventListener('click', e => {
                    if(e.target.matches('.btn-accept')) sendFriendRequest(e.target.dataset.id);
                });

                requestListEl.addEventListener('click', e => {
                    if(e.target.matches('.btn-accept')) acceptFriendRequest(e.target.dataset.id);
                    if(e.target.matches('.btn-decline')) declineFriendRequest(e.target.dataset.id);
                });
                
                // Modal close buttons
                friendDetailsModal.querySelector('.modal-close-btn').addEventListener('click', () => friendDetailsModal.classList.remove('visible'));
                friendDetailsModal.addEventListener('click', e => { if (e.target === friendDetailsModal) friendDetailsModal.classList.remove('visible'); });
            }

            // --- Initial Navigation Setup ---
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            const listPanels = {
                'chats-panel': document.getElementById('chats-panel'), 'friends-panel': document.getElementById('friends-panel'),
                'requests-panel': document.getElementById('requests-panel'), 'add-friends-panel': document.getElementById('add-friends-panel'),
                'settings-panel': document.getElementById('settings-panel'),
            };

            navLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    const targetId = this.dataset.target;
                    if (!targetId || !listPanels[targetId]) return;
                    navLinks.forEach(navLink => navLink.classList.remove('active'));
                    this.classList.add('active');
                    for (const panelId in listPanels) {
                        if (listPanels[panelId]) listPanels[panelId].classList.toggle('hidden', panelId !== targetId);
                    }
                });
            });
        });
    </script>
</body>
</html>
