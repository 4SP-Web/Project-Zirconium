<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP ‚Äì COUNTDOWNS</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
    /* --- Dashboard Layout --- */
    body.dashboard-page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
      font-family: 'PrimaryFont', sans-serif;
    }
    .dashboard-container {
      display: flex;
      flex: 1;
    }

    /* --- Sidebar (same as notes.html) --- */
    .sidebar {
      width: 200px;
      background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
      color: #fff;
      padding: 20px 10px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #444;
      transition: width 0.5s ease-in-out;
      position: relative;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .sidebar.collapsed {
      width: 85px;
    }
    #toggleSidebar {
      position: absolute;
      top: 10px;
      left: 10px;
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .sidebar nav {
      margin-top: 60px;
      display: flex;
      flex-direction: column;
    }
    .sidebar nav a {
      display: flex;
      align-items: center;
      color: #ddd;
      text-decoration: none;
      padding: 12px 16px;
      border-radius: 4px;
      margin: 4px 0;
      font-family: 'SecondaryFont', sans-serif;
      transition: background 0.3s ease-in-out;
    }
    .sidebar nav a .icon {
      margin-right: 12px;
      font-size: 1.2rem;
    }
    .sidebar nav a:hover,
    .sidebar nav a.active {
      background: rgba(103, 32, 189, 0.2);
      color: #fff;
    }
    .sidebar.collapsed nav a {
      justify-content: center;
    }
    .sidebar.collapsed nav a .label {
      display: none;
    }
    .sidebar .marquee-container {
      overflow: hidden;
      white-space: nowrap;
      position: relative;
      width: 100%;
      height: 1.8em;
      line-height: 1.8em;
      margin-top: 20px;
    }
    .marquee-content {
      display: inline-block;
      padding-left: 100%;
      transform: translateX(0);
      animation: none;
      line-height: 1.8em;
      font-family: 'SecondaryFont', sans-serif;
      color: #bbb;
    }
    .marquee-active {
      animation: scroll-left 12s linear infinite;
    }
    @keyframes scroll-left {
      from { transform: translateX(100%); }
      to   { transform: translateX(-100%); }
    }

    /* --- Main Content Area --- */
    main {
      flex: 1;
      background: #f2f4f7;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-y: auto;
    }
    .content-container {
      max-width: 700px;
      width: 100%;
      margin-top: 30px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .content-header {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      font-family: 'SecondaryFont', sans-serif;
      font-size: 1.8rem;
      color: #6720bd;
      text-align: center;
    }
    /* --- Countdown Form --- */
    .countdown-form {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 15px;
      font-family: 'PrimaryFont', sans-serif;
    }
    .countdown-form input[type="text"],
    .countdown-form input[type="date"],
    .countdown-form input[type="time"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: 'PrimaryFont', sans-serif;
      font-size: 1rem;
    }
    .countdown-form button {
      padding: 12px;
      background: linear-gradient(135deg, #6720bd 0%, #9933ff 100%);
      border: none;
      color: #fff;
      font-family: 'SecondaryFont', sans-serif;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .countdown-form button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(103, 32, 189, 0.25);
    }
    .countdown-form .button-group {
      display: flex;
      gap: 10px;
    }

    /* --- Countdown List --- */
    .countdown-list-container {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-family: 'PrimaryFont', sans-serif;
    }
    #countdownsList {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    #countdownsList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      animation: fadeInItem 0.4s ease-out forwards;
      font-size: 1rem;
      color: #333;
    }
    #countdownsList li.loading-item {
      text-align: center;
      color: #777;
      font-style: italic;
      padding: 20px;
      animation: none;
      border-bottom: none;
    }
    #countdownsList li:last-child:not(.loading-item) {
      border-bottom: none;
    }
    .countdown-info {
      flex-grow: 1;
      margin-right: 10px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .countdown-name {
      font-weight: 600;
      color: #6720bd;
      font-family: 'SecondaryFont', sans-serif;
    }
    .countdown-date {
      font-size: 0.85rem;
      color: #555;
    }
    .countdown-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }
    .countdown-actions button {
      background: linear-gradient(135deg, #17a2b8 0%, #1f95a3 100%);
      border: none;
      color: #fff;
      padding: 6px 10px;
      font-size: 0.85rem;
      border-radius: 4px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      font-family: 'SecondaryFont', sans-serif;
    }
    .countdown-actions button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(23, 162, 184, 0.25);
    }

    /* --- Status Message --- */
    #statusMessages {
      font-family: 'PrimaryFont', sans-serif;
      font-size: 0.95rem;
      min-height: 1.2em;
      color: #d9534f; /* red for errors by default */
      text-align: center;
    }

    /* --- Animations --- */
    @keyframes fadeInItem {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* --- Responsive --- */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      main { padding: 10px; }
      .content-container { margin-top: 10px; }
      .countdown-actions { flex-direction: column; }
      .countdown-actions button { width: 100%; }
    }
  </style>
</head>
<body class="dashboard-page">
  <!-- Sidebar (identical structure to notes.html) -->
  <aside id="sidebar" class="sidebar">
    <button id="toggleSidebar">‚ò∞</button>
    <div class="user-info">
      <!-- Placeholder for user photo / email marquee -->
      <div class="marquee-container">
        <span class="marquee-content" id="marqueeEmail">Loading‚Ä¶</span>
      </div>
    </div>
    <nav>
      <a href="dashboard.html"><span class="icon">üè†</span><span class="label">DASHBOARD</span></a>
      <a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">PROXIES</span></a>
      <a href="soundboard.html"><span class="icon">üéµ</span><span class="label">SOUNDBOARD</span></a>
      <a href="games.html"><span class="icon">üéÆ</span><span class="label">GAMES</span></a>
      <a href="others.html"><span class="icon">‚ú®</span><span class="label">OTHERS</span></a>
      <a href="countdown.html" class="active"><span class="icon">‚è≥</span><span class="label">COUNTDOWNS</span></a>
    </nav>
  </aside>

  <!-- Main Content Area -->
  <main>
    <div class="content-container">
      <div class="content-header">COUNTDOWNS</div>

      <!-- Countdown Form -->
      <div class="countdown-form">
        <input type="text" id="countdownName" placeholder="Countdown Name" />
        <input type="date" id="countdownDate" />
        <input type="time" id="countdownTime" />
        <div class="button-group">
          <button id="saveCountdownBtn">Save Countdown</button>
          <button id="clearCountdownBtn">Clear</button>
        </div>
      </div>

      <!-- List of Existing Countdowns (max 10) -->
      <div class="countdown-list-container">
        <div style="font-family: 'SecondaryFont', sans-serif; font-size: 1.1rem; margin-bottom: 10px;">
          Your Saved Countdowns (<span id="countdownSlotsUsed">0</span>/10)
        </div>
        <ul id="countdownsList">
          <!-- Dynamically generated list items will go here -->
        </ul>
      </div>

      <!-- Live ‚ÄúTime Remaining‚Äù Display -->
      <div id="timeRemaining" style="
           background: #fff;
           border-radius: 8px;
           padding: 20px;
           box-shadow: 0 2px 8px rgba(0,0,0,0.05);
           font-family: 'SecondaryFont', sans-serif;
           font-size: 1.2rem;
           text-align: center;
           min-height: 2em;
         ">
        Please create or open a countdown.
      </div>

      <!-- Status Messages -->
      <div id="statusMessages"></div>
    </div>
  </main>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>

  <script>
    // Maximum number of countdowns per user
    const MAX_COUNTDOWNS = 10;

    // DOM Elements
    const countdownNameEl = document.getElementById('countdownName');
    const countdownDateEl = document.getElementById('countdownDate');
    const countdownTimeEl = document.getElementById('countdownTime');
    const saveBtn = document.getElementById('saveCountdownBtn');
    const clearBtn = document.getElementById('clearCountdownBtn');
    const countdownsListEl = document.getElementById('countdownsList');
    const slotsUsedEl = document.getElementById('countdownSlotsUsed');
    const timeRemainingEl = document.getElementById('timeRemaining');
    const statusEl = document.getElementById('statusMessages');
    const marqueeEmailEl = document.getElementById('marqueeEmail');
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    const sidebarEl = document.getElementById('sidebar');

    let currentUser = null;
    let countdownsData = []; // Array of { name, targetTimestamp, createdAt }
    let editingIndex = null; // If editing an existing countdown, its index

    // Initialize Firebase Auth & Firestore
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Toggle sidebar collapse
    toggleSidebarBtn.addEventListener('click', () => {
      sidebarEl.classList.toggle('collapsed');
      // Restart marquee if collapsed
      setTimeout(initMarquee, 300);
    });

    // Listen for auth state changes
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        marqueeEmailEl.textContent = user.email;
        initMarquee();
        loadCountdowns();
      } else {
        // If not signed in, redirect to login (or show a message)
        window.location.href = 'login.html';
      }
    });

    // Initialize marquee animation
    function initMarquee() {
      marqueeEmailEl.classList.remove('marquee-active');
      void marqueeEmailEl.offsetWidth;
      marqueeEmailEl.classList.add('marquee-active');
    }

    // Show a status message (error or success)
    function showStatus(message, type = 'error', duration = 4000) {
      statusEl.textContent = message;
      if (type === 'success') {
        statusEl.style.color = '#28a745'; // green
      } else {
        statusEl.style.color = '#d9534f'; // red
      }
      if (duration > 0) {
        setTimeout(() => { statusEl.textContent = ''; }, duration);
      }
    }

    // Combine date + time inputs into a Firestore Timestamp
    function getTimestampFromInputs() {
      const dateVal = countdownDateEl.value;
      const timeVal = countdownTimeEl.value;
      if (!dateVal || !timeVal) return null;
      const [year, month, day] = dateVal.split('-').map(Number);
      const [hour, minute] = timeVal.split(':').map(Number);
      const dt = new Date(year, month - 1, day, hour, minute);
      return firebase.firestore.Timestamp.fromDate(dt);
    }

    // Load all countdowns for the current user
    async function loadCountdowns() {
      try {
        const docRef = db.collection('countdownApp').doc(currentUser.uid);
        const docSnap = await docRef.get();
        if (docSnap.exists) {
          const data = docSnap.data();
          countdownsData = Array.isArray(data.countdowns) ? data.countdowns : [];
        } else {
          countdownsData = [];
        }
        renderCountdownsList();
      } catch (err) {
        console.error('Error loading countdowns:', err);
        showStatus('Could not load countdowns: ' + err.message);
      }
    }

    // Render the list of countdowns
    function renderCountdownsList() {
      countdownsListEl.innerHTML = '';
      if (countdownsData.length === 0) {
        countdownsListEl.innerHTML = '<li class="loading-item">No countdowns saved. Add one!</li>';
        slotsUsedEl.textContent = '0';
        return;
      }

      countdownsData.forEach((item, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="countdown-info">
            <div class="countdown-name">${item.name}</div>
            <div class="countdown-date">${item.targetTimestamp.toDate().toLocaleString()}</div>
          </div>
          <div class="countdown-actions">
            <button class="edit-btn" data-index="${idx}">Edit Name</button>
            <button class="open-btn" data-index="${idx}">Open</button>
            <button class="delete-btn" data-index="${idx}">Delete</button>
          </div>
        `;
        countdownsListEl.appendChild(li);
      });
      slotsUsedEl.textContent = countdownsData.length;
      attachListEventListeners();
    }

    // Attach click handlers to the dynamically created buttons
    function attachListEventListeners() {
      countdownsListEl.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', e => startEditName(parseInt(e.target.dataset.index)));
      });
      countdownsListEl.querySelectorAll('.open-btn').forEach(btn => {
        btn.addEventListener('click', e => openCountdown(parseInt(e.target.dataset.index)));
      });
      countdownsListEl.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', e => deleteCountdown(parseInt(e.target.dataset.index)));
      });
    }

    // Start editing just the name of an existing countdown
    function startEditName(index) {
      const item = countdownsData[index];
      countdownNameEl.value = item.name;
      countdownDateEl.value = item.targetTimestamp.toDate().toISOString().split('T')[0];
      countdownTimeEl.value = item.targetTimestamp.toDate().toTimeString().slice(0,5);
      editingIndex = index;
      saveBtn.textContent = 'Update Name';
      showStatus(`Editing name for "${item.name}"`, 'success', 3000);
    }

    // Open a countdown: load into inputs and start live timer
    function openCountdown(index) {
      const item = countdownsData[index];
      countdownNameEl.value = item.name;
      const dt = item.targetTimestamp.toDate();
      countdownDateEl.value = dt.toISOString().split('T')[0];
      countdownTimeEl.value = dt.toTimeString().slice(0,5);
      editingIndex = index;
      saveBtn.textContent = 'Save Changes';
      startLiveTimer(item.targetTimestamp.toDate());
      showStatus(`Opened "${item.name}"`, 'success', 3000);
    }

    // Delete a countdown
    async function deleteCountdown(index) {
      try {
        const confirmDeletion = confirm(`Delete countdown "${countdownsData[index].name}"?`);
        if (!confirmDeletion) return;
        countdownsData.splice(index, 1);
        await saveAllCountdownsToFirestore();
        renderCountdownsList();
        clearForm();
        showStatus('Countdown deleted.', 'success');
      } catch (err) {
        console.error('Error deleting countdown:', err);
        showStatus('Could not delete: ' + err.message);
      }
    }

    // Clear form inputs and stop timer
    function clearForm() {
      countdownNameEl.value = '';
      countdownDateEl.value = '';
      countdownTimeEl.value = '';
      editingIndex = null;
      saveBtn.textContent = 'Save Countdown';
      timeRemainingEl.textContent = 'Please create or open a countdown.';
      if (liveTimerInterval) {
        clearInterval(liveTimerInterval);
        liveTimerInterval = null;
      }
    }

    // Save (create or update) a single countdown from the form
    saveBtn.addEventListener('click', async () => {
      const name = countdownNameEl.value.trim();
      const ts = getTimestampFromInputs();
      if (!name || !ts) {
        showStatus('Please provide a name, date, and time.');
        return;
      }

      // If editing an existing countdown
      if (editingIndex !== null && editingIndex < countdownsData.length) {
        // Update existing entry
        countdownsData[editingIndex].name = name;
        countdownsData[editingIndex].targetTimestamp = ts;
      } else {
        // Adding a new countdown
        if (countdownsData.length >= MAX_COUNTDOWNS) {
          showStatus(`You can only save up to ${MAX_COUNTDOWNS} countdowns.`);
          return;
        }
        countdownsData.push({
          name: name,
          targetTimestamp: ts,
          createdAt: firebase.firestore.Timestamp.now()
        });
      }

      try {
        await saveAllCountdownsToFirestore();
        renderCountdownsList();
        startLiveTimer(ts.toDate());
        showStatus('Countdown saved!', 'success');
        editingIndex = countdownsData.findIndex(item =>
          item.name === name && item.targetTimestamp.seconds === ts.seconds
        );
        saveBtn.textContent = 'Save Changes';
      } catch (err) {
        console.error('Error saving countdown:', err);
        showStatus('Save failed: ' + err.message);
      }
    });

    // Save the entire array of countdowns back to Firestore
    async function saveAllCountdownsToFirestore() {
      const docRef = db.collection('countdownApp').doc(currentUser.uid);
      const payload = {
        countdowns: countdownsData.map(item => ({
          name: item.name,
          targetTimestamp: item.targetTimestamp,
          createdAt: item.createdAt
        }))
      };
      await db.runTransaction(async tx => {
        const doc = await tx.get(docRef);
        if (doc.exists) {
          tx.update(docRef, payload);
        } else {
          tx.set(docRef, payload);
        }
      });
    }

    // Live timer logic
    let liveTimerInterval = null;
    function startLiveTimer(targetDate) {
      if (liveTimerInterval) clearInterval(liveTimerInterval);
      function updateTimer() {
        const now = new Date();
        const diffMs = targetDate.getTime() - now.getTime();
        if (diffMs <= 0) {
          timeRemainingEl.textContent = 'Time‚Äôs up!';
          clearInterval(liveTimerInterval);
          return;
        }
        const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
        timeRemainingEl.textContent = 
          `${days}d ${hours}h ${minutes}m ${seconds}s remaining`;
      }
      updateTimer();
      liveTimerInterval = setInterval(updateTimer, 1000);
    }

    // Clear button: reset form
    clearBtn.addEventListener('click', () => {
      clearForm();
      showStatus('Form cleared.', 'success', 2000);
    });
  </script>
</body>
</html>
