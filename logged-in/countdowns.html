<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - COUNTDOWNS</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="../panic-key.js"></script>
    <script src="../ban-enforcer.js"></script>
    <script src="../url-changer.js"></script>
    <style>
        /* --- Base Layout & Theme --- */
        body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: 'PrimaryFont', sans-serif; }
        .dashboard-container { display: flex; flex: 1; }
        .main-content { flex: 1; padding: 30px; background: #f4f7fa; overflow-y: auto; display: flex; flex-direction: column; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid #e9eef3; flex-shrink: 0; }
        .dashboard-title { margin: 0; font-size: 2.0em; font-weight: bold; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        /* --- Sidebar --- */
        .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
        .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; opacity: 1; visibility: visible; transition: opacity 0.2s ease-in-out 0.4s; }
        .sidebar.collapsed nav a .label { opacity: 0; visibility: hidden; transition-delay: 0s; }
        
        /* --- Content & Controls --- */
        .content-wrapper { display: flex; flex-direction: column; flex-grow: 1; gap: 25px; }
        .page-controls { display: flex; gap: 10px; align-items: center; }
        .btn-primary { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); border: none; color: #fff; padding: 10px 20px; border-radius: 8px; font-family: 'PrimaryFont', sans-serif; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; font-weight: 600; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(103, 32, 189, 0.25); }
        .btn-primary:disabled { background: #b6b6b6; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.8; }
        .btn-primary.btn-group { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .btn-primary.btn-group:hover { box-shadow: 0 6px 15px rgba(40, 167, 69, 0.25); }
        .active-countdown-wrapper { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; position: relative; }
        #closeActiveCountdownBtn { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.8em; color: #aaa; cursor: pointer; transition: color 0.2s; line-height: 1; padding: 5px; }
        #closeActiveCountdownBtn:hover { color: #333; }
        #activeCountdownNameDisplay { font-size: 1.8em; margin: 0 0 15px; color: #333; font-weight: 600; }
        .timer-display { padding: 15px; border-radius: 8px; background: #f4f7fa; border: 1px solid #e9eef3; font-size: 1.2em; color: #6720bd; font-weight: bold; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; min-height: 2.5em; align-items: center; }
        .timer-display .time-unit { display: inline-block; font-variant-numeric: tabular-nums; }
        .timer-display .time-label { font-size: 0.6em; margin-left: 3px; color: #777; }

        /* --- List Styles with Tabs --- */
        .countdown-list-area { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .section-tabs { display: flex; flex-wrap: wrap; margin-bottom: 15px; gap: 10px; }
        .section-tab-button { background-color: #f0f2f5; color: #555; border: 1px solid #e0e0e0; padding: 8px 15px; border-radius: 20px; font-weight: 600; font-size: 0.9em; cursor: pointer; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; }
        .section-tab-button:hover { background-color: #e8eaf0; color: #333; }
        .section-tab-button.active { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); color: #fff; border-color: transparent; box-shadow: 0 4px 10px rgba(103, 32, 189, 0.2); }
        .section-tab-button[data-tab="groups"].active { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2); }
        .section-tab-content { display: none; }
        .section-tab-content.active { display: block; }
        .section-tab-content ul { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
        .no-items-message { color: #888; font-style: italic; padding: 20px; text-align: center; background: #f9f9fc; border-radius: 8px; }
        #cloudSavesListContainer li { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-radius: 8px; background-color: #f9fafd; border: 1px solid #e9eef3; }
        .save-info { flex-grow: 1; margin-right: 10px; }
        .save-name { font-weight: bold; color: #6720bd; font-size: 1.1em; }
        .group-name { color: #28a745; }
        .save-details { font-size: 0.8em; color: #777; margin-top: 3px; }
        .save-actions button { background: none; border: 1.5px solid; padding: 6px 10px; border-radius: 8px; cursor: pointer; margin-left: 4px; font-size: 0.9em; transition: all 0.2s ease-in-out; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .save-actions .open-save-btn, .save-actions .open-group-btn { background: rgba(0, 123, 255, 0.1); border-color: #007bff; color: #007bff; }
        .save-actions .open-save-btn:hover, .save-actions .open-group-btn:hover { background: #007bff; color: #fff; box-shadow: 0 2px 6px rgba(0,123,255,0.3); }
        .save-actions .edit-countdown-btn, .save-actions .edit-group-btn { background: rgba(255, 193, 7, 0.1); border-color: #ffc107; color: #856404; }
        .save-actions .edit-countdown-btn:hover, .save-actions .edit-group-btn:hover { background: #ffc107; color: #212529; box-shadow: 0 2px 6px rgba(255,193,7,0.3); }
        .save-actions .delete-save-btn, .save-actions .delete-group-btn { background: rgba(178, 34, 34, 0.1); border-color: #b22222; color: #b22222; }
        .save-actions .delete-save-btn:hover, .save-actions .delete-group-btn:hover { background: #b22222; color: #fff; box-shadow: 0 2px 6px rgba(178,34,34,0.3); }

        /* --- Modal Styles --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 1000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal-content { background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s ease; font-family: 'PrimaryFont', sans-serif; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h3 { margin: 0 0 25px; font-size: 1.6em; color: #333; text-align: center; font-family: 'PrimaryFont', sans-serif; font-weight: 600; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9em; color: #555; font-weight: 600; font-family: 'PrimaryFont', sans-serif; }
        .form-group input[type="text"], .form-group select { width: 100%; box-sizing: border-box; padding: 12px; font-size: 1em; border: 1px solid #ccc; border-radius: 8px; transition: all 0.2s ease; font-family: 'PrimaryFont', sans-serif; }
        .form-group input:focus, .form-group select:focus { border-color: #8a2be2; box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.15); outline: none; }
        .modal-actions { margin-top: 30px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-secondary { background: #6c757d; border: none; color: #fff; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; font-size: 0.9em; font-family: 'PrimaryFont', sans-serif; font-weight: 600; }
        .btn-secondary:hover { background: #5a6268; }

        /* Group Modal Specifics */
        #groupCountdownSelector { max-height: 250px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background-color: #fdfdfd; }
        #groupCountdownSelector .checkbox-item { display: block; position: relative; padding-left: 35px; margin-bottom: 12px; cursor: pointer; font-size: 1.1em; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        #groupCountdownSelector .checkbox-item input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .checkmark { position: absolute; top: 0; left: 0; height: 25px; width: 25px; background-color: #eee; border-radius: 4px; transition: background-color 0.2s; }
        #groupCountdownSelector .checkbox-item:hover input ~ .checkmark { background-color: #ccc; }
        #groupCountdownSelector .checkbox-item input:checked ~ .checkmark { background-color: #28a745; }
        .checkmark:after { content: ""; position: absolute; display: none; }
        #groupCountdownSelector .checkbox-item input:checked ~ .checkmark:after { display: block; }
        #groupCountdownSelector .checkbox-item .checkmark:after { left: 9px; top: 5px; width: 5px; height: 10px; border: solid white; border-width: 0 3px 3px 0; -webkit-transform: rotate(45deg); -ms-transform: rotate(45deg); transform: rotate(45deg); }


        /* Repeat Options */
        .repeat-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-family: 'PrimaryFont', sans-serif; }
        .repeat-toggle-wrapper { display: flex; align-items: center; justify-content: space-between; }
        .switch-label { font-weight: 600; color: #333; font-family: 'PrimaryFont', sans-serif; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #6720bd; }
        input:checked + .slider:before { transform: translateX(22px); }
        #repeatOptions { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, margin-top 0.4s ease-out; }
        #repeatOptions.visible { max-height: 200px; margin-top: 20px; }
        .day-selector { margin-top: 15px; }
        .day-selector p { margin: 0 0 10px; font-weight: 500; font-family: 'PrimaryFont', sans-serif; }
        .day-buttons { display: flex; justify-content: space-between; gap: 5px; }
        .day-buttons label { flex: 1; text-align: center; }
        .day-buttons input { display: none; }
        .day-buttons span { display: block; padding: 8px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; font-family: 'PrimaryFont', sans-serif; }
        .day-buttons input:checked + span { background-color: #6720bd; color: white; border-color: #6720bd; }

        /* Fullscreen & Color Palette */
        #fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; color: white; z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; transition: background 0.5s ease; user-select: none; }
        #fullscreen-overlay.active { display: flex; }
        #fullscreen-overlay.inactive-cursor { cursor: none; }
        #fullscreen-name { font-size: 4.5vw; margin-bottom: 2vh; text-shadow: 0 0 20px rgba(0, 0, 0, 0.5); font-weight: bold; }
        #fullscreen-timer { font-size: 10vw; font-weight: bold; font-family: 'PrimaryFont', sans-serif; letter-spacing: 0.05em; color: #fff; text-shadow: 0 0 25px rgba(0, 0, 0, 0.4); }
        #fullscreen-timer .time-unit { display: inline-block; margin: 0 1vw; font-variant-numeric: tabular-nums; }
        #fullscreen-timer .time-label { font-size: 0.25em; margin-left: 0.5vw; color: #ddd; display: block; margin-top: -1vh; }
        #fullscreen-target-date { margin-top: 4vh; font-size: 2vw; color: #ccc; background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 10px; }
        .fs-controls, .fs-menu { opacity: 1; visibility: visible; position: absolute; transition: opacity 0.5s ease-in-out; }
        .fs-controls { top: 20px; right: 20px; }
        .fs-menu { bottom: 20px; left: 20px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: left; max-width: 300px; }
        .fs-menu h3 { margin: 0 0 10px; font-size: 1.5vw; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 5px; }
        .fs-menu ul { list-style: none; margin: 0; padding: 0; }
        .fs-menu li { font-size: 1.2vw; color: #ddd; padding: 3px 0; }
        .fs-controls.controls-hidden, .fs-menu.controls-hidden { opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in-out, visibility 0s linear 0.5s; }
        #fs-color-toggle { font-size: 2em; cursor: pointer; transition: transform 0.3s; }
        #fs-color-toggle:hover { transform: rotate(45deg); }
        #fs-color-palette { position: absolute; top: 70px; right: 0px; width: 152px; background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); border-radius: 10px; padding: 10px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; z-index: 2001; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        #fs-color-palette.visible { opacity: 1; visibility: visible; }
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid white; transition: transform 0.2s; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch-custom { background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); }
        #color-picker-input { visibility: hidden; width: 0; height: 0; position: absolute; }

        /* --- Custom Flatpickr Styles --- */
        .flatpickr-time input.numInput {
            font-family: 'PrimaryFont', sans-serif !important;
        }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange { background: #d8c1ff !important; border-color: #9e78e8 !important; color: #333 !important; }
        .flatpickr-day.today { border-color: #9e78e8 !important; color: #6720bd !important; }
        .flatpickr-day:hover { background: #e9d9ff !important; border-color: #c7a4ff !important; }

        /* Grid layout for calendar days to ensure 7-day rows, leaving weekdays to default flex behavior */
        .dayContainer {
            display: grid !important;
            grid-template-columns: repeat(7, 1fr);
            width: 100%;
            padding: 0 !important;
            box-sizing: border-box;
        }

        .flatpickr-day {
            border-radius: 6px !important;
            height: 32px !important;
            line-height: 32px !important;
            max-width: none !important; /* Remove max-width constraint */
            width: 32px !important;     /* Keep the visual indicator a fixed size */
            margin: 1px auto !important; /* Center the fixed-size day in the grid cell */
        }
    </style>
</head>

<body class="dashboard-page">
    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" /></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="apps.html" class="active"><span class="icon">✨</span><span class="label">Apps</span></a></li>
                    <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content fade-in">
            <div class="dashboard-header">
                <h2 class="dashboard-title">COUNTDOWNS</h2>
                 <div class="page-controls">
                    <button id="addGroupBtn" class="btn-primary btn-group">➕ Add New Group</button>
                    <button id="addCountdownBtn" class="btn-primary">✨ Add New Countdown</button>
                    <button id="fullscreenBtn" class="btn-primary" disabled>Fullscreen 🚀</button>
                </div>
            </div>
            <div class="content-wrapper">
                <div class="active-countdown-wrapper">
                    <button id="closeActiveCountdownBtn" title="Close Active Countdown">&times;</button>
                    <h3 id="activeCountdownNameDisplay">No countdown selected</h3>
                    <div class="timer-display" id="timerDisplay">Select or create a countdown to begin.</div>
                </div>
                <div class="countdown-list-area">
                     <div id="cloudSavesListContainer">
                     </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <h3 id="modalTitle">Add New Countdown</h3>
            <form id="countdownForm">
                <div class="form-group">
                    <label for="nameInput">Event Name</label>
                    <input type="text" id="nameInput" placeholder="e.g., Project Deadline" maxlength="20" required>
                </div>
                <div class="form-group">
                    <label for="dateTimePicker" id="dateTimePickerLabel">Target Date & Time</label>
                    <input type="text" id="dateTimePicker" placeholder="Click to select..." required>
                </div>
                
                <div class="repeat-section">
                    <div class="repeat-toggle-wrapper">
                        <span class="switch-label">Repeat this event</span>
                        <label class="switch">
                            <input type="checkbox" id="repeatToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="repeatOptions">
                        <div class="form-group">
                            <label for="repeatFrequency">Frequency</label>
                            <select id="repeatFrequency">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                            </select>
                        </div>
                        <div class="day-selector" id="weeklyRepeatOptions">
                            <p>Repeat on these days:</p>
                            <div class="day-buttons">
                                <label><input type="checkbox" name="repeatDay" value="1"><span>M</span></label>
                                <label><input type="checkbox" name="repeatDay" value="2"><span>T</span></label>
                                <label><input type="checkbox" name="repeatDay" value="3"><span>W</span></label>
                                <label><input type="checkbox" name="repeatDay" value="4"><span>T</span></label>
                                <label><input type="checkbox" name="repeatDay" value="5"><span>F</span></label>
                                <label><input type="checkbox" name="repeatDay" value="6"><span>S</span></label>
                                <label><input type="checkbox" name="repeatDay" value="0"><span>S</span></label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" id="cancelFormBtn" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save Countdown</button>
                </div>
            </form>
        </div>
    </div>

    <div id="groupModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="groupModalTitle">Create New Group</h3>
            <form id="groupForm">
                <div class="form-group">
                    <label for="groupNameInput">Group Name</label>
                    <input type="text" id="groupNameInput" placeholder="e.g., Class Periods" required>
                </div>
                <div class="form-group">
                    <label>Select Repeating Countdowns</label>
                    <div id="groupCountdownSelector">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancelGroupFormBtn" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary btn-group">Save Group</button>
                </div>
            </form>
        </div>
    </div>

    <div id="fullscreen-overlay">
        <div class="fs-controls">
            <div id="fs-color-toggle" title="Change Color">🎨</div>
            <div id="fs-color-palette">
                <div class="color-swatch" style="background: #0a0a14;" data-color="#0a0a14"></div>
                <div class="color-swatch" style="background: linear-gradient(135deg, #23074d, #cc5333);" data-color="linear-gradient(135deg, #23074d, #cc5333)"></div>
                <div class="color-swatch" style="background: linear-gradient(135deg, #1f4037, #99f2c8);" data-color="linear-gradient(135deg, #1f4037, #99f2c8)"></div>
                <div class="color-swatch" style="background: linear-gradient(135deg, #603813, #b29f94);" data-color="linear-gradient(135deg, #603813, #b29f94)"></div>
                <div class="color-swatch" style="background: linear-gradient(135deg, #780206, #061161);" data-color="linear-gradient(135deg, #780206, #061161)"></div>
                <div class="color-swatch" style="background: #2c3e50;" data-color="#2c3e50"></div>
                <div class="color-swatch" style="background: #c0392b;" data-color="#c0392b"></div>
                <div class="color-swatch" style="background: #008080;" data-color="#008080"></div>
                <div class="color-swatch" style="background: linear-gradient(to right, #00c6ff, #0072ff);" data-color="linear-gradient(to right, #00c6ff, #0072ff)"></div>
                <div class="color-swatch" style="background: linear-gradient(to right, #ff7e5f, #feb47b);" data-color="linear-gradient(to right, #ff7e5f, #feb47b)"></div>
                <div class="color-swatch" style="background: linear-gradient(to right, #8e2de2, #4a00e0);" data-color="linear-gradient(to right, #8e2de2, #4a00e0)"></div>
                <div class="color-swatch color-swatch-custom" title="Custom Color"></div>
                <input type="color" id="color-picker-input">
            </div>
        </div>
        <div id="fullscreen-group-view" class="fs-menu">
            <h3>Next Up</h3>
            <ul id="fullscreen-next-up-list"></ul>
        </div>
        <h2 id="fullscreen-name"></h2>
        <div id="fullscreen-timer"></div>
        <p id="fullscreen-target-date"></p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        // --- Globals ---
        let currentUser, userCountdowns = [], userGroups = [], activeCountdown, activeGroup, countdownInterval, flatpickrInstance, inactivityTimer;
        let isEditing = false, editingId = null;
        let isEditingGroup = false, editingGroupId = null;

        // --- DOM Elements ---
        const listContainerEl = document.getElementById('cloudSavesListContainer');
        const activeCountdownNameEl = document.getElementById('activeCountdownNameDisplay');
        const timerDisplayEl = document.getElementById('timerDisplay');
        const addBtn = document.getElementById('addCountdownBtn');
        const addGroupBtn = document.getElementById('addGroupBtn');
        const closeActiveBtn = document.getElementById('closeActiveCountdownBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        
        // Countdown Modal
        const modalOverlay = document.getElementById('modal-overlay');
        const countdownForm = document.getElementById('countdownForm');
        const nameInput = document.getElementById('nameInput');
        const dateTimePicker = document.getElementById('dateTimePicker');
        const dateTimePickerLabel = document.getElementById('dateTimePickerLabel');
        const cancelBtn = document.getElementById('cancelFormBtn');
        const repeatToggle = document.getElementById('repeatToggle');
        const repeatOptions = document.getElementById('repeatOptions');
        const repeatFrequency = document.getElementById('repeatFrequency');
        const weeklyRepeatOptions = document.getElementById('weeklyRepeatOptions');

        // Group Modal
        const groupModalOverlay = document.getElementById('groupModalOverlay');
        const groupForm = document.getElementById('groupForm');
        const groupNameInput = document.getElementById('groupNameInput');
        const groupCountdownSelector = document.getElementById('groupCountdownSelector');
        const cancelGroupBtn = document.getElementById('cancelGroupFormBtn');
        
        // Fullscreen
        const fullscreenOverlay = document.getElementById('fullscreen-overlay');
        const fullscreenName = document.getElementById('fullscreen-name');
        const fullscreenTimer = document.getElementById('fullscreen-timer');
        const fullscreenTargetDate = document.getElementById('fullscreen-target-date');
        const fsControls = document.querySelector('.fs-controls');
        const fsColorToggle = document.getElementById('fs-color-toggle');
        const fsColorPalette = document.getElementById('fs-color-palette');
        const colorPickerInput = document.getElementById('color-picker-input');
        const fullscreenGroupView = document.getElementById('fullscreen-group-view');
        const fullscreenNextUpList = document.getElementById('fullscreen-next-up-list');

        // --- Utility ---
        const generateId = (prefix) => `${prefix}_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
        const formatDate = (date) => date ? new Date(date).toLocaleString('en-US', { month: 'long', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' }) : 'N/A';
        const getStorageKey = (key) => currentUser ? `4sp_${key}_${currentUser.uid}` : null;
        
        // --- Repetition Logic ---
        function calculateNextOccurrence(countdown) {
            if (!countdown.repeat) return new Date(countdown.targetTimestamp);
            let lastTarget = new Date(countdown.targetTimestamp);
            let now = new Date();
            if (lastTarget > now) return lastTarget;
            let nextTarget = new Date(lastTarget);
            if (countdown.repeat.type === 'daily') {
                const diffDays = Math.ceil((now - nextTarget) / (1000 * 60 * 60 * 24));
                nextTarget.setDate(nextTarget.getDate() + diffDays);
                if (nextTarget <= now) nextTarget.setDate(nextTarget.getDate() + 1);
            } else if (countdown.repeat.type === 'weekly' && countdown.repeat.days && countdown.repeat.days.length > 0) {
                const sortedDays = countdown.repeat.days.map(d => parseInt(d)).sort((a,b) => a - b);
                while (nextTarget <= now) {
                    let currentDay = nextTarget.getDay();
                    let nextDayInCycle = sortedDays.find(d => d > currentDay);
                    if (nextDayInCycle !== undefined) {
                        nextTarget.setDate(nextTarget.getDate() + (nextDayInCycle - currentDay));
                    } else {
                        nextTarget.setDate(nextTarget.getDate() + (7 - currentDay + sortedDays[0]));
                    }
                }
            }
            return nextTarget;
        }
        
        // --- Modal Logic (Countdown) ---
        function openCountdownModal(isEditMode = false, countdown = null) {
            isEditing = isEditMode; editingId = isEditMode ? countdown.id : null;
            document.getElementById('modalTitle').textContent = isEditMode ? 'Edit Countdown' : 'Create New Countdown';
            document.querySelector('#modal-content button[type="submit"]').textContent = isEditMode ? 'Save Changes' : 'Create Countdown';
            nameInput.value = isEditMode ? countdown.name : '';

            const isRepeating = isEditMode && !!countdown.repeat;
            repeatToggle.checked = isRepeating;
            repeatOptions.classList.toggle('visible', isRepeating);

            if (isRepeating) {
                flatpickrInstance.set('noCalendar', true);
                flatpickrInstance.set('altFormat', 'h:i K');
                dateTimePickerLabel.textContent = 'Target Time';
                dateTimePicker.placeholder = 'Click to select time...';
            } else {
                flatpickrInstance.set('noCalendar', false);
                flatpickrInstance.set('altFormat', 'F j, Y at h:i K');
                dateTimePickerLabel.textContent = 'Target Date & Time';
                dateTimePicker.placeholder = 'Click to select...';
            }

            flatpickrInstance.setDate(isEditMode ? countdown.targetTimestamp : new Date(), true);
            
            repeatFrequency.value = (isEditMode && countdown.repeat) ? countdown.repeat.type : 'daily';
            weeklyRepeatOptions.style.display = repeatFrequency.value === 'weekly' ? 'block' : 'none';
            document.querySelectorAll('input[name="repeatDay"]').forEach(cb => {
                cb.checked = (isEditMode && countdown.repeat && countdown.repeat.days) ? countdown.repeat.days.includes(cb.value) : false;
            });
            modalOverlay.classList.add('visible');
        }

        function closeCountdownModal() {
            countdownForm.reset();
            // Reset flatpickr to its default state for the next time it's opened
            flatpickrInstance.set('noCalendar', false);
            flatpickrInstance.set('altFormat', 'F j, Y at h:i K');
            dateTimePickerLabel.textContent = 'Target Date & Time';
            dateTimePicker.placeholder = 'Click to select...';
            flatpickrInstance.clear();
            
            repeatOptions.classList.remove('visible');
            weeklyRepeatOptions.style.display = 'none';
            modalOverlay.classList.remove('visible');
        }

        // --- Modal Logic (Group) ---
        function openGroupModal(isEditMode = false, group = null) {
            isEditingGroup = isEditMode; editingGroupId = isEditMode ? group.id : null;
            document.getElementById('groupModalTitle').textContent = isEditMode ? 'Edit Group' : 'Create New Group';
            groupNameInput.value = isEditMode ? group.name : '';
            
            const repeatingCountdowns = userCountdowns.filter(cd => cd.repeat);
            groupCountdownSelector.innerHTML = '';
            if (repeatingCountdowns.length > 0) {
                repeatingCountdowns.forEach(cd => {
                    const isChecked = isEditMode && group.countdownIds.includes(cd.id);
                    groupCountdownSelector.innerHTML += `
                        <label class="checkbox-item">${cd.name}
                            <input type="checkbox" value="${cd.id}" ${isChecked ? 'checked' : ''}>
                            <span class="checkmark"></span>
                        </label>`;
                });
            } else {
                groupCountdownSelector.innerHTML = `<p class="no-items-message">No repeating countdowns available to add to a group.</p>`;
            }
            groupModalOverlay.classList.add('visible');
        }
        function closeGroupModal() {
            groupForm.reset();
            groupModalOverlay.classList.remove('visible');
        }

        // --- Data Handling ---
        function loadAllData() {
            const countdownsKey = getStorageKey('countdowns');
            const groupsKey = getStorageKey('countdownGroups');
            if (!countdownsKey || !groupsKey) return;
            try {
                const storedCountdowns = localStorage.getItem(countdownsKey);
                userCountdowns = storedCountdowns ? JSON.parse(storedCountdowns).map(cd => ({ ...cd, targetTimestamp: new Date(cd.targetTimestamp) })) : [];
                const storedGroups = localStorage.getItem(groupsKey);
                userGroups = storedGroups ? JSON.parse(storedGroups) : [];
            } catch (e) { console.error("Error loading data:", e); userCountdowns = []; userGroups = []; }
            renderListWithTabs();
        }

        function saveCountdowns() {
            const storageKey = getStorageKey('countdowns'); if (!storageKey) return;
            localStorage.setItem(storageKey, JSON.stringify(userCountdowns));
            renderListWithTabs();
        }
        
        function saveGroups() {
            const storageKey = getStorageKey('countdownGroups'); if (!storageKey) return;
            localStorage.setItem(storageKey, JSON.stringify(userGroups));
            renderListWithTabs();
        }

        // --- UI Rendering ---
        function renderListWithTabs() {
            listContainerEl.innerHTML = '';
            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();

            const sections = {
                groups: { title: 'Groups', items: userGroups, active: true },
                month: { title: 'This Month', items: [] },
                year: { title: 'This Year', items: [] },
                future: { title: 'Future Years', items: [] },
                past: { title: 'Finished', items: [] }
            };

            userCountdowns.forEach(cd => {
                const nextOccurrence = calculateNextOccurrence(cd);
                const item = { ...cd, nextOccurrence };

                if (!cd.repeat && new Date(cd.targetTimestamp) <= now) sections.past.items.push(item);
                else if (nextOccurrence.getFullYear() === thisYear && nextOccurrence.getMonth() === thisMonth) sections.month.items.push(item);
                else if (nextOccurrence.getFullYear() === thisYear) sections.year.items.push(item);
                else sections.future.items.push(item);
            });
            
            const tabsContainer = document.createElement('div');
            tabsContainer.className = 'section-tabs';
            listContainerEl.appendChild(tabsContainer);

            Object.entries(sections).forEach(([key, section]) => {
                const tabButton = document.createElement('button');
                tabButton.className = `section-tab-button ${section.active ? 'active' : ''}`;
                tabButton.dataset.tab = key;
                tabButton.textContent = `${section.title} (${section.items.length})`;
                tabsContainer.appendChild(tabButton);

                const tabContent = document.createElement('div');
                tabContent.className = `section-tab-content ${section.active ? 'active' : ''}`;
                tabContent.id = `tab-content-${key}`;
                const ul = document.createElement('ul');

                if (section.items.length > 0) {
                    if (key === 'groups') {
                        section.items.forEach(group => {
                            const li = document.createElement('li');
                            li.dataset.id = group.id;
                            li.dataset.type = 'group';
                            li.innerHTML = `
                                <div class="save-info">
                                    <span class="save-name group-name">${group.name}</span>
                                    <div class="save-details">${group.countdownIds.length} countdown(s) in this group</div>
                                </div>
                                <div class="save-actions">
                                    <button class="open-group-btn">Open</button>
                                    <button class="edit-group-btn">Edit</button>
                                    <button class="delete-group-btn">Delete</button>
                                </div>`;
                            ul.appendChild(li);
                        });
                    } else {
                        section.items.sort((a,b) => a.nextOccurrence - b.nextOccurrence).forEach(cd => {
                            const li = document.createElement('li');
                            li.dataset.id = cd.id;
                            li.dataset.type = 'countdown';
                            const dateDetails = `Target: ${formatDate(cd.nextOccurrence)}`;
                            li.innerHTML = `
                                <div class="save-info">
                                    <span class="save-name">${cd.name} ${cd.repeat ? '🔄' : ''}</span>
                                    <div class="save-details">${dateDetails}</div>
                                </div>
                                <div class="save-actions">
                                    <button class="open-save-btn">Open</button>
                                    <button class="edit-countdown-btn">Edit</button>
                                    <button class="delete-save-btn">Delete</button>
                                </div>`;
                            ul.appendChild(li);
                        });
                    }
                } else {
                    ul.innerHTML = `<div class="no-items-message">No items in this category.</div>`;
                }
                tabContent.appendChild(ul);
                listContainerEl.appendChild(tabContent);
            });

            tabsContainer.addEventListener('click', (e) => {
                const target = e.target.closest('.section-tab-button');
                if (target) {
                    listContainerEl.querySelectorAll('.section-tab-button, .section-tab-content').forEach(el => el.classList.remove('active'));
                    target.classList.add('active');
                    document.getElementById(`tab-content-${target.dataset.tab}`).classList.add('active');
                }
            });
        }
        
        // --- Timer Logic ---
        function formatCountdown(targetDate) {
            const end = new Date(targetDate);
            const now = new Date();
            if (end <= now) { return "🎉 Finished!"; }

            let years = end.getFullYear() - now.getFullYear();
            let months = end.getMonth() - now.getMonth();
            let days = end.getDate() - now.getDate();
            let hours = end.getHours() - now.getHours();
            let minutes = end.getMinutes() - now.getMinutes();
            let seconds = end.getSeconds() - now.getSeconds();

            if (seconds < 0) { minutes--; seconds += 60; }
            if (minutes < 0) { hours--; minutes += 60; }
            if (hours < 0) { days--; hours += 24; }
            if (days < 0) {
                months--;
                const lastDayOfPrevMonth = new Date(end.getFullYear(), end.getMonth(), 0).getDate();
                days += lastDayOfPrevMonth;
            }
            if (months < 0) { years--; months += 12; }
            
            const units = [
                {v: years, l:'yrs'}, {v: months, l:'mths'}, {v: days, l:'days'},
                {v: hours, l:'hrs'}, {v: minutes, l:'mins'}, {v: seconds, l:'secs'}
            ];
            
            const visibleUnits = units.filter((unit, idx) => units.slice(0, idx).reduce((acc, p) => acc + p.v, 0) + unit.v > 0);
            
            return visibleUnits.map(unit => `<span class="time-unit">${unit.v}<span class="time-label">${unit.l}</span></span>`).join('') || `<span class="time-unit">0<span class="time-label">secs</span></span>`;
        }

        function updateTimerDisplay(targetDate) {
            const end = new Date(targetDate); 
            let now = new Date();
            if (end <= now) {
                if (activeGroup) {
                    const currentIndex = activeGroup.sortedCountdowns.findIndex(cd => cd.id === activeCountdown.id);
                    const nextCountdown = activeGroup.sortedCountdowns[currentIndex + 1];
                    if (nextCountdown) {
                        setActiveCountdown(nextCountdown);
                    } else {
                        clearActiveCountdown();
                    }
                } else if (activeCountdown && activeCountdown.repeat) {
                    const nextOccurrence = calculateNextOccurrence(activeCountdown);
                    if (nextOccurrence > now) updateTimerDisplay(nextOccurrence);
                    renderListWithTabs();
                } else {
                    clearInterval(countdownInterval); 
                    const finishedMessage = "🎉 Countdown Finished!";
                    timerDisplayEl.innerHTML = finishedMessage;
                    if (document.fullscreenElement) fullscreenTimer.innerHTML = finishedMessage;
                }
                return;
            }

            const html = formatCountdown(end);
            timerDisplayEl.innerHTML = html;
            if (document.fullscreenElement) fullscreenTimer.innerHTML = html;
        }
        
        function setActiveCountdown(countdown) {
            clearInterval(countdownInterval);
            activeCountdown = countdown;
            activeCountdownNameEl.textContent = activeGroup ? `${activeGroup.name}: ${countdown.name}` : countdown.name;
            const tick = () => updateTimerDisplay(calculateNextOccurrence(countdown));
            tick();
            countdownInterval = setInterval(tick, 1000);
            fullscreenBtn.disabled = false;
            localStorage.setItem(getStorageKey('lastActiveId'), countdown.id);
            if (document.fullscreenElement) {
                updateFullscreenDisplay();
            }
        }

        function setActiveGroup(group) {
            const groupCountdowns = group.countdownIds
                .map(id => userCountdowns.find(cd => cd.id === id))
                .filter(Boolean);

            if (groupCountdowns.length === 0) {
                alert(`The group "${group.name}" has no countdowns.`);
                return;
            }

            const sortedCountdowns = groupCountdowns
                .map(cd => ({ ...cd, nextOccurrence: calculateNextOccurrence(cd) }))
                .sort((a, b) => a.nextOccurrence - b.nextOccurrence);
            
            activeGroup = { ...group, sortedCountdowns };
            setActiveCountdown(sortedCountdowns[0]);
        }
        
        function clearActiveCountdown() {
            clearInterval(countdownInterval); 
            activeCountdown = null;
            activeGroup = null;
            activeCountdownNameEl.textContent = 'No countdown selected';
            timerDisplayEl.textContent = 'Select or create a countdown to begin.';
            fullscreenBtn.disabled = true;
            localStorage.removeItem(getStorageKey('lastActiveId'));
            updateFullscreenGroupView();
        }

        // --- Fullscreen Logic ---
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            fullscreenOverlay.classList.remove('inactive-cursor'); 
            fsControls.classList.remove('controls-hidden');
            fullscreenGroupView.classList.remove('controls-hidden');
            inactivityTimer = setTimeout(() => {
                fullscreenOverlay.classList.add('inactive-cursor'); 
                fsControls.classList.add('controls-hidden'); 
                fullscreenGroupView.classList.add('controls-hidden');
                fsColorPalette.classList.remove('visible');
            }, 3000);
        }

        function updateFullscreenDisplay() {
            if (!activeCountdown) return;
            fullscreenName.textContent = activeGroup ? `${activeGroup.name}: ${activeCountdown.name}` : activeCountdown.name;
            const nextOccurrence = calculateNextOccurrence(activeCountdown);
            fullscreenTargetDate.textContent = `Target: ${formatDate(nextOccurrence)}`;
            updateTimerDisplay(nextOccurrence);
            updateFullscreenGroupView();
        }
        
        function updateFullscreenGroupView() {
            if (activeGroup && document.fullscreenElement) {
                fullscreenGroupView.style.display = 'block';
                const currentIndex = activeGroup.sortedCountdowns.findIndex(cd => cd.id === activeCountdown.id);
                const nextUp = activeGroup.sortedCountdowns.slice(currentIndex + 1, currentIndex + 6); // Show next 5
                fullscreenNextUpList.innerHTML = nextUp.length > 0
                    ? nextUp.map(cd => `<li>${cd.name}</li>`).join('')
                    : '<li>No more countdowns in this group.</li>';
            } else {
                fullscreenGroupView.style.display = 'none';
                fullscreenNextUpList.innerHTML = '';
            }
        }

        function enterFullscreen() {
            if (!activeCountdown) return;
            fullscreenOverlay.classList.add('active');
            updateFullscreenDisplay();
            fullscreenOverlay.addEventListener('mousemove', resetInactivityTimer); resetInactivityTimer();
            fullscreenOverlay.requestFullscreen().catch(e => { alert(`Error entering fullscreen: ${e.message}`); fullscreenOverlay.classList.remove('active'); });
        }

        function handleFullscreenChange() { 
            if (!document.fullscreenElement) {
                fullscreenOverlay.classList.remove('active'); 
                clearTimeout(inactivityTimer);
                fullscreenOverlay.removeEventListener('mousemove', resetInactivityTimer);
                updateFullscreenGroupView();
            } else {
                updateFullscreenGroupView();
            }
        }

        // --- Event Handlers ---
        function handleCountdownFormSubmit(e) {
            e.preventDefault();
            const name = nameInput.value.trim(); const selectedDate = flatpickrInstance.selectedDates[0];
            if (!name || !selectedDate) { alert("Please fill out all fields."); return; }
            if (selectedDate.getTime() < new Date().getTime() && !repeatToggle.checked) { alert("Please select a future date for a non-repeating countdown."); return; }
            let countdownData = { name, targetTimestamp: selectedDate, repeat: null };
            if (repeatToggle.checked) {
                countdownData.repeat = { type: repeatFrequency.value };
                if (repeatFrequency.value === 'weekly') {
                    const days = Array.from(document.querySelectorAll('input[name="repeatDay"]:checked')).map(cb => cb.value);
                    if (days.length === 0) { alert("Please select at least one day for weekly repetition."); return; }
                    countdownData.repeat.days = days;
                }
            }
            if (isEditing) {
                const index = userCountdowns.findIndex(cd => cd.id === editingId);
                if (index > -1) { userCountdowns[index] = { ...userCountdowns[index], ...countdownData }; }
            } else { userCountdowns.push({ id: generateId('cd'), ...countdownData }); }
            saveCountdowns(); closeCountdownModal();
        }
        
        function handleGroupFormSubmit(e) {
            e.preventDefault();
            const name = groupNameInput.value.trim();
            if (!name) { alert("Please enter a group name."); return; }
            const selectedIds = Array.from(groupCountdownSelector.querySelectorAll('input:checked')).map(cb => cb.value);
            if (isEditingGroup) {
                const index = userGroups.findIndex(g => g.id === editingGroupId);
                if (index > -1) { userGroups[index].name = name; userGroups[index].countdownIds = selectedIds; }
            } else {
                userGroups.push({ id: generateId('group'), name, countdownIds: selectedIds });
            }
            saveGroups(); closeGroupModal();
        }

        function handleListClick(e) {
            const li = e.target.closest('li'); if (!li) return;
            const id = li.dataset.id; const type = li.dataset.type;
            
            if (type === 'countdown') {
                const countdown = userCountdowns.find(cd => cd.id === id); if (!countdown) return;
                if (e.target.matches('.open-save-btn')) { activeGroup = null; setActiveCountdown(countdown); }
                else if (e.target.matches('.edit-countdown-btn')) openCountdownModal(true, countdown);
                else if (e.target.matches('.delete-save-btn')) {
                    if (confirm(`Are you sure you want to delete "${countdown.name}"? This will also remove it from any groups.`)) {
                        userCountdowns = userCountdowns.filter(cd => cd.id !== id);
                        userGroups.forEach(group => { group.countdownIds = group.countdownIds.filter(cdId => cdId !== id); });
                        saveGroups();
                        saveCountdowns();
                        if (activeCountdown && activeCountdown.id === id) clearActiveCountdown();
                    }
                }
            } else if (type === 'group') {
                const group = userGroups.find(g => g.id === id); if (!group) return;
                if (e.target.matches('.open-group-btn')) setActiveGroup(group);
                else if (e.target.matches('.edit-group-btn')) openGroupModal(true, group);
                else if (e.target.matches('.delete-group-btn')) {
                    if (confirm(`Are you sure you want to delete the group "${group.name}"?`)) {
                        userGroups = userGroups.filter(g => g.id !== id);
                        saveGroups();
                    }
                }
            }
        }
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            flatpickrInstance = flatpickr("#dateTimePicker", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                altInput: true,
                altFormat: "F j, Y at h:i K",
                minuteIncrement: 1
            });
            
            // Listeners
            addBtn.addEventListener('click', () => openCountdownModal(false));
            addGroupBtn.addEventListener('click', () => openGroupModal(false));
            cancelBtn.addEventListener('click', closeCountdownModal);
            cancelGroupBtn.addEventListener('click', closeGroupModal);
            closeActiveBtn.addEventListener('click', clearActiveCountdown);
            modalOverlay.addEventListener('click', (e) => { if(e.target === modalOverlay) closeCountdownModal(); });
            groupModalOverlay.addEventListener('click', (e) => { if(e.target === groupModalOverlay) closeGroupModal(); });
            countdownForm.addEventListener('submit', handleCountdownFormSubmit);
            groupForm.addEventListener('submit', handleGroupFormSubmit);
            listContainerEl.addEventListener('click', handleListClick);
            fullscreenBtn.addEventListener('click', enterFullscreen);
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            
            // Repeat options
            repeatToggle.addEventListener('change', () => {
                const isRepeating = repeatToggle.checked;
                repeatOptions.classList.toggle('visible', isRepeating);

                const selectedTime = flatpickrInstance.selectedDates[0];

                if (isRepeating) {
                    flatpickrInstance.set('noCalendar', true);
                    flatpickrInstance.set('altFormat', 'h:i K');
                    dateTimePickerLabel.textContent = 'Target Time';
                    dateTimePicker.placeholder = 'Click to select time...';
                } else {
                    flatpickrInstance.set('noCalendar', false);
                    flatpickrInstance.set('altFormat', 'F j, Y at h:i K');
                    dateTimePickerLabel.textContent = 'Target Date & Time';
                    dateTimePicker.placeholder = 'Click to select...';
                }
                
                // Re-apply the selected time to force a redraw with the new format
                if (selectedTime) {
                    flatpickrInstance.setDate(selectedTime, true);
                }
            });

            repeatFrequency.addEventListener('change', () => {
                weeklyRepeatOptions.style.display = repeatFrequency.value === 'weekly' ? 'block' : 'none';
            });

            // Fullscreen Color Picker
            fsColorToggle.addEventListener('click', (e) => { e.stopPropagation(); fsColorPalette.classList.toggle('visible'); });
            document.body.addEventListener('click', () => fsColorPalette.classList.remove('visible'));
            fsColorPalette.addEventListener('click', (e) => {
                const swatch = e.target.closest('.color-swatch'); if (!swatch || swatch.classList.contains('color-swatch-custom')) return;
                e.stopPropagation(); fullscreenOverlay.style.background = swatch.dataset.color;
                localStorage.setItem(getStorageKey('fsColor'), swatch.dataset.color); fsColorPalette.classList.remove('visible');
            });
            document.querySelector('.color-swatch-custom').addEventListener('click', () => colorPickerInput.click());
            colorPickerInput.addEventListener('input', (e) => {
                fullscreenOverlay.style.background = e.target.value; localStorage.setItem(getStorageKey('fsColor'), e.target.value);
            });

            // Auth & Final Setup
            document.getElementById('toggleSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
            document.getElementById('logoutBtn').addEventListener('click', () => firebase.auth().signOut());
            document.getElementById('signOutLink').addEventListener('click', (e) => { e.preventDefault(); firebase.auth().signOut(); });
            firebase.auth().onAuthStateChanged(async user => {
                if (user) {
                    currentUser = user;
                    fullscreenOverlay.style.background = localStorage.getItem(getStorageKey('fsColor')) || '#0a0a14';
                    loadAllData();
                    const lastActiveId = localStorage.getItem(getStorageKey('lastActiveId'));
                    if (lastActiveId) {
                        const cdToLoad = userCountdowns.find(cd => cd.id === lastActiveId);
                        if (cdToLoad) setActiveCountdown(cdToLoad);
                    }
                } else { window.location.href = '../login.html'; }
            });
        });
    </script>
</body>
</html>
