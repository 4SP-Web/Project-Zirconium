<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - ANALYTICS</title>
    <link rel="stylesheet" href="../css/style.css" />
    <script src="../ban-enforcer.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        /* General Layout */
        body.settings-page{display:flex;flex-direction:column;min-height:100vh;margin:0;font-family:'PrimaryFont',sans-serif}
        .settings-container{display:flex;flex:1}
        .sidebar{width:200px;background:linear-gradient(180deg,#333 0%,#2a2a2a 100%);color:#fff;padding:20px 10px;display:flex;flex-direction:column;border-right:1px solid #444;transition:width .5s ease-in-out;position:relative;box-shadow:2px 0 10px rgba(0,0,0,.1)}
        .sidebar.collapsed{width:85px}
        #toggleSidebar{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:0 0;border:none;color:#fff;font-size:1.2em;cursor:pointer;padding:4px;transition:transform .5s ease-in-out}
        .sidebar.collapsed #toggleSidebar{transform:translateX(-50%) rotate(180deg)}
        .sidebar nav ul{list-style:none;padding:0;margin:60px 0 0}
        .sidebar nav li{margin-bottom:10px}
        .sidebar nav a{display:flex;align-items:center;padding:12px 15px;color:#fff;text-decoration:none;border-radius:8px;transition:all .3s ease;font-family:'PrimaryFont',sans-serif;text-transform:uppercase}
        .sidebar nav a.active,.sidebar nav a:hover{background:linear-gradient(135deg,#6720bd 0%,#8a2be2 100%);transform:translateX(5px)}
        .sidebar nav a .icon{font-size:1.2em;width:24px;text-align:center}
        .sidebar nav a .label{margin-left:10px;white-space:nowrap;opacity:1;visibility:visible;transition:opacity .2s ease-in-out;transition-delay:.4s}
        .sidebar.collapsed nav a .label{opacity:0;visibility:hidden;transition-delay:0s}
        .main-content{flex:1;padding:40px;background:linear-gradient(135deg,#f0f2f5 0%,#e8eaf0 100%);overflow-y:auto;position:relative}
        .dashboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;background:#fff;padding:20px 30px;border-radius:15px;box-shadow:0 4px 20px rgba(0,0,0,.08);border:1px solid rgba(103,32,189,.1)}
        .dashboard-title{margin:0;font-size:2.2em;font-weight:700;background:linear-gradient(135deg,#6720bd 0%,#8a2be2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        
        /* Tabs Styles */
        .tabs{display:flex;margin-bottom:0;background:#fff;border-radius:15px 15px 0 0;box-shadow:0 4px 20px rgba(0,0,0,.05);padding:0 20px;border-bottom:2px solid #ddd}
        .tab-button{background:0 0;border:none;padding:15px 25px;cursor:pointer;font-size:1.1em;color:#555;transition:color .3s ease,border-bottom .3s ease;font-family:'PrimaryFont',sans-serif;text-transform:uppercase;letter-spacing:.5px;border-bottom:3px solid transparent;margin-bottom:-2px}
        .tab-button.active{color:#6720bd;border-bottom:3px solid #6720bd;font-weight:700}
        .tab-content{display:none;padding-top:20px;animation:fadeIn .6s ease-out}
        .tab-content.active{display:block}

        /* Stats Grid Styles */
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:30px}
        .stat-card,.chart-container,.content-container{background:#fff;padding:25px;border-radius:20px;box-shadow:0 6px 30px rgba(0,0,0,.08);border:1px solid rgba(103,32,189,.1)}
        .stat-card h3{margin:0 0 10px;font-size:1.1em;color:#555;font-family:'PrimaryFont',sans-serif;text-transform:uppercase;letter-spacing:.5px}
        .stat-card .stat-number{font-size:2.8em;font-weight:700;color:#6720bd;font-family:'PrimaryFont',sans-serif}
        .chart-container{grid-column:1/-1}
        .content-container h3,.chart-container h3{margin:0 0 20px;font-size:1.5em;color:#333;font-family:'PrimaryFont',sans-serif;border-bottom:2px solid rgba(103,32,189,.1);padding-bottom:10px}

        /* User List & Search Styles */
        .controls-bar{display:flex;gap:15px;margin-bottom:20px;align-items:center;flex-wrap:wrap}
        .controls-bar label{font-weight:700;color:#555}
        .controls-bar select,.controls-bar input{padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:.9em;font-family: 'SecondaryFont', sans-serif;}
        .controls-bar .btn{padding:8px 15px;font-size:0.9em;background:#6720bd;color:white;border:none;border-radius:8px;cursor:pointer;}
        #userTable{width:100%;border-collapse:collapse}
        #userTable th,#userTable td{text-align:left;padding:12px 15px;border-bottom:1px solid #eee;font-size:.95em}
        #userTable th{background-color:#f8f8f8;font-weight:700;color:#6720bd;text-transform:uppercase;letter-spacing:.5px}
        #userTable tbody tr{cursor:pointer;transition:background-color .2s ease}
        #userTable tbody tr:hover{background-color:#f0e6ff}
        #user-search-results{margin-top:20px}

        /* Modal Styles */
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px;animation:fadeIn .3s}
        .modal-content{background:#fff;padding:30px;border-radius:20px;max-width:600px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,.2);position:relative}
        .modal-close{position:absolute;top:15px;right:20px;font-size:2em;font-weight:700;color:#888;cursor:pointer;background:0 0;border:none;line-height:1}
        .modal-content h3{margin-top:0;font-size:1.8em;color:#6720bd}
        .detail-grid{display:grid;grid-template-columns:auto 1fr;gap:10px 20px;margin-top:20px}
        .detail-grid strong{font-weight:700;color:#333;text-align:right}
        .detail-grid span{color:#555;word-break:break-all}

        /* Reauthentication Overlay */
        #reauth-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(240,242,245,.95);z-index:1001;display:flex;align-items:center;justify-content:center}
        #reauth-box{background:#fff;padding:40px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.1);max-width:400px;text-align:center}
        #reauth-box .reauth-btn{background:linear-gradient(135deg,#6720bd 0%,#8a2be2 100%);color:#fff;border:none;padding:12px 30px;font-size:1em;border-radius:8px;cursor:pointer;font-family:'PrimaryFont',sans-serif;text-transform:uppercase}
        #reauth-password{width:calc(100% - 24px);padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:15px;font-size:1em}
        
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    </style>
</head>
<body class="settings-page">
    <header class="main-header light-bg">
        <div class="container"><div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer"/></a></div><div class="auth-buttons"><button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button><button id="logoutBtn" class="btn btn-login">LOG OUT</button></div></div>
    </header>

    <div class="settings-container">
        <aside class="sidebar slide-in" id="sidebar">
             <button id="toggleSidebar">‚ò∞</button><nav><ul><li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li><li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li><li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li><li><a href="apps.html"><span class="icon">‚ú®</span><span class="label">Apps</span></a></li><li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li><li id="analyticsLink" style="display:none"><a href="analytics.html" class="active"><span class="icon">üìä</span><span class="label">Analytics</span></a></li><li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li></ul></nav>
        </aside>

        <main class="main-content">
            <div id="reauth-overlay">
                <div id="reauth-box">
                    <h3>Admin Verification</h3><p>Please verify your identity to continue.</p>
                    <div id="reauth-password-group" style="display:none;"><input type="password" id="reauth-password" placeholder="Enter your password..."></div>
                    <button id="reauth-button" class="reauth-btn">Verify</button>
                </div>
            </div>

            <div id="analytics-content" style="visibility: hidden;">
                <div class="dashboard-header fade-in">
                    <h2 class="dashboard-title">Site Analytics</h2>
                </div>

                <div class="tabs">
                    <button class="tab-button active" onclick="openTab(event, 'dashboardTab')">Dashboard</button>
                    <button class="tab-button" onclick="openTab(event, 'userListTab')">User List</button>
                    <button class="tab-button" onclick="openTab(event, 'userSearchTab')">User Search</button>
                </div>

                <div id="dashboardTab" class="tab-content active">
                    <div class="stats-grid fade-in">
                        <div class="stat-card"><h3>Total Users</h3><p class="stat-number" id="totalUsersStat">...</p></div>
                        <div class="stat-card"><h3>Daily Active Users</h3><p class="stat-number" id="dauStat">...</p></div>
                        <div class="stat-card"><h3>Monthly Active Users</h3><p class="stat-number" id="mauStat">...</p></div>
                        <div class="stat-card"><h3>Platform Banned</h3><p class="stat-number" id="bannedCountStat">...</p></div>
                        <div class="stat-card"><h3>Open Requests</h3><p class="stat-number" id="openRequestsStat">...</p></div>
                        <div class="stat-card"><h3>Request-Banned</h3><p class="stat-number" id="requestBannedStat">...</p></div>
                        <div class="chart-container"><h3>New User Signups (Last 30 Days)</h3><canvas id="userSignupsChart"></canvas></div>
                        <div class="chart-container"><h3>Account Type Distribution</h3><canvas id="accountTypeChart" style="max-height:350px"></canvas></div>
                    </div>
                </div>

                <div id="userListTab" class="tab-content">
                    <div class="content-container fade-in">
                        <h3>All Registered Users</h3>
                        <div class="controls-bar">
                            <label for="sort-by">Sort By:</label>
                            <select id="sort-by"><option value="username">Username</option><option value="email">Email</option><option value="createdAt">Creation Date</option></select>
                            <label for="sort-order">Order:</label>
                            <select id="sort-order"><option value="asc">Ascending</option><option value="desc">Descending</option></select>
                        </div>
                        <table id="userTable">
                            <thead><tr><th>Username</th><th>Email</th><th>Auth Method</th><th>Created On</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="userSearchTab" class="tab-content">
                    <div class="content-container fade-in">
                        <h3>Search for a User</h3>
                        <div class="controls-bar">
                            <input type="text" id="search-input" placeholder="Enter username..." size="30">
                            <button id="search-button" class="btn">Search</button>
                        </div>
                        <div id="user-search-results">
                            <p>Enter a username and click Search to see results.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-overlay" id="user-detail-modal">
                <div class="modal-content">
                    <button class="modal-close" id="modal-close-btn">&times;</button>
                    <h3 id="detail-username">User Details</h3>
                    <div class="detail-grid">
                        <strong>User ID:</strong> <span id="detail-uid"></span>
                        <strong>Email:</strong> <span id="detail-email"></span>
                        <strong>Auth Method:</strong> <span id="detail-authMethod"></span>
                        <strong>Created On:</strong> <span id="detail-createdAt"></span>
                        <strong>Last Login:</strong> <span id="detail-lastLogin"></span>
                        <strong>Requests Banned:</strong> <span id="detail-isRequestsBanned"></span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
        const ADMIN_EMAILS = ['4simpleproblems@gmail.com', 'belkwy30@minerva.sparcc.org'];
        const USER_COUNT_OFFSET = 7; // Adjusts user count as requested

        let allUsersData = []; // Cache for user data to avoid re-fetching
        let charts = {}; // To hold chart instances for proper destruction

        // --- Entry Point ---
        firebase.auth().onAuthStateChanged(user => {
            if (!user || !ADMIN_EMAILS.includes(user.email)) {
                window.location.href = 'dashboard.html';
                return;
            }
            document.getElementById('analyticsLink').style.display = 'list-item';
            setupReauthentication(user);
        });

        // --- Reauthentication ---
        function setupReauthentication(user) {
            const reauthButton = document.getElementById('reauth-button');
            const passwordGroup = document.getElementById('reauth-password-group');
            const providerData = user.providerData.find(p => p.providerId !== 'firebase');
            
            passwordGroup.style.display = (providerData?.providerId === 'password') ? 'block' : 'none';

            reauthButton.onclick = async () => {
                try {
                    if (providerData.providerId === 'password') {
                        const password = document.getElementById('reauth-password').value;
                        if (!password) return alert("Please enter your password.");
                        await user.reauthenticateWithCredential(firebase.auth.EmailAuthProvider.credential(user.email, password));
                    } else if (providerData.providerId === 'google.com') {
                        await user.reauthenticateWithPopup(new firebase.auth.GoogleAuthProvider());
                    } else if (providerData.providerId === 'github.com') {
                        await user.reauthenticateWithPopup(new firebase.auth.GithubAuthProvider());
                    }
                    
                    document.getElementById('reauth-overlay').style.display = 'none';
                    document.getElementById('analytics-content').style.visibility = 'visible';
                    fetchAllAnalytics();
                } catch (error) {
                    alert("Reauthentication failed. Please check your credentials and try again.");
                }
            };
        }

        // --- Data Fetching and Processing ---
        async function fetchAllAnalytics() {
            const db = firebase.firestore();
            try {
                const [usersSnapshot, requestsSnapshot, bannedSnapshot] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('requests').get(),
                    db.collection('bans').get()
                ]);

                document.getElementById('bannedCountStat').textContent = bannedSnapshot.size;
                processUserData(usersSnapshot.docs);
                processRequestsData(requestsSnapshot.docs);
                setupEventListeners();
            } catch (error) {
                console.error("Error fetching analytics:", error);
            }
        }

        function processUserData(userDocs) {
            let requestBannedCount = 0, dau = 0, mau = 0;
            const signupsByDay = {}, accountTypes = { "Email/Password": 0, "Google": 0, "GitHub": 0, "Unknown": 0 };
            const now = new Date(), twentyFourHoursAgo = new Date(now.getTime() - 864e5), thirtyDaysAgo = new Date(now.getTime() - 2592e6);

            allUsersData = userDocs.map(doc => {
                const data = doc.data();
                if (data.isRequestsBanned) requestBannedCount++;
                const createdAt = data.createdAt?.toDate();
                if (createdAt && createdAt >= thirtyDaysAgo) {
                    const day = createdAt.toISOString().split('T')[0];
                    signupsByDay[day] = (signupsByDay[day] || 0) + 1;
                }
                const lastLogin = data.lastLogin?.toDate();
                if (lastLogin) {
                    if (lastLogin >= twentyFourHoursAgo) dau++;
                    if (lastLogin >= thirtyDaysAgo) mau++;
                }
                let authMethodKey = "Unknown";
                if (data.authMethod === 'google') authMethodKey = "Google";
                else if (data.authMethod === 'github') authMethodKey = "GitHub";
                else if (data.authMethod === 'password') authMethodKey = "Email/Password";
                accountTypes[authMethodKey]++;

                return {
                    uid: doc.id,
                    username: data.username || 'N/A', email: data.email || 'N/A',
                    authMethod: authMethodKey, createdAt: createdAt, lastLogin: lastLogin,
                    isRequestsBanned: data.isRequestsBanned ? 'Yes' : 'No'
                };
            });

            document.getElementById('totalUsersStat').textContent = Math.max(0, userDocs.length - USER_COUNT_OFFSET);
            document.getElementById('dauStat').textContent = dau;
            document.getElementById('mauStat').textContent = mau;
            document.getElementById('requestBannedStat').textContent = requestBannedCount;

            renderUserSignupsChart(signupsByDay);
            renderAccountTypeChart(accountTypes);
            sortAndRenderUserList();
        }

        function processRequestsData(requestDocs) {
            let openRequests = 0;
            requestDocs.forEach(doc => {
                if (doc.data().status === 'open') openRequests++;
            });
            document.getElementById('openRequestsStat').textContent = openRequests;
        }

        // --- Rendering Functions ---
        function renderChart(canvasId, config) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            charts[canvasId] = new Chart(ctx, config);
        }

        function renderUserSignupsChart(signupData) {
            const labels = [], data = [];
            for (let i = 29; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const dayString = d.toISOString().split('T')[0];
                labels.push(d); data.push(signupData[dayString] || 0);
            }
            renderChart('userSignupsChart', { type: 'line', data: { labels: labels, datasets: [{ label: 'New Users', data: data, borderColor: '#8a2be2', backgroundColor: 'rgba(138, 43, 226, 0.1)', fill: true, tension: 0.4 }] }, options: { scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: true, ticks: { precision: 0 } } } } });
        }
        
        function renderAccountTypeChart(accountTypes) {
            const labels = Object.keys(accountTypes).filter(key => accountTypes[key] > 0);
            const data = labels.map(key => accountTypes[key]);
            renderChart('accountTypeChart', { type: 'doughnut', data: { labels: labels, datasets: [{ label: 'Account Types', data: data, backgroundColor: ['#6720bd', '#4285F4', '#333', '#999'], hoverOffset: 4 }] } });
        }

        function renderUserList(users, container) {
            const tableBody = container || document.querySelector('#userTable tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            if (users.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 4;
                cell.textContent = 'No users found.';
                cell.style.textAlign = 'center';
                return;
            }
            users.forEach(user => {
                const row = tableBody.insertRow();
                row.dataset.uid = user.uid;
                row.insertCell().textContent = user.username;
                row.insertCell().textContent = user.email;
                row.insertCell().textContent = user.authMethod;
                row.insertCell().textContent = user.createdAt ? user.createdAt.toLocaleDateString() : 'N/A';
            });
        }
        
        // --- UI Interactivity ---
        function sortAndRenderUserList() {
            const sortBy = document.getElementById('sort-by').value;
            const sortOrder = document.getElementById('sort-order').value;
            const sortedUsers = [...allUsersData].sort((a, b) => {
                const valA = a[sortBy], valB = b[sortBy];
                if (valA instanceof Date) return sortOrder === 'asc' ? valA - valB : valB - valA;
                return sortOrder === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
            });
            renderUserList(sortedUsers);
        }

        function showUserDetailModal(uid) {
            const user = allUsersData.find(u => u.uid === uid);
            if (!user) return;
            document.getElementById('detail-username').textContent = user.username;
            document.getElementById('detail-uid').textContent = user.uid;
            document.getElementById('detail-email').textContent = user.email;
            document.getElementById('detail-authMethod').textContent = user.authMethod;
            document.getElementById('detail-createdAt').textContent = user.createdAt ? user.createdAt.toLocaleString() : 'N/A';
            document.getElementById('detail-lastLogin').textContent = user.lastLogin ? user.lastLogin.toLocaleString() : 'N/A';
            document.getElementById('detail-isRequestsBanned').textContent = user.isRequestsBanned;
            document.getElementById('user-detail-modal').style.display = 'flex';
        }

        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        function setupEventListeners() {
            document.getElementById('sort-by')?.addEventListener('change', sortAndRenderUserList);
            document.getElementById('sort-order')?.addEventListener('change', sortAndRenderUserList);
            
            document.getElementById('search-button')?.addEventListener('click', () => {
                const query = document.getElementById('search-input').value.toLowerCase();
                if (!query) return;
                const results = allUsersData.filter(u => u.username.toLowerCase().includes(query));
                const resultsContainer = document.getElementById('user-search-results');
                resultsContainer.innerHTML = ''; // Clear previous
                const table = document.createElement('table');
                table.id = 'searchResultsTable';
                table.innerHTML = `<thead><tr><th>Username</th><th>Email</th><th>Auth Method</th></tr></thead><tbody></tbody>`;
                resultsContainer.appendChild(table);
                renderUserList(results, table.querySelector('tbody'));
            });

            document.getElementById('userTable')?.querySelector('tbody').addEventListener('click', e => {
                const row = e.target.closest('tr');
                if (row?.dataset.uid) showUserDetailModal(row.dataset.uid);
            });
            
            document.getElementById('user-search-results')?.addEventListener('click', e => {
                const row = e.target.closest('tr');
                if (row?.dataset.uid) showUserDetailModal(row.dataset.uid);
            });
            
            document.getElementById('modal-close-btn')?.addEventListener('click', () => document.getElementById('user-detail-modal').style.display = 'none');
            document.getElementById('user-detail-modal')?.addEventListener('click', e => {
                if (e.target === e.currentTarget) e.currentTarget.style.display = 'none';
            });

            document.getElementById('logoutBtn').onclick = () => firebase.auth().signOut().then(() => location.href = '../login.html');
            document.getElementById('toggleSidebar').onclick = () => document.getElementById('sidebar').classList.toggle('collapsed');
        }
    </script>
</body>
</html>
