<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - ANALYTICS</title>
    <link rel="stylesheet" href="../css/style.css" />
    <script src="../ban-enforcer.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body.settings-page{display:flex;flex-direction:column;min-height:100vh;margin:0;font-family:'PrimaryFont',sans-serif}.settings-container{display:flex;flex:1}.sidebar{width:200px;background:linear-gradient(180deg,#333 0%,#2a2a2a 100%);color:#fff;padding:20px 10px;display:flex;flex-direction:column;border-right:1px solid #444;transition:width .5s ease-in-out;position:relative;box-shadow:2px 0 10px rgba(0,0,0,.1)}.sidebar.collapsed{width:85px}#toggleSidebar{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:0 0;border:none;color:#fff;font-size:1.2em;cursor:pointer;padding:4px;transition:transform .5s ease-in-out}.sidebar.collapsed #toggleSidebar{transform:translateX(-50%) rotate(180deg)}.sidebar nav ul{list-style:none;padding:0;margin:60px 0 0}.sidebar nav li{margin-bottom:10px}.sidebar nav a{display:flex;align-items:center;padding:12px 15px;color:#fff;text-decoration:none;border-radius:8px;transition:all .3s ease;font-family:'PrimaryFont',sans-serif;text-transform:uppercase}.sidebar nav a.active,.sidebar nav a:hover{background:linear-gradient(135deg,#6720bd 0%,#8a2be2 100%);transform:translateX(5px)}.sidebar nav a .icon{font-size:1.2em;width:24px;text-align:center}.sidebar nav a .label{margin-left:10px;white-space:nowrap;opacity:1;visibility:visible;transition:opacity .2s ease-in-out;transition-delay:.4s}.sidebar.collapsed nav a .label{opacity:0;visibility:hidden;transition-delay:0s}.main-content{flex:1;padding:40px;background:linear-gradient(135deg,#f0f2f5 0%,#e8eaf0 100%);overflow-y:auto;position:relative}.dashboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:40px;background:#fff;padding:20px 30px;border-radius:15px;box-shadow:0 4px 20px rgba(0,0,0,.08);border:1px solid rgba(103,32,189,.1)}.dashboard-title{margin:0;font-size:2.2em;font-weight:700;background:linear-gradient(135deg,#6720bd 0%,#8a2be2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:30px}.stat-card,.chart-container{background:#fff;padding:25px;border-radius:20px;box-shadow:0 6px 30px rgba(0,0,0,.08);border:1px solid rgba(103,32,189,.1);transition:all .3s cubic-bezier(.4,0,.2,1)}.stat-card:hover,.chart-container:hover{transform:translateY(-8px) scale(1.02);box-shadow:0 15px 40px rgba(103,32,189,.15);border-color:rgba(103,32,189,.3)}.stat-card h3{margin:0 0 10px;font-size:1.1em;color:#555;font-family:'PrimaryFont',sans-serif;text-transform:uppercase;letter-spacing:.5px}.stat-card .stat-number{font-size:2.8em;font-weight:700;color:#6720bd;font-family:'PrimaryFont',sans-serif}.stat-card .stat-number .loader{font-size:.5em;color:#999}.chart-container{grid-column:1/-1;padding:30px}.chart-container h3{margin:0 0 25px;font-size:1.5em;color:#333;font-family:'PrimaryFont',sans-serif;border-bottom:2px solid rgba(103,32,189,.1);padding-bottom:10px}.fade-in{animation:fadeIn .6s ease-out}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        /* CORRECTED Reauthentication Overlay Style */
        #reauth-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(240,242,245,.95);z-index:100;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;transition:opacity .3s ease;padding:20px}#reauth-box{background:#fff;padding:40px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.1);max-width:400px}#reauth-box h3{font-size:1.6em;color:#333;margin-top:0}#reauth-box p{color:#666;margin-bottom:25px}#reauth-box .reauth-btn{background:linear-gradient(135deg,#6720bd 0%,#8a2be2 100%);color:#fff;border:none;padding:12px 30px;font-size:1em;border-radius:8px;cursor:pointer;transition:all .3s ease;font-family:'PrimaryFont',sans-serif;text-transform:uppercase}#reauth-box .reauth-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(103,32,189,.3)}#reauth-password{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:15px;font-size:1em}
    </style>
</head>
<body class="settings-page">
    <header class="main-header light-bg">
        <div class="container"><div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer"/></a></div><div class="auth-buttons"><button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button><button id="logoutBtn" class="btn btn-login">LOG OUT</button></div></div>
    </header>

    <div class="settings-container">
        <aside class="sidebar slide-in" id="sidebar">
             <button id="toggleSidebar">‚ò∞</button><nav><ul><li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li><li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li><li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li><li><a href="apps.html"><span class="icon">‚ú®</span><span class="label">Apps</span></a></li><li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li><li id="analyticsLink" style="display:none"><a href="analytics.html" class="active"><span class="icon">üìä</span><span class="label">Analytics</span></a></li><li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li></ul></nav>
        </aside>

        <main class="main-content">
            <div id="reauth-overlay">
                <div id="reauth-box">
                    <h3>Admin Verification Required</h3>
                    <p>For security, please re-authenticate to access the analytics dashboard.</p>
                    <div id="reauth-password-group" style="display: none;">
                        <input type="password" id="reauth-password" placeholder="Enter your password...">
                    </div>
                    <button id="reauth-button" class="reauth-btn">Re-authenticate</button>
                </div>
            </div>

            <div id="analytics-content" style="visibility: hidden;">
                <div class="dashboard-header fade-in">
                    <h2 class="dashboard-title">Site Analytics</h2>
                </div>

                <div class="analytics-grid fade-in">
                    <div class="stat-card"><h3>Total Users</h3><p class="stat-number" id="totalUsersStat"><span class="loader">Loading...</span></p></div>
                    <div class="stat-card"><h3>Daily Active Users (DAU)</h3><p class="stat-number" id="dauStat"><span class="loader">Loading...</span></p></div>
                    <div class="stat-card"><h3>Monthly Active Users (MAU)</h3><p class="stat-number" id="mauStat"><span class="loader">Loading...</span></p></div>
                    <div class="stat-card"><h3>Platform Banned Users</h3><p class="stat-number" id="bannedCountStat"><span class="loader">Loading...</span></p></div>
                    <div class="stat-card"><h3>Open Feature Requests</h3><p class="stat-number" id="openRequestsStat"><span class="loader">Loading...</span></p></div>
                    <div class="stat-card"><h3>Total Engagements (Votes)</h3><p class="stat-number" id="totalVotesStat"><span class="loader">Loading...</span></p></div>
                    <div class="stat-card"><h3>Request-Banned Users</h3><p class="stat-number" id="requestBannedStat"><span class="loader">Loading...</span></p></div>

                    <div class="chart-container"><h3>New User Signups (Last 30 Days)</h3><canvas id="userSignupsChart"></canvas></div>
                    <div class="chart-container"><h3>Account Type Distribution</h3><canvas id="accountTypeChart" style="max-height:350px"></canvas></div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
        const ADMIN_EMAILS = ['4simpleproblems@gmail.com', 'belkwy30@minerva.sparcc.org'];

        firebase.auth().onAuthStateChanged(user => {
            if (!user || !ADMIN_EMAILS.includes(user.email)) {
                window.location.href = 'dashboard.html';
                return;
            }
            document.getElementById('analyticsLink').style.display = 'list-item';
            setupReauthentication(user);
        });

        function setupReauthentication(user) {
            const reauthButton = document.getElementById('reauth-button');
            const passwordGroup = document.getElementById('reauth-password-group');
            const passwordInput = document.getElementById('reauth-password');
            
            // This logic correctly checks the user's provider and sets up the right UI.
            const providerData = user.providerData[0];
            let authProvider = null;

            if (providerData.providerId === 'password') {
                passwordGroup.style.display = 'block';
                reauthButton.textContent = 'Verify with Password';
            } else if (providerData.providerId === 'google.com') {
                authProvider = new firebase.auth.GoogleAuthProvider();
                reauthButton.textContent = 'Verify with Google';
            } else if (providerData.providerId === 'github.com') {
                authProvider = new firebase.auth.GithubAuthProvider();
                reauthButton.textContent = 'Verify with GitHub';
            }

            reauthButton.onclick = async () => {
                try {
                    if (authProvider) {
                        await user.reauthenticateWithPopup(authProvider);
                    } else { 
                        const password = passwordInput.value;
                        if (!password) { alert("Please enter your password."); return; }
                        const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
                        await user.reauthenticateWithCredential(credential);
                    }
                    
                    document.getElementById('reauth-overlay').style.display = 'none';
                    document.getElementById('analytics-content').style.visibility = 'visible';
                    fetchAllAnalytics();
                } catch (error) {
                    console.error("Reauthentication failed:", error);
                    alert("Reauthentication failed. Please check your credentials and try again.");
                }
            };
        }

        async function fetchAllAnalytics() {
            console.log("Fetching all analytics from Firestore (client-side)...");
            const db = firebase.firestore();
            try {
                // Fetch data from multiple collections in parallel for speed
                const [bannedSnapshot, usersSnapshot, requestsSnapshot] = await Promise.all([
                    db.collection('bans').get(),
                    db.collection('users').get(),
                    db.collection('requests').get()
                ]);

                // Process each dataset
                document.getElementById('bannedCountStat').textContent = bannedSnapshot.size;
                processUserData(usersSnapshot.docs);
                processRequestsData(requestsSnapshot.docs);

            } catch (error) {
                console.error("Error fetching analytics data:", error);
                alert("An error occurred while fetching data. Check your Firestore rules and the console.");
            }
        }

        function processUserData(userDocs) {
            let requestBannedCount = 0;
            let dau = 0;
            let mau = 0;
            const signupsByDay = {};
            const accountTypes = { "Email/Password": 0, "Google": 0, "GitHub": 0 };

            const now = new Date();
            const twentyFourHoursAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));

            userDocs.forEach(doc => {
                const data = doc.data();

                // Check for request bans
                if (data.isRequestsBanned === true) {
                    requestBannedCount++;
                }

                const createdAt = data.createdAt?.toDate();
                if (createdAt && createdAt >= thirtyDaysAgo) {
                    const day = createdAt.toISOString().split('T')[0];
                    signupsByDay[day] = (signupsByDay[day] || 0) + 1;
                }

                const lastLogin = data.lastLogin?.toDate();
                if (lastLogin) {
                    if (lastLogin >= twentyFourHoursAgo) dau++;
                    if (lastLogin >= thirtyDaysAgo) mau++;
                }

                if (data.provider === 'google.com') accountTypes.Google++;
                else if (data.provider === 'github.com') accountTypes.GitHub++;
                else accountTypes["Email/Password"]++;
            });

            document.getElementById('totalUsersStat').textContent = userDocs.length;
            document.getElementById('dauStat').textContent = dau;
            document.getElementById('mauStat').textContent = mau;
            document.getElementById('requestBannedStat').textContent = requestBannedCount;

            renderUserSignupsChart(signupsByDay);
            renderAccountTypeChart(accountTypes);
        }

        function processRequestsData(requestDocs) {
            let openRequests = 0;
            let totalVotes = 0;

            requestDocs.forEach(doc => {
                const data = doc.data();
                // Assumes a status field, e.g., 'open', 'approved', 'denied'
                if (data.status === 'open') {
                    openRequests++;
                }
                totalVotes += (data.upvotes || 0);
                totalVotes += (data.downvotes || 0);
            });

            document.getElementById('openRequestsStat').textContent = openRequests;
            document.getElementById('totalVotesStat').textContent = totalVotes;
        }

        function renderUserSignupsChart(signupData) {
            const ctx = document.getElementById('userSignupsChart').getContext('2d');
            const labels = []; const data = [];
            for (let i = 29; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const dayString = d.toISOString().split('T')[0];
                labels.push(d); data.push(signupData[dayString] || 0);
            }
            new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'New Users', data: data, borderColor: '#8a2be2', backgroundColor: 'rgba(138, 43, 226, 0.1)', fill: true, tension: 0.4 }] }, options: { scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: true, ticks: { precision: 0 } } } } });
        }
        
        function renderAccountTypeChart(accountTypes) {
            const ctx = document.getElementById('accountTypeChart').getContext('2d');
            new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(accountTypes), datasets: [{ label: 'Account Types', data: Object.values(accountTypes), backgroundColor: ['#6720bd', '#4285F4', '#333'], hoverOffset: 4 }] } });
        }

        document.getElementById('logoutBtn').onclick = () => firebase.auth().signOut().then(() => location.href = '../login.html');
        document.getElementById('toggleSidebar').onclick = () => document.getElementById('sidebar').classList.toggle('collapsed');
    </script>
</body>
</html>
