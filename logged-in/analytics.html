<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - ANALYTICS</title>
    <link rel="stylesheet" href="../css/style.css" />
    <script src="../ban-enforcer.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    /* --- Base Layout (from settings.html) --- */
    body.analytics-page {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        margin: 0;
        font-family: 'PrimaryFont', sans-serif;
    }
    .analytics-container {
        display: flex;
        flex: 1;
    }

    /* --- Sidebar (from settings.html) --- */
    .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.collapsed { width: 85px; }
    #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
    .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
    .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
    .sidebar nav li { margin-bottom: 10px; }
    .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
    .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
    .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
    .sidebar nav a .label { 
        margin-left: 10px; 
        white-space: nowrap; 
        opacity: 1;
        visibility: visible;
        transition: opacity 0.2s ease-in-out;
        transition-delay: 0.4s;
    }
    .sidebar.collapsed nav a .label { 
        opacity: 0;
        visibility: hidden;
        transition-delay: 0s;
    }

    /* --- Main Content (from settings.html) --- */
    .main-content {
        flex: 1;
        padding: 40px;
        background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
        overflow-y: auto;
        position: relative;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
        background: white;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid rgba(103, 32, 189, 0.1);
    }

    .dashboard-title {
        margin: 0;
        font-size: 2.2em;
        font-weight: bold;
        background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* --- Reauthentication Section (adapted from settings.html) --- */
    #reauth-section, #access-denied-section {
        background: #fff;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 6px 30px rgba(0,0,0,0.08);
        text-align: center;
        border: 1px solid rgba(103, 32, 189, 0.1);
    }
    #reauth-section h3, #access-denied-section h3 {
        font-family: 'PrimaryFont', sans-serif;
        margin: 0 0 15px;
        font-size: 1.6em;
        color: #333;
    }
    #reauth-section p, #access-denied-section p {
        font-family: 'SecondaryFont', sans-serif;
        color: #666;
        margin-bottom: 30px;
        line-height: 1.6;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }
    .settings-form { display: flex; flex-direction: column; gap: 15px; align-items: center; }
    .settings-form input { padding: 12px 15px; border: 1px solid #ddd; border-radius: 12px; font-size: 1em; width: 100%; max-width: 350px; }
    .reauth-btn { background: linear-gradient(135deg, #4285F4 0%, #3478e6 100%); color: #fff; border: none; padding: 12px 25px; border-radius: 8px; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; font-size: 1em; }
    .reauth-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3); }

    /* --- Analytics Content --- */
    #analytics-content {
        display: none; /* Hidden by default */
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
    }
    .stat-card {
        background: #fff;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 6px 30px rgba(0,0,0,0.07);
        border: 1px solid #f0f0f0;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 35px rgba(0,0,0,0.1);
    }
    .stat-card-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
    }
    .stat-card-icon {
        font-size: 1.8em;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
    }
    .icon-users { background: linear-gradient(135deg, #007bff, #00bfff); }
    .icon-requests { background: linear-gradient(135deg, #28a745, #20c997); }
    .icon-logins { background: linear-gradient(135deg, #ffc107, #fd9e02); }
    .icon-activity { background: linear-gradient(135deg, #e83e8c, #dc3545); }
    .stat-card-title {
        font-family: 'PrimaryFont', sans-serif;
        font-size: 1.1em;
        color: #555;
        font-weight: 600;
        margin: 0;
    }
    .stat-card-value {
        font-family: 'PrimaryFont', sans-serif;
        font-size: 2.5em;
        font-weight: bold;
        color: #333;
        margin: 0;
    }
    .chart-container {
        margin-top: 20px;
        position: relative;
        height: 300px;
    }
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #6720bd;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 40px auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .fade-in { animation: fadeIn 0.6s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="analytics-page">
    <header class="main-header light-bg">
        <div class="container">
            <div class="logo">
                <a href="../index.html">
                    <img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer"/>
                </a>
            </div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="analytics-container">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">‚ò∞</button>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="apps.html"><span class="icon">‚ú®</span><span class="label">Apps</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="analytics.html" class="active"><span class="icon">üìä</span><span class="label">Analytics</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content fade-in">
            <div class="dashboard-header">
                <h2 class="dashboard-title">Site Analytics</h2>
            </div>
            
            <section id="access-denied-section" style="display: none;">
                <h3>üö´ Access Denied</h3>
                <p>You do not have the required permissions to view this page. This area is restricted to site administrators.</p>
                <button class="btn btn-login" onclick="window.location.href='dashboard.html'">Return to Dashboard</button>
            </section>

            <section id="reauth-section" style="display: none;">
                <h3>üîê Admin Verification Required</h3>
                <p>For security purposes, please re-authenticate your account to access the analytics dashboard.</p>
                <div class="reauth-wrapper">
                    <form class="settings-form" id="email-reauth-form" style="display: none;">
                        <div class="form-group">
                            <input type="password" id="reauthPassword" placeholder="Enter password & press Enter..." required>
                        </div>
                    </form>
                    <button class="reauth-btn" id="reauthBtn" style="display: none;">Reauthenticate</button>
                </div>
            </section>

            <section id="analytics-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon icon-users">üë•</div>
                            <h3 class="stat-card-title">Total Users</h3>
                        </div>
                        <p class="stat-card-value" id="total-users-value"><div class="loading-spinner"></div></p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon icon-requests">üìù</div>
                            <h3 class="stat-card-title">Total Submissions</h3>
                        </div>
                        <p class="stat-card-value" id="total-requests-value"><div class="loading-spinner"></div></p>
                    </div>
                     <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon icon-activity">üó≥Ô∏è</div>
                            <h3 class="stat-card-title">Average Vote Score</h3>
                        </div>
                        <p class="stat-card-value" id="avg-votes-value"><div class="loading-spinner"></div></p>
                    </div>
                    <div class="stat-card">
                        <h3 class="stat-card-title">Account Types Breakdown</h3>
                        <div class="chart-container" id="account-types-container">
                            <div class="loading-spinner"></div>
                            <canvas id="accountTypesChart"></canvas>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3 class="stat-card-title">Submission Types Breakdown</h3>
                        <div class="chart-container" id="request-types-container">
                            <div class="loading-spinner"></div>
                            <canvas id="requestTypesChart"></canvas>
                        </div>
                    </div>
                     <div class="stat-card" style="grid-column: 1 / -1;">
                        <h3 class="stat-card-title">User Signups Over Time (Last 30 Days)</h3>
                        <div class="chart-container" id="signups-chart-container">
                             <div class="loading-spinner"></div>
                            <canvas id="userSignupsChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
        // --- Globals & Configuration ---
        const ALLOWED_ADMINS = ['4simpleproblems@gmail.com', 'belkwy30@minerva.sparcc.org'];
        let currentUser = null;
        let authMethod = 'password';

        // --- AUTH & PAGE INITIALIZATION ---
        firebase.auth().onAuthStateChanged(user => {
            if (!user) {
                // No user logged in, redirect to login page.
                location.href = '../login.html';
                return;
            }
            currentUser = user;

            // Check if the current user is in the allowed admin list.
            if (!ALLOWED_ADMINS.includes(user.email)) {
                // If not an allowed admin, show access denied message and stop.
                document.getElementById('access-denied-section').style.display = 'block';
                document.getElementById('reauth-section').style.display = 'none';
                document.getElementById('analytics-content').style.display = 'none';
                return;
            }
            
            // If the user is an allowed admin, check for reauthentication status.
            checkLocalReauthStatus();
        });

        function checkLocalReauthStatus() {
            const reauthKey = `analytics_reauth_status_${currentUser.uid}`;
            const isReauthenticated = sessionStorage.getItem(reauthKey) === 'true';

            if (isReauthenticated) {
                // If already reauthenticated in this session, show the analytics content.
                showAnalyticsContent();
            } else {
                // Otherwise, show the reauthentication prompt.
                setupReauthUI();
            }
        }
        
        function setupReauthUI() {
            document.getElementById('reauth-section').style.display = 'block';
            const emailReauthForm = document.getElementById('email-reauth-form');
            const reauthBtn = document.getElementById('reauthBtn');
            const reauthPasswordInput = document.getElementById('reauthPassword');

            const isGoogle = currentUser.providerData.some(p => p.providerId === 'google.com');
            const isGithub = currentUser.providerData.some(p => p.providerId === 'github.com');
            
            if (isGoogle) { authMethod = 'google'; } 
            else if (isGithub) { authMethod = 'github'; } 
            else { authMethod = 'password'; }

            if (authMethod === 'google' || authMethod === 'github') {
                const providerName = authMethod.charAt(0).toUpperCase() + authMethod.slice(1);
                reauthBtn.textContent = `Reauthenticate with ${providerName}`;
                reauthBtn.style.display = 'block';
                emailReauthForm.style.display = 'none';
                reauthBtn.onclick = reauthenticateWithPopup;
            } else {
                emailReauthForm.style.display = 'block';
                reauthBtn.style.display = 'none';
                reauthPasswordInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        reauthenticateWithPassword(reauthPasswordInput.value);
                    }
                });
            }
        }
        
        function handleSuccessfulReauth() {
            const reauthKey = `analytics_reauth_status_${currentUser.uid}`;
            sessionStorage.setItem(reauthKey, 'true');
            showAnalyticsContent();
        }
        
        function showAnalyticsContent() {
            document.getElementById('reauth-section').style.display = 'none';
            document.getElementById('access-denied-section').style.display = 'none';
            document.getElementById('analytics-content').style.display = 'block';
            loadAllAnalyticsData();
        }

        // --- Reauthentication Functions ---
        async function reauthenticateWithPassword(password) {
            if (!password) return alert('Please enter your password.');
            const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
            try {
                await currentUser.reauthenticateWithCredential(credential);
                handleSuccessfulReauth();
            } catch (error) {
                alert(error.code === 'auth/wrong-password' ? 'Authentication failed: Incorrect password.' : `Auth failed: ${error.message}`);
            }
        }

        async function reauthenticateWithPopup() {
            let provider;
            if (authMethod === 'google') provider = new firebase.auth.GoogleAuthProvider();
            else if (authMethod === 'github') provider = new firebase.auth.GithubAuthProvider();
            else return;

            try {
                await currentUser.reauthenticateWithPopup(provider);
                handleSuccessfulReauth();
            } catch (error) {
                alert(`Reauthentication failed: ${error.message}`);
            }
        }

        // --- Analytics Data Fetching & Rendering ---
        async function loadAllAnalyticsData() {
            // Use Promise.all to fetch all data concurrently for better performance
            await Promise.all([
                fetchAndDisplayTotalUsers(),
                fetchAndDisplayTotalRequests(),
                fetchAndRenderAccountTypes(),
                fetchAndRenderRequestTypes(),
                fetchAndRenderUserSignups(),
                fetchAndDisplayAverageVoteScore(),
            ]);
        }

        async function fetchAndDisplayTotalUsers() {
            try {
                const snapshot = await firebase.firestore().collection('users').get();
                document.getElementById('total-users-value').textContent = snapshot.size;
            } catch (error) {
                console.error("Error fetching total users:", error);
                document.getElementById('total-users-value').textContent = 'Error';
            }
        }

        async function fetchAndDisplayTotalRequests() {
            try {
                const snapshot = await firebase.firestore().collection('requests').get();
                document.getElementById('total-requests-value').textContent = snapshot.size;
            } catch (error) {
                console.error("Error fetching total requests:", error);
                document.getElementById('total-requests-value').textContent = 'Error';
            }
        }
        
        async function fetchAndDisplayAverageVoteScore() {
            try {
                const snapshot = await firebase.firestore().collection('requests').get();
                if (snapshot.empty) {
                     document.getElementById('avg-votes-value').textContent = 'N/A';
                     return;
                }
                let totalScore = 0;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const score = (data.upvotes || 0) - (data.downvotes || 0);
                    totalScore += score;
                });
                const avgScore = (totalScore / snapshot.size).toFixed(1);
                document.getElementById('avg-votes-value').textContent = avgScore;
            } catch (error) {
                console.error("Error fetching average vote score:", error);
                document.getElementById('avg-votes-value').textContent = 'Error';
            }
        }

        async function fetchAndRenderAccountTypes() {
            const container = document.getElementById('account-types-container');
            try {
                const snapshot = await firebase.firestore().collection('users').get();
                const providerCounts = { Email: 0, Google: 0, GitHub: 0 };
                snapshot.forEach(doc => {
                    const providers = doc.data().providerData || [];
                    if (providers.some(p => p.providerId === 'google.com')) {
                        providerCounts.Google++;
                    } else if (providers.some(p => p.providerId === 'github.com')) {
                        providerCounts.GitHub++;
                    } else {
                        providerCounts.Email++;
                    }
                });
                renderPieChart('accountTypesChart', Object.keys(providerCounts), Object.values(providerCounts));
                container.querySelector('.loading-spinner').style.display = 'none';
            } catch (error) {
                console.error("Error fetching account types:", error);
                container.innerHTML = '<p>Error loading chart data.</p>';
            }
        }

        async function fetchAndRenderRequestTypes() {
            const container = document.getElementById('request-types-container');
            try {
                const snapshot = await firebase.firestore().collection('requests').get();
                const typeCounts = { Sound: 0, Feature: 0, Issue: 0 };
                snapshot.forEach(doc => {
                    const type = doc.data().type;
                    if (type === 'sound') typeCounts.Sound++;
                    else if (type === 'feature') typeCounts.Feature++;
                    else if (type === 'issue') typeCounts.Issue++;
                });
                renderPieChart('requestTypesChart', Object.keys(typeCounts), Object.values(typeCounts));
                container.querySelector('.loading-spinner').style.display = 'none';
            } catch (error) {
                console.error("Error fetching request types:", error);
                container.innerHTML = '<p>Error loading chart data.</p>';
            }
        }

        async function fetchAndRenderUserSignups() {
            const container = document.getElementById('signups-chart-container');
            try {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const snapshot = await firebase.firestore().collection('users')
                    .where('createdAt', '>=', firebase.firestore.Timestamp.fromDate(thirtyDaysAgo))
                    .orderBy('createdAt', 'asc')
                    .get();

                const signupCountsByDay = {};
                for (let i = 0; i < 30; i++) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const key = d.toISOString().split('T')[0];
                    signupCountsByDay[key] = 0;
                }
                
                snapshot.forEach(doc => {
                    const createdAt = doc.data().createdAt?.toDate();
                    if (createdAt) {
                        const key = createdAt.toISOString().split('T')[0];
                        if (signupCountsByDay.hasOwnProperty(key)) {
                            signupCountsByDay[key]++;
                        }
                    }
                });
                
                const sortedLabels = Object.keys(signupCountsByDay).sort();
                const sortedData = sortedLabels.map(label => signupCountsByDay[label]);
                
                renderLineChart('userSignupsChart', sortedLabels, sortedData);
                container.querySelector('.loading-spinner').style.display = 'none';

            } catch (error) {
                console.error("Error fetching user signups:", error);
                container.innerHTML = '<p>Error loading chart data.</p>';
            }
        }

        // --- Chart Rendering Functions ---
        function renderPieChart(canvasId, labels, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#6720bd', '#007bff', '#28a745', '#ffc107', '#dc3545'],
                        borderColor: '#ffffff',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }
        
        function renderLineChart(canvasId, labels, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'New Users',
                        data: data,
                        backgroundColor: 'rgba(103, 32, 189, 0.2)',
                        borderColor: '#6720bd',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    plugins: { legend: { display: false } }
                }
            });
        }


        // --- General UI ---
        document.getElementById('logoutBtn').onclick = document.getElementById('signOutLink').onclick = () => {
            firebase.auth().signOut().then(() => { location.href = '../login.html'; });
        };
        document.getElementById('toggleSidebar').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });
    </script>
</body>
</html>
