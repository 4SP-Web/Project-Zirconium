<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - ANALYTICS</title>
    <link rel="stylesheet" href="../css/style.css" />
    <script src="../ban-enforcer.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    /* --- Base Layout & Sidebar --- */
    body.analytics-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: 'PrimaryFont', sans-serif; }
    .analytics-container { display: flex; flex: 1; }
    .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.collapsed { width: 85px; }
    #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
    .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
    .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
    .sidebar nav li { margin-bottom: 10px; }
    .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
    .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
    .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
    .sidebar nav a .label { margin-left: 10px; white-space: nowrap; opacity: 1; visibility: visible; transition: opacity 0.2s ease-in-out; transition-delay: 0.4s; }
    .sidebar.collapsed nav a .label { opacity: 0; visibility: hidden; transition-delay: 0s; }

    /* --- Main Content & Header --- */
    .main-content { flex: 1; padding: 40px; background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%); overflow-y: auto; position: relative; }
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .dashboard-title { margin: 0; font-size: 2.2em; font-weight: bold; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .header-buttons { display: flex; gap: 10px; }
    #refresh-analytics-btn, #analytics-settings-btn { background: #f0f2f5; border: 1px solid #e0e0e0; color: #555; padding: 8px 15px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1em; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease; font-family: 'PrimaryFont', sans-serif; }
    #refresh-analytics-btn:hover, #analytics-settings-btn:hover { background-color: #e9ecef; border-color: #ccc; }
    #refresh-analytics-btn:disabled { cursor: not-allowed; opacity: 0.7; }
    #refresh-analytics-btn.refreshing svg { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* --- Reauthentication & Access Denied Sections --- */
    #reauth-section, #access-denied-section { background: #fff; padding: 40px; border-radius: 20px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); text-align: center; border: 1px solid rgba(103, 32, 189, 0.1); }
    .settings-form { display: flex; flex-direction: column; gap: 15px; align-items: center; }
    .settings-form input { padding: 12px 15px; border: 1px solid #ddd; border-radius: 12px; font-size: 1em; width: 100%; max-width: 350px; font-family: 'PrimaryFont', sans-serif; }
    .reauth-btn { background: linear-gradient(135deg, #4285F4 0%, #3478e6 100%); color: #fff; border: none; padding: 12px 25px; border-radius: 8px; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; font-size: 1em; }

    /* --- Tabbed Interface & Analytics Styles --- */
    #analytics-content { display: none; background-color: #fff; border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); overflow: hidden; }
    .settings-tabs { display: flex; background-color: #f0f2f5; padding: 6px; gap: 6px; border-bottom: 1px solid #e0e0e0; }
    .tab-button { flex: 1; padding: 12px; background: none; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1.1em; color: #555; transition: all 0.2s ease; font-family: 'PrimaryFont', sans-serif; }
    .tab-button.active { background: #fff; color: #6720bd; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .tab-panels-wrapper { position: relative; overflow: hidden; }
    .tab-panels-container { display: flex; transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
    .tab-panel { flex-shrink: 0; width: 100%; box-sizing: border-box; display: block !important; padding: 25px 30px; }
    .stat-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: #f8f9fa; border-radius: 12px; padding: 20px; text-align: center; border: 1px solid #e9ecef; }
    .stat-card-title { font-size: 1em; color: #555; margin: 0 0 10px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .stat-card-value { font-size: 2.2em; font-weight: bold; color: #333; margin: 0; min-height: 40px; }
    .stat-card-value.offset::after { content: '*'; font-size: 0.5em; vertical-align: top; color: #6720bd; }
    .chart-grid, .tables-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; }
    .chart-card { background: #fff; border: 1px solid #f0f0f0; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
    h4 { margin: 0 0 15px; text-align: center; font-size: 1.2em; color: #444; }
    .chart-container { position: relative; height: 300px; }
    
    /* --- Data Table Styles --- */
    .table-container { margin-top: 30px; }
    .table-container h4 { text-align: left; }
    .table-controls { display: flex; justify-content: flex-end; margin-bottom: 15px; }
    .table-controls input { padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; width: 100%; max-width: 300px; font-family: 'PrimaryFont', sans-serif;}
    .data-table-wrapper { max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 12px; }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; font-family: 'PrimaryFont', sans-serif; }
    .data-table thead { position: sticky; top: 0; background-color: #f8f9fa; z-index: 1; }
    .data-table th { font-weight: 600; color: #333; cursor: pointer; user-select: none; transition: background-color 0.2s; position: relative; }
    .data-table th.sort-active { background-color: rgba(103, 32, 189, 0.1); color: #6720bd; }
    .data-table th.sort-active::after { content: ''; position: absolute; right: 10px; top: 50%; border: 4px solid transparent; }
    .data-table th.sort-asc::after { border-bottom-color: #6720bd; transform: translateY(-70%); }
    .data-table th.sort-desc::after { border-top-color: #6720bd; transform: translateY(-30%); }
    .data-table tbody tr { transition: background-color 0.2s; }
    .data-table tbody tr:hover { background-color: #f0f2f5; cursor: pointer; }
    .data-table td { font-size: 0.9em; color: #555; }

    /* --- Site Health & Tooltip Styles --- */
    .health-layout { display: flex; gap: 30px; align-items: flex-start; flex-wrap: wrap; }
    .health-score-container { flex: 1; min-width: 250px; text-align: center; }
    .health-score-circle { width: 200px; height: 200px; margin: 0 auto 20px; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #f0f2f5; position: relative; transition: border-color 0.5s ease; }
    .health-score-circle .grade { font-size: 5em; font-weight: bold; line-height: 1; }
    .health-score-circle .score { font-size: 1.2em; color: #555; }
    .health-status { font-size: 1.5em; font-weight: 600; }
    .health-diagnostics { flex: 2; min-width: 300px; }
    .diagnostic-list { list-style: none; padding: 0; margin: 0; }
    .diagnostic-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background-color: #f8f9fa; border-radius: 8px; margin-bottom: 10px; }
    .diagnostic-item-label { font-weight: 500; color: #444; }
    .diagnostic-item-value { font-weight: bold; font-size: 1.1em; }
    .info-icon { font-style: normal; font-weight: bold; display: inline-block; width: 18px; height: 18px; line-height: 18px; text-align: center; background: #ccc; color: white; border-radius: 50%; font-size: 12px; cursor: help; position: relative; }
    .info-tooltip { visibility: hidden; opacity: 0; width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -125px; transition: opacity 0.3s; font-family: 'PrimaryFont', sans-serif; font-size: 0.85em; font-weight: normal; line-height: 1.4; pointer-events: none; }
    .info-icon:hover .info-tooltip { visibility: visible; opacity: 1; }

    /* --- Modals --- */
    .modal { display: flex; align-items: center; justify-content: center; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); visibility: hidden; opacity: 0; transition: opacity 0.25s ease-out; }
    .modal.modal-open { visibility: visible; opacity: 1; }
    .modal-content { background-color: #fff; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); position: relative; transform: scale(0.95); transition: transform 0.3s ease; font-family: 'PrimaryFont', sans-serif; }
    .modal.modal-open .modal-content { transform: scale(1); }
    .modal-close-btn { position: absolute; top: 10px; right: 15px; font-size: 28px; background: none; border: none; cursor: pointer; color: #aaa; font-family: sans-serif; }
    .modal-content h3 { margin: 0 0 20px; font-size: 1.8em; color: #6720bd; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 25px; }
    .detail-item { font-size: 1em; }
    .detail-item strong { display: block; color: #333; font-weight: 600; margin-bottom: 4px; }
    .detail-item span { color: #555; word-break: break-all; }
    .detail-item .status-banned { color: #dc3545; font-weight: bold; }
    .detail-item .status-ok { color: #28a745; font-weight: bold; }
    .full-width { grid-column: 1 / -1; }
    .settings-section { display: flex; flex-direction: column; gap: 12px; }
    .settings-section label { font-weight: 600; color: #555; font-size: 1.1em; }
    .offset-control { display: flex; align-items: center; gap: 15px; }
    .offset-control input[type="range"] { flex-grow: 1; }
    .offset-control span { font-weight: bold; font-size: 1.2em; min-width: 40px; text-align: center; }
    </style>
</head>
<body class="analytics-page">
    <header class="main-header light-bg">
        <div class="container"> <div class="logo"> <a href="../index.html"> <img src="../images/logo-dark.png" alt="4SP Logo"/> </a> </div> <div class="auth-buttons"> <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button> <button id="logoutBtn" class="btn btn-login">LOG OUT</button> </div> </div>
    </header>

    <div class="analytics-container">
        <aside class="sidebar" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="apps.html"><span class="icon">✨</span><span class="label">Apps</span></a></li>
                    <li><a href="settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="analytics.html" class="active"><span class="icon">📊</span><span class="label">Analytics</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="dashboard-header">
                <h2 class="dashboard-title">Site Analytics</h2>
                <div class="header-buttons">
                    <button id="analytics-settings-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311a1.464 1.464 0 0 1-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"/></svg>
                        <span>Settings</span>
                    </button>
                    <button id="refresh-analytics-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
            <section id="access-denied-section" style="display: none;"> <h3>🚫 Access Denied</h3> <p>You do not have permission to view this page.</p> <button class="btn btn-login" onclick="window.location.href='dashboard.html'">Return to Dashboard</button> </section>
            <section id="reauth-section" style="display: none;"> <h3>🔐 Admin Verification</h3> <p>Please re-authenticate to access the analytics dashboard.</p> <div class="reauth-wrapper"> <form class="settings-form" id="email-reauth-form" style="display: none;"> <input type="password" id="reauthPassword" placeholder="Enter password & press Enter..." required> </form> <button class="reauth-btn" id="reauthBtn" style="display: none;">Reauthenticate</button> </div> </section>

            <section id="analytics-content">
                <div class="settings-tabs">
                    <button class="tab-button active" data-tab="users">👥 Users</button>
                    <button class="tab-button" data-tab="auth">🔐 Authentication</button>
                    <button class="tab-button" data-tab="submissions">📝 Submissions</button>
                    <button class="tab-button" data-tab="health">❤️ Site Health</button>
                </div>
                <div class="tab-panels-wrapper">
                    <div class="tab-panels-container">
                        <div id="tab-users" class="tab-panel">
                            <div class="stat-card-grid">
                                <div class="stat-card">
                                    <h4 class="stat-card-title">Total Users <i class="info-icon">i<span class="info-tooltip">Counts profiles in the database. May differ from Firebase Auth count if profile creation failed for some users.</span></i></h4>
                                    <p class="stat-card-value" id="total-users-value"></p>
                                </div>
                                <div class="stat-card">
                                    <h4 class="stat-card-title">New Users (30d) <i class="info-icon">i<span class="info-tooltip">Counts new profiles created in the database within the last 30 days.</span></i></h4>
                                    <p class="stat-card-value" id="new-users-value"></p>
                                </div>
                                <div class="stat-card"><h4 class="stat-card-title">Daily Actions / User</h4><p class="stat-card-value" id="actions-per-user-value"></p></div>
                            </div>
                            <div class="table-container">
                                <h4>All Users</h4>
                                <div class="table-controls"><input type="text" id="user-search" placeholder="Search users by name or email..."></div>
                                <div class="data-table-wrapper"><table class="data-table" id="users-table"><thead><tr><th data-sort="username">Username</th><th data-sort="email">Email</th><th data-sort="authMethod">Auth Method</th><th data-sort="createdAt">Created At</th></tr></thead><tbody></tbody></table></div>
                            </div>
                        </div>
                        <div id="tab-auth" class="tab-panel">
                             <div class="stat-card-grid">
                                <div class="stat-card"><h4 class="stat-card-title">Verified Emails</h4><p class="stat-card-value" id="verified-users-value"></p></div>
                                <div class="stat-card"><h4 class="stat-card-title">Unverified Emails</h4><p class="stat-card-value" id="unverified-users-value"></p></div>
                                <div class="stat-card"><h4 class="stat-card-title">Banned Users</h4><p class="stat-card-value" id="banned-users-value"></p></div>
                            </div>
                            <div class="chart-grid">
                                <div class="chart-card"><h4>Account Types</h4><div class="chart-container"><canvas id="accountTypesChart"></canvas></div></div>
                                <div class="chart-card"><h4>Email Verification Status</h4><div class="chart-container"><canvas id="verificationStatusChart"></canvas></div></div>
                            </div>
                        </div>
                        <div id="tab-submissions" class="tab-panel">
                            <div class="stat-card-grid">
                                <div class="stat-card"><h4 class="stat-card-title">Total Submissions</h4><p class="stat-card-value" id="total-requests-value"></p></div>
                                <div class="stat-card"><h4 class="stat-card-title">Avg. Vote Score</h4><p class="stat-card-value" id="avg-votes-value"></p></div>
                                <div class="stat-card"><h4 class="stat-card-title">Recyclable Slots</h4><p class="stat-card-value" id="recyclable-reqs-value"></p></div>
                                <div class="stat-card"><h4 class="stat-card-title">Pending Review</h4><p class="stat-card-value" id="pending-reqs-value"></p></div>
                            </div>
                            <div class="chart-grid">
                                <div class="chart-card"><h4>Submission Types</h4><div class="chart-container"><canvas id="requestTypesChart"></canvas></div></div>
                                <div class="chart-card"><h4>Admin Status</h4><div class="chart-container"><canvas id="adminStatusChart"></canvas></div></div>
                                <div class="chart-card"><h4>Sound Categories</h4><div class="chart-container"><canvas id="soundCategoriesChart"></canvas></div></div>
                            </div>
                             <div class="tables-grid" style="margin-top: 30px;">
                                <div class="table-container">
                                    <h4>Most Upvoted</h4>
                                    <div class="data-table-wrapper" style="max-height: 250px;"><table class="data-table" id="top-requests-table"><thead><tr><th>Title</th><th>Author</th><th>Score</th></tr></thead><tbody></tbody></table></div>
                                </div>
                                <div class="table-container">
                                    <h4>Most Downvoted</h4>
                                    <div class="data-table-wrapper" style="max-height: 250px;"><table class="data-table" id="bottom-requests-table"><thead><tr><th>Title</th><th>Author</th><th>Score</th></tr></thead><tbody></tbody></table></div>
                                </div>
                            </div>
                        </div>
                        <div id="tab-health" class="tab-panel">
                            <div class="stat-card-grid">
                                <div class="stat-card"><h4 class="stat-card-title">Total Visits</h4><p class="stat-card-value" id="total-visits-value"></p></div>
                            </div>
                             <div class="health-layout">
                                <div class="health-score-container">
                                    <div class="health-score-circle" id="health-score-circle">
                                        <span class="grade" id="health-grade">--</span>
                                        <span class="score" id="health-score">--/100</span>
                                    </div>
                                    <h3 class="health-status" id="health-status-text">Calculating...</h3>
                                </div>
                                <div class="health-diagnostics">
                                    <h4>Key Diagnostics</h4>
                                    <ul class="diagnostic-list" id="diagnostic-list"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="userDetailsModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3 id="modal-username">User Details</h3>
            <div class="details-grid">
                <div class="detail-item"><strong>Email</strong><span id="modal-email"></span></div>
                <div class="detail-item"><strong>Auth Method</strong><span id="modal-authMethod"></span></div>
                <div class="detail-item full-width"><strong>User ID</strong><span id="modal-uid"></span></div>
                <div class="detail-item"><strong>Account Created</strong><span id="modal-createdAt"></span></div>
                <div class="detail-item"><strong>Limits Last Reset</strong><span id="modal-limitsReset"></span></div>
                <div class="detail-item"><strong>Daily Requests Used</strong><span id="modal-dailyRequests"></span></div>
                <div class="detail-item"><strong>Daily Votes Used</strong><span id="modal-dailyVotes"></span></div>
                <div class="detail-item"><strong>Ban Status</strong><span id="modal-banStatus"></span></div>
                <div class="detail-item" id="modal-ban-expiry-item" style="display: none;"><strong>Ban Expires</strong><span id="modal-banExpiry"></span></div>
                <div class="detail-item full-width" id="modal-ban-reason-item" style="display: none;"><strong>Ban Reason</strong><span id="modal-banReason"></span></div>
            </div>
        </div>
    </div>
    
    <div id="analyticsSettingsModal" class="modal">
        <div class="modal-content">
             <button class="modal-close-btn">&times;</button>
             <h3>Analytics Settings</h3>
             <div class="settings-section">
                <label for="userCountOffset">User Count Offset</label>
                <div class="offset-control">
                    <span>-10</span>
                    <input type="range" id="userCountOffset" min="-10" max="10" step="1" value="0">
                    <span>+10</span>
                    <span id="userCountOffsetValue">0</span>
                </div>
                <p style="font-size: 0.8em; color: #666; margin: 5px 0 0;">Use this to manually align the displayed user count with the count in Firebase Authentication.</p>
             </div>
        </div>
    </div>


<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
        // --- Globals & Configuration ---
        const ALLOWED_ADMINS = ['4simpleproblems@gmail.com', 'belkwy30@minerva.sparcc.org'];
        let currentUser = null, authMethod = 'password';
        let allUsersData = [], allRequestsData = [];
        let chartInstances = {};
        let userSortState = { key: 'createdAt', direction: 'desc' };

        // --- AUTH & PAGE INITIALIZATION ---
        firebase.auth().onAuthStateChanged(user => {
            if (!user) { location.href = '../login.html'; return; }
            currentUser = user;
            if (!ALLOWED_ADMINS.includes(user.email)) {
                document.getElementById('access-denied-section').style.display = 'block';
                return;
            }
            checkLocalReauthStatus();
        });

        function checkLocalReauthStatus() {
            if (sessionStorage.getItem(`analytics_reauth_status_${currentUser.uid}`) === 'true') {
                showAnalyticsContent();
            } else {
                setupReauthUI();
            }
        }
        
        function handleSuccessfulReauth() {
            sessionStorage.setItem(`analytics_reauth_status_${currentUser.uid}`, 'true');
            showAnalyticsContent();
        }
        
        function showAnalyticsContent() {
            document.getElementById('reauth-section').style.display = 'none';
            document.getElementById('analytics-content').style.display = 'block';
            initializeUI();
            loadAllAnalyticsData();
        }

        // --- UI Initialization & Event Handlers ---
        function initializeUI() {
            initializeTabs();
            initializeTableSorting();
            initializeUserDetailsModal();
            initializeSettingsModal();
            document.getElementById('refresh-analytics-btn').addEventListener('click', () => {
                loadAllAnalyticsData().then(() => {
                    const btn = document.getElementById('refresh-analytics-btn');
                    const originalText = btn.querySelector('span').textContent;
                    btn.querySelector('span').textContent = "Refreshed!";
                    setTimeout(() => {
                         btn.querySelector('span').textContent = originalText;
                    }, 2000);
                });
            });
        }

        // --- Analytics Data Fetching & Rendering ---
        async function loadAllAnalyticsData() {
            const refreshBtn = document.getElementById('refresh-analytics-btn');
            refreshBtn.disabled = true; refreshBtn.classList.add('refreshing');
            const db = firebase.firestore();
            try {
                const [usersSnapshot, requestsSnapshot, visitsSnapshot] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('requests').get(),
                    db.collection('site_metrics').doc('visitCounter').get()
                ]);
                allUsersData = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allRequestsData = requestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const totalVisits = visitsSnapshot.exists ? visitsSnapshot.data().totalVisits : 0;

                renderUserAnalytics();
                renderAuthAnalytics();
                renderSubmissionAnalytics();
                renderSiteHealthAnalytics(totalVisits);
            } catch (error) {
                console.error("Fatal error fetching analytics data:", error);
                alert("Could not load analytics data. Check Firestore rules and console for errors.");
            } finally {
                refreshBtn.disabled = false; refreshBtn.classList.remove('refreshing');
            }
        }
        
        function renderUserAnalytics() {
            const offset = parseInt(localStorage.getItem('analyticsUserOffset') || '0');
            const totalUsers = allUsersData.length + offset;
            
            const totalUsersValueEl = document.getElementById('total-users-value');
            totalUsersValueEl.textContent = totalUsers.toLocaleString();
            totalUsersValueEl.classList.toggle('offset', offset !== 0);

            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            const newUsers = allUsersData.filter(u => u.createdAt?.toDate() > thirtyDaysAgo);
            const newUsersValueEl = document.getElementById('new-users-value');
            newUsersValueEl.textContent = (newUsers.length + offset).toLocaleString();
            newUsersValueEl.classList.toggle('offset', offset !== 0);
            
            const totalActions = allRequestsData.length + allRequestsData.reduce((acc, r) => acc + (r.upvotedBy?.length || 0) + (r.downvotedBy?.length || 0), 0);
            document.getElementById('actions-per-user-value').textContent = totalUsers > 0 ? (totalActions / totalUsers).toFixed(2) : 0;
            
            const signupsByDay = newUsers.reduce((acc, user) => { const day = user.createdAt.toDate().toISOString().split('T')[0]; acc[day] = (acc[day] || 0) + 1; return acc; }, {});
            const sortedSignupLabels = Object.keys(signupsByDay).sort();
            const sortedSignupData = sortedSignupLabels.map(label => signupsByDay[label]);
            renderLineChart('userSignupsChart', sortedSignupLabels, sortedSignupData);
            
            sortAndRenderUsers();
            document.getElementById('user-search').addEventListener('input', e => {
                const query = e.target.value.toLowerCase();
                const filtered = allUsersData.filter(u => u.username?.toLowerCase().includes(query) || u.email?.toLowerCase().includes(query));
                renderUserTable(filtered);
            });
        }

        function renderAuthAnalytics() {
            const verifiedUsers = allUsersData.filter(u => u.emailVerified === true).length;
            const unverifiedUsers = allUsersData.length - verifiedUsers;
            const bannedUsers = allUsersData.filter(u => u.isRequestsBanned === true).length;

            document.getElementById('verified-users-value').textContent = verifiedUsers;
            document.getElementById('unverified-users-value').textContent = unverifiedUsers;
            document.getElementById('banned-users-value').textContent = bannedUsers;
            
            const providerCounts = allUsersData.reduce((acc, user) => { const method = user.authMethod || 'email'; acc[method] = (acc[method] || 0) + 1; return acc; }, {});
            renderPieChart('accountTypesChart', Object.keys(providerCounts), Object.values(providerCounts));
            renderPieChart('verificationStatusChart', ['Verified', 'Unverified'], [verifiedUsers, unverifiedUsers]);
        }

        function renderSubmissionAnalytics() {
            const recyclableReqs = allRequestsData.filter(r => r.status === 'recyclable');
            const pendingReqs = allRequestsData.filter(r => !r.adminStatus);
            const totalScore = allRequestsData.reduce((acc, r) => acc + ((r.upvotes || 0) - (r.downvotes || 0)), 0);
            document.getElementById('total-requests-value').textContent = allRequestsData.length;
            document.getElementById('recyclable-reqs-value').textContent = recyclableReqs.length;
            document.getElementById('pending-reqs-value').textContent = pendingReqs.length;
            document.getElementById('avg-votes-value').textContent = allRequestsData.length > 0 ? (totalScore / allRequestsData.length).toFixed(1) : 'N/A';
            const typeCounts = allRequestsData.reduce((acc, r) => { acc[r.type] = (acc[r.type] || 0) + 1; return acc; }, {});
            renderPieChart('requestTypesChart', Object.keys(typeCounts), Object.values(typeCounts));
            const statusCounts = allRequestsData.reduce((acc, r) => { const status = r.adminStatus || 'Pending'; acc[status] = (acc[status] || 0) + 1; return acc; }, {});
            renderPieChart('adminStatusChart', Object.keys(statusCounts), Object.values(statusCounts));
            const soundCategoryCounts = allRequestsData.filter(r => r.type === 'sound').reduce((acc, r) => { const cat = r.soundCategory || 'N/A'; acc[cat] = (acc[cat] || 0) + 1; return acc; }, {});
            renderPieChart('soundCategoriesChart', Object.keys(soundCategoryCounts), Object.values(soundCategoryCounts));
            const topRequests = [...allRequestsData].sort((a, b) => ((b.upvotes||0)-(b.downvotes||0)) - ((a.upvotes||0)-(a.downvotes||0))).slice(0, 10);
            renderTopRequestsTable('top-requests-table', topRequests);
            const bottomRequests = [...allRequestsData].sort((a, b) => ((a.upvotes||0)-(a.downvotes||0)) - ((b.upvotes||0)-(b.downvotes||0))).slice(0, 10);
            renderTopRequestsTable('bottom-requests-table', bottomRequests);
        }
        
        function renderSiteHealthAnalytics(totalVisits) {
            document.getElementById('total-visits-value').textContent = totalVisits.toLocaleString();
            let score = 100;
            const diagnostics = [];
            
            const activeUserIds = new Set();
            allRequestsData.forEach(r => {
                activeUserIds.add(r.userId);
                r.upvotedBy?.forEach(uid => activeUserIds.add(uid));
                r.downvotedBy?.forEach(uid => activeUserIds.add(uid));
            });
            const engagementRate = allUsersData.length > 0 ? activeUserIds.size / allUsersData.length : 0;
            score += (engagementRate - 0.25) * 40; // Bonus/penalty based on 25% engagement rate
            diagnostics.push({label: 'User Engagement Rate', value: `${(engagementRate * 100).toFixed(1)}%`});

            const verificationRate = allUsersData.length > 0 ? allUsersData.filter(u => u.emailVerified).length / allUsersData.length : 0;
            score -= (1 - verificationRate) * 20; // Max -20 pts for unverified users
            diagnostics.push({label: 'Email Verification Rate', value: `${(verificationRate * 100).toFixed(1)}%`});
            
            const pendingReqs = allRequestsData.filter(r => !r.adminStatus).length;
            const pendingRatio = allRequestsData.length > 0 ? pendingReqs / allRequestsData.length : 0;
            score -= pendingRatio * 20;
            diagnostics.push({label: 'Pending Submissions', value: `${pendingReqs} (${(pendingRatio * 100).toFixed(0)}%)`});
            
            const bannedUsers = allUsersData.filter(u => u.isRequestsBanned).length;
            const bannedRatio = allUsersData.length > 0 ? bannedUsers / allUsersData.length : 0;
            score -= bannedRatio * 30;
            diagnostics.push({label: 'Banned User Ratio', value: `${bannedUsers} (${(bannedRatio * 100).toFixed(1)}%)`});
            
            const respondedReqs = allRequestsData.filter(r => r.adminStatus && r.adminStatusUpdatedAt && r.timestamp);
            const responseTimes = respondedReqs.map(r => r.adminStatusUpdatedAt.toMillis() - r.timestamp.toMillis());
            const avgResponseTimeMs = responseTimes.length > 0 ? responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length : 0;
            const avgResponseTimeDays = avgResponseTimeMs / (1000 * 60 * 60 * 24);
            score -= Math.min(avgResponseTimeDays * 5, 20);
            diagnostics.push({label: 'Avg. Admin Response', value: `${avgResponseTimeDays.toFixed(1)} days`});
            
            const avgVoteScore = parseFloat(document.getElementById('avg-votes-value').textContent) || 0;
            score += Math.max(Math.min(avgVoteScore * 2, 15), -15);
            diagnostics.push({label: 'Average Submission Score', value: avgVoteScore.toFixed(1)});
            
            score = Math.max(0, Math.min(100, score));
            const getGrade = s => { if (s >= 97) return {g:'A+',t:'Excellent',c:'#28a745'}; if (s >= 93) return {g:'A',t:'Excellent',c:'#28a745'}; if (s >= 90) return {g:'A-',t:'Great',c:'#20c997'}; if (s >= 87) return {g:'B+',t:'Good',c:'#ffc107'}; if (s >= 83) return {g:'B',t:'Good',c:'#ffc107'}; if (s >= 80) return {g:'B-',t:'Fair',c:'#fd7e14'}; if (s >= 70) return {g:'C',t:'Needs Improvement',c:'#dc3545'}; return {g:'F',t:'Critical',c:'#c82333'}; };
            const { g, t, c } = getGrade(score);
            document.getElementById('health-grade').textContent = g;
            document.getElementById('health-score').textContent = `${score.toFixed(0)}/100`;
            document.getElementById('health-status-text').textContent = t;
            document.getElementById('health-score-circle').style.border = `8px solid ${c}`;
            document.getElementById('diagnostic-list').innerHTML = diagnostics.map(d => `<li class="diagnostic-item"><span class="diagnostic-item-label">${d.label}</span><span class="diagnostic-item-value">${d.value}</span></li>`).join('');
        }
        
        // --- Helper Functions ---
        function initializeSettingsModal() {
            const modal = document.getElementById('analyticsSettingsModal');
            document.getElementById('analytics-settings-btn').addEventListener('click', () => modal.classList.add('modal-open'));
            modal.querySelector('.modal-close-btn').addEventListener('click', () => modal.classList.remove('modal-open'));
            modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('modal-open'); });

            const offsetSlider = document.getElementById('userCountOffset');
            const offsetValueEl = document.getElementById('userCountOffsetValue');

            const savedOffset = localStorage.getItem('analyticsUserOffset') || '0';
            offsetSlider.value = savedOffset;
            offsetValueEl.textContent = savedOffset;

            offsetSlider.addEventListener('input', () => {
                offsetValueEl.textContent = offsetSlider.value;
            });
            offsetSlider.addEventListener('change', () => {
                localStorage.setItem('analyticsUserOffset', offsetSlider.value);
                // Re-render user counts when the offset is changed and saved.
                renderUserAnalytics();
            });
        }
        
        function setupReauthUI() {
            document.getElementById('reauth-section').style.display = 'block';
            const emailForm = document.getElementById('email-reauth-form'),
                reauthBtn = document.getElementById('reauthBtn'),
                passInput = document.getElementById('reauthPassword');
            const providerId = currentUser.providerData[0] ?.providerId;
            authMethod = providerId === 'google.com' ? 'google' : (providerId === 'github.com' ? 'github' : 'password');
            if (authMethod !== 'password') {
                reauthBtn.textContent = `Reauthenticate with ${authMethod.charAt(0).toUpperCase() + authMethod.slice(1)}`;
                reauthBtn.style.display = 'block';
                emailForm.style.display = 'none';
                reauthBtn.onclick = reauthenticateWithPopup;
            } else {
                emailForm.style.display = 'block';
                reauthBtn.style.display = 'none';
                passInput.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        reauthenticateWithPassword(passInput.value);
                    }
                });
            }
        }
        async function reauthenticateWithPassword(password) {
            try {
                await currentUser.reauthenticateWithCredential(firebase.auth.EmailAuthProvider.credential(currentUser.email, password));
                handleSuccessfulReauth();
            } catch (error) {
                alert(`Auth failed: ${error.message}`);
            }
        }
        async function reauthenticateWithPopup() {
            let provider = authMethod === 'google' ? new firebase.auth.GoogleAuthProvider() : new firebase.auth.GithubAuthProvider();
            try {
                await currentUser.reauthenticateWithPopup(provider);
                handleSuccessfulReauth();
            } catch (error) {
                alert(`Reauthentication failed: ${error.message}`);
            }
        }

        function initializeTabs() {
            const tabContainer = document.querySelector('.settings-tabs'),
                panelContainer = document.querySelector('.tab-panels-container'),
                tabButtons = tabContainer.querySelectorAll('.tab-button');
            tabContainer.addEventListener('click', e => {
                const clickedButton = e.target.closest('.tab-button');
                if (clickedButton) {
                    const tabIndex = Array.from(tabButtons).indexOf(clickedButton);
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    clickedButton.classList.add('active');
                    panelContainer.style.transform = `translateX(-${tabIndex * 100}%)`;
                }
            });
        }

        function initializeTableSorting() {
            const tableHeaders = document.querySelectorAll('#users-table th[data-sort]');
            tableHeaders.forEach(th => {
                th.addEventListener('click', () => {
                    const sortKey = th.dataset.sort;
                    if (userSortState.key === sortKey) {
                        userSortState.direction = userSortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        userSortState.key = sortKey;
                        userSortState.direction = 'asc';
                    }
                    sortAndRenderUsers();
                });
            });
        }

        function initializeUserDetailsModal() {
            const modal = document.getElementById('userDetailsModal'),
                closeBtn = modal.querySelector('.modal-close-btn'),
                closeModal = () => modal.classList.remove('modal-open');
            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', e => {
                if (e.target === modal) closeModal();
            });
            document.querySelector('#users-table tbody').addEventListener('click', e => {
                const row = e.target.closest('tr');
                if (row && row.dataset.userid) {
                    const user = allUsersData.find(u => u.id === row.dataset.userid);
                    if (user) openUserDetailsModal(user);
                }
            });
        }

        function sortAndRenderUsers() {
            const { key, direction } = userSortState;
            const sortedUsers = [...allUsersData].sort((a, b) => {
                let valA = a[key], valB = b[key];
                if (key === 'createdAt' && valA?.toDate) valA = valA.toMillis();
                if (key === 'createdAt' && valB?.toDate) valB = valB.toMillis();
                if (valA === undefined || valA === null) return 1;
                if (valB === undefined || valB === null) return -1;
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            document.querySelectorAll('#users-table th').forEach(th => {
                th.classList.remove('sort-active', 'sort-asc', 'sort-desc');
                if (th.dataset.sort === key) {
                    th.classList.add('sort-active', `sort-${direction}`);
                }
            });
            renderUserTable(sortedUsers);
        }

        function renderUserTable(users) {
            const tbody = document.getElementById('users-table').querySelector('tbody');
            tbody.innerHTML = users.map(user => `
                <tr data-userid="${user.id}">
                    <td>${user.username || 'N/A'}</td><td>${user.email}</td>
                    <td>${user.authMethod || 'email'}</td><td>${user.createdAt ? user.createdAt.toDate().toLocaleDateString() : 'N/A'}</td>
                </tr>`).join('');
        }

        function renderTopRequestsTable(tableId, requests) {
            const tbody = document.getElementById(tableId).querySelector('tbody');
            tbody.innerHTML = requests.map(req => `
                <tr>
                    <td title="${req.title}">${req.title.substring(0, 35)}${req.title.length > 35 ? '...' : ''}</td>
                    <td>${req.isAnonymous ? '<i>Anonymous</i>' : req.username}</td>
                    <td>${(req.upvotes || 0) - (req.downvotes || 0)}</td>
                </tr>`).join('');
        }
        
        function openUserDetailsModal(user) {
            document.getElementById('modal-username').textContent = user.username || 'No Username';
            document.getElementById('modal-email').textContent = user.email || 'N/A';
            document.getElementById('modal-uid').textContent = user.id;
            document.getElementById('modal-createdAt').textContent = user.createdAt ? user.createdAt.toDate().toLocaleString() : 'N/A';
            document.getElementById('modal-authMethod').textContent = user.authMethod || 'email';
            document.getElementById('modal-dailyRequests').textContent = `${user.dailyRequestCount || 0}`;
            document.getElementById('modal-dailyVotes').textContent = `${user.dailyVoteCount || 0}`;
            document.getElementById('modal-limitsReset').textContent = user.limitsLastReset || 'Never';
            const isBanned = user.isRequestsBanned === true;
            const banStatusEl = document.getElementById('modal-banStatus');
            banStatusEl.textContent = isBanned ? 'BANNED' : 'Not Banned';
            banStatusEl.className = isBanned ? 'status-banned' : 'status-ok';
            document.getElementById('modal-ban-expiry-item').style.display = isBanned ? 'block' : 'none';
            document.getElementById('modal-ban-reason-item').style.display = isBanned ? 'block' : 'none';
            if (isBanned) {
                document.getElementById('modal-banExpiry').textContent = user.requestsBannedUntil ? user.requestsBannedUntil.toDate().toLocaleString() : 'Indefinite';
                document.getElementById('modal-banReason').textContent = user.requestsBanReason || 'No reason provided.';
            }
            document.getElementById('userDetailsModal').classList.add('modal-open');
        }

        function renderPieChart(canvasId, labels, data) {
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#6720bd', '#007bff', '#28a745', '#ffc107', '#dc3545', '#6c757d'], borderColor: '#ffffff', borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function renderLineChart(canvasId, labels, data) {
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'Count', data: data, backgroundColor: 'rgba(103, 32, 189, 0.2)', borderColor: '#6720bd', borderWidth: 2, fill: true, tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
            });
        }
        document.getElementById('logoutBtn').onclick = () => firebase.auth().signOut();
        document.getElementById('signOutLink').onclick = (e) => {
            e.preventDefault();
            firebase.auth().signOut();
        };
        document.getElementById('toggleSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
    </script>
</body>
</html>
