<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - ANALYTICS</title>
    <link rel="stylesheet" href="../css/style.css" />
    <script src="../ban-enforcer.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    /* --- Base Layout & Sidebar (from settings.html) --- */
    body.analytics-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: 'PrimaryFont', sans-serif; }
    .analytics-container { display: flex; flex: 1; }
    .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.collapsed { width: 85px; }
    #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
    .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
    .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
    .sidebar nav li { margin-bottom: 10px; }
    .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
    .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
    .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
    .sidebar nav a .label { margin-left: 10px; white-space: nowrap; opacity: 1; visibility: visible; transition: opacity 0.2s ease-in-out; transition-delay: 0.4s; }
    .sidebar.collapsed nav a .label { opacity: 0; visibility: hidden; transition-delay: 0s; }

    /* --- Main Content & Header --- */
    .main-content { flex: 1; padding: 40px; background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%); overflow-y: auto; position: relative; }
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .dashboard-title { margin: 0; font-size: 2.2em; font-weight: bold; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

    /* --- Reauthentication & Access Denied Sections --- */
    #reauth-section, #access-denied-section { background: #fff; padding: 40px; border-radius: 20px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); text-align: center; border: 1px solid rgba(103, 32, 189, 0.1); }
    #reauth-section h3, #access-denied-section h3 { margin: 0 0 15px; font-size: 1.6em; color: #333; }
    #reauth-section p, #access-denied-section p { color: #666; margin-bottom: 30px; line-height: 1.6; max-width: 600px; margin-left: auto; margin-right: auto; }
    .settings-form { display: flex; flex-direction: column; gap: 15px; align-items: center; }
    .settings-form input { padding: 12px 15px; border: 1px solid #ddd; border-radius: 12px; font-size: 1em; width: 100%; max-width: 350px; }
    .reauth-btn { background: linear-gradient(135deg, #4285F4 0%, #3478e6 100%); color: #fff; border: none; padding: 12px 25px; border-radius: 8px; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; font-size: 1em; }

    /* --- Tabbed Interface Styles (from dashboard.html) --- */
    #analytics-content { display: none; background-color: #fff; border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); overflow: hidden; }
    .settings-tabs { display: flex; background-color: #f0f2f5; padding: 6px; gap: 6px; border-bottom: 1px solid #e0e0e0; }
    .tab-button { flex: 1; padding: 12px; background: none; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1.1em; color: #555; transition: all 0.2s ease; }
    .tab-button.active { background: #fff; color: #6720bd; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .tab-panels-wrapper { position: relative; overflow: hidden; }
    .tab-panels-container { display: flex; transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
    .tab-panel { flex-shrink: 0; width: 100%; box-sizing: border-box; display: block !important; padding: 25px 30px; }

    /* --- General Analytics Styles --- */
    .stat-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: #f8f9fa; border-radius: 12px; padding: 20px; text-align: center; border: 1px solid #e9ecef; }
    .stat-card-title { font-size: 1em; color: #555; margin: 0 0 10px; font-weight: 600; }
    .stat-card-value { font-size: 2.2em; font-weight: bold; color: #333; margin: 0; }
    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; }
    .chart-card { background: #fff; border: 1px solid #f0f0f0; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
    .chart-card h4 { margin: 0 0 15px; text-align: center; font-size: 1.2em; color: #444; }
    .chart-container { position: relative; height: 300px; }
    
    /* --- Data Table Styles --- */
    .table-container { margin-top: 20px; }
    .table-controls { display: flex; justify-content: flex-end; margin-bottom: 15px; }
    .table-controls input { padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; width: 100%; max-width: 300px; }
    .data-table-wrapper { max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 12px; }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
    .data-table thead { position: sticky; top: 0; background-color: #f8f9fa; z-index: 1; }
    .data-table th { font-weight: 600; color: #333; cursor: pointer; user-select: none; }
    .data-table th:hover { background-color: #f0f2f5; }
    .data-table tbody tr:hover { background-color: #f9f9f9; }
    .data-table td { font-size: 0.9em; color: #555; }
    .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #6720bd; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 40px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="analytics-page">
    <header class="main-header light-bg">
        <div class="container"> <div class="logo"> <a href="../index.html"> <img src="../images/logo-dark.png" alt="4SP Logo"/> </a> </div> <div class="auth-buttons"> <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button> <button id="logoutBtn" class="btn btn-login">LOG OUT</button> </div> </div>
    </header>

    <div class="analytics-container">
        <aside class="sidebar" id="sidebar">
            <button id="toggleSidebar">‚ò∞</button>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="apps.html"><span class="icon">‚ú®</span><span class="label">Apps</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="analytics.html" class="active"><span class="icon">üìä</span><span class="label">Analytics</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="dashboard-header"> <h2 class="dashboard-title">Site Analytics</h2> </div>
            <section id="access-denied-section" style="display: none;"> <h3>üö´ Access Denied</h3> <p>You do not have permission to view this page.</p> <button class="btn btn-login" onclick="window.location.href='dashboard.html'">Return to Dashboard</button> </section>
            <section id="reauth-section" style="display: none;"> <h3>üîê Admin Verification</h3> <p>Please re-authenticate to access the analytics dashboard.</p> <div class="reauth-wrapper"> <form class="settings-form" id="email-reauth-form" style="display: none;"> <input type="password" id="reauthPassword" placeholder="Enter password & press Enter..." required> </form> <button class="reauth-btn" id="reauthBtn" style="display: none;">Reauthenticate</button> </div> </section>

            <section id="analytics-content">
                <div class="settings-tabs">
                    <button class="tab-button active" data-tab="users">üë• Users</button>
                    <button class="tab-button" data-tab="submissions">üìù Submissions</button>
                    <button class="tab-button" data-tab="health">‚ù§Ô∏è Site Health</button>
                </div>
                <div class="tab-panels-wrapper">
                    <div class="tab-panels-container">
                        <div id="tab-users" class="tab-panel">
                            <div class="stat-card-grid">
                                <div class="stat-card"><h4 class="stat-card-title">Total Users</h4><p class="stat-card-value" id="total-users-value"><div class="loading-spinner"></div></p></div>
                                <div class="stat-card"><h4 class="stat-card-title">New Users (30d)</h4><p class="stat-card-value" id="new-users-value"><div class="loading-spinner"></div></p></div>
                                <div class="stat-card"><h4 class="stat-card-title">Banned Users</h4><p class="stat-card-value" id="banned-users-value"><div class="loading-spinner"></div></p></div>
                            </div>
                            <div class="chart-grid">
                                <div class="chart-card"><h4>Account Types</h4><div class="chart-container" id="account-types-container"><canvas id="accountTypesChart"></canvas></div></div>
                                <div class="chart-card"><h4>Signups Over Time (Last 30 Days)</h4><div class="chart-container" id="signups-chart-container"><canvas id="userSignupsChart"></canvas></div></div>
                            </div>
                            <div class="table-container">
                                <div class="table-controls"><input type="text" id="user-search" placeholder="Search users..."></div>
                                <div class="data-table-wrapper"><table class="data-table" id="users-table"><thead><tr><th data-sort="username">Username</th><th data-sort="email">Email</th><th data-sort="authMethod">Auth Method</th><th data-sort="createdAt">Created At</th></tr></thead><tbody></tbody></table></div>
                            </div>
                        </div>
                        <div id="tab-submissions" class="tab-panel">
                            <div class="stat-card-grid">
                                <div class="stat-card"><h4 class="stat-card-title">Total Submissions</h4><p class="stat-card-value" id="total-requests-value"><div class="loading-spinner"></div></p></div>
                                <div class="stat-card"><h4 class="stat-card-title">Avg. Vote Score</h4><p class="stat-card-value" id="avg-votes-value"><div class="loading-spinner"></div></p></div>
                                <div class="stat-card"><h4 class="stat-card-title">Recyclable Slots</h4><p class="stat-card-value" id="recyclable-reqs-value"><div class="loading-spinner"></div></p></div>
                            </div>
                            <div class="chart-grid">
                                <div class="chart-card"><h4>Submission Types</h4><div class="chart-container" id="request-types-container"><canvas id="requestTypesChart"></canvas></div></div>
                                <div class="chart-card"><h4>Admin Status</h4><div class="chart-container" id="admin-status-container"><canvas id="adminStatusChart"></canvas></div></div>
                            </div>
                             <div class="table-container">
                                <h4>Recent Submissions</h4>
                                <div class="data-table-wrapper"><table class="data-table" id="requests-table"><thead><tr><th>Title</th><th>Type</th><th>Author</th><th>Status</th><th>Score</th><th>Date</th></tr></thead><tbody></tbody></table></div>
                            </div>
                        </div>
                        <div id="tab-health" class="tab-panel">
                            <h3>Coming Soon!</h3>
                            <p>This section will provide deeper insights into site performance and health metrics.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
        // --- Globals & Configuration ---
        const ALLOWED_ADMINS = ['4simpleproblems@gmail.com', 'belkwy30@minerva.sparcc.org'];
        let currentUser = null, authMethod = 'password';
        let allUsersData = [], allRequestsData = [];
        let chartInstances = {};

        // --- AUTH & PAGE INITIALIZATION ---
        firebase.auth().onAuthStateChanged(user => {
            if (!user) { location.href = '../login.html'; return; }
            currentUser = user;
            if (!ALLOWED_ADMINS.includes(user.email)) {
                document.getElementById('access-denied-section').style.display = 'block';
                return;
            }
            checkLocalReauthStatus();
        });

        function checkLocalReauthStatus() {
            if (sessionStorage.getItem(`analytics_reauth_status_${currentUser.uid}`) === 'true') {
                showAnalyticsContent();
            } else {
                setupReauthUI();
            }
        }
        
        function setupReauthUI() {
            document.getElementById('reauth-section').style.display = 'block';
            const emailForm = document.getElementById('email-reauth-form'), reauthBtn = document.getElementById('reauthBtn'), passInput = document.getElementById('reauthPassword');
            const providerId = currentUser.providerData[0]?.providerId;
            authMethod = providerId === 'google.com' ? 'google' : (providerId === 'github.com' ? 'github' : 'password');

            if (authMethod !== 'password') {
                reauthBtn.textContent = `Reauthenticate with ${authMethod.charAt(0).toUpperCase() + authMethod.slice(1)}`;
                reauthBtn.style.display = 'block';
                emailForm.style.display = 'none';
                reauthBtn.onclick = reauthenticateWithPopup;
            } else {
                emailForm.style.display = 'block';
                reauthBtn.style.display = 'none';
                passInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); reauthenticateWithPassword(passInput.value); }});
            }
        }
        
        function handleSuccessfulReauth() {
            sessionStorage.setItem(`analytics_reauth_status_${currentUser.uid}`, 'true');
            showAnalyticsContent();
        }
        
        function showAnalyticsContent() {
            document.getElementById('reauth-section').style.display = 'none';
            document.getElementById('analytics-content').style.display = 'block';
            initializeTabs();
            loadAllAnalyticsData();
        }

        // --- Reauthentication Functions ---
        async function reauthenticateWithPassword(password) {
            try { await currentUser.reauthenticateWithCredential(firebase.auth.EmailAuthProvider.credential(currentUser.email, password)); handleSuccessfulReauth(); } catch (error) { alert(`Auth failed: ${error.message}`); }
        }
        async function reauthenticateWithPopup() {
            let provider = authMethod === 'google' ? new firebase.auth.GoogleAuthProvider() : new firebase.auth.GithubAuthProvider();
            try { await currentUser.reauthenticateWithPopup(provider); handleSuccessfulReauth(); } catch (error) { alert(`Reauthentication failed: ${error.message}`); }
        }
        
        // --- TAB LOGIC ---
        function initializeTabs() {
            const tabContainer = document.querySelector('.settings-tabs');
            const panelContainer = document.querySelector('.tab-panels-container');
            const tabButtons = tabContainer.querySelectorAll('.tab-button');
            tabContainer.addEventListener('click', e => {
                const clickedButton = e.target.closest('.tab-button');
                if (clickedButton) {
                    const tabIndex = Array.from(tabButtons).indexOf(clickedButton);
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    clickedButton.classList.add('active');
                    panelContainer.style.transform = `translateX(-${tabIndex * 100}%)`;
                }
            });
        }

        // --- Analytics Data Fetching & Rendering ---
        async function loadAllAnalyticsData() {
            const db = firebase.firestore();
            try {
                const [usersSnapshot, requestsSnapshot] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('requests').get()
                ]);
                allUsersData = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allRequestsData = requestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                renderUserAnalytics();
                renderSubmissionAnalytics();
            } catch (error) {
                console.error("Fatal error fetching analytics data:", error);
                alert("Could not load analytics data. Check Firestore rules and console for errors.");
            }
        }

        function renderUserAnalytics() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.setDate(now.getDate() - 30));
            const newUsers = allUsersData.filter(u => u.createdAt?.toDate() > thirtyDaysAgo);
            const bannedUsers = allUsersData.filter(u => u.isRequestsBanned === true);

            document.getElementById('total-users-value').textContent = allUsersData.length;
            document.getElementById('new-users-value').textContent = newUsers.length;
            document.getElementById('banned-users-value').textContent = bannedUsers.length;

            // Render Charts
            const providerCounts = allUsersData.reduce((acc, user) => {
                const method = user.authMethod || 'email'; // Fallback for older data
                acc[method] = (acc[method] || 0) + 1;
                return acc;
            }, {});
            renderPieChart('accountTypesChart', Object.keys(providerCounts), Object.values(providerCounts));
            
            const signupsByDay = newUsers.reduce((acc, user) => {
                const day = user.createdAt.toDate().toISOString().split('T')[0];
                acc[day] = (acc[day] || 0) + 1;
                return acc;
            }, {});
            const sortedSignupLabels = Object.keys(signupsByDay).sort();
            const sortedSignupData = sortedSignupLabels.map(label => signupsByDay[label]);
            renderLineChart('userSignupsChart', sortedSignupLabels, sortedSignupData);

            // Render Table
            renderUserTable(allUsersData);
            document.getElementById('user-search').addEventListener('input', e => {
                const query = e.target.value.toLowerCase();
                const filtered = allUsersData.filter(u => u.username?.toLowerCase().includes(query) || u.email?.toLowerCase().includes(query));
                renderUserTable(filtered);
            });
        }

        function renderSubmissionAnalytics() {
            const recyclableReqs = allRequestsData.filter(r => r.status === 'recyclable');
            const totalScore = allRequestsData.reduce((acc, r) => acc + ((r.upvotes || 0) - (r.downvotes || 0)), 0);

            document.getElementById('total-requests-value').textContent = allRequestsData.length;
            document.getElementById('recyclable-reqs-value').textContent = recyclableReqs.length;
            document.getElementById('avg-votes-value').textContent = allRequestsData.length > 0 ? (totalScore / allRequestsData.length).toFixed(1) : 'N/A';

            // Render Charts
            const typeCounts = allRequestsData.reduce((acc, r) => { acc[r.type] = (acc[r.type] || 0) + 1; return acc; }, {});
            renderPieChart('requestTypesChart', Object.keys(typeCounts), Object.values(typeCounts));
            
            const statusCounts = allRequestsData.reduce((acc, r) => { const status = r.adminStatus || 'Pending'; acc[status] = (acc[status] || 0) + 1; return acc; }, {});
            renderPieChart('adminStatusChart', Object.keys(statusCounts), Object.values(statusCounts));

            // Render Table
            renderRequestsTable(allRequestsData.sort((a,b) => b.timestamp.toMillis() - a.timestamp.toMillis()).slice(0, 50)); // Show 50 most recent
        }

        // --- Table Rendering ---
        function renderUserTable(users) {
            const tbody = document.getElementById('users-table').querySelector('tbody');
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.username || 'N/A'}</td>
                    <td>${user.email}</td>
                    <td>${user.authMethod || 'email'}</td>
                    <td>${user.createdAt ? user.createdAt.toDate().toLocaleDateString() : 'N/A'}</td>
                </tr>
            `).join('');
        }
        function renderRequestsTable(requests) {
            const tbody = document.getElementById('requests-table').querySelector('tbody');
            tbody.innerHTML = requests.map(req => `
                <tr>
                    <td title="${req.title}">${req.title.substring(0, 25)}${req.title.length > 25 ? '...' : ''}</td>
                    <td>${req.type}</td>
                    <td>${req.isAnonymous ? '<i>Anonymous</i>' : req.username}</td>
                    <td>${req.adminStatus || 'Pending'}</td>
                    <td>${(req.upvotes || 0) - (req.downvotes || 0)}</td>
                    <td>${req.timestamp.toDate().toLocaleDateString()}</td>
                </tr>
            `).join('');
        }

        // --- Chart Rendering Functions ---
        function renderPieChart(canvasId, labels, data) {
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#6720bd', '#007bff', '#28a745', '#ffc107', '#dc3545', '#6c757d'], borderColor: '#ffffff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
        }
        function renderLineChart(canvasId, labels, data) {
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Count', data: data, backgroundColor: 'rgba(103, 32, 189, 0.2)', borderColor: '#6720bd', borderWidth: 2, fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } } });
        }

        // --- General UI ---
        document.getElementById('logoutBtn').onclick = () => firebase.auth().signOut();
        document.getElementById('signOutLink').onclick = (e) => { e.preventDefault(); firebase.auth().signOut(); };
        document.getElementById('toggleSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
    </script>
</body>
</html>
