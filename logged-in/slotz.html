<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - SLOTZ</title>
    <link rel="stylesheet" href="../css/style.css" />
    <script src="../panic-key.js"></script>
    <script src="../ban-enforcer.js"></script>
    <script src="../url-changer.js"></script>
    <style>
        /* Base page layout from countdowns.html */
        body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: 'PrimaryFont', sans-serif; }
        .dashboard-container { display: flex; flex: 1; }
        .main-content { flex: 1; padding: 30px; background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%); overflow-y: auto; display: flex; flex-direction: column; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(103, 32, 189, 0.1); flex-shrink: 0; }
        .dashboard-title { margin: 0; font-size: 2.0em; font-weight: bold; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        /* Sidebar */
        .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
        .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { 
            margin-left: 10px; 
            white-space: nowrap; 
            opacity: 1;
            visibility: visible;
            transition: opacity 0.2s ease-in-out;
            transition-delay: 0.4s;
        }
        .sidebar.collapsed nav a .label { 
            opacity: 0;
            visibility: hidden;
            transition-delay: 0s;
        }

        /* --- SLOTS & MODAL STYLES --- */
        .hidden { display: none !important; }
        .game-layout { display: flex; flex-wrap: wrap; gap: 30px; }
        .game-wrapper { flex: 2; min-width: 350px; }
        .scoreboard-wrapper { flex: 1; min-width: 250px; }

        .game-container, .scoreboard-container { background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); display: flex; flex-direction: column; gap: 20px; }
        #controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: center; padding: 15px; background: #f9f9fc; border-radius: 10px; border: 1px solid #eee; }
        .control-group { display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 0.9em; color: #555; }
        #balance { font-weight: bold; color: #6720bd; font-size: 1.2em; }
        #bet { width: 80px; padding: 10px; font-size: 1em; border: 1px solid #ccc; border-radius: 8px; font-family: 'PrimaryFont', sans-serif; text-align: center; }
        
        .btn-primary, .btn-secondary, .btn-danger { border: none; color: #fff; padding: 10px 20px; border-radius: 8px; font-family: 'PrimaryFont', sans-serif; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; font-weight: 600; text-transform: uppercase; }
        .btn-primary { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(103, 32, 189, 0.25); }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(220, 53, 69, 0.25); }
        .btn-primary:disabled, .btn-danger:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }

        .circular-btn { background-color: #f0f2f5; border: 1px solid #e0e0e0; width: 32px; height: 32px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; margin-left: 10px; }
        .circular-btn:hover { background-color: #e8eaf0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transform: rotate(90deg); }
        .circular-btn img { width: 16px; height: 16px; }

        #slot-machine { display: flex; gap: 20px; justify-content: center; }
        .reel { width: 110px; height: 110px; border: 3px solid #e0e0e0; border-radius: 15px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; background-color: #f0f2f5; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05); }
        .reel .number { position: absolute; font-size: 3.5rem; color: #333; font-weight: 900; }
        .reel.spinning .number { animation: slide 0.4s linear infinite; filter: blur(4px); }
        @keyframes slide { 0% { transform: translateY(100%); } 100% { transform: translateY(-100%); } }

        #message { min-height: 1.5em; font-size: 1.5rem; font-weight: 700; text-align: center; transition: opacity 0.5s ease; }
        #message.win.x2 { color: #28a745; }
        #message.win.x3 { color: #ffc107; }
        #message.lose { color: #dc3545; }

        .scoreboard-container h3 { margin: 0 0 10px 0; text-align: center; color: #333; font-family: 'PrimaryFont', sans-serif; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #scoreboardList { list-style: none; padding: 0; margin: 0; }
        #scoreboardList li { display: flex; justify-content: space-between; padding: 12px 8px; border-bottom: 1px solid #f0f0f0; font-size: 0.95em; }
        #scoreboardList li:last-child { border-bottom: none; }
        #scoreboardList .rank { font-weight: bold; color: #6720bd; margin-right: 15px; }
        #scoreboardList .score { font-weight: 600; color: #333; }
        .no-scores { text-align: center; color: #888; font-style: italic; padding: 20px; }
        
        /* Modal styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 400px; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h3 { margin-top: 0; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 1.1em; }
        .form-group input { width: 100%; box-sizing: border-box; padding: 12px; font-size: 1em; border: 1px solid #ccc; border-radius: 8px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .error-message { color: #dc3545; font-size: 0.9em; min-height: 1.2em; margin-top: 5px; font-weight: 600; }
    </style>
</head>
<body class="dashboard-page">

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" /></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <button id="toggleSidebar">‚ò∞</button>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="others.html" class="active"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content fade-in">
            <div class="dashboard-header"><h2 class="dashboard-title">SLOTZ üé∞</h2></div>
            <div class="game-layout">
                <div class="game-wrapper">
                    <div class="game-container">
                        <div id="controls">
                            <div class="control-group">BALANCE: <span id="balance">100</span>
                                <button id="refreshBtn" class="circular-btn hidden" title="Refresh Balance (only at 0)"><img src="../images/refresh-dark.png" alt="Refresh"/></button>
                            </div>
                            <div class="control-group">BET: <input type="number" id="bet" min="1" step="1" value="10"/></div>
                            <button id="spin" class="btn-primary">SPIN</button>
                            <button id="allInBtn" class="btn-danger">ALL IN!</button>
                        </div>
                        <div id="slot-machine">
                            <div class="reel"><div class="number">7</div></div>
                            <div class="reel"><div class="number">7</div></div>
                            <div class="reel"><div class="number">7</div></div>
                        </div>
                        <div id="message">Place your bet and spin!</div>
                    </div>
                </div>
                <div class="scoreboard-wrapper">
                    <div class="scoreboard-container">
                        <h3>üèÜ Personal Best Scores</h3>
                        <ol id="scoreboardList"></ol>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="resetModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Restart Challenge üß†</h3>
            <p>To get more funds, please answer this simple question.</p>
            <div class="form-group">
                <label id="mathQuestionLabel" for="mathAnswerInput">What is 5 + 3?</label>
                <input type="number" id="mathAnswerInput" placeholder="Your Answer">
                <p id="resetError" class="error-message"></p>
            </div>
            <div class="modal-actions">
                <button id="cancelResetBtn" class="btn-secondary">Cancel</button>
                <button id="submitResetBtn" class="btn-primary">Submit</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Globals & DOM Elements ---
        let currentUser, balance = 100n, isSpinning = false, correctAnswer = 0;
        const WIN_TARGET = 1_000_000_000_000_000_000n; // 1 Quintillion
        const sidebar = document.getElementById('sidebar'), toggleSidebarBtn = document.getElementById('toggleSidebar'), mainLogoutBtn = document.getElementById('logoutBtn'), sidebarLogoutBtn = document.getElementById('signOutLink');
        const reelsEls = document.querySelectorAll('.reel .number'), spinBtn = document.getElementById('spin'), balEl = document.getElementById('balance'), betEl = document.getElementById('bet'), msgEl = document.getElementById('message'), allInBtn = document.getElementById('allInBtn'), scoreboardListEl = document.getElementById('scoreboardList'), refreshBtn = document.getElementById('refreshBtn');
        const resetModal = document.getElementById('resetModal'), mathQuestionLabel = document.getElementById('mathQuestionLabel'), mathAnswerInput = document.getElementById('mathAnswerInput'), resetErrorEl = document.getElementById('resetError'), submitResetBtn = document.getElementById('submitResetBtn'), cancelResetBtn = document.getElementById('cancelResetBtn');

        // --- Game Data ---
        const strip = [...Array(15).fill(1), ...Array(15).fill(2), ...Array(15).fill(3), ...Array(10).fill(4), ...Array(5).fill(5), ...Array(3).fill(6), ...Array(2).fill(7)];
        
        // --- Sidebar & Auth ---
        const handleLogout = () => firebase.auth().signOut().catch(e => console.error('Logout Error:', e));
        toggleSidebarBtn.addEventListener('click', () => { sidebar.classList.toggle('collapsed'); });
        const dbRef_ = () => firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid);
        firebase.auth().onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                mainLogoutBtn.addEventListener('click', handleLogout);
                sidebarLogoutBtn.addEventListener('click', handleLogout);
                loadBalance(); renderScoreboard(); updateUIForGameState();
            } else { window.location.href = '../index.html'; }
        });
        
        // --- Local Storage & Scoreboard (using BigInt) ---
        const getStorageKey = (key) => currentUser ? `4sp_${key}_${currentUser.uid}` : null;
        const loadBalance = () => { balance = BigInt(localStorage.getItem(getStorageKey('slotz_balance')) || '100'); };
        const saveBalance = () => localStorage.setItem(getStorageKey('slotz_balance'), balance.toString());
        const loadScores = () => JSON.parse(localStorage.getItem(getStorageKey('slotz_scores')) || '[]');
        const saveScores = (scores) => localStorage.setItem(getStorageKey('slotz_scores'), JSON.stringify(scores));
        
        const addScore = (newScore) => { // newScore is a BigInt
            let scores = loadScores(); // returns array of strings
            if (!scores.includes(newScore.toString())) {
                scores.push(newScore.toString());
                scores.sort((a, b) => {
                    const bigB = BigInt(b);
                    const bigA = BigInt(a);
                    if (bigB > bigA) return 1;
                    if (bigA > bigB) return -1;
                    return 0;
                });
                saveScores(scores.slice(0, 10));
                renderScoreboard();
            }
        };

        const renderScoreboard = () => {
            const scores = loadScores(); // returns strings
            scoreboardListEl.innerHTML = scores.length === 0 
                ? '<li class="no-scores">No high scores yet. Get spinning!</li>' 
                : scores.map((score, i) => `<li><span class="rank">#${i + 1}</span> <span class="score">${BigInt(score).toLocaleString()}</span></li>`).join('');
        };

        // --- Game Logic & State ---
        const updateBalanceUI = () => { balEl.textContent = balance.toLocaleString(); betEl.max = balance.toString(); };
        const setControlsState = (enabled) => { spinBtn.disabled = !enabled; betEl.disabled = !enabled; allInBtn.disabled = !enabled; };
        const showMessage = (text, type = '', duration = 3000) => { msgEl.textContent = text; msgEl.className = type; if (duration) setTimeout(() => { if (msgEl.textContent === text) msgEl.textContent = ''; }, duration); };
        const animateReel = (el, duration, final) => { const p = el.parentElement; p?.classList.add('spinning'); return new Promise(res => setTimeout(() => { p?.classList.remove('spinning'); el.textContent = final; res(final); }, duration)); };
        
        const updateUIForGameState = () => {
            updateBalanceUI();
            if (balance <= 0n) {
                setControlsState(false);
                refreshBtn.classList.remove('hidden');
            } else if (balance < WIN_TARGET) {
                setControlsState(true);
                refreshBtn.classList.add('hidden');
            } else { // Handle re-loading a page where the user has already won
                showMessage('üéâüéâüéâ YOU WON! You reached 1 Quintillion! üéâüéâüéâ', 'win x3', 0);
                setControlsState(false);
            }
        };

        const spin = async () => {
            if (isSpinning) return;
            let betAmount;
            try {
                betAmount = BigInt(betEl.value);
            } catch (e) {
                showMessage('Please enter a valid bet amount.', 'lose'); return;
            }
            if (!betAmount || betAmount < 1n || betAmount > balance) { showMessage('Please enter a valid bet.', 'lose'); return; }
            
            isSpinning = true; setControlsState(false); balance -= betAmount; updateBalanceUI(); showMessage('');
            
            // --- NEW PROBABILITY LOGIC ---
            const chance = Math.random();
            let finals = [];
            const getRandomReelValue = () => strip[Math.floor(Math.random() * strip.length)];

            if (chance < 0.15) { // 15% chance for 3x Jackpot
                const value = getRandomReelValue();
                finals = [value, value, value];
            } else if (chance < 0.50) { // 35% chance for 2x Win (0.15 + 0.35 = 0.50)
                let val1 = getRandomReelValue();
                let val2 = getRandomReelValue();
                while (val1 === val2) { // Ensure the second value is different
                    val2 = getRandomReelValue();
                }
                finals = [val1, val1, val2];
                // Shuffle the array to randomize the position of the non-matching reel
                for (let i = finals.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [finals[i], finals[j]] = [finals[j], finals[i]];
                }
            } else { // 50% chance for Loss
                let val1 = getRandomReelValue();
                let val2 = getRandomReelValue();
                let val3 = getRandomReelValue();
                // Ensure all three are different
                while (val2 === val1) { val2 = getRandomReelValue(); }
                while (val3 === val1 || val3 === val2) { val3 = getRandomReelValue(); }
                finals = [val1, val2, val3];
            }
            // --- END OF NEW LOGIC ---

            const results = await Promise.all(finals.map((val, i) => animateReel(reelsEls[i], [1200, 1400, 1600][i] + Math.random() * 300, val)));
            
            const counts = results.reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
            let payout = 0n;
            
            if (Object.values(counts).includes(3)) {
                payout = betAmount * 3n; showMessage('üéâ JACKPOT! 3√ó WIN!', 'win x3', 5000);
            } else if (Object.values(counts).includes(2)) {
                payout = betAmount * 2n; showMessage('‚ú® NICE! 2√ó WIN!', 'win x2', 5000);
            } else {
                showMessage('üò¢ YOU LOSE', 'lose', 5000);
            }
            
            if (payout > 0n) {
                balance += payout;
                addScore(balance);
                
                if (balance >= WIN_TARGET) {
                    showMessage('üéâüéâüéâ YOU WON! You reached 1 Quintillion! üéâüéâüéâ', 'win x3', 0);
                    isSpinning = true; // Permanently lock spinning
                    saveBalance();
                    updateUIForGameState();
                    return; // End spin logic here
                }
            }
            
            if (balance <= 0n) balance = 0n;
            saveBalance(); isSpinning = false; updateUIForGameState();
            if (balance <= 0n) showMessage('üí∏ YOU ARE OUT OF MONEY! HIT REFRESH TO RESTART.', 'lose', 0);
        };

        // --- Modal Logic ---
        const openResetModal = () => {
            const num1 = Math.floor(Math.random() * 9) + 1;
            const num2 = Math.floor(Math.random() * 9) + 1;
            correctAnswer = num1 + num2;
            mathQuestionLabel.textContent = `What is ${num1} + ${num2}?`;
            mathAnswerInput.value = '';
            resetErrorEl.textContent = '';
            resetModal.classList.add('visible');
            mathAnswerInput.focus();
        };
        const closeResetModal = () => resetModal.classList.remove('visible');
        const handleResetSubmit = () => {
            const userAnswer = parseInt(mathAnswerInput.value, 10);
            if (userAnswer === correctAnswer) {
                balance = 100n; saveBalance();
                showMessage('Correct! Here are some funds. Good luck!', 'win x2', 3000);
                updateUIForGameState(); closeResetModal();
            } else {
                resetErrorEl.textContent = "That's not right. Try this new one.";
                const num1 = Math.floor(Math.random() * 9) + 1;
                const num2 = Math.floor(Math.random() * 9) + 1;
                correctAnswer = num1 + num2;
                mathQuestionLabel.textContent = `What is ${num1} + ${num2}?`;
                mathAnswerInput.value = '';
                mathAnswerInput.focus();
            }
        };

        // --- Event Listeners ---
        spinBtn.addEventListener('click', spin);
        allInBtn.addEventListener('click', () => { if (balance > 0n) { betEl.value = balance.toString(); spin(); } else { showMessage('You have no money to go all in!', 'lose'); } });
        refreshBtn.addEventListener('click', openResetModal);
        submitResetBtn.addEventListener('click', handleResetSubmit);
        cancelResetBtn.addEventListener('click', closeResetModal);
        mathAnswerInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleResetSubmit(); });
    });
    </script>
</body>
</html>
