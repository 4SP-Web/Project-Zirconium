<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - SLOTZ</title>
    <link rel="stylesheet" href="../css/style.css" />
    <script src="../panic-key.js"></script>
    <script src="../ban-enforcer.js"></script>
    <script src="../url-changer.js"></script>
    <style>
        /* Base page layout from countdowns.html */
        body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: 'PrimaryFont', sans-serif; }
        .dashboard-container { display: flex; flex: 1; }
        .main-content { flex: 1; padding: 30px; background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%); overflow-y: auto; display: flex; flex-direction: column; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(103, 32, 189, 0.1); flex-shrink: 0; }
        .dashboard-title { margin: 0; font-size: 2.0em; font-weight: bold; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        /* Sidebar from countdowns.html */
        .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; position: relative; overflow: hidden; }
        .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .sidebar.collapsed nav a { justify-content: center; padding: 10px 0; }
        .sidebar.collapsed nav a .label { display: none; }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em; }
        .marquee-content { display: inline-block; padding-left: 100%; transform: translateX(0); animation: none; line-height: 1.8em; }
        .marquee-active { animation: scroll-left 12s linear infinite; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .user-info .username { font-family: 'PrimaryFont', sans-serif; font-size: 1.3em; margin-bottom: 8px; font-weight: bold; }
        .user-info .email { font-family: 'SecondaryFont', sans-serif; font-size: 0.9em; color: #bbb; }

        /* --- NEW SLOTS STYLES --- */
        .game-layout { display: flex; flex-wrap: wrap; gap: 30px; }
        .game-wrapper { flex: 2; min-width: 350px; }
        .scoreboard-wrapper { flex: 1; min-width: 250px; }

        .game-container, .scoreboard-container {
            background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex; flex-direction: column; gap: 20px;
        }

        #controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: center; padding: 15px; background: #f9f9fc; border-radius: 10px; border: 1px solid #eee; }
        .control-group { display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 0.9em; color: #555; }
        #balance { font-weight: bold; color: #6720bd; font-size: 1.2em; }
        #bet { width: 80px; padding: 10px; font-size: 1em; border: 1px solid #ccc; border-radius: 8px; font-family: 'PrimaryFont', sans-serif; text-align: center; }
        
        .btn-primary, .btn-secondary { border: none; color: #fff; padding: 10px 20px; border-radius: 8px; font-family: 'PrimaryFont', sans-serif; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; font-weight: 600; text-transform: uppercase; }
        .btn-primary { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(103, 32, 189, 0.25); }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; }
        .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(220, 53, 69, 0.25); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }

        #slot-machine { display: flex; gap: 20px; justify-content: center; }
        .reel { width: 110px; height: 110px; border: 3px solid #e0e0e0; border-radius: 15px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; background-color: #f0f2f5; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05); }
        .reel .number { position: absolute; font-size: 3.5rem; color: #333; font-weight: 900; }
        .reel.spinning .number { animation: slide 0.4s linear infinite; filter: blur(4px); }
        @keyframes slide { 0% { transform: translateY(100%); } 100% { transform: translateY(-100%); } }

        #message { min-height: 1.5em; font-size: 1.5rem; font-weight: 700; text-align: center; transition: opacity 0.5s ease; }
        #message.win.x2 { color: #28a745; }
        #message.win.x3 { color: #ffc107; }
        #message.lose { color: #dc3545; }

        .scoreboard-container h3 { margin: 0 0 10px 0; text-align: center; color: #333; font-family: 'PrimaryFont', sans-serif; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #scoreboardList { list-style: none; padding: 0; margin: 0; }
        #scoreboardList li { display: flex; justify-content: space-between; padding: 12px 8px; border-bottom: 1px solid #f0f0f0; font-size: 0.95em; }
        #scoreboardList li:last-child { border-bottom: none; }
        #scoreboardList .rank { font-weight: bold; color: #6720bd; margin-right: 15px; }
        #scoreboardList .score { font-weight: 600; color: #333; }
        .no-scores { text-align: center; color: #888; font-style: italic; padding: 20px; }
    </style>
</head>
<body class="dashboard-page">

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" /></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <button id="toggleSidebar">‚ò∞</button>
            <div class="user-info">
                <div class="marquee-container"><span id="userName" class="marquee-content username">Loading...</span></div>
                <div class="marquee-container"><span id="userEmail" class="marquee-content email">...</span></div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html" class="active"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="others.html"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content fade-in">
            <div class="dashboard-header">
                <h2 class="dashboard-title">SLOTZ üé∞</h2>
            </div>
            
            <div class="game-layout">
                <div class="game-wrapper">
                    <div class="game-container">
                        <div id="controls">
                            <div class="control-group">BALANCE: <span id="balance">1000</span></div>
                            <div class="control-group">BET: <input type="number" id="bet" min="1" step="1" value="10"/></div>
                            <button id="spin" class="btn-primary">SPIN</button>
                            <button id="allInBtn" class="btn-danger">ALL IN!</button>
                        </div>
                        <div id="slot-machine">
                            <div class="reel"><div class="number">7</div></div>
                            <div class="reel"><div class="number">7</div></div>
                            <div class="reel"><div class="number">7</div></div>
                        </div>
                        <div id="message">Place your bet and spin!</div>
                    </div>
                </div>

                <div class="scoreboard-wrapper">
                    <div class="scoreboard-container">
                        <h3>üèÜ Personal Best Scores</h3>
                        <ol id="scoreboardList">
                            <li class="no-scores">Play a round to see your scores!</li>
                        </ol>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Globals & DOM Elements ---
        let currentUser;
        const sidebar = document.getElementById('sidebar');
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        const sidebarUserNameEl = document.getElementById('userName');
        const sidebarUserEmailEl = document.getElementById('userEmail');
        const mainLogoutBtn = document.getElementById('logoutBtn');
        const sidebarLogoutBtn = document.getElementById('signOutLink');

        // Game Elements
        const reelsEls = document.querySelectorAll('.reel .number');
        const spinBtn = document.getElementById('spin');
        const balEl = document.getElementById('balance');
        const betEl = document.getElementById('bet');
        const msgEl = document.getElementById('message');
        const allInBtn = document.getElementById('allInBtn');
        const scoreboardListEl = document.getElementById('scoreboardList');

        // --- Rigging & Game Data ---
        const riggedToLoseEmails = ['enemy1@example.com', 'jace.toot@icloud.com', 'tootja30@minerva.sparcc.org'];
        const riggedToWinEmails = ['ludwza30@minerva.sparcc.org', '4simpleproblems@gmail.com', 'belkwy30@minerva.sparcc.org'];
        const strip = [
            ...Array(15).fill(1), ...Array(15).fill(2), ...Array(15).fill(3),
            ...Array(10).fill(4), ...Array(5).fill(5), ...Array(3).fill(6), ...Array(2).fill(7)
        ];
        
        let balance = 1000;
        let isSpinning = false;
        
        // --- Sidebar & Auth Logic (from countdowns.html) ---
        const handleLogout = () => {
            firebase.auth().signOut().catch(e => console.error('Logout Error:', e));
        };

        const updateMarquees = () => {
            document.querySelectorAll('.marquee-content').forEach(el => {
                const parent = el.parentElement;
                if (!parent) return;
                el.classList.toggle('marquee-active', el.scrollWidth > parent.clientWidth);
            });
        };

        toggleSidebarBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            setTimeout(updateMarquees, 500); // Wait for transition
        });

        const dbRef_ = () => firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid);
        firebase.auth().onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                try {
                    const doc = await dbRef_().get();
                    sidebarUserNameEl.textContent = (doc.exists && doc.data().username) ? doc.data().username : (user.displayName || 'User');
                } catch (error) {
                    sidebarUserNameEl.textContent = user.displayName || 'User';
                }
                sidebarUserEmailEl.textContent = user.email;
                updateMarquees();
                mainLogoutBtn.addEventListener('click', handleLogout);
                sidebarLogoutBtn.addEventListener('click', handleLogout);
                
                // Initialize game for the logged-in user
                loadBalance();
                renderScoreboard();
                setControlsState(true);

            } else {
                window.location.href = '../index.html';
            }
        });
        
        // --- Local Storage & Scoreboard Logic ---
        const getStorageKey = (key) => currentUser ? `4sp_${key}_${currentUser.uid}` : null;
        
        const loadBalance = () => {
            const savedBalance = localStorage.getItem(getStorageKey('slotz_balance'));
            balance = savedBalance ? parseInt(savedBalance, 10) : 1000;
            updateBalanceUI();
        };

        const saveBalance = () => {
            localStorage.setItem(getStorageKey('slotz_balance'), balance);
        };
        
        const loadScores = () => {
            const scoresJSON = localStorage.getItem(getStorageKey('slotz_scores'));
            return scoresJSON ? JSON.parse(scoresJSON) : [];
        };

        const saveScores = (scores) => {
            localStorage.setItem(getStorageKey('slotz_scores'), JSON.stringify(scores));
        };

        const addScore = (newScore) => {
            let scores = loadScores();
            // Check if score is high enough
            if (scores.length < 10 || newScore > scores[scores.length - 1]) {
                if (!scores.includes(newScore)) { // Prevent duplicate scores
                    scores.push(newScore);
                    scores.sort((a, b) => b - a); // Sort descending
                    const top10 = scores.slice(0, 10);
                    saveScores(top10);
                    renderScoreboard();
                }
            }
        };

        const renderScoreboard = () => {
            const scores = loadScores();
            scoreboardListEl.innerHTML = '';
            if (scores.length === 0) {
                scoreboardListEl.innerHTML = '<li class="no-scores">No high scores yet. Get spinning!</li>';
            } else {
                scores.forEach((score, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="rank">#${index + 1}</span> <span class="score">${score.toLocaleString()}</span>`;
                    scoreboardListEl.appendChild(li);
                });
            }
        };

        // --- Game Logic ---
        const shuffle = (arr) => {
            const a = arr.slice();
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        };
        const reelsData = [shuffle(strip), shuffle(strip), shuffle(strip)];

        const setControlsState = (enabled) => {
            spinBtn.disabled = !enabled;
            betEl.disabled = !enabled;
            allInBtn.disabled = !enabled;
            isSpinning = !enabled;
        };
        
        const updateBalanceUI = () => {
            balEl.textContent = balance.toLocaleString();
            betEl.max = balance;
        };

        const showMessage = (text, type = '', duration = 3000) => {
            msgEl.textContent = text;
            msgEl.className = type;
            if (duration) {
                setTimeout(() => {
                    if (msgEl.textContent === text) msgEl.textContent = '';
                }, duration);
            }
        };

        const animateReel = (el, duration, final) => {
            const parent = el.parentElement;
            parent?.classList.add('spinning');
            return new Promise(res => {
                setTimeout(() => {
                    parent?.classList.remove('spinning');
                    el.textContent = final;
                    res(final);
                }, duration);
            });
        };
        
        const spin = async () => {
            if (isSpinning) return;
            const betAmount = parseInt(betEl.value, 10);

            if (!betAmount || betAmount < 1 || betAmount > balance) {
                showMessage('Please enter a valid bet.', 'lose');
                return;
            }

            setControlsState(false);
            balance -= betAmount;
            updateBalanceUI();
            saveBalance();
            showMessage('');

            // Rigging check
            let finals;
            const email = currentUser.email;
            if (riggedToWinEmails.includes(email)) {
                const symbol = strip[Math.floor(Math.random() * strip.length)];
                finals = [symbol, symbol, symbol];
            } else if (riggedToLoseEmails.includes(email)) {
                let s1, s2, s3;
                do { s1 = shuffle(strip)[0]; s2 = shuffle(strip)[0]; s3 = shuffle(strip)[0]; }
                while (s1 === s2 || s2 === s3 || s1 === s3);
                finals = [s1, s2, s3];
            } else {
                 finals = reelsData.map(s => s[Math.floor(Math.random() * s.length)]);
            }

            const durations = [1200, 1400, 1600].map(d => d + Math.random() * 300);
            const results = await Promise.all(finals.map((val, i) => animateReel(reelsEls[i], durations[i], val)));
            
            // Payout logic
            const counts = results.reduce((acc, val) => { acc[val] = (acc[val] || 0) + 1; return acc; }, {});
            let payout = 0;
            
            if (Object.values(counts).includes(3)) {
                payout = betAmount * 3;
                showMessage('üéâ JACKPOT! 3√ó WIN!', 'win x3', 5000);
            } else if (Object.values(counts).includes(2)) {
                payout = betAmount * 2;
                showMessage('‚ú® NICE! 2√ó WIN!', 'win x2', 5000);
            } else {
                showMessage(riggedToLoseEmails.includes(email) ? 'üòÇ ANOTHER LOSS! KEEP TRYING!' : 'üò¢ YOU LOSE', 'lose', 5000);
            }

            if (payout > 0) {
                balance += payout;
                updateBalanceUI();
                saveBalance();
                addScore(balance); // Add to high score on win
            }
            
            if (balance === 0) {
                showMessage('üí∏ YOU ARE OUT OF MONEY! REFRESH TO RESTART.', 'lose', 0);
            } else {
                setControlsState(true);
            }
        };

        // --- Event Listeners ---
        spinBtn.addEventListener('click', spin);
        allInBtn.addEventListener('click', () => {
            if (balance > 0) {
                betEl.value = balance;
                spin();
            } else {
                showMessage('You have no money to go all in!', 'lose');
            }
        });

    });
    </script>
</body>
</html>
