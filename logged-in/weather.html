<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - Weather</title>
    <link rel="stylesheet" href="../css/style.css" />
    <style>
        /* --- Base styles from dashboard --- */
        body.weather-page {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            font-family: 'PrimaryFont', sans-serif;
            background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
        }

        .dashboard-container {
            display: flex;
            flex: 1;
        }

        .sidebar {
            width: 200px;
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #444;
            transition: width 0.5s ease-in-out;
            position: relative;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .sidebar.collapsed {
            width: 85px;
        }

        #toggleSidebar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2em;
            cursor: pointer;
            padding: 4px;
            transition: transform 0.5s ease-in-out;
        }

        .sidebar.collapsed #toggleSidebar {
            transform: translateX(-50%) rotate(180deg);
        }

        .sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 60px 0 0;
        }

        .sidebar nav li {
            margin-bottom: 10px;
        }

        .sidebar nav a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-family: 'PrimaryFont', sans-serif;
            text-transform: uppercase;
        }

        .sidebar nav a:hover,
        .sidebar nav a.active {
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            transform: translateX(5px);
        }

        .sidebar nav a .icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }

        .sidebar nav a .label {
            margin-left: 10px;
            white-space: nowrap;
        }
        
        .sidebar.collapsed nav a {
             justify-content: center;
             padding: 10px 0;
        }

        .sidebar.collapsed nav a .label {
            display: none;
        }

        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }
        
        @media (max-width: 767px) {
            .main-content {
                padding: 20px;
            }
        }

        /* --- Weather Page Specific Styles --- */
        .weather-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(103, 32, 189, 0.1);
        }

        .weather-title {
            margin: 0;
            font-size: 2.2em;
            font-weight: bold;
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .location-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        #locationSearch {
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
            min-width: 200px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        #locationSearch:focus {
            outline: none;
            border-color: #8a2be2;
            box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.2);
        }
        
        .control-btn {
            padding: 10px 15px;
            font-size: 1em;
            font-weight: 600;
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(103, 32, 189, 0.3);
        }

        .weather-grid {
            display: grid;
            gap: 20px;
        }
        
        .weather-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 6px 30px rgba(0, 0, 0, 0.07);
            border: 1px solid rgba(103, 32, 189, 0.1);
        }

        .weather-card-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(103, 32, 189, 0.1);
            padding-bottom: 15px;
        }
        
        /* Current Conditions */
        #currentConditions .content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .current-main {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        #currentIcon {
            font-size: 5em;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        #currentTemp {
            font-size: 4em;
            font-weight: bold;
            color: #333;
        }
        
        #currentDesc {
            font-size: 1.3em;
            color: #555;
        }

        .current-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px 30px;
            font-size: 1em;
        }
        
        .current-details p {
            margin: 0;
            color: #666;
        }
        
        .current-details strong {
            color: #333;
        }
        
        /* Hourly Forecast */
        #hourlyForecast .scroll-container {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            scrollbar-width: thin;
            scrollbar-color: #8a2be2 #e0e0e0;
        }
        
        .hourly-item {
            flex: 0 0 100px;
            text-align: center;
            padding: 15px 10px;
            border-right: 1px solid #f0f0f0;
        }
        
        .hourly-item:last-child {
            border-right: none;
        }

        .hourly-item p { margin: 5px 0; }
        .hourly-time { font-weight: bold; }
        .hourly-icon { font-size: 2em; }
        
        /* Daily Forecast */
        #dailyForecast .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px;
        }
        
        .daily-item {
            background: #f9faff;
            border: 1px solid #e8eaf0;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .daily-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(103, 32, 189, 0.1);
            border-color: rgba(103, 32, 189, 0.3);
        }

        .daily-item p { margin: 5px 0; }
        .daily-day { font-weight: bold; font-size: 1.1em; }
        .daily-icon { font-size: 2.5em; margin: 10px 0; }
        .daily-temps { font-size: 1em; }
        .daily-temps .high { font-weight: 600; }
        .daily-temps .low { color: #777; }
        
        /* Air Quality & UV Index */
        .duo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .status-display {
            text-align: center;
        }

        .status-value {
            font-size: 3em;
            font-weight: bold;
        }
        .status-label {
            font-size: 1.2em;
            margin-top: 5px;
        }
        
        /* Utility */
        .loading-text, .error-text {
            text-align: center;
            font-size: 1.2em;
            color: #888;
            padding: 40px;
        }
        
        .error-text {
            color: #d9534f;
        }

    </style>
</head>

<body class="weather-page">

    <div class="dashboard-container">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">‚ò∞</button>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="weather.html" class="active"><span class="icon">üå¶Ô∏è</span><span class="label">Weather</span></a></li>
                    <li><a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="others.html"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="weather-header">
                <h2 class="weather-title" id="locationName">Loading Location...</h2>
                <div class="location-controls">
                    <input type="text" id="locationSearch" placeholder="Enter city, state, or zip">
                    <button class="control-btn" id="searchBtn">Search</button>
                    <button class="control-btn" id="currentLocationBtn">üìç Current Location</button>
                </div>
            </div>

            <div class="weather-grid" id="weatherGrid">
                <p class="loading-text">Fetching the latest weather data for you...</p>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM Element References ---
            const weatherGrid = document.getElementById('weatherGrid');
            const locationNameEl = document.getElementById('locationName');
            const locationSearchInput = document.getElementById('locationSearch');
            const searchBtn = document.getElementById('searchBtn');
            const currentLocationBtn = document.getElementById('currentLocationBtn');
            const sidebar = document.getElementById('sidebar');
            const toggleSidebarBtn = document.getElementById('toggleSidebar');

            // --- App State ---
            let currentUnits = {
                temp: '¬∞F',
                speed: 'mph',
                precip: 'in',
                pressure: 'inHg'
            };
            let apiUnits = {
                temp: 'fahrenheit',
                speed: 'mph',
                precip: 'inch'
            };

            // --- WMO Weather Code Mapping ---
            const WMO_CODES = {
                0: { desc: "Clear sky", icon: "‚òÄÔ∏è" }, 1: { desc: "Mainly clear", icon: "üå§Ô∏è" },
                2: { desc: "Partly cloudy", icon: "üå•Ô∏è" }, 3: { desc: "Overcast", icon: "‚òÅÔ∏è" },
                45: { desc: "Fog", icon: "üå´Ô∏è" }, 48: { desc: "Depositing rime fog", icon: "üå´Ô∏è" },
                51: { desc: "Light drizzle", icon: "üå¶Ô∏è" }, 53: { desc: "Moderate drizzle", icon: "üå¶Ô∏è" },
                55: { desc: "Dense drizzle", icon: "üåßÔ∏è" }, 56: { desc: "Light freezing drizzle", icon: "üå®Ô∏è" },
                57: { desc: "Dense freezing drizzle", icon: "üå®Ô∏è" }, 61: { desc: "Slight rain", icon: "üåßÔ∏è" },
                63: { desc: "Moderate rain", icon: "üåßÔ∏è" }, 65: { desc: "Heavy rain", icon: " Torrential rain" },
                66: { desc: "Light freezing rain", icon: "üå®Ô∏è" }, 67: { desc: "Heavy freezing rain", icon: "üå®Ô∏è" },
                71: { desc: "Slight snow fall", icon: "‚ùÑÔ∏è" }, 73: { desc: "Moderate snow fall", icon: "‚ùÑÔ∏è" },
                75: { desc: "Heavy snow fall", icon: "‚ùÑÔ∏è" }, 77: { desc: "Snow grains", icon: "‚ùÑÔ∏è" },
                80: { desc: "Slight rain showers", icon: "üå¶Ô∏è" }, 81: { desc: "Moderate rain showers", icon: "üå¶Ô∏è" },
                82: { desc: "Violent rain showers", icon: "‚õàÔ∏è" }, 85: { desc: "Slight snow showers", icon: "üå®Ô∏è" },
                86: { desc: "Heavy snow showers", icon: "üå®Ô∏è" }, 95: { desc: "Thunderstorm", icon: "‚õàÔ∏è" },
                96: { desc: "Thunderstorm with slight hail", icon: "‚õàÔ∏è" }, 99: { desc: "Thunderstorm with heavy hail", icon: "‚õàÔ∏è" },
            };

            // --- Location Management ---
            const saveLocation = (location) => {
                localStorage.setItem('weatherAppLocation', JSON.stringify(location));
            };

            const loadLocation = () => {
                const savedLocation = localStorage.getItem('weatherAppLocation');
                if (savedLocation) {
                    return JSON.parse(savedLocation);
                }
                return null; // No location saved
            };

            const getLocation = () => {
                const savedLocation = loadLocation();
                if (savedLocation) {
                    fetchAndDisplayWeather(savedLocation);
                } else {
                    // If no saved location, use geolocation
                    fetchCurrentLocation();
                }
            };
            
            const fetchCurrentLocation = () => {
                if (!navigator.geolocation) {
                    displayError("Geolocation is not supported by your browser. Please search for a location.");
                    return;
                }
                currentLocationBtn.disabled = true;
                currentLocationBtn.textContent = 'Locating...';
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        // Use Nominatim for reverse geocoding to get a city name
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                        const data = await response.json();
                        const name = data.address.city || data.address.town || data.address.village || "Current Location";
                        const location = { name, latitude, longitude };
                        saveLocation(location);
                        fetchAndDisplayWeather(location);
                        currentLocationBtn.disabled = false;
                        currentLocationBtn.textContent = 'üìç Current Location';
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        displayError("Could not get your location. Please allow location access or search for a city.");
                         currentLocationBtn.disabled = false;
                        currentLocationBtn.textContent = 'üìç Current Location';
                    }
                );
            };

            const searchForLocation = async (query) => {
                if (!query) return;
                // Use Nominatim for geocoding
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
                const data = await response.json();
                if (data && data.length > 0) {
                    const result = data[0];
                    const location = {
                        name: result.display_name.split(',')[0],
                        latitude: parseFloat(result.lat),
                        longitude: parseFloat(result.lon)
                    };
                    saveLocation(location);
                    fetchAndDisplayWeather(location);
                } else {
                    displayError(`Could not find a location for "${query}". Please try again.`);
                }
            };

            // --- Weather Data Fetching and Display ---
            const fetchAndDisplayWeather = async (location) => {
                weatherGrid.innerHTML = `<p class="loading-text">Fetching weather for ${location.name}...</p>`;
                locationNameEl.textContent = location.name;

                try {
                    const params = {
                        current: "temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,pressure_msl,wind_speed_10m,wind_direction_10m,wind_gusts_10m",
                        hourly: "temperature_2m,precipitation_probability,weather_code",
                        daily: "weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_probability_max",
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        forecast_days: 16
                    };

                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${location.latitude}&longitude=${location.longitude}&current=${params.current}&hourly=${params.hourly}&daily=${params.daily}&temperature_unit=${apiUnits.temp}&wind_speed_unit=${apiUnits.speed}&precipitation_unit=${apiUnits.precip}&timezone=${params.timezone}&forecast_days=${params.forecast_days}`;
                    
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Weather API Error: ${response.statusText}`);
                    }
                    const data = await response.json();
                    
                    renderWeather(data, location.name);

                } catch (error) {
                    console.error("Failed to fetch weather data:", error);
                    displayError("Could not retrieve weather data. The service might be temporarily unavailable.");
                }
            };
            
            const renderWeather = (data, name) => {
                weatherGrid.innerHTML = ''; // Clear previous content
                
                // Create and append cards
                weatherGrid.appendChild(createCurrentConditionsCard(data));
                weatherGrid.appendChild(createHourlyForecastCard(data));
                weatherGrid.appendChild(createDailyForecastCard(data));
            };

            const createCurrentConditionsCard = (data) => {
                const card = document.createElement('div');
                card.className = 'weather-card';
                card.id = 'currentConditions';
                
                const {
                    temperature_2m,
                    apparent_temperature,
                    relative_humidity_2m,
                    weather_code,
                    wind_speed_10m,
                    wind_gusts_10m,
                    pressure_msl,
                    wind_direction_10m
                } = data.current;
                
                const codeInfo = WMO_CODES[weather_code] || { desc: 'Unknown', icon: '‚ùì' };
                
                card.innerHTML = `
                    <h3 class="weather-card-title">Current Conditions</h3>
                    <div class="content">
                        <div class="current-main">
                            <span id="currentIcon">${codeInfo.icon}</span>
                            <div>
                                <p id="currentTemp">${Math.round(temperature_2m)}${currentUnits.temp}</p>
                                <p id="currentDesc">${codeInfo.desc}</p>
                            </div>
                        </div>
                        <div class="current-details">
                            <p><strong>Feels Like:</strong> ${Math.round(apparent_temperature)}${currentUnits.temp}</p>
                            <p><strong>Humidity:</strong> ${relative_humidity_2m}%</p>
                            <p><strong>Wind:</strong> ${Math.round(wind_speed_10m)} ${currentUnits.speed}</p>
                            <p><strong>Gusts:</strong> ${Math.round(wind_gusts_10m)} ${currentUnits.speed}</p>
                            <p><strong>Pressure:</strong> ${(pressure_msl * 0.02953).toFixed(2)} ${currentUnits.pressure}</p>
                            <p><strong>Direction:</strong> ${wind_direction_10m}¬∞</p>
                        </div>
                    </div>
                `;
                return card;
            };

            const createHourlyForecastCard = (data) => {
                const card = document.createElement('div');
                card.className = 'weather-card';
                card.id = 'hourlyForecast';
                
                let itemsHtml = '';
                const currentTime = new Date(data.current.time).getHours();
                
                // Show next 24 hours
                for(let i=currentTime; i < currentTime + 24; i++) {
                    const date = new Date(data.hourly.time[i]);
                    const hour = date.getHours();
                    const codeInfo = WMO_CODES[data.hourly.weather_code[i]] || { desc: 'Unknown', icon: '‚ùì' };
                    
                    itemsHtml += `
                        <div class="hourly-item">
                            <p class="hourly-time">${hour === 0 ? '12am' : hour === 12 ? '12pm' : hour > 12 ? (hour - 12) + 'pm' : hour + 'am'}</p>
                            <p class="hourly-icon">${codeInfo.icon}</p>
                            <p class="hourly-temp">${Math.round(data.hourly.temperature_2m[i])}${currentUnits.temp}</p>
                            <p class="hourly-precip">${data.hourly.precipitation_probability[i]}%</p>
                        </div>
                    `;
                }
                
                card.innerHTML = `
                    <h3 class="weather-card-title">Hourly Forecast</h3>
                    <div class="scroll-container">${itemsHtml}</div>
                `;
                return card;
            };

            const createDailyForecastCard = (data) => {
                const card = document.createElement('div');
                card.className = 'weather-card';
                card.id = 'dailyForecast';
                
                let itemsHtml = '';
                
                for(let i=0; i < data.daily.time.length; i++) {
                    const date = new Date(data.daily.time[i] + 'T00:00:00');
                    const dayName = i === 0 ? 'Today' : date.toLocaleDateString(undefined, { weekday: 'short' });
                    const codeInfo = WMO_CODES[data.daily.weather_code[i]] || { desc: 'Unknown', icon: '‚ùì' };
                    
                    itemsHtml += `
                        <div class="daily-item">
                            <p class="daily-day">${dayName}</p>
                             <p class="daily-date">${date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</p>
                            <p class="daily-icon">${codeInfo.icon}</p>
                            <p class="daily-temps">
                                <span class="high">${Math.round(data.daily.temperature_2m_max[i])}¬∞</span> / 
                                <span class="low">${Math.round(data.daily.temperature_2m_min[i])}¬∞</span>
                            </p>
                            <p class="daily-precip">üíß ${data.daily.precipitation_probability_max[i]}%</p>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <h3 class="weather-card-title">16-Day Forecast</h3>
                    <div class="grid-container">${itemsHtml}</div>
                `;
                return card;
            };
            
            const displayError = (message) => {
                 weatherGrid.innerHTML = `<p class="error-text">‚ö†Ô∏è ${message}</p>`;
            };

            // --- Event Listeners ---
            searchBtn.addEventListener('click', () => searchForLocation(locationSearchInput.value));
            locationSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchForLocation(locationSearchInput.value);
                }
            });
            currentLocationBtn.addEventListener('click', fetchCurrentLocation);
            
            toggleSidebarBtn.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
            });

            // --- Initial Load ---
            getLocation();
        });
    </script>
</body>
</html>
