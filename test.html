<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - SIGN UP</title>
    <link rel="stylesheet" href="css/style.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script src="firebase-config.js"></script>

    <script src="panic-key.js"></script>
    <script src="url-changer.js"></script>

    <style>
        /* --- NEW LAYOUT STYLES --- */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px 20px;
            min-height: calc(100vh - 200px); /* Adjust based on header/footer height */
        }

        .auth-card {
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            border: 1px solid #e0e0e0;
            width: 100%;
            max-width: 450px;
            padding: 40px;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
        }

        .auth-view {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out, visibility 0.4s;
        }
        
        .auth-view.hidden {
            opacity: 0;
            transform: translateX(-20px);
            position: absolute;
            top: 40px;
            left: 40px;
            right: 40px;
            visibility: hidden;
        }

        .auth-card h2 {
            font-family: 'PrimaryFont', sans-serif;
            font-size: 2.2em;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .auth-card p.subtitle {
            font-family: 'SecondaryFont', sans-serif;
            font-size: 1.1em;
            color: #555;
            line-height: 1.6;
            text-align: center;
            margin-bottom: 30px;
        }

        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            color: #aaa;
            margin: 25px 0;
            font-family: 'SecondaryFont', sans-serif;
            font-size: 0.9em;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #eee;
        }
        .divider:not(:empty)::before {
            margin-right: .25em;
        }
        .divider:not(:empty)::after {
            margin-left: .25em;
        }

        /* --- SHARED ELEMENT STYLES --- */
        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-family: 'SecondaryFont', sans-serif;
            color: #555;
            font-size: 0.95em;
            text-align: left;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'SecondaryFont', sans-serif;
            font-size: 1em;
            color: #333;
            transition: border-color 0.3s ease;
        }
        .input-group input:focus {
            border-color: #6720bd;
            outline: none;
        }

        .btn-primary, .btn-google {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            font-family: 'PrimaryFont', sans-serif;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background-color: #6720bd;
            color: #fff;
            border: none;
        }
        .btn-primary:not(.btn-disabled):hover {
            background-color: #5a1aa8;
            transform: translateY(-2px);
        }

        .btn-google {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            color: #333;
            border: 1px solid #ccc;
            margin-bottom: 15px;
            font-size: 1em;
        }
        .btn-google img {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }
        .btn-google:not(.btn-disabled):hover {
            background-color: #f5f5f5;
            border-color: #aaa;
        }

        .checkbox-container {
            margin-top: 25px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            font-family: 'SecondaryFont', sans-serif;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
        }
        .checkbox-group a {
            color: #6720bd;
            text-decoration: none;
            font-weight: bold;
        }
        
        .message-area {
            width: 100%;
            margin-top: 15px;
            min-height: 20px;
            text-align: center;
            font-size: 0.9em;
        }
        .error-message { color: #d9534f; }
        
        .switch-link {
            margin-top: 25px;
            font-family: 'SecondaryFont', sans-serif;
            color: #555;
            text-align: center;
            font-size: 1em;
        }
        .switch-link a {
            color: #6720bd;
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
        }
        
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
        }

        .btn-loading {
            position: relative;
            color: transparent !important;
        }

        .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-top: -8px;
            margin-left: -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        .btn-google.btn-loading::after {
            border: 2px solid #555555;
            border-top-color: transparent;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- FULL PAGE LOADER --- */
        #page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20000;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #page-loader.visible {
            opacity: 1;
            visibility: visible;
        }
        #page-loader::after {
            content: "";
            width: 50px;
            height: 50px;
            border: 5px solid #ccc;
            border-radius: 50%;
            border-top-color: #6720bd;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div id="page-loader"></div>

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo">
                <a href="index.html"><img src="images/logo-dark.png" alt="4SP Logo"></a>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">HOME</a></li>
                    <li><a href="login.html">LOGIN</a></li>
                </ul>
            </nav>
            <div class="auth-buttons">
                <a href="login.html" class="btn btn-login">LOGIN</a>
                <a href="signup.html" class="btn btn-signup">SIGN UP</a>
            </div>
        </div>
    </header>

    <div class="auth-container">
        <div class="auth-card">
            <div id="hub-view" class="auth-view">
                <h2>Create an Account</h2>
                <p class="subtitle">Join the community in just a few clicks.</p>

                <button id="googleSignupBtn" class="btn-google">
                    <img src="images/google-icon.png" alt="Google Icon"> Sign up with Google
                </button>
                <button id="githubSignupBtn" class="btn-google">
                    <img src="images/github-mark.png" alt="GitHub Icon"> Sign up with GitHub
                </button>

                <div class="divider">or</div>
                
                <button id="showEmailFormBtn" class="btn-primary">Continue with Email</button>
            </div>

            <div id="email-view" class="auth-view hidden">
                <form id="signupForm" novalidate>
                    <h2>Your Details</h2>
                    <p class="subtitle">Let's get your account set up.</p>
                    <div class="input-group">
                        <label for="signupUsername">Username</label>
                        <input type="text" id="signupUsername" required minlength="4" maxlength="16">
                    </div>
                    <div class="input-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" required>
                    </div>
                    <div class="input-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" required minlength="6" maxlength="36">
                    </div>
                    <button type="submit" class="btn-primary" id="emailSignupBtn">Create Account</button>
                </form>
            </div>
            
            <div class="checkbox-container">
                <div class="checkbox-group">
                    <input type="checkbox" id="agreeTerms">
                    <label for="agreeTerms">I agree to the <a href="legal.html" target="_blank">Terms of Service</a></label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="agreePrivacy">
                    <label for="agreePrivacy">I agree to the <a href="legal.html" target="_blank">Privacy Policy</a></label>
                </div>
            </div>

            <div id="signupMessage" class="message-area"></div>
            
            <p class="switch-link">
                Already have an account? <a href="login.html">Login here</a>
                <span id="backToHub" style="display: none;">or <a href="#">Go Back</a></span>
            </p>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 4SP. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const db = firebase.firestore();
            const auth = firebase.auth();
            
            // Views
            const hubView = document.getElementById('hub-view');
            const emailView = document.getElementById('email-view');

            // Buttons
            const googleSignupBtn = document.getElementById('googleSignupBtn');
            const githubSignupBtn = document.getElementById('githubSignupBtn');
            const showEmailFormBtn = document.getElementById('showEmailFormBtn');
            const emailSignupBtn = document.getElementById('emailSignupBtn');
            const backToHubLink = document.querySelector('#backToHub a');

            // Inputs & Other Elements
            const signupForm = document.getElementById('signupForm');
            const signupMessageDiv = document.getElementById('signupMessage');
            const agreeTermsCheckbox = document.getElementById('agreeTerms');
            const agreePrivacyCheckbox = document.getElementById('agreePrivacy');
            const pageLoader = document.getElementById('page-loader');

            const showPageLoader = (show) => {
                pageLoader.classList.toggle('visible', show);
            };

            const showMessage = (text, isError = true) => {
                signupMessageDiv.textContent = text;
                signupMessageDiv.className = isError ? 'message-area error-message' : 'message-area success-message';
            };

            const setButtonLoading = (button, isLoading) => {
                if (!button) return;
                if (isLoading) {
                    button.classList.add('btn-loading');
                    button.disabled = true;
                } else {
                    button.classList.remove('btn-loading');
                    updateButtonState();
                }
            };

            const updateButtonState = () => {
                const areCheckboxesChecked = agreeTermsCheckbox.checked && agreePrivacyCheckbox.checked;
                const allButtons = [googleSignupBtn, githubSignupBtn, showEmailFormBtn, emailSignupBtn];
                allButtons.forEach(btn => {
                    if (btn && !btn.classList.contains('btn-loading')) {
                        btn.disabled = !areCheckboxesChecked;
                        btn.classList.toggle('btn-disabled', !areCheckboxesChecked);
                    }
                });
            };

            const showEmailView = (show) => {
                hubView.classList.toggle('hidden', show);
                emailView.classList.toggle('hidden', !show);
                document.getElementById('backToHub').style.display = show ? 'inline' : 'none';
            };
            
            showEmailFormBtn.addEventListener('click', () => showEmailView(true));
            backToHubLink.addEventListener('click', (e) => {
                e.preventDefault();
                showEmailView(false);
            });

            const showSuccessScreen = (username, email) => {
                const authCard = document.querySelector('.auth-card');
                authCard.innerHTML = `
                    <div style="text-align: center;">
                        <h2>Account Created!</h2>
                        <p class="subtitle">Welcome, ${username}! A verification link has been sent to ${email}.</p>
                        <p style="font-size: 0.9em; color: #888; margin-bottom: 25px;">Please check your inbox (and spam folder) to activate your account before logging in.</p>
                        <a href="login.html" class="btn-primary">Proceed to Login</a>
                    </div>`;
            };

            const cleanupFailedUser = async (user) => {
                if (user) {
                    try { await user.delete(); console.log("Cleaned up partially created user from Auth."); } 
                    catch (error) { console.error("CRITICAL: Failed to clean up user.", error); }
                }
            };
            
            agreeTermsCheckbox.addEventListener('change', updateButtonState);
            agreePrivacyCheckbox.addEventListener('change', updateButtonState);

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showMessage('', false);
                const username = document.getElementById('signupUsername').value.trim();
                const email = document.getElementById('signupEmail').value.trim();
                const password = document.getElementById('signupPassword').value;

                if (username.length < 4 || username.length > 16) return showMessage('Username must be 4-16 characters.');
                const passwordRegex = /^(?=.*[A-Z])(?=.*\d)(?=.*[^a-zA-Z0-9]).{6,36}$/;
                if (!passwordRegex.test(password)) return showMessage('Password must be 6-36 chars and include an uppercase letter, number, and symbol.');

                setButtonLoading(emailSignupBtn, true);
                let user = null;
                try {
                    if (await isUsernameTaken(username)) throw new Error('That username is already taken.');
                    if (await isEmailBanned(email)) throw new Error('This email address is not allowed to register.');
                    
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    user = userCredential.user;

                    const docCreated = await createUserDocument(user, 'password', username);
                    if (!docCreated) throw new Error('Could not create user profile. Rolling back.');
                    
                    await user.sendEmailVerification(actionCodeSettings);
                    showSuccessScreen(username, email);
                } catch (error) {
                    await cleanupFailedUser(user);
                    let message = error.message || 'Sign-up failed. Please try again.';
                    if (error.code === 'auth/email-already-in-use') message = 'This email is already in use.';
                    showMessage(message);
                } finally {
                    setButtonLoading(emailSignupBtn, false);
                }
            });
            
            const startProviderSignUp = (providerName) => {
                let provider;
                if (providerName === 'Google') provider = new firebase.auth.GoogleAuthProvider();
                else if (providerName === 'GitHub') provider = new firebase.auth.GithubAuthProvider();
                else return;

                sessionStorage.setItem('pendingRedirect', providerName);
                showPageLoader(true); // Show loader immediately on click
                auth.signInWithRedirect(provider).catch(error => {
                    showMessage("Could not start sign-up. Please check browser settings.");
                    sessionStorage.removeItem('pendingRedirect');
                    showPageLoader(false);
                });
            };

            const handleRedirectResult = async () => {
                try {
                    const result = await auth.getRedirectResult();
                    if (!result || !result.user) {
                        return; // No user, no redirect, do nothing.
                    }
                    
                    const user = result.user;
                    const providerName = sessionStorage.getItem('pendingRedirect') || 'your provider';
                    
                    if (!user.email) throw new Error(`Email permission was denied by ${providerName}. We need your email to create an account.`);
                    if (await isEmailBanned(user.email)) throw new Error('This email address is not allowed to register.');

                    if (result.additionalUserInfo?.isNewUser) {
                        let username = (user.displayName || user.email.split('@')[0] || 'User').replace(/[^a-zA-Z0-9]/g, '').slice(0, 16);
                        if (username.length < 4) username = `User${user.uid.substring(0, 8)}`;
                        if (await checkProfanity(username)) username = `User${user.uid.substring(0, 8)}`;
                        
                        let finalUsername = username;
                        for (let i = 1; await isUsernameTaken(finalUsername); i++) {
                            const suffix = i;
                            finalUsername = `${username.slice(0, 15 - String(suffix).length)}${suffix}`;
                        }

                        const docCreated = await createUserDocument(user, providerName.toLowerCase(), finalUsername);
                        if (!docCreated) throw new Error("Could not save user profile. Please try again.");
                        
                        if (!user.emailVerified) await user.sendEmailVerification(actionCodeSettings);
                        showSuccessScreen(finalUsername, user.email);
                    } else {
                        throw new Error(`An account with this ${providerName} email already exists. Please log in instead.`);
                    }
                } catch (error) {
                    await cleanupFailedUser(auth.currentUser);
                    if (auth.currentUser) await auth.signOut();
                    showMessage(error.message || `Failed to sign up.`);
                    console.error(`Redirect Error:`, error);
                } finally {
                    sessionStorage.removeItem('pendingRedirect');
                    showPageLoader(false);
                }
            };

            googleSignupBtn.addEventListener('click', () => startProviderSignUp('Google'));
            githubSignupBtn.addEventListener('click', () => startProviderSignUp('GitHub'));

            const initializePage = () => {
                if (sessionStorage.getItem('pendingRedirect')) {
                    showPageLoader(true);
                }
                
                handleRedirectResult();

                // Other helper functions, assuming they are defined elsewhere or not needed for this component
                const isUsernameTaken = async (username) => {
                     const querySnapshot = await db.collection('users').where('username', '==', username).limit(1).get();
                     return !querySnapshot.empty;
                };
                const createUserDocument = async (user, authMethod, username) => {
                     await db.collection('users').doc(user.uid).set({
                        email: user.email, authMethod, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        username, emailVerified: user.emailVerified 
                     });
                     return true;
                };

                updateButtonState();
            };

            initializePage();
        });
    </script>
</body>
</html>
