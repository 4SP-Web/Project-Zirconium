<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>4SP - SIGNUP</title>

    <link rel="stylesheet" href="css/style.css">

    <!-- Firebase compat libs (matching your setup) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script src="firebase-config.js"></script>
    <script src="panic-key.js"></script>
    <script src="url-changer.js"></script>

    <style>
        /* condensed CSS from your file with minor tweaks for debug area */
        body { font-family: Arial, Helvetica, sans-serif; margin:0; padding:0; background:#fafafa; color:#222; }
        .container { max-width:1100px; margin:0 auto; padding:20px; }
        header{background:#fff;border-bottom:1px solid #eee;padding:12px 0;}
        header .logo img{height:36px;}
        .auth-split-container{display:flex; gap:0; max-width:900px; margin:40px auto; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.06)}
        .auth-col{flex:1;padding:36px; box-sizing:border-box;}
        .left-col{background:#f8f9fa;border-right:1px solid #eee; min-width:320px;}
        h1,h2{margin:0 0 14px;}
        form{max-width:380px;}
        .input-group{margin-bottom:16px;}
        input[type="text"], input[type="email"], input[type="password"]{width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:15px;}
        .btn-primary{display:inline-block;width:100%; padding:12px;border-radius:8px;background:#6720bd;color:#fff;border:0; cursor:pointer;font-size:16px;}
        .btn-google{display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;border-radius:8px;border:1px solid #ccc;background:#fff; cursor:pointer;font-size:15px;width:100%;}
        .consent-text{font-style:italic;color:#666;margin-top:12px; font-family: 'SecondaryFont', sans-serif;}
        .message-area{min-height:36px;margin-top:12px;color:#d9534f;}
        .debug-area{margin-top:14px;background:#111;color:#fff;padding:10px;border-radius:8px;font-family:monospace;font-size:12px;display:none;white-space:pre-wrap; max-height:200px; overflow:auto;}
        .toggle-debug{margin-top:10px;background:transparent;border:1px dashed #ccc;padding:6px 8px;border-radius:6px;cursor:pointer;font-size:13px;}
        .right-col h2{margin-top:0;}
        footer{padding:18px;background:#fff;border-top:1px solid #eee;text-align:center;margin-top:30px;}
        @media(max-width:760px){ .auth-split-container{flex-direction:column;} .left-col{border-right:none;border-bottom:1px solid #eee;} }
    </style>
</head>
<body>
    <header>
        <div class="container" style="display:flex;align-items:center;justify-content:space-between;">
            <div class="logo"><a href="index.html"><img src="images/logo-dark.png" alt="4SP"></a></div>
            <nav>
                <a href="index.html" style="margin-right:12px;color:#444;text-decoration:none;">Home</a>
                <a href="login.html" style="color:#444;text-decoration:none;">Login</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="auth-split-container" id="authContainer">
            <div class="auth-col left-col" id="leftCol">
                <h2>Create an account</h2>
                <form id="signupForm" novalidate>
                    <div id="step1" class="signup-step">
                        <div class="input-group">
                            <label for="signupUsername">Username</label>
                            <input id="signupUsername" type="text" placeholder="4-16 characters (letters, numbers, -_* etc)" minlength="4" maxlength="16" required pattern="^[a-zA-Z0-9?!@#$%&\*\\-]+$">
                        </div>
                        <button id="nextBtn" type="button" class="btn-primary">Next</button>
                    </div>

                    <div id="step2" class="signup-step" style="display:none;margin-top:12px;">
                        <div class="input-group">
                            <label for="signupEmail">Email (Gmail recommended)</label>
                            <input id="signupEmail" type="email" placeholder="you@gmail.com">
                        </div>

                        <div class="input-group">
                            <label for="signupPassword">Password</label>
                            <input id="signupPassword" type="password" placeholder="6-36 chars, 1 uppercase, 1 number, 1 symbol" minlength="6" maxlength="36">
                        </div>

                        <div class="input-group">
                            <label for="verifyPassword">Verify Password</label>
                            <input id="verifyPassword" type="password" placeholder="Re-enter password">
                        </div>

                        <button id="emailSignupBtn" type="submit" class="btn-primary">Create Account</button>

                        <p class="consent-text">By signing up you agree to the <a href="legal.html" target="_blank">Terms of Service</a> and <a href="legal.html" target="_blank">Privacy Policy</a>.</p>
                        <div id="signupMessage" class="message-area" role="status"></div>
                    </div>
                </form>

                <p style="margin-top:14px;">Already have an account? <a href="login.html">Login here</a></p>

                <!-- developer debug area (toggleable) -->
                <button id="toggleDebug" class="toggle-debug">Show debug output</button>
                <div id="debugArea" class="debug-area" aria-hidden="true"></div>
            </div>

            <div class="auth-col right-col" id="rightCol">
                <h2>Other ways to join</h2>
                <p style="margin-bottom:12px;color:#555;">Use a trusted provider to sign up quickly.</p>

                <button id="googleSignupBtn" class="btn-google" title="Sign up with Google">
                    <img src="images/google-icon.png" alt="Google" style="width:20px;height:20px;"> Sign up with Google
                </button>

                <div style="height:10px"></div>

                <button id="githubSignupBtn" class="btn-google" title="Sign up with GitHub">
                    <img src="images/github-mark.png" alt="GitHub" style="width:20px;height:20px;"> Sign up with GitHub
                </button>

                <div style="margin-top:18px;color:#666;font-size:14px;">
                    <strong>Tip:</strong> If popups are blocked, we'll automatically fall back to a redirect-based sign-in that is more compatible with strict browsers.
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">&copy; 2025 4SP. All rights reserved.</div>
    </footer>

    <script>
    // --- Utility & UI helpers ---
    function $(id){ return document.getElementById(id); }
    function logDebug(msg){ 
        try { 
            const dbg = $('debugArea'); 
            dbg.style.display = 'block'; 
            dbg.setAttribute('aria-hidden','false');
            dbg.textContent += msg + "\\n\\n";
            console.log('[4SP debug]', msg);
        } catch(e){ console.log('[4SP debug]', msg); }
    }
    function showMessage(text, isError=true){
        const el = $('signupMessage');
        el.textContent = text || '';
        el.style.color = isError ? '#d9534f' : '#2c9f4a';
    }
    function setButtonLoading(btn, isLoading){
        if(!btn) return;
        btn.disabled = isLoading;
        btn.style.opacity = isLoading ? '0.6' : '1';
    }

    // --- Main logic ---
    document.addEventListener('DOMContentLoaded', async () => {
        const auth = firebase.auth();
        const db = firebase.firestore();
        const leftCol = $('leftCol');
        const step1 = $('step1');
        const step2 = $('step2');
        const nextBtn = $('nextBtn');
        const emailSignupBtn = $('emailSignupBtn');
        const googleSignupBtn = $('googleSignupBtn');
        const githubSignupBtn = $('githubSignupBtn');
        const signupForm = $('signupForm');
        const toggleDebug = $('toggleDebug');
        let currentUsername = '';

        // actionCodeSettings used for email verification links
        const actionCodeSettings = {
            url: `${window.location.protocol}//${window.location.hostname}${(window.location.port ? ':' + window.location.port: '')}/verify.html`,
            handleCodeInApp: true
        };

        // show/hide debug area
        toggleDebug.addEventListener('click', () => {
            const dbg = $('debugArea');
            const shown = dbg.style.display !== 'none' && dbg.style.display !== '';
            dbg.style.display = shown ? 'none' : 'block';
            dbg.setAttribute('aria-hidden', shown ? 'true' : 'false');
            toggleDebug.textContent = shown ? 'Show debug output' : 'Hide debug output';
        });

        // password helpers - keep minimal for readability
        const setupPasswordToggle = (btnId, inputId) => {
            // (you can reintroduce eye icons if you want)
        };

        // not-intrusive profanity check (same as before)
        async function checkProfanity(text){
            if(!text || !text.trim()) return false;
            try {
                const r = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
                if(!r.ok) return false;
                const result = await r.text();
                return result.toLowerCase() === 'true';
            } catch(e){
                console.warn('profanity check failed', e);
                return false;
            }
        }

        async function isUsernameTaken(username){
            try {
                const snap = await db.collection('users').where('username','==',username).limit(1).get();
                return !snap.empty;
            } catch(e){
                console.error('username check error', e);
                return true;
            }
        }

        async function createUserDocument(user, authMethod, username){
            try {
                await db.collection('users').doc(user.uid).set({
                    email: user.email,
                    authMethod,
                    username,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    emailVerified: !!user.emailVerified
                });
                return true;
            } catch(e){
                console.error('createUserDocument error', e);
                return false;
            }
        }

        async function showSuccessScreen(username, email){
            // simplified success screen replacement
            leftCol.innerHTML = `
                <h2>Account Created!</h2>
                <div style="margin-top:12px;">
                    <p><strong>Username:</strong> ${username}</p>
                    <p><strong>Email:</strong> ${email}</p>
                    <p style="color:#666;margin-top:10px;">A verification link was sent if required. Check spam if needed.</p>
                    <a href="login.html" class="btn-primary" style="display:inline-block;margin-top:12px;text-decoration:none;">Proceed to Login</a>
                </div>
            `;
        }

        async function cleanupFailedUser(user){
            try {
                if(user && user.delete) await user.delete();
                await auth.signOut();
            } catch(e){
                console.warn('cleanup failed', e);
                try{ await auth.signOut(); }catch(e2){ console.warn('signOut also failed', e2); }
            }
        }

        // --- Steps navigation ---
        nextBtn.addEventListener('click', async () => {
            showMessage('');
            const username = $('signupUsername').value.trim();
            const re = /^[a-zA-Z0-9?!@#$%&\*\\-]+$/;
            if(username.length < 4 || username.length > 16){ showMessage('Username must be 4-16 characters.'); return; }
            if(!re.test(username)){ showMessage('Username contains invalid characters.'); return; }
            if(await checkProfanity(username)){ showMessage('Please choose a different username.'); return; }
            if(await isUsernameTaken(username)){ showMessage('Username already taken.'); return; }
            currentUsername = username;
            step1.style.display = 'none';
            step2.style.display = 'block';
        });

        // --- Email/password signup (unchanged, still sends verification) ---
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showMessage('');
            const email = $('signupEmail').value.trim();
            const password = $('signupPassword').value;
            const verifyPassword = $('verifyPassword').value;
            if(!email){ showMessage('Please enter an email.'); return; }
            if(password !== verifyPassword){ showMessage('Passwords do not match.'); return; }
            const pwRe = /^(?=.*[A-Z])(?=.*\d)(?=.*[^a-zA-Z0-9]).{6,36}$/;
            if(!pwRe.test(password)){ showMessage('Password must be 6-36 characters and include an uppercase letter, number and special character.'); return; }
            setButtonLoading(emailSignupBtn, true);
            try {
                // optional: restrict to gmail if desired
                // if(!email.toLowerCase().endsWith('@gmail.com')) { showMessage('We recommend Gmail for best deliverability.'); }
                const cred = await auth.createUserWithEmailAndPassword(email, password);
                const user = cred.user;
                try {
                    await user.sendEmailVerification(actionCodeSettings);
                    const ok = await createUserDocument(user, 'password', currentUsername || ('User'+user.uid.substring(0,8)));
                    if(!ok) throw new Error('Failed to create user doc');
                    await showSuccessScreen(currentUsername || ('User'+user.uid.substring(0,8)), email);
                } catch(postErr){
                    console.error('post-creation error', postErr);
                    await cleanupFailedUser(user);
                    throw postErr;
                }
            } catch(err){
                console.error('email signup error', err);
                let msg = 'Sign-up failed. Try again.';
                if(err && err.code === 'auth/email-already-in-use') msg = 'This email is already in use.';
                else if(err && err.code === 'auth/weak-password') msg = 'Weak password.';
                showMessage(msg);
            } finally {
                setButtonLoading(emailSignupBtn, false);
            }
        });

        // ---------------------------------------
        // Robust OAuth handling (Google + GitHub)
        // ---------------------------------------

        // Common post-provider processing:
        async function processOAuthResult(result, providerName){
            // result is what firebase returns from popup or redirect
            logDebug(`processOAuthResult: provider=${providerName} result=${JSON.stringify(result, null, 2)}`);
            if(!result || !result.user){
                logDebug('No result.user in provider response.');
                showMessage('Authentication failed. Please try again.');
                return;
            }
            const user = result.user;

            // Try common places for email
            let userEmail = user.email || 
                            (result.additionalUserInfo && result.additionalUserInfo.profile && result.additionalUserInfo.profile.email) ||
                            (result.additionalUserInfo && result.additionalUserInfo.profile && result.additionalUserInfo.profile['email']);

            // If profile didn't include email but accessToken is present, fetch userinfo from Google endpoint
            if(!userEmail && result.credential && result.credential.accessToken){
                try {
                    const token = result.credential.accessToken;
                    logDebug('Access token present. Fetching Google userinfo endpoint...');
                    const r = await fetch(`https://www.googleapis.com/oauth2/v3/userinfo?access_token=${encodeURIComponent(token)}`);
                    if(r.ok){
                        const profile = await r.json();
                        logDebug('Google userinfo:', JSON.stringify(profile, null, 2));
                        userEmail = userEmail || profile.email;
                    } else {
                        logDebug('Google userinfo fetch failed: ' + r.status);
                    }
                } catch(fetchErr){
                    console.error('userinfo fetch err', fetchErr);
                }
            }

            // If still no email, attempt alternative checks (GitHub may need additional scope)
            if(!userEmail){
                // If provider is GitHub and there's additionalUserInfo.profile.emails array, attempt to find one
                if(providerName === 'GitHub' && result.additionalUserInfo && result.additionalUserInfo.username){
                    // GitHub often requires extra scope to reveal email; we'll try to see what's available.
                    logDebug('GitHub provider returned no email. additionalUserInfo: ' + JSON.stringify(result.additionalUserInfo, null, 2));
                }

                // Final fallback: sign out and show clear instructions + a retry button
                try{ await auth.signOut(); } catch(e){ console.warn('signOut fallback failed', e); }
                const msg = 'Could not retrieve email from ' + providerName + '. Make sure you grant email permission on the consent screen and allow popups/cookies. Click Retry to try a different flow.';
                showMessage(msg);
                // create a retry UI
                createRetryUI(providerName);
                return;
            }

            // Now we have an email: check banned / new user flow
            if(await isEmailBanned(userEmail)){
                await cleanupFailedUser(user);
                showMessage('This email address is not allowed to register.');
                return;
            }

            const isNewUser = result.additionalUserInfo && result.additionalUserInfo.isNewUser;
            if(isNewUser){
                try {
                    // build username
                    let proposed = user.displayName || userEmail.split('@')[0] || 'User';
                    proposed = proposed.replace(/[^a-zA-Z0-9?!@#$%&\*\\-]/g, '');
                    if(proposed.length < 4) proposed = `User${user.uid.substring(0,8)}`;
                    else if(proposed.length > 16) proposed = proposed.substring(0,16);
                    if(await checkProfanity(proposed)) proposed = `User${user.uid.substring(0,8)}`;

                    // ensure uniqueness
                    let finalUsername = proposed;
                    let counter = 1;
                    while(await isUsernameTaken(finalUsername)){
                        const suffix = `_${counter}`;
                        const maxBase = 16 - suffix.length;
                        const base = proposed.length > maxBase ? proposed.substring(0,maxBase) : proposed;
                        finalUsername = base + suffix;
                        counter++;
                        if(counter>1000){ finalUsername = `User${user.uid.substring(0,12)}`; break; }
                    }

                    // create the user document (do NOT send verification for OAuth)
                    const created = await createUserDocument(user, providerName.toLowerCase(), finalUsername);
                    if(!created) throw new Error('Document creation failed');
                    await showSuccessScreen(finalUsername, userEmail);
                } catch(e){
                    console.error('Post-OAuth new user processing error', e);
                    await cleanupFailedUser(user);
                    showMessage('Could not finish signup. Try again.');
                }
            } else {
                // Not new -> instruct to login instead
                try{ await auth.signOut(); } catch(e){ console.warn('signOut on existing user failed', e); }
                showMessage('An account with this email already exists. Try logging in instead.');
            }
        }

        function createRetryUI(providerName){
            // Remove any previous retry box
            const existing = document.getElementById('oauthRetryBox');
            if(existing) existing.remove();
            const box = document.createElement('div');
            box.id = 'oauthRetryBox';
            box.style.marginTop = '12px';
            box.innerHTML = `
                <div style="padding:12px;border-radius:8px;background:#fff;border:1px solid #eee;">
                    <div style="margin-bottom:8px;color:#333;">
                        <strong>Retry ${providerName} sign-in</strong>
                    </div>
                    <div style="margin-bottom:8px;color:#666;">Try the redirect-based flow (more compatible) or disable popup blockers / allow third-party cookies and try again.</div>
                    <div style="display:flex;gap:8px;">
                        <button id="retryRedirectBtn" class="btn-google">Retry (Redirect)</button>
                        <button id="retryPopupBtn" class="btn-google">Retry (Popup)</button>
                    </div>
                </div>
            `;
            $('leftCol').appendChild(box);
            $('retryRedirectBtn').addEventListener('click', async () => {
                box.remove();
                await startOAuthRedirectFlow(providerName);
            });
            $('retryPopupBtn').addEventListener('click', async () => {
                box.remove();
                if(providerName === 'Google') startOAuthPopup('Google');
                else startOAuthPopup('GitHub');
            });
        }

        // start popup flow
        async function startOAuthPopup(providerName){
            const auth = firebase.auth();
            try {
                if(providerName === 'Google'){
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.addScope('email');
                    provider.addScope('profile');
                    provider.setCustomParameters({ prompt: 'select_account' });
                    const result = await auth.signInWithPopup(provider);
                    logDebug('Popup result: ' + JSON.stringify(result, null, 2));
                    await processOAuthResult(result, 'Google');
                } else if(providerName === 'GitHub'){
                    const provider = new firebase.auth.GithubAuthProvider();
                    provider.addScope('user:email');
                    const result = await auth.signInWithPopup(provider);
                    logDebug('Popup result (GitHub): ' + JSON.stringify(result, null, 2));
                    await processOAuthResult(result, 'GitHub');
                }
            } catch(err){
                console.error('Popup sign-in error:', err);
                logDebug('Popup sign-in error: ' + (err && err.message) + ' code=' + (err && err.code));
                // If popup blocked or operation not allowed, fallback to redirect
                if(err && (err.code === 'auth/popup-blocked' || err.code === 'auth/cancelled-popup-request' || err.code === 'auth/operation-not-supported-in-this-environment' || err.code === 'auth/web-storage-unsupported')){
                    showMessage('Popup blocked or not supported. Falling back to redirect-based sign in...');
                    await startOAuthRedirectFlow(providerName);
                } else {
                    showMessage('Could not sign in with popup. Try the redirect option.');
                }
            }
        }

        // start redirect flow (set a flag so we know to look for redirect result)
        async function startOAuthRedirectFlow(providerName){
            const auth = firebase.auth();
            try {
                localStorage.setItem('oauthRedirectInProgress', providerName);
                if(providerName === 'Google'){
                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.addScope('email');
                    provider.addScope('profile');
                    provider.setCustomParameters({ prompt: 'select_account' });
                    await auth.signInWithRedirect(provider);
                } else {
                    const provider = new firebase.auth.GithubAuthProvider();
                    provider.addScope('user:email');
                    await auth.signInWithRedirect(provider);
                }
            } catch(e){
                console.error('redirect start error', e);
                showMessage('Could not start redirect sign-in. Check popups/settings and try again.');
            }
        }

        // getRedirectResult handler (run after page load to catch redirect results)
        async function handlePendingRedirectResult(){
            try {
                const auth = firebase.auth();
                const result = await auth.getRedirectResult();
                const providerName = localStorage.getItem('oauthRedirectInProgress') || 'Google';
                if(result && result.user){
                    logDebug('getRedirectResult returned: ' + JSON.stringify(result, null, 2));
                    await processOAuthResult(result, providerName);
                } else {
                    logDebug('getRedirectResult: no user in result. raw result: ' + JSON.stringify(result, null, 2));
                }
            } catch(e){
                console.error('getRedirectResult error', e);
                logDebug('getRedirectResult error: ' + (e && e.message));
                showMessage('Sign-in redirect failed. Try again.');
            } finally {
                localStorage.removeItem('oauthRedirectInProgress');
            }
        }

        // Attach UI event handlers for provider buttons
        googleSignupBtn.addEventListener('click', async () => {
            // Try popup first, fallback inside handler
            await startOAuthPopup('Google');
        });

        githubSignupBtn.addEventListener('click', async () => {
            // GitHub popup (if fails will show retry UI)
            await startOAuthPopup('GitHub');
        });

        // If user was redirected back, handle result
        // We run this with a short timeout to allow firebase to initialize
        setTimeout(() => {
            if(localStorage.getItem('oauthRedirectInProgress')){
                logDebug('Detected oauthRedirectInProgress flag on page load. Processing redirect result...');
                handlePendingRedirectResult();
            } else {
                // Still call getRedirectResult once just in case
                auth.getRedirectResult().then(res => {
                    if(res && res.user){
                        logDebug('getRedirectResult at load returned user: ' + JSON.stringify(res, null, 2));
                        // we don't know provider name here; use Google by default (or check additionalUserInfo.providerId)
                        const providerId = res.credential && res.credential.providerId || (res.additionalUserInfo && res.additionalUserInfo.providerId) || 'google.com';
                        const pName = providerId.includes('github') ? 'GitHub' : 'Google';
                        processOAuthResult(res, pName);
                    } else {
                        // nothing to do
                    }
                }).catch(err => {
                    // ignore/noisy errors
                    logDebug('Initial getRedirectResult error: ' + (err && err.message));
                });
            }
        }, 500);

        // Helper: check banned emails collection
        async function isEmailBanned(email){
            if(!email) return false;
            try {
                const d = await db.collection('bannedEmails').doc(email.toLowerCase()).get();
                return d.exists;
            } catch(e){
                console.error('isEmailBanned error', e);
                return false;
            }
        }

        // initialize view
        step1.style.display = 'block';
        step2.style.display = 'none';
        showMessage('');

        // Developer hint: show debug area automatically while testing
        // Uncomment below line if you want to auto-show debug area on dev hosts:
        // $('debugArea').style.display = 'block';
    });
    </script>
</body>
</html>
