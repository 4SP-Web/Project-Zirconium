<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - SIGN UP</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* This CSS is specific to signup.html, defining the main frame for the content */
        .auth-split-container {
            background-color: #fff; /* White background for the main frame */
            border-radius: 16px; /* Rounded corners for the main frame */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); /* Subtle shadow for the main frame */
            border: 1px solid #e0e0e0; /* A distinct border for the main frame */
            display: flex;
            flex-wrap: wrap; /* Allow columns to wrap on smaller screens */
            max-width: 900px; /* Max width for the container */
            margin: 50px auto; /* Center the container */
            overflow: hidden; /* Ensures rounded corners are respected */
        }

        .auth-col {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .auth-col.left-col {
            background-color: #f8f9fa; /* Slightly different background for left column */
            border-right: 1px solid #eee;
            min-width: 300px; /* Ensure left column has a minimum width */
        }

        .auth-col h2 {
            font-family: 'PrimaryFont', sans-serif;
            font-size: 2.2em;
            color: #333;
            margin-bottom: 25px;
            text-align: center;
            width: 100%;
        }

        .auth-col form {
            width: 100%;
            max-width: 350px;
        }

        .auth-col .input-group {
            margin-bottom: 20px;
        }

        .auth-col .input-group label {
            display: block;
            margin-bottom: 8px;
            font-family: 'SecondaryFont', sans-serif;
            color: #555;
            font-size: 0.95em;
            text-align: left;
        }

        .auth-col .input-group input[type="text"],
        .auth-col .input-group input[type="email"],
        .auth-col .input-group input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'SecondaryFont', sans-serif;
            font-size: 1em;
            color: #333;
            transition: border-color 0.3s ease;
        }

        .auth-col .input-group input[type="text"]:focus,
        .auth-col .input-group input[type="email"]:focus,
        .auth-col .input-group input[type="password"]:focus {
            border-color: #6720bd; /* Purple focus */
            outline: none;
        }

        .auth-col .btn-primary {
            width: 100%;
            padding: 14px;
            background-color: #6720bd; /* Primary purple */
            color: #fff;
            border: none;
            border-radius: 8px;
            font-family: 'PrimaryFont', sans-serif;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .auth-col .btn-primary:hover {
            background-color: #5a1aa8; /* Darker purple on hover */
            transform: translateY(-2px);
        }

        .auth-col .separator {
            width: 100%;
            max-width: 350px;
            margin: 25px 0;
            text-align: center;
            position: relative;
            font-family: 'SecondaryFont', sans-serif;
            color: #888;
        }

        .auth-col .separator::before,
        .auth-col .separator::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background-color: #ddd;
        }

        .auth-col .separator::before {
            left: 0;
        }

        .auth-col .separator::after {
            right: 0;
        }

        .auth-col .btn-google {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 350px;
            padding: 12px;
            background-color: #fff;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: 'PrimaryFont', sans-serif;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .auth-col .btn-google img {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .auth-col .btn-google:hover {
            background-color: #f5f5f5;
            border-color: #aaa;
        }

        .auth-col .switch-link {
            width: 100%;
            max-width: 350px;
            margin-top: 25px;
            font-family: 'SecondaryFont', sans-serif;
            color: #555;
            text-align: center;
        }
        
        .auth-col .switch-link a {
            color: #6720bd;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .auth-col .switch-link a:hover {
            color: #5a1aa8;
        }

        .auth-col .message-area {
            width: 100%;
            max-width: 350px;
            margin-top: 15px;
            min-height: 20px; /* Reserve space to prevent layout shift */
            text-align: center;
            font-size: 0.9em;
        }
        
        .auth-col .error-message {
            color: #d9534f; /* Red for error */
        }
        
        .auth-col .success-message {
            color: #5cb85c; /* Green for success */
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .auth-split-container {
                flex-direction: column;
                margin: 20px;
            }
            .auth-col.left-col {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body>
    <section class="hero-section dark-bg">
        <div class="container">
            <h1>JOIN 4SP TODAY!</h1>
        </div>
    </section>
    
    <header class="main-header light-bg">
        <div class="container">
            <div class="logo">
                <a href="index.html"><img src="images/logo-dark.png" alt="4SP Logo"></a>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">HOME</a></li>
                    <li><a href="signup.html">SIGN UP</a></li>
                </ul>
            </nav>
            <div class="auth-buttons">
                <a href="login.html" class="btn btn-login">LOGIN</a>
                <a href="signup.html" class="btn btn-signup">SIGN UP</a>
            </div>
        </div>
    </header>

    <div class="auth-split-container">
        <div class="auth-col left-col">
            <h2>Create Your Account</h2>
            <form id="signupForm" novalidate>
                <div class="input-group">
                    <label for="signupUsername">Username</label>
                    <input type="text" id="signupUsername" placeholder="Enter your desired username" required maxlength="16">
                </div>
                <div class="input-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" placeholder="Enter your email" required>
                </div>
                <div class="input-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" placeholder="Create a password (min 6 characters)" required>
                </div>
                <button type="submit" class="btn-primary">SIGN UP</button>
            </form>
            <div id="signupMessage" class="message-area"></div>

            <div class="separator">OR</div>

            <button id="googleSignupBtn" class="btn-google">
                <img src="images/google-icon.png" alt="Google Icon"> Sign Up with Google
            </button>

            <p class="switch-link">Already have an account? <a href="login.html">Log in here</a></p>
        </div>
        <div class="auth-col right-col">
            <h2>Start Your Adventure!</h2>
            <p style="text-align: center;">Sign up for 4SP and get access to your personalized dashboard, exciting games, secure proxies, and the ultimate soundboard!</p>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 4SP. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const db = firebase.firestore();
            const auth = firebase.auth();
            const signupMessageDiv = document.getElementById('signupMessage');

            // Helper to display messages
            const showMessage = (element, text, isError = true) => {
                element.textContent = text;
                element.className = isError ? 'message-area error-message' : 'message-area success-message';
            };

            // --- Email/Password Sign Up Logic ---
            document.getElementById('signupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                signupMessageDiv.innerHTML = '';
                
                const usernameRaw = document.getElementById('signupUsername').value.trim();
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;

                // Username validation
                if (usernameRaw.length < 4 || usernameRaw.length > 16) {
                    showMessage(signupMessageDiv, 'Username must be between 4 and 16 characters.');
                    return;
                }
                if (!/^[a-zA-Z0-9.\?\!@#$%&*-]+$/.test(usernameRaw)) {
                    showMessage(signupMessageDiv, 'Username can only contain letters, numbers, and ., ?, !, @, #, $, %, &, *, -');
                    return;
                }

                // Password validation
                if (password.length < 6) {
                    showMessage(signupMessageDiv, 'Password must be at least 6 characters long.');
                    return;
                }

                try {
                    // Profanity filter for username
                    const customProfanities = [];
                    const addParam = encodeURIComponent(customProfanities.join(','));
                    const purgoUrl = 'https://www.purgomalum.com/service/json' + '?text=' + encodeURIComponent(usernameRaw) + '&add=' + addParam;
                    const response = await fetch(purgoUrl);

                    if (!response.ok) {
                        throw new Error('Profanity filter service unavailable.');
                    }

                    const data = await response.json();
                    const filteredUsername = data.result;

                    if (filteredUsername !== usernameRaw) {
                        showMessage(signupMessageDiv, 'Profanity detected and replaced in username: "' + filteredUsername + '"', true);
                        // Optionally, update the input field with the filtered username
                        document.getElementById('signupUsername').value = filteredUsername;
                        return; // Stop signup if profanity was found and user needs to see it
                    }

                    // Create user with email and password
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    // Send email verification
                    await user.sendEmailVerification();

                    // Store username in Firestore
                    await db.collection('users').doc(user.uid).set({
                        username: filteredUsername,
                        email: user.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        accountType: 'email/password'
                    });

                    showMessage(signupMessageDiv, 'Account created! A verification email has been sent to your inbox. Please verify your email before logging in.', false);

                    // Clear form
                    document.getElementById('signupUsername').value = '';
                    document.getElementById('signupEmail').value = '';
                    document.getElementById('signupPassword').value = '';

                } catch (error) {
                    console.error('Sign up error:', error);
                    let message = 'An unknown sign up error occurred. Please try again.';
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            message = 'The email address is already in use by another account. Please log in or use a different email.';
                            break;
                        case 'auth/invalid-email':
                            message = 'The email address is not valid.';
                            break;
                        case 'auth/weak-password':
                            message = 'The password is too weak. Please choose a stronger password.';
                            break;
                        case 'auth/operation-not-allowed':
                            message = 'Email/password sign-in is not enabled. Please contact support.';
                            break;
                    }
                    showMessage(signupMessageDiv, message);
                }
            });

            // --- Google Sign Up Logic ---
            document.getElementById('googleSignupBtn').addEventListener('click', async () => {
                signupMessageDiv.innerHTML = '';
                const provider = new firebase.auth.GoogleAuthProvider();

                try {
                    const result = await auth.signInWithPopup(provider);
                    const user = result.user;

                    // Check if the user was just created
                    if (result.additionalUserInfo && result.additionalUserInfo.isNewUser) {
                        // User was just created, save their info to Firestore
                        const defaultUsername = user.displayName || user.email.split('@')[0]; // Use display name or part of email as default username

                        // Profanity filter for default username from Google
                        const customProfanities = [];
                        const addParam = encodeURIComponent(customProfanities.join(','));
                        const purgoUrl = 'https://www.purgomalum.com/service/json' + '?text=' + encodeURIComponent(defaultUsername) + '&add=' + addParam;
                        const response = await fetch(purgoUrl);

                        if (!response.ok) {
                            throw new Error('Profanity filter service unavailable.');
                        }

                        const data = await response.json();
                        const filteredUsername = data.result;

                        if (filteredUsername !== defaultUsername) {
                            showMessage(signupMessageDiv, 'Profanity detected and replaced in your Google username: "' + filteredUsername + '". You can change it later in settings.', true);
                        }

                        await db.collection('users').doc(user.uid).set({
                            username: filteredUsername,
                            email: user.email,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            accountType: 'google'
                        });
                        
                        // Redirect to dashboard after successful signup
                        window.location.href = 'logged-in/dashboard.html';

                    } else {
                        // This user already exists, redirect to login or dashboard if already logged in
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            // User exists in Firestore, redirect to dashboard
                            showMessage(signupMessageDiv, 'You are already signed up. Redirecting to dashboard...', false);
                            setTimeout(() => {
                                window.location.href = 'logged-in/dashboard.html';
                            }, 1500);
                        } else {
                            // This means they have a Firebase Auth account but not a Firestore record (edge case)
                            // Sign them out and ask them to contact support or try signing up again.
                            await auth.signOut();
                            showMessage(signupMessageDiv, 'An existing Google account was found, but your record is incomplete. Please try signing up again or contact support.');
                        }
                    }
                } catch (error) {
                    console.error('Google Sign-Up error:', error);
                    let message = 'A problem occurred with Google Sign-Up. Please try again.';
                    if (error.code === 'auth/popup-closed-by-user') {
                        // This is not an error, just the user cancelling the signup.
                        return; 
                    } else if (error.code === 'auth/account-exists-with-different-credential') {
                        message = 'An account with this email already exists using a password. Please log in with your email and password, or use a different email to sign up with Google.';
                    }
                    showMessage(signupMessageDiv, message);
                }
            });
        });
    </script>
</body>
</html>
