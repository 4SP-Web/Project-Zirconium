<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - GN-GAMES</title>

    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link rel="apple-touch-icon" href="../images/favicon.png">
    <link rel="stylesheet" href="../css/style.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/gn-math/gn-math.github.io@main/gnmath.js"></script>

    <script>
        window.addEventListener('beforeunload', function (event) {
            // This prompt is often disruptive. Only enable if truly critical for unsaved game states.
            // Consider if Firebase/game state saving makes this less necessary.
            // event.preventDefault();
            // event.returnValue = ''; // For older browsers
            // return 'Are you sure you want to leave? Any unsaved progress in the current game might be lost.';
        });
    </script>

    <meta name="description" content="Play unblocked games via GN-Math on the 4SP platform. Fast, free, no downloads—perfect for school or home.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-4sp-site.com/GN-GAMES/index.html"> <meta property="og:title" content="4SP - GN-Math Games">
    <meta property="og:description" content="Play unblocked games via GN-Math on the 4SP platform.">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://your-4sp-site.com/GN-GAMES/index.html"> <meta name="twitter:title" content="4SP - GN-Math Games">
    <meta name="twitter:description" content="Play unblocked games via GN-Math on the 4SP platform.">
    <meta name="keywords" content="unblocked games, 4sp, gn-math, browser games, school games, html5 games, free games, play games, online games, gaming">

    <style>
        :root {
            --v4-card-bg: #fff;
            --v4-input-bg: #f8f9fa;
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-border: #ccc;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
        }

        body.dashboard-page {
            display: flex; flex-direction: column; min-height: 100vh;
            margin: 0; font-family: var(--v4-font-primary);
            background-color: var(--v4-bg-gradient); /* More specific than 'background' */
        }
        .dashboard-container { display: flex; flex: 1; overflow: hidden; }

        /* Sidebar Styles (Standardized) */
        .sidebar {
            width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff; padding: 20px 10px; display: flex; flex-direction: column;
            border-right: 1px solid #444; transition: width 0.5s ease-in-out;
            position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); flex-shrink: 0; /* Prevent sidebar from shrinking */
            z-index: 1001; /* Ensure sidebar is above some content but below modals */
        }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: none; border: none; color: #fff; font-size: 1.2em;
            cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out;
        }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .user-info {
            text-align: center; margin: 60px 0 30px;
            border-bottom: 1px solid #555; padding-bottom: 20px;
            overflow: hidden; /* Changed from visible to hidden for marquee container */
        }
        .marquee-container {
            overflow: hidden; white-space: nowrap; position: relative;
            width: 100%; height: 1.8em; line-height: 1.8em;
        }
        .marquee-content {
            display: inline-block; padding-left: 100%; transform: translateX(0);
            animation: none; line-height: 1.8em;
        }
        .marquee-active { animation: scroll-left-gn-games 12s linear infinite; }
        .sidebar.collapsed .marquee-active { animation-duration: 20s; } /* Slower when collapsed */
        @keyframes scroll-left-gn-games {
            0%   { transform: translateX(0); } /* Start fully to the right (padded) */
            100% { transform: translateX(-100%); } /* Scroll fully to the left */
        }
        .user-info .username {
            font-family: var(--v4-font-primary); font-size: 1.3em; margin-bottom: 8px;
            line-height: 0.2em; font-weight: bold; display: block; /* ensure it takes width for marquee */
        }
        .user-info .email {
            font-family: var(--v4-font-secondary); font-size: 0.9em; color: #bbb; display: block;
        }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a {
            display: flex; align-items: center; padding: 12px 15px; color: #fff;
            text-decoration: none; border-radius: 8px; transition: all 0.3s ease;
            font-family: var(--v4-font-primary); text-transform: uppercase;
            position: relative; overflow: hidden; font-size: 1em;
        }
        .sidebar nav a::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        .sidebar nav a:hover::before { left: 100%; }
        .sidebar nav a.active, .sidebar nav a:hover {
            background: var(--v4-purple-gradient); transform: translateX(5px); color: #fff;
        }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center;}
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap;}
        .sidebar.collapsed nav a { justify-content: center; padding: 10px 0;}
        .sidebar.collapsed nav a .label { display: none; }
        .sidebar.collapsed nav a .icon { margin-left: 0; } /* Removed margin-right for centering */

        /* Main Content & Animations */
        .main-content {
            flex: 1; padding: 30px; background-color: var(--v4-bg-gradient);
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .main-content.fade-in { animation: fadeInPageContent 0.6s ease-out; }
        @keyframes fadeInPageContent {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sidebar.slide-in { animation: slideInSidebarAnim 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideInSidebarAnim {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .page-header-v4 {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; background: var(--v4-card-bg);
            padding: 20px 30px; border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(103, 32, 189, 0.1);
        }
        .page-title-v4 {
            margin: 0; font-size: 2.2em; font-weight: bold;
            background: var(--v4-purple-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; font-family: var(--v4-font-primary);
        }

        /* GN-Math Specific Styles (Themed for V4) */
        .game-controls {
            background-color: var(--v4-card-bg); padding: 15px 20px;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.07);
            margin-bottom: 25px; display: flex; gap: 15px;
            align-items: center; flex-wrap: wrap;
        }
        .game-controls .search-container { display: flex; gap: 10px; align-items: center; flex-grow: 1; }
        .game-controls input[type="text"], .game-controls select {
            padding: 10px 15px; border: 1px solid var(--v4-input-border);
            border-radius: 8px; font-family: var(--v4-font-secondary);
            background-color: var(--v4-input-bg); color: var(--v4-text-primary);
            font-size: 0.95em; /* Slightly adjusted for better fit */
        }
        .game-controls input[type="text"] { flex-grow: 1; min-width: 200px; }
        .game-controls input[type="text"]:focus, .game-controls select:focus { /* Combined for consistency */
            border-color: var(--v4-purple-accent);
            box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.15); outline: none;
        }
        .game-controls select { min-width: 150px; }

        #zoneCount {
            margin-bottom: 20px; font-family: var(--v4-font-secondary);
            color: var(--v4-text-primary); font-size: 1.1em;
            padding: 12px 15px; background-color: var(--v4-input-bg);
            border-radius: 8px; text-align: left;
            border: 1px solid var(--v4-border-softer); /* Added subtle border */
        }
        #container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px; /* Increased gap slightly */ padding-bottom: 20px;
        }
        #container .zone-item { /* Game card */
            background-color: var(--v4-card-bg); border: 1px solid var(--v4-border-softer);
            border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            font-family: var(--v4-font-secondary); color: var(--v4-text-primary);
            cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            text-align: center; display: flex; flex-direction: column;
            overflow: hidden;
        }
        #container .zone-item:hover {
            transform: translateY(-4px); box-shadow: 0 5px 15px rgba(0,0,0,0.12);
            border-color: var(--v4-purple-accent);
        }
        #container .zone-item img {
            width: 100%; height: 140px; object-fit: cover;
            border-radius: 8px; margin-bottom: 12px; /* Increased margin */
            background-color: var(--v4-border-softer); /* Placeholder bg for loading */
        }
        #container .zone-item button { /* Play button */
            background: var(--v4-purple-gradient); color: white;
            border: none; padding: 10px; cursor: pointer;
            font-weight: bold; margin-top: auto; border-radius: 6px;
            font-family: var(--v4-font-primary); font-size: 0.95em;
            width: 100%; white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis; display: block; text-transform: uppercase;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        #container .zone-item button:hover {
             background: linear-gradient(135deg, var(--v4-purple-accent-darker) 0%, #7923c8 100%);
             transform: translateY(-1px);
        }

        /* Zone Viewer (Iframe Modal) */
        #zoneViewer {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9); /* Darker overlay */ z-index: 2000;
            flex-direction: column;
            animation: fadeInZoneViewer 0.3s ease-out;
        }
        @keyframes fadeInZoneViewer {
            from { opacity: 0; } to { opacity: 1; }
        }
        #zoneViewer .zone-header {
            background-color: var(--v4-card-bg); padding: 12px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--v4-border-light); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        #zoneViewer .zone-header .zone-title { display: flex; align-items: baseline; }
        #zoneViewer .zone-header .zone-title h2 { margin: 0; font-size: 1.3em; color: var(--v4-text-primary); font-family: var(--v4-font-primary); }
        #zoneViewer .zone-header .zone-title a { font-size: 0.85em; color: var(--v4-purple-accent); text-decoration: none; margin-left: 10px; }
        #zoneViewer .zone-header .zone-title a:hover { text-decoration: underline; }
        #zoneViewer .zone-controls button {
            margin-left: 10px; padding: 8px 15px; background: var(--v4-purple-gradient); color: white;
            border: none; border-radius: 6px; cursor: pointer; font-family: var(--v4-font-primary);
            font-size: 0.9em; transition: background 0.3s ease, transform 0.2s ease;
        }
        #zoneViewer .zone-controls button:hover {
            background: linear-gradient(135deg, var(--v4-purple-accent-darker) 0%, #7923c8 100%);
            transform: translateY(-1px);
        }
        #zoneViewer iframe {
            flex-grow: 1; border: none;
            background-color: #000; /* Black background for game area */
        }

        /* General Popup (Contact/Privacy) */
        #popupOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); /* Slightly darker overlay */ z-index: 2010;
            display: none; justify-content: center; align-items: center; padding: 20px;
        }
        #popupOverlay .popup {
            background-color: var(--v4-card-bg); padding: 25px 30px; /* Adjusted padding */
            border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); /* Enhanced shadow */
            width: 100%; max-width: 600px; /* Slightly wider popup */
            animation: fadeInPopupAnimation 0.3s ease-out;
        }
        @keyframes fadeInPopupAnimation {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        #popupOverlay .popup-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--v4-border-softer); padding-bottom: 15px; margin-bottom: 20px; /* Adjusted margin */
        }
        #popupOverlay .popup-header h3 { margin: 0; font-family: var(--v4-font-primary); color: var(--v4-text-primary); font-size: 1.5em; } /* Larger title */
        #popupOverlay .popup-header button#popupClose { /* More specific selector */
            background: none; border: none; font-size: 1.8em; cursor: pointer;
            color: var(--v4-text-secondary); line-height: 1; padding: 0;
            transition: color 0.2s ease;
        }
        #popupOverlay .popup-header button#popupClose:hover { color: var(--v4-purple-accent); }
        #popupBody {
            font-family: var(--v4-font-secondary); color: var(--v4-text-secondary);
            line-height: 1.7; /* Improved readability */ max-height: 60vh; overflow-y: auto;
            font-size: 0.95em; /* Slightly larger text */
        }
        #popupBody p { margin-bottom: 1em; }
        #popupBody h2 { font-family: var(--v4-font-primary); color: var(--v4-text-primary); margin-top: 0.5em; margin-bottom: 0.5em; font-size: 1.2em; }

        /* Footer Styles */
        footer {
            background-color: var(--v4-card-bg); color: var(--v4-text-secondary);
            text-align: center; padding: 20px 0; border-top: 1px solid var(--v4-border-softer);
            font-family: var(--v4-font-secondary); font-size: 0.9em; margin-top: auto; /* Push to bottom */
        }
        footer .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .footer-links a, .footer-links label {
            color: var(--v4-purple-accent) !important; text-decoration: none; margin: 0 10px !important;
            cursor: pointer;
        }
        .footer-links a:hover, .footer-links label:hover { text-decoration: underline !important; }

        /* Utility classes */
        .hidden { display: none !important; }

    </style>
</head>
<body class="dashboard-page">

    <header class="main-header"> <div class="container">
            <div class="logo">
                <a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"></a>
            </div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <button id="toggleSidebar">☰</button>
            <div class="user-info">
                <div class="marquee-container"><span id="userName" class="marquee-content username">Loading…</span></div>
                <div class="marquee-container"><span id="userEmail" class="marquee-content email">Loading…</span></div>
            </div>
            <nav>
                <ul>
                    <li><a href="../logged-in/dashboard.html"><span class="icon">🏠</span><span class="label">Dashboard</span></a></li>
                    <li><a href="../logged-in/proxies.html"><span class="icon">🛡️</span><span class="label">Proxies</span></a></li>
                    <li><a href="../logged-in/soundboard.html"><span class="icon">🎵</span><span class="label">Soundboard</span></a></li>
                    <li><a href="index.html" class="active"><span class="icon">🎮</span><span class="label">Games</span></a></li>
                    <li><a href="../logged-in/others.html"><span class="icon">✨</span><span class="label">Others</span></a></li>
                    <li><a href="../logged-in/settings.html"><span class="icon">⚙️</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">🔒</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-header-v4">
                <h2 class="page-title-v4">GN-Math Games</h2>
            </div>

            <div class="game-controls">
                <div class="search-container">
                    <input type="text" id="searchBar" placeholder="Search games..." aria-label="Search games">
                    <select id="sortOptions" aria-label="Sort games by">
                        <option value="name">Sort by Name</option>
                        <option value="id">Sort by Date</option>
                        <option value="popular">Sort by Popularity</option>
                    </select>
                </div>
            </div>

            <div id="zoneCount">Loading games...</div>
            <div id="container">
                </div>
        </main>
    </div>

    <div id="zoneViewer" class="hidden" aria-modal="true" role="dialog" aria-labelledby="zoneName">
        <div class="zone-header">
            <div class="zone-title">
                <h2 id="zoneName">Game Title</h2>
                <span id="zoneId" class="hidden"></span> <a id="zoneAuthor" href="#" target="_blank" rel="noopener noreferrer">by Author</a>
            </div>
            <div class="zone-controls">
                <button id="fullscreenBtnZone">Fullscreen</button>
                <button id="newTabBtnZone">New Tab</button>
                <button id="downloadBtnZone">Download</button>
                <button id="closeBtnZone">Close</button>
            </div>
        </div>
        <iframe id="zoneFrame" title="Game Content" allowfullscreen></iframe>
    </div>

    <div id="popupOverlay" class="hidden" aria-modal="true" role="dialog" aria-labelledby="popupTitle">
        <div class="popup">
            <div class="popup-header">
                <h3 id="popupTitle">Popup Title</h3>
                <button id="popupClose" aria-label="Close popup">×</button>
            </div>
            <div id="popupBody"></div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; <span id="currentYear"></span> 4SP. All rights reserved.</p>
            <div class="footer-links" style="margin-top: 10px; font-size: 0.9em;">
                <a href="#" id="contactLink">Contact</a>
                <a href="#" id="privacyLink">Privacy Policy</a>
                <a href="#" id="exportDataLink">Export Data</a>
                <label for="importData" style="cursor:pointer;">Import Data</label>
                <input type="file" id="importData" class="hidden" accept=".json">
            </div>
        </div>
    </footer>

    <script>
    // START: Core 4SP Dashboard and Firebase Logic
    const dbRef = () => {
        const currentUser = firebase.auth().currentUser;
        return currentUser ? firebase.firestore().collection('users').doc(currentUser.uid) : null;
    };

    const marqueeEls = document.querySelectorAll('.marquee-content');
    const sidebarEl = document.getElementById('sidebar');
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    const userNameEl = document.getElementById('userName');
    const userEmailEl = document.getElementById('userEmail');
    const headerLogoutBtn = document.getElementById('logoutBtn');
    const sidebarSignOutLink = document.getElementById('signOutLink');
    const mainContentEl = document.querySelector('.main-content');
    const popupOverlayEl = document.getElementById('popupOverlay');
    const popupCloseBtn = document.getElementById('popupClose');

    function handleLogout() {
        firebase.auth().signOut().then(() => {
            window.location.href = '../login.html'; // Corrected path relative to GN-GAMES
        }).catch(error => console.error('Logout error:', error));
    }

    if (headerLogoutBtn) headerLogoutBtn.addEventListener('click', handleLogout);
    if (sidebarSignOutLink) {
        sidebarSignOutLink.addEventListener('click', (e) => {
            e.preventDefault();
            handleLogout();
        });
    }

    firebase.auth().onAuthStateChanged(async user => {
        const body = document.body;
        if (user) {
            if (userEmailEl) userEmailEl.textContent = user.email;
            if (userNameEl) {
                const userDocRef = dbRef();
                if (userDocRef) {
                    try {
                        const doc = await userDocRef.get();
                        userNameEl.textContent = (doc.exists && doc.data().username) ? doc.data().username : (user.displayName || 'User');
                    } catch (error) {
                        userNameEl.textContent = user.displayName || 'User';
                        console.error("Error fetching username:", error);
                    }
                } else {
                    userNameEl.textContent = user.displayName || 'User';
                }
            }

            if (!body.classList.contains('animations-applied')) {
                if(sidebarEl) sidebarEl.classList.add('slide-in');
                if(mainContentEl) mainContentEl.classList.add('fade-in');
                body.classList.add('animations-applied');
            }
            
            if (typeof listZones === 'function') listZones(); // Load games after auth
            else console.error("listZones function is not defined.");

        } else {
            window.location.href = '../login.html'; // Corrected path
        }
        updateMarquees();
    });

    if (toggleSidebarBtn && sidebarEl) {
        toggleSidebarBtn.addEventListener('click', () => {
            sidebarEl.classList.toggle('collapsed');
            setTimeout(updateMarquees, 500); 
        });
    }

    function updateMarquees() {
        marqueeEls.forEach(el => {
            if (!el || !el.parentElement || !sidebarEl) return;
            const parent = el.parentElement;
            if (parent.clientWidth === 0 && !sidebarEl.classList.contains('collapsed')) {
                setTimeout(updateMarquees, 150); 
                return;
            }
            const isCollapsed = sidebarEl.classList.contains('collapsed');
            const contentWidth = el.scrollWidth;
            const containerWidth = parent.clientWidth;
            // For collapsed sidebar, always scroll if there's content.
            // For expanded, scroll only if content overflows.
            const shouldScroll = isCollapsed ? (contentWidth > 0) : (contentWidth > containerWidth);
            el.classList.toggle('marquee-active', shouldScroll);
        });
    }
    
    window.addEventListener('resize', () => setTimeout(updateMarquees, 300));
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        if (firebase.auth().currentUser && !document.body.classList.contains('animations-applied')) {
            if(sidebarEl) sidebarEl.classList.add('slide-in');
            if(mainContentEl) mainContentEl.classList.add('fade-in');
            document.body.classList.add('animations-applied');
        }
        setTimeout(updateMarquees, 300); // Initial call
    });

    function closePopup() {
        if (popupOverlayEl) {
            popupOverlayEl.classList.add('hidden');
            popupOverlayEl.style.display = 'none'; // Ensure it's hidden
        }
        const popupBody = document.getElementById('popupBody');
        if (popupBody) popupBody.innerHTML = '';
    }
    if (popupCloseBtn) popupCloseBtn.addEventListener('click', closePopup);
    // END: Core 4SP Dashboard and Firebase Logic


    // START: GN-Math Game Loading and Interaction Logic
    const gnContainer = document.getElementById('container');
    const gnZoneViewer = document.getElementById('zoneViewer');
    let gnZoneFrame = document.getElementById('zoneFrame'); // Use let for potential re-assignment
    const gnSearchBar = document.getElementById('searchBar');
    const gnSortOptions = document.getElementById('sortOptions');
    const gnZoneCount = document.getElementById('zoneCount');
    const gnZoneNameEl = document.getElementById('zoneName'); // Renamed for clarity
    const gnZoneIdEl = document.getElementById('zoneId');
    const gnZoneAuthorEl = document.getElementById('zoneAuthor'); // Renamed for clarity
    const gnPopupTitle = document.getElementById('popupTitle');
    const gnPopupBody = document.getElementById('popupBody');

    // Zone Viewer Control Buttons
    const fullscreenBtnZone = document.getElementById('fullscreenBtnZone');
    const newTabBtnZone = document.getElementById('newTabBtnZone');
    const downloadBtnZone = document.getElementById('downloadBtnZone');
    const closeBtnZone = document.getElementById('closeBtnZone');


    const ZONES_URL = "https://cdn.jsdelivr.net/gh/gn-math/assets@main/zones.json";
    const COVER_URL_BASE = "https://cdn.jsdelivr.net/gh/gn-math/covers@main";
    const HTML_URL_BASE = "https://cdn.jsdelivr.net/gh/gn-math/html@main";
    let masterZoneList = []; // Store all fetched zones once
    let popularityData = {};

    async function listZones() {
        if (!gnContainer) {
            console.error("Game container element (#container) not found.");
            if (gnZoneCount) gnZoneCount.textContent = "Error: UI elements missing for games.";
            return;
        }
        if (gnZoneCount) gnZoneCount.textContent = "Loading games, please wait...";
        try {
            const response = await fetch(`${ZONES_URL}?t=${Date.now()}`); // Cache bust
            if (!response.ok) throw new Error(`Failed to fetch zones.json: ${response.status}`);
            masterZoneList = await response.json();
            
            await fetchPopularity(); // Fetch popularity data
            sortAndDisplayZones(); // Initial sort and display

        } catch (error) {
            console.error("Error loading zones:", error);
            if (gnContainer) gnContainer.innerHTML = `<p style="color:red;">Error loading games: ${error.message}. Please try refreshing.</p>`;
            if (gnZoneCount) gnZoneCount.textContent = "Failed to load games.";
        }
    }

    async function fetchPopularity() {
        try {
            // Fetching stats for the entire package might be slow/large.
            // If an aggregated popularity JSON is available from gn-math, that would be better.
            // This is a placeholder for how you might integrate popularity.
            // For now, we'll simulate or leave it, as the jsdelivr stats API for individual files can be complex for sorting.
            // Example: you might have a separate JSON for { "gameId": popularityScore }
            console.log("Popularity data fetching placeholder. Implement if API available.");
            // Mock popularity for now
            // masterZoneList.forEach(zone => { popularityData[zone.id] = Math.floor(Math.random() * 1000);});
        } catch (error) {
            console.warn("Could not fetch popularity data:", error);
        }
    }
    
    function sortAndDisplayZones() {
        if (!gnSortOptions || !masterZoneList || masterZoneList.length === 0) return;
        
        let zonesToDisplay = [...masterZoneList]; // Create a mutable copy for sorting/filtering
        const sortBy = gnSortOptions.value;

        if (sortBy === 'name') {
            zonesToDisplay.sort((a, b) => a.name.localeCompare(b.name));
        } else if (sortBy === 'id') { // Assuming 'id' implies date added (higher ID = newer)
            zonesToDisplay.sort((a, b) => (parseInt(b.id) || 0) - (parseInt(a.id) || 0)); // Sort descending by ID
        } else if (sortBy === 'popular') {
            zonesToDisplay.sort((a, b) => (popularityData[b.id] || 0) - (popularityData[a.id] || 0));
        }
        
        filterAndDisplayZones(zonesToDisplay);
    }

    function filterAndDisplayZones(sortedZones) {
        if (!gnSearchBar || !sortedZones) return;
        const query = gnSearchBar.value.toLowerCase().trim();
        const filteredZones = query 
            ? sortedZones.filter(zone => zone.name.toLowerCase().includes(query))
            : sortedZones;
        
        renderGameCards(filteredZones);
    }

    function renderGameCards(zonesToRender) {
        if (!gnContainer) return;
        gnContainer.innerHTML = ""; // Clear previous game cards efficiently

        if (!zonesToRender || zonesToRender.length === 0) {
            gnContainer.innerHTML = "<p>No games found matching your criteria.</p>";
            if (gnZoneCount) gnZoneCount.textContent = "0 Games Found";
            return;
        }

        const fragment = document.createDocumentFragment(); // Use fragment for performance

        zonesToRender.forEach(file => {
            const zoneItem = document.createElement("div");
            zoneItem.className = "zone-item";
            zoneItem.setAttribute('role', 'button');
            zoneItem.setAttribute('tabindex', '0'); // Make it focusable
            zoneItem.setAttribute('aria-label', `Play ${file.name}`);
            zoneItem.dataset.zoneId = file.id; // Store id for easier access

            zoneItem.addEventListener('click', () => openZone(file));
            zoneItem.addEventListener('keydown', (e) => { // Allow activation with Enter/Space
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    openZone(file);
                }
            });

            const img = document.createElement("img");
            // Construct URL correctly using base variables
            img.src = file.cover.replace("{COVER_URL}", COVER_URL_BASE).replace("{HTML_URL}", HTML_URL_BASE);
            img.alt = file.name; 
            img.loading = "lazy"; // Lazy load images for faster initial page load
            img.onerror = function() {
                this.src = '../images/favicon.png'; // Ensure this fallback image exists
                this.alt = 'Image not available for ' + file.name;
                this.style.objectFit = 'contain'; // Adjust fit for fallback
            };
            zoneItem.appendChild(img);

            const button = document.createElement("button");
            button.textContent = file.name;
            button.setAttribute('aria-hidden', 'true'); // Hide from screen readers as card is already focusable
            // The card itself is clickable, so the button is more of a visual label here.
            // If the button should have separate functionality, it would need its own event listener and stopPropagation.
            zoneItem.appendChild(button);
            fragment.appendChild(zoneItem);
        });
        gnContainer.appendChild(fragment); // Append all cards at once
        if (gnZoneCount) gnZoneCount.textContent = `Showing: ${zonesToRender.length} Game(s)`;
    }
    
    gnSearchBar.addEventListener('input', () => sortAndDisplayZones());
    gnSortOptions.addEventListener('change', () => sortAndDisplayZones());


    function openZone(file) {
        if (!file || !file.url) {
            console.error("Invalid file object for openZone:", file);
            alert("Could not load game: Invalid game data.");
            return;
        }

        if (file.url.startsWith("http")) { // External link
            window.open(file.url, "_blank", "noopener,noreferrer");
        } else { // Internal game
            const gameUrl = file.url.replace("{HTML_URL}", HTML_URL_BASE);
            
            if (gnZoneNameEl) gnZoneNameEl.textContent = file.name;
            if (gnZoneIdEl) gnZoneIdEl.textContent = file.id;
            if (gnZoneAuthorEl) {
                gnZoneAuthorEl.textContent = "by " + (file.author || "Unknown");
                gnZoneAuthorEl.href = file.authorLink || "#";
            }

            // Ensure iframe exists and is clean
            if (!gnZoneFrame || !document.body.contains(gnZoneFrame)) { // Check if it's still in DOM
                const oldFrame = document.getElementById('zoneFrame');
                if(oldFrame) oldFrame.remove(); // Remove old one if detached but ID exists

                gnZoneFrame = document.createElement("iframe");
                gnZoneFrame.id = "zoneFrame";
                gnZoneFrame.title = "Game Content"; // Accessibility
                gnZoneFrame.setAttribute('allowfullscreen', ''); // HTML attribute for fullscreen

                const header = gnZoneViewer.querySelector('.zone-header');
                if (header) header.after(gnZoneFrame);
                else gnZoneViewer.appendChild(gnZoneFrame); // Fallback
            }
            gnZoneFrame.src = 'about:blank'; // Clear previous content first

            // Fetch and inject HTML. Using srcdoc might be simpler for modern browsers if no complex base URL issues.
            // For wider compatibility and control, injecting content is fine.
            fetch(`${gameUrl}?t=${Date.now()}`) // Cache bust
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status} for ${gameUrl}`);
                    return response.text();
                })
                .then(html => {
                    // It's generally safer to set src to a data URI or use srcdoc if the HTML is simple
                    // For complex HTML with its own scripts that might rely on relative paths,
                    // setting src to the actual gameUrl might be better IF sandboxing and origin policies allow.
                    // However, injecting like this is common for this pattern.
                    gnZoneFrame.contentWindow.document.open();
                    gnZoneFrame.contentWindow.document.write(html);
                    gnZoneFrame.contentWindow.document.close();
                    
                    if (gnZoneViewer) {
                         gnZoneViewer.classList.remove('hidden');
                         gnZoneViewer.style.display = "flex"; // Ensure it's visible
                         gnZoneViewer.focus(); // Focus the viewer for keyboard navigation (e.g., ESC to close)
                    }
                })
                .catch(error => {
                    console.error("Failed to load zone:", file.name, error);
                    alert(`Failed to load game "${file.name}": ${error.message}`);
                    closeZone(); // Close viewer if game fails to load
                });
        }
    }

    function aboutBlankGame() { // Renamed to avoid conflict
        if (!gnZoneIdEl || !gnZoneIdEl.textContent) return;
        const currentZoneId = gnZoneIdEl.textContent;
        const zone = masterZoneList.find(z => String(z.id) === currentZoneId);
        if (!zone || zone.url.startsWith("http")) return; // Only for internal games

        const gameUrl = zone.url.replace("{HTML_URL}", HTML_URL_BASE);
        const newWindow = window.open("about:blank", "_blank", "noopener,noreferrer");
        if (newWindow) {
            fetch(`${gameUrl}?t=${Date.now()}`)
                .then(response => response.text())
                .then(html => {
                    newWindow.document.open();
                    newWindow.document.write(html);
                    newWindow.document.close();
                })
                .catch(err => {
                    console.error("Error opening game in new tab:", err);
                    newWindow.close(); 
                    alert("Could not open game in new tab.");
                });
        } else {
            alert("Popup blocked. Please allow popups for this site to open the game in a new tab.");
        }
    }

    function closeZone() {
        if (gnZoneViewer) {
            gnZoneViewer.classList.add('hidden');
            gnZoneViewer.style.display = "none"; // Ensure hidden
        }
        if (gnZoneFrame) {
            gnZoneFrame.src = 'about:blank'; // Critical to stop game and free resources
            // Optionally, remove and recreate iframe on next open if issues persist:
            // gnZoneFrame.remove(); 
            // gnZoneFrame = null; // Allow it to be recreated in openZone
        }
    }

    function downloadZoneGame() { // Renamed
        if (!gnZoneIdEl || !gnZoneIdEl.textContent) return;
        const currentZoneId = gnZoneIdEl.textContent;
        const zone = masterZoneList.find(z => String(z.id) === currentZoneId);
        if (!zone || zone.url.startsWith("http")) return;

        const gameUrl = zone.url.replace("{HTML_URL}", HTML_URL_BASE);
        fetch(`${gameUrl}?t=${Date.now()}`)
            .then(res => res.text())
            .then(text => {
                const blob = new Blob([text], { type: "text/html;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                // Sanitize filename: replace non-alphanumeric (except underscore/hyphen) with underscore
                a.download = zone.name.replace(/[^\w\s-]/gi, '_').replace(/\s+/g, '_') + ".html";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            })
            .catch(err => {
                console.error("Error downloading zone:", err);
                alert("Could not download game file.");
            });
    }

    function fullscreenZoneGame() { // Renamed
        if (!gnZoneFrame || !gnZoneFrame.contentWindow) { // Check contentWindow as iframe might be blank
            alert("Game iframe is not available for fullscreen.");
            return;
        }
        // Standard fullscreen API
        if (gnZoneFrame.requestFullscreen) gnZoneFrame.requestFullscreen();
        else if (gnZoneFrame.mozRequestFullScreen) gnZoneFrame.mozRequestFullScreen(); /* Firefox */
        else if (gnZoneFrame.webkitRequestFullscreen) gnZoneFrame.webkitRequestFullscreen(); /* Chrome, Safari & Opera */
        else if (gnZoneFrame.msRequestFullscreen) gnZoneFrame.msRequestFullscreen(); /* IE/Edge */
        else alert("Fullscreen mode is not supported by your browser or the game element.");
    }

    // Event listeners for zone viewer controls
    if(fullscreenBtnZone) fullscreenBtnZone.addEventListener('click', fullscreenZoneGame);
    if(newTabBtnZone) newTabBtnZone.addEventListener('click', aboutBlankGame);
    if(downloadBtnZone) downloadBtnZone.addEventListener('click', downloadZoneGame);
    if(closeBtnZone) closeBtnZone.addEventListener('click', closeZone);
    
    // Keyboard accessibility for zone viewer (e.g., ESC to close)
    if(gnZoneViewer) {
        gnZoneViewer.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeZone();
            }
        });
    }
    
    // Footer Popups and Data Functions
    const contactLink = document.getElementById('contactLink');
    const privacyLink = document.getElementById('privacyLink');
    const exportDataLink = document.getElementById('exportDataLink');
    const importDataInput = document.getElementById('importData');


    function showContact() {
        if (gnPopupTitle) gnPopupTitle.textContent = "Contact Us";
        if (gnPopupBody) gnPopupBody.innerHTML = `<p>For support or inquiries, please join our Discord server or reach out via email.</p>
                                                  <p><strong>Discord:</strong> [Your Server Link Here]</p>
                                                  <p><strong>Email:</strong> support@4simpleproblems.com</p>`; // Replace with actual links/info
        if (popupOverlayEl) {
            popupOverlayEl.classList.remove('hidden');
            popupOverlayEl.style.display = 'flex';
        }
    }

    function loadPrivacy() {
        if (gnPopupTitle) gnPopupTitle.textContent = "Privacy Policy";
        if (gnPopupBody) {
            gnPopupBody.innerHTML = `
                <h2>Privacy Policy for 4SP</h2>
                <p><strong>Last Updated:</strong> ${new Date().toLocaleDateString()}</p>
                <p>Welcome to 4SP! This privacy policy explains how we collect, use, and protect your information when you use our GN-Math Games service and other related services (collectively, "Services").</p>
                <h3>Information We Collect</h3>
                <ul>
                    <li><strong>AccountInformation:</strong> When you create an account, we collect your email address and allow you to set a username. This is processed via Google Firebase Authentication.</li>
                    <li><strong>Usage Data:</strong> We may collect anonymous data about how you interact with our games and services to improve them. This does not include personally identifiable information unless explicitly stated for a feature.</li>
                    <li><strong>Local Storage:</strong> Some settings or game progress may be stored in your browser's local storage. You can manage this data via your browser settings or our "Export/Import Data" feature.</li>
                </ul>
                <h3>How We Use Your Information</h3>
                <ul>
                    <li>To provide, maintain, and improve our Services.</li>
                    <li>To authenticate users and personalize their experience.</li>
                    <li>To respond to your inquiries and provide support.</li>
                </ul>
                <h3>Data Sharing</h3>
                <p>We do not sell your personal information. We may share information with:
                    <ul>
                        <li><strong>Service Providers:</strong> Such as Google Firebase for authentication and backend services. These providers are bound by their own privacy policies.</li>
                        <li><strong>Legal Requirements:</strong> If required by law or to protect the rights and safety of 4SP and its users.</li>
                    </ul>
                </p>
                <h3>Your Choices</h3>
                <p>You can manage your account information through the Settings page. You can also use the "Export Data" feature to get a copy of your locally stored data and "Import Data" to restore it. Deleting your account will remove your authentication details from Firebase and you should clear local storage manually if desired.</p>
                <h3>Contact Us</h3>
                <p>If you have any questions about this Privacy Policy, please contact us via the methods provided in the "Contact" section.</p>
            `;
        }
        if (popupOverlayEl) {
            popupOverlayEl.classList.remove('hidden');
            popupOverlayEl.style.display = 'flex';
        }
    }

    function saveDataToFile() { // Renamed
        try {
            let dataToExport = {};
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('4sp_') || key.startsWith('firebase:') || key.startsWith('gnGame_')) { // Added gnGame_ prefix
                    dataToExport[key] = localStorage.getItem(key);
                }
            });
            if (Object.keys(dataToExport).length === 0) {
                alert("No 4SP specific data found in local storage to export.");
                return;
            }
            const dataStr = JSON.stringify(dataToExport, null, 2); // Pretty print JSON
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `4sp_gngames_data_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("Data exported successfully!");
        } catch (error) {
            console.error("Error exporting data:", error);
            alert("Failed to export data. Check console for details.");
        }
    }

    function loadDataFromFile(event) { // Renamed
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const content = e.target.result;
                const parsedData = JSON.parse(content);
                let importedCount = 0;
                let skippedCount = 0;
                if (confirm("This will overwrite any existing local data with the same keys. Are you sure you want to proceed?")) {
                    for (let key in parsedData) {
                        if (key.startsWith('4sp_') || key.startsWith('firebase:') || key.startsWith('gnGame_')) {
                            localStorage.setItem(key, parsedData[key]);
                            importedCount++;
                        } else {
                            skippedCount++;
                        }
                    }
                    alert(importedCount > 0 ? `Data imported successfully: ${importedCount} item(s) loaded. ${skippedCount} item(s) skipped.` : "No relevant 4SP data found in the file to import.");
                    if (importedCount > 0) window.location.reload();
                }
            } catch (error) {
                console.error("Error importing data:", error);
                alert("Failed to import data. The file might be corrupted or not in the expected JSON format.");
            } finally {
                event.target.value = null; // Reset file input for next import
            }
        };
        reader.readAsText(file);
    }

    if(contactLink) contactLink.addEventListener('click', (e) => { e.preventDefault(); showContact(); });
    if(privacyLink) privacyLink.addEventListener('click', (e) => { e.preventDefault(); loadPrivacy(); });
    if(exportDataLink) exportDataLink.addEventListener('click', (e) => { e.preventDefault(); saveDataToFile(); });
    if(importDataInput) importDataInput.addEventListener('change', loadDataFromFile);

    // END: GN-Math Game Loading and Interaction Logic
    </script>
</body>
</html>
