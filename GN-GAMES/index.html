<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4SP - GN-GAMES</title>

  <!-- V4 Global Stylesheet -->
  <link rel="stylesheet" href="../css/style.css" />

  <!-- Favicon Links -->
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />

  <!-- Prevent accidental navigation away -->
  <script>
    window.addEventListener('beforeunload', function (event) {
      event.preventDefault();
      event.returnValue = '';
      return 'Are you sure you want to leave? Any unsaved changes will be lost.';
    });
  </script>

  <!-- Ads & Analytics -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5521219086088837" crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-WX5VS54ZDW"></script>
  <meta name="google-adsense-account" content="ca-pub-5521219086088837" />
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-WX5VS54ZDW');
  </script>
  <script async src="https://fundingchoicesmessages.google.com/i/pub-5521219086088837?ers=1"></script>

  <!-- GN-Math Script -->
  <script src="https://cdn.jsdelivr.net/gh/gn-math/gn-math.github.io@main/gnmath.js"></script>

  <!-- Inline Styles for Zone Grid & Dark/Light Variables -->
  <style>
    :root {
      --primary-color: #fc2651;
      --text-color: #333;
      --background-color: #FFFFFF;
      --card-bg: #f8f8f8;
      --card-border: #e0e0e0;
      --shadow: rgba(0, 0, 0, 0.1);
      --popup-bg: #fff;
    }

    .dark-mode {
      --primary-color: #fc2651;
      --text-color: #e0e0e0;
      --background-color: #181818;
      --card-bg: #252525;
      --card-border: #383838;
      --shadow: rgba(0, 0, 0, 0.4);
      --popup-bg: #252525;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    /* Zone Grid: use V4‚Äôs dashboard-grid but adjust gaps */
    #container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 1rem;
    }

    .zone-item {
      background-color: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      box-shadow: 0 2px 4px var(--shadow);
      display: flex;
      flex-direction: column;
      transition: background-color 0.2s, box-shadow 0.2s;
    }

    .zone-item:hover {
      background-color: var(--card-border);
      box-shadow: 0 4px 8px var(--shadow);
    }

    .zone-item img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
    }

    .zone-item button {
      background-color: var(--card-bg);
      color: var(--text-color);
      border: none;
      padding: 10px;
      cursor: pointer;
      font-weight: bold;
      flex-grow: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: background-color 0.2s;
    }

    .zone-item button:hover {
      background-color: var(--primary-color);
      color: white;
    }

    #zoneCount {
      margin: 0.5rem 0;
      font-size: 0.9rem;
      color: var(--text-color);
    }

    /* Zone Viewer (full‚Äêscreen iframe) */
    #zoneViewer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--background-color);
      z-index: 1000;
      display: none;
      flex-direction: column;
    }

    .zone-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: var(--primary-color);
      color: white;
      padding: 0.5rem 1rem;
    }

    .zone-title {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    #zoneName {
      font-size: 1.2rem;
      font-weight: bold;
      margin: 0;
    }

    #zoneId {
      display: none;
    }

    #zoneAuthor {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
    }

    #zoneAuthor:hover {
      text-decoration: underline;
    }

    .zone-controls {
      display: flex;
      gap: 10px;
    }

    .zone-controls button {
      background-color: transparent;
      border: 1px solid white;
      color: white;
      padding: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .zone-controls button:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    #zoneFrame {
      flex-grow: 1;
      border: none;
      width: 100%;
      height: 100%;
    }

    /* Popup Overlay */
    #popupOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .popup {
      background-color: var(--popup-bg);
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .popup-header {
      background-color: var(--primary-color);
      color: white;
      padding: 0.8rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #popupTitle {
      margin: 0;
      font-size: 1.2rem;
    }

    #popupClose {
      background: transparent;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      line-height: 1;
    }

    #popupBody {
      padding: 1rem;
      overflow-y: auto;
      color: var(--text-color);
    }

    #popupBody input[type="text"],
    #popupBody input[type="file"] {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 1rem;
      border: 1px solid var(--card-border);
      border-radius: 4px;
      background-color: var(--card-bg);
      color: var(--text-color);
      font-size: 16px;
    }

    #settings-button {
      display: block;
      width: 100%;
      padding: 0.75rem;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-bottom: 1rem;
    }

    footer {
      background-color: var(--card-bg);
      padding: 1rem;
      text-align: center;
      margin-top: 2rem;
      border-top: 1px solid var(--card-border);
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    .footer-links a {
      color: var(--primary-color);
      text-decoration: none;
    }

    .footer-links a:hover {
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 10px;
      }

      .search-container {
        width: 100%;
      }

      #container {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
      }

      .zone-item img {
        height: 140px;
      }

      .zone-item button {
        height: 60px;
        font-size: 14px;
      }
    }
  </style>
</head>

<body class="dashboard-page dark-mode">
  <!-- V4 HEADER (exactly from dashboard.html) -->
  <header class="main-header light-bg">
    <div class="container">
      <div class="logo">
        <a href="../index.html">
          <img src="../images/logo-dark.png" alt="4SP Logo" style="height: 40px; cursor: pointer;" />
        </a>
      </div>
      <div class="auth-buttons">
        <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
        <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
      </div>
    </div>
  </header>

  <div class="dashboard-container">
    <!-- V4 SIDEBAR (exactly from dashboard.html) -->
    <aside class="sidebar slide-in" id="sidebar">
      <button id="toggleSidebar">‚ò∞</button>

      <div class="user-info">
        <div class="marquee-container">
          <span id="userName" class="marquee-content username">Loading‚Ä¶</span>
        </div>
        <div class="marquee-container">
          <span id="userEmail" class="marquee-content email">Loading‚Ä¶</span>
        </div>
      </div>

      <nav>
        <ul>
          <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
          <li><a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">Proxies</span></a></li>
          <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
          <li><a href="games.html" class="active"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
          <li><a href="others.html"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
          <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
          <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
        </ul>
      </nav>
    </aside>

    <!-- MAIN CONTENT AREA -->
    <main class="main-content fade-in">
      <!-- Zone Search & Sort (header content) -->
      <div class="header-content" style="margin-bottom: 1rem; align-items: center;">
        <div class="logo" style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
          gn-math
        </div>
        <div class="search-container" style="flex: 1; margin-left: 2rem; display: flex; gap: 10px;">
          <input type="text" id="searchBar" placeholder="Search zones..." oninput="filterZones()" />
          <select id="sortOptions" onchange="sortZones()">
            <option value="name">Name</option>
            <option value="id">ID (Date)</option>
            <option value="popular">Popular</option>
          </select>
          <button id="settings" style="background-color: var(--primary-color); color: white; border: none; border-radius: 4px; padding: 0.5rem 1rem; font-size: 16px; cursor: pointer; margin-left: 1rem;">‚öôÔ∏è</button>
        </div>
      </div>

      <!-- Zone Count -->
      <div id="zoneCount">Loading zones...</div>

      <!-- Zone Grid: Use V4‚Äôs dashboard-grid container -->
      <div class="dashboard-grid" id="container">Loading...</div>

      <!-- Zone Viewer (Hidden by Default) -->
      <div id="zoneViewer">
        <div class="zone-header">
          <div class="zone-title">
            <h2 id="zoneName">zone</h2>
            <span id="zoneId" style="display: none;"></span>
            <a id="zoneAuthor" href="#" target="_blank">by Author</a>
          </div>
          <div class="zone-controls">
            <button onclick="fullscreenZone()">Fullscreen</button>
            <button onclick="aboutBlank()">Open in New Tab</button>
            <button onclick="downloadZone()">Download</button>
            <button onclick="closeZone()">Close</button>
          </div>
        </div>
        <iframe id="zoneFrame"></iframe>
      </div>

      <!-- Popup Overlay -->
      <div id="popupOverlay">
        <div class="popup">
          <div class="popup-header">
            <h3 id="popupTitle">Title</h3>
            <button id="popupClose" onclick="closePopup()">√ó</button>
          </div>
          <div id="popupBody">Content will be here</div>
        </div>
      </div>
    </main>
  </div>

  <!-- V4 FOOTER -->
  <footer>
    <div class="footer-links">
      <a href="#" onclick="showContact(); return false;">Contact</a>
      <a href="#" onclick="loadPrivacy(); return false;">Privacy Policy</a>
      <a href="javascript:saveData()">Export Data</a>
      <label for="importData" style="color: var(--primary-color); cursor: pointer;">Import Data</label>
      <input type="file" id="importData" style="display: none;" onchange="loadData(event)" />
    </div>
  </footer>

  <!-- GN-Math & Firebase Scripts -->
  <script>
    // Sidebar toggle logic
    const toggleSidebarBtn = document.getElementById("toggleSidebar");
    const sidebar = document.getElementById("sidebar");
    toggleSidebarBtn.addEventListener("click", () => {
      sidebar.classList.toggle("collapsed");
      // If marquee elements exist, update them here: setTimeout(updateMarquees, 550);
    });

    // Logout handling (same as V4 dashboard)
    const handleLogout = () => {
      if (window.firebase && firebase.auth) {
        firebase.auth().signOut()
          .then(() => location.href = "../login.html")
          .catch(err => console.error("Logout error:", err));
      } else {
        location.href = "../index.html";
      }
    };
    document.getElementById("logoutBtn").onclick = handleLogout;
    document.getElementById("signOutLink").onclick = handleLogout;

    // GN-Math Zone Logic (unchanged)
    const container = document.getElementById('container');
    const zoneViewer = document.getElementById('zoneViewer');
    let zoneFrame = document.getElementById('zoneFrame');
    const searchBar = document.getElementById('searchBar');
    const sortOptions = document.getElementById('sortOptions');
    const zonesURL = "https://cdn.jsdelivr.net/gh/gn-math/assets@main/zones.json";
    const coverURL = "https://cdn.jsdelivr.net/gh/gn-math/covers@main";
    const htmlURL = "https://cdn.jsdelivr.net/gh/gn-math/html@main";
    let zones = [];
    let popularityData = {};

    async function listZones() {
      try {
        const response = await fetch(zonesURL + "?t=" + Date.now());
        const json = await response.json();
        zones = json;
        await fetchPopularity();
        sortZones();
        const search = new URLSearchParams(window.location.search);
        const id = search.get('id');
        if (id) {
          const zone = zones.find(z => z.id + '' == id + '');
          if (zone) openZone(zone);
        }
      } catch (error) {
        container.innerHTML = `Error loading zones: ${error}`;
      }
    }

    async function fetchPopularity() {
      try {
        const resp = await fetch("https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files?period=year");
        const data = await resp.json();
        data.forEach(file => {
          const idMatch = file.name.match(/\/(\d+)\.html$/);
          if (idMatch) {
            const id = parseInt(idMatch[1]);
            popularityData[id] = file.hits.total;
          }
        });
      } catch {
        popularityData[0] = 0;
      }
    }

    function sortZones() {
      const sortBy = sortOptions.value;
      if (sortBy === 'name') {
        zones.sort((a, b) => a.name.localeCompare(b.name));
      } else if (sortBy === 'id') {
        zones.sort((a, b) => a.id - b.id);
      } else if (sortBy === 'popular') {
        zones.sort((a, b) => (popularityData[b.id] || 0) - (popularityData[a.id] || 0));
      }
      zones.sort((a, b) => (a.id === -1 ? -1 : b.id === -1 ? 1 : 0));
      displayZones(zones);
    }

    function displayZones(zones) {
      container.innerHTML = "";
      zones.forEach(file => {
        const zoneItem = document.createElement("div");
        zoneItem.className = "zone-item";
        zoneItem.onclick = () => openZone(file);

        const img = document.createElement("img");
        img.src = file.cover.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        zoneItem.appendChild(img);

        const button = document.createElement("button");
        button.textContent = file.name;
        button.onclick = event => {
          event.stopPropagation();
          openZone(file);
        };
        zoneItem.appendChild(button);

        container.appendChild(zoneItem);
      });
      if (container.innerHTML === "") {
        container.innerHTML = "No zones found.";
      } else {
        document.getElementById("zoneCount").textContent = `Zones Loaded: ${zones.length}`;
      }
    }

    function filterZones() {
      const query = searchBar.value.toLowerCase();
      const filtered = zones.filter(z => z.name.toLowerCase().includes(query));
      displayZones(filtered);
    }

    function openZone(file) {
      if (file.url.startsWith("http")) {
        window.open(file.url, "_blank");
      } else {
        const url = file.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        fetch(url + "?t=" + Date.now())
          .then(resp => resp.text())
          .then(html => {
            zoneFrame.contentDocument.open();
            zoneFrame.contentDocument.write(html);
            zoneFrame.contentDocument.close();
            document.getElementById('zoneName').textContent = file.name;
            document.getElementById('zoneId').textContent = file.id;
            document.getElementById('zoneAuthor').textContent = "by " + file.author;
            if (file.authorLink) {
              document.getElementById('zoneAuthor').href = file.authorLink;
            }
            zoneViewer.style.display = "flex";
          })
          .catch(err => alert("Failed to load zone: " + err));
      }
    }

    function aboutBlank() {
      const newWindow = window.open("about:blank", "_blank");
      const zone = zones.find(z => z.id + '' === document.getElementById('zoneId').textContent).url
        .replace("{COVER_URL}", coverURL)
        .replace("{HTML_URL}", htmlURL);
      fetch(zone + "?t=" + Date.now())
        .then(resp => resp.text())
        .then(html => {
          if (newWindow) {
            newWindow.document.open();
            newWindow.document.write(html);
            newWindow.document.close();
          }
        });
    }

    function closeZone() {
      zoneViewer.style.display = "none";
      zoneViewer.removeChild(zoneFrame);
    }

    function downloadZone() {
      const id = document.getElementById('zoneId').textContent;
      const zone = zones.find(z => z.id + '' === id);
      fetch(zone.url.replace("{HTML_URL}", htmlURL) + "?t=" + Date.now())
        .then(res => res.text())
        .then(text => {
          const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = zone.name + ".html";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
    }

    function fullscreenZone() {
      if (zoneFrame.requestFullscreen) zoneFrame.requestFullscreen();
      else if (zoneFrame.mozRequestFullScreen) zoneFrame.mozRequestFullScreen();
      else if (zoneFrame.webkitRequestFullscreen) zoneFrame.webkitRequestFullscreen();
      else if (zoneFrame.msRequestFullscreen) zoneFrame.msRequestFullscreen();
    }

    function saveData() {
      const data = JSON.stringify(localStorage) + "\n\n|\n\n" + document.cookie;
      const link = document.createElement("a");
      link.href = URL.createObjectURL(new Blob([data], { type: "text/plain" }));
      link.download = `${Date.now()}.data`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);
    }

    function loadData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const content = e.target.result;
        const [localStorageData, cookieData] = content.split("\n\n|\n\n");
        try {
          const parsed = JSON.parse(localStorageData);
          for (const key in parsed) {
            localStorage.setItem(key, parsed[key]);
          }
        } catch {}
        if (cookieData) {
          const cookies = cookieData.split("; ");
          cookies.forEach(cookie => {
            document.cookie = cookie;
          });
        }
        alert("Data loaded");
      };
      reader.readAsText(file);
    }

    function darkMode() {
      document.body.classList.toggle("dark-mode");
    }

    function cloakIcon(url) {
      const link = document.querySelector("link[rel~='icon']");
      link.rel = "icon";
      link.href = url.trim() === "" ? "favicon.png" : url;
      document.head.appendChild(link);
    }

    function cloakName(string) {
      document.title = string.trim() === "" ? "gn-math" : string;
    }

    function tabCloak() {
      closePopup();
      document.getElementById('popupTitle').textContent = "Tab Cloak";
      document.getElementById('popupBody').innerHTML = `
        <label for="tab-cloak-textbox" style="font-weight: bold;">Set Tab Title:</label><br>
        <input type="text" id="tab-cloak-textbox" placeholder="Enter new tab name..." oninput="cloakName(this.value)">
        <br><br><label for="tab-cloak-favicon" style="font-weight: bold;">Set Tab Icon:</label><br>
        <input type="text" id="tab-cloak-favicon" placeholder="Enter new tab icon URL..." oninput="cloakIcon(this.value)">
      `;
      document.getElementById('popupOverlay').style.display = "flex";
    }

    // Settings button opens popup
    document.getElementById('settings').addEventListener('click', () => {
      document.getElementById('popupTitle').textContent = "Settings";
      document.getElementById('popupBody').innerHTML = `
        <button id="settings-button" onclick="darkMode()">Toggle Dark Mode</button>
        <br><br>
        <button id="settings-button" onclick="tabCloak()">Tab Cloak</button>
      `;
      document.getElementById('popupOverlay').style.display = "flex";
    });

    function showContact() {
      document.getElementById('popupTitle').textContent = "Contact";
      document.getElementById('popupBody').innerHTML = `<p>Discord: https://discord.gg/NAFw4ykZ7n</p>`;
      document.getElementById('popupOverlay').style.display = "flex";
    }

    function loadPrivacy() {
      document.getElementById('popupTitle').textContent = "Privacy Policy";
      document.getElementById('popupBody').innerHTML = `
        <div style="max-height:60vh; overflow-y:auto;">
          <h2>PRIVACY POLICY</h2>
          <p>Last updated April 17, 2025</p>
          <p>This Privacy Notice for gn-math ("we," "us," or "our"), describes how and why we might access, collect, store, use, and/or share ("process") your personal information when you use our services ("Services"), including when you:</p>
          <ul>
            <li>Visit our website at <a href="https://gn-math.github.io">https://gn-math.github.io</a>, or any website of ours that links to this Privacy Notice</li>
            <li>Engage with us in other related ways, including any sales, marketing, or events</li>
          </ul>
          <p>Questions or concerns? Reading this Privacy Notice will help you understand your privacy rights and choices. We are responsible for making decisions about how your personal information is processed. If you do not agree with our policies and practices, please do not use our Services. If you still have any questions or concerns, please contact us at <a href="https://discord.gg/NAFw4ykZ7n">https://discord.gg/NAFw4ykZ7n</a>.</p>
          <!-- Full policy content can be pasted here as needed -->
        </div>
      `;
      document.getElementById('popupOverlay').style.display = "flex";
    }

    function closePopup() {
      document.getElementById('popupOverlay').style.display = "none";
    }

    // Prevent certain domains
    const schoolList = ["deledao", "goguardian", "lightspeed", "linewize", "securly", ".edu/"];
    function isBlockedDomain(url) {
      const domain = new URL(url, location.origin).hostname + "/";
      return schoolList.some(school => domain.includes(school));
    }
    const originalFetch = window.fetch;
    window.fetch = function (url, options) {
      if (isBlockedDomain(url)) {
        console.warn(`Blocked request to ${url}`);
        return Promise.reject(new Error("Blocked domain"));
      }
      return originalFetch.apply(this, arguments);
    };
    const originalOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function (method, url) {
      if (isBlockedDomain(url)) {
        console.warn(`Blocked XHR to ${url}`);
        return;
      }
      return originalOpen.apply(this, arguments);
    };
    HTMLCanvasElement.prototype.toDataURL = function () {
      return "";
    };

    // Initialize zone listing
    listZones();
  </script>
</body>

</html>
