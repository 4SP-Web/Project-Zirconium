<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - SIGN UP</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .auth-container { background-color: #fff; border-radius: 24px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border: 1px solid #e0e0e0; max-width: 500px; margin: 40px auto; padding: 30px; display: flex; flex-direction: column; align-items: center; text-align: center; }
        h2 { font-family: sans-serif; font-size: 2em; color: #333; margin-bottom: 25px; }
        form { width: 100%; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 6px; font-family: sans-serif; color: #555; font-size: 0.9em; }
        .input-group input { width: 100%; box-sizing: border-box; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-family: sans-serif; font-size: 0.95em; }
        .input-group input:focus { border-color: #6720bd; outline: none; }
        .btn-primary { width: 100%; padding: 12px; background-color: #6720bd; color: #fff; border: none; border-radius: 8px; font-family: sans-serif; font-size: 1em; cursor: pointer; transition: background-color 0.3s ease; margin-top: 5px; }
        .btn-primary:hover { background-color: #5a1aa8; }
        .separator { margin: 20px 0; text-align: center; position: relative; font-family: sans-serif; color: #888; width: 100%; }
        .separator::before, .separator::after { content: ''; position: absolute; top: 50%; width: 40%; height: 1px; background-color: #ddd; }
        .separator::before { left: 0; }
        .separator::after { right: 0; }
        .btn-google { display: flex; align-items: center; justify-content: center; width: 100%; padding: 10px; background-color: #fff; color: #333; border: 1px solid #ccc; border-radius: 8px; font-family: sans-serif; font-size: 0.95em; cursor: pointer; transition: background-color 0.3s ease; }
        .btn-google img { width: 18px; height: 18px; margin-right: 8px; }
        .btn-google:hover { background-color: #f5f5f5; }
        .switch-link { margin-top: 20px; font-family: sans-serif; color: #555; }
        .switch-link a { color: #6720bd; text-decoration: none; font-weight: bold; }
        .error-message, .success-message { font-size: 0.9em; margin-top: 15px; width: 100%; text-align: center; padding: 10px; border-radius: 6px; }
        .error-message { color: #D8000C; background-color: #FFBABA; }
        .success-message { color: #4F8A10; background-color: #DFF2BF; }
        .checkbox-group { margin-bottom: 15px; display: flex; align-items: center; font-family: sans-serif; font-size: 0.9em; color: #666; justify-content: flex-start; }
        .checkbox-group input { margin-right: 8px; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body>
    <div class="auth-container">
        <h2>Create Account</h2>
        <div id="message-container"></div>
        <form id="signupForm">
            <div class="input-group">
                <label for="signupEmail">Email</label>
                <input type="email" id="signupEmail" required>
            </div>
            <div class="input-group">
                <label for="signupUsername">Username (Optional)</label>
                <input type="text" id="signupUsername">
            </div>
            <div class="input-group">
                <label for="signupPassword">Password</label>
                <input type="password" id="signupPassword" required minlength="6">
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="agreeTerms" required>
                <label for="agreeTerms">I agree to the <a href="legal.html#termsOfService" target="_blank">Terms of Service</a></label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="agreePrivacy" required>
                <label for="agreePrivacy">I agree to the <a href="legal.html#privacyPolicy" target="_blank">Privacy Policy</a></label>
            </div>
            <button type="submit" class="btn-primary">SIGN UP</button>
        </form>
        <div class="separator">OR</div>
        <button id="googleSignupBtn" class="btn-google">
            <img src="images/google-icon.png" alt="Google Icon"> Sign up with Google
        </button>
        <p class="switch-link">Already have an account? <a href="login.html">Login here</a></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const signupForm = document.getElementById('signupForm');
            const googleSignupBtn = document.getElementById('googleSignupBtn');
            const messageContainer = document.getElementById('message-container');

            // You can modify this list with the emails you want to block.
            const deniedEmails = [
                'example1@domain.com',
                'testuser@example.org',
                'anotheruser@website.net'
            ];
            
            const showMessage = (message, type = 'error') => {
                messageContainer.innerHTML = `<div class="${type}-message">${message}</div>`;
            };

            // Handle Email/Password Signup
            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                messageContainer.innerHTML = '';
                
                const email = document.getElementById('signupEmail').value;
                const username = document.getElementById('signupUsername').value;
                const password = document.getElementById('signupPassword').value;

                if (deniedEmails.includes(email)) {
                    showMessage('This email address is not allowed to register.');
                    return;
                }

                try {
                    // 1. Create the user in Firebase Authentication
                    const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    // 2. Send a verification email
                    await user.sendEmailVerification();

                    // 3. Create the user document in Firestore
                    const userData = {
                        email: user.email,
                        username: username || null, // Store null if username is empty
                        authMethod: 'email-password',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await db.collection('users').doc(user.uid).set(userData);

                    // 4. Show success message
                    showMessage('Account created! Please check your email for a verification link to log in.', 'success');
                    signupForm.reset();

                } catch (error) {
                    console.error('Sign-up error:', error);
                    if (error.code === 'auth/email-already-in-use') {
                        showMessage('This email address is already in use. Please <a href="login.html">login</a> instead.');
                    } else {
                        showMessage(error.message);
                    }
                }
            });

            // Handle Google Signup
            googleSignupBtn.addEventListener('click', async () => {
                // You might want to check the terms/privacy boxes before allowing a click.
                // This example proceeds directly for simplicity.
                messageContainer.innerHTML = '';

                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    const result = await firebase.auth().signInWithPopup(provider);
                    const user = result.user;

                    if (deniedEmails.includes(user.email)) {
                        await firebase.auth().signOut();
                        showMessage('This email address is not allowed to register.');
                        return;
                    }
                    
                    // Check if this is a brand new user
                    const isNewUser = result.additionalUserInfo.isNewUser;

                    if (isNewUser) {
                        // Create the user document in Firestore for the new user
                        const userData = {
                            email: user.email,
                            username: user.displayName || null,
                            authMethod: 'google',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        await db.collection('users').doc(user.uid).set(userData);
                        
                        // Redirect to the dashboard since Google accounts are pre-verified
                        window.location.href = '/logged-in/dashboard.html'; // CHANGE TO YOUR DASHBOARD URL
                    } else {
                        // This user already exists. Deny signup and guide them to login.
                        await firebase.auth().signOut();
                        showMessage('An account with this Google email already exists. Please <a href="login.html">login</a>.');
                    }
                } catch (error) {
                    console.error('Google Sign-up error:', error);
                    if (error.code === 'auth/account-exists-with-different-credential') {
                        showMessage('An account with this email already exists with a password. Please login using your email and password.');
                    } else {
                        showMessage('Failed to sign up with Google. Please try again.');
                    }
                }
            });
        });
    </script>
</body>
</html>
